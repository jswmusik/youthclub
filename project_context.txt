=== PROJECT CONTEXT GENERATED ===
=== IGNORED: node_modules, venv, migrations, media, images ===

=== DIRECTORY STRUCTURE ===
./
    generate_focused_context.py
    project_context.txt
    frontend/
        postcss.config.mjs
        next-env.d.ts
        README.md
        package.json
        tsconfig.json
        eslint.config.mjs
        next.config.ts
        types/
            organization.ts
            post.ts
        context/
            AuthContext.tsx
        app/
            utils.ts
            layout.tsx
            page.tsx
            globals.css
            admin/
                club/
                    layout.tsx
                    page.tsx
                    settings/
                        page.tsx
                    posts/
                        page.tsx
                        edit/
                            [id]/
                                page.tsx
                        [id]/
                            page.tsx
                        create/
                            page.tsx
                    rewards/
                        page.tsx
                        edit/
                            [id]/
                                page.tsx
                        [id]/
                            page.tsx
                        create/
                            page.tsx
                    admins/
                        page.tsx
                    groups/
                        page.tsx
                        requests/
                            page.tsx
                        edit/
                            [id]/
                                page.tsx
                        [id]/
                            page.tsx
                        create/
                            page.tsx
                    msgboard/
                        page.tsx
                    youth/
                        page.tsx
                        [id]/
                            page.tsx
                    guardians/
                        page.tsx
                        [id]/
                            page.tsx
                    profile/
                        page.tsx
                    news-feed/
                        page.tsx
                        archive/
                            page.tsx
                        [id]/
                            page.tsx
                    custom-fields/
                        page.tsx
                super/
                    layout.tsx
                    page.tsx
                    municipalities/
                        page.tsx
                        [id]/
                            page.tsx
                    messages/
                        page.tsx
                    posts/
                        page.tsx
                        edit/
                            [id]/
                                page.tsx
                        [id]/
                            page.tsx
                        create/
                            page.tsx
                    clubs/
                        page.tsx
                        [id]/
                            page.tsx
                    rewards/
                        page.tsx
                        edit/
                            [id]/
                                page.tsx
                        [id]/
                            page.tsx
                        create/
                            page.tsx
                    admins/
                        page.tsx
                    groups/
                        page.tsx
                        requests/
                            page.tsx
                        edit/
                            [id]/
                                page.tsx
                        [id]/
                            page.tsx
                        create/
                            page.tsx
                    youth/
                        page.tsx
                        [id]/
                            page.tsx
                    guardians/
                        page.tsx
                        [id]/
                            page.tsx
                    profile/
                        page.tsx
                    news/
                        page.tsx
                        tags/
                            page.tsx
                    news-feed/
                        page.tsx
                        archive/
                            page.tsx
                        [id]/
                            page.tsx
                    custom-fields/
                        page.tsx
                    countries/
                        page.tsx
                    interests/
                        page.tsx
                municipality/
                    layout.tsx
                    page.tsx
                    settings/
                        page.tsx
                    posts/
                        page.tsx
                        edit/
                            [id]/
                                page.tsx
                        [id]/
                            page.tsx
                        create/
                            page.tsx
                    clubs/
                        page.tsx
                        [id]/
                            page.tsx
                    rewards/
                        page.tsx
                        edit/
                            [id]/
                                page.tsx
                        [id]/
                            page.tsx
                        create/
                            page.tsx
                    admins/
                        page.tsx
                    groups/
                        page.tsx
                        requests/
                            page.tsx
                        edit/
                            [id]/
                                page.tsx
                        [id]/
                            page.tsx
                        create/
                            page.tsx
                    msgboard/
                        page.tsx
                    youth/
                        page.tsx
                        [id]/
                            page.tsx
                    guardians/
                        page.tsx
                        [id]/
                            page.tsx
                    profile/
                        page.tsx
                    news-feed/
                        page.tsx
                        archive/
                            page.tsx
                        [id]/
                            page.tsx
                    custom-fields/
                        page.tsx
            dashboard/
                youth/
                    page.tsx
                guardian/
                    page.tsx
            components/
                SystemAlert.tsx
                NewsArticleReader.tsx
                NewsFeed.tsx
                CustomFieldsDisplay.tsx
                GroupForm.tsx
                RewardDetailView.tsx
                NewsArchive.tsx
                CustomRuleBuilder.tsx
                GroupDetailView.tsx
                RewardManager.tsx
                GroupManager.tsx
                GroupRequestsManager.tsx
                CustomFieldsForm.tsx
                DeleteConfirmationModal.tsx
                RichTextEditor.tsx
                CustomFieldManager.tsx
                Toast.tsx
                RewardForm.tsx
                MemberSelector.tsx
                posts/
                    PostForm.tsx
            login/
                page.tsx
        public/
        lib/
            api.ts
    backend/
        manage.py
        organization/
            models.py
            serializers.py
            __init__.py
            apps.py
            admin.py
            tests.py
            urls.py
            views.py
        posts/
            models.py
            serializers.py
            __init__.py
            apps.py
            admin.py
            tests.py
            views.py
        core/
            asgi.py
            __init__.py
            settings.py
            urls.py
            wsgi.py
        system_messages/
            models.py
            serializers.py
            __init__.py
            apps.py
            admin.py
            tests.py
            views.py
        rewards/
            signals.py
            models.py
            serializers.py
            __init__.py
            apps.py
            admin.py
            utils.py
            tests.py
            views.py
            management/
                commands/
                    process_birthday_rewards.py
        custom_fields/
            models.py
            serializers.py
            __init__.py
            apps.py
            admin.py
            tests.py
            views.py
        groups/
            signals.py
            models.py
            serializers.py
            __init__.py
            apps.py
            admin.py
            permissions.py
            tests.py
            views.py
            management/
                __init__.py
                commands/
                    __init__.py
                    init_system_groups.py
        news/
            models.py
            serializers.py
            __init__.py
            apps.py
            admin.py
            tests.py
            views.py
        users/
            models.py
            serializers.py
            __init__.py
            apps.py
            admin.py
            permissions.py
            tests.py
            views.py
            management/
                commands/
                    increment_grades.py
        api/
            models.py
            __init__.py
            apps.py
            admin.py
            tests.py
            urls.py
            views.py


=== FILE CONTENTS ===


--- START OF FILE: ./generate_focused_context.py ---
import os

# ==========================================
#  PASTE THE FILES YOU WANT TO SHARE HERE
# ==========================================
TARGETS = [
    # --- Backend Configuration ---
    'backend/core/settings.py',
    'backend/api/urls.py',
    
    # --- User & Permissions (Crucial for Targeting Logic) ---
    'backend/users/models.py',          # Added: To see exact user fields (grade, dob, etc.)
    'backend/users/permissions.py',

    # --- Reference Patterns (Targeting & Scoping) ---
    'backend/rewards/models.py',        # Best reference for targeting mix (Groups + Demographics)
    'backend/rewards/views.py',         # Best reference for Admin Scope filtering
    'backend/news/models.py',           # Best reference for Title/Hero/RichText content
    
    # --- Critical for Custom Field Targeting ---
    'backend/custom_fields/models.py',  # To understand the field schema
    'backend/groups/models.py',         # Reference for storing 'custom_field_rules'
    'backend/groups/views.py',          # Reference for logic that filters Users by custom rules

    # --- Frontend Setup ---
    'frontend/lib/api.ts',
    
    # --- Frontend Components (UI Reference) ---
    'frontend/components/RichTextEditor.tsx',
    'frontend/components/RewardForm.tsx',       # Reference for Demographics UI
    'frontend/components/GroupForm.tsx',        # Reference for Custom Rule UI integration
    'frontend/components/CustomRuleBuilder.tsx',# The specific component for building rules
    'frontend/components/RewardManager.tsx',    # Reference for the Dashboard/List view
    
    # --- Navigation (To inject menu items) ---
    'frontend/app/admin/super/layout.tsx',
    'frontend/app/admin/municipality/layout.tsx',
    'frontend/app/admin/club/layout.tsx',
]
# ==========================================

OUTPUT_FILE = 'focused_context.txt'

def generate_focused_context():
    with open(OUTPUT_FILE, 'w', encoding='utf-8') as out:
        out.write("=== FOCUSED CONTEXT ===\n\n")
        
        for path in TARGETS:
            # Check if file exists
            if not os.path.exists(path):
                out.write(f"\n--- MISSING FILE: {path} ---\n")
                continue

            # If it's a directory, walk it (shallow, 1 level deep usually preferred here but we'll do full)
            if os.path.isdir(path):
                for root, _, files in os.walk(path):
                    for file in files:
                        file_path = os.path.join(root, file)
                        try:
                            with open(file_path, 'r', encoding='utf-8') as f:
                                out.write(f"\n\n--- START OF FILE: {file_path} ---\n")
                                out.write(f.read())
                                out.write(f"\n--- END OF FILE: {file_path} ---\n")
                        except Exception as e:
                            out.write(f"\n--- ERROR READING: {file_path} ---\n")
            
            # If it's a file, just read it
            else:
                try:
                    with open(path, 'r', encoding='utf-8') as f:
                        out.write(f"\n\n--- START OF FILE: {path} ---\n")
                        out.write(f.read())
                        out.write(f"\n--- END OF FILE: {path} ---\n")
                except Exception as e:
                    out.write(f"\n--- ERROR READING: {path} ---\n")

    print(f"‚úÖ Focused context generated in: {OUTPUT_FILE}")

if __name__ == "__main__":
    generate_focused_context()
--- END OF FILE: ./generate_focused_context.py ---


--- START OF FILE: ./project_context.txt ---
=== PROJECT CONTEXT GENERATED ===
=== IGNORED: node_modules, venv, migrations, media, images ===

=== DIRECTORY STRUCTURE ===
./
    generate_focused_context.py
    project_context.txt
    frontend/
        postcss.config.mjs
        next-env.d.ts
        README.md
        package.json
        tsconfig.json
        eslint.config.mjs
        next.config.ts
        types/
            organization.ts
            post.ts
        context/
            AuthContext.tsx
        app/
            utils.ts
            layout.tsx
            page.tsx
            globals.css
            admin/
                club/
                    layout.tsx
                    page.tsx
                    settings/
                        page.tsx
                    posts/
                        page.tsx
                        edit/
                            [id]/
                                page.tsx
                        [id]/
                            page.tsx
                        create/
                            page.tsx
                    rewards/
                        page.tsx
                        edit/
                            [id]/
                                page.tsx
                        [id]/
                            page.tsx
                        create/
                            page.tsx
                    admins/
                        page.tsx
                    groups/
                        page.tsx
                        requests/
                            page.tsx
                        edit/
                            [id]/
                                page.tsx
                        [id]/
                            page.tsx
                        create/
                            page.tsx
                    msgboard/
                        page.tsx
                    youth/
                        page.tsx
                        [id]/
                            page.tsx
                    guardians/
                        page.tsx
                        [id]/
                            page.tsx
                    profile/
                        page.tsx
                    news-feed/
                        page.tsx
                        archive/
                            page.tsx
                        [id]/
                            page.tsx
                    custom-fields/
                        page.tsx
                super/
                    layout.tsx
                    page.tsx
                    municipalities/
                        page.tsx
                        [id]/
                            page.tsx
                    messages/
                        page.tsx
                    posts/
                        page.tsx
                        edit/
                            [id]/
                                page.tsx
                        [id]/
                            page.tsx
                        create/
                            page.tsx
                    clubs/
                        page.tsx
                        [id]/
                            page.tsx
                    rewards/
                        page.tsx
                        edit/
                            [id]/
                                page.tsx
                        [id]/
                            page.tsx
                        create/
                            page.tsx
                    admins/
                        page.tsx
                    groups/
                        page.tsx
                        requests/
                            page.tsx
                        edit/
                            [id]/
                                page.tsx
                        [id]/
                            page.tsx
                        create/
                            page.tsx
                    youth/
                        page.tsx
                        [id]/
                            page.tsx
                    guardians/
                        page.tsx
                        [id]/
                            page.tsx
                    profile/
                        page.tsx
                    news/
                        page.tsx
                        tags/
                            page.tsx
                    news-feed/
                        page.tsx
                        archive/
                            page.tsx
                        [id]/
                            page.tsx
                    custom-fields/
                        page.tsx
                    countries/
                        page.tsx
                    interests/
                        page.tsx
                municipality/
                    layout.tsx
                    page.tsx
                    settings/
                        page.tsx
                    posts/
                        page.tsx
                        edit/
                            [id]/
                                page.tsx
                        [id]/
                            page.tsx
                        create/
                            page.tsx
                    clubs/
                        page.tsx
                        [id]/
                            page.tsx
                    rewards/
                        page.tsx
                        edit/
                            [id]/
                                page.tsx
                        [id]/
                            page.tsx
                        create/
                            page.tsx
                    admins/
                        page.tsx
                    groups/
                        page.tsx
                        requests/
                            page.tsx
                        edit/
                            [id]/
                                page.tsx
                        [id]/
                            page.tsx
                        create/
                            page.tsx
                    msgboard/
                        page.tsx
                    youth/
                        page.tsx
                        [id]/
                            page.tsx
                    guardians/
                        page.tsx
                        [id]/
                            page.tsx
                    profile/
                        page.tsx
                    news-feed/
                        page.tsx
                        archive/
                            page.tsx
                        [id]/
                            page.tsx
                    custom-fields/
                        page.tsx
            dashboard/
                youth/
                    page.tsx
                guardian/
                    page.tsx
            components/
                SystemAlert.tsx
                NewsArticleReader.tsx
                NewsFeed.tsx
                CustomFieldsDisplay.tsx
                GroupForm.tsx
                RewardDetailView.tsx
                NewsArchive.tsx
                CustomRuleBuilder.tsx
                GroupDetailView.tsx
                RewardManager.tsx
                GroupManager.tsx
                GroupRequestsManager.tsx
                CustomFieldsForm.tsx
                DeleteConfirmationModal.tsx
                RichTextEditor.tsx
                CustomFieldManager.tsx
                Toast.tsx
                RewardForm.tsx
                MemberSelector.tsx
                posts/
                    PostForm.tsx
            login/
                page.tsx
        public/
        lib/
            api.ts
    backend/
        manage.py
        organization/
            models.py
            serializers.py
            __init__.py
            apps.py
            admin.py
            tests.py
            urls.py
            views.py
        posts/
            models.py
            serializers.py
            __init__.py
            apps.py
            admin.py
            tests.py
            views.py
        core/
            asgi.py
            __init__.py
            settings.py
            urls.py
            wsgi.py
        system_messages/

--- END OF FILE: ./project_context.txt ---


--- START OF FILE: ./frontend/postcss.config.mjs ---
const config = {
  plugins: {
    "@tailwindcss/postcss": {},
  },
};

export default config;

--- END OF FILE: ./frontend/postcss.config.mjs ---


--- START OF FILE: ./frontend/next-env.d.ts ---
/// <reference types="next" />
/// <reference types="next/image-types/global" />
import "./.next/dev/types/routes.d.ts";

// NOTE: This file should not be edited
// see https://nextjs.org/docs/app/api-reference/config/typescript for more information.

--- END OF FILE: ./frontend/next-env.d.ts ---


--- START OF FILE: ./frontend/README.md ---
This is a [Next.js](https://nextjs.org) project bootstrapped with [`create-next-app`](https://nextjs.org/docs/app/api-reference/cli/create-next-app).

## Getting Started

First, run the development server:

```bash
npm run dev
# or
yarn dev
# or
pnpm dev
# or
bun dev
```

Open [http://localhost:3000](http://localhost:3000) with your browser to see the result.

You can start editing the page by modifying `app/page.tsx`. The page auto-updates as you edit the file.

This project uses [`next/font`](https://nextjs.org/docs/app/building-your-application/optimizing/fonts) to automatically optimize and load [Geist](https://vercel.com/font), a new font family for Vercel.

## Learn More

To learn more about Next.js, take a look at the following resources:

- [Next.js Documentation](https://nextjs.org/docs) - learn about Next.js features and API.
- [Learn Next.js](https://nextjs.org/learn) - an interactive Next.js tutorial.

You can check out [the Next.js GitHub repository](https://github.com/vercel/next.js) - your feedback and contributions are welcome!

## Deploy on Vercel

The easiest way to deploy your Next.js app is to use the [Vercel Platform](https://vercel.com/new?utm_medium=default-template&filter=next.js&utm_source=create-next-app&utm_campaign=create-next-app-readme) from the creators of Next.js.

Check out our [Next.js deployment documentation](https://nextjs.org/docs/app/building-your-application/deploying) for more details.

--- END OF FILE: ./frontend/README.md ---


--- START OF FILE: ./frontend/package.json ---
{
  "name": "frontend",
  "version": "0.1.0",
  "private": true,
  "scripts": {
    "dev": "next dev",
    "build": "next build",
    "start": "next start",
    "lint": "eslint"
  },
  "dependencies": {
    "@react-google-maps/api": "^2.20.7",
    "axios": "^1.13.2",
    "js-cookie": "^3.0.5",
    "next": "16.0.3",
    "react": "19.2.0",
    "react-dom": "19.2.0",
    "react-quill-new": "^3.6.0"
  },
  "devDependencies": {
    "@tailwindcss/postcss": "^4",
    "@types/js-cookie": "^3.0.6",
    "@types/node": "^20",
    "@types/react": "^19",
    "@types/react-dom": "^19",
    "eslint": "^9",
    "eslint-config-next": "16.0.3",
    "tailwindcss": "^4",
    "typescript": "^5"
  }
}

--- END OF FILE: ./frontend/package.json ---


--- START OF FILE: ./frontend/tsconfig.json ---
{
  "compilerOptions": {
    "target": "ES2017",
    "lib": ["dom", "dom.iterable", "esnext"],
    "allowJs": true,
    "skipLibCheck": true,
    "strict": true,
    "noEmit": true,
    "esModuleInterop": true,
    "module": "esnext",
    "moduleResolution": "bundler",
    "resolveJsonModule": true,
    "isolatedModules": true,
    "jsx": "react-jsx",
    "incremental": true,
    "plugins": [
      {
        "name": "next"
      }
    ],
    "paths": {
      "@/*": ["./*"]
    }
  },
  "include": [
    "next-env.d.ts",
    "**/*.ts",
    "**/*.tsx",
    ".next/types/**/*.ts",
    ".next/dev/types/**/*.ts",
    "**/*.mts"
  ],
  "exclude": ["node_modules"]
}

--- END OF FILE: ./frontend/tsconfig.json ---


--- START OF FILE: ./frontend/eslint.config.mjs ---
import { defineConfig, globalIgnores } from "eslint/config";
import nextVitals from "eslint-config-next/core-web-vitals";
import nextTs from "eslint-config-next/typescript";

const eslintConfig = defineConfig([
  ...nextVitals,
  ...nextTs,
  // Override default ignores of eslint-config-next.
  globalIgnores([
    // Default ignores of eslint-config-next:
    ".next/**",
    "out/**",
    "build/**",
    "next-env.d.ts",
  ]),
]);

export default eslintConfig;

--- END OF FILE: ./frontend/eslint.config.mjs ---


--- START OF FILE: ./frontend/next.config.ts ---
import type { NextConfig } from "next";

const nextConfig: NextConfig = {
  /* config options here */
};

export default nextConfig;

--- END OF FILE: ./frontend/next.config.ts ---


--- START OF FILE: ./frontend/types/organization.ts ---
// frontend/types/organization.ts

export interface OpeningHour {
    id: number;
    weekday: number;
    weekday_display: string;
    week_cycle: string;
    open_time: string;
    close_time: string;
    title: string;
}

export interface Club {
    id: number;
    name: string;
    municipality: number;
    municipality_name: string;
    description: string;
    email: string;
    phone: string;
    avatar: string | null;
    hero_image: string | null;
    address: string;
    allowed_age_groups: string;
    club_categories: string;
    regular_hours: OpeningHour[];
}


--- END OF FILE: ./frontend/types/organization.ts ---


--- START OF FILE: ./frontend/types/post.ts ---
export interface PostImage {
    id: number;
    image: string;
    order: number;
}

export interface Post {
    id: number;
    title: string;
    content: string;
    post_type: 'TEXT' | 'IMAGE' | 'VIDEO';
    video_url?: string;
    
    // Distribution / Scope
    is_global: boolean;
    target_municipalities: number[];
    target_clubs: number[];
    
    // Status & Scheduling
    status: 'DRAFT' | 'SCHEDULED' | 'PUBLISHED' | 'ARCHIVED';
    published_at?: string; 
    visibility_end_date?: string; 
    is_pinned: boolean;

    // Targeting (Audience)
    target_member_type: 'YOUTH' | 'GUARDIAN' | 'BOTH';
    target_groups: number[];
    target_interests: number[];
    target_genders: string[];
    target_grades: number[];
    target_min_age?: number;
    target_max_age?: number;
    target_custom_fields?: Record<string, any>;

    // Settings
    allow_comments: boolean;
    require_moderation: boolean;
    limit_comments_per_user: number;
    allow_replies: boolean;
    send_push_notification: boolean;
    push_title?: string;
    push_message?: string;

    // Metrics
    view_count: number;
    comment_count: number;

    // Relations
    author?: {
        id: number;
        first_name: string;
        last_name: string;
    };
    images: PostImage[];
    created_at: string;
}

--- END OF FILE: ./frontend/types/post.ts ---


--- START OF FILE: ./frontend/context/AuthContext.tsx ---
'use client';

import { createContext, useContext, useState, useEffect, ReactNode } from 'react';
import Cookies from 'js-cookie';
import api from '../lib/api';
import { useRouter } from 'next/navigation';

interface User {
  id: number;
  email: string;
  first_name: string;
  last_name: string;
  role: string;
  avatar: string | null;
  assigned_municipality?: number | { id: number } | null;
  assigned_club?: number | { id: number } | null;
}

interface AuthContextType {
  user: User | null;
  login: (email: string, password: string) => Promise<void>;
  logout: () => void;
  loading: boolean;
  messageCount: number;
  refreshMessageCount: () => Promise<void>;
}

const AuthContext = createContext<AuthContextType | undefined>(undefined);

export function AuthProvider({ children }: { children: ReactNode }) {
  const [user, setUser] = useState<User | null>(null);
  const [loading, setLoading] = useState(true);
  const [messageCount, setMessageCount] = useState(0);
  const router = useRouter();

  // Check if user is already logged in when page loads
  useEffect(() => {
    const checkUser = async () => {
      const token = Cookies.get('access_token');
      if (token) {
        try {
          const res = await api.get('/auth/users/me/');
          const userData = res.data;
          setUser(userData);
          // Refresh message count after user is loaded
          try {
            const msgRes = await api.get('/messages/active_list/');
            const list = Array.isArray(msgRes.data) ? msgRes.data : [];
            setMessageCount(list.length);
          } catch (msgErr: any) {
            // Silently handle 401 for message count
            if (msgErr?.response?.status !== 401) {
              console.error('Failed to load message count', msgErr);
            }
            setMessageCount(0);
          }
        } catch (error) {
          console.error("Session expired", error);
          Cookies.remove('access_token');
          setMessageCount(0);
        }
      }
      setLoading(false);
    };
    checkUser();
  }, []);

  const refreshMessageCount = async () => {
    // Only fetch message count if user is authenticated
    if (!user) {
      setMessageCount(0);
      return;
    }
    
    try {
      const res = await api.get('/messages/active_list/');
      const list = Array.isArray(res.data) ? res.data : [];
      setMessageCount(list.length);
    } catch (err: any) {
      // Silently handle 401 (unauthorized) - user might not be logged in or token expired
      if (err?.response?.status === 401) {
        setMessageCount(0);
        return;
      }
      console.error('Failed to load message count', err);
      setMessageCount(0);
    }
  };

  const login = async (email: string, password: string) => {
    try {
      // 1. Get Token
      const res = await api.post('/auth/jwt/create/', { email, password });
      Cookies.set('access_token', res.data.access, { expires: 1 }); // Expires in 1 day
      Cookies.set('refresh_token', res.data.refresh, { expires: 1 });

      // 2. Get User Details
      const userRes = await api.get('/auth/users/me/');
      const userData = userRes.data;
      setUser(userData);
      refreshMessageCount();

      // Log the successful login for audit trail (ignore failures)
      try {
        await api.post('/users/log_login/');
      } catch (logErr) {
        console.error('Failed to log login event', logErr);
      }

      // 3. Redirect based on Role
      switch (userData.role) {
        case 'SUPER_ADMIN':
          router.push('/admin/super');
          break;
        case 'MUNICIPALITY_ADMIN':
          router.push('/admin/municipality');
          break;
        case 'CLUB_ADMIN':
          router.push('/admin/club');
          break;
        case 'GUARDIAN':
          router.push('/dashboard/guardian');
          break;
        case 'YOUTH_MEMBER':
          router.push('/dashboard/youth');
          break;
        default:
          router.push('/');
      }
    } catch (error) {
      console.error("Login failed", error);
      throw error;
    }
  };

  const logout = () => {
    Cookies.remove('access_token');
    Cookies.remove('refresh_token');
    setUser(null);
    setMessageCount(0);
    router.push('/login');
  };

  return (
    <AuthContext.Provider value={{ user, login, logout, loading, messageCount, refreshMessageCount }}>
      {children}
    </AuthContext.Provider>
  );
}

export const useAuth = () => {
  const context = useContext(AuthContext);
  if (!context) throw new Error('useAuth must be used within an AuthProvider');
  return context;
};
--- END OF FILE: ./frontend/context/AuthContext.tsx ---


--- START OF FILE: ./frontend/app/utils.ts ---
export const getMediaUrl = (path: string | null | undefined) => {
    if (!path) return null;
    
    // If it's already a full URL (starts with http), return it as is
    if (path.startsWith('http')) {
      return path;
    }
  
    // Ensure path starts with / for proper URL construction
    const normalizedPath = path.startsWith('/') ? path : `/${path}`;
    
    // Otherwise, prepend the Django Backend URL
    // We use localhost:8000 because that's where Django is running
    return `http://localhost:8000${normalizedPath}`;
  };
--- END OF FILE: ./frontend/app/utils.ts ---


--- START OF FILE: ./frontend/app/layout.tsx ---
import type { Metadata } from "next";
import { Inter } from "next/font/google";
import "./globals.css";
import { AuthProvider } from "../context/AuthContext";
import SystemAlert from "./components/SystemAlert";

const inter = Inter({ subsets: ["latin"] });

export const metadata: Metadata = {
  title: "The Youth App",
  description: "Ungdomsappen 2.0",
};

export default function RootLayout({
  children,
}: Readonly<{
  children: React.ReactNode;
}>) {
  return (
    <html lang="en">
      <body className={inter.className}>
        <AuthProvider>
          <SystemAlert />
          {children}
        </AuthProvider>
      </body>
    </html>
  );
}
--- END OF FILE: ./frontend/app/layout.tsx ---


--- START OF FILE: ./frontend/app/page.tsx ---
'use client';

import { useState, useEffect } from 'react';
import Link from 'next/link'; // We need this for navigation
import { Club } from '../types/organization';
import { getMediaUrl } from './utils';
import { useAuth } from '../context/AuthContext'; // Import Auth

export default function Home() {
  const [clubs, setClubs] = useState<Club[]>([]);
  const [loadingClubs, setLoadingClubs] = useState(true);
  
  // Get user info from our Auth Context
  const { user, logout, loading: authLoading } = useAuth();

  useEffect(() => {
    fetch('http://localhost:8000/api/clubs/')
      .then((res) => res.json())
      .then((data) => {
        setClubs(data);
        setLoadingClubs(false);
      })
      .catch((err) => {
        console.error('Error fetching clubs:', err);
        setLoadingClubs(false);
      });
  }, []);

  return (
    <main className="min-h-screen bg-gray-50 text-gray-900 font-sans">
      {/* HEADER */}
      <header className="bg-blue-600 text-white p-6 shadow-md">
        <div className="max-w-7xl mx-auto flex justify-between items-center">
          <h1 className="text-3xl font-bold tracking-tight">Ungdomsappen</h1>
          
          <div className="flex items-center gap-4">
            {!authLoading && (
              <>
                {user ? (
                  // LOGGED IN STATE
                  <div className="flex items-center gap-4">
                    <span className="hidden md:block font-medium">Hi, {user.first_name}</span>
                    
                    {/* Link back to their specific dashboard based on role */}
                    <Link 
                      href={
                        user.role === 'SUPER_ADMIN' ? '/admin/super' :
                        user.role === 'MUNICIPALITY_ADMIN' ? '/admin/municipality' :
                        user.role === 'CLUB_ADMIN' ? '/admin/club' :
                        user.role === 'GUARDIAN' ? '/dashboard/guardian' :
                        '/dashboard/youth'
                      }
                      className="bg-white text-blue-600 px-4 py-2 rounded-lg font-bold text-sm hover:bg-gray-100 transition"
                    >
                      My Dashboard
                    </Link>

                    <button 
                      onClick={logout}
                      className="bg-blue-800 px-4 py-2 rounded-lg text-sm hover:bg-blue-700 transition"
                    >
                      Logout
                    </button>
                  </div>
                ) : (
                  // LOGGED OUT STATE
                  <Link 
                    href="/login"
                    className="bg-blue-800 px-4 py-2 rounded-lg hover:bg-blue-700 transition"
                  >
                    Login
                  </Link>
                )}
              </>
            )}
          </div>
        </div>
      </header>

      {/* MAIN CONTENT */}
      <div className="max-w-7xl mx-auto p-6 mt-8">
        <h2 className="text-2xl font-bold mb-6 text-gray-800">Explore Clubs</h2>
        
        {loadingClubs ? (
          <p>Loading clubs...</p>
        ) : (
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
            {clubs.map((club) => {
              const heroUrl = getMediaUrl(club.hero_image);
              const avatarUrl = getMediaUrl(club.avatar);

              return (
                <div key={club.id} className="bg-white rounded-xl shadow-lg overflow-hidden border border-gray-100 flex flex-col h-full hover:shadow-xl transition">
                  {/* HERO IMAGE */}
                  <div className="h-48 bg-gray-200 w-full relative">
                    {heroUrl ? (
                      <img 
                        src={heroUrl} 
                        alt={club.name} 
                        className="w-full h-full object-cover"
                        onError={(e) => {
                          (e.target as HTMLImageElement).src = 'https://via.placeholder.com/400x200?text=No+Image';
                        }}
                      />
                    ) : (
                      <div className="flex items-center justify-center h-full text-gray-400">
                        No Image
                      </div>
                    )}
                    
                    <div className="absolute -bottom-6 left-6">
                      {avatarUrl && (
                        <img 
                          src={avatarUrl} 
                          alt="Avatar" 
                          className="w-16 h-16 rounded-full border-4 border-white shadow-md bg-white object-cover" 
                        />
                      )}
                    </div>
                  </div>

                  <div className="p-6 pt-8 flex-grow">
                    <h3 className="text-xl font-bold text-gray-900">{club.name}</h3>
                    <p className="text-sm text-blue-600 font-medium mb-2">{club.municipality_name}</p>
                    <p className="text-gray-600 text-sm mb-4 line-clamp-3">
                      {club.description}
                    </p>
                    <div className="text-xs text-gray-500 space-y-1">
                      <p>üìç {club.address || 'No address set'}</p>
                      <p>üìß {club.email}</p>
                    </div>
                  </div>
                  
                  <div className="bg-gray-50 p-4 border-t border-gray-100">
                    <button className="w-full py-2 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700 transition">
                      Visit Club
                    </button>
                  </div>
                </div>
              );
            })}
          </div>
        )}
      </div>
    </main>
  );
}
--- END OF FILE: ./frontend/app/page.tsx ---


--- START OF FILE: ./frontend/app/globals.css ---
@import "tailwindcss";

:root {
  --background: #ffffff;
  --foreground: #171717;
}

@theme inline {
  --color-background: var(--background);
  --color-foreground: var(--foreground);
  --font-sans: var(--font-geist-sans);
  --font-mono: var(--font-geist-mono);
}

@media (prefers-color-scheme: dark) {
  :root {
    --background: #0a0a0a;
    --foreground: #ededed;
  }
}

body {
  background: var(--background);
  color: var(--foreground);
  font-family: Arial, Helvetica, sans-serif;
}

@keyframes slide-in {
  from {
    transform: translateX(100%);
    opacity: 0;
  }
  to {
    transform: translateX(0);
    opacity: 1;
  }
}

.animate-slide-in {
  animation: slide-in 0.3s ease-out;
}

/* News Content Styles */
.news-content h1 { @apply text-3xl font-bold mt-6 mb-4 text-gray-900; }
.news-content h2 { @apply text-2xl font-bold mt-5 mb-3 text-gray-800; }
.news-content h3 { @apply text-xl font-bold mt-4 mb-2 text-gray-800; }
.news-content p { @apply mb-4 leading-relaxed text-gray-700; }
.news-content ul { @apply list-disc list-inside mb-4 space-y-1; }
.news-content ol { @apply list-decimal list-inside mb-4 space-y-1; }
.news-content a { @apply text-blue-600 underline hover:text-blue-800; }
.news-content blockquote { @apply border-l-4 border-gray-300 pl-4 italic text-gray-600 my-4; }
.news-content img { @apply rounded-lg max-w-full h-auto my-6 shadow-md; }
--- END OF FILE: ./frontend/app/globals.css ---


--- START OF FILE: ./frontend/app/admin/club/layout.tsx ---
'use client';

import { useEffect, useState } from 'react';
import Link from 'next/link';
import { usePathname } from 'next/navigation';
import { useAuth } from '../../../context/AuthContext';
import { getMediaUrl } from '../../utils';
import api from '../../../lib/api';

const getInitials = (first?: string | null, last?: string | null) => {
  const firstInitial = first?.charAt(0)?.toUpperCase() || '';
  const lastInitial = last?.charAt(0)?.toUpperCase() || '';
  return firstInitial + lastInitial || 'C';
};

export default function ClubAdminLayout({ children }: { children: React.ReactNode }) {
  const pathname = usePathname();
  const { logout, user, messageCount, refreshMessageCount } = useAuth();
  const [pendingRequestsCount, setPendingRequestsCount] = useState(0);

  useEffect(() => {
    refreshMessageCount();
    refreshPendingRequestsCount();
  }, [refreshMessageCount]);

  const refreshPendingRequestsCount = async () => {
    if (!user) {
      setPendingRequestsCount(0);
      return;
    }
    
    try {
      const res = await api.get('/group-requests/');
      const data = Array.isArray(res.data) ? res.data : (res.data.results || []);
      setPendingRequestsCount(data.length);
    } catch (err: any) {
      // Silently handle 401 (unauthorized) - user might not be logged in or token expired
      if (err?.response?.status === 401) {
        setPendingRequestsCount(0);
        return;
      }
      console.error('Failed to load pending requests count', err);
      setPendingRequestsCount(0);
    }
  };

  const navigation = [
    { name: 'Overview', href: '/admin/club' },
    { name: 'Club Settings', href: '/admin/club/settings' },
    { name: 'Manage Admins', href: '/admin/club/admins' },
    { name: 'Manage Youth', href: '/admin/club/youth' },
    { name: 'Manage Guardians', href: '/admin/club/guardians' },
    { name: 'News Feed', href: '/admin/club/news-feed' },
    { name: 'Manage Posts', href: '/admin/club/posts' },
    { name: 'Groups', href: '/admin/club/groups' },
    { name: 'Applications', href: '/admin/club/groups/requests', showBadge: true },
    { name: 'Manage Rewards', href: '/admin/club/rewards' },
    { name: 'Message Board', href: '/admin/club/msgboard', showBadge: true },
    { name: 'Custom Fields', href: '/admin/club/custom-fields' },
  ];

  return (
    <div className="min-h-screen bg-gray-100 flex">
      <aside className="w-64 bg-slate-900 text-white flex flex-col flex-shrink-0">
        <div className="p-6 border-b border-slate-800 flex items-center gap-3">
          <Link href="/admin/club/profile" className="inline-block">
            {user?.avatar ? (
              <img
                src={getMediaUrl(user.avatar) || ''}
                alt="Profile avatar"
                className="w-12 h-12 rounded-full object-cover border-2 border-blue-400"
              />
            ) : (
              <div className="w-12 h-12 rounded-full bg-blue-500 text-white flex items-center justify-center text-lg font-semibold border-2 border-blue-400">
                {getInitials(user?.first_name, user?.last_name)}
              </div>
            )}
          </Link>
          <div className="leading-tight">
            <h2 className="text-base font-semibold text-blue-100">
              {user?.first_name || ''} {user?.last_name || ''}
            </h2>
            <p className="text-[11px] uppercase tracking-wide text-slate-400">
              {user?.role?.replace(/_/g, ' ') || 'Club Admin'}
            </p>
          </div>
        </div>

        <nav className="flex-1 p-4 space-y-2">
          {navigation.map((item) => {
            const isActive = pathname === item.href;
            return (
              <Link
                key={item.name}
                href={item.href}
                className={`flex items-center justify-between px-4 py-3 rounded-lg text-sm font-medium transition-colors ${
                  isActive ? 'bg-blue-600 text-white shadow-md' : 'text-slate-300 hover:bg-slate-800 hover:text-white'
                }`}
              >
                <span>{item.name}</span>
                {item.showBadge && item.href.includes('/requests') && pendingRequestsCount > 0 && (
                  <span className="ml-2 inline-flex items-center justify-center rounded-full bg-red-500 text-white text-xs font-bold min-w-[1.5rem] px-2 py-0.5">
                    {pendingRequestsCount}
                  </span>
                )}
                {item.showBadge && !item.href.includes('/requests') && messageCount > 0 && (
                  <span className="ml-2 inline-flex items-center justify-center rounded-full bg-red-500 text-white text-xs font-bold min-w-[1.5rem] px-2 py-0.5">
                    {messageCount}
                  </span>
                )}
              </Link>
            );
          })}
        </nav>

        <div className="p-4 border-t border-slate-800">
          <button
            onClick={logout}
            className="w-full py-2 px-4 bg-red-600 hover:bg-red-700 rounded text-sm font-bold transition"
          >
            Sign Out
          </button>
        </div>
      </aside>

      <main className="flex-1 p-8 overflow-y-auto">{children}</main>
    </div>
  );
}


--- END OF FILE: ./frontend/app/admin/club/layout.tsx ---


--- START OF FILE: ./frontend/app/admin/club/page.tsx ---
'use client';

import { useAuth } from '../../../context/AuthContext';

export default function ClubAdminDashboard() {
  const { user, logout } = useAuth();

  return (
    <div className="min-h-screen bg-gray-100 p-10">
      <div className="flex justify-between items-center mb-8">
        <h1 className="text-3xl font-bold text-green-600">Club Admin</h1>
        <div className="flex gap-4 items-center">
          <span className="text-gray-600">Welcome, {user?.first_name}</span>
          <button onClick={logout} className="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">
            Logout
          </button>
        </div>
      </div>
      <div className="bg-white p-6 rounded-lg shadow">
        <p>Manage your daily club operations, events, and members here.</p>
      </div>
    </div>
  );
}
--- END OF FILE: ./frontend/app/admin/club/page.tsx ---


--- START OF FILE: ./frontend/app/admin/club/settings/page.tsx ---
'use client';

import { useState, useEffect } from 'react';
import api from '../../../../lib/api';
import { useAuth } from '../../../../context/AuthContext';
import { getMediaUrl } from '../../../utils';
import Toast from '../../../components/Toast';

interface ClubFormState {
  name: string;
  description: string;
  email: string;
  phone: string;
  address: string;
  terms_and_conditions: string;
  club_policies: string;
  latitude: string;
  longitude: string;
  club_categories: string;
}

export default function ClubSettingsPage() {
  const { user, loading } = useAuth();
  const [isLoading, setIsLoading] = useState(true);
  const [isSaving, setIsSaving] = useState(false);
  const [clubData, setClubData] = useState<any>(null);
  const [avatarFile, setAvatarFile] = useState<File | null>(null);
  const [avatarPreview, setAvatarPreview] = useState<string | null>(null);
  const [heroFile, setHeroFile] = useState<File | null>(null);
  const [heroPreview, setHeroPreview] = useState<string | null>(null);
  const [toast, setToast] = useState<{ message: string; type: 'success' | 'error'; isVisible: boolean }>({
    message: '',
    type: 'success',
    isVisible: false,
  });

  const [formData, setFormData] = useState<ClubFormState>({
    name: '',
    description: '',
    email: '',
    phone: '',
    address: '',
    terms_and_conditions: '',
    club_policies: '',
    latitude: '',
    longitude: '',
    club_categories: '',
  });

  useEffect(() => {
    if (!loading && user) {
      fetchClub();
    }
  }, [user, loading]);

  const fetchClub = async () => {
    const assigned = user?.assigned_club;
    const clubId =
      typeof assigned === 'object' && assigned !== null ? (assigned as any).id : typeof assigned === 'number' ? assigned : null;

    if (!clubId) {
      setIsLoading(false);
      return;
    }

    try {
      const res = await api.get(`/clubs/${clubId}/`);
      const data = res.data;
      setClubData(data);
      setFormData({
        name: data.name || '',
        description: data.description || '',
        email: data.email || '',
        phone: data.phone || '',
        address: data.address || '',
        terms_and_conditions: data.terms_and_conditions || '',
        club_policies: data.club_policies || '',
        latitude: data.latitude !== null && data.latitude !== undefined ? String(data.latitude) : '',
        longitude: data.longitude !== null && data.longitude !== undefined ? String(data.longitude) : '',
        club_categories: data.club_categories || '',
      });
      setAvatarPreview(data.avatar ? getMediaUrl(data.avatar) : null);
      setHeroPreview(data.hero_image ? getMediaUrl(data.hero_image) : null);
    } catch (err) {
      console.error('Failed to load club data', err);
    } finally {
      setIsLoading(false);
    }
  };

  const handleFileChange = (e: React.ChangeEvent<HTMLInputElement>, type: 'avatar' | 'hero') => {
    const file = e.target.files?.[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onloadend = () => {
      if (type === 'avatar') {
        setAvatarFile(file);
        setAvatarPreview(reader.result as string);
      } else {
        setHeroFile(file);
        setHeroPreview(reader.result as string);
      }
    };
    reader.readAsDataURL(file);
  };

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    if (!clubData) return;
    setIsSaving(true);

    try {
      const data = new FormData();
      data.append('name', formData.name);
      data.append('description', formData.description);
      data.append('email', formData.email);
      data.append('phone', formData.phone);
      data.append('address', formData.address);
      data.append('terms_and_conditions', formData.terms_and_conditions);
      data.append('club_policies', formData.club_policies);
      if (formData.latitude.trim() !== '') data.append('latitude', formData.latitude);
      if (formData.longitude.trim() !== '') data.append('longitude', formData.longitude);
      data.append('club_categories', formData.club_categories);
      data.append('municipality', clubData.municipality);

      if (avatarFile) data.append('avatar', avatarFile);
      if (heroFile) data.append('hero_image', heroFile);

      await api.patch(`/clubs/${clubData.id}/`, data, { headers: { 'Content-Type': 'multipart/form-data' } });
      setToast({ message: 'Club settings updated!', type: 'success', isVisible: true });
      setAvatarFile(null);
      setHeroFile(null);
      fetchClub();
    } catch (err) {
      console.error(err);
      setToast({ message: 'Failed to update club settings.', type: 'error', isVisible: true });
    } finally {
      setIsSaving(false);
    }
  };

  if (loading || isLoading) {
    return <div className="p-10 text-center">Loading...</div>;
  }

  if (!clubData) {
    return <div className="p-10 text-center">No club assigned. Please contact your administrator.</div>;
  }

  return (
    <div className="space-y-6">
      <div className="rounded-2xl bg-gradient-to-r from-indigo-600 to-blue-600 text-white p-8 shadow-lg">
        <div className="flex flex-col md:flex-row md:items-center md:justify-between gap-6">
          <div>
            <p className="text-sm uppercase tracking-widest text-white/70 font-semibold">Club Admin</p>
            <h1 className="text-3xl font-bold mt-1">My Club Settings</h1>
            <p className="text-white/80 mt-2 max-w-2xl">
              Update your club profile information. Changes are instantly visible to your members.
            </p>
          </div>
          <div className="flex gap-4">
            <div className="bg-white/15 rounded-xl px-6 py-4 text-center">
              <p className="text-xs uppercase tracking-widest text-white/70">Club</p>
              <p className="text-xl font-bold">{formData.name || '‚Äî'}</p>
            </div>
            <div className="bg-white/15 rounded-xl px-6 py-4 text-center">
              <p className="text-xs uppercase tracking-widest text-white/70">Municipality</p>
              <p className="text-xl font-bold">{clubData.municipality_name || '‚Äî'}</p>
            </div>
          </div>
        </div>
      </div>

      <div className="bg-white rounded-2xl shadow-xl p-8 border border-slate-100">
        <form className="space-y-10" onSubmit={handleSubmit}>
          <section className="space-y-4">
            <div className="flex items-center justify-between">
              <div>
                <h3 className="text-lg font-semibold text-slate-900">Branding</h3>
                <p className="text-sm text-slate-500">Keep your club visuals fresh and inviting.</p>
              </div>
            </div>
            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div className="bg-slate-50 p-4 rounded-xl border border-dashed border-slate-200">
                <label className="block text-xs font-semibold uppercase text-slate-500 mb-3">Logo / Avatar</label>
                <div className="flex items-center gap-4">
                  {avatarPreview ? (
                    <img src={avatarPreview} className="w-20 h-20 object-contain bg-white rounded-xl shadow" alt="Avatar" />
                  ) : (
                    <div className="w-20 h-20 bg-slate-200 rounded-xl flex items-center justify-center text-slate-400 text-sm">
                      No Img
                    </div>
                  )}
                  <input type="file" accept="image/*" className="text-sm" onChange={(e) => handleFileChange(e, 'avatar')} />
                </div>
              </div>

              <div className="bg-slate-50 p-4 rounded-xl border border-dashed border-slate-200">
                <label className="block text-xs font-semibold uppercase text-slate-500 mb-3">Hero Banner</label>
                <div className="space-y-3">
                  {heroPreview ? (
                    <img src={heroPreview} className="w-full h-32 object-cover rounded-xl shadow" alt="Hero" />
                  ) : (
                    <div className="w-full h-32 bg-slate-200 rounded-xl flex items-center justify-center text-slate-400 text-sm">
                      No Hero Image
                    </div>
                  )}
                  <input type="file" accept="image/*" className="text-sm" onChange={(e) => handleFileChange(e, 'hero')} />
                </div>
              </div>
            </div>
          </section>

          <section className="space-y-4">
            <div>
              <h3 className="text-lg font-semibold text-slate-900">Basic Details</h3>
              <p className="text-sm text-slate-500">General information about your club.</p>
            </div>
            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div>
                <label className="block text-sm font-semibold mb-2 text-slate-700">Club Name</label>
                <input
                  type="text"
                  className="w-full border border-slate-200 p-3 rounded-xl focus:ring-2 focus:ring-blue-500"
                  value={formData.name}
                  onChange={(e) => setFormData({ ...formData, name: e.target.value })}
                />
              </div>
              <div>
                <label className="block text-sm font-semibold mb-2 text-slate-700">Club Categories</label>
                <input
                  type="text"
                  className="w-full border border-slate-200 p-3 rounded-xl focus:ring-2 focus:ring-blue-500"
                  value={formData.club_categories}
                  onChange={(e) => setFormData({ ...formData, club_categories: e.target.value })}
                />
              </div>
            </div>
            <div>
              <label className="block text-sm font-semibold mb-2 text-slate-700">Description</label>
              <textarea
                rows={3}
                className="w-full border border-slate-200 p-3 rounded-xl focus:ring-2 focus:ring-blue-500"
                value={formData.description}
                onChange={(e) => setFormData({ ...formData, description: e.target.value })}
              />
            </div>
          </section>

          <section className="space-y-4">
            <div>
              <h3 className="text-lg font-semibold text-slate-900">Contact</h3>
              <p className="text-sm text-slate-500">How members can reach your club.</p>
            </div>
            <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
              <div>
                <label className="block text-sm font-semibold mb-2 text-slate-700">Email</label>
                <input
                  type="email"
                  className="w-full border border-slate-200 p-3 rounded-xl focus:ring-2 focus:ring-blue-500"
                  value={formData.email}
                  onChange={(e) => setFormData({ ...formData, email: e.target.value })}
                />
              </div>
              <div>
                <label className="block text-sm font-semibold mb-2 text-slate-700">Phone</label>
                <input
                  type="text"
                  className="w-full border border-slate-200 p-3 rounded-xl focus:ring-2 focus:ring-blue-500"
                  value={formData.phone}
                  onChange={(e) => setFormData({ ...formData, phone: e.target.value })}
                />
              </div>
              <div>
                <label className="block text-sm font-semibold mb-2 text-slate-700">Address</label>
                <input
                  type="text"
                  className="w-full border border-slate-200 p-3 rounded-xl focus:ring-2 focus:ring-blue-500"
                  value={formData.address}
                  onChange={(e) => setFormData({ ...formData, address: e.target.value })}
                />
              </div>
            </div>
          </section>

          <section className="space-y-4">
            <div>
              <h3 className="text-lg font-semibold text-slate-900">Location</h3>
              <p className="text-sm text-slate-500">Map coordinates help visitors find the club.</p>
            </div>
            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div>
                <label className="block text-sm font-semibold mb-2 text-slate-700">Latitude</label>
                <input
                  type="text"
                  className="w-full border border-slate-200 p-3 rounded-xl focus:ring-2 focus:ring-blue-500"
                  value={formData.latitude}
                  onChange={(e) => setFormData({ ...formData, latitude: e.target.value })}
                  placeholder="e.g. 59.3293"
                />
              </div>
              <div>
                <label className="block text-sm font-semibold mb-2 text-slate-700">Longitude</label>
                <input
                  type="text"
                  className="w-full border border-slate-200 p-3 rounded-xl focus:ring-2 focus:ring-blue-500"
                  value={formData.longitude}
                  onChange={(e) => setFormData({ ...formData, longitude: e.target.value })}
                  placeholder="e.g. 18.0686"
                />
              </div>
            </div>
          </section>

          <section className="space-y-4">
            <div>
              <h3 className="text-lg font-semibold text-slate-900">Policies</h3>
              <p className="text-sm text-slate-500">Legal documents and guidelines for your club.</p>
            </div>
            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div>
                <label className="block text-sm font-semibold mb-2 text-slate-700">Terms & Conditions</label>
                <textarea
                  rows={4}
                  className="w-full border border-slate-200 p-3 rounded-xl focus:ring-2 focus:ring-blue-500"
                  value={formData.terms_and_conditions}
                  onChange={(e) => setFormData({ ...formData, terms_and_conditions: e.target.value })}
                />
              </div>
              <div>
                <label className="block text-sm font-semibold mb-2 text-slate-700">Club Policies</label>
                <textarea
                  rows={4}
                  className="w-full border border-slate-200 p-3 rounded-xl focus:ring-2 focus:ring-blue-500"
                  value={formData.club_policies}
                  onChange={(e) => setFormData({ ...formData, club_policies: e.target.value })}
                />
              </div>
            </div>
          </section>

          <div className="flex justify-end border-t border-slate-100 pt-6">
            <button
              type="submit"
              disabled={isSaving}
              className="bg-blue-600 text-white px-8 py-3 rounded-xl font-semibold shadow hover:bg-blue-700 transition disabled:opacity-50"
            >
              {isSaving ? 'Saving...' : 'Save Changes'}
            </button>
          </div>
        </form>
      </div>

      <Toast
        message={toast.message}
        type={toast.type}
        isVisible={toast.isVisible}
        onClose={() => setToast({ ...toast, isVisible: false })}
      />
    </div>
  );
}


--- END OF FILE: ./frontend/app/admin/club/settings/page.tsx ---


--- START OF FILE: ./frontend/app/admin/club/posts/page.tsx ---
'use client';

import { useEffect, useState } from 'react';
import Link from 'next/link';
import api from '../../../../lib/api';
import { Post } from '../../../../types/post';
import DeleteConfirmationModal from '../../../components/DeleteConfirmationModal';
import Toast from '../../../components/Toast';

export default function SuperAdminPostsPage() {
    const [posts, setPosts] = useState<any[]>([]); // Use any to handle the nested details easier
    const [stats, setStats] = useState<any>(null);
    const [loading, setLoading] = useState(true);
    
    // Delete Modal State
    const [showDeleteModal, setShowDeleteModal] = useState(false);
    const [postToDelete, setPostToDelete] = useState<{ id: number; title: string } | null>(null);
    const [isDeleting, setIsDeleting] = useState(false);
    
    // Toast State
    const [toast, setToast] = useState<{ message: string; type: 'success' | 'error' | 'info' | 'warning'; isVisible: boolean }>({
        message: '',
        type: 'success',
        isVisible: false,
    });

    const fetchData = async () => {
        try {
            const postsRes = await api.get('/posts/');
            setPosts(postsRes.data.results || postsRes.data);

            const statsRes = await api.get('/posts/analytics_overview/');
            setStats(statsRes.data);
        } catch (err) {
            console.error("Failed to fetch posts", err);
        } finally {
            setLoading(false);
        }
    };

    useEffect(() => {
        fetchData();
    }, []);

    const handleDeleteClick = (post: Post) => {
        setPostToDelete({ id: post.id, title: post.title });
        setShowDeleteModal(true);
    };

    const handleDeleteConfirm = async () => {
        if (!postToDelete) return;

        setIsDeleting(true);
        try {
            await api.delete(`/posts/${postToDelete.id}/`);
            setToast({ message: 'Post deleted successfully!', type: 'success', isVisible: true });
            setShowDeleteModal(false);
            setPostToDelete(null);
            fetchData(); 
        } catch (err) {
            setToast({ message: 'Failed to delete post.', type: 'error', isVisible: true });
        } finally {
            setIsDeleting(false);
        }
    };

    // Helper to determine what to show in the "Scope" column
    const getScopeBadge = (post: any) => {
        if (post.is_global) {
            return <span className="bg-purple-100 text-purple-800 px-2 py-1 rounded-full text-xs font-bold">üåç Global</span>;
        }
        
        // Super Admin creating for specific Munis
        if (post.target_municipalities_details && post.target_municipalities_details.length > 0) {
            const count = post.target_municipalities_details.length;
            const name = post.target_municipalities_details[0].name;
            return (
                <span className="bg-blue-100 text-blue-800 px-2 py-1 rounded-full text-xs font-bold">
                    üèõÔ∏è {count > 1 ? `${count} Municipalities` : name}
                </span>
            );
        }

        // Super/Muni Admin creating for specific Clubs
        if (post.target_clubs_details && post.target_clubs_details.length > 0) {
            const count = post.target_clubs_details.length;
            const name = post.target_clubs_details[0].name;
            return (
                <span className="bg-green-100 text-green-800 px-2 py-1 rounded-full text-xs font-bold">
                    ‚öΩ {count > 1 ? `${count} Clubs` : name}
                </span>
            );
        }

        // Fallback based on ownership
        if (post.owner_role === 'MUNICIPALITY_ADMIN') return <span className="text-gray-500 text-xs">Municipality</span>;
        if (post.owner_role === 'CLUB_ADMIN') return <span className="text-gray-500 text-xs">Club</span>;

        return <span className="text-gray-400 text-xs">-</span>;
    };

    if (loading) return <div className="p-8 text-center">Loading posts...</div>;

    return (
        <div className="space-y-6">
            {/* Header */}
            <div className="flex justify-between items-center">
                <h1 className="text-2xl font-bold text-gray-800">Post Management</h1>
                <Link 
                    href="/admin/super/posts/create"
                    className="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md font-medium"
                >
                    + Create New Post
                </Link>
            </div>

            {/* Analytics Cards */}
            {stats && (
                <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div className="bg-white p-4 rounded-lg shadow border-l-4 border-blue-500">
                        <p className="text-sm text-gray-500">Total Posts</p>
                        <p className="text-2xl font-bold">{stats.total_posts}</p>
                    </div>
                    <div className="bg-white p-4 rounded-lg shadow border-l-4 border-green-500">
                        <p className="text-sm text-gray-500">New (7 Days)</p>
                        <p className="text-2xl font-bold">{stats.created_last_7_days}</p>
                    </div>
                    <div className="bg-white p-4 rounded-lg shadow border-l-4 border-purple-500">
                        <p className="text-sm text-gray-500">New (30 Days)</p>
                        <p className="text-2xl font-bold">{stats.created_last_30_days}</p>
                    </div>
                    <div className="bg-white p-4 rounded-lg shadow border-l-4 border-orange-500">
                        <p className="text-sm text-gray-500">Avg Views</p>
                        <p className="text-2xl font-bold">{stats.average_views}</p>
                    </div>
                </div>
            )}

            {/* Posts Table */}
            <div className="bg-white shadow rounded-lg overflow-hidden">
                <table className="min-w-full divide-y divide-gray-200">
                    <thead className="bg-gray-50">
                        <tr>
                            <th className="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Title</th>
                            <th className="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Scope</th>
                            <th className="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Type</th>
                            <th className="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Status</th>
                            <th className="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Views</th>
                            <th className="px-6 py-3 text-right text-xs font-bold text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody className="bg-white divide-y divide-gray-200">
                        {posts.length === 0 ? (
                            <tr>
                                <td colSpan={6} className="px-6 py-8 text-center text-gray-500">
                                    No posts found. Create your first one!
                                </td>
                            </tr>
                        ) : (
                            posts.map((post) => (
                                <tr key={post.id} className="hover:bg-gray-50 transition">
                                    <td className="px-6 py-4">
                                        <div className="text-sm font-bold text-gray-900">
                                            {post.is_pinned && <span className="mr-2 text-red-500" title="Pinned">üìå</span>}
                                            {post.title}
                                        </div>
                                        <div className="text-xs text-gray-500">
                                            By {post.author?.first_name || 'Unknown'} ‚Ä¢ {new Date(post.created_at).toLocaleDateString()}
                                        </div>
                                    </td>
                                    
                                    {/* NEW SCOPE COLUMN */}
                                    <td className="px-6 py-4">
                                        {getScopeBadge(post)}
                                    </td>

                                    <td className="px-6 py-4">
                                        <span className="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-gray-100 text-gray-800 border border-gray-200">
                                            {post.post_type}
                                        </span>
                                    </td>
                                    <td className="px-6 py-4">
                                        <span className={`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-bold ${
                                            post.status === 'PUBLISHED' ? 'bg-green-100 text-green-800' :
                                            post.status === 'DRAFT' ? 'bg-yellow-100 text-yellow-800' :
                                            'bg-gray-100 text-gray-800'
                                        }`}>
                                            {post.status}
                                        </span>
                                    </td>
                                    <td className="px-6 py-4 text-sm text-gray-500">
                                        {post.view_count}
                                    </td>
                                    <td className="px-6 py-4 text-right text-sm font-medium space-x-3">
                                        <Link href={`/admin/super/posts/${post.id}`} className="text-indigo-600 hover:text-indigo-900">
                                            View
                                        </Link>
                                        <Link href={`/admin/super/posts/edit/${post.id}`} className="text-blue-600 hover:text-blue-900">
                                            Edit
                                        </Link>
                                        <button 
                                            onClick={() => handleDeleteClick(post)}
                                            className="text-red-600 hover:text-red-900"
                                        >
                                            Delete
                                        </button>
                                    </td>
                                </tr>
                            ))
                        )}
                    </tbody>
                </table>
            </div>

            <DeleteConfirmationModal
                isVisible={showDeleteModal}
                onClose={() => { if (!isDeleting) { setShowDeleteModal(false); setPostToDelete(null); } }}
                onConfirm={handleDeleteConfirm}
                itemName={postToDelete?.title}
                isLoading={isDeleting}
            />
            <Toast message={toast.message} type={toast.type} isVisible={toast.isVisible} onClose={() => setToast({ ...toast, isVisible: false })} />
        </div>
    );
}

--- END OF FILE: ./frontend/app/admin/club/posts/page.tsx ---


--- START OF FILE: ./frontend/app/admin/club/posts/edit/[id]/page.tsx ---
'use client';

import { useEffect, useState } from 'react';
import { useRouter, useParams } from 'next/navigation';
import api from '../../../../../../lib/api';
import PostForm from '../../../../../components/posts/PostForm';
import { Post } from '../../../../../../types/post';

export default function EditPostPage() {
    const router = useRouter();
    const params = useParams();
    const postId = params?.id as string;
    
    const [post, setPost] = useState<Post | null>(null);
    const [loading, setLoading] = useState(true);

    useEffect(() => {
        if (!postId) return;
        
        const fetchPost = async () => {
            try {
                const res = await api.get(`/posts/${postId}/`);
                setPost(res.data);
            } catch (err) {
                console.error("Failed to fetch post", err);
                alert("Post not found");
                router.push('/admin/club/posts');
            } finally {
                setLoading(false);
            }
        };
        fetchPost();
    }, [postId, router]);

    if (loading) return <div className="p-8 text-center text-gray-500">Loading post data...</div>;
    if (!post) return null;

    return (
        <div className="max-w-4xl mx-auto">
            <div className="mb-6">
                <button 
                    onClick={() => router.back()}
                    className="text-sm text-gray-500 hover:text-gray-700 mb-2"
                >
                    ‚Üê Cancel & Back
                </button>
                <h1 className="text-2xl font-bold text-gray-900">Edit Post</h1>
            </div>

            <PostForm 
                initialData={post}
                role="club" // <--- Ensures Distribution UI is hidden entirely (auto-assigned)
                onSuccess={() => router.push(`/admin/club/posts/${post.id}`)} 
            />
        </div>
    );
}
--- END OF FILE: ./frontend/app/admin/club/posts/edit/[id]/page.tsx ---


--- START OF FILE: ./frontend/app/admin/club/posts/[id]/page.tsx ---
'use client';

import { useEffect, useMemo, useState } from 'react';
import Link from 'next/link';
import { useRouter, useParams } from 'next/navigation';
import api from '../../../../../lib/api';
import { Post } from '../../../../../types/post';

export default function PostDetailPage() {
    const router = useRouter();
    const params = useParams();
    const postId = params?.id as string;
    
    const [post, setPost] = useState<Post | null>(null);
    const [comments, setComments] = useState<any[]>([]);
    const [loading, setLoading] = useState(true);
    const [customFieldMap, setCustomFieldMap] = useState<Record<number, string>>({});

    const fetchData = async () => {
        if (!postId) return;
        
        try {
            // 1. Fetch Post Details
            const postRes = await api.get(`/posts/${postId}/`);
            setPost(postRes.data);

            // 2. Fetch Comments for this post
            const commentsRes = await api.get(`/post-comments/?post_id=${postId}`);
            setComments(commentsRes.data.results || commentsRes.data);
        } catch (err) {
            console.error(err);
        } finally {
            setLoading(false);
        }
    };

    useEffect(() => {
        fetchData();
    }, [postId]);

    const handleApproveComment = async (commentId: number, currentStatus: boolean) => {
        try {
            await api.patch(`/post-comments/${commentId}/`, { is_approved: !currentStatus });
            fetchData(); // Refresh list
        } catch (err) {
            alert('Failed to update comment');
        }
    };

    const handleDeleteComment = async (commentId: number) => {
        if (!confirm("Delete this comment permanently?")) return;
        try {
            await api.delete(`/post-comments/${commentId}/`);
            fetchData(); // Refresh list
        } catch (err) {
            alert('Failed to delete comment');
        }
    };

    const hasCustomFieldRules = useMemo(() => {
        if (!post?.target_custom_fields) return false;
        return Object.keys(post.target_custom_fields).length > 0;
    }, [post?.target_custom_fields]);

    useEffect(() => {
        const fetchCustomFieldNames = async () => {
            if (!hasCustomFieldRules) return;
            try {
                const res = await api.get('/custom-fields/');
                const definitions = res.data.results || res.data || [];
                const map = definitions.reduce((acc: Record<number, string>, field: any) => {
                    acc[field.id] = field.name;
                    return acc;
                }, {});
                setCustomFieldMap(map);
            } catch (error) {
                console.error('Failed to load custom fields', error);
            }
        };

        fetchCustomFieldNames();
    }, [hasCustomFieldRules]);

    if (loading) return <div className="p-8">Loading...</div>;
    if (!post) return <div className="p-8">Post not found</div>;

    return (
        <div className="space-y-6 max-w-6xl mx-auto">
            {/* --- HEADER --- */}
            <div className="flex justify-between items-start">
                <div>
                    <button onClick={() => router.push('/admin/super/posts')} className="text-sm text-gray-500 mb-1 hover:underline">‚Üê Back to List</button>
                    <h1 className="text-3xl font-bold text-gray-900">{post.title}</h1>
                    <div className="flex items-center gap-3 mt-2">
                        <span className={`px-2 py-1 rounded-full text-xs font-bold ${
                            post.status === 'PUBLISHED' ? 'bg-green-100 text-green-800' :
                            post.status === 'DRAFT' ? 'bg-yellow-100 text-yellow-800' :
                            'bg-gray-100 text-gray-800'
                        }`}>
                            {post.status}
                        </span>
                        <span className="text-sm text-gray-500">Created: {new Date(post.created_at).toLocaleDateString()}</span>
                        {post.is_pinned && <span className="text-sm text-red-500 font-medium">üìå Pinned</span>}
                    </div>
                </div>
                <div className="flex gap-3">
                    <Link 
                        href={`/admin/super/posts/edit/${post.id}`}
                        className="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 font-medium"
                    >
                        Edit Post
                    </Link>
                </div>
            </div>

            <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                
                {/* --- LEFT COL: PREVIEW --- */}
                <div className="lg:col-span-2 space-y-6">
                    {/* Content Preview Card */}
                    <div className="bg-white p-6 rounded-lg shadow">
                        <h3 className="text-lg font-bold text-gray-800 mb-4 border-b pb-2">Content Preview</h3>
                        
                        {/* Video Display */}
                        {post.post_type === 'VIDEO' && post.video_url && (
                            <div className="mb-4 bg-black rounded overflow-hidden aspect-video flex items-center justify-center text-white">
                                {/* Simple placeholder if specific youtube embed logic isn't added yet */}
                                <a href={post.video_url} target="_blank" rel="noreferrer" className="underline">
                                    Watch Video ({post.video_url})
                                </a>
                            </div>
                        )}

                        {/* Image Display */}
                        {post.post_type === 'IMAGE' && post.images && post.images.length > 0 && (
                            <div className="flex gap-2 overflow-x-auto mb-4 pb-2">
                                {post.images.map(img => (
                                    <img key={img.id} src={img.image} className="h-48 rounded object-cover border" alt="Post media" />
                                ))}
                            </div>
                        )}

                        {/* Text Content */}
                        <div 
                            className="prose max-w-none text-gray-700 bg-gray-50 p-4 rounded border"
                            dangerouslySetInnerHTML={{ __html: post.content }} 
                        />
                    </div>

                    {/* Comments Manager */}
                    <div className="bg-white p-6 rounded-lg shadow">
                        <div className="flex justify-between items-center mb-4">
                            <h3 className="text-lg font-bold text-gray-800">Comments ({comments.length})</h3>
                            <span className="text-xs text-gray-500">Moderation: {post.require_moderation ? 'On' : 'Off'}</span>
                        </div>
                        
                        <div className="space-y-4 max-h-96 overflow-y-auto">
                            {comments.length === 0 ? (
                                <p className="text-gray-400 italic">No comments yet.</p>
                            ) : (
                                comments.map(comment => (
                                    <div key={comment.id} className={`p-3 rounded border ${comment.is_approved ? 'bg-white' : 'bg-red-50 border-red-200'}`}>
                                        <div className="flex justify-between">
                                            <p className="text-sm font-bold text-gray-700">
                                                {comment.author?.first_name} {comment.author?.last_name}
                                                <span className="text-gray-400 font-normal ml-2 text-xs">
                                                    {new Date(comment.created_at).toLocaleString()}
                                                </span>
                                            </p>
                                            <div className="flex gap-2">
                                                <button 
                                                    onClick={() => handleApproveComment(comment.id, comment.is_approved)}
                                                    className={`text-xs px-2 py-1 rounded ${comment.is_approved ? 'bg-yellow-100 text-yellow-700' : 'bg-green-100 text-green-700'}`}
                                                >
                                                    {comment.is_approved ? 'Hide' : 'Approve'}
                                                </button>
                                                <button 
                                                    onClick={() => handleDeleteComment(comment.id)}
                                                    className="text-xs px-2 py-1 rounded bg-red-100 text-red-700 hover:bg-red-200"
                                                >
                                                    Delete
                                                </button>
                                            </div>
                                        </div>
                                        <p className="text-gray-800 mt-1 text-sm">{comment.content}</p>
                                        {!comment.is_approved && (
                                            <p className="text-xs text-red-600 font-bold mt-1">‚ö† Pending Approval</p>
                                        )}
                                    </div>
                                ))
                            )}
                        </div>
                    </div>
                </div>

                {/* --- RIGHT COL: DETAILS & ANALYTICS --- */}
                <div className="space-y-6">
                    
                    {/* Analytics Card */}
                    <div className="bg-white p-6 rounded-lg shadow border-t-4 border-blue-500">
                        <h3 className="font-bold text-gray-800 mb-4">Analytics</h3>
                        <div className="grid grid-cols-2 gap-4 text-center">
                            <div className="p-2 bg-gray-50 rounded">
                                <p className="text-2xl font-bold text-blue-600">{post.view_count}</p>
                                <p className="text-xs text-gray-500">Views</p>
                            </div>
                            <div className="p-2 bg-gray-50 rounded">
                                <p className="text-2xl font-bold text-green-600">{comments.length}</p>
                                <p className="text-xs text-gray-500">Comments</p>
                            </div>
                        </div>
                    </div>

                    {/* Targeting Summary */}
                    <div className="bg-white p-6 rounded-lg shadow">
                        <h3 className="font-bold text-gray-800 mb-4">Target Audience</h3>
                        <ul className="space-y-3 text-sm">
                            <li className="flex justify-between">
                                <span className="text-gray-500">Member Type:</span>
                                <span className="font-medium">{post.target_member_type}</span>
                            </li>
                            {post.target_groups.length > 0 ? (
                                <div>
                                    <p className="text-gray-500 mb-1">Targeted Groups:</p>
                                    <div className="flex flex-wrap gap-1">
                                        {post.target_groups.map(g => (
                                            <span key={g} className="px-2 py-0.5 bg-blue-100 text-blue-800 rounded text-xs">Group ID {g}</span>
                                        ))}
                                    </div>
                                </div>
                            ) : (
                                <>
                                    <li className="flex justify-between">
                                        <span className="text-gray-500">Age Range:</span>
                                        <span className="font-medium">
                                            {post.target_min_age || 0} - {post.target_max_age || 'Any'}
                                        </span>
                                    </li>
                                    <li className="flex justify-between">
                                        <span className="text-gray-500">Gender:</span>
                                        <span className="font-medium">
                                            {post.target_genders.length > 0 ? post.target_genders.join(', ') : 'All'}
                                        </span>
                                    </li>
                                    <li className="flex justify-between">
                                        <span className="text-gray-500">Grades:</span>
                                        <span className="font-medium">
                                            {post.target_grades.length > 0 ? post.target_grades.join(', ') : 'All'}
                                        </span>
                                    </li>
                                </>
                            )}
                            {hasCustomFieldRules && (
                                <li className="flex flex-col gap-2">
                                    <span className="text-gray-500">Custom Field Rules:</span>
                                    <div className="flex flex-col gap-1">
                                        {Object.entries(post.target_custom_fields || {}).map(([fieldId, value]) => {
                                            const id = Number(fieldId);
                                            const fieldName = customFieldMap[id] || `Custom Field #${fieldId}`;
                                            let displayValue: string;
                                            if (typeof value === 'boolean') displayValue = value ? 'Yes' : 'No';
                                            else displayValue = Array.isArray(value) ? value.join(', ') : String(value);
                                            return (
                                                <span
                                                    key={fieldId}
                                                    className="text-sm text-gray-700 bg-gray-50 px-2 py-1 rounded border border-gray-100"
                                                >
                                                    <strong>{fieldName}:</strong> {displayValue || 'Any'}
                                                </span>
                                            );
                                        })}
                                    </div>
                                </li>
                            )}
                        </ul>
                    </div>

                    {/* Settings Summary */}
                    <div className="bg-white p-6 rounded-lg shadow">
                        <h3 className="font-bold text-gray-800 mb-4">Configuration</h3>
                        <ul className="space-y-2 text-sm text-gray-600">
                            <li>‚Ä¢ {post.allow_comments ? '‚úÖ Comments Allowed' : '‚ùå Comments Disabled'}</li>
                            <li>‚Ä¢ {post.require_moderation ? '‚úÖ Moderation On' : '‚ö™ Moderation Off'}</li>
                            <li>‚Ä¢ {post.send_push_notification ? '‚úÖ Push Notification Sent' : '‚ö™ No Push Notification'}</li>
                            {post.visibility_end_date && (
                                <li className="text-orange-600">‚Ä¢ Expires: {new Date(post.visibility_end_date).toLocaleDateString()}</li>
                            )}
                        </ul>
                    </div>

                </div>
            </div>
        </div>
    );
}
--- END OF FILE: ./frontend/app/admin/club/posts/[id]/page.tsx ---


--- START OF FILE: ./frontend/app/admin/club/posts/create/page.tsx ---
'use client';

import { useRouter } from 'next/navigation';
import PostForm from '../../../../components/posts/PostForm';

export default function CreatePostPage() {
    const router = useRouter();

    return (
        <div className="max-w-4xl mx-auto">
            <div className="mb-6">
                <button 
                    onClick={() => router.back()}
                    className="text-sm text-gray-500 hover:text-gray-700 mb-2"
                >
                    ‚Üê Back to Posts
                </button>
                <h1 className="text-2xl font-bold text-gray-900">Create New Post</h1>
                <p className="text-gray-500">Share updates, news, or media with your members.</p>
            </div>

            <PostForm 
                role="club" // <--- This ensures the Global/Muni options are HIDDEN
                onSuccess={() => router.push('/admin/club/posts')} 
            />
        </div>
    );
}
--- END OF FILE: ./frontend/app/admin/club/posts/create/page.tsx ---


--- START OF FILE: ./frontend/app/admin/club/rewards/page.tsx ---
'use client';

import RewardManager from '../../../components/RewardManager';

export default function ClubRewardsPage() {
  return (
    <div className="max-w-7xl mx-auto p-4">
      <RewardManager basePath="/admin/club/rewards" />
    </div>
  );
}
--- END OF FILE: ./frontend/app/admin/club/rewards/page.tsx ---


--- START OF FILE: ./frontend/app/admin/club/rewards/edit/[id]/page.tsx ---
'use client';

import { useState, useEffect } from 'react';
import { useParams } from 'next/navigation';
import api from '@/lib/api'; 
import RewardForm from '@/app/components/RewardForm';

export default function EditRewardPage() {
  const params = useParams();
  const id = params?.id as string;
  
  const [reward, setReward] = useState(null);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    if (id) {
      api.get(`/rewards/${id}/`)
        .then(res => {
          setReward(res.data);
          setLoading(false);
        })
        .catch(err => {
          console.error(err);
          setLoading(false);
        });
    }
  }, [id]);

  if (loading) return <div className="p-12 text-center text-gray-500">Loading...</div>;
  if (!reward) return <div className="p-12 text-center text-red-500">Reward not found.</div>;

  return (
    <div className="max-w-5xl mx-auto p-4">
      <div className="mb-8">
        <h1 className="text-3xl font-bold text-gray-900">Edit Reward</h1>
      </div>
      
      <RewardForm 
        initialData={reward} 
        redirectPath="/admin/club/rewards" 
      />
    </div>
  );
}
--- END OF FILE: ./frontend/app/admin/club/rewards/edit/[id]/page.tsx ---


--- START OF FILE: ./frontend/app/admin/club/rewards/[id]/page.tsx ---
'use client';

import { useParams } from 'next/navigation';
import RewardDetailView from '@/app/components/RewardDetailView';

export default function RewardDetailPage() {
  const params = useParams();
  const id = params?.id as string;

  return (
    <div className="max-w-7xl mx-auto p-4">
      <RewardDetailView 
        rewardId={id} 
        basePath="/admin/club/rewards" 
      />
    </div>
  );
}
--- END OF FILE: ./frontend/app/admin/club/rewards/[id]/page.tsx ---


--- START OF FILE: ./frontend/app/admin/club/rewards/create/page.tsx ---
'use client';

import RewardForm from '../../../../components/RewardForm';

export default function CreateRewardPage() {
  return (
    <div className="max-w-5xl mx-auto p-4">
      <div className="mb-8">
        <h1 className="text-3xl font-bold text-gray-900">Create Club Reward</h1>
        <p className="text-gray-500">
          This reward will be targeted specifically to members of your club.
        </p>
      </div>
      
      <RewardForm redirectPath="/admin/club/rewards" />
    </div>
  );
}
--- END OF FILE: ./frontend/app/admin/club/rewards/create/page.tsx ---


--- START OF FILE: ./frontend/app/admin/club/admins/page.tsx ---
'use client';

import { useState, useEffect, Suspense } from 'react';
import { useRouter, useSearchParams, usePathname } from 'next/navigation';
import api from '../../../../lib/api';
import { getMediaUrl } from '../../../utils';
import Toast from '../../../components/Toast';
import { useAuth } from '../../../../context/AuthContext';
import DeleteConfirmationModal from '../../../components/DeleteConfirmationModal';

interface AdminStats {
  total_admins?: number;
  verification?: { verified?: number; pending?: number; unverified?: number };
  activity?: { active_7_days?: number };
}

function ManageClubAdminsPageContent() {
  const router = useRouter();
  const pathname = usePathname();
  const searchParams = useSearchParams();
  const { user: currentUser } = useAuth();

  const [users, setUsers] = useState<any[]>([]);
  const [totalCount, setTotalCount] = useState(0);
  const [isLoading, setIsLoading] = useState(true);
  const [stats, setStats] = useState<AdminStats | null>(null);
  const [analyticsExpanded, setAnalyticsExpanded] = useState(true);
  const [avatarErrors, setAvatarErrors] = useState<Set<number>>(new Set());

  const [toast, setToast] = useState<{ message: string; type: 'success' | 'error' | 'info' | 'warning'; isVisible: boolean }>({
    message: '',
    type: 'success',
    isVisible: false,
  });

  const [showModal, setShowModal] = useState(false);
  const [isEditing, setIsEditing] = useState(false);
  const [editUserId, setEditUserId] = useState<number | null>(null);
  
  // Delete Confirmation Modal State
  const [showDeleteModal, setShowDeleteModal] = useState(false);
  const [userToDelete, setUserToDelete] = useState<{ id: number; name: string } | null>(null);
  const [isDeleting, setIsDeleting] = useState(false);

  const initialFormState = {
    email: '',
    password: '',
    first_name: '',
    last_name: '',
    nickname: '',
    legal_gender: 'MALE',
    phone_number: '',
    profession: '',
    hide_contact_info: false,
  };

  const [formData, setFormData] = useState(initialFormState);
  const [avatarFile, setAvatarFile] = useState<File | null>(null);
  const [avatarPreview, setAvatarPreview] = useState<string | null>(null);

  useEffect(() => {
    fetchStats();
  }, []);

  useEffect(() => {
    fetchAdmins();
  }, [searchParams]);

  const fetchStats = async () => {
    try {
      const res = await api.get('/users/stats/');
      setStats(res.data);
    } catch (err) {
      console.error(err);
    }
  };

  const fetchAdmins = async () => {
    setIsLoading(true);
    try {
      const params = new URLSearchParams();
      params.set('role', 'CLUB_ADMIN');

      const page = searchParams.get('page');
      const search = searchParams.get('search');
      const status = searchParams.get('verification_status');
      const gender = searchParams.get('legal_gender');

      if (page) params.set('page', page);
      if (search) params.set('search', search);
      if (status) params.set('verification_status', status);
      if (gender) params.set('legal_gender', gender);

      const res = await api.get(`/users/?${params.toString()}`);
      const list = res.data.results || [];
      setUsers(list);
      setTotalCount(res.data.count ?? list.length);
    } catch (err) {
      console.error(err);
    } finally {
      setIsLoading(false);
    }
  };

  const updateUrl = (key: string, value: string) => {
    const params = new URLSearchParams(searchParams.toString());
    if (value) params.set(key, value);
    else params.delete(key);
    if (key !== 'page') params.set('page', '1');
    router.push(`${pathname}?${params.toString()}`);
  };

  const handleOpenCreate = () => {
    setIsEditing(false);
    setEditUserId(null);
    setFormData(initialFormState);
    setAvatarFile(null);
    setAvatarPreview(null);
    setShowModal(true);
  };

  const handleOpenEdit = (admin: any) => {
    setIsEditing(true);
    setEditUserId(admin.id);
    setFormData({
      email: admin.email,
      password: '',
      first_name: admin.first_name || '',
      last_name: admin.last_name || '',
      nickname: admin.nickname || '',
      legal_gender: admin.legal_gender || 'MALE',
      phone_number: admin.phone_number || '',
      profession: admin.profession || '',
      hide_contact_info: !!admin.hide_contact_info,
    });
    setAvatarFile(null);
    setAvatarPreview(admin.avatar ? getMediaUrl(admin.avatar) : null);
    setShowModal(true);
  };

  const handleDeleteClick = (admin: any) => {
    // Prevent admins from deleting themselves
    if (currentUser && currentUser.id === admin.id) {
      setToast({ 
        message: 'You cannot delete your own account.', 
        type: 'warning', 
        isVisible: true 
      });
      return;
    }

    setUserToDelete({ id: admin.id, name: `${admin.first_name} ${admin.last_name}` });
    setShowDeleteModal(true);
  };

  const handleDeleteConfirm = async () => {
    if (!userToDelete) return;

    setIsDeleting(true);
    try {
      await api.delete(`/users/${userToDelete.id}/`);
      setToast({ message: 'Admin deleted successfully!', type: 'success', isVisible: true });
      setShowDeleteModal(false);
      setUserToDelete(null);
      fetchAdmins();
      fetchStats();
    } catch (err) {
      setToast({ message: 'Failed to delete admin.', type: 'error', isVisible: true });
    } finally {
      setIsDeleting(false);
    }
  };

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    try {
      const data = new FormData();
      Object.entries(formData).forEach(([key, value]) => {
        if (key === 'password' && !value) return;
        data.append(key, typeof value === 'boolean' ? String(value) : value.toString());
      });
      data.append('role', 'CLUB_ADMIN');
      if (avatarFile) data.append('avatar', avatarFile);

      const config = { headers: { 'Content-Type': 'multipart/form-data' } };
      if (isEditing && editUserId) {
        await api.patch(`/users/${editUserId}/`, data, config);
        setToast({ message: 'Admin updated!', type: 'success', isVisible: true });
      } else {
        await api.post('/users/', data, config);
        setToast({ message: 'Admin created!', type: 'success', isVisible: true });
      }

      setShowModal(false);
      fetchAdmins();
      fetchStats();
    } catch (err) {
      console.error(err);
      setToast({ message: 'Operation failed. Please try again.', type: 'error', isVisible: true });
    }
  };

  const handleAvatarChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (!file) return;
    setAvatarFile(file);
    const reader = new FileReader();
    reader.onloadend = () => setAvatarPreview(reader.result as string);
    reader.readAsDataURL(file);
  };

  const getInitials = (first = '', last = '') => {
    const a = first.charAt(0).toUpperCase() || '';
    const b = last.charAt(0).toUpperCase() || '';
    return a + b || '?';
  };

  const currentPage = Number(searchParams.get('page')) || 1;
  const totalPages = totalCount > 0 ? Math.ceil(totalCount / 10) : 1;

  return (
    <div className="space-y-6">
      <div className="flex flex-wrap justify-between gap-4 items-center">
        <div>
          <p className="text-sm text-emerald-500 uppercase font-semibold">Club Admin</p>
          <h1 className="text-3xl font-bold text-gray-900">Manage Admins</h1>
          <p className="text-gray-500 text-sm">Create, edit, and track the admins within your club.</p>
        </div>
        <button
          onClick={handleOpenCreate}
          className="bg-emerald-600 text-white px-5 py-2 rounded-lg font-semibold shadow hover:bg-emerald-700 transition"
        >
          + Add Admin
        </button>
      </div>

      {stats && (
        <div className="rounded-xl border border-emerald-100 bg-white shadow-sm">
          <button
            onClick={() => setAnalyticsExpanded((prev) => !prev)}
            className="w-full flex items-center justify-between px-4 py-3 text-left"
          >
            <div className="flex items-center gap-2">
              <span className="w-2 h-2 rounded-full bg-emerald-500"></span>
              <span className="text-sm font-semibold text-gray-700">Analytics Overview</span>
            </div>
            <svg
              className={`w-5 h-5 text-gray-500 transition-transform ${analyticsExpanded ? 'rotate-180' : ''}`}
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
            </svg>
          </button>
          <div
            className={`grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 px-4 pb-4 transition-all duration-500 ${
              analyticsExpanded ? 'max-h-[500px] pt-2 opacity-100' : 'max-h-0 opacity-0 -translate-y-2 pointer-events-none'
            } overflow-hidden`}
          >
            <div className="bg-gradient-to-r from-emerald-500 to-emerald-600 text-white rounded-xl p-4 shadow-md">
              <p className="text-xs uppercase tracking-wide text-white/80">Total Admins</p>
              <p className="text-3xl font-bold mt-1">{stats.total_admins ?? users.length}</p>
            </div>
            <div className="bg-white border border-emerald-50 rounded-xl p-4 shadow-sm">
              <p className="text-xs uppercase text-gray-500 mb-1">Verified</p>
              <p className="text-2xl font-bold text-emerald-600">{stats.verification?.verified ?? 0}</p>
            </div>
            <div className="bg-white border border-emerald-50 rounded-xl p-4 shadow-sm">
              <p className="text-xs uppercase text-gray-500 mb-1">Pending</p>
              <p className="text-2xl font-bold text-amber-500">{stats.verification?.pending ?? 0}</p>
            </div>
            <div className="bg-white border border-emerald-50 rounded-xl p-4 shadow-sm">
              <p className="text-xs uppercase text-gray-500 mb-1">Active (7d)</p>
              <p className="text-2xl font-bold text-gray-800">{stats.activity?.active_7_days ?? 0}</p>
            </div>
          </div>
        </div>
      )}

      <div className="bg-white rounded-xl shadow-sm border border-gray-100 p-4">
        <div className="flex flex-wrap gap-4 items-end">
          <div className="flex-1 min-w-[200px]">
            <label className="block text-xs font-semibold text-gray-500 uppercase mb-1">Search</label>
            <input
              type="text"
              placeholder="Search name or email..."
              value={searchParams.get('search') || ''}
              onChange={(e) => updateUrl('search', e.target.value)}
              className="w-full border border-gray-200 rounded-lg p-2.5 text-sm focus:ring-2 focus:ring-emerald-500"
            />
          </div>
          <div className="w-48">
            <label className="block text-xs font-semibold text-gray-500 uppercase mb-1">Verification Status</label>
            <select
              value={searchParams.get('verification_status') || ''}
              onChange={(e) => updateUrl('verification_status', e.target.value)}
              className="w-full border border-gray-200 rounded-lg p-2.5 text-sm focus:ring-2 focus:ring-emerald-500 bg-gray-50"
            >
              <option value="">All</option>
              <option value="VERIFIED">Verified</option>
              <option value="PENDING">Pending</option>
              <option value="UNVERIFIED">Unverified</option>
            </select>
          </div>
          <div className="w-40">
            <label className="block text-xs font-semibold text-gray-500 uppercase mb-1">Gender</label>
            <select
              value={searchParams.get('legal_gender') || ''}
              onChange={(e) => updateUrl('legal_gender', e.target.value)}
              className="w-full border border-gray-200 rounded-lg p-2.5 text-sm focus:ring-2 focus:ring-emerald-500 bg-gray-50"
            >
              <option value="">Any</option>
              <option value="MALE">Male</option>
              <option value="FEMALE">Female</option>
              <option value="OTHER">Other</option>
            </select>
          </div>
          <button
            onClick={() => router.push(pathname)}
            className="px-4 py-2 text-sm text-gray-500 hover:text-red-500"
          >
            Clear
          </button>
        </div>
      </div>

      <div className="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
        {isLoading ? (
          <div className="p-8 text-center text-gray-500">Loading admins...</div>
        ) : users.length === 0 ? (
          <div className="p-8 text-center text-gray-500">No admins found.</div>
        ) : (
          <table className="min-w-full divide-y divide-gray-200">
            <thead className="bg-gray-50">
              <tr>
                <th className="px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase">Admin</th>
                <th className="px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase">Role</th>
                <th className="px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase">Job Title</th>
                <th className="px-6 py-3 text-right text-xs font-semibold text-gray-500 uppercase">Actions</th>
              </tr>
            </thead>
            <tbody className="bg-white divide-y divide-gray-100">
              {users.map((admin) => (
                <tr key={admin.id}>
                  <td className="px-6 py-4">
                    <div className="flex items-center">
                      {admin.avatar && !avatarErrors.has(admin.id) ? (
                        <img
                          src={getMediaUrl(admin.avatar) || ''}
                          alt="avatar"
                          className="w-10 h-10 rounded-full object-cover mr-3 border border-emerald-100"
                          onError={() =>
                            setAvatarErrors((prev) => {
                              const next = new Set(prev);
                              next.add(admin.id);
                              return next;
                            })
                          }
                        />
                      ) : (
                        <div className="w-10 h-10 rounded-full bg-blue-100 text-blue-700 flex items-center justify-center font-semibold mr-3">
                          {getInitials(admin.first_name, admin.last_name)}
                        </div>
                      )}
                      <div>
                        <p className="font-semibold text-gray-900">
                          {admin.first_name} {admin.last_name}
                        </p>
                        <p className="text-xs text-gray-500">{admin.email}</p>
                      </div>
                    </div>
                  </td>
                  <td className="px-6 py-4">
                    <span className="px-2 py-1 rounded-full text-xs font-semibold bg-emerald-100 text-emerald-700">
                      Club Admin
                    </span>
                  </td>
                  <td className="px-6 py-4 text-sm text-gray-600">{admin.profession || '‚Äî'}</td>
                  <td className="px-6 py-4 text-right space-x-4">
                    <button onClick={() => handleOpenEdit(admin)} className="text-emerald-600 font-semibold">
                      Edit
                    </button>
                    <button onClick={() => handleDeleteClick(admin)} className="text-red-600 font-semibold">
                      Delete
                    </button>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        )}
      </div>

      <div className="flex items-center justify-between border border-gray-100 bg-white px-4 py-3 rounded-xl shadow-sm">
        <div className="text-sm text-gray-600">Total admins: {totalCount}</div>
        <div className="flex items-center gap-3">
          <button
            disabled={currentPage === 1}
            onClick={() => updateUrl('page', (currentPage - 1).toString())}
            className="px-3 py-1 rounded border text-sm disabled:opacity-50"
          >
            Previous
          </button>
          <span className="text-sm text-gray-600">
            Page {currentPage} of {totalPages}
          </span>
          <button
            disabled={currentPage >= totalPages}
            onClick={() => updateUrl('page', (currentPage + 1).toString())}
            className="px-3 py-1 rounded border text-sm disabled:opacity-50"
          >
            Next
          </button>
        </div>
      </div>

      {showModal && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-2xl shadow-2xl w-full max-w-2xl p-8 max-h-[90vh] overflow-y-auto">
            <h2 className="text-2xl font-bold mb-6 text-gray-900">{isEditing ? 'Edit Admin' : 'Create Admin'}</h2>
            <form onSubmit={handleSubmit} className="space-y-6">
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <input
                  required
                  type="text"
                  placeholder="First Name"
                  className="border p-2 rounded"
                  value={formData.first_name}
                  onChange={(e) => setFormData({ ...formData, first_name: e.target.value })}
                />
                <input
                  required
                  type="text"
                  placeholder="Last Name"
                  className="border p-2 rounded"
                  value={formData.last_name}
                  onChange={(e) => setFormData({ ...formData, last_name: e.target.value })}
                />
                <input
                  type="text"
                  placeholder="Nickname"
                  className="border p-2 rounded"
                  value={formData.nickname}
                  onChange={(e) => setFormData({ ...formData, nickname: e.target.value })}
                />
                <select
                  className="border p-2 rounded"
                  value={formData.legal_gender}
                  onChange={(e) => setFormData({ ...formData, legal_gender: e.target.value })}
                >
                  <option value="MALE">Male</option>
                  <option value="FEMALE">Female</option>
                  <option value="OTHER">Other</option>
                </select>
                <input
                  required
                  type="email"
                  placeholder="Email"
                  className="border p-2 rounded"
                  value={formData.email}
                  onChange={(e) => setFormData({ ...formData, email: e.target.value })}
                />
                <input
                  type="password"
                  placeholder={isEditing ? 'New Password (optional)' : 'Password'}
                  className="border p-2 rounded"
                  required={!isEditing}
                  value={formData.password}
                  onChange={(e) => setFormData({ ...formData, password: e.target.value })}
                />
                <input
                  type="text"
                  placeholder="Phone"
                  className="border p-2 rounded"
                  value={formData.phone_number}
                  onChange={(e) => setFormData({ ...formData, phone_number: e.target.value })}
                />
                <input
                  type="text"
                  placeholder="Profession / Job Title"
                  className="border p-2 rounded"
                  value={formData.profession}
                  onChange={(e) => setFormData({ ...formData, profession: e.target.value })}
                />
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">Avatar</label>
                <input type="file" accept="image/*" className="w-full border p-2 rounded" onChange={handleAvatarChange} />
                {avatarPreview && (
                  <img src={avatarPreview} alt="preview" className="w-16 h-16 rounded-full object-cover mt-2 border" />
                )}
              </div>

              <label className="inline-flex items-center gap-2 text-sm text-gray-700">
                <input
                  type="checkbox"
                  checked={formData.hide_contact_info}
                  onChange={(e) => setFormData({ ...formData, hide_contact_info: e.target.checked })}
                />
                Hide contact information
              </label>

              <div className="flex justify-end gap-4 pt-4 border-t border-gray-100">
                <button type="button" onClick={() => setShowModal(false)} className="text-gray-500 hover:text-gray-700">
                  Cancel
                </button>
                <button
                  type="submit"
                  className="bg-emerald-600 text-white px-6 py-2 rounded-lg font-semibold hover:bg-emerald-700"
                >
                  {isEditing ? 'Save Changes' : 'Create Admin'}
                </button>
              </div>
            </form>
          </div>
        </div>
      )}

      {/* Delete Confirmation Modal */}
      <DeleteConfirmationModal
        isVisible={showDeleteModal}
        onClose={() => {
          if (!isDeleting) {
            setShowDeleteModal(false);
            setUserToDelete(null);
          }
        }}
        onConfirm={handleDeleteConfirm}
        itemName={userToDelete?.name}
        isLoading={isDeleting}
      />

      <Toast
        message={toast.message}
        type={toast.type}
        isVisible={toast.isVisible}
        onClose={() => setToast({ ...toast, isVisible: false })}
      />
    </div>
  );
}

export default function ManageClubAdminsPage() {
  return (
    <Suspense fallback={<div className="p-8 text-center text-gray-500">Loading...</div>}>
      <ManageClubAdminsPageContent />
    </Suspense>
  );
}


--- END OF FILE: ./frontend/app/admin/club/admins/page.tsx ---


--- START OF FILE: ./frontend/app/admin/club/groups/page.tsx ---
'use client';
import GroupManager from '../../../components/GroupManager';
export default function Page() { return <div className="p-8"><GroupManager basePath="/admin/municipality/groups" /></div>; }
--- END OF FILE: ./frontend/app/admin/club/groups/page.tsx ---


--- START OF FILE: ./frontend/app/admin/club/groups/requests/page.tsx ---
'use client';
import GroupRequestsManager from '../../../../components/GroupRequestsManager';
export default function Page() { return <div className="p-8 max-w-6xl mx-auto"><GroupRequestsManager /></div>; }
--- END OF FILE: ./frontend/app/admin/club/groups/requests/page.tsx ---


--- START OF FILE: ./frontend/app/admin/club/groups/edit/[id]/page.tsx ---
'use client';

import { useState, useEffect } from 'react';
import { useParams } from 'next/navigation';
import api from '@/lib/api'; 
import GroupForm from '@/app/components/GroupForm';

export default function EditGroupPage() {
  const params = useParams();
  const id = params?.id as string;
  
  const [group, setGroup] = useState(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState('');

  useEffect(() => {
    if (id) {
      const fetchGroup = async () => {
        try {
          const res = await api.get(`/groups/${id}/`);
          setGroup(res.data);
        } catch (err) {
          console.error(err);
          setError('Failed to load group data.');
        } finally {
          setLoading(false);
        }
      };
      fetchGroup();
    }
  }, [id]);

  if (loading) return <div className="p-12 text-center text-gray-500">Loading group settings...</div>;
  if (error || !group) return <div className="p-12 text-center text-red-500">{error || 'Group not found'}</div>;

  return (
    <div className="max-w-4xl mx-auto p-4">
      <div className="mb-8">
        <h1 className="text-2xl font-bold text-gray-900">Edit Group</h1>
        <p className="text-gray-500">Update membership rules and settings.</p>
      </div>
      
      <GroupForm 
        initialData={group} 
        redirectPath="/admin/super/groups" 
      />
    </div>
  );
}
--- END OF FILE: ./frontend/app/admin/club/groups/edit/[id]/page.tsx ---


--- START OF FILE: ./frontend/app/admin/club/groups/[id]/page.tsx ---
'use client';
import { useParams } from 'next/navigation';
import GroupDetailView from '../../../../components/GroupDetailView';
export default function Page() { 
  const { id } = useParams() as { id: string };
  return <div className="p-8"><GroupDetailView groupId={id} basePath="/admin/municipality/groups" /></div>; 
}
--- END OF FILE: ./frontend/app/admin/club/groups/[id]/page.tsx ---


--- START OF FILE: ./frontend/app/admin/club/groups/create/page.tsx ---
'use client';
import GroupForm from '../../../../components/GroupForm';
export default function Page() { 
  return <div className="p-8"><h1 className="text-2xl font-bold mb-6">New Municipality Group</h1><GroupForm redirectPath="/admin/municipality/groups" /></div>; 
}
--- END OF FILE: ./frontend/app/admin/club/groups/create/page.tsx ---


--- START OF FILE: ./frontend/app/admin/club/msgboard/page.tsx ---
'use client';

import { useEffect, useState, Suspense } from 'react';
import api from '../../../../lib/api';
import Toast from '../../../components/Toast';
import { useAuth } from '../../../../context/AuthContext';
import DeleteConfirmationModal from '../../../components/DeleteConfirmationModal';

interface SystemMessage {
  id: number;
  title: string;
  message: string;
  message_type: 'INFO' | 'IMPORTANT' | 'WARNING';
  created_at: string;
  expires_at: string;
  is_sticky: boolean;
  external_link?: string | null;
}

const MESSAGE_STYLES: Record<SystemMessage['message_type'], { badge: string; border: string }> = {
  INFO: {
    badge: 'bg-blue-100 text-blue-800',
    border: 'border-blue-200',
  },
  IMPORTANT: {
    badge: 'bg-orange-100 text-orange-800',
    border: 'border-orange-200',
  },
  WARNING: {
    badge: 'bg-red-100 text-red-800',
    border: 'border-red-200',
  },
};

const formatDate = (value: string) =>
  new Date(value).toLocaleString(undefined, {
    year: 'numeric',
    month: 'short',
    day: 'numeric',
    hour: '2-digit',
    minute: '2-digit',
  });

function ClubMessageBoardContent() {
  const [messages, setMessages] = useState<SystemMessage[]>([]);
  const [loading, setLoading] = useState(true);
  const [toast, setToast] = useState<{ message: string; type: 'success' | 'error'; isVisible: boolean }>({
    message: '',
    type: 'success',
    isVisible: false,
  });
  const { refreshMessageCount } = useAuth();
  
  // Hide Confirmation Modal State
  const [showHideModal, setShowHideModal] = useState(false);
  const [messageToHide, setMessageToHide] = useState<{ id: number; title: string } | null>(null);
  const [isHiding, setIsHiding] = useState(false);

  const fetchMessages = async () => {
    setLoading(true);
    try {
      const res = await api.get('/messages/active_list/');
      const list: SystemMessage[] = Array.isArray(res.data) ? res.data : [];
      list.sort((a, b) => new Date(b.created_at).getTime() - new Date(a.created_at).getTime());
      setMessages(list);
      refreshMessageCount();
    } catch (err) {
      console.error(err);
      setToast({ message: 'Failed to load messages.', type: 'error', isVisible: true });
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => {
    fetchMessages();
  }, []);

  const handleHideClick = (msg: SystemMessage) => {
    if (msg.is_sticky) return;
    setMessageToHide({ id: msg.id, title: msg.title });
    setShowHideModal(true);
  };

  const handleHideConfirm = async () => {
    if (!messageToHide) return;

    setIsHiding(true);
    try {
      await api.post(`/messages/${messageToHide.id}/dismiss/`);
      setToast({ message: 'Message hidden.', type: 'success', isVisible: true });
      setShowHideModal(false);
      setMessageToHide(null);
      fetchMessages();
    } catch (err) {
      console.error(err);
      setToast({ message: 'Failed to hide message.', type: 'error', isVisible: true });
    } finally {
      setIsHiding(false);
    }
  };

  return (
    <div className="space-y-6">
      <div className="flex flex-wrap justify-between items-center gap-4">
        <div>
          <p className="text-sm text-blue-500 uppercase font-semibold tracking-wide">Club Admin</p>
          <h1 className="text-3xl font-bold text-gray-900">Internal Message Board</h1>
          <p className="text-gray-600">All active notices targeted to your role appear here.</p>
        </div>
        <button
          onClick={fetchMessages}
          className="px-4 py-2 rounded-lg border border-blue-200 text-sm text-blue-700 hover:bg-blue-50"
        >
          Refresh
        </button>
      </div>

      {loading ? (
        <div className="bg-white rounded-xl shadow p-6 text-center text-gray-500">Loading messages‚Ä¶</div>
      ) : messages.length === 0 ? (
        <div className="bg-white rounded-xl shadow p-8 text-center text-gray-500">
          No active messages for your role right now.
        </div>
      ) : (
        <div className="space-y-4">
          {messages.map((msg) => {
            const styles = MESSAGE_STYLES[msg.message_type] || MESSAGE_STYLES.INFO;
            return (
              <div
                key={msg.id}
                className={`bg-white border ${styles.border} rounded-xl shadow-sm p-5 flex flex-col gap-3`}
              >
                <div className="flex flex-wrap justify-between items-start gap-3">
                  <div>
                    <div className="flex items-center gap-2">
                      <span className={`text-xs font-semibold px-2 py-1 rounded-full ${styles.badge}`}>
                        {msg.message_type}
                      </span>
                      {msg.is_sticky && (
                        <span className="text-[11px] uppercase tracking-wide text-red-500 font-semibold">
                          Sticky
                        </span>
                      )}
                    </div>
                    <h2 className="text-lg font-semibold text-gray-900 mt-1">{msg.title}</h2>
                  </div>
                  <div className="text-right text-xs text-gray-500">
                    <div>Created: {formatDate(msg.created_at)}</div>
                    <div>Expires: {formatDate(msg.expires_at)}</div>
                  </div>
                </div>

                <p className="text-gray-700 whitespace-pre-line">{msg.message}</p>

                {msg.external_link && (
                  <a
                    href={msg.external_link}
                    target="_blank"
                    rel="noopener noreferrer"
                    className="text-sm text-blue-600 font-semibold hover:underline"
                  >
                    View more ‚Üó
                  </a>
                )}

                <div className="flex justify-end gap-3 text-sm">
                  <button
                    onClick={() => handleHideClick(msg)}
                    disabled={msg.is_sticky}
                    className={`px-4 py-2 rounded-lg border text-sm font-semibold transition ${
                      msg.is_sticky
                        ? 'border-gray-200 text-gray-400 cursor-not-allowed'
                        : 'border-red-200 text-red-600 hover:bg-red-50'
                    }`}
                  >
                    Hide
                  </button>
                </div>
              </div>
            );
          })}
        </div>
      )}

      {/* Hide Confirmation Modal */}
      <DeleteConfirmationModal
        isVisible={showHideModal}
        onClose={() => {
          if (!isHiding) {
            setShowHideModal(false);
            setMessageToHide(null);
          }
        }}
        onConfirm={handleHideConfirm}
        title="Hide Message"
        itemName={messageToHide?.title}
        message={messageToHide ? `Are you sure you want to hide "${messageToHide.title}"? You can refresh the page to see it again.` : undefined}
        confirmButtonText="Hide"
        isLoading={isHiding}
      />

      <Toast
        message={toast.message}
        type={toast.type}
        isVisible={toast.isVisible}
        onClose={() => setToast({ ...toast, isVisible: false })}
      />
    </div>
  );
}

export default function ClubMessageBoardPage() {
  return (
    <Suspense fallback={<div className="p-8 text-center text-gray-500">Loading message board‚Ä¶</div>}>
      <ClubMessageBoardContent />
    </Suspense>
  );
}


--- END OF FILE: ./frontend/app/admin/club/msgboard/page.tsx ---


--- START OF FILE: ./frontend/app/admin/club/youth/page.tsx ---
'use client';

import { useState, useEffect, Suspense } from 'react';
import { useRouter, useSearchParams, usePathname } from 'next/navigation';
import Link from 'next/link';
import api from '../../../../lib/api';
import { useAuth } from '../../../../context/AuthContext';
import { getMediaUrl } from '../../../utils';
import Toast from '../../../components/Toast';
import DeleteConfirmationModal from '../../../components/DeleteConfirmationModal';
import CustomFieldsForm from '../../../components/CustomFieldsForm';

interface Option { id: number; name: string; }
interface GuardianOption { id: number; first_name: string; last_name: string; email: string; }

function ManageClubYouthPageContent() {
  const router = useRouter();
  const pathname = usePathname();
  const searchParams = useSearchParams();
  const { user } = useAuth();

  const [users, setUsers] = useState<any[]>([]);
  const [totalCount, setTotalCount] = useState(0);
  const [isLoading, setIsLoading] = useState(true);
  const [stats, setStats] = useState<any>(null);
  const [analyticsExpanded, setAnalyticsExpanded] = useState(true);
  const [avatarErrors, setAvatarErrors] = useState<Set<number>>(new Set());

  const [toast, setToast] = useState<{ message: string; type: 'success' | 'error'; isVisible: boolean }>({
    message: '',
    type: 'success',
    isVisible: false,
  });

  const [interests, setInterests] = useState<Option[]>([]);
  const [guardiansList, setGuardiansList] = useState<GuardianOption[]>([]);

  const [showModal, setShowModal] = useState(false);
  const [isEditing, setIsEditing] = useState(false);
  const [editUserId, setEditUserId] = useState<number | null>(null);
  const [avatarFile, setAvatarFile] = useState<File | null>(null);
  const [avatarPreview, setAvatarPreview] = useState<string | null>(null);
  
  // Delete Confirmation Modal State
  const [showDeleteModal, setShowDeleteModal] = useState(false);
  const [userToDelete, setUserToDelete] = useState<{ id: number; name: string } | null>(null);
  const [isDeleting, setIsDeleting] = useState(false);

  const [guardianSearchTerm, setGuardianSearchTerm] = useState('');
  const [showGuardianDropdown, setShowGuardianDropdown] = useState(false);
  const [interestSearchTerm, setInterestSearchTerm] = useState('');
  const [showInterestDropdown, setShowInterestDropdown] = useState(false);

  const initialFormState = {
    email: '',
    password: '',
    first_name: '',
    last_name: '',
    nickname: '',
    legal_gender: 'MALE',
    preferred_gender: '',
    phone_number: '',
    date_of_birth: '',
    grade: '',
    verification_status: 'UNVERIFIED',
    interests: [] as number[],
    guardians: [] as number[],
  };

  const [formData, setFormData] = useState(initialFormState);
  const [customFieldValues, setCustomFieldValues] = useState<Record<number, any>>({});

  useEffect(() => {
    fetchDropdowns();
    fetchStats();
  }, []);

  useEffect(() => {
    fetchYouth();
  }, [searchParams]);

  const fetchStats = async () => {
    try {
      const res = await api.get('/users/youth_stats/');
      setStats(res.data);
    } catch (err) {
      console.error(err);
    }
  };

  const fetchDropdowns = async () => {
    try {
      const interestRes = await api.get('/interests/');
      setInterests(Array.isArray(interestRes.data) ? interestRes.data : (interestRes.data?.results || []));

      const guardianRes = await api.get('/users/list_guardians/');
      setGuardiansList(guardianRes.data);
    } catch (err) {
      console.error(err);
    }
  };

  const fetchYouth = async () => {
    setIsLoading(true);
    try {
      const params = new URLSearchParams();
      params.set('role', 'YOUTH_MEMBER');

      const page = searchParams.get('page');
      if (page) params.set('page', page);

      const search = searchParams.get('search');
      if (search) params.set('search', search);

      const ageFrom = searchParams.get('age_from');
      if (ageFrom) params.set('age_from', ageFrom);

      const ageTo = searchParams.get('age_to');
      if (ageTo) params.set('age_to', ageTo);

      const gradeFrom = searchParams.get('grade_from');
      if (gradeFrom) params.set('grade_from', gradeFrom);

      const gradeTo = searchParams.get('grade_to');
      if (gradeTo) params.set('grade_to', gradeTo);

      const status = searchParams.get('verification_status');
      if (status) params.set('verification_status', status);

      const gender = searchParams.get('legal_gender');
      if (gender) params.set('legal_gender', gender);

      const res = await api.get(`/users/?${params.toString()}`);
      const results = res.data.results || [];
      setUsers(results);
      setTotalCount(res.data.count ?? results.length);
    } catch (err) {
      console.error(err);
    } finally {
      setIsLoading(false);
    }
  };

  const updateUrl = (key: string, value: string) => {
    const params = new URLSearchParams(searchParams.toString());
    if (value) params.set(key, value);
    else params.delete(key);
    if (key !== 'page') params.set('page', '1');
    router.push(`${pathname}?${params.toString()}`);
  };

  const handleOpenCreate = () => {
    setIsEditing(false);
    setEditUserId(null);
    setFormData(initialFormState);
    setCustomFieldValues({});
    setAvatarFile(null);
    setAvatarPreview(null);
    setGuardianSearchTerm('');
    setInterestSearchTerm('');
    setShowGuardianDropdown(false);
    setShowInterestDropdown(false);
    setShowModal(true);
  };

  const handleOpenEdit = async (youth: any) => {
    setIsEditing(true);
    setEditUserId(youth.id);
    setFormData({
      email: youth.email,
      password: '',
      first_name: youth.first_name || '',
      last_name: youth.last_name || '',
      nickname: youth.nickname || '',
      legal_gender: youth.legal_gender || 'MALE',
      preferred_gender: youth.preferred_gender || '',
      phone_number: youth.phone_number || '',
      date_of_birth: youth.date_of_birth || '',
      grade: youth.grade?.toString() || '',
      verification_status: youth.verification_status || 'UNVERIFIED',
      interests:
        youth.interests?.map((i: any) => (typeof i === 'object' ? i.id : i)) || [],
      guardians: youth.guardians || [],
    });
    setAvatarFile(null);
    setAvatarPreview(youth.avatar ? getMediaUrl(youth.avatar) : null);
    setGuardianSearchTerm('');
    setInterestSearchTerm('');
    setShowGuardianDropdown(false);
    setShowInterestDropdown(false);
    
    // Load custom field values for this user
    try {
      const userRes = await api.get(`/users/${youth.id}/`);
      const customFieldValuesData = userRes.data.custom_field_values || [];
      const values: Record<number, any> = {};
      customFieldValuesData.forEach((cfv: any) => {
        values[cfv.field] = cfv.value;
      });
      setCustomFieldValues(values);
    } catch (err) {
      console.error('Failed to load custom field values:', err);
      setCustomFieldValues({});
    }
    
    setShowModal(true);
  };

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    try {
      const data = new FormData();
      Object.entries(formData).forEach(([key, value]) => {
        if (key === 'password' && !value) return;
        if (key === 'interests' || key === 'guardians') return;
        data.append(key, value?.toString() || '');
      });

      formData.interests.forEach((id) => data.append('interests', id.toString()));
      formData.guardians.forEach((id) => data.append('guardians', id.toString()));
      data.append('role', 'YOUTH_MEMBER');
      if (avatarFile) data.append('avatar', avatarFile);

      const config = { headers: { 'Content-Type': 'multipart/form-data' } };
      let userId: number;
      if (isEditing && editUserId) {
        await api.patch(`/users/${editUserId}/`, data, config);
        userId = editUserId;
        setToast({ message: 'Youth updated successfully!', type: 'success', isVisible: true });
      } else {
        const res = await api.post('/users/', data, config);
        userId = res.data.id;
        setToast({ message: 'Youth created successfully!', type: 'success', isVisible: true });
      }

      // Save custom field values
      if (Object.keys(customFieldValues).length > 0) {
        try {
          await api.post('/custom-fields/save_values_for_user/', {
            user_id: userId,
            values: customFieldValues,
          });
        } catch (err) {
          console.error('Failed to save custom field values:', err);
        }
      }

      setShowModal(false);
      fetchYouth();
      fetchStats();
    } catch (err) {
      setToast({ message: 'Operation failed. Please try again.', type: 'error', isVisible: true });
      console.error(err);
    }
  };

  const handleDeleteClick = (youth: any) => {
    setUserToDelete({ id: youth.id, name: `${youth.first_name} ${youth.last_name}` });
    setShowDeleteModal(true);
  };

  const handleDeleteConfirm = async () => {
    if (!userToDelete) return;

    setIsDeleting(true);
    try {
      await api.delete(`/users/${userToDelete.id}/`);
      setToast({ message: 'Youth deleted successfully!', type: 'success', isVisible: true });
      setShowDeleteModal(false);
      setUserToDelete(null);
      fetchYouth();
      fetchStats();
    } catch (err) {
      setToast({ message: 'Failed to delete youth.', type: 'error', isVisible: true });
    } finally {
      setIsDeleting(false);
    }
  };

  const handleAvatarChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (file) {
      setAvatarFile(file);
      const reader = new FileReader();
      reader.onloadend = () => setAvatarPreview(reader.result as string);
      reader.readAsDataURL(file);
    }
  };

  const toggleInterest = (id: number) => {
    setFormData((prev) => ({
      ...prev,
      interests: prev.interests.includes(id)
        ? prev.interests.filter((i) => i !== id)
        : [...prev.interests, id],
    }));
    setInterestSearchTerm('');
    setShowInterestDropdown(false);
  };

  const removeInterest = (id: number) => {
    setFormData((prev) => ({
      ...prev,
      interests: prev.interests.filter((i) => i !== id),
    }));
  };

  const toggleGuardian = (id: number) => {
    setFormData((prev) => ({
      ...prev,
      guardians: prev.guardians.includes(id)
        ? prev.guardians.filter((i) => i !== id)
        : [...prev.guardians, id],
    }));
    setGuardianSearchTerm('');
    setShowGuardianDropdown(false);
  };

  const removeGuardian = (id: number) => {
    setFormData((prev) => ({
      ...prev,
      guardians: prev.guardians.filter((i) => i !== id),
    }));
  };

  const filteredInterests = interests.filter(
    (interest) =>
      interest.name.toLowerCase().includes(interestSearchTerm.toLowerCase()) &&
      !formData.interests.includes(interest.id)
  );

  const filteredGuardians = guardiansList.filter((guardian) => {
    const target = `${guardian.first_name} ${guardian.last_name} ${guardian.email}`.toLowerCase();
    return (
      target.includes(guardianSearchTerm.toLowerCase()) &&
      !formData.guardians.includes(guardian.id)
    );
  });

  const getSelectedInterests = () =>
    formData.interests.map((id) => interests.find((interest) => interest.id === id)).filter(Boolean) as Option[];

  const getSelectedGuardians = () =>
    formData.guardians.map((id) => guardiansList.find((guardian) => guardian.id === id)).filter(Boolean) as GuardianOption[];

  const getInitials = (first = '', last = '') => {
    const a = first.charAt(0)?.toUpperCase() || '';
    const b = last.charAt(0)?.toUpperCase() || '';
    return a + b || '?';
  };

  const getAvatarColor = () => 'bg-green-100 text-green-700';
  const getVerificationBadge = (status: string) => {
    switch (status) {
      case 'VERIFIED':
        return 'bg-green-100 text-green-700';
      case 'PENDING':
        return 'bg-yellow-100 text-yellow-700';
      default:
        return 'bg-gray-100 text-gray-600';
    }
  };

  const currentPage = Number(searchParams.get('page')) || 1;
  const totalPages = totalCount > 0 ? Math.ceil(totalCount / 10) : 1;
  const verifiedCount = stats?.verification?.VERIFIED ?? stats?.verification?.verified ?? stats?.verified ?? 0;
  const active7Days = stats?.activity?.active_7_days ?? 0;
  const gradesTracked = Object.keys(stats?.grades || {}).length;

  return (
    <div>
      <div className="flex justify-between items-center mb-6">
        <div>
          <p className="text-sm text-green-500 uppercase font-semibold">Club Admin</p>
          <h1 className="text-2xl font-bold text-gray-900">Manage Youth Members</h1>
        </div>
        <button onClick={handleOpenCreate} className="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 shadow">
          + Add Youth
        </button>
      </div>

      {stats && (
        <div className="mb-6">
          <button
            onClick={() => setAnalyticsExpanded(!analyticsExpanded)}
            className="flex items-center justify-between w-full bg-white rounded-lg shadow-sm border border-gray-200 p-3 hover:bg-gray-50 transition-colors mb-3"
          >
            <div className="flex items-center gap-2">
              <svg className="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11 19V9m0 0l-3 3m3-3l3 3m5 7V5a2 2 0 00-2-2h-3.5a2 2 0 00-1.6.8l-1.8 2.4H6a2 2 0 00-2 2v11a2 2 0 002 2h12a2 2 0 002-2z" />
              </svg>
              <span className="text-sm font-semibold text-gray-700">Analytics</span>
            </div>
            <svg
              className={`w-5 h-5 text-gray-600 transition-transform duration-200 ${analyticsExpanded ? 'rotate-180' : ''}`}
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
            </svg>
          </button>

          <div
            className={`grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 transition-all duration-500 ease-in-out ${
              analyticsExpanded ? 'max-h-[600px] opacity-100 translate-y-0' : 'max-h-0 opacity-0 -translate-y-4 pointer-events-none'
            } overflow-hidden`}
          >
            <div className="bg-gradient-to-br from-green-500 to-green-600 rounded-xl shadow-md p-4 text-white">
              <h3 className="text-xs font-semibold uppercase text-white/80">Total Youth</h3>
              <p className="text-3xl font-bold mt-1">{stats.total_youth ?? 0}</p>
            </div>
            <div className="bg-white rounded-xl shadow p-4 border border-green-50">
              <h3 className="text-xs font-semibold uppercase text-gray-500 mb-2">Active (7 days)</h3>
              <p className="text-2xl font-bold text-gray-800">{active7Days}</p>
            </div>
            <div className="bg-white rounded-xl shadow p-4 border border-green-50">
              <h3 className="text-xs font-semibold uppercase text-gray-500 mb-2">Verified</h3>
              <p className="text-xl font-bold text-green-600">{verifiedCount}</p>
            </div>
            <div className="bg-white rounded-xl shadow p-4 border border-green-50">
              <h3 className="text-xs font-semibold uppercase text-gray-500 mb-2">Grades Tracked</h3>
              <p className="text-xl font-bold text-green-600">{gradesTracked}</p>
            </div>
          </div>
        </div>
      )}

      <div className="bg-white p-4 rounded-lg shadow mb-6 border border-gray-100">
        <div className="flex flex-wrap gap-4 items-end">
          <div className="flex-1 min-w-[200px]">
            <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Search</label>
            <input
              type="text"
              placeholder="Search name or email..."
              className="w-full border rounded p-2 text-sm bg-gray-50"
              value={searchParams.get('search') || ''}
              onChange={(e) => updateUrl('search', e.target.value)}
            />
          </div>

          <div className="w-20">
            <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Age From</label>
            <input
              type="number"
              className="w-full border rounded p-2 text-sm bg-gray-50"
              value={searchParams.get('age_from') || ''}
              onChange={(e) => updateUrl('age_from', e.target.value)}
            />
          </div>

          <div className="w-20">
            <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Age To</label>
            <input
              type="number"
              className="w-full border rounded p-2 text-sm bg-gray-50"
              value={searchParams.get('age_to') || ''}
              onChange={(e) => updateUrl('age_to', e.target.value)}
            />
          </div>

          <div className="w-24">
            <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Grade From</label>
            <input
              type="number"
              className="w-full border rounded p-2 text-sm bg-gray-50"
              value={searchParams.get('grade_from') || ''}
              onChange={(e) => updateUrl('grade_from', e.target.value)}
            />
          </div>

          <div className="w-24">
            <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Grade To</label>
            <input
              type="number"
              className="w-full border rounded p-2 text-sm bg-gray-50"
              value={searchParams.get('grade_to') || ''}
              onChange={(e) => updateUrl('grade_to', e.target.value)}
            />
          </div>

          <div className="w-44">
            <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Status</label>
            <select
              className="w-full border rounded p-2 text-sm bg-gray-50"
              value={searchParams.get('verification_status') || ''}
              onChange={(e) => updateUrl('verification_status', e.target.value)}
            >
              <option value="">All Statuses</option>
              <option value="UNVERIFIED">Unverified</option>
              <option value="PENDING">Pending</option>
              <option value="VERIFIED">Verified</option>
            </select>
          </div>

          <div className="w-32">
            <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Gender</label>
            <select
              className="w-full border rounded p-2 text-sm bg-gray-50"
              value={searchParams.get('legal_gender') || ''}
              onChange={(e) => updateUrl('legal_gender', e.target.value)}
            >
              <option value="">Any</option>
              <option value="MALE">Male</option>
              <option value="FEMALE">Female</option>
              <option value="OTHER">Other</option>
            </select>
          </div>

          <button onClick={() => router.push(pathname)} className="px-4 py-2 text-sm text-gray-600 hover:text-red-500">
            Clear Filters
          </button>
        </div>
      </div>

      <div className="bg-white rounded-lg shadow overflow-hidden mb-6">
        {isLoading ? (
          <div className="p-8 text-center text-gray-500">Loading youth...</div>
        ) : users.length === 0 ? (
          <div className="p-8 text-center text-gray-500">No youth members found.</div>
        ) : (
          <table className="min-w-full divide-y divide-gray-200">
            <thead className="bg-gray-50">
              <tr>
                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">User</th>
                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Verification</th>
                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Grade / DOB</th>
                <th className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">Actions</th>
              </tr>
            </thead>
            <tbody className="bg-white divide-y divide-gray-200">
              {users.map((youth) => (
                <tr key={youth.id}>
                  <td className="px-6 py-4">
                    <div className="flex items-center">
                      {youth.avatar && !avatarErrors.has(youth.id) ? (
                        <img
                          src={getMediaUrl(youth.avatar) || ''}
                          alt="Avatar"
                          className="w-10 h-10 rounded-full object-cover mr-3"
                          onError={() =>
                            setAvatarErrors((prev) => {
                              const next = new Set(prev);
                              next.add(youth.id);
                              return next;
                            })
                          }
                        />
                      ) : (
                        <div className={`w-10 h-10 rounded-full ${getAvatarColor()} flex items-center justify-center font-semibold text-sm mr-3`}>
                          {getInitials(youth.first_name, youth.last_name)}
                        </div>
                      )}
                      <div>
                        <div className="text-sm font-semibold text-gray-900">
                          {youth.first_name} {youth.last_name}
                        </div>
                        <div className="text-xs text-gray-500">{youth.email}</div>
                      </div>
                    </div>
                  </td>
                  <td className="px-6 py-4">
                    <span className={`px-2 py-1 rounded-full text-xs font-semibold ${getVerificationBadge(youth.verification_status)}`}>
                      {youth.verification_status || 'UNVERIFIED'}
                    </span>
                  </td>
                  <td className="px-6 py-4 text-sm text-gray-600">
                    Grade: <span className="font-semibold">{youth.grade || '-'}</span>
                    <br />
                    <span className="text-xs">{youth.date_of_birth || '-'}</span>
                  </td>
                  <td className="px-6 py-4 whitespace-nowrap text-right text-sm space-x-4">
                    <Link href={`/admin/club/youth/${youth.id}`} className="text-green-600 font-bold">
                      View
                    </Link>
                    <button onClick={() => handleOpenEdit(youth)} className="text-indigo-600 font-bold">
                      Edit
                    </button>
                    <button onClick={() => handleDeleteClick(youth)} className="text-red-600">
                      Delete
                    </button>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        )}
      </div>

      <div className="flex items-center justify-between border-t border-gray-200 bg-white px-4 py-3 sm:px-6 rounded-lg shadow">
        <div className="text-sm text-gray-600">Total youth: {totalCount}</div>
        <div className="flex items-center gap-2">
          <button
            disabled={currentPage === 1}
            onClick={() => updateUrl('page', (currentPage - 1).toString())}
            className="px-3 py-1 rounded border text-sm disabled:opacity-50"
          >
            Previous
          </button>
          <span className="text-sm text-gray-600">
            Page {currentPage} of {totalPages}
          </span>
          <button
            disabled={currentPage >= totalPages}
            onClick={() => updateUrl('page', (currentPage + 1).toString())}
            className="px-3 py-1 rounded border text-sm disabled:opacity-50"
          >
            Next
          </button>
        </div>
      </div>

      {/* MODAL */}
      {showModal && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
            <div className="bg-white rounded-xl shadow-2xl w-full max-w-2xl p-8 max-h-[90vh] overflow-y-auto">
                <h2 className="text-2xl font-bold mb-6 text-gray-800">{isEditing ? 'Edit Youth' : 'Create Youth'}</h2>
                <form onSubmit={handleSubmit} className="space-y-6">
                    
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <input required type="text" placeholder="First Name" className="border p-2 rounded" value={formData.first_name} onChange={e => setFormData({...formData, first_name: e.target.value})} />
                        <input required type="text" placeholder="Last Name" className="border p-2 rounded" value={formData.last_name} onChange={e => setFormData({...formData, last_name: e.target.value})} />
                        <input type="text" placeholder="Nickname" className="border p-2 rounded" value={formData.nickname} onChange={e => setFormData({...formData, nickname: e.target.value})} />
                        <input required type="email" placeholder="Email" className="border p-2 rounded" value={formData.email} onChange={e => setFormData({...formData, email: e.target.value})} />
                        <input type="password" placeholder="Password" className="border p-2 rounded" required={!isEditing} value={formData.password} onChange={e => setFormData({...formData, password: e.target.value})} />
                        <input type="text" placeholder="Phone" className="border p-2 rounded" value={formData.phone_number} onChange={e => setFormData({...formData, phone_number: e.target.value})} />
                    </div>

                    <div className="bg-gray-50 p-4 rounded-lg border grid grid-cols-2 gap-4">
                        <div>
                            <label className="block text-xs font-bold uppercase text-gray-500 mb-1">Date of Birth</label>
                            <input type="date" className="w-full border p-2 rounded" value={formData.date_of_birth} onChange={e => setFormData({...formData, date_of_birth: e.target.value})} />
                        </div>
                        <div>
                            <label className="block text-xs font-bold uppercase text-gray-500 mb-1">Grade</label>
                            <input type="number" placeholder="e.g. 7" className="w-full border p-2 rounded" value={formData.grade} onChange={e => setFormData({...formData, grade: e.target.value})} />
                        </div>
                        <select className="border p-2 rounded" value={formData.legal_gender} onChange={e => setFormData({...formData, legal_gender: e.target.value})}>
                            <option value="MALE">Male</option><option value="FEMALE">Female</option><option value="OTHER">Other</option>
                        </select>
                        <input type="text" placeholder="Preferred Gender" className="border p-2 rounded" value={formData.preferred_gender} onChange={e => setFormData({...formData, preferred_gender: e.target.value})} />
                    </div>

                    {/* STATUS */}
                    <div className="bg-green-50 p-4 rounded-lg border border-green-100">
                        <label className="block text-sm font-bold text-green-800 mb-2">Verification</label>
                        <div className="flex gap-4">
                            {['UNVERIFIED', 'PENDING', 'VERIFIED'].map(status => (
                                <label key={status} className="flex items-center space-x-2">
                                    <input type="radio" name="verification_status" value={status} checked={formData.verification_status === status} onChange={e => setFormData({...formData, verification_status: e.target.value})} />
                                    <span className="text-sm font-medium">{status}</span>
                                </label>
                            ))}
                        </div>
                    </div>

                    {/* GUARDIANS & INTERESTS */}
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                      <div>
                        <label className="block text-sm font-bold mb-2">Assign Guardians</label>
                        {formData.guardians.length > 0 && (
                          <div className="flex flex-wrap gap-2 mb-3 p-3 bg-blue-50 rounded-lg border border-blue-200">
                            {getSelectedGuardians().map((guardian) => (
                              <span key={guardian.id} className="inline-flex items-center gap-1.5 px-3 py-1.5 bg-blue-600 text-white text-sm rounded-full font-medium">
                                {guardian.first_name} {guardian.last_name}
                                <button type="button" onClick={() => removeGuardian(guardian.id)} className="hover:bg-blue-700 rounded-full p-0.5 transition-colors">
                                  <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                                  </svg>
                                </button>
                              </span>
                            ))}
                          </div>
                        )}
                        <div className="relative mb-4">
                          <input
                            type="text"
                            placeholder="Search guardians..."
                            value={guardianSearchTerm}
                            onChange={(e) => {
                              setGuardianSearchTerm(e.target.value);
                              setShowGuardianDropdown(true);
                            }}
                            onFocus={() => setShowGuardianDropdown(true)}
                            className="w-full border border-gray-300 rounded-lg p-2.5 focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                          />
                          {showGuardianDropdown && (
                            <>
                              <div className="fixed inset-0 z-10" onClick={() => setShowGuardianDropdown(false)}></div>
                              <div className="absolute z-20 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-60 overflow-y-auto">
                                {filteredGuardians.length > 0 ? (
                                  filteredGuardians.map((guardian) => (
                                    <button
                                      key={guardian.id}
                                      type="button"
                                      onClick={() => toggleGuardian(guardian.id)}
                                      className="w-full text-left px-4 py-2.5 hover:bg-blue-50 transition-colors border-b border-gray-100 last:border-b-0"
                                    >
                                      <div className="font-medium text-gray-900">{guardian.first_name} {guardian.last_name}</div>
                                      <div className="text-xs text-gray-500">{guardian.email}</div>
                                    </button>
                                  ))
                                ) : guardianSearchTerm ? (
                                  <div className="px-4 py-3 text-sm text-gray-500 text-center">No guardians found</div>
                                ) : (
                                  <div className="px-4 py-3 text-sm text-gray-500 text-center">All guardians already selected</div>
                                )}
                              </div>
                            </>
                          )}
                        </div>
                      </div>

                      <div>
                        <label className="block text-sm font-bold mb-2">Interests</label>
                        {formData.interests.length > 0 && (
                          <div className="flex flex-wrap gap-2 mb-3 p-3 bg-purple-50 rounded-lg border border-purple-200">
                            {getSelectedInterests().map((interest) => (
                              <span key={interest.id} className="inline-flex items-center gap-1.5 px-3 py-1.5 bg-purple-600 text-white text-sm rounded-full font-medium">
                                {interest.name}
                                <button type="button" onClick={() => removeInterest(interest.id)} className="hover:bg-purple-700 rounded-full p-0.5 transition-colors">
                                  <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                                  </svg>
                                </button>
                              </span>
                            ))}
                          </div>
                        )}
                        <div className="relative mb-4">
                          <input
                            type="text"
                            placeholder="Search interests..."
                            value={interestSearchTerm}
                            onChange={(e) => {
                              setInterestSearchTerm(e.target.value);
                              setShowInterestDropdown(true);
                            }}
                            onFocus={() => setShowInterestDropdown(true)}
                            className="w-full border border-gray-300 rounded-lg p-2.5 focus:ring-2 focus:ring-purple-500 focus:border-purple-500"
                          />
                          {showInterestDropdown && (
                            <>
                              <div className="fixed inset-0 z-10" onClick={() => setShowInterestDropdown(false)}></div>
                              <div className="absolute z-20 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-60 overflow-y-auto">
                                {filteredInterests.length > 0 ? (
                                  filteredInterests.map((interest) => (
                                    <button
                                      key={interest.id}
                                      type="button"
                                      onClick={() => toggleInterest(interest.id)}
                                      className="w-full text-left px-4 py-2.5 hover:bg-purple-50 transition-colors border-b border-gray-100 last:border-b-0"
                                    >
                                      <div className="font-medium text-gray-900">{interest.name}</div>
                                    </button>
                                  ))
                                ) : interestSearchTerm ? (
                                  <div className="px-4 py-3 text-sm text-gray-500 text-center">No interests found</div>
                                ) : (
                                  <div className="px-4 py-3 text-sm text-gray-500 text-center">All interests already selected</div>
                                )}
                              </div>
                            </>
                          )}
                        </div>
                      </div>
                    </div>

                    <div><label className="block text-sm font-bold mb-2">Avatar</label><input type="file" className="w-full border p-2 rounded" onChange={handleAvatarChange} /></div>

                    {/* Custom Fields */}
                    <CustomFieldsForm
                      targetRole="YOUTH_MEMBER"
                      context="USER_PROFILE"
                      values={customFieldValues}
                      onChange={(fieldId, value) => {
                        setCustomFieldValues((prev) => ({
                          ...prev,
                          [fieldId]: value,
                        }));
                      }}
                      userId={isEditing ? editUserId : null}
                      userMunicipalityId={null}
                      userClubId={user?.assigned_club || null}
                    />

                    <div className="flex justify-end gap-4 pt-4 border-t">
                        <button type="button" onClick={()=>setShowModal(false)} className="text-gray-500">Cancel</button>
                        <button type="submit" className="bg-green-600 text-white px-6 py-2 rounded">{isEditing ? 'Save' : 'Create'}</button>
                    </div>
                </form>
            </div>
        </div>
       )}

      {/* Delete Confirmation Modal */}
      <DeleteConfirmationModal
        isVisible={showDeleteModal}
        onClose={() => {
          if (!isDeleting) {
            setShowDeleteModal(false);
            setUserToDelete(null);
          }
        }}
        onConfirm={handleDeleteConfirm}
        itemName={userToDelete?.name}
        isLoading={isDeleting}
      />

      <Toast message={toast.message} type={toast.type} isVisible={toast.isVisible} onClose={() => setToast({ ...toast, isVisible: false })} />
    </div>
  );
}

export default function ManageClubYouthPage() {
  return (
    <Suspense fallback={<div>Loading...</div>}>
      <ManageClubYouthPageContent />
    </Suspense>
  );
}
--- END OF FILE: ./frontend/app/admin/club/youth/page.tsx ---


--- START OF FILE: ./frontend/app/admin/club/youth/[id]/page.tsx ---
'use client';

import { useState, useEffect, Suspense } from 'react';
import { useRouter, useParams } from 'next/navigation';
import Link from 'next/link';
import api from '../../../../../lib/api';
import { getMediaUrl } from '../../../../utils';
import CustomFieldsDisplay from '../../../../components/CustomFieldsDisplay';

interface Option { id: number; name: string; }
interface GuardianOption { id: number; first_name: string; last_name: string; email: string; }

function YouthViewPageContent() {
  const router = useRouter();
  const params = useParams();
  const youthId = params?.id as string;

  const [youth, setYouth] = useState<any>(null);
  const [clubs, setClubs] = useState<Option[]>([]);
  const [interests, setInterests] = useState<Option[]>([]);
  const [guardiansList, setGuardiansList] = useState<GuardianOption[]>([]);
  const [isLoading, setIsLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);

  useEffect(() => {
    if (youthId) {
      fetchData();
    }
  }, [youthId]);

  const fetchData = async () => {
    setIsLoading(true);
    setError(null);
    try {
      const userRes = await api.get(`/users/${youthId}/`);
      setYouth(userRes.data);

      const clubRes = await api.get('/clubs/?page_size=1000');
      setClubs(Array.isArray(clubRes.data) ? clubRes.data : (clubRes.data?.results || []));

      const interestRes = await api.get('/interests/');
      setInterests(Array.isArray(interestRes.data) ? interestRes.data : (interestRes.data?.results || []));

      const guardianRes = await api.get('/users/list_guardians/');
      setGuardiansList(guardianRes.data);
    } catch (err: any) {
      setError(err?.response?.status === 404 ? 'Youth member not found or access denied.' : 'Failed to load youth member');
    } finally {
      setIsLoading(false);
    }
  };

  const calculateAge = (dateOfBirth: string | null) => {
    if (!dateOfBirth) return null;
    const today = new Date();
    const birthDate = new Date(dateOfBirth);
    let age = today.getFullYear() - birthDate.getFullYear();
    const monthDiff = today.getMonth() - birthDate.getMonth();
    if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) age--;
    return age;
  };

  if (isLoading) {
    return (
      <div className="p-8 text-center">
        <p className="text-gray-500">Loading youth member...</p>
      </div>
    );
  }

  if (error || !youth) {
    return (
      <div className="p-8">
        <div className="bg-red-50 border border-red-200 rounded-lg p-4 mb-4">
          <p className="text-red-800">{error || 'Youth member not found.'}</p>
        </div>
        <Link href="/admin/club/youth" className="text-green-600 hover:text-green-800 font-semibold">
          ‚Üê Back to Youth Members
        </Link>
      </div>
    );
  }

  const interestIds = youth.interests?.map((i: any) => (typeof i === 'object' ? i.id : i)) || [];
  const guardianIds = youth.guardians || [];

  return (
    <div className="p-8 space-y-6">
      <div className="flex items-center justify-between">
        <Link href="/admin/club/youth" className="text-green-600 hover:text-green-800 font-semibold">
          ‚Üê Back to Youth Members
        </Link>
        <button
          onClick={() => router.push(`/admin/club/youth?edit=${youth.id}`)}
          className="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 shadow"
        >
          Edit Youth
        </button>
      </div>

      <section className="bg-white rounded-2xl shadow-xl p-8">
        <div className="flex flex-col md:flex-row md:items-center gap-6 border-b pb-6">
          {youth.avatar && (
            <img
              src={getMediaUrl(youth.avatar) || ''}
              alt={`${youth.first_name} ${youth.last_name}`}
              className="w-32 h-32 rounded-full object-cover border-4 border-green-100"
              onError={(e) => ((e.target as HTMLImageElement).style.display = 'none')}
            />
          )}
          <div>
            <p className="text-sm text-green-500 uppercase font-semibold">Youth Profile</p>
            <h1 className="text-3xl font-bold text-gray-900 mt-1">
              {youth.first_name} {youth.last_name}
              {youth.nickname && <span className="text-xl text-gray-500 ml-2">({youth.nickname})</span>}
            </h1>
            <p className="text-gray-600 mt-2">{youth.email}</p>
            <div className="flex items-center gap-3 mt-3">
              <span className={`px-3 py-1 text-xs font-bold rounded-full ${
                youth.verification_status === 'VERIFIED'
                  ? 'bg-green-100 text-green-700'
                  : youth.verification_status === 'PENDING'
                  ? 'bg-yellow-100 text-yellow-700'
                  : 'bg-gray-100 text-gray-600'
              }`}>
                {youth.verification_status || 'UNVERIFIED'}
              </span>
              {youth.phone_number && <span className="text-sm text-gray-600">üìû {youth.phone_number}</span>}
            </div>
          </div>
        </div>
      </section>

      <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <div className="lg:col-span-2 space-y-6">
          <section className="bg-white rounded-2xl shadow p-6">
            <h2 className="text-xl font-bold text-gray-800 mb-4">Basic Information</h2>
            <div className="grid grid-cols-2 gap-4 text-sm">
              <div>
                <p className="text-gray-500 font-semibold uppercase text-xs mb-1">Date of Birth</p>
                <p className="text-gray-900">{youth.date_of_birth || '-'}</p>
              </div>
              <div>
                <p className="text-gray-500 font-semibold uppercase text-xs mb-1">Age</p>
                <p className="text-gray-900">{calculateAge(youth.date_of_birth) || '-'}</p>
              </div>
              <div>
                <p className="text-gray-500 font-semibold uppercase text-xs mb-1">Grade</p>
                <p className="text-gray-900">{youth.grade || '-'}</p>
              </div>
              <div>
                <p className="text-gray-500 font-semibold uppercase text-xs mb-1">Legal Gender</p>
                <p className="text-gray-900">{youth.legal_gender || '-'}</p>
              </div>
              <div>
                <p className="text-gray-500 font-semibold uppercase text-xs mb-1">Preferred Gender</p>
                <p className="text-gray-900">{youth.preferred_gender || '-'}</p>
              </div>
              <div>
                <p className="text-gray-500 font-semibold uppercase text-xs mb-1">Preferred Club</p>
                <p className="text-gray-900">{clubs.find((c) => c.id === youth.preferred_club)?.name || '-'}</p>
              </div>
            </div>
          </section>

          {guardianIds.length > 0 && (
            <section className="bg-white rounded-2xl shadow p-6">
              <h2 className="text-xl font-bold text-gray-800 mb-4">Assigned Guardians</h2>
              <div className="space-y-3">
                {guardianIds.map((guardianId: number) => {
                  const guardian = guardiansList.find((g) => g.id === guardianId);
                  if (!guardian) return null;
                  return (
                    <div key={guardianId} className="p-3 border rounded-lg bg-gray-50">
                      <p className="text-sm font-semibold text-gray-900">
                        {guardian.first_name} {guardian.last_name}
                      </p>
                      <p className="text-xs text-gray-500">{guardian.email}</p>
                    </div>
                  );
                })}
              </div>
            </section>
          )}

          {interestIds.length > 0 && (
            <section className="bg-white rounded-2xl shadow p-6">
              <h2 className="text-xl font-bold text-gray-800 mb-4">Interests</h2>
              <div className="flex flex-wrap gap-2">
                {interestIds.map((interestId: number) => {
                  const interest = interests.find((i) => i.id === interestId);
                  if (!interest) return null;
                  return (
                    <span
                      key={interestId}
                      className="px-3 py-1 bg-green-100 text-green-700 rounded-full text-sm font-medium"
                    >
                      {interest.name}
                    </span>
                  );
                })}
              </div>
            </section>
          )}

          {/* CUSTOM FIELDS */}
          <CustomFieldsDisplay
            userId={youth.id}
            targetRole="YOUTH_MEMBER"
            context="USER_PROFILE"
          />
        </div>

        <aside className="space-y-6">
          <section className="bg-white rounded-2xl shadow p-6">
            <h3 className="text-lg font-bold text-gray-800 mb-3">Account Information</h3>
            <div className="space-y-3 text-sm text-gray-700">
              <div>
                <p className="text-xs text-gray-500 font-semibold uppercase">Date Joined</p>
                <p>{youth.date_joined ? new Date(youth.date_joined).toLocaleDateString() : '-'}</p>
              </div>
              <div>
                <p className="text-xs text-gray-500 font-semibold uppercase">Last Login</p>
                <p>{youth.last_login ? new Date(youth.last_login).toLocaleDateString() : 'Never'}</p>
              </div>
              <div>
                <p className="text-xs text-gray-500 font-semibold uppercase">Preferred Language</p>
                <p>{youth.preferred_language || '-'}</p>
              </div>
              <div>
                <p className="text-xs text-gray-500 font-semibold uppercase">Account Status</p>
                <span
                  className={`px-2 py-1 rounded text-xs font-bold ${
                    youth.is_active ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'
                  }`}
                >
                  {youth.is_active ? 'Active' : 'Inactive'}
                </span>
              </div>
            </div>
          </section>

          <section className="bg-white rounded-2xl shadow p-6 space-y-2">
            <button
              onClick={() => router.push(`/admin/club/youth?edit=${youth.id}`)}
              className="w-full bg-green-600 text-white py-2 rounded-lg font-semibold hover:bg-green-700"
            >
              Edit Youth
            </button>
            <Link
              href="/admin/club/youth"
              className="block w-full text-center bg-gray-100 text-gray-700 py-2 rounded-lg font-semibold hover:bg-gray-200"
            >
              Back to List
            </Link>
          </section>
        </aside>
      </div>
    </div>
  );
}

export default function YouthViewPage() {
  return (
    <Suspense fallback={<div className="p-8 text-center">Loading...</div>}>
      <YouthViewPageContent />
    </Suspense>
  );
}
--- END OF FILE: ./frontend/app/admin/club/youth/[id]/page.tsx ---


--- START OF FILE: ./frontend/app/admin/club/guardians/page.tsx ---
'use client';

import { useState, useEffect, Suspense } from 'react';
import { useRouter, useSearchParams, usePathname } from 'next/navigation';
import Link from 'next/link';
import api from '../../../../lib/api';
import { useAuth } from '../../../../context/AuthContext';
import { getMediaUrl } from '../../../utils';
import Toast from '../../../components/Toast';
import DeleteConfirmationModal from '../../../components/DeleteConfirmationModal';
import CustomFieldsForm from '../../../components/CustomFieldsForm';

interface YouthOption {
  id: number;
  first_name: string;
  last_name: string;
  email: string;
  grade: number | null;
}

function ManageClubGuardiansPageContent() {
  const router = useRouter();
  const pathname = usePathname();
  const searchParams = useSearchParams();

  const [guardians, setGuardians] = useState<any[]>([]);
  const [totalCount, setTotalCount] = useState(0);
  const [isLoading, setIsLoading] = useState(true);
  const [stats, setStats] = useState<any>(null);
  const [analyticsExpanded, setAnalyticsExpanded] = useState(true);
  const [avatarErrors, setAvatarErrors] = useState<Set<number>>(new Set());

  const [toast, setToast] = useState<{ message: string; type: 'success' | 'error' | 'info' | 'warning'; isVisible: boolean }>({
    message: '',
    type: 'success',
    isVisible: false,
  });

  const [youthList, setYouthList] = useState<YouthOption[]>([]);
  const { user } = useAuth();
  const [customFieldValues, setCustomFieldValues] = useState<Record<number, any>>({});

  const [showModal, setShowModal] = useState(false);
  const [isEditing, setIsEditing] = useState(false);
  const [editUserId, setEditUserId] = useState<number | null>(null);
  const [avatarFile, setAvatarFile] = useState<File | null>(null);
  const [avatarPreview, setAvatarPreview] = useState<string | null>(null);
  const [youthSearchTerm, setYouthSearchTerm] = useState('');
  const [showYouthDropdown, setShowYouthDropdown] = useState(false);
  
  // Delete Confirmation Modal State
  const [showDeleteModal, setShowDeleteModal] = useState(false);
  const [userToDelete, setUserToDelete] = useState<{ id: number; name: string } | null>(null);
  const [isDeleting, setIsDeleting] = useState(false);

  const initialFormState = {
    email: '',
    password: '',
    first_name: '',
    last_name: '',
    phone_number: '',
    legal_gender: 'MALE',
    verification_status: 'UNVERIFIED',
    youth_members: [] as number[],
  };
  const [formData, setFormData] = useState(initialFormState);

  useEffect(() => {
    fetchDropdowns();
    fetchStats();
  }, []);

  useEffect(() => {
    fetchGuardians();
  }, [searchParams]);

  useEffect(() => {
    const editId = searchParams.get('edit');
    if (editId && !isEditing && !showModal) {
      const userId = parseInt(editId, 10);
      const existing = guardians.find((g) => g.id === userId);
      if (existing) {
        handleOpenEdit(existing);
      } else if (!isNaN(userId)) {
        api
          .get(`/users/${userId}/`)
          .then((res) => handleOpenEdit(res.data))
          .catch((err) => console.error('Failed to load guardian for edit', err));
      }
    }
  }, [searchParams, guardians, isEditing, showModal]);

  const fetchStats = async () => {
    try {
      const res = await api.get('/users/guardian_stats/');
      setStats(res.data);
    } catch (err) {
      console.error(err);
    }
  };

  const fetchDropdowns = async () => {
    try {
      // Backend automatically filters youth to only those assigned to this club admin's club
      const youthRes = await api.get('/users/list_youth/');
      setYouthList(Array.isArray(youthRes.data) ? youthRes.data : []);
    } catch (err) {
      console.error(err);
    }
  };

  const fetchGuardians = async () => {
    setIsLoading(true);
    try {
      const params = new URLSearchParams();
      params.set('role', 'GUARDIAN');
      const search = searchParams.get('search');
      if (search) params.set('search', search);
      const gender = searchParams.get('legal_gender');
      if (gender) params.set('legal_gender', gender);
      const status = searchParams.get('verification_status');
      if (status) params.set('verification_status', status);
      const page = searchParams.get('page');
      if (page) params.set('page', page);

      // Backend automatically filters guardians to only those linked to youth in this club
      const res = await api.get(`/users/?${params.toString()}`);
      if (res.data?.results) {
        setGuardians(res.data.results);
        setTotalCount(res.data.count ?? res.data.results.length);
      } else {
        const data = Array.isArray(res.data) ? res.data : [];
        setGuardians(data);
        setTotalCount(data.length);
      }
    } catch (err) {
      console.error(err);
    } finally {
      setIsLoading(false);
    }
  };

  const updateUrl = (key: string, value: string) => {
    const params = new URLSearchParams(searchParams.toString());
    if (value) params.set(key, value);
    else params.delete(key);
    if (key !== 'page') params.set('page', '1');
    router.push(`${pathname}?${params.toString()}`);
  };

  const handleOpenCreate = () => {
    setIsEditing(false);
    setEditUserId(null);
    setFormData(initialFormState);
    setCustomFieldValues({});
    setAvatarFile(null);
    setAvatarPreview(null);
    setYouthSearchTerm('');
    setShowYouthDropdown(false);
    setShowModal(true);
  };

  const handleOpenEdit = async (guardian: any) => {
    setIsEditing(true);
    setEditUserId(guardian.id);
    setFormData({
      email: guardian.email || '',
      password: '',
      first_name: guardian.first_name || '',
      last_name: guardian.last_name || '',
      phone_number: guardian.phone_number || '',
      legal_gender: guardian.legal_gender || 'MALE',
      verification_status: guardian.verification_status || 'UNVERIFIED',
      youth_members: guardian.youth_members || [],
    });
    setAvatarFile(null);
    setAvatarPreview(guardian.avatar ? getMediaUrl(guardian.avatar) : null);
    setYouthSearchTerm('');
    setShowYouthDropdown(false);
    
    // Load custom field values for this user
    try {
      const userRes = await api.get(`/users/${guardian.id}/`);
      const customFieldValuesData = userRes.data.custom_field_values || [];
      const values: Record<number, any> = {};
      customFieldValuesData.forEach((cfv: any) => {
        values[cfv.field] = cfv.value;
      });
      setCustomFieldValues(values);
    } catch (err) {
      console.error('Failed to load custom field values:', err);
      setCustomFieldValues({});
    }
    
    setShowModal(true);
  };

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    try {
      const data = new FormData();
      Object.entries(formData).forEach(([key, value]) => {
        if (key === 'password' && !value) return;
        if (key === 'youth_members') return;
        data.append(key, value?.toString() || '');
      });
      formData.youth_members.forEach((id) => data.append('youth_members', id.toString()));
      data.append('role', 'GUARDIAN');
      if (avatarFile) data.append('avatar', avatarFile);

      const config = { headers: { 'Content-Type': 'multipart/form-data' } };
      let userId: number;
      if (isEditing && editUserId) {
        await api.patch(`/users/${editUserId}/`, data, config);
        userId = editUserId;
        setToast({ message: 'Guardian updated successfully!', type: 'success', isVisible: true });
      } else {
        const createRes = await api.post('/users/', data, config);
        userId = createRes.data.id;
        setToast({ message: 'Guardian created successfully!', type: 'success', isVisible: true });
      }

      // Save custom field values
      if (Object.keys(customFieldValues).length > 0) {
        try {
          await api.post('/custom-fields/save_values_for_user/', {
            user_id: userId,
            values: customFieldValues,
          });
        } catch (err) {
          console.error('Failed to save custom field values:', err);
        }
      }

      setShowModal(false);
      fetchGuardians();
      fetchStats();
    } catch (err) {
      console.error(err);
      setToast({ message: 'Operation failed. Please try again.', type: 'error', isVisible: true });
    }
  };

  const handleDeleteClick = (guardian: any) => {
    setUserToDelete({ id: guardian.id, name: `${guardian.first_name} ${guardian.last_name}` });
    setShowDeleteModal(true);
  };

  const handleDeleteConfirm = async () => {
    if (!userToDelete) return;

    setIsDeleting(true);
    try {
      await api.delete(`/users/${userToDelete.id}/`);
      setToast({ message: 'Guardian deleted successfully!', type: 'success', isVisible: true });
      setShowDeleteModal(false);
      setUserToDelete(null);
      fetchGuardians();
      fetchStats();
    } catch (err) {
      setToast({ message: 'Failed to delete guardian.', type: 'error', isVisible: true });
    } finally {
      setIsDeleting(false);
    }
  };

  const handleAvatarChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (file) {
      setAvatarFile(file);
      const reader = new FileReader();
      reader.onloadend = () => setAvatarPreview(reader.result as string);
      reader.readAsDataURL(file);
    }
  };

  const toggleYouth = (id: number) => {
    setFormData((prev) => {
      const exists = prev.youth_members.includes(id);
      if (exists) {
        return { ...prev, youth_members: prev.youth_members.filter((y) => y !== id) };
      }
      return { ...prev, youth_members: [...prev.youth_members, id] };
    });
    setYouthSearchTerm('');
    setShowYouthDropdown(false);
  };

  const removeYouth = (id: number) => {
    setFormData((prev) => ({
      ...prev,
      youth_members: prev.youth_members.filter((y) => y !== id),
    }));
  };

  const filteredYouth = youthList.filter((y) => {
    const target = `${y.first_name} ${y.last_name} ${y.email}`.toLowerCase();
    return target.includes(youthSearchTerm.toLowerCase()) && !formData.youth_members.includes(y.id);
  });

  const getSelectedYouth = () =>
    formData.youth_members.map((id) => youthList.find((y) => y.id === id)).filter(Boolean) as YouthOption[];

  const getInitials = (first = '', last = '') => {
    const a = first.charAt(0)?.toUpperCase() || '';
    const b = last.charAt(0)?.toUpperCase() || '';
    return a + b || '?';
  };

  const getAvatarColor = () => 'bg-green-100 text-green-700';

  const currentPage = Number(searchParams.get('page')) || 1;
  const totalPages = totalCount > 0 ? Math.ceil(totalCount / 10) : 1;

  return (
    <div>
      <div className="flex flex-wrap justify-between items-center gap-4 mb-6">
        <div>
          <p className="text-sm text-green-500 uppercase font-semibold">Club Admin</p>
          <h1 className="text-2xl font-bold text-gray-900">Manage Guardians</h1>
        </div>
        <button onClick={handleOpenCreate} className="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 shadow">
          + Add Guardian
        </button>
      </div>

      {stats && (
        <div className="mb-6">
          <button
            onClick={() => setAnalyticsExpanded(!analyticsExpanded)}
            className="flex items-center justify-between w-full bg-white rounded-lg shadow-sm border border-gray-200 p-3 hover:bg-gray-50 transition-colors mb-3"
          >
            <div className="flex items-center gap-2">
              <svg className="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
              </svg>
              <span className="text-sm font-semibold text-gray-700">Analytics</span>
            </div>
            <svg
              className={`w-5 h-5 text-gray-600 transition-transform duration-200 ${analyticsExpanded ? 'rotate-180' : ''}`}
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
            </svg>
          </button>

          <div
            className={`grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 transition-all duration-500 ease-in-out ${
              analyticsExpanded ? 'max-h-[600px] opacity-100 translate-y-0' : 'max-h-0 opacity-0 -translate-y-4 pointer-events-none'
            } overflow-hidden`}
          >
            <div className="bg-gradient-to-br from-green-500 to-green-600 rounded-xl shadow-md p-4 text-white">
              <h3 className="text-xs font-semibold uppercase text-white/80">Total Guardians</h3>
              <p className="text-3xl font-bold mt-1">{stats.total_guardians}</p>
              <p className="text-xs text-white/80">Active in your club</p>
            </div>
            <div className="bg-white rounded-xl shadow p-4 border border-green-50">
              <h3 className="text-xs font-semibold uppercase text-gray-500 mb-1">Verified</h3>
              <p className="text-2xl font-bold text-gray-900">{stats.verification?.verified ?? 0}</p>
            </div>
            <div className="bg-white rounded-xl shadow p-4 border border-green-50">
              <h3 className="text-xs font-semibold uppercase text-gray-500 mb-1">Pending</h3>
              <p className="text-2xl font-bold text-gray-900">{stats.verification?.pending ?? 0}</p>
            </div>
            <div className="bg-white rounded-xl shadow p-4 border border-green-50">
              <h3 className="text-xs font-semibold uppercase text-gray-500 mb-1">Active (7 days)</h3>
              <p className="text-2xl font-bold text-gray-900">{stats.activity?.active_7_days ?? 0}</p>
            </div>
          </div>
        </div>
      )}

      <div className="bg-white p-4 rounded-lg shadow mb-6 border border-gray-100">
        <div className="flex flex-wrap gap-4 items-end">
          <div className="flex-1 min-w-[200px]">
            <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Search</label>
            <input
              type="text"
              placeholder="Name or email..."
              className="w-full border rounded p-2 text-sm bg-gray-50"
              value={searchParams.get('search') || ''}
              onChange={(e) => updateUrl('search', e.target.value)}
            />
          </div>
          <div className="w-40">
            <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Gender</label>
            <select
              className="w-full border rounded p-2 text-sm bg-gray-50"
              value={searchParams.get('legal_gender') || ''}
              onChange={(e) => updateUrl('legal_gender', e.target.value)}
            >
              <option value="">All</option>
              <option value="MALE">Male</option>
              <option value="FEMALE">Female</option>
              <option value="OTHER">Other</option>
            </select>
          </div>
          <div className="w-40">
            <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Status</label>
            <select
              className="w-full border rounded p-2 text-sm bg-gray-50"
              value={searchParams.get('verification_status') || ''}
              onChange={(e) => updateUrl('verification_status', e.target.value)}
            >
              <option value="">All</option>
              <option value="UNVERIFIED">Unverified</option>
              <option value="PENDING">Pending</option>
              <option value="VERIFIED">Verified</option>
            </select>
          </div>
          <button
            onClick={() => router.push(pathname)}
            className="px-4 py-2 text-sm text-gray-600 border border-gray-300 rounded hover:text-red-600 hover:bg-red-50"
          >
            Clear Filters
          </button>
        </div>
      </div>

      <div className="bg-white rounded-lg shadow overflow-hidden mb-6">
        {isLoading ? (
          <div className="p-8 text-center text-gray-500">Loading guardians...</div>
        ) : guardians.length === 0 ? (
          <div className="p-8 text-center text-gray-500">No guardians found for your club.</div>
        ) : (
          <table className="min-w-full divide-y divide-gray-200">
            <thead className="bg-gray-50">
              <tr>
                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Guardian</th>
                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Linked Youth</th>
                <th className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">Actions</th>
              </tr>
            </thead>
            <tbody className="bg-white divide-y divide-gray-200">
              {guardians.map((guardian) => (
                <tr key={guardian.id}>
                  <td className="px-6 py-4 whitespace-nowrap">
                    <div className="flex items-center">
                      {guardian.avatar && !avatarErrors.has(guardian.id) ? (
                        <img
                          src={getMediaUrl(guardian.avatar) || ''}
                          alt="Avatar"
                          className="w-10 h-10 rounded-full object-cover mr-3"
                          onError={() =>
                            setAvatarErrors((prev) => {
                              const next = new Set(prev);
                              next.add(guardian.id);
                              return next;
                            })
                          }
                        />
                      ) : (
                        <div className={`w-10 h-10 rounded-full ${getAvatarColor()} flex items-center justify-center font-semibold text-sm mr-3`}>
                          {getInitials(guardian.first_name, guardian.last_name)}
                        </div>
                      )}
                      <div>
                        <div className="text-sm font-medium text-gray-900">{guardian.first_name} {guardian.last_name}</div>
                        <div className="text-xs text-gray-500">{guardian.email}</div>
                      </div>
                    </div>
                  </td>
                  <td className="px-6 py-4 whitespace-nowrap">
                    <span
                      className={`px-2 py-1 text-xs font-bold rounded-full ${
                        guardian.verification_status === 'VERIFIED'
                          ? 'bg-green-100 text-green-800'
                          : guardian.verification_status === 'PENDING'
                          ? 'bg-yellow-100 text-yellow-800'
                          : 'bg-gray-100 text-gray-600'
                      }`}
                    >
                      {guardian.verification_status || 'UNVERIFIED'}
                    </span>
                  </td>
                  <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
                    <span className="font-semibold">{guardian.youth_members ? guardian.youth_members.length : 0}</span> linked
                  </td>
                  <td className="px-6 py-4 whitespace-nowrap text-right text-sm space-x-4">
                    <Link href={`/admin/club/guardians/${guardian.id}`} className="text-green-600 font-bold">
                      View
                    </Link>
                    <button onClick={() => handleOpenEdit(guardian)} className="text-indigo-600 font-bold">
                      Edit
                    </button>
                    <button onClick={() => handleDeleteClick(guardian)} className="text-red-600">
                      Delete
                    </button>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        )}
      </div>

      <div className="flex items-center justify-between border-t border-gray-200 bg-white px-4 py-3 sm:px-6 rounded-lg shadow">
        <div className="text-sm text-gray-600">Total guardians: {totalCount}</div>
        <div className="flex items-center gap-2">
          <button
            disabled={currentPage === 1}
            onClick={() => updateUrl('page', (currentPage - 1).toString())}
            className="px-3 py-1 rounded border text-sm disabled:opacity-50"
          >
            Previous
          </button>
          <span className="text-sm text-gray-600">
            Page {currentPage} of {totalPages}
          </span>
          <button
            disabled={currentPage >= totalPages}
            onClick={() => updateUrl('page', (currentPage + 1).toString())}
            className="px-3 py-1 rounded border text-sm disabled:opacity-50"
          >
            Next
          </button>
        </div>
      </div>

      {showModal && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-xl shadow-2xl w-full max-w-2xl p-8 max-h-[90vh] overflow-y-auto">
            <h2 className="text-2xl font-bold mb-6 text-gray-800">{isEditing ? 'Edit Guardian' : 'Create Guardian'}</h2>
            <form onSubmit={handleSubmit} className="space-y-6">
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <input
                  required
                  type="text"
                  placeholder="First Name"
                  className="border p-2 rounded"
                  value={formData.first_name}
                  onChange={(e) => setFormData({ ...formData, first_name: e.target.value })}
                />
                <input
                  required
                  type="text"
                  placeholder="Last Name"
                  className="border p-2 rounded"
                  value={formData.last_name}
                  onChange={(e) => setFormData({ ...formData, last_name: e.target.value })}
                />
                <input
                  required
                  type="email"
                  placeholder="Email"
                  className="border p-2 rounded"
                  value={formData.email}
                  onChange={(e) => setFormData({ ...formData, email: e.target.value })}
                />
                <input
                  type="password"
                  placeholder={isEditing ? 'New Password (optional)' : 'Password'}
                  className="border p-2 rounded"
                  required={!isEditing}
                  value={formData.password}
                  onChange={(e) => setFormData({ ...formData, password: e.target.value })}
                />
                <input
                  type="text"
                  placeholder="Phone Number"
                  className="border p-2 rounded"
                  value={formData.phone_number}
                  onChange={(e) => setFormData({ ...formData, phone_number: e.target.value })}
                />
                <select
                  className="border p-2 rounded"
                  value={formData.legal_gender}
                  onChange={(e) => setFormData({ ...formData, legal_gender: e.target.value })}
                >
                  <option value="MALE">Male</option>
                  <option value="FEMALE">Female</option>
                  <option value="OTHER">Other</option>
                </select>
              </div>

              <div className="bg-green-50 p-4 rounded-lg border border-green-100">
                <label className="block text-sm font-bold text-green-800 mb-2">Verification Status</label>
                <div className="flex gap-4">
                  {['UNVERIFIED', 'PENDING', 'VERIFIED'].map((status) => (
                    <label key={status} className="flex items-center space-x-2 text-sm font-medium">
                      <input
                        type="radio"
                        name="verification_status"
                        value={status}
                        checked={formData.verification_status === status}
                        onChange={(e) => setFormData({ ...formData, verification_status: e.target.value })}
                      />
                      <span>{status}</span>
                    </label>
                  ))}
                </div>
              </div>

              <div>
                <label className="block text-sm font-bold mb-2">Assign Youth Members</label>
                <p className="text-xs text-gray-500 mb-3">Only youth members assigned to your club can be linked.</p>
                {formData.youth_members.length > 0 && (
                  <div className="flex flex-wrap gap-2 mb-3 p-3 bg-blue-50 rounded-lg border border-blue-200">
                    {getSelectedYouth().map((youth) => (
                      <span
                        key={youth.id}
                        className="inline-flex items-center gap-1.5 px-3 py-1.5 bg-blue-600 text-white text-sm rounded-full font-medium"
                      >
                        {youth.first_name} {youth.last_name} {youth.grade ? `(Gr ${youth.grade})` : ''}
                        <button
                          type="button"
                          onClick={() => removeYouth(youth.id)}
                          className="hover:bg-blue-700 rounded-full p-0.5"
                        >
                          <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                          </svg>
                        </button>
                      </span>
                    ))}
                  </div>
                )}

                <div className="relative mb-4">
                  <input
                    type="text"
                    placeholder="Search youth members..."
                    value={youthSearchTerm}
                    onChange={(e) => {
                      setYouthSearchTerm(e.target.value);
                      setShowYouthDropdown(true);
                    }}
                    onFocus={() => setShowYouthDropdown(true)}
                    className="w-full border border-gray-300 rounded-lg p-2.5 pr-10 focus:ring-2 focus:ring-green-500 focus:border-green-500"
                  />
                  <svg
                    className="absolute right-3 top-1/2 transform -translate-y-1/2 w-5 h-5 text-gray-400 pointer-events-none"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                  </svg>

                  {showYouthDropdown && (
                    <>
                      <div className="fixed inset-0 z-10" onClick={() => setShowYouthDropdown(false)}></div>
                      <div className="absolute z-20 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-60 overflow-y-auto">
                        {filteredYouth.length > 0 ? (
                          filteredYouth.map((y) => (
                            <button
                              key={y.id}
                              type="button"
                              onClick={() => toggleYouth(y.id)}
                              className="w-full text-left px-4 py-2.5 hover:bg-green-50 transition-colors border-b border-gray-100 last:border-b-0"
                            >
                              <div className="font-medium text-gray-900">{y.first_name} {y.last_name}</div>
                              <div className="text-xs text-gray-500">{y.email} {y.grade ? `‚Ä¢ Gr ${y.grade}` : ''}</div>
                            </button>
                          ))
                        ) : youthSearchTerm ? (
                          <div className="px-4 py-3 text-sm text-gray-500 text-center">
                            No youth found for "{youthSearchTerm}"
                          </div>
                        ) : (
                          <div className="text-xs text-gray-500 text-center">
                            {formData.youth_members.length === 0 ? 'No youth available.' : 'All youth already selected.'}
                          </div>
                        )}
                      </div>
                    </>
                  )}
                </div>
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">Avatar</label>
                <input type="file" accept="image/*" className="w-full border p-2 rounded" onChange={handleAvatarChange} />
                {avatarPreview && <img src={avatarPreview} alt="Preview" className="w-16 h-16 mt-2 rounded-full object-cover border" />}
              </div>

              <CustomFieldsForm
                targetRole="GUARDIAN"
                context="USER_PROFILE"
                values={customFieldValues}
                onChange={(fieldId, value) => {
                  setCustomFieldValues((prev) => ({
                    ...prev,
                    [fieldId]: value,
                  }));
                }}
                userId={isEditing ? editUserId : null}
                userMunicipalityId={null}
                userClubId={user?.assigned_club ? (typeof user.assigned_club === 'object' ? user.assigned_club.id : user.assigned_club) : null}
              />

              <div className="flex justify-end gap-4 pt-4 border-t">
                <button type="button" onClick={() => setShowModal(false)} className="text-gray-500">
                  Cancel
                </button>
                <button type="submit" className="bg-green-600 text-white px-6 py-2 rounded-lg hover:bg-green-700">
                  {isEditing ? 'Save Changes' : 'Create Guardian'}
                </button>
              </div>
            </form>
          </div>
        </div>
      )}

      {/* Delete Confirmation Modal */}
      <DeleteConfirmationModal
        isVisible={showDeleteModal}
        onClose={() => {
          if (!isDeleting) {
            setShowDeleteModal(false);
            setUserToDelete(null);
          }
        }}
        onConfirm={handleDeleteConfirm}
        itemName={userToDelete?.name}
        isLoading={isDeleting}
      />

      <Toast
        message={toast.message}
        type={toast.type}
        isVisible={toast.isVisible}
        onClose={() => setToast({ ...toast, isVisible: false })}
      />
    </div>
  );
}

export default function ManageClubGuardiansPage() {
  return (
    <Suspense fallback={<div>Loading...</div>}>
      <ManageClubGuardiansPageContent />
    </Suspense>
  );
}


--- END OF FILE: ./frontend/app/admin/club/guardians/page.tsx ---


--- START OF FILE: ./frontend/app/admin/club/guardians/[id]/page.tsx ---
'use client';

import { useState, useEffect, Suspense } from 'react';
import { useRouter, useParams } from 'next/navigation';
import Link from 'next/link';
import api from '../../../../../lib/api';
import { getMediaUrl } from '../../../../utils';
import CustomFieldsDisplay from '../../../../components/CustomFieldsDisplay';

interface YouthOption {
  id: number;
  first_name: string;
  last_name: string;
  email: string;
  grade: number | null;
}

function ClubGuardianViewContent() {
  const router = useRouter();
  const params = useParams();
  const guardianId = params?.id as string;

  const [guardian, setGuardian] = useState<any>(null);
  const [youthList, setYouthList] = useState<YouthOption[]>([]);
  const [isLoading, setIsLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);

  useEffect(() => {
    if (guardianId) {
      fetchData();
    }
  }, [guardianId]);

  const fetchData = async () => {
    setIsLoading(true);
    setError(null);
    try {
      const userRes = await api.get(`/users/${guardianId}/`);
      setGuardian(userRes.data);

      // Backend automatically filters youth to only those assigned to this club admin's club
      const youthRes = await api.get('/users/list_youth/');
      setYouthList(Array.isArray(youthRes.data) ? youthRes.data : []);
    } catch (err: any) {
      setError(err?.response?.status === 404 ? 'Guardian not found or access denied.' : 'Failed to load guardian');
    } finally {
      setIsLoading(false);
    }
  };

  if (isLoading) {
    return (
      <div className="p-8 text-center">
        <p className="text-gray-500">Loading guardian...</p>
      </div>
    );
  }

  if (error || !guardian) {
    return (
      <div className="p-8">
        <div className="bg-red-50 border border-red-200 rounded-lg p-4 mb-4">
          <p className="text-red-800">{error || 'Guardian not found.'}</p>
        </div>
        <Link href="/admin/club/guardians" className="text-green-600 hover:text-green-800 font-semibold">
          ‚Üê Back to Guardians
        </Link>
      </div>
    );
  }

  const youthIds = guardian.youth_members || [];

  return (
    <div className="p-8 space-y-6">
      <div className="flex items-center justify-between">
        <Link href="/admin/club/guardians" className="text-green-600 hover:text-green-800 font-semibold">
          ‚Üê Back to Guardians
        </Link>
        <button
          onClick={() => router.push(`/admin/club/guardians?edit=${guardian.id}`)}
          className="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 shadow"
        >
          Edit Guardian
        </button>
      </div>

      <section className="bg-white rounded-2xl shadow-xl p-8">
        <div className="flex flex-col md:flex-row md:items-center gap-6 border-b pb-6">
          {guardian.avatar && (
            <img
              src={getMediaUrl(guardian.avatar) || ''}
              alt={`${guardian.first_name} ${guardian.last_name}`}
              className="w-32 h-32 rounded-full object-cover border-4 border-green-100"
              onError={(e) => ((e.target as HTMLImageElement).style.display = 'none')}
            />
          )}
          <div>
            <p className="text-sm text-green-500 uppercase font-semibold">Guardian Profile</p>
            <h1 className="text-3xl font-bold text-gray-900 mt-1">
              {guardian.first_name} {guardian.last_name}
            </h1>
            <p className="text-gray-600 mt-2">{guardian.email}</p>
            <div className="flex items-center gap-3 mt-3">
              <span className={`px-3 py-1 text-xs font-bold rounded-full ${
                guardian.verification_status === 'VERIFIED'
                  ? 'bg-green-100 text-green-700'
                  : guardian.verification_status === 'PENDING'
                  ? 'bg-yellow-100 text-yellow-700'
                  : 'bg-gray-100 text-gray-600'
              }`}>
                {guardian.verification_status || 'UNVERIFIED'}
              </span>
              {guardian.phone_number && <span className="text-sm text-gray-600">üìû {guardian.phone_number}</span>}
            </div>
          </div>
        </div>
      </section>

      <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <div className="lg:col-span-2 space-y-6">
          <section className="bg-white rounded-2xl shadow p-6">
            <h2 className="text-xl font-bold text-gray-800 mb-4">Basic Information</h2>
            <div className="grid grid-cols-2 gap-4 text-sm">
              <div>
                <p className="text-gray-500 font-semibold uppercase text-xs mb-1">First Name</p>
                <p className="text-gray-900">{guardian.first_name || '-'}</p>
              </div>
              <div>
                <p className="text-gray-500 font-semibold uppercase text-xs mb-1">Last Name</p>
                <p className="text-gray-900">{guardian.last_name || '-'}</p>
              </div>
              <div>
                <p className="text-gray-500 font-semibold uppercase text-xs mb-1">Email</p>
                <p className="text-gray-900">{guardian.email || '-'}</p>
              </div>
              <div>
                <p className="text-gray-500 font-semibold uppercase text-xs mb-1">Phone Number</p>
                <p className="text-gray-900">{guardian.phone_number || '-'}</p>
              </div>
              <div>
                <p className="text-gray-500 font-semibold uppercase text-xs mb-1">Legal Gender</p>
                <p className="text-gray-900">{guardian.legal_gender || '-'}</p>
              </div>
            </div>
          </section>

          <section className="bg-white rounded-2xl shadow p-6">
            <h2 className="text-xl font-bold text-gray-800 mb-4">Connected Youth Members</h2>
            {youthIds.length === 0 ? (
              <p className="text-gray-500">No youth members connected to this guardian.</p>
            ) : (
              <div className="space-y-3">
                {youthIds.map((yid: number) => {
                  const youth = youthList.find((y) => y.id === yid);
                  if (!youth) return null;
                  return (
                    <div key={yid} className="p-3 border rounded-lg bg-gray-50">
                      <p className="text-sm font-semibold text-gray-900">
                        {youth.first_name} {youth.last_name} {youth.grade ? `(Grade ${youth.grade})` : ''}
                      </p>
                      <p className="text-xs text-gray-500">{youth.email}</p>
                    </div>
                  );
                })}
              </div>
            )}
          </section>

          {/* CUSTOM FIELDS */}
          <CustomFieldsDisplay
            userId={guardian.id}
            targetRole="GUARDIAN"
            context="USER_PROFILE"
          />
        </div>

        <aside className="space-y-6">
          <section className="bg-white rounded-2xl shadow p-6">
            <h3 className="text-lg font-bold text-gray-800 mb-3">Account Information</h3>
            <div className="space-y-3 text-sm text-gray-700">
              <div>
                <p className="text-xs text-gray-500 font-semibold uppercase">Date Joined</p>
                <p>{guardian.date_joined ? new Date(guardian.date_joined).toLocaleDateString() : '-'}</p>
              </div>
              <div>
                <p className="text-xs text-gray-500 font-semibold uppercase">Last Login</p>
                <p>{guardian.last_login ? new Date(guardian.last_login).toLocaleDateString() : 'Never'}</p>
              </div>
              <div>
                <p className="text-xs text-gray-500 font-semibold uppercase">Preferred Language</p>
                <p>{guardian.preferred_language || '-'}</p>
              </div>
              <div>
                <p className="text-xs text-gray-500 font-semibold uppercase">Account Status</p>
                <span
                  className={`px-2 py-1 rounded text-xs font-bold ${
                    guardian.is_active ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'
                  }`}
                >
                  {guardian.is_active ? 'Active' : 'Inactive'}
                </span>
              </div>
            </div>
          </section>

          <section className="bg-white rounded-2xl shadow p-6 space-y-2">
            <button
              onClick={() => router.push(`/admin/club/guardians?edit=${guardian.id}`)}
              className="w-full bg-green-600 text-white py-2 rounded-lg font-semibold hover:bg-green-700"
            >
              Edit Guardian
            </button>
            <Link
              href="/admin/club/guardians"
              className="block w-full text-center bg-gray-100 text-gray-700 py-2 rounded-lg font-semibold hover:bg-gray-200"
            >
              Back to List
            </Link>
          </section>
        </aside>
      </div>
    </div>
  );
}

export default function ClubGuardianViewPage() {
  return (
    <Suspense fallback={<div className="p-8 text-center">Loading...</div>}>
      <ClubGuardianViewContent />
    </Suspense>
  );
}


--- END OF FILE: ./frontend/app/admin/club/guardians/[id]/page.tsx ---


--- START OF FILE: ./frontend/app/admin/club/profile/page.tsx ---
'use client';

import { Suspense, useEffect, useState } from 'react';
import api from '../../../../lib/api';
import { getMediaUrl } from '../../../utils';
import Toast from '../../../components/Toast';
import { useAuth } from '../../../../context/AuthContext';

interface ProfileForm {
  first_name: string;
  last_name: string;
  email: string;
  phone_number: string;
  preferred_language: string;
  profession: string;
  nickname: string;
  hide_contact_info: boolean;
  password: string;
}

interface LoginHistoryItem {
  id: number;
  timestamp: string;
}

const formatDateTime = (value: string | null | undefined) => {
  if (!value) return 'Never';
  return new Date(value).toLocaleString(undefined, {
    year: 'numeric',
    month: 'short',
    day: 'numeric',
    hour: '2-digit',
    minute: '2-digit',
  });
};

function ClubProfileContent() {
  const { user, loading } = useAuth();
  const [profile, setProfile] = useState<ProfileForm>({
    first_name: '',
    last_name: '',
    email: '',
    phone_number: '',
    preferred_language: 'sv',
    profession: '',
    nickname: '',
    hide_contact_info: false,
    password: '',
  });
  const [avatarPreview, setAvatarPreview] = useState<string | null>(null);
  const [avatarFile, setAvatarFile] = useState<File | null>(null);
  const [lastLogin, setLastLogin] = useState<string | null>(null);
  const [loginHistory, setLoginHistory] = useState<LoginHistoryItem[]>([]);
  const [isSaving, setIsSaving] = useState(false);
  const [toast, setToast] = useState<{ message: string; type: 'success' | 'error'; isVisible: boolean }>({
    message: '',
    type: 'success',
    isVisible: false,
  });

  useEffect(() => {
    if (!user?.id) return;

    const loadProfile = async () => {
      try {
        const res = await api.get('/auth/users/me/');
        const data = res.data;
        setProfile({
          first_name: data.first_name || '',
          last_name: data.last_name || '',
          email: data.email || '',
          phone_number: data.phone_number || '',
          preferred_language: data.preferred_language || 'sv',
          profession: data.profession || '',
          nickname: data.nickname || '',
          hide_contact_info: data.hide_contact_info ?? false,
          password: '',
        });
        setAvatarPreview(data.avatar ? getMediaUrl(data.avatar) : null);
        setLastLogin(data.last_login || null);
      } catch (err) {
        console.error('Failed to load profile', err);
      }
    };

    const loadLoginHistory = async () => {
      try {
        const res = await api.get('/users/login_history/');
        setLoginHistory(res.data || []);
      } catch (err) {
        console.error('Failed to load login history', err);
      }
    };

    loadProfile();
    loadLoginHistory();
  }, [user?.id]);

  const handleChange = (field: keyof ProfileForm, value: string | boolean) => {
    setProfile((prev) => ({ ...prev, [field]: value }));
  };

  const handleAvatarChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (file) {
      setAvatarFile(file);
      const reader = new FileReader();
      reader.onloadend = () => setAvatarPreview(reader.result as string);
      reader.readAsDataURL(file);
    }
  };

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    if (!user?.id) return;

    setIsSaving(true);
    try {
      const formData = new FormData();
      Object.entries(profile).forEach(([key, value]) => {
        if (key === 'password' && !value) return;
        formData.append(key, typeof value === 'boolean' ? String(value) : value);
      });
      if (avatarFile) {
        formData.append('avatar', avatarFile);
      }
      formData.append('role', 'CLUB_ADMIN');

      await api.patch('/auth/users/me/', formData, {
        headers: { 'Content-Type': 'multipart/form-data' },
      });
      setToast({ message: 'Profile updated successfully!', type: 'success', isVisible: true });
      setProfile((prev) => ({ ...prev, password: '' }));
    } catch (err) {
      console.error('Failed to update profile', err);
      setToast({ message: 'Failed to update profile.', type: 'error', isVisible: true });
    } finally {
      setIsSaving(false);
    }
  };

  if (loading || !user) {
    return <div className="p-8 text-center text-gray-500">Loading profile...</div>;
  }

  const latestLoginTimestamp = loginHistory.length > 0 ? loginHistory[0].timestamp : lastLogin;

  return (
    <div className="space-y-8">
      <div>
        <p className="text-sm text-purple-500 uppercase font-semibold">Club Admin</p>
        <h1 className="text-3xl font-bold text-gray-900">My Profile</h1>
        <p className="text-gray-600 mt-1">Keep your profile up to date and review your recent login activity.</p>
      </div>

      <div className="grid grid-cols-1 xl:grid-cols-3 gap-6">
        <div className="xl:col-span-2 bg-white rounded-2xl shadow p-6">
          <h2 className="text-xl font-bold text-gray-800 mb-4">Profile Details</h2>
          <form onSubmit={handleSubmit} className="space-y-6">
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label className="block text-sm font-semibold text-gray-700 mb-1">First Name</label>
                <input
                  type="text"
                  className="w-full border rounded-lg p-2"
                  value={profile.first_name}
                  onChange={(e) => handleChange('first_name', e.target.value)}
                  required
                />
              </div>
              <div>
                <label className="block text-sm font-semibold text-gray-700 mb-1">Last Name</label>
                <input
                  type="text"
                  className="w-full border rounded-lg p-2"
                  value={profile.last_name}
                  onChange={(e) => handleChange('last_name', e.target.value)}
                  required
                />
              </div>
              <div>
                <label className="block text-sm font-semibold text-gray-700 mb-1">Email</label>
                <input
                  type="email"
                  className="w-full border rounded-lg p-2"
                  value={profile.email}
                  onChange={(e) => handleChange('email', e.target.value)}
                  required
                />
              </div>
              <div>
                <label className="block text-sm font-semibold text-gray-700 mb-1">Phone Number</label>
                <input
                  type="text"
                  className="w-full border rounded-lg p-2"
                  value={profile.phone_number}
                  onChange={(e) => handleChange('phone_number', e.target.value)}
                />
              </div>
              <div>
                <label className="block text-sm font-semibold text-gray-700 mb-1">Preferred Language</label>
                <select
                  className="w-full border rounded-lg p-2"
                  value={profile.preferred_language}
                  onChange={(e) => handleChange('preferred_language', e.target.value)}
                >
                  <option value="sv">Swedish</option>
                  <option value="en">English</option>
                  <option value="fi">Finnish</option>
                </select>
              </div>
              <div>
                <label className="block text-sm font-semibold text-gray-700 mb-1">Profession / Job Title</label>
                <input
                  type="text"
                  className="w-full border rounded-lg p-2"
                  value={profile.profession}
                  onChange={(e) => handleChange('profession', e.target.value)}
                />
              </div>
              <div>
                <label className="block text-sm font-semibold text-gray-700 mb-1">Nickname</label>
                <input
                  type="text"
                  className="w-full border rounded-lg p-2"
                  value={profile.nickname}
                  onChange={(e) => handleChange('nickname', e.target.value)}
                />
              </div>
              <div>
                <label className="block text-sm font-semibold text-gray-700 mb-1">New Password</label>
                <input
                  type="password"
                  className="w-full border rounded-lg p-2"
                  placeholder="Leave blank to keep current"
                  value={profile.password}
                  onChange={(e) => handleChange('password', e.target.value)}
                />
              </div>
            </div>

            <div className="flex items-center gap-3">
              <input
                id="hide_contact"
                type="checkbox"
                className="h-4 w-4 text-purple-600"
                checked={profile.hide_contact_info}
                onChange={(e) => handleChange('hide_contact_info', e.target.checked)}
              />
              <label htmlFor="hide_contact" className="text-sm text-gray-700">
                Hide my contact info from public listings
              </label>
            </div>

            <div>
              <label className="block text-sm font-semibold text-gray-700 mb-1">Avatar</label>
              <input type="file" accept="image/*" onChange={handleAvatarChange} />
              {avatarPreview && (
                <img src={avatarPreview} alt="Avatar preview" className="w-20 h-20 rounded-full object-cover mt-3" />
              )}
            </div>

            <div className="flex justify-end gap-4 pt-4 border-t">
              <button
                type="submit"
                className="bg-purple-600 text-white px-6 py-2 rounded-lg hover:bg-purple-700 disabled:opacity-50"
                disabled={isSaving}
              >
                {isSaving ? 'Saving...' : 'Save Changes'}
              </button>
            </div>
          </form>
        </div>

        <div className="space-y-6">
          <div className="bg-white rounded-2xl shadow p-6">
            <h3 className="text-lg font-bold text-gray-800 mb-4">Account Summary</h3>
            <div className="space-y-3 text-sm text-gray-700">
              <div className="flex justify-between">
                <span className="text-gray-500">Role</span>
                <span className="font-semibold">Club Admin</span>
              </div>
              <div className="flex justify-between">
                <span className="text-gray-500">Last Login</span>
                <span className="font-semibold">{formatDateTime(latestLoginTimestamp)}</span>
              </div>
            </div>
          </div>

          <div className="bg-white rounded-2xl shadow p-6">
            <h3 className="text-lg font-bold text-gray-800 mb-4">Recent Logins</h3>
            {loginHistory.length === 0 ? (
              <p className="text-sm text-gray-500">No login history recorded yet.</p>
            ) : (
              <ul className="space-y-3 text-sm">
                {loginHistory.map((entry) => (
                  <li key={entry.id} className="border-b pb-2 last:border-b-0">
                    <span className="font-semibold text-gray-900">{formatDateTime(entry.timestamp)}</span>
                  </li>
                ))}
              </ul>
            )}
          </div>
        </div>
      </div>

      <Toast
        message={toast.message}
        type={toast.type}
        isVisible={toast.isVisible}
        onClose={() => setToast({ ...toast, isVisible: false })}
      />
    </div>
  );
}

export default function ClubProfilePage() {
  return (
    <Suspense fallback={<div className="p-8 text-center">Loading profile...</div>}>
      <ClubProfileContent />
    </Suspense>
  );
}


--- END OF FILE: ./frontend/app/admin/club/profile/page.tsx ---


--- START OF FILE: ./frontend/app/admin/club/news-feed/page.tsx ---
'use client';

import NewsFeed from '../../../components/NewsFeed';

export default function ClubAdminNewsFeed() {
  return (
    <div className="max-w-7xl mx-auto">
      <div className="mb-8">
        <h1 className="text-3xl font-bold text-gray-900">News Feed</h1>
        <p className="text-gray-500">Latest updates and featured stories.</p>
      </div>
      
      {/* We simply render the component here */}
      <NewsFeed basePath="/admin/club/news-feed" />
    </div>
  );
}


--- END OF FILE: ./frontend/app/admin/club/news-feed/page.tsx ---


--- START OF FILE: ./frontend/app/admin/club/news-feed/archive/page.tsx ---
'use client';

import Link from 'next/link';
import NewsArchive from '../../../../components/NewsArchive';

export default function ClubAdminNewsArchive() {
  return (
    <div className="max-w-7xl mx-auto">
      <div className="mb-8 flex items-center gap-4">
        <Link 
          href="/admin/club/news-feed"
          className="p-2 rounded-full bg-white shadow-sm border border-gray-200 text-gray-500 hover:text-blue-600 transition"
        >
          <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 19l-7-7m0 0l7-7m-7 7h18" />
          </svg>
        </Link>
        <div>
          <h1 className="text-3xl font-bold text-gray-900">News Archive</h1>
          <p className="text-gray-500">Browse all published articles.</p>
        </div>
      </div>
      
      {/* Pass the base path and publishedOnly flag so cards link correctly and filtering works */}
      <NewsArchive basePath="/admin/club/news-feed" publishedOnly={true} />
    </div>
  );
}


--- END OF FILE: ./frontend/app/admin/club/news-feed/archive/page.tsx ---


--- START OF FILE: ./frontend/app/admin/club/news-feed/[id]/page.tsx ---
'use client';

import { useParams } from 'next/navigation';
import NewsArticleReader from '../../../../components/NewsArticleReader';

export default function ClubAdminArticlePage() {
  const params = useParams();
  const id = params?.id as string;

  return (
    <NewsArticleReader 
      articleId={id} 
      backLink="/admin/club/news-feed" 
    />
  );
}


--- END OF FILE: ./frontend/app/admin/club/news-feed/[id]/page.tsx ---


--- START OF FILE: ./frontend/app/admin/club/custom-fields/page.tsx ---
'use client';

import CustomFieldManager from '../../../components/CustomFieldManager';

export default function ClubCustomFieldsPage() {
  return (
    <div className="max-w-7xl mx-auto">
      <div className="mb-8">
        <h1 className="text-3xl font-bold text-gray-900">Club Specific Fields</h1>
        <p className="text-gray-500">
          Create fields that only members of your club will see.
        </p>
      </div>
      
      <CustomFieldManager scope="CLUB" />
    </div>
  );
}
--- END OF FILE: ./frontend/app/admin/club/custom-fields/page.tsx ---


--- START OF FILE: ./frontend/app/admin/super/layout.tsx ---
'use client';

import { useEffect, useState } from 'react';
import Link from 'next/link';
import { usePathname } from 'next/navigation';
import { useAuth } from '../../../context/AuthContext';
import { getMediaUrl } from '../../utils';
import api from '../../../lib/api';

const getInitials = (first?: string | null, last?: string | null) => {
  const firstInitial = first?.charAt(0)?.toUpperCase() || '';
  const lastInitial = last?.charAt(0)?.toUpperCase() || '';
  return firstInitial + lastInitial || 'S';
};

export default function SuperAdminLayout({ children }: { children: React.ReactNode }) {
  const pathname = usePathname();
  const { logout, user, messageCount, refreshMessageCount } = useAuth();
  const [pendingRequestsCount, setPendingRequestsCount] = useState(0);

  useEffect(() => {
    refreshMessageCount();
    refreshPendingRequestsCount();
  }, [refreshMessageCount]);

  const refreshPendingRequestsCount = async () => {
    if (!user) {
      setPendingRequestsCount(0);
      return;
    }
    
    try {
      const res = await api.get('/group-requests/');
      const data = Array.isArray(res.data) ? res.data : (res.data.results || []);
      setPendingRequestsCount(data.length);
    } catch (err: any) {
      // Silently handle 401 (unauthorized) - user might not be logged in or token expired
      if (err?.response?.status === 401) {
        setPendingRequestsCount(0);
        return;
      }
      console.error('Failed to load pending requests count', err);
      setPendingRequestsCount(0);
    }
  };

    const navigation = [
        { name: 'Overview', href: '/admin/super' },
        { name: 'Manage Admins', href: '/admin/super/admins' },
        { name: 'Manage Youth', href: '/admin/super/youth' },
        { name: 'Manage Guardians', href: '/admin/super/guardians' },
        // --- NEW NEWS SECTION ---
        { name: 'News Management', href: '/admin/super/news' }, 
        { name: 'News Tags', href: '/admin/super/news/tags' },
        { name: 'News Feed', href: '/admin/super/news-feed' },
        { name: 'Manage Posts', href: '/admin/super/posts' },
        // ------------------------
        { name: 'Manage Interests', href: '/admin/super/interests' },
        { name: 'Manage Countries', href: '/admin/super/countries' },
        { name: 'Manage Municipalities', href: '/admin/super/municipalities' },
        { name: 'Manage Clubs', href: '/admin/super/clubs' },
        { name: 'System Messages', href: '/admin/super/messages' },
        { name: 'Manage Groups', href: '/admin/super/groups' },
        { name: 'Applications', href: '/admin/super/groups/requests', showBadge: true },
        { name: 'Manage Rewards', href: '/admin/super/rewards' },
        { name: 'Custom Fields', href: '/admin/super/custom-fields' },
      ];

  return (
    <div className="min-h-screen bg-gray-100 flex">
      {/* SIDEBAR */}
      <aside className="w-64 bg-slate-900 text-white flex flex-col flex-shrink-0">
        <div className="p-6 border-b border-slate-800 flex items-center gap-3">
          <Link href="/admin/super/profile" className="inline-block">
            {user?.avatar ? (
              <img
                src={getMediaUrl(user.avatar) || ''}
                alt="Profile avatar"
                className="w-12 h-12 rounded-full object-cover border-2 border-red-400"
              />
            ) : (
              <div className="w-12 h-12 rounded-full bg-red-500 text-white flex items-center justify-center text-lg font-semibold border-2 border-red-400">
                {getInitials(user?.first_name, user?.last_name)}
              </div>
            )}
          </Link>
          <div className="leading-tight">
            <h2 className="text-base font-semibold text-red-100">
              {user?.first_name || ''} {user?.last_name || ''}
            </h2>
            <p className="text-[11px] uppercase tracking-wide text-slate-400">
              {user?.role?.replace(/_/g, ' ') || 'Super Admin'}
            </p>
          </div>
        </div>
        
        <nav className="flex-1 p-4 space-y-2">
          {navigation.map((item) => {
            const isActive = pathname === item.href;
            return (
              <Link
                key={item.name}
                href={item.href}
                className={`flex items-center justify-between px-4 py-3 rounded-lg text-sm font-medium transition-colors ${
                  isActive 
                    ? 'bg-red-600 text-white shadow-md' 
                    : 'text-slate-300 hover:bg-slate-800 hover:text-white'
                }`}
              >
                <span>{item.name}</span>
                {(item as any).showBadge && item.href.includes('/requests') && pendingRequestsCount > 0 && (
                  <span className="ml-2 inline-flex items-center justify-center rounded-full bg-red-500 text-white text-xs font-bold min-w-[1.5rem] px-2 py-0.5">
                    {pendingRequestsCount}
                  </span>
                )}
                {(item as any).showBadge && !item.href.includes('/requests') && messageCount > 0 && (
                  <span className="ml-2 inline-flex items-center justify-center rounded-full bg-red-500 text-white text-xs font-bold min-w-[1.5rem] px-2 py-0.5">
                    {messageCount}
                  </span>
                )}
              </Link>
            );
          })}
        </nav>

        <div className="p-4 border-t border-slate-800">
          <button 
            onClick={logout}
            className="w-full py-2 px-4 bg-red-600 hover:bg-red-700 rounded text-sm font-bold transition"
          >
            Sign Out
          </button>
        </div>
      </aside>

      {/* MAIN CONTENT AREA */}
      <main className="flex-1 p-8 overflow-y-auto">
        {children}
      </main>
    </div>
  );
}
--- END OF FILE: ./frontend/app/admin/super/layout.tsx ---


--- START OF FILE: ./frontend/app/admin/super/page.tsx ---
export default function SuperAdminDashboard() {
    return (
      <div className="p-10">
        <h1 className="text-3xl font-bold text-red-600">Super Admin Dashboard</h1>
        <p>Only visible to Super Admins.</p>
      </div>
    );
  }
--- END OF FILE: ./frontend/app/admin/super/page.tsx ---


--- START OF FILE: ./frontend/app/admin/super/municipalities/page.tsx ---
'use client';

import { useState, useEffect, Suspense } from 'react';
import { useRouter, useSearchParams, usePathname } from 'next/navigation';
import Link from 'next/link';
import api from '../../../../lib/api';
import { getMediaUrl } from '../../../utils';
import Toast from '../../../components/Toast';
import DeleteConfirmationModal from '../../../components/DeleteConfirmationModal';

interface CountryOption { id: number; name: string; }

function ManageMunicipalitiesPageContent() {
  const router = useRouter();
  const pathname = usePathname();
  const searchParams = useSearchParams();

  // --- STATE ---
  const [municipalities, setMunicipalities] = useState<any[]>([]);
  const [totalCount, setTotalCount] = useState(0);
  const [countries, setCountries] = useState<CountryOption[]>([]);
  const [isLoading, setIsLoading] = useState(true);
  
  // Toast State
  const [toast, setToast] = useState<{ message: string; type: 'success' | 'error' | 'info' | 'warning'; isVisible: boolean }>({
    message: '',
    type: 'success',
    isVisible: false,
  });

  // Modal
  const [showModal, setShowModal] = useState(false);
  const [isEditing, setIsEditing] = useState(false);
  const [editId, setEditId] = useState<number | null>(null);
  
  // Files
  const [avatarFile, setAvatarFile] = useState<File | null>(null);
  const [avatarPreview, setAvatarPreview] = useState<string | null>(null);
  const [heroFile, setHeroFile] = useState<File | null>(null);
  const [heroPreview, setHeroPreview] = useState<string | null>(null);
  
  // Delete Confirmation Modal State
  const [showDeleteModal, setShowDeleteModal] = useState(false);
  const [municipalityToDelete, setMunicipalityToDelete] = useState<{ id: number; name: string } | null>(null);
  const [isDeleting, setIsDeleting] = useState(false);

  const initialFormState = {
    country: '',
    name: '',
    municipality_code: '',
    description: '',
    terms_and_conditions: '',
    email: '',
    phone: '',
    website_link: '',
    allow_self_registration: true,
    // Social Media inputs (we will pack these into JSON later)
    facebook: '',
    instagram: ''
  };

  const [formData, setFormData] = useState(initialFormState);

  // --- LOAD DATA ---
  useEffect(() => {
    fetchCountries();
  }, []);

  useEffect(() => {
    fetchMunicipalities();
  }, [searchParams]);

  const fetchCountries = async () => {
    try {
      const countryRes = await api.get('/countries/');
      const countryData = Array.isArray(countryRes.data) ? countryRes.data : (countryRes.data.results || []);
      setCountries(countryData);
    } catch (err) {
      console.error(err);
    }
  };

  const fetchMunicipalities = async () => {
    setIsLoading(true);
    try {
      const params = new URLSearchParams();
      const page = searchParams.get('page');
      if (page) params.set('page', page);
      
      // Add filters
      const country = searchParams.get('country');
      if (country) params.set('country', country);
      
      const search = searchParams.get('search');
      if (search) params.set('search', search);
      
      const muniRes = await api.get(`/municipalities/?${params.toString()}`);
      
      // Handle both paginated and non-paginated responses
      if (Array.isArray(muniRes.data)) {
        // Non-paginated response (array)
        setMunicipalities(muniRes.data);
        setTotalCount(muniRes.data.length);
      } else {
        // Paginated response (object with results and count)
        setMunicipalities(muniRes.data.results || []);
        setTotalCount(muniRes.data.count || (muniRes.data.results?.length || 0));
      }
    } catch (err) {
      console.error(err);
    } finally {
      setIsLoading(false);
    }
  };

  const updateUrl = (key: string, value: string) => {
    const params = new URLSearchParams(searchParams.toString());
    if (value) params.set(key, value); else params.delete(key);
    if (key !== 'page') params.set('page', '1');
    router.push(`${pathname}?${params.toString()}`);
  };

  // --- ACTIONS ---
  const handleOpenCreate = () => {
    setIsEditing(false);
    setEditId(null);
    setFormData(initialFormState);
    setAvatarFile(null); setAvatarPreview(null);
    setHeroFile(null); setHeroPreview(null);
    setShowModal(true);
  };

  const handleOpenEdit = (item: any) => {
    setIsEditing(true);
    setEditId(item.id);
    
    // Parse social media JSON safely
    let social = { facebook: '', instagram: '' };
    try {
      if (item.social_media) {
        if (typeof item.social_media === 'string') {
          social = { ...social, ...JSON.parse(item.social_media) };
        } else if (typeof item.social_media === 'object') {
          social = { ...social, ...item.social_media };
        }
      }
    } catch (e) {}

    setFormData({
      country: String(item.country?.id ?? item.country ?? ''),
      name: item.name,
      municipality_code: item.municipality_code || '',
      description: item.description || '',
      terms_and_conditions: item.terms_and_conditions || '',
      email: item.email || '',
      phone: item.phone || '',
      website_link: item.website_link || '',
      allow_self_registration: item.allow_self_registration ?? true,
      facebook: social.facebook || '',
      instagram: social.instagram || ''
    });

    setAvatarFile(null);
    setAvatarPreview(item.avatar ? getMediaUrl(item.avatar) : null);
    
    setHeroFile(null);
    setHeroPreview(item.hero_image ? getMediaUrl(item.hero_image) : null);
    
    setShowModal(true);
  };

  const handleDeleteClick = (muni: any) => {
    setMunicipalityToDelete({ id: muni.id, name: muni.name });
    setShowDeleteModal(true);
  };

  const handleDeleteConfirm = async () => {
    if (!municipalityToDelete) return;

    setIsDeleting(true);
    try {
      await api.delete(`/municipalities/${municipalityToDelete.id}/`);
      setToast({
        message: 'Municipality deleted successfully!',
        type: 'success',
        isVisible: true,
      });
      setShowDeleteModal(false);
      setMunicipalityToDelete(null);
      fetchMunicipalities();
    } catch (err) {
      setToast({
        message: 'Failed to delete municipality.',
        type: 'error',
        isVisible: true,
      });
    } finally {
      setIsDeleting(false);
    }
  };

  const handleFileChange = (e: React.ChangeEvent<HTMLInputElement>, type: 'avatar' | 'hero') => {
    const file = e.target.files?.[0];
    if (file) {
      const reader = new FileReader();
      reader.onloadend = () => {
        if (type === 'avatar') {
          setAvatarFile(file);
          setAvatarPreview(reader.result as string);
        } else {
          setHeroFile(file);
          setHeroPreview(reader.result as string);
        }
      };
      reader.readAsDataURL(file);
    }
  };

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    try {
      const data = new FormData();
      
      // Pack social media into JSON string
      const socialMediaJson = JSON.stringify({
        facebook: formData.facebook,
        instagram: formData.instagram
      });

      data.append('country', formData.country);
      data.append('name', formData.name);
      data.append('municipality_code', formData.municipality_code);
      data.append('description', formData.description);
      data.append('terms_and_conditions', formData.terms_and_conditions);
      data.append('email', formData.email);
      data.append('phone', formData.phone);
      data.append('website_link', formData.website_link);
      data.append('allow_self_registration', formData.allow_self_registration.toString());
      data.append('social_media', socialMediaJson);
      
      if (avatarFile) data.append('avatar', avatarFile);
      if (heroFile) data.append('hero_image', heroFile);

      const config = { headers: { 'Content-Type': 'multipart/form-data' } };
      
      if (isEditing && editId) {
        await api.patch(`/municipalities/${editId}/`, data, config);
        setToast({
          message: 'Municipality updated successfully!',
          type: 'success',
          isVisible: true,
        });
      } else {
        await api.post('/municipalities/', data, config);
        setToast({
          message: 'Municipality created successfully!',
          type: 'success',
          isVisible: true,
        });
      }

      setShowModal(false);
      fetchMunicipalities();
    } catch (err) {
      setToast({
        message: 'Operation failed. Please try again.',
        type: 'error',
        isVisible: true,
      });
      console.error(err);
    }
  };

  const currentPage = Number(searchParams.get('page')) || 1;
  const totalPages = totalCount > 0 ? Math.ceil(totalCount / 10) : 1;

  return (
    <div>
      <div className="flex justify-between items-center mb-6">
        <h1 className="text-2xl font-bold text-gray-800">Manage Municipalities</h1>
        <button onClick={handleOpenCreate} className="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 shadow">
          + Add Municipality
        </button>
      </div>

      {/* --- FILTER BAR --- */}
      <div className="bg-white p-4 rounded-lg shadow mb-6 border border-gray-100">
        <div className="flex flex-wrap gap-4 items-end">
          <div className="flex-1 min-w-[200px]">
            <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Search</label>
            <input
              type="text"
              placeholder="Search by name, code, email, or description..."
              className="w-full border rounded p-2 text-sm bg-gray-50"
              value={searchParams.get('search') || ''}
              onChange={(e) => {
                const value = e.target.value;
                if (value.trim()) {
                  updateUrl('search', value.trim());
                } else {
                  const params = new URLSearchParams(searchParams.toString());
                  params.delete('search');
                  params.set('page', '1');
                  router.push(`${pathname}?${params.toString()}`);
                }
              }}
            />
          </div>

          <div className="w-48">
            <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Country</label>
            <select
              className="w-full border rounded p-2 text-sm bg-gray-50"
              value={searchParams.get('country') || ''}
              onChange={(e) => updateUrl('country', e.target.value)}
            >
              <option value="">All Countries</option>
              {Array.isArray(countries) && countries.map(c => (
                <option key={c.id} value={c.id.toString()}>{c.name}</option>
              ))}
            </select>
          </div>

          <button
            onClick={() => router.push(pathname)}
            className="px-4 py-2 text-sm text-gray-500 hover:text-red-500 font-medium pb-2.5"
          >
            Clear Filters
          </button>
        </div>
      </div>

      {/* --- LIST --- */}
      <div className="bg-white rounded-lg shadow overflow-hidden mb-6">
        {isLoading ? (
          <div className="p-8 text-center text-gray-500">Loading...</div>
        ) : municipalities.length === 0 ? (
          <div className="p-8 text-center text-gray-500">No municipalities found.</div>
        ) : (
          <table className="min-w-full divide-y divide-gray-200">
            <thead className="bg-gray-50">
              <tr>
                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Municipality</th>
                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Country</th>
                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Code</th>
                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Registration</th>
                <th className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">Actions</th>
              </tr>
            </thead>
            <tbody className="bg-white divide-y divide-gray-200">
              {municipalities.map((muni) => {
                // Find country name for display
                const countryName = countries.find(c => c.id === muni.country)?.name || muni.country;
                
                return (
                  <tr key={muni.id}>
                    <td className="px-6 py-4 whitespace-nowrap">
                      <div className="flex items-center">
                        {muni.avatar ? (
                          <img 
                            src={getMediaUrl(muni.avatar) || ''}
                            alt={muni.name}
                            className="w-10 h-10 rounded-full object-cover mr-3 border"
                            onError={(e) => { (e.target as HTMLImageElement).style.display = 'none'; }}
                          />
                        ) : (
                          <div className="w-10 h-10 rounded-full bg-gray-100 mr-3 flex items-center justify-center text-gray-400 text-xs font-bold">
                            M
                          </div>
                        )}
                        <div className="text-sm font-bold text-gray-900">{muni.name}</div>
                      </div>
                    </td>
                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
                      {countryName}
                    </td>
                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
                      {muni.municipality_code || '-'}
                    </td>
                    <td className="px-6 py-4 whitespace-nowrap text-sm">
                      <span className={`px-2 py-1 text-xs rounded-full ${muni.allow_self_registration ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`}>
                        {muni.allow_self_registration ? 'Allowed' : 'Restricted'}
                      </span>
                    </td>
                    <td className="px-6 py-4 whitespace-nowrap text-right text-sm font-medium space-x-4">
                      <Link href={`/admin/super/municipalities/${muni.id}`} className="text-blue-600 hover:text-blue-900 font-bold">View</Link>
                      <button onClick={() => handleOpenEdit(muni)} className="text-indigo-600 hover:text-indigo-900 font-bold">Edit</button>
                      <button onClick={() => handleDeleteClick(muni)} className="text-red-600 hover:text-red-900">Delete</button>
                    </td>
                  </tr>
                );
              })}
            </tbody>
          </table>
        )}
      </div>

      {/* --- PAGINATION CONTROLS --- */}
      {totalCount > 0 && (
        <div className="flex items-center justify-between border-t border-gray-200 bg-white px-4 py-3 sm:px-6 rounded-lg shadow">
          <div className="flex flex-1 justify-between sm:hidden">
            <button 
              disabled={currentPage === 1}
              onClick={() => updateUrl('page', (currentPage - 1).toString())}
              className="relative inline-flex items-center rounded-md border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50 disabled:opacity-50"
            >
              Previous
            </button>
            <button 
              disabled={currentPage >= totalPages}
              onClick={() => updateUrl('page', (currentPage + 1).toString())}
              className="relative ml-3 inline-flex items-center rounded-md border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50 disabled:opacity-50"
            >
              Next
            </button>
          </div>
          <div className="hidden sm:flex sm:flex-1 sm:items-center sm:justify-between">
            <div>
              <p className="text-sm text-gray-700">
                Showing page <span className="font-medium">{currentPage}</span> of <span className="font-medium">{totalPages}</span>
                {' '}(Total: {totalCount})
              </p>
            </div>
            <div>
              <nav className="isolate inline-flex -space-x-px rounded-md shadow-sm" aria-label="Pagination">
                <button
                  disabled={currentPage === 1}
                  onClick={() => updateUrl('page', (currentPage - 1).toString())}
                  className="relative inline-flex items-center rounded-l-md px-2 py-2 text-gray-400 ring-1 ring-inset ring-gray-300 hover:bg-gray-50 focus:z-20 focus:outline-offset-0 disabled:opacity-50"
                >
                  <span className="sr-only">Previous</span>
                  ‚Üê Prev
                </button>
                
                {/* Simple Pagination Numbers */}
                {[...Array(totalPages)].map((_, i) => {
                  const p = i + 1;
                  return (
                    <button
                      key={p}
                      onClick={() => updateUrl('page', p.toString())}
                      className={`relative inline-flex items-center px-4 py-2 text-sm font-semibold 
                        ${p === currentPage 
                          ? 'bg-blue-600 text-white focus:z-20 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-blue-600' 
                          : 'text-gray-900 ring-1 ring-inset ring-gray-300 hover:bg-gray-50 focus:z-20 focus:outline-offset-0'}`}
                    >
                      {p}
                    </button>
                  );
                })}

                <button
                  disabled={currentPage >= totalPages}
                  onClick={() => updateUrl('page', (currentPage + 1).toString())}
                  className="relative inline-flex items-center rounded-r-md px-2 py-2 text-gray-400 ring-1 ring-inset ring-gray-300 hover:bg-gray-50 focus:z-20 focus:outline-offset-0 disabled:opacity-50"
                >
                  <span className="sr-only">Next</span>
                  Next ‚Üí
                </button>
              </nav>
            </div>
          </div>
        </div>
      )}

      {/* --- MODAL --- */}
      {showModal && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-xl shadow-2xl w-full max-w-2xl p-8 max-h-[90vh] overflow-y-auto">
            <h2 className="text-2xl font-bold mb-6 text-gray-800">{isEditing ? 'Edit Municipality' : 'New Municipality'}</h2>
            <form onSubmit={handleSubmit} className="space-y-6">
              
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label className="block text-sm font-bold mb-1 text-gray-700">Name</label>
                  <input required type="text" className="w-full border p-2 rounded" 
                    value={formData.name} onChange={e => setFormData({...formData, name: e.target.value})} />
                </div>
                
                <div>
                  <label className="block text-sm font-bold mb-1 text-gray-700">Country</label>
                  <select required className="w-full border p-2 rounded" 
                    value={formData.country} onChange={e => setFormData({...formData, country: e.target.value})}>
                    <option value="">Select Country...</option>
                    {countries.map(c => <option key={c.id} value={c.id}>{c.name}</option>)}
                  </select>
                </div>
              </div>

              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label className="block text-sm font-bold mb-1 text-gray-700">Municipality Code</label>
                  <input type="text" className="w-full border p-2 rounded" 
                    value={formData.municipality_code} onChange={e => setFormData({...formData, municipality_code: e.target.value})} />
                </div>
                
                <div className="flex items-center pt-6">
                  <label className="flex items-center space-x-2 cursor-pointer">
                    <input type="checkbox" checked={formData.allow_self_registration}
                      onChange={e => setFormData({...formData, allow_self_registration: e.target.checked})}
                      className="text-blue-600 h-5 w-5" />
                    <span className="text-sm font-bold text-gray-700">Allow Self Registration</span>
                  </label>
                </div>
              </div>

              {/* IMAGES */}
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4 bg-gray-50 p-4 rounded">
                <div>
                  <label className="block text-xs font-bold mb-1 uppercase text-gray-500">Avatar</label>
                  <input type="file" accept="image/*" className="w-full border p-1 rounded text-sm" onChange={e => handleFileChange(e, 'avatar')} />
                  {avatarPreview && <img src={avatarPreview} className="h-16 mt-2 object-contain" alt="Avatar Preview" />}
                </div>
                <div>
                  <label className="block text-xs font-bold mb-1 uppercase text-gray-500">Hero Image</label>
                  <input type="file" accept="image/*" className="w-full border p-1 rounded text-sm" onChange={e => handleFileChange(e, 'hero')} />
                  {heroPreview && <img src={heroPreview} className="h-16 mt-2 object-cover w-full rounded" alt="Hero Preview" />}
                </div>
              </div>

              {/* CONTACT */}
              <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                <input type="email" placeholder="Email" className="border p-2 rounded" 
                  value={formData.email} onChange={e => setFormData({...formData, email: e.target.value})} />
                <input type="text" placeholder="Phone" className="border p-2 rounded" 
                  value={formData.phone} onChange={e => setFormData({...formData, phone: e.target.value})} />
                <input type="url" placeholder="Website URL" className="border p-2 rounded" 
                  value={formData.website_link} onChange={e => setFormData({...formData, website_link: e.target.value})} />
              </div>

              {/* SOCIAL MEDIA */}
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <input type="text" placeholder="Facebook URL" className="border p-2 rounded" 
                  value={formData.facebook} onChange={e => setFormData({...formData, facebook: e.target.value})} />
                <input type="text" placeholder="Instagram URL" className="border p-2 rounded" 
                  value={formData.instagram} onChange={e => setFormData({...formData, instagram: e.target.value})} />
              </div>

              <div>
                <label className="block text-sm font-bold mb-1 text-gray-700">Description</label>
                <textarea rows={2} required className="w-full border p-2 rounded" 
                  value={formData.description} onChange={e => setFormData({...formData, description: e.target.value})} />
              </div>

              <div>
                <label className="block text-sm font-bold mb-1 text-gray-700">Terms & Conditions</label>
                <textarea rows={3} required className="w-full border p-2 rounded" 
                  value={formData.terms_and_conditions} onChange={e => setFormData({...formData, terms_and_conditions: e.target.value})} />
              </div>

              <div className="flex justify-end gap-4 pt-4 border-t">
                <button type="button" onClick={() => setShowModal(false)} className="text-gray-500 hover:text-gray-700">Cancel</button>
                <button type="submit" className="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700 transition">
                  {isEditing ? 'Save Changes' : 'Create'}
                </button>
              </div>
            </form>
          </div>
        </div>
      )}

      {/* Delete Confirmation Modal */}
      <DeleteConfirmationModal
        isVisible={showDeleteModal}
        onClose={() => {
          if (!isDeleting) {
            setShowDeleteModal(false);
            setMunicipalityToDelete(null);
          }
        }}
        onConfirm={handleDeleteConfirm}
        itemName={municipalityToDelete?.name}
        message={municipalityToDelete ? `Are you sure you want to delete "${municipalityToDelete.name}"? This will delete all clubs linked to this municipality. This action cannot be undone.` : undefined}
        isLoading={isDeleting}
      />

      {/* Toast Notification */}
      <Toast
        message={toast.message}
        type={toast.type}
        isVisible={toast.isVisible}
        onClose={() => setToast({ ...toast, isVisible: false })}
      />
    </div>
  );
}

export default function ManageMunicipalitiesPage() {
  return (
    <Suspense fallback={<div>Loading...</div>}>
      <ManageMunicipalitiesPageContent />
    </Suspense>
  );
}
--- END OF FILE: ./frontend/app/admin/super/municipalities/page.tsx ---


--- START OF FILE: ./frontend/app/admin/super/municipalities/[id]/page.tsx ---
'use client';

import { useState, useEffect, Suspense } from 'react';
import { useRouter, useParams } from 'next/navigation';
import Link from 'next/link';
import api from '../../../../../lib/api';
import { getMediaUrl } from '../../../../utils';

function MunicipalityViewPageContent() {
  const router = useRouter();
  const params = useParams();
  const municipalityId = params?.id as string;

  const [municipality, setMunicipality] = useState<any>(null);
  const [isLoading, setIsLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);

  useEffect(() => {
    if (municipalityId) {
      fetchMunicipality();
    }
  }, [municipalityId]);

  const fetchMunicipality = async () => {
    setIsLoading(true);
    setError(null);
    try {
      const res = await api.get(`/municipalities/${municipalityId}/`);
      setMunicipality(res.data);
    } catch (err: any) {
      setError(err?.response?.status === 404 ? 'Municipality not found' : 'Failed to load municipality');
      console.error(err);
    } finally {
      setIsLoading(false);
    }
  };

  if (isLoading) {
    return (
      <div className="p-8 text-center">
        <p className="text-gray-500">Loading municipality details...</p>
      </div>
    );
  }

  if (error || !municipality) {
    return (
      <div className="p-8">
        <div className="bg-red-50 border border-red-200 rounded-lg p-4 mb-4">
          <p className="text-red-800">{error || 'Municipality not found'}</p>
        </div>
        <Link href="/admin/super/municipalities" className="text-blue-600 hover:text-blue-800">
          ‚Üê Back to Municipalities
        </Link>
      </div>
    );
  }

  // Parse social media safely
  let socialMedia = { facebook: '', instagram: '' };
  try {
    if (municipality.social_media) {
      if (typeof municipality.social_media === 'string') {
        socialMedia = { ...socialMedia, ...JSON.parse(municipality.social_media) };
      } else if (typeof municipality.social_media === 'object') {
        socialMedia = { ...socialMedia, ...municipality.social_media };
      }
    }
  } catch (e) {
    console.error('Failed to parse social media:', e);
  }

  return (
    <div className="p-8">
      {/* HEADER */}
      <div className="flex items-center justify-between mb-6">
        <Link href="/admin/super/municipalities" className="text-blue-600 hover:text-blue-800 font-medium">
          ‚Üê Back to Municipalities
        </Link>
        <div className="flex gap-4">
          <button
            onClick={() => router.push(`/admin/super/municipalities?edit=${municipality.id}`)}
            className="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700"
          >
            Edit Municipality
          </button>
        </div>
      </div>

      {/* MUNICIPALITY HEADER */}
      <div className="bg-white rounded-xl shadow-lg overflow-hidden mb-6">
        <div className="relative">
          {municipality.hero_image && (
            <img
              src={getMediaUrl(municipality.hero_image) || ''}
              alt={municipality.name}
              className="w-full h-64 object-cover"
              onError={(e) => (e.target as HTMLImageElement).style.display = 'none'}
            />
          )}
          <div className={`p-8 ${municipality.hero_image ? 'absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/70 to-transparent' : ''}`}>
            <div className="flex items-end gap-6">
              {municipality.avatar && (
                <img
                  src={getMediaUrl(municipality.avatar) || ''}
                  alt={municipality.name}
                  className={`w-24 h-24 rounded-full object-cover border-4 ${municipality.hero_image ? 'border-white' : 'border-gray-200'}`}
                  onError={(e) => (e.target as HTMLImageElement).style.display = 'none'}
                />
              )}
              <div className={municipality.hero_image ? 'text-white' : ''}>
                <h1 className="text-4xl font-bold mb-2">{municipality.name}</h1>
                <p className="text-lg opacity-90">
                  {municipality.country_name || 'Unknown Country'}
                  {municipality.country_code && ` (${municipality.country_code})`}
                </p>
                {municipality.municipality_code && (
                  <p className="text-sm opacity-80 mt-2">Code: {municipality.municipality_code}</p>
                )}
              </div>
            </div>
          </div>
        </div>
      </div>

      <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
        {/* MAIN CONTENT */}
        <div className="lg:col-span-2 space-y-6">
          {/* DESCRIPTION */}
          <div className="bg-white rounded-xl shadow p-6">
            <h2 className="text-2xl font-bold text-gray-800 mb-4">About</h2>
            <p className="text-gray-700 whitespace-pre-wrap">{municipality.description || 'No description provided.'}</p>
          </div>

          {/* CONTACT INFO */}
          <div className="bg-white rounded-xl shadow p-6">
            <h2 className="text-2xl font-bold text-gray-800 mb-4">Contact Information</h2>
            <div className="grid grid-cols-2 gap-4">
              {municipality.email && (
                <div>
                  <p className="text-sm text-gray-500 font-bold uppercase">Email</p>
                  <p className="font-medium">{municipality.email}</p>
                </div>
              )}
              {municipality.phone && (
                <div>
                  <p className="text-sm text-gray-500 font-bold uppercase">Phone</p>
                  <p className="font-medium">{municipality.phone}</p>
                </div>
              )}
              {municipality.website_link && (
                <div className="col-span-2">
                  <p className="text-sm text-gray-500 font-bold uppercase">Website</p>
                  <a
                    href={municipality.website_link}
                    target="_blank"
                    rel="noopener noreferrer"
                    className="text-blue-600 hover:text-blue-800 underline font-medium"
                  >
                    {municipality.website_link}
                  </a>
                </div>
              )}
            </div>
          </div>

          {/* SOCIAL MEDIA */}
          {(socialMedia.facebook || socialMedia.instagram) && (
            <div className="bg-white rounded-xl shadow p-6">
              <h2 className="text-2xl font-bold text-gray-800 mb-4">Social Media</h2>
              <div className="flex gap-4">
                {socialMedia.facebook && (
                  <a
                    href={socialMedia.facebook}
                    target="_blank"
                    rel="noopener noreferrer"
                    className="text-blue-600 hover:text-blue-800 underline"
                  >
                    Facebook ‚Üí
                  </a>
                )}
                {socialMedia.instagram && (
                  <a
                    href={socialMedia.instagram}
                    target="_blank"
                    rel="noopener noreferrer"
                    className="text-pink-600 hover:text-pink-800 underline"
                  >
                    Instagram ‚Üí
                  </a>
                )}
              </div>
            </div>
          )}

          {/* TERMS & CONDITIONS */}
          {municipality.terms_and_conditions && (
            <div className="bg-white rounded-xl shadow p-6">
              <h2 className="text-2xl font-bold text-gray-800 mb-4">Terms & Conditions</h2>
              <p className="text-sm text-gray-600 whitespace-pre-wrap">{municipality.terms_and_conditions}</p>
            </div>
          )}
        </div>

        {/* SIDEBAR */}
        <div className="space-y-6">
          {/* QUICK INFO */}
          <div className="bg-white rounded-xl shadow p-6">
            <h3 className="text-lg font-bold text-gray-800 mb-4">Quick Info</h3>
            <div className="space-y-3">
              <div>
                <p className="text-xs text-gray-500 font-bold uppercase">Country</p>
                <p className="text-sm font-medium">
                  {municipality.country_name || 'Unknown'}
                  {municipality.country_code && ` (${municipality.country_code})`}
                </p>
              </div>
              {municipality.municipality_code && (
                <div>
                  <p className="text-xs text-gray-500 font-bold uppercase">Municipality Code</p>
                  <p className="text-sm font-medium">{municipality.municipality_code}</p>
                </div>
              )}
              <div>
                <p className="text-xs text-gray-500 font-bold uppercase">Self Registration</p>
                <span className={`inline-block px-2 py-1 text-xs rounded-full ${
                  municipality.allow_self_registration 
                    ? 'bg-green-100 text-green-800' 
                    : 'bg-red-100 text-red-800'
                }`}>
                  {municipality.allow_self_registration ? 'Allowed' : 'Restricted'}
                </span>
              </div>
            </div>
          </div>

          {/* ACTIONS */}
          <div className="bg-white rounded-xl shadow p-6">
            <h3 className="text-lg font-bold text-gray-800 mb-4">Actions</h3>
            <div className="space-y-2">
              <button
                onClick={() => router.push(`/admin/super/municipalities?edit=${municipality.id}`)}
                className="w-full bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 text-center"
              >
                Edit Municipality
              </button>
              <Link
                href="/admin/super/municipalities"
                className="block w-full bg-gray-100 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-200 text-center"
              >
                Back to List
              </Link>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
}

export default function MunicipalityViewPage() {
  return (
    <Suspense fallback={<div className="p-8 text-center">Loading...</div>}>
      <MunicipalityViewPageContent />
    </Suspense>
  );
}


--- END OF FILE: ./frontend/app/admin/super/municipalities/[id]/page.tsx ---


--- START OF FILE: ./frontend/app/admin/super/messages/page.tsx ---
'use client';

import { useState, useEffect } from 'react';
import api from '../../../../lib/api';
import Toast from '../../../components/Toast';
import DeleteConfirmationModal from '../../../components/DeleteConfirmationModal';

const ROLES = [
  { id: 'SUPER_ADMIN', label: 'Super Admin' },
  { id: 'MUNICIPALITY_ADMIN', label: 'Municipality Admin' },
  { id: 'CLUB_ADMIN', label: 'Club Admin' },
  { id: 'YOUTH_MEMBER', label: 'Youth Member' },
  { id: 'GUARDIAN', label: 'Guardian' },
];

export default function ManageMessagesPage() {
  const [messages, setMessages] = useState<any[]>([]);
  const [showModal, setShowModal] = useState(false);
  
  // Toast State
  const [toast, setToast] = useState<{ message: string; type: 'success' | 'error' | 'info' | 'warning'; isVisible: boolean }>({
    message: '',
    type: 'success',
    isVisible: false,
  });
  
  // Delete Confirmation Modal State
  const [showDeleteModal, setShowDeleteModal] = useState(false);
  const [messageToDelete, setMessageToDelete] = useState<{ id: number; title: string } | null>(null);
  const [isDeleting, setIsDeleting] = useState(false);
  
  const [formData, setFormData] = useState({
    title: '',
    message: '',
    message_type: 'INFO',
    target_all: true,
    selected_roles: [] as string[],
    days_active: 7,
    is_sticky: false,
    external_link: ''
  });

  useEffect(() => {
    fetchMessages();
  }, []);

  const fetchMessages = async () => {
    try {
      const res = await api.get('/messages/');
      setMessages(res.data.results || res.data);
    } catch (err: any) {
      console.error('Error fetching messages:', err);
      const errorMessage = err?.response?.data?.detail || err?.response?.data?.message || err?.message || 'Failed to load messages';
      alert(`Error: ${errorMessage}`);
    }
  };

  const toggleRole = (role: string) => {
    setFormData(prev => {
      const list = prev.selected_roles.includes(role)
        ? prev.selected_roles.filter(r => r !== role)
        : [...prev.selected_roles, role];
      return { ...prev, selected_roles: list };
    });
  };

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    
    const expires = new Date();
    expires.setDate(expires.getDate() + parseInt(formData.days_active.toString()));

    const payload = {
      title: formData.title,
      message: formData.message,
      message_type: formData.message_type,
      target_roles: formData.target_all ? ['ALL'] : formData.selected_roles,
      is_sticky: formData.is_sticky,
      external_link: formData.external_link || null,
      expires_at: expires.toISOString()
    };

    try {
      await api.post('/messages/', payload);
      setToast({
        message: 'System message created successfully!',
        type: 'success',
        isVisible: true,
      });
      setShowModal(false);
      fetchMessages();
      setFormData({ ...formData, title: '', message: '', external_link: '' });
    } catch (err) {
      setToast({
        message: 'Failed to create system message.',
        type: 'error',
        isVisible: true,
      });
    }
  };

  const handleDeleteClick = (msg: any) => {
    setMessageToDelete({ id: msg.id, title: msg.title });
    setShowDeleteModal(true);
  };

  const handleDeleteConfirm = async () => {
    if (!messageToDelete) return;

    setIsDeleting(true);
    try {
      await api.delete(`/messages/${messageToDelete.id}/`);
      setToast({
        message: 'System message deleted successfully!',
        type: 'success',
        isVisible: true,
      });
      setShowDeleteModal(false);
      setMessageToDelete(null);
      fetchMessages();
    } catch (err) {
      setToast({
        message: 'Failed to delete system message.',
        type: 'error',
        isVisible: true,
      });
    } finally {
      setIsDeleting(false);
    }
  };

  return (
    <div className="p-8">
      <div className="flex justify-between items-center mb-6">
        <h1 className="text-2xl font-bold text-gray-800">System Messages</h1>
        <button onClick={() => setShowModal(true)} className="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
          + New Message
        </button>
      </div>

      <div className="bg-white rounded-lg shadow overflow-hidden">
        <table className="min-w-full divide-y divide-gray-200">
          <thead className="bg-gray-50">
            <tr>
              <th className="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase">Type</th>
              <th className="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase">Content</th>
              <th className="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase">Audience</th>
              <th className="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase">Settings</th>
              <th className="px-6 py-3 text-right">Action</th>
            </tr>
          </thead>
          <tbody className="divide-y divide-gray-200">
            {messages.map(msg => (
              <tr key={msg.id}>
                <td className="px-6 py-4">
                  <span className={`px-2 py-1 rounded text-xs font-bold text-white
                    ${msg.message_type === 'INFO' ? 'bg-blue-500' : 
                      msg.message_type === 'IMPORTANT' ? 'bg-orange-500' : 'bg-red-600'}`}>
                    {msg.message_type}
                  </span>
                </td>
                <td className="px-6 py-4">
                  <div className="font-bold">{msg.title}</div>
                  <div className="text-sm text-gray-600">{msg.message}</div>
                  {msg.external_link && <a href={msg.external_link} target="_blank" className="text-xs text-blue-500 underline">Link</a>}
                </td>
                <td className="px-6 py-4 text-sm">
                  {msg.target_roles.includes("ALL") ? "Everyone" : msg.target_roles.join(", ")}
                </td>
                <td className="px-6 py-4 text-sm">
                  {msg.is_sticky && <span className="bg-purple-100 text-purple-800 text-xs px-2 py-1 rounded mr-2">Sticky</span>}
                  <span className="text-gray-500">Expires: {new Date(msg.expires_at).toLocaleDateString()}</span>
                </td>
                <td className="px-6 py-4 text-right">
                   <button onClick={() => handleDeleteClick(msg)} className="text-red-600 font-bold text-sm">Delete</button>
                </td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>

      {showModal && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
          <div className="bg-white rounded-lg p-8 max-w-lg w-full max-h-[90vh] overflow-y-auto">
            <h2 className="text-xl font-bold mb-4">Create System Message</h2>
            <form onSubmit={handleSubmit} className="space-y-4">
              
              <div className="grid grid-cols-2 gap-4">
                <div>
                  <label className="block text-sm font-bold mb-1">Type</label>
                  <select className="w-full border p-2 rounded" 
                    value={formData.message_type} onChange={e => setFormData({...formData, message_type: e.target.value})}>
                    <option value="INFO">Information</option>
                    <option value="IMPORTANT">Important</option>
                    <option value="WARNING">Warning</option>
                  </select>
                </div>
                <div>
                  <label className="block text-sm font-bold mb-1">Duration (Days)</label>
                  <input type="number" min="1" max="365" className="w-full border p-2 rounded" 
                    value={formData.days_active} onChange={e => setFormData({...formData, days_active: parseInt(e.target.value)})} />
                </div>
              </div>

              <div>
                <label className="block text-sm font-bold mb-1">Title</label>
                <input type="text" required className="w-full border p-2 rounded" 
                  value={formData.title} onChange={e => setFormData({...formData, title: e.target.value})} />
              </div>

              <div>
                <label className="block text-sm font-bold mb-1">Message Body</label>
                <textarea required rows={3} className="w-full border p-2 rounded" 
                  value={formData.message} onChange={e => setFormData({...formData, message: e.target.value})} />
              </div>

              <div>
                <label className="block text-sm font-bold mb-1">External Link (Optional)</label>
                <input type="url" placeholder="https://..." className="w-full border p-2 rounded" 
                  value={formData.external_link} onChange={e => setFormData({...formData, external_link: e.target.value})} />
              </div>

              <div className="flex items-center gap-2 bg-gray-50 p-3 rounded border">
                <input type="checkbox" id="sticky" checked={formData.is_sticky} 
                  onChange={e => setFormData({...formData, is_sticky: e.target.checked})} />
                <label htmlFor="sticky" className="text-sm font-bold text-gray-700 cursor-pointer">
                  Make Sticky (Re-appears on refresh)
                </label>
              </div>

              <div>
                <label className="block text-sm font-bold mb-1">Target Audience</label>
                <div className="flex items-center mb-2">
                  <input type="checkbox" checked={formData.target_all} 
                    onChange={e => setFormData({...formData, target_all: e.target.checked})} 
                    className="mr-2" />
                  <span>All Roles</span>
                </div>
                
                {!formData.target_all && (
                  <div className="grid grid-cols-2 gap-2 bg-gray-50 p-2 rounded border">
                    {ROLES.map(role => (
                      <label key={role.id} className="flex items-center text-sm">
                        <input type="checkbox" className="mr-2"
                          checked={formData.selected_roles.includes(role.id)}
                          onChange={() => toggleRole(role.id)}
                        />
                        {role.label}
                      </label>
                    ))}
                  </div>
                )}
              </div>

              <div className="flex justify-end gap-3 mt-4">
                <button type="button" onClick={() => setShowModal(false)} className="text-gray-500">Cancel</button>
                <button type="submit" className="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Send Message</button>
              </div>

            </form>
          </div>
        </div>
      )}

      {/* Delete Confirmation Modal */}
      <DeleteConfirmationModal
        isVisible={showDeleteModal}
        onClose={() => {
          if (!isDeleting) {
            setShowDeleteModal(false);
            setMessageToDelete(null);
          }
        }}
        onConfirm={handleDeleteConfirm}
        itemName={messageToDelete?.title}
        message={messageToDelete ? `Are you sure you want to delete "${messageToDelete.title}"? This action cannot be undone.` : undefined}
        isLoading={isDeleting}
      />

      {/* Toast Notification */}
      <Toast
        message={toast.message}
        type={toast.type}
        isVisible={toast.isVisible}
        onClose={() => setToast({ ...toast, isVisible: false })}
      />
    </div>
  );
}
--- END OF FILE: ./frontend/app/admin/super/messages/page.tsx ---


--- START OF FILE: ./frontend/app/admin/super/posts/page.tsx ---
'use client';

import { useEffect, useState } from 'react';
import Link from 'next/link';
import api from '../../../../lib/api';
import { Post } from '../../../../types/post';
import DeleteConfirmationModal from '../../../components/DeleteConfirmationModal';
import Toast from '../../../components/Toast';

export default function SuperAdminPostsPage() {
    const [posts, setPosts] = useState<any[]>([]); // Use any to handle the nested details easier
    const [stats, setStats] = useState<any>(null);
    const [loading, setLoading] = useState(true);
    
    // Delete Modal State
    const [showDeleteModal, setShowDeleteModal] = useState(false);
    const [postToDelete, setPostToDelete] = useState<{ id: number; title: string } | null>(null);
    const [isDeleting, setIsDeleting] = useState(false);
    
    // Toast State
    const [toast, setToast] = useState<{ message: string; type: 'success' | 'error' | 'info' | 'warning'; isVisible: boolean }>({
        message: '',
        type: 'success',
        isVisible: false,
    });

    const fetchData = async () => {
        try {
            const postsRes = await api.get('/posts/');
            setPosts(postsRes.data.results || postsRes.data);

            const statsRes = await api.get('/posts/analytics_overview/');
            setStats(statsRes.data);
        } catch (err) {
            console.error("Failed to fetch posts", err);
        } finally {
            setLoading(false);
        }
    };

    useEffect(() => {
        fetchData();
    }, []);

    const handleDeleteClick = (post: Post) => {
        setPostToDelete({ id: post.id, title: post.title });
        setShowDeleteModal(true);
    };

    const handleDeleteConfirm = async () => {
        if (!postToDelete) return;

        setIsDeleting(true);
        try {
            await api.delete(`/posts/${postToDelete.id}/`);
            setToast({ message: 'Post deleted successfully!', type: 'success', isVisible: true });
            setShowDeleteModal(false);
            setPostToDelete(null);
            fetchData(); 
        } catch (err) {
            setToast({ message: 'Failed to delete post.', type: 'error', isVisible: true });
        } finally {
            setIsDeleting(false);
        }
    };

    // Helper to determine what to show in the "Scope" column
    const getScopeBadge = (post: any) => {
        if (post.is_global) {
            return <span className="bg-purple-100 text-purple-800 px-2 py-1 rounded-full text-xs font-bold">üåç Global</span>;
        }
        
        // Super Admin creating for specific Munis
        if (post.target_municipalities_details && post.target_municipalities_details.length > 0) {
            const count = post.target_municipalities_details.length;
            const name = post.target_municipalities_details[0].name;
            return (
                <span className="bg-blue-100 text-blue-800 px-2 py-1 rounded-full text-xs font-bold">
                    üèõÔ∏è {count > 1 ? `${count} Municipalities` : name}
                </span>
            );
        }

        // Super/Muni Admin creating for specific Clubs
        if (post.target_clubs_details && post.target_clubs_details.length > 0) {
            const count = post.target_clubs_details.length;
            const name = post.target_clubs_details[0].name;
            return (
                <span className="bg-green-100 text-green-800 px-2 py-1 rounded-full text-xs font-bold">
                    ‚öΩ {count > 1 ? `${count} Clubs` : name}
                </span>
            );
        }

        // Fallback based on ownership
        if (post.owner_role === 'MUNICIPALITY_ADMIN') return <span className="text-gray-500 text-xs">Municipality</span>;
        if (post.owner_role === 'CLUB_ADMIN') return <span className="text-gray-500 text-xs">Club</span>;

        return <span className="text-gray-400 text-xs">-</span>;
    };

    if (loading) return <div className="p-8 text-center">Loading posts...</div>;

    return (
        <div className="space-y-6">
            {/* Header */}
            <div className="flex justify-between items-center">
                <h1 className="text-2xl font-bold text-gray-800">Post Management</h1>
                <Link 
                    href="/admin/super/posts/create"
                    className="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md font-medium"
                >
                    + Create New Post
                </Link>
            </div>

            {/* Analytics Cards */}
            {stats && (
                <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div className="bg-white p-4 rounded-lg shadow border-l-4 border-blue-500">
                        <p className="text-sm text-gray-500">Total Posts</p>
                        <p className="text-2xl font-bold">{stats.total_posts}</p>
                    </div>
                    <div className="bg-white p-4 rounded-lg shadow border-l-4 border-green-500">
                        <p className="text-sm text-gray-500">New (7 Days)</p>
                        <p className="text-2xl font-bold">{stats.created_last_7_days}</p>
                    </div>
                    <div className="bg-white p-4 rounded-lg shadow border-l-4 border-purple-500">
                        <p className="text-sm text-gray-500">New (30 Days)</p>
                        <p className="text-2xl font-bold">{stats.created_last_30_days}</p>
                    </div>
                    <div className="bg-white p-4 rounded-lg shadow border-l-4 border-orange-500">
                        <p className="text-sm text-gray-500">Avg Views</p>
                        <p className="text-2xl font-bold">{stats.average_views}</p>
                    </div>
                </div>
            )}

            {/* Posts Table */}
            <div className="bg-white shadow rounded-lg overflow-hidden">
                <table className="min-w-full divide-y divide-gray-200">
                    <thead className="bg-gray-50">
                        <tr>
                            <th className="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Title</th>
                            <th className="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Scope</th>
                            <th className="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Type</th>
                            <th className="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Status</th>
                            <th className="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Views</th>
                            <th className="px-6 py-3 text-right text-xs font-bold text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody className="bg-white divide-y divide-gray-200">
                        {posts.length === 0 ? (
                            <tr>
                                <td colSpan={6} className="px-6 py-8 text-center text-gray-500">
                                    No posts found. Create your first one!
                                </td>
                            </tr>
                        ) : (
                            posts.map((post) => (
                                <tr key={post.id} className="hover:bg-gray-50 transition">
                                    <td className="px-6 py-4">
                                        <div className="text-sm font-bold text-gray-900">
                                            {post.is_pinned && <span className="mr-2 text-red-500" title="Pinned">üìå</span>}
                                            {post.title}
                                        </div>
                                        <div className="text-xs text-gray-500">
                                            By {post.author?.first_name || 'Unknown'} ‚Ä¢ {new Date(post.created_at).toLocaleDateString()}
                                        </div>
                                    </td>
                                    
                                    {/* NEW SCOPE COLUMN */}
                                    <td className="px-6 py-4">
                                        {getScopeBadge(post)}
                                    </td>

                                    <td className="px-6 py-4">
                                        <span className="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-gray-100 text-gray-800 border border-gray-200">
                                            {post.post_type}
                                        </span>
                                    </td>
                                    <td className="px-6 py-4">
                                        <span className={`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-bold ${
                                            post.status === 'PUBLISHED' ? 'bg-green-100 text-green-800' :
                                            post.status === 'DRAFT' ? 'bg-yellow-100 text-yellow-800' :
                                            'bg-gray-100 text-gray-800'
                                        }`}>
                                            {post.status}
                                        </span>
                                    </td>
                                    <td className="px-6 py-4 text-sm text-gray-500">
                                        {post.view_count}
                                    </td>
                                    <td className="px-6 py-4 text-right text-sm font-medium space-x-3">
                                        <Link href={`/admin/super/posts/${post.id}`} className="text-indigo-600 hover:text-indigo-900">
                                            View
                                        </Link>
                                        <Link href={`/admin/super/posts/edit/${post.id}`} className="text-blue-600 hover:text-blue-900">
                                            Edit
                                        </Link>
                                        <button 
                                            onClick={() => handleDeleteClick(post)}
                                            className="text-red-600 hover:text-red-900"
                                        >
                                            Delete
                                        </button>
                                    </td>
                                </tr>
                            ))
                        )}
                    </tbody>
                </table>
            </div>

            <DeleteConfirmationModal
                isVisible={showDeleteModal}
                onClose={() => { if (!isDeleting) { setShowDeleteModal(false); setPostToDelete(null); } }}
                onConfirm={handleDeleteConfirm}
                itemName={postToDelete?.title}
                isLoading={isDeleting}
            />
            <Toast message={toast.message} type={toast.type} isVisible={toast.isVisible} onClose={() => setToast({ ...toast, isVisible: false })} />
        </div>
    );
}

--- END OF FILE: ./frontend/app/admin/super/posts/page.tsx ---


--- START OF FILE: ./frontend/app/admin/super/posts/edit/[id]/page.tsx ---
'use client';

import { useEffect, useState } from 'react';
import { useRouter, useParams } from 'next/navigation';
import api from '../../../../../../lib/api';
import PostForm from '../../../../../components/posts/PostForm';
import { Post } from '../../../../../../types/post';

export default function EditPostPage() {
    const router = useRouter();
    const params = useParams();
    const postId = params?.id as string;
    
    const [post, setPost] = useState<Post | null>(null);
    const [loading, setLoading] = useState(true);

    useEffect(() => {
        if (!postId) return;
        
        const fetchPost = async () => {
            try {
                const res = await api.get(`/posts/${postId}/`);
                setPost(res.data);
            } catch (err) {
                console.error("Failed to fetch post", err);
                alert("Post not found");
                router.push('/admin/super/posts');
            } finally {
                setLoading(false);
            }
        };
        fetchPost();
    }, [postId, router]);

    if (loading) return <div className="p-8 text-center text-gray-500">Loading post data...</div>;
    if (!post) return null;

    return (
        <div className="max-w-4xl mx-auto">
            <div className="mb-6">
                <button 
                    onClick={() => router.back()}
                    className="text-sm text-gray-500 hover:text-gray-700 mb-2"
                >
                    ‚Üê Cancel & Back
                </button>
                <h1 className="text-2xl font-bold text-gray-900">Edit Post</h1>
            </div>

            <PostForm 
                initialData={post}
                role="super" 
                onSuccess={() => router.push(`/admin/super/posts/${post.id}`)} // Redirect to View Page
            />
        </div>
    );
}
--- END OF FILE: ./frontend/app/admin/super/posts/edit/[id]/page.tsx ---


--- START OF FILE: ./frontend/app/admin/super/posts/[id]/page.tsx ---
'use client';

import { useEffect, useMemo, useState } from 'react';
import Link from 'next/link';
import { useRouter, useParams } from 'next/navigation';
import api from '../../../../../lib/api';
import { Post } from '../../../../../types/post';

export default function PostDetailPage() {
    const router = useRouter();
    const params = useParams();
    const postId = params?.id as string;
    
    const [post, setPost] = useState<Post | null>(null);
    const [comments, setComments] = useState<any[]>([]);
    const [loading, setLoading] = useState(true);
    const [customFieldMap, setCustomFieldMap] = useState<Record<number, string>>({});

    const fetchData = async () => {
        if (!postId) return;
        
        try {
            // 1. Fetch Post Details
            const postRes = await api.get(`/posts/${postId}/`);
            setPost(postRes.data);

            // 2. Fetch Comments for this post
            const commentsRes = await api.get(`/post-comments/?post_id=${postId}`);
            setComments(commentsRes.data.results || commentsRes.data);
        } catch (err) {
            console.error(err);
        } finally {
            setLoading(false);
        }
    };

    useEffect(() => {
        fetchData();
    }, [postId]);

    const handleApproveComment = async (commentId: number, currentStatus: boolean) => {
        try {
            await api.patch(`/post-comments/${commentId}/`, { is_approved: !currentStatus });
            fetchData(); // Refresh list
        } catch (err) {
            alert('Failed to update comment');
        }
    };

    const handleDeleteComment = async (commentId: number) => {
        if (!confirm("Delete this comment permanently?")) return;
        try {
            await api.delete(`/post-comments/${commentId}/`);
            fetchData(); // Refresh list
        } catch (err) {
            alert('Failed to delete comment');
        }
    };

    const hasCustomFieldRules = useMemo(() => {
        if (!post?.target_custom_fields) return false;
        return Object.keys(post.target_custom_fields).length > 0;
    }, [post?.target_custom_fields]);

    useEffect(() => {
        const fetchCustomFieldNames = async () => {
            if (!hasCustomFieldRules) return;
            try {
                const res = await api.get('/custom-fields/');
                const definitions = res.data.results || res.data || [];
                const map = definitions.reduce((acc: Record<number, string>, field: any) => {
                    acc[field.id] = field.name;
                    return acc;
                }, {});
                setCustomFieldMap(map);
            } catch (error) {
                console.error('Failed to load custom fields', error);
            }
        };

        fetchCustomFieldNames();
    }, [hasCustomFieldRules]);

    if (loading) return <div className="p-8">Loading...</div>;
    if (!post) return <div className="p-8">Post not found</div>;

    return (
        <div className="space-y-6 max-w-6xl mx-auto">
            {/* --- HEADER --- */}
            <div className="flex justify-between items-start">
                <div>
                    <button onClick={() => router.push('/admin/super/posts')} className="text-sm text-gray-500 mb-1 hover:underline">‚Üê Back to List</button>
                    <h1 className="text-3xl font-bold text-gray-900">{post.title}</h1>
                    <div className="flex items-center gap-3 mt-2">
                        <span className={`px-2 py-1 rounded-full text-xs font-bold ${
                            post.status === 'PUBLISHED' ? 'bg-green-100 text-green-800' :
                            post.status === 'DRAFT' ? 'bg-yellow-100 text-yellow-800' :
                            'bg-gray-100 text-gray-800'
                        }`}>
                            {post.status}
                        </span>
                        <span className="text-sm text-gray-500">Created: {new Date(post.created_at).toLocaleDateString()}</span>
                        {post.is_pinned && <span className="text-sm text-red-500 font-medium">üìå Pinned</span>}
                    </div>
                </div>
                <div className="flex gap-3">
                    <Link 
                        href={`/admin/super/posts/edit/${post.id}`}
                        className="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 font-medium"
                    >
                        Edit Post
                    </Link>
                </div>
            </div>

            <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                
                {/* --- LEFT COL: PREVIEW --- */}
                <div className="lg:col-span-2 space-y-6">
                    {/* Content Preview Card */}
                    <div className="bg-white p-6 rounded-lg shadow">
                        <h3 className="text-lg font-bold text-gray-800 mb-4 border-b pb-2">Content Preview</h3>
                        
                        {/* Video Display */}
                        {post.post_type === 'VIDEO' && post.video_url && (
                            <div className="mb-4 bg-black rounded overflow-hidden aspect-video flex items-center justify-center text-white">
                                {/* Simple placeholder if specific youtube embed logic isn't added yet */}
                                <a href={post.video_url} target="_blank" rel="noreferrer" className="underline">
                                    Watch Video ({post.video_url})
                                </a>
                            </div>
                        )}

                        {/* Image Display */}
                        {post.post_type === 'IMAGE' && post.images && post.images.length > 0 && (
                            <div className="flex gap-2 overflow-x-auto mb-4 pb-2">
                                {post.images.map(img => (
                                    <img key={img.id} src={img.image} className="h-48 rounded object-cover border" alt="Post media" />
                                ))}
                            </div>
                        )}

                        {/* Text Content */}
                        <div 
                            className="prose max-w-none text-gray-700 bg-gray-50 p-4 rounded border"
                            dangerouslySetInnerHTML={{ __html: post.content }} 
                        />
                    </div>

                    {/* Comments Manager */}
                    <div className="bg-white p-6 rounded-lg shadow">
                        <div className="flex justify-between items-center mb-4">
                            <h3 className="text-lg font-bold text-gray-800">Comments ({comments.length})</h3>
                            <span className="text-xs text-gray-500">Moderation: {post.require_moderation ? 'On' : 'Off'}</span>
                        </div>
                        
                        <div className="space-y-4 max-h-96 overflow-y-auto">
                            {comments.length === 0 ? (
                                <p className="text-gray-400 italic">No comments yet.</p>
                            ) : (
                                comments.map(comment => (
                                    <div key={comment.id} className={`p-3 rounded border ${comment.is_approved ? 'bg-white' : 'bg-red-50 border-red-200'}`}>
                                        <div className="flex justify-between">
                                            <p className="text-sm font-bold text-gray-700">
                                                {comment.author?.first_name} {comment.author?.last_name}
                                                <span className="text-gray-400 font-normal ml-2 text-xs">
                                                    {new Date(comment.created_at).toLocaleString()}
                                                </span>
                                            </p>
                                            <div className="flex gap-2">
                                                <button 
                                                    onClick={() => handleApproveComment(comment.id, comment.is_approved)}
                                                    className={`text-xs px-2 py-1 rounded ${comment.is_approved ? 'bg-yellow-100 text-yellow-700' : 'bg-green-100 text-green-700'}`}
                                                >
                                                    {comment.is_approved ? 'Hide' : 'Approve'}
                                                </button>
                                                <button 
                                                    onClick={() => handleDeleteComment(comment.id)}
                                                    className="text-xs px-2 py-1 rounded bg-red-100 text-red-700 hover:bg-red-200"
                                                >
                                                    Delete
                                                </button>
                                            </div>
                                        </div>
                                        <p className="text-gray-800 mt-1 text-sm">{comment.content}</p>
                                        {!comment.is_approved && (
                                            <p className="text-xs text-red-600 font-bold mt-1">‚ö† Pending Approval</p>
                                        )}
                                    </div>
                                ))
                            )}
                        </div>
                    </div>
                </div>

                {/* --- RIGHT COL: DETAILS & ANALYTICS --- */}
                <div className="space-y-6">
                    
                    {/* Analytics Card */}
                    <div className="bg-white p-6 rounded-lg shadow border-t-4 border-blue-500">
                        <h3 className="font-bold text-gray-800 mb-4">Analytics</h3>
                        <div className="grid grid-cols-2 gap-4 text-center">
                            <div className="p-2 bg-gray-50 rounded">
                                <p className="text-2xl font-bold text-blue-600">{post.view_count}</p>
                                <p className="text-xs text-gray-500">Views</p>
                            </div>
                            <div className="p-2 bg-gray-50 rounded">
                                <p className="text-2xl font-bold text-green-600">{comments.length}</p>
                                <p className="text-xs text-gray-500">Comments</p>
                            </div>
                        </div>
                    </div>

                    {/* Targeting Summary */}
                    <div className="bg-white p-6 rounded-lg shadow">
                        <h3 className="font-bold text-gray-800 mb-4">Target Audience</h3>
                        <ul className="space-y-3 text-sm">
                            <li className="flex justify-between">
                                <span className="text-gray-500">Member Type:</span>
                                <span className="font-medium">{post.target_member_type}</span>
                            </li>
                            {post.target_groups.length > 0 ? (
                                <div>
                                    <p className="text-gray-500 mb-1">Targeted Groups:</p>
                                    <div className="flex flex-wrap gap-1">
                                        {post.target_groups.map(g => (
                                            <span key={g} className="px-2 py-0.5 bg-blue-100 text-blue-800 rounded text-xs">Group ID {g}</span>
                                        ))}
                                    </div>
                                </div>
                            ) : (
                                <>
                                    <li className="flex justify-between">
                                        <span className="text-gray-500">Age Range:</span>
                                        <span className="font-medium">
                                            {post.target_min_age || 0} - {post.target_max_age || 'Any'}
                                        </span>
                                    </li>
                                    <li className="flex justify-between">
                                        <span className="text-gray-500">Gender:</span>
                                        <span className="font-medium">
                                            {post.target_genders.length > 0 ? post.target_genders.join(', ') : 'All'}
                                        </span>
                                    </li>
                                    <li className="flex justify-between">
                                        <span className="text-gray-500">Grades:</span>
                                        <span className="font-medium">
                                            {post.target_grades.length > 0 ? post.target_grades.join(', ') : 'All'}
                                        </span>
                                    </li>
                                </>
                            )}
                            {hasCustomFieldRules && (
                                <li className="flex flex-col gap-2">
                                    <span className="text-gray-500">Custom Field Rules:</span>
                                    <div className="flex flex-col gap-1">
                                        {Object.entries(post.target_custom_fields || {}).map(([fieldId, value]) => {
                                            const id = Number(fieldId);
                                            const fieldName = customFieldMap[id] || `Custom Field #${fieldId}`;
                                            let displayValue: string;
                                            if (typeof value === 'boolean') displayValue = value ? 'Yes' : 'No';
                                            else displayValue = Array.isArray(value) ? value.join(', ') : String(value);
                                            return (
                                                <span
                                                    key={fieldId}
                                                    className="text-sm text-gray-700 bg-gray-50 px-2 py-1 rounded border border-gray-100"
                                                >
                                                    <strong>{fieldName}:</strong> {displayValue || 'Any'}
                                                </span>
                                            );
                                        })}
                                    </div>
                                </li>
                            )}
                        </ul>
                    </div>

                    {/* Settings Summary */}
                    <div className="bg-white p-6 rounded-lg shadow">
                        <h3 className="font-bold text-gray-800 mb-4">Configuration</h3>
                        <ul className="space-y-2 text-sm text-gray-600">
                            <li>‚Ä¢ {post.allow_comments ? '‚úÖ Comments Allowed' : '‚ùå Comments Disabled'}</li>
                            <li>‚Ä¢ {post.require_moderation ? '‚úÖ Moderation On' : '‚ö™ Moderation Off'}</li>
                            <li>‚Ä¢ {post.send_push_notification ? '‚úÖ Push Notification Sent' : '‚ö™ No Push Notification'}</li>
                            {post.visibility_end_date && (
                                <li className="text-orange-600">‚Ä¢ Expires: {new Date(post.visibility_end_date).toLocaleDateString()}</li>
                            )}
                        </ul>
                    </div>

                </div>
            </div>
        </div>
    );
}
--- END OF FILE: ./frontend/app/admin/super/posts/[id]/page.tsx ---


--- START OF FILE: ./frontend/app/admin/super/posts/create/page.tsx ---
'use client';

import { useRouter } from 'next/navigation';
import PostForm from '../../../../components/posts/PostForm';

export default function CreatePostPage() {
    const router = useRouter();

    return (
        <div className="max-w-4xl mx-auto">
            <div className="mb-6">
                <button 
                    onClick={() => router.back()}
                    className="text-sm text-gray-500 hover:text-gray-700 mb-2"
                >
                    ‚Üê Back to Posts
                </button>
                <h1 className="text-2xl font-bold text-gray-900">Create New Post</h1>
                <p className="text-gray-500">Share updates, news, or media with your members.</p>
            </div>

            <PostForm 
                role="super" 
                onSuccess={() => router.push('/admin/super/posts')} 
            />
        </div>
    );
}
--- END OF FILE: ./frontend/app/admin/super/posts/create/page.tsx ---


--- START OF FILE: ./frontend/app/admin/super/clubs/page.tsx ---
'use client';

import { useState, useEffect, Suspense } from 'react';
import { useRouter, useSearchParams, usePathname } from 'next/navigation';
import Link from 'next/link';
import api from '../../../../lib/api';
import { getMediaUrl } from '../../../utils';
import Toast from '../../../components/Toast';
import DeleteConfirmationModal from '../../../components/DeleteConfirmationModal';

interface Option { id: number; name: string; }

const WEEKDAYS = [
  { id: 1, name: 'Monday' }, { id: 2, name: 'Tuesday' }, { id: 3, name: 'Wednesday' },
  { id: 4, name: 'Thursday' }, { id: 5, name: 'Friday' }, { id: 6, name: 'Saturday' }, { id: 7, name: 'Sunday' },
];

const CYCLES = [
  { id: 'ALL', name: 'Every Week' },
  { id: 'ODD', name: 'Odd Weeks' },
  { id: 'EVEN', name: 'Even Weeks' },
];

const GENDER_RESTRICTIONS = [
  { id: 'ALL', name: 'All Genders' },
  { id: 'BOYS', name: 'Boys Only' },
  { id: 'GIRLS', name: 'Girls Only' },
  { id: 'OTHER', name: 'Other' },
];

function ManageClubsPageContent() {
  const router = useRouter();
  const pathname = usePathname();
  const searchParams = useSearchParams();

  // --- STATE ---
  const [clubs, setClubs] = useState<any[]>([]);
  const [totalCount, setTotalCount] = useState(0);
  const [municipalities, setMunicipalities] = useState<Option[]>([]);
  const [isLoading, setIsLoading] = useState(true);
  
  // Toast State
  const [toast, setToast] = useState<{ message: string; type: 'success' | 'error' | 'info' | 'warning'; isVisible: boolean }>({
    message: '',
    type: 'success',
    isVisible: false,
  });

  // Modal & Files
  const [showModal, setShowModal] = useState(false);
  const [isEditing, setIsEditing] = useState(false);
  const [editId, setEditId] = useState<number | null>(null);
  const [avatarFile, setAvatarFile] = useState<File | null>(null);
  const [avatarPreview, setAvatarPreview] = useState<string | null>(null);
  const [heroFile, setHeroFile] = useState<File | null>(null);
  const [heroPreview, setHeroPreview] = useState<string | null>(null);
  
  // Delete Confirmation Modal State
  const [showDeleteModal, setShowDeleteModal] = useState(false);
  const [clubToDelete, setClubToDelete] = useState<{ id: number; name: string } | null>(null);
  const [isDeleting, setIsDeleting] = useState(false);

  // Opening Hours
  const [openingHours, setOpeningHours] = useState<any[]>([]);
  const [hourError, setHourError] = useState('');

  // Form Data
  const initialFormState = {
    name: '', municipality: '', email: '', phone: '',
    description: '', terms_and_conditions: '', club_policies: '',
    address: '', club_categories: '', latitude: '', longitude: '',
  };
  const [formData, setFormData] = useState(initialFormState);

  // New Hour Form
  const initialHourState = {
    weekday: 1, week_cycle: 'ALL',
    open_time: '14:00', close_time: '20:00',
    title: '', gender_restriction: 'ALL',
    restriction_mode: 'NONE', // NONE, AGE, GRADE
    min_value: '', max_value: ''
  };
  const [newHour, setNewHour] = useState(initialHourState);

  useEffect(() => {
    fetchMunicipalities();
  }, []);

  useEffect(() => {
    fetchClubs();
  }, [searchParams]);

  const fetchMunicipalities = async () => {
    try {
      const muniRes = await api.get('/municipalities/');
      setMunicipalities(Array.isArray(muniRes.data) ? muniRes.data : (muniRes.data.results || []));
    } catch (err) {
      console.error(err);
    }
  };

  const fetchClubs = async () => {
    setIsLoading(true);
    try {
      const params = new URLSearchParams();
      const page = searchParams.get('page');
      if (page) params.set('page', page);
      
      // Add filters
      const municipality = searchParams.get('municipality');
      if (municipality) params.set('municipality', municipality);
      
      const search = searchParams.get('search');
      if (search) params.set('search', search);
      
      const clubRes = await api.get(`/clubs/?${params.toString()}`);
      
      // Handle both paginated and non-paginated responses
      if (Array.isArray(clubRes.data)) {
        // Non-paginated response (array)
        setClubs(clubRes.data);
        setTotalCount(clubRes.data.length);
      } else {
        // Paginated response (object with results and count)
        setClubs(clubRes.data.results || []);
        setTotalCount(clubRes.data.count || (clubRes.data.results?.length || 0));
      }
    } catch (err) {
      console.error(err);
    } finally {
      setIsLoading(false);
    }
  };

  const updateUrl = (key: string, value: string) => {
    const params = new URLSearchParams(searchParams.toString());
    if (value) params.set(key, value); else params.delete(key);
    if (key !== 'page') params.set('page', '1');
    router.push(`${pathname}?${params.toString()}`);
  };

  const handleOpenCreate = () => {
    setIsEditing(false); setEditId(null);
    setFormData(initialFormState);
    setOpeningHours([]); setNewHour(initialHourState);
    setAvatarFile(null); setAvatarPreview(null);
    setHeroFile(null); setHeroPreview(null);
    setShowModal(true);
  };

  const handleOpenEdit = (item: any) => {
    setIsEditing(true); setEditId(item.id);
    setFormData({
      name: item.name, municipality: item.municipality,
      email: item.email || '', phone: item.phone || '',
      description: item.description || '', terms_and_conditions: item.terms_and_conditions || '',
      club_policies: item.club_policies || '', address: item.address || '',
      club_categories: item.club_categories || '',
      latitude: item.latitude?.toString() || '', longitude: item.longitude?.toString() || '',
    });
    setOpeningHours(item.regular_hours || []);
    setAvatarFile(null); setAvatarPreview(item.avatar ? getMediaUrl(item.avatar) : null);
    setHeroFile(null); setHeroPreview(item.hero_image ? getMediaUrl(item.hero_image) : null);
    setNewHour(initialHourState);
    setShowModal(true);
  };

  const handleDeleteClick = (club: any) => {
    setClubToDelete({ id: club.id, name: club.name });
    setShowDeleteModal(true);
  };

  const handleDeleteConfirm = async () => {
    if (!clubToDelete) return;

    setIsDeleting(true);
    try { 
      await api.delete(`/clubs/${clubToDelete.id}/`);
      setToast({
        message: 'Club deleted successfully!',
        type: 'success',
        isVisible: true,
      });
      setShowDeleteModal(false);
      setClubToDelete(null);
      fetchClubs(); 
    } 
    catch (err) { 
      setToast({
        message: 'Failed to delete club.',
        type: 'error',
        isVisible: true,
      });
    } finally {
      setIsDeleting(false);
    }
  };

  const handleFileChange = (e: React.ChangeEvent<HTMLInputElement>, type: 'avatar' | 'hero') => {
    const file = e.target.files?.[0];
    if (file) {
      const reader = new FileReader();
      reader.onloadend = () => {
        if (type === 'avatar') { setAvatarFile(file); setAvatarPreview(reader.result as string); } 
        else { setHeroFile(file); setHeroPreview(reader.result as string); }
      };
      reader.readAsDataURL(file);
    }
  };

  // --- HOUR VALIDATION ---
  const checkOverlap = (newItem: any) => {
    // Convert time string "14:00" to minutes
    const toMins = (t: string) => {
      const [h, m] = t.split(':').map(Number);
      return h * 60 + m;
    };
    const start = toMins(newItem.open_time);
    const end = toMins(newItem.close_time);

    // Validation: End must be after Start
    if (end <= start) return "Close time must be after Open time.";

    // Check against existing
    for (const h of openingHours) {
      if (h.weekday !== newItem.weekday) continue;
      
      // Cycle Check: Overlap if either is ALL or they match
      const cycleOverlap = h.week_cycle === 'ALL' || newItem.week_cycle === 'ALL' || h.week_cycle === newItem.week_cycle;
      if (!cycleOverlap) continue;

      const s2 = toMins(h.open_time);
      const e2 = toMins(h.close_time);

      // Overlap formula: (StartA < EndB) and (EndA > StartB)
      // Note: We use < and > to allow touching (e.g. 15:00 end and 15:00 start is ok)
      if (start < e2 && end > s2) {
        return `Overlap detected with existing hour: ${h.open_time}-${h.close_time} (${h.week_cycle === 'ALL' ? 'Every Week' : h.week_cycle})`;
      }
    }
    return null;
  };

  const addHour = () => {
    setHourError('');
    const error = checkOverlap(newHour);
    if (error) {
      setHourError(error);
      return;
    }
    setOpeningHours([...openingHours, { ...newHour }]);
    // Keep the day selected for faster entry, reset times/title
    setNewHour({ ...newHour, title: '', min_value: '', max_value: '' }); 
  };

  const removeHour = (index: number) => {
    const updated = [...openingHours];
    updated.splice(index, 1);
    setOpeningHours(updated);
  };

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    
    // Validate required fields (trim whitespace and check for actual content)
    const trimmedName = formData.name?.trim();
    const municipalityValue = formData.municipality?.toString().trim();
    const trimmedEmail = formData.email?.trim();
    const trimmedPhone = formData.phone?.trim();
    const trimmedDescription = formData.description?.trim();
    const trimmedTerms = formData.terms_and_conditions?.trim();
    const trimmedPolicies = formData.club_policies?.trim();
    
    // Check if municipality is a valid number
    const isValidMunicipality = municipalityValue && !isNaN(Number(municipalityValue)) && Number(municipalityValue) > 0;
    
    if (!trimmedName || !isValidMunicipality || !trimmedEmail || !trimmedPhone || 
        !trimmedDescription || !trimmedTerms || !trimmedPolicies) {
      const missingFields = [];
      if (!trimmedName) missingFields.push('Name');
      if (!isValidMunicipality) missingFields.push('Municipality');
      if (!trimmedEmail) missingFields.push('Email');
      if (!trimmedPhone) missingFields.push('Phone');
      if (!trimmedDescription) missingFields.push('Description');
      if (!trimmedTerms) missingFields.push('Terms & Conditions');
      if (!trimmedPolicies) missingFields.push('Club Policies');
      
      alert(`Please fill in the following required fields: ${missingFields.join(', ')}`);
      return;
    }
    
    try {
      const data = new FormData();
      // Append all form fields with trimmed values (validation already ensured required fields are filled)
      data.append('name', trimmedName);
      data.append('municipality', municipalityValue);
      data.append('email', trimmedEmail);
      data.append('phone', trimmedPhone);
      data.append('description', trimmedDescription);
      data.append('terms_and_conditions', trimmedTerms);
      data.append('club_policies', trimmedPolicies);
      // Append optional fields
      if (formData.address?.trim()) data.append('address', formData.address.trim());
      if (formData.club_categories?.trim()) data.append('club_categories', formData.club_categories.trim());
      if (formData.latitude?.trim()) data.append('latitude', formData.latitude.trim());
      if (formData.longitude?.trim()) data.append('longitude', formData.longitude.trim());
      
      // Clean up opening hours data before sending
      const cleanedHours = openingHours.map(hour => {
        const cleaned: any = {
          weekday: hour.weekday,
          week_cycle: hour.week_cycle || 'ALL',
          open_time: hour.open_time,
          close_time: hour.close_time,
          title: hour.title || '',
          gender_restriction: hour.gender_restriction || 'ALL',
          restriction_mode: hour.restriction_mode || 'NONE',
        };
        
        // Only include min_value/max_value if restriction_mode is not 'NONE'
        if (cleaned.restriction_mode !== 'NONE') {
          cleaned.min_value = hour.min_value ? parseInt(hour.min_value) : null;
          cleaned.max_value = hour.max_value ? parseInt(hour.max_value) : null;
        } else {
          cleaned.min_value = null;
          cleaned.max_value = null;
        }
        
        return cleaned;
      });
      
      data.append('regular_hours_data', JSON.stringify(cleanedHours));
      if (avatarFile) data.append('avatar', avatarFile);
      if (heroFile) data.append('hero_image', heroFile);

      const config = { headers: { 'Content-Type': 'multipart/form-data' } };
      if (isEditing && editId) {
        await api.patch(`/clubs/${editId}/`, data, config);
        setToast({
          message: 'Club updated successfully!',
          type: 'success',
          isVisible: true,
        });
      } else {
        await api.post('/clubs/', data, config);
        setToast({
          message: 'Club created successfully!',
          type: 'success',
          isVisible: true,
        });
      }

      setShowModal(false);
      fetchClubs();
    } catch (err: any) { 
      const errorMessage = err?.response?.data?.detail || err?.response?.data?.message || JSON.stringify(err?.response?.data) || 'Operation failed.';
      setToast({
        message: `Error: ${errorMessage}`,
        type: 'error',
        isVisible: true,
      });
      console.error('Full error:', err);
      console.error('Error response data:', err?.response?.data);
    }
  };

  const currentPage = Number(searchParams.get('page')) || 1;
  const totalPages = totalCount > 0 ? Math.ceil(totalCount / 10) : 1;

  return (
    <div>
      <div className="flex justify-between items-center mb-6">
        <h1 className="text-2xl font-bold text-gray-800">Manage Clubs</h1>
        <button onClick={handleOpenCreate} className="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 shadow">+ Add Club</button>
      </div>

      {/* --- FILTER BAR --- */}
      <div className="bg-white p-4 rounded-lg shadow mb-6 border border-gray-100">
        <div className="flex flex-wrap gap-4 items-end">
          <div className="flex-1 min-w-[200px]">
            <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Search</label>
            <input
              type="text"
              placeholder="Search by club name, email, or description..."
              className="w-full border rounded p-2 text-sm bg-gray-50"
              value={searchParams.get('search') || ''}
              onChange={(e) => {
                const value = e.target.value;
                if (value.trim()) {
                  updateUrl('search', value.trim());
                } else {
                  const params = new URLSearchParams(searchParams.toString());
                  params.delete('search');
                  params.set('page', '1');
                  router.push(`${pathname}?${params.toString()}`);
                }
              }}
            />
          </div>

          <div className="w-48">
            <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Municipality</label>
            <select
              className="w-full border rounded p-2 text-sm bg-gray-50"
              value={searchParams.get('municipality') || ''}
              onChange={(e) => updateUrl('municipality', e.target.value)}
            >
              <option value="">All Municipalities</option>
              {Array.isArray(municipalities) && municipalities.map(m => (
                <option key={m.id} value={m.id.toString()}>{m.name}</option>
              ))}
            </select>
          </div>

          <button
            onClick={() => router.push(pathname)}
            className="px-4 py-2 text-sm text-gray-500 hover:text-red-500 font-medium pb-2.5"
          >
            Clear Filters
          </button>
        </div>
      </div>

      {/* LIST */}
      <div className="bg-white rounded-lg shadow overflow-hidden mb-6">
        {isLoading ? <div className="p-8 text-center">Loading...</div> : (
          <table className="min-w-full divide-y divide-gray-200">
            <thead className="bg-gray-50">
              <tr>
                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Club</th>
                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Municipality</th>
                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Email</th>
                <th className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">Actions</th>
              </tr>
            </thead>
            <tbody className="bg-white divide-y divide-gray-200">
              {clubs.map((club) => (
                <tr key={club.id}>
                  <td className="px-6 py-4 whitespace-nowrap">
                    <div className="flex items-center">
                      {club.avatar ? <img src={getMediaUrl(club.avatar) || ''} className="w-10 h-10 rounded-full object-cover mr-3" /> : <div className="w-10 h-10 bg-gray-200 rounded-full mr-3 flex items-center justify-center text-xs">C</div>}
                      <div className="text-sm font-bold">{club.name}</div>
                    </div>
                  </td>
                  <td className="px-6 py-4 whitespace-nowrap text-sm">{club.municipality_name}</td>
                  <td className="px-6 py-4 whitespace-nowrap text-sm">{club.email}</td>
                  <td className="px-6 py-4 whitespace-nowrap text-right text-sm space-x-4">
                    <Link href={`/admin/super/clubs/${club.id}`} className="text-blue-600 hover:text-blue-900 font-bold">View</Link>
                    <button onClick={() => handleOpenEdit(club)} className="text-indigo-600 hover:text-indigo-900 font-bold">Edit</button>
                    <button onClick={() => handleDeleteClick(club)} className="text-red-600 hover:text-red-900">Delete</button>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        )}
      </div>

      {/* --- PAGINATION CONTROLS --- */}
      {totalCount > 0 && (
        <div className="flex items-center justify-between border-t border-gray-200 bg-white px-4 py-3 sm:px-6 rounded-lg shadow">
          <div className="flex flex-1 justify-between sm:hidden">
            <button 
              disabled={currentPage === 1}
              onClick={() => updateUrl('page', (currentPage - 1).toString())}
              className="relative inline-flex items-center rounded-md border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50 disabled:opacity-50"
            >
              Previous
            </button>
            <button 
              disabled={currentPage >= totalPages}
              onClick={() => updateUrl('page', (currentPage + 1).toString())}
              className="relative ml-3 inline-flex items-center rounded-md border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50 disabled:opacity-50"
            >
              Next
            </button>
          </div>
          <div className="hidden sm:flex sm:flex-1 sm:items-center sm:justify-between">
            <div>
              <p className="text-sm text-gray-700">
                Showing page <span className="font-medium">{currentPage}</span> of <span className="font-medium">{totalPages}</span>
                {' '}(Total: {totalCount})
              </p>
            </div>
            <div>
              <nav className="isolate inline-flex -space-x-px rounded-md shadow-sm" aria-label="Pagination">
                <button
                  disabled={currentPage === 1}
                  onClick={() => updateUrl('page', (currentPage - 1).toString())}
                  className="relative inline-flex items-center rounded-l-md px-2 py-2 text-gray-400 ring-1 ring-inset ring-gray-300 hover:bg-gray-50 focus:z-20 focus:outline-offset-0 disabled:opacity-50"
                >
                  <span className="sr-only">Previous</span>
                  ‚Üê Prev
                </button>
                
                {/* Simple Pagination Numbers */}
                {[...Array(totalPages)].map((_, i) => {
                  const p = i + 1;
                  return (
                    <button
                      key={p}
                      onClick={() => updateUrl('page', p.toString())}
                      className={`relative inline-flex items-center px-4 py-2 text-sm font-semibold 
                        ${p === currentPage 
                          ? 'bg-blue-600 text-white focus:z-20 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-blue-600' 
                          : 'text-gray-900 ring-1 ring-inset ring-gray-300 hover:bg-gray-50 focus:z-20 focus:outline-offset-0'}`}
                    >
                      {p}
                    </button>
                  );
                })}

                <button
                  disabled={currentPage >= totalPages}
                  onClick={() => updateUrl('page', (currentPage + 1).toString())}
                  className="relative inline-flex items-center rounded-r-md px-2 py-2 text-gray-400 ring-1 ring-inset ring-gray-300 hover:bg-gray-50 focus:z-20 focus:outline-offset-0 disabled:opacity-50"
                >
                  <span className="sr-only">Next</span>
                  Next ‚Üí
                </button>
              </nav>
            </div>
          </div>
        </div>
      )}

      {/* MODAL */}
      {showModal && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-xl shadow-2xl w-full max-w-5xl p-8 max-h-[90vh] overflow-y-auto">
            <h2 className="text-2xl font-bold mb-6 text-gray-800">{isEditing ? 'Edit Club' : 'New Club'}</h2>
            <form onSubmit={handleSubmit} className="space-y-6">
              <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                {/* Left Col: Basic */}
                <div className="space-y-4">
                  <div><label className="text-sm font-bold">Club Name</label><input required type="text" className="w-full border p-2 rounded" value={formData.name} onChange={e => setFormData({...formData, name: e.target.value})} /></div>
                  <div><label className="text-sm font-bold">Municipality</label><select required className="w-full border p-2 rounded" value={formData.municipality} onChange={e => setFormData({...formData, municipality: e.target.value})}>
                    <option value="">Select municipality</option>
                    {municipalities.map(m => <option key={m.id} value={m.id}>{m.name}</option>)}
                  </select></div>
                  <div className="grid grid-cols-2 gap-2">
                    <input required type="email" placeholder="Email" className="border p-2 rounded" value={formData.email} onChange={e => setFormData({...formData, email: e.target.value})} />
                    <input required type="text" placeholder="Phone" className="border p-2 rounded" value={formData.phone} onChange={e => setFormData({...formData, phone: e.target.value})} />
                  </div>
                  <div><label className="text-sm font-bold">Description</label><textarea required rows={3} className="w-full border p-2 rounded" value={formData.description} onChange={e => setFormData({...formData, description: e.target.value})} /></div>
                  <div><label className="text-sm font-bold">Address</label><input type="text" className="w-full border p-2 rounded" value={formData.address} onChange={e => setFormData({...formData, address: e.target.value})} /></div>
                  <div className="grid grid-cols-2 gap-2">
                    <div><label className="text-sm font-bold">Latitude</label><input type="number" step="any" placeholder="e.g. 59.3293" className="w-full border p-2 rounded" value={formData.latitude} onChange={e => setFormData({...formData, latitude: e.target.value})} /></div>
                    <div><label className="text-sm font-bold">Longitude</label><input type="number" step="any" placeholder="e.g. 18.0686" className="w-full border p-2 rounded" value={formData.longitude} onChange={e => setFormData({...formData, longitude: e.target.value})} /></div>
                  </div>
                  <div><label className="text-sm font-bold">Categories</label><input type="text" placeholder="e.g. Sports, Art" className="w-full border p-2 rounded" value={formData.club_categories} onChange={e => setFormData({...formData, club_categories: e.target.value})} /></div>
                </div>
                
                {/* Right Col: Media & Legal */}
                <div className="space-y-4">
                  <div className="grid grid-cols-2 gap-2 bg-gray-50 p-2 rounded">
                    <div><label className="text-xs font-bold uppercase">Avatar</label><input type="file" className="w-full text-xs" onChange={e => handleFileChange(e, 'avatar')} />{avatarPreview && <img src={avatarPreview} className="h-10 mt-1" />}</div>
                    <div><label className="text-xs font-bold uppercase">Hero</label><input type="file" className="w-full text-xs" onChange={e => handleFileChange(e, 'hero')} />{heroPreview && <img src={heroPreview} className="h-10 mt-1 rounded" />}</div>
                  </div>
                  <div><label className="text-sm font-bold">Terms & Conditions</label><textarea required rows={2} placeholder="Terms & Conditions" className="w-full border p-2 rounded text-sm" value={formData.terms_and_conditions} onChange={e => setFormData({...formData, terms_and_conditions: e.target.value})} /></div>
                  <div><label className="text-sm font-bold">Club Policies</label><textarea required rows={2} placeholder="Club Policies" className="w-full border p-2 rounded text-sm" value={formData.club_policies} onChange={e => setFormData({...formData, club_policies: e.target.value})} /></div>
                </div>
              </div>

              {/* HOURS BUILDER */}
              <div className="border-t pt-4 mt-4">
                <h3 className="text-lg font-bold text-gray-700 mb-4">Opening Hours</h3>
                
                {/* Add Form */}
                <div className="bg-gray-50 p-3 rounded mb-4 border space-y-3">
                  <div className="flex flex-wrap gap-2">
                    <select className="border p-1 rounded text-sm w-32" value={newHour.weekday} onChange={e => setNewHour({...newHour, weekday: parseInt(e.target.value)})}>
                      {WEEKDAYS.map(d => <option key={d.id} value={d.id}>{d.name}</option>)}
                    </select>
                    <select className="border p-1 rounded text-sm w-32" value={newHour.week_cycle} onChange={e => setNewHour({...newHour, week_cycle: e.target.value})}>
                      {CYCLES.map(c => <option key={c.id} value={c.id}>{c.name}</option>)}
                    </select>
                    <input type="time" className="border p-1 rounded text-sm" value={newHour.open_time} onChange={e => setNewHour({...newHour, open_time: e.target.value})} />
                    <span>-</span>
                    <input type="time" className="border p-1 rounded text-sm" value={newHour.close_time} onChange={e => setNewHour({...newHour, close_time: e.target.value})} />
                  </div>

                  {/* RESTRICTIONS ROW */}
                  <div className="flex flex-wrap gap-2 items-center">
                    <select className="border p-1 rounded text-sm w-32 bg-white" value={newHour.restriction_mode} onChange={e => setNewHour({...newHour, restriction_mode: e.target.value})}>
                      <option value="NONE">No Restriction</option>
                      <option value="AGE">Age Range</option>
                      <option value="GRADE">Grade Range</option>
                    </select>

                    {newHour.restriction_mode !== 'NONE' && (
                      <div className="flex items-center gap-1">
                        <input type="number" placeholder="From" className="border p-1 rounded text-sm w-16" value={newHour.min_value} onChange={e => setNewHour({...newHour, min_value: e.target.value})} />
                        <span className="text-gray-500">-</span>
                        <input type="number" placeholder="To" className="border p-1 rounded text-sm w-16" value={newHour.max_value} onChange={e => setNewHour({...newHour, max_value: e.target.value})} />
                        <span className="text-xs text-gray-500 font-bold uppercase ml-1">{newHour.restriction_mode}</span>
                      </div>
                    )}

                    <select className="border p-1 rounded text-sm w-36 bg-white" value={newHour.gender_restriction} onChange={e => setNewHour({...newHour, gender_restriction: e.target.value})}>
                      {GENDER_RESTRICTIONS.map(g => <option key={g.id} value={g.id}>{g.name}</option>)}
                    </select>

                    <input type="text" placeholder="Title (Optional)" className="border p-1 rounded text-sm flex-1" value={newHour.title} onChange={e => setNewHour({...newHour, title: e.target.value})} />
                    
                    <button type="button" onClick={addHour} className="bg-green-600 text-white px-3 py-1 rounded text-sm hover:bg-green-700 ml-auto">+ Add Hour</button>
                  </div>
                  
                  {hourError && <p className="text-red-600 text-xs font-bold">{hourError}</p>}
                </div>

                {/* HOURS LIST */}
                <div className="space-y-2 max-h-60 overflow-y-auto">
                  {openingHours.map((hour, idx) => {
                    const dayName = WEEKDAYS.find(d => d.id === hour.weekday)?.name;
                    const cycleName = CYCLES.find(c => c.id === hour.week_cycle)?.name;
                    const genderName = GENDER_RESTRICTIONS.find(g => g.id === hour.gender_restriction)?.name || 'All Genders';
                    return (
                      <div key={idx} className="flex justify-between items-center bg-white border p-2 rounded shadow-sm text-sm">
                        <div className="flex gap-2">
                          <span className="font-bold w-24">{dayName}</span>
                          <span className="text-gray-500 text-xs uppercase w-20 pt-0.5">{cycleName}</span>
                          <span>{hour.open_time.substring(0,5)} - {hour.close_time.substring(0,5)}</span>
                        </div>
                        
                        <div className="flex gap-4 items-center">
                          {hour.restriction_mode !== 'NONE' && (
                            <span className="bg-yellow-100 text-yellow-800 px-2 py-0.5 rounded text-xs font-bold">
                              {hour.restriction_mode === 'AGE' ? 'Age' : 'Grade'} {hour.min_value}-{hour.max_value}
                            </span>
                          )}
                          {hour.gender_restriction !== 'ALL' && (
                            <span className="bg-pink-100 text-pink-800 px-2 py-0.5 rounded text-xs font-bold">
                              {genderName}
                            </span>
                          )}
                          {hour.title && <span className="text-gray-500 italic">{hour.title}</span>}
                          <button type="button" onClick={() => removeHour(idx)} className="text-red-500 font-bold px-2">√ó</button>
                        </div>
                      </div>
                    );
                  })}
                </div>
              </div>

              <div className="flex justify-end gap-4 pt-4 border-t">
                <button type="button" onClick={() => setShowModal(false)} className="text-gray-500">Cancel</button>
                <button type="submit" className="bg-blue-600 text-white px-6 py-2 rounded">{isEditing ? 'Save' : 'Create'}</button>
              </div>
            </form>
          </div>
        </div>
      )}

      {/* Delete Confirmation Modal */}
      <DeleteConfirmationModal
        isVisible={showDeleteModal}
        onClose={() => {
          if (!isDeleting) {
            setShowDeleteModal(false);
            setClubToDelete(null);
          }
        }}
        onConfirm={handleDeleteConfirm}
        itemName={clubToDelete?.name}
        isLoading={isDeleting}
      />

      {/* Toast Notification */}
      <Toast
        message={toast.message}
        type={toast.type}
        isVisible={toast.isVisible}
        onClose={() => setToast({ ...toast, isVisible: false })}
      />
    </div>
  );
}

export default function ManageClubsPage() {
  return <Suspense fallback={<div>Loading...</div>}><ManageClubsPageContent /></Suspense>;
}

--- END OF FILE: ./frontend/app/admin/super/clubs/page.tsx ---


--- START OF FILE: ./frontend/app/admin/super/clubs/[id]/page.tsx ---
'use client';

import { useState, useEffect, Suspense, useMemo } from 'react';
import { useRouter, useParams } from 'next/navigation';
import Link from 'next/link';
import Script from 'next/script';
import { GoogleMap, Marker, LoadScript } from '@react-google-maps/api';
import api from '../../../../../lib/api';
import { getMediaUrl } from '../../../../utils';

const WEEKDAYS = [
  { id: 1, name: 'Monday' }, { id: 2, name: 'Tuesday' }, { id: 3, name: 'Wednesday' },
  { id: 4, name: 'Thursday' }, { id: 5, name: 'Friday' }, { id: 6, name: 'Saturday' }, { id: 7, name: 'Sunday' },
];

const CYCLES = [
  { id: 'ALL', name: 'Every Week' },
  { id: 'ODD', name: 'Odd Weeks' },
  { id: 'EVEN', name: 'Even Weeks' },
];

function ClubViewPageContent() {
  const router = useRouter();
  const params = useParams();
  const clubId = params?.id as string;

  const [club, setClub] = useState<any>(null);
  const [isLoading, setIsLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);

  useEffect(() => {
    if (clubId) {
      fetchClub();
    }
  }, [clubId]);

  const fetchClub = async () => {
    setIsLoading(true);
    setError(null);
    try {
      const res = await api.get(`/clubs/${clubId}/`);
      setClub(res.data);
    } catch (err: any) {
      setError(err?.response?.status === 404 ? 'Club not found' : 'Failed to load club');
      console.error(err);
    } finally {
      setIsLoading(false);
    }
  };

  if (isLoading) {
    return (
      <div className="p-8 text-center">
        <p className="text-gray-500">Loading club details...</p>
      </div>
    );
  }

  if (error || !club) {
    return (
      <div className="p-8">
        <div className="bg-red-50 border border-red-200 rounded-lg p-4 mb-4">
          <p className="text-red-800">{error || 'Club not found'}</p>
        </div>
        <Link href="/admin/super/clubs" className="text-blue-600 hover:text-blue-800">
          ‚Üê Back to Clubs
        </Link>
      </div>
    );
  }

  return (
    <div className="p-8">
      {/* HEADER */}
      <div className="flex items-center justify-between mb-6">
        <Link href="/admin/super/clubs" className="text-blue-600 hover:text-blue-800 font-medium">
          ‚Üê Back to Clubs
        </Link>
        <div className="flex gap-4">
          <button
            onClick={() => router.push(`/admin/super/clubs?edit=${club.id}`)}
            className="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700"
          >
            Edit Club
          </button>
        </div>
      </div>

      {/* CLUB HEADER */}
      <div className="bg-white rounded-xl shadow-lg overflow-hidden mb-6">
        <div className="relative">
          {club.hero_image && (
            <img
              src={getMediaUrl(club.hero_image) || ''}
              alt={club.name}
              className="w-full h-64 object-cover"
              onError={(e) => (e.target as HTMLImageElement).style.display = 'none'}
            />
          )}
          <div className={`p-8 ${club.hero_image ? 'absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/70 to-transparent' : ''}`}>
            <div className="flex items-end gap-6">
              {club.avatar && (
                <img
                  src={getMediaUrl(club.avatar) || ''}
                  alt={club.name}
                  className={`w-24 h-24 rounded-full object-cover border-4 ${club.hero_image ? 'border-white' : 'border-gray-200'}`}
                  onError={(e) => (e.target as HTMLImageElement).style.display = 'none'}
                />
              )}
              <div className={club.hero_image ? 'text-white' : ''}>
                <h1 className="text-4xl font-bold mb-2">{club.name}</h1>
                <p className="text-lg opacity-90">{club.municipality_name}</p>
                {club.address && (
                  <p className="text-sm opacity-80 mt-2">üìç {club.address}</p>
                )}
              </div>
            </div>
          </div>
        </div>
      </div>

      <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
        {/* MAIN CONTENT */}
        <div className="lg:col-span-2 space-y-6">
          {/* DESCRIPTION */}
          <div className="bg-white rounded-xl shadow p-6">
            <h2 className="text-2xl font-bold text-gray-800 mb-4">About</h2>
            <p className="text-gray-700 whitespace-pre-wrap">{club.description || 'No description provided.'}</p>
          </div>

          {/* CONTACT INFO */}
          <div className="bg-white rounded-xl shadow p-6">
            <h2 className="text-2xl font-bold text-gray-800 mb-4">Contact Information</h2>
            <div className="grid grid-cols-2 gap-4">
              <div>
                <p className="text-sm text-gray-500 font-bold uppercase">Email</p>
                <p className="font-medium">{club.email || '-'}</p>
              </div>
              <div>
                <p className="text-sm text-gray-500 font-bold uppercase">Phone</p>
                <p className="font-medium">{club.phone || '-'}</p>
              </div>
              {club.address && (
                <div className="col-span-2">
                  <p className="text-sm text-gray-500 font-bold uppercase">Address</p>
                  <p className="font-medium">{club.address}</p>
                </div>
              )}
              {(club.latitude && club.longitude) && (
                <div className="col-span-2">
                  <p className="text-sm text-gray-500 font-bold uppercase mb-2">Location</p>
                  <p className="text-sm text-gray-600 mb-2">Coordinates: {club.latitude}, {club.longitude}</p>
                  <a
                    href={`https://www.google.com/maps?q=${club.latitude},${club.longitude}`}
                    target="_blank"
                    rel="noopener noreferrer"
                    className="text-blue-600 hover:text-blue-800 underline text-sm mb-3 inline-block"
                  >
                    Open in Google Maps ‚Üí
                  </a>
                </div>
              )}
            </div>
          </div>

          {/* GOOGLE MAP */}
          {club.latitude && club.longitude && (
            <div className="bg-white rounded-xl shadow p-6">
              <h2 className="text-2xl font-bold text-gray-800 mb-4">Map Location</h2>
              {process.env.NEXT_PUBLIC_GOOGLE_MAPS_API_KEY ? (
                <div className="w-full h-96 rounded-lg overflow-hidden border border-gray-200">
                  <LoadScript googleMapsApiKey={process.env.NEXT_PUBLIC_GOOGLE_MAPS_API_KEY}>
                    <GoogleMap
                      mapContainerStyle={{ width: '100%', height: '100%' }}
                      center={{
                        lat: parseFloat(club.latitude),
                        lng: parseFloat(club.longitude)
                      }}
                      zoom={15}
                      options={{
                        zoomControl: true,
                        streetViewControl: true,
                        mapTypeControl: true,
                        fullscreenControl: true,
                      }}
                    >
                      <Marker
                        position={{
                          lat: parseFloat(club.latitude),
                          lng: parseFloat(club.longitude)
                        }}
                        title={club.name}
                      />
                    </GoogleMap>
                  </LoadScript>
                </div>
              ) : (
                <div className="w-full h-96 rounded-lg overflow-hidden border border-gray-200 bg-gray-100 flex items-center justify-center">
                  <div className="text-center p-4">
                    <p className="text-gray-600 mb-2">Google Maps API key not configured</p>
                    <p className="text-sm text-gray-500">Add NEXT_PUBLIC_GOOGLE_MAPS_API_KEY to your .env.local file</p>
                    <a
                      href={`https://www.google.com/maps?q=${club.latitude},${club.longitude}`}
                      target="_blank"
                      rel="noopener noreferrer"
                      className="text-blue-600 hover:text-blue-800 underline text-sm mt-2 inline-block"
                    >
                      Open in Google Maps instead ‚Üí
                    </a>
                  </div>
                </div>
              )}
            </div>
          )}

          {/* OPENING HOURS */}
          {club.regular_hours && club.regular_hours.length > 0 && (
            <div className="bg-white rounded-xl shadow p-6">
              <h2 className="text-2xl font-bold text-gray-800 mb-4">Opening Hours</h2>
              <div className="space-y-3">
                {club.regular_hours.map((hour: any, idx: number) => {
                  const dayName = WEEKDAYS.find(d => d.id === hour.weekday)?.name;
                  const cycleName = CYCLES.find(c => c.id === hour.week_cycle)?.name;
                  const timeStr = `${hour.open_time.substring(0,5)} - ${hour.close_time.substring(0,5)}`;
                  
                  return (
                    <div key={idx} className="border rounded-lg p-4 hover:bg-gray-50 transition">
                      <div className="flex justify-between items-start">
                        <div className="flex-1">
                          <div className="flex items-center gap-3 mb-2">
                            <span className="font-bold text-gray-900 w-28">{dayName}</span>
                            <span className="text-xs text-gray-500 uppercase bg-gray-100 px-2 py-1 rounded">{cycleName}</span>
                            <span className="text-gray-700 font-medium">{timeStr}</span>
                          </div>
                          {hour.title && (
                            <p className="text-sm text-gray-600 italic ml-28">{hour.title}</p>
                          )}
                          {hour.description && (
                            <p className="text-xs text-gray-500 mt-1 ml-28">{hour.description}</p>
                          )}
                        </div>
                        <div className="flex gap-2 items-center">
                          {hour.restriction_mode !== 'NONE' && hour.min_value && hour.max_value && (
                            <span className="bg-yellow-100 text-yellow-800 px-2 py-1 rounded text-xs font-bold">
                              {hour.restriction_mode === 'AGE' ? 'Age' : 'Grade'} {hour.min_value}-{hour.max_value}
                            </span>
                          )}
                          {hour.gender_restriction !== 'ALL' && (
                            <span className="bg-blue-100 text-blue-800 px-2 py-1 rounded text-xs font-bold">
                              {hour.gender_restriction}
                            </span>
                          )}
                        </div>
                      </div>
                    </div>
                  );
                })}
              </div>
            </div>
          )}

          {/* LEGAL DOCUMENTS */}
          {(club.terms_and_conditions || club.club_policies) && (
            <div className="bg-white rounded-xl shadow p-6">
              <h2 className="text-2xl font-bold text-gray-800 mb-4">Legal Documents</h2>
              <div className="space-y-4">
                {club.terms_and_conditions && (
                  <div>
                    <h3 className="text-lg font-bold text-gray-700 mb-2">Terms & Conditions</h3>
                    <p className="text-sm text-gray-600 whitespace-pre-wrap">{club.terms_and_conditions}</p>
                  </div>
                )}
                {club.club_policies && (
                  <div>
                    <h3 className="text-lg font-bold text-gray-700 mb-2">Club Policies</h3>
                    <p className="text-sm text-gray-600 whitespace-pre-wrap">{club.club_policies}</p>
                  </div>
                )}
              </div>
            </div>
          )}
        </div>

        {/* SIDEBAR */}
        <div className="space-y-6">
          {/* QUICK INFO */}
          <div className="bg-white rounded-xl shadow p-6">
            <h3 className="text-lg font-bold text-gray-800 mb-4">Quick Info</h3>
            <div className="space-y-3">
              {club.club_categories && (
                <div>
                  <p className="text-xs text-gray-500 font-bold uppercase">Categories</p>
                  <p className="text-sm font-medium">{club.club_categories}</p>
                </div>
              )}
              {club.allowed_age_groups && (
                <div>
                  <p className="text-xs text-gray-500 font-bold uppercase">Age Groups</p>
                  <p className="text-sm font-medium">{club.allowed_age_groups}</p>
                </div>
              )}
            </div>
          </div>

          {/* ACTIONS */}
          <div className="bg-white rounded-xl shadow p-6">
            <h3 className="text-lg font-bold text-gray-800 mb-4">Actions</h3>
            <div className="space-y-2">
              <button
                onClick={() => router.push(`/admin/super/clubs?edit=${club.id}`)}
                className="w-full bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 text-center"
              >
                Edit Club
              </button>
              <Link
                href="/admin/super/clubs"
                className="block w-full bg-gray-100 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-200 text-center"
              >
                Back to List
              </Link>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
}

export default function ClubViewPage() {
  return (
    <Suspense fallback={<div className="p-8 text-center">Loading...</div>}>
      <ClubViewPageContent />
    </Suspense>
  );
}


--- END OF FILE: ./frontend/app/admin/super/clubs/[id]/page.tsx ---


--- START OF FILE: ./frontend/app/admin/super/rewards/page.tsx ---
'use client';

import RewardManager from '../../../components/RewardManager';

export default function SuperAdminRewardsPage() {
  return (
    <div className="max-w-7xl mx-auto p-4">
      <RewardManager basePath="/admin/super/rewards" />
    </div>
  );
}
--- END OF FILE: ./frontend/app/admin/super/rewards/page.tsx ---


--- START OF FILE: ./frontend/app/admin/super/rewards/edit/[id]/page.tsx ---
'use client';

import { useState, useEffect } from 'react';
import { useParams } from 'next/navigation';
import api from '@/lib/api'; 
import RewardForm from '@/app/components/RewardForm';

export default function EditRewardPage() {
  const params = useParams();
  const id = params?.id as string;
  
  const [reward, setReward] = useState(null);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    if (id) {
      api.get(`/rewards/${id}/`)
        .then(res => {
          setReward(res.data);
          setLoading(false);
        })
        .catch(err => {
          console.error(err);
          setLoading(false);
        });
    }
  }, [id]);

  if (loading) return <div className="p-12 text-center text-gray-500">Loading reward...</div>;
  if (!reward) return <div className="p-12 text-center text-red-500">Reward not found.</div>;

  return (
    <div className="max-w-5xl mx-auto p-4">
      <div className="mb-8">
        <h1 className="text-3xl font-bold text-gray-900">Edit Reward</h1>
      </div>
      
      <RewardForm 
        initialData={reward} 
        redirectPath="/admin/super/rewards" 
      />
    </div>
  );
}
--- END OF FILE: ./frontend/app/admin/super/rewards/edit/[id]/page.tsx ---


--- START OF FILE: ./frontend/app/admin/super/rewards/[id]/page.tsx ---
'use client';

import { useParams } from 'next/navigation';
import RewardDetailView from '@/app/components/RewardDetailView';

export default function RewardDetailPage() {
  const params = useParams();
  const id = params?.id as string;

  return (
    <div className="max-w-7xl mx-auto p-4">
      <RewardDetailView 
        rewardId={id} 
        basePath="/admin/super/rewards" 
      />
    </div>
  );
}
--- END OF FILE: ./frontend/app/admin/super/rewards/[id]/page.tsx ---


--- START OF FILE: ./frontend/app/admin/super/rewards/create/page.tsx ---
'use client';

import RewardForm from '../../../../components/RewardForm';

export default function CreateRewardPage() {
  return (
    <div className="max-w-5xl mx-auto p-4">
      <div className="mb-8">
        <h1 className="text-3xl font-bold text-gray-900">Create New Reward</h1>
        <p className="text-gray-500">
          Rewards can be targeted to specific groups, demographics, or triggered automatically.
        </p>
      </div>
      
      {/* Reuse the component we just made */}
      <RewardForm redirectPath="/admin/super/rewards" />
    </div>
  );
}
--- END OF FILE: ./frontend/app/admin/super/rewards/create/page.tsx ---


--- START OF FILE: ./frontend/app/admin/super/admins/page.tsx ---
'use client';

import { useState, useEffect, Suspense } from 'react';
import { useRouter, useSearchParams, usePathname } from 'next/navigation';
import api from '../../../../lib/api';
import { getMediaUrl } from '../../../utils';
import Toast from '../../../components/Toast';
import { useAuth } from '../../../../context/AuthContext';
import DeleteConfirmationModal from '../../../components/DeleteConfirmationModal';

interface Option { id: number; name: string; }

// Define the shape of our stats data
interface AdminStats {
  total_admins: number;
  roles: { super: number; municipality: number; club: number };
  gender: { male: number; female: number; other: number };
  activity: { active_7_days: number; new_30_days: number };
}

function ManageAdminsPageContent() {
  const router = useRouter();
  const pathname = usePathname();
  const searchParams = useSearchParams();
  const { user: currentUser } = useAuth();

  // --- STATE ---
  const [users, setUsers] = useState<any[]>([]);
  const [totalCount, setTotalCount] = useState(0); 
  const [isLoading, setIsLoading] = useState(true);
  
  // Stats State
  const [stats, setStats] = useState<AdminStats | null>(null);
  const [analyticsExpanded, setAnalyticsExpanded] = useState(true);
  const [avatarErrors, setAvatarErrors] = useState<Set<number>>(new Set());
  
  // Toast State
  const [toast, setToast] = useState<{ message: string; type: 'success' | 'error' | 'info' | 'warning'; isVisible: boolean }>({
    message: '',
    type: 'success',
    isVisible: false,
  });

  // Modal & Form State
  const [showModal, setShowModal] = useState(false);
  const [isEditing, setIsEditing] = useState(false);
  const [editUserId, setEditUserId] = useState<number | null>(null);
  const [municipalities, setMunicipalities] = useState<Option[]>([]);
  const [clubs, setClubs] = useState<Option[]>([]);
  
  // Delete Confirmation Modal State
  const [showDeleteModal, setShowDeleteModal] = useState(false);
  const [userToDelete, setUserToDelete] = useState<{ id: number; name: string } | null>(null);
  const [isDeleting, setIsDeleting] = useState(false);

  const initialFormState = {
    email: '', password: '', first_name: '', last_name: '', nickname: '',
    legal_gender: 'MALE', phone_number: '', profession: '',
    assigned_municipality: '', assigned_club: '', hide_contact_info: false
  };

  const [formData, setFormData] = useState(initialFormState);
  const [adminType, setAdminType] = useState('MUNICIPALITY_ADMIN');
  const [avatarFile, setAvatarFile] = useState<File | null>(null);
  const [avatarPreview, setAvatarPreview] = useState<string | null>(null);

  // --- INITIAL DATA LOAD ---
  useEffect(() => {
    fetchDropdowns();
    fetchStats(); // Fetch analytics on load
  }, []);

  // --- FETCH LIST WHEN URL CHANGES ---
  useEffect(() => {
    fetchAdmins();
  }, [searchParams]);

  const fetchStats = async () => {
    try {
      const res = await api.get('/users/stats/');
      setStats(res.data);
    } catch (err) {
      console.error("Failed to load stats", err);
    }
  };

  const fetchAdmins = async () => {
    setIsLoading(true);
    try {
      const adminRoles = ['SUPER_ADMIN', 'MUNICIPALITY_ADMIN', 'CLUB_ADMIN'];
      const roleFilter = searchParams.get('role');
      
      // If a specific admin role is selected, fetch only that role
      if (roleFilter && adminRoles.includes(roleFilter)) {
        const params = new URLSearchParams();
        params.set('role', roleFilter);
        
        // Copy other allowed filters
        const municipality = searchParams.get('assigned_municipality');
        if (municipality) params.set('assigned_municipality', municipality);
        
        const club = searchParams.get('assigned_club');
        if (club) params.set('assigned_club', club);
        
        const gender = searchParams.get('legal_gender');
        if (gender) params.set('legal_gender', gender);
        
        const search = searchParams.get('search');
        if (search) params.set('search', search);
        
        const page = searchParams.get('page');
        if (page) params.set('page', page);
        
        const res = await api.get(`/users/?${params.toString()}`);
        setUsers(res.data.results || []);
        setTotalCount(res.data.count);
      } else {
        // When showing all admins (no role filter), fetch all admin roles and combine
        // We need to fetch each role separately and combine results
        const municipality = searchParams.get('assigned_municipality');
        const club = searchParams.get('assigned_club');
        const gender = searchParams.get('legal_gender');
        const search = searchParams.get('search');
        const page = Number(searchParams.get('page')) || 1;
        const pageSize = 10;
        
        // Fetch all admin roles in parallel
        const promises = adminRoles.map(role => {
          const params = new URLSearchParams();
          params.set('role', role);
          if (municipality) params.set('assigned_municipality', municipality);
          if (club) params.set('assigned_club', club);
          if (gender) params.set('legal_gender', gender);
          if (search) params.set('search', search);
          // Fetch all pages for each role (we'll paginate on frontend)
          params.set('page_size', '1000'); // Large number to get all
          return api.get(`/users/?${params.toString()}`);
        });
        
        const results = await Promise.all(promises);
        
        // Combine all admin users
        let allAdmins: any[] = [];
        results.forEach(res => {
          if (res.data.results) {
            allAdmins = allAdmins.concat(res.data.results);
          }
        });
        
        // Apply frontend pagination
        const startIndex = (page - 1) * pageSize;
        const endIndex = startIndex + pageSize;
        const paginatedAdmins = allAdmins.slice(startIndex, endIndex);
        
        setUsers(paginatedAdmins);
        setTotalCount(allAdmins.length);
      }
    } catch (err) {
      console.error(err);
    } finally {
      setIsLoading(false);
    }
  };

  const fetchDropdowns = async () => {
    try {
      const muniRes = await api.get('/municipalities/');
      setMunicipalities(Array.isArray(muniRes.data) ? muniRes.data : (muniRes.data?.results || []));
      const clubRes = await api.get('/clubs/');
      setClubs(Array.isArray(clubRes.data) ? clubRes.data : (clubRes.data?.results || []));
    } catch (err) {
      console.error(err);
    }
  };

  const updateUrl = (key: string, value: string) => {
    const params = new URLSearchParams(searchParams.toString());
    
    // If updating role, ensure it's a valid admin role
    if (key === 'role') {
      const adminRoles = ['SUPER_ADMIN', 'MUNICIPALITY_ADMIN', 'CLUB_ADMIN'];
      if (value && adminRoles.includes(value)) {
        params.set(key, value);
      } else {
        params.delete(key); // Remove invalid role filter
      }
    } else {
      if (value) params.set(key, value);
      else params.delete(key);
    }
    
    if (key !== 'page') params.set('page', '1');
    router.push(`${pathname}?${params.toString()}`);
  };

  // --- ACTIONS ---

  const handleOpenCreate = () => {
    setIsEditing(false);
    setEditUserId(null);
    setFormData(initialFormState);
    setAdminType('MUNICIPALITY_ADMIN');
    setAvatarFile(null);
    setAvatarPreview(null);
    setShowModal(true);
  };

  const handleOpenEdit = (user: any) => {
    setIsEditing(true);
    setEditUserId(user.id);
    setAdminType(user.role);
    setFormData({
      email: user.email, password: '', 
      first_name: user.first_name || '', last_name: user.last_name || '',
      nickname: user.nickname || '', legal_gender: user.legal_gender || 'MALE',
      phone_number: user.phone_number || '', profession: user.profession || '',
      assigned_municipality: user.assigned_municipality || '', assigned_club: user.assigned_club || '',
      hide_contact_info: user.hide_contact_info || false
    });
    setAvatarFile(null);
    setAvatarPreview(user.avatar ? getMediaUrl(user.avatar) : null);
    setShowModal(true);
  };

  const handleDeleteClick = (user: any) => {
    // Prevent admins from deleting themselves
    if (currentUser && currentUser.id === user.id) {
      setToast({
        message: 'You cannot delete your own account.',
        type: 'warning',
        isVisible: true,
      });
      return;
    }

    setUserToDelete({ id: user.id, name: `${user.first_name} ${user.last_name}` });
    setShowDeleteModal(true);
  };

  const handleDeleteConfirm = async () => {
    if (!userToDelete) return;

    setIsDeleting(true);
    try {
      await api.delete(`/users/${userToDelete.id}/`);
      setToast({
        message: 'Admin deleted successfully!',
        type: 'success',
        isVisible: true,
      });
      setShowDeleteModal(false);
      setUserToDelete(null);
      fetchAdmins();
      fetchStats(); // Update stats after delete
    } catch (err) { 
      setToast({
        message: 'Failed to delete admin.',
        type: 'error',
        isVisible: true,
      });
    } finally {
      setIsDeleting(false);
    }
  };

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    try {
      const data = new FormData();
      Object.entries(formData).forEach(([key, value]) => {
        if (key === 'password' && !value) return; 
        data.append(key, value.toString());
      });
      data.append('role', adminType);
      if (avatarFile) data.append('avatar', avatarFile);

      const config = { headers: { 'Content-Type': 'multipart/form-data' } };
      if (isEditing && editUserId) {
        await api.patch(`/users/${editUserId}/`, data, config);
        setToast({
          message: 'Admin updated successfully!',
          type: 'success',
          isVisible: true,
        });
      } else {
        await api.post('/users/', data, config);
        setToast({
          message: 'Admin created successfully!',
          type: 'success',
          isVisible: true,
        });
      }

      setShowModal(false);
      setAvatarFile(null);
      setAvatarPreview(null);
      fetchAdmins();
      fetchStats(); // Update stats after create/edit
    } catch (err) { 
      setToast({
        message: 'Operation failed. Please try again.',
        type: 'error',
        isVisible: true,
      });
      console.error(err);
    }
  };

  const handleAvatarChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (file) {
      const validTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/svg+xml', 'image/gif'];
      if (!validTypes.includes(file.type)) {
        alert('Please select a valid image file (jpg, png, svg, or gif)');
        return;
      }
      setAvatarFile(file);
      const reader = new FileReader();
      reader.onloadend = () => setAvatarPreview(reader.result as string);
      reader.readAsDataURL(file);
    }
  };

  // Helper function to get initials from name
  const getInitials = (firstName: string = '', lastName: string = '') => {
    const first = firstName?.charAt(0)?.toUpperCase() || '';
    const last = lastName?.charAt(0)?.toUpperCase() || '';
    return first + last || '?';
  };

  // Helper function to get avatar color (consistent for all roles)
  const getAvatarColor = () => {
    return 'bg-blue-200 text-blue-800';
  };

  const currentPage = Number(searchParams.get('page')) || 1;
  const totalPages = Math.ceil(totalCount / 10);

  return (
    <div>
      <div className="flex justify-between items-center mb-6">
        <h1 className="text-2xl font-bold text-gray-800">Manage Administrators</h1>
        <button onClick={handleOpenCreate} className="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 shadow">
          + Create New Admin
        </button>
      </div>

      {/* --- ANALYTICS HUD --- */}
      {stats && (
        <div className="mb-6">
          {/* Toggle Button */}
          <button
            onClick={() => setAnalyticsExpanded(!analyticsExpanded)}
            className="flex items-center justify-between w-full bg-white rounded-lg shadow-sm border border-gray-200 p-3 hover:bg-gray-50 transition-colors mb-3"
          >
            <div className="flex items-center gap-2">
              <svg className="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
              </svg>
              <span className="text-sm font-semibold text-gray-700">Analytics Dashboard</span>
            </div>
            <svg 
              className={`w-5 h-5 text-gray-600 transition-transform duration-200 ${analyticsExpanded ? 'rotate-180' : ''}`}
              fill="none" 
              stroke="currentColor" 
              viewBox="0 0 24 24"
            >
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
            </svg>
          </button>

          {/* Analytics Cards - Collapsible */}
          <div 
            className={`grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 transition-all duration-500 ease-in-out ${
              analyticsExpanded 
                ? 'max-h-[600px] opacity-100 translate-y-0' 
                : 'max-h-0 opacity-0 -translate-y-4 pointer-events-none'
            } overflow-hidden`}
          >
              {/* Card 1: Total */}
              <div className="bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl shadow-md p-4 text-white transform hover:scale-105 transition-all duration-200">
                <div className="flex items-center justify-between mb-2">
                  <div className="bg-white/20 rounded-lg p-2">
                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                    </svg>
                  </div>
                </div>
                <h3 className="text-blue-100 text-xs font-semibold uppercase tracking-wider mb-1">Total Admins</h3>
                <p className="text-3xl font-bold mb-0.5">{stats.total_admins}</p>
                <p className="text-blue-100 text-xs">Active administrators</p>
              </div>

              {/* Card 2: Roles */}
              <div className="bg-white rounded-xl shadow-md p-4 border border-gray-100 hover:shadow-lg transition-all duration-200">
                <div className="flex items-center justify-between mb-2">
                  <h3 className="text-gray-600 text-xs font-bold uppercase tracking-wider">Role Distribution</h3>
                  <div className="bg-purple-100 rounded-lg p-1.5">
                    <svg className="w-4 h-4 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
                    </svg>
                  </div>
                </div>
                <div className="space-y-2">
                  <div className="flex items-center justify-between p-1.5 bg-red-50 rounded-lg">
                    <div className="flex items-center gap-1.5">
                      <div className="w-1.5 h-1.5 bg-red-500 rounded-full"></div>
                      <span className="text-xs text-gray-700 font-medium">Super</span>
                    </div>
                    <span className="text-base font-bold text-red-600">{stats.roles.super}</span>
                  </div>
                  <div className="flex items-center justify-between p-1.5 bg-purple-50 rounded-lg">
                    <div className="flex items-center gap-1.5">
                      <div className="w-1.5 h-1.5 bg-purple-500 rounded-full"></div>
                      <span className="text-xs text-gray-700 font-medium">Municipality</span>
                    </div>
                    <span className="text-base font-bold text-purple-600">{stats.roles.municipality}</span>
                  </div>
                  <div className="flex items-center justify-between p-1.5 bg-green-50 rounded-lg">
                    <div className="flex items-center gap-1.5">
                      <div className="w-1.5 h-1.5 bg-green-500 rounded-full"></div>
                      <span className="text-xs text-gray-700 font-medium">Club</span>
                    </div>
                    <span className="text-base font-bold text-green-600">{stats.roles.club}</span>
                  </div>
                </div>
              </div>

              {/* Card 3: Gender */}
              <div className="bg-white rounded-xl shadow-md p-4 border border-gray-100 hover:shadow-lg transition-all duration-200">
                <div className="flex items-center justify-between mb-2">
                  <h3 className="text-gray-600 text-xs font-bold uppercase tracking-wider">Gender Split</h3>
                  <div className="bg-pink-100 rounded-lg p-1.5">
                    <svg className="w-4 h-4 text-pink-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" />
                    </svg>
                  </div>
                </div>
                <div className="space-y-2">
                  <div className="flex items-center justify-between p-1.5 bg-blue-50 rounded-lg">
                    <div className="flex items-center gap-1.5">
                      <div className="w-1.5 h-1.5 bg-blue-500 rounded-full"></div>
                      <span className="text-xs text-gray-700 font-medium">Male</span>
                    </div>
                    <span className="text-base font-bold text-blue-600">{stats.gender.male}</span>
                  </div>
                  <div className="flex items-center justify-between p-1.5 bg-pink-50 rounded-lg">
                    <div className="flex items-center gap-1.5">
                      <div className="w-1.5 h-1.5 bg-pink-500 rounded-full"></div>
                      <span className="text-xs text-gray-700 font-medium">Female</span>
                    </div>
                    <span className="text-base font-bold text-pink-600">{stats.gender.female}</span>
                  </div>
                  <div className="flex items-center justify-between p-1.5 bg-gray-50 rounded-lg">
                    <div className="flex items-center gap-1.5">
                      <div className="w-1.5 h-1.5 bg-gray-500 rounded-full"></div>
                      <span className="text-xs text-gray-700 font-medium">Other</span>
                    </div>
                    <span className="text-base font-bold text-gray-600">{stats.gender.other}</span>
                  </div>
                </div>
              </div>

              {/* Card 4: Activity */}
              <div className="bg-gradient-to-br from-orange-500 to-orange-600 rounded-xl shadow-md p-4 text-white transform hover:scale-105 transition-all duration-200">
                <div className="flex items-center justify-between mb-2">
                  <div className="bg-white/20 rounded-lg p-2">
                    <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" />
                    </svg>
                  </div>
                </div>
                <h3 className="text-orange-100 text-xs font-semibold uppercase tracking-wider mb-3">Engagement</h3>
                <div className="space-y-2">
                  <div className="bg-white/20 rounded-lg p-2 backdrop-blur-sm">
                    <div className="flex items-center justify-between mb-1">
                      <span className="text-orange-100 text-xs font-medium">Active (7d)</span>
                      <span className="text-xl font-bold">{stats.activity.active_7_days}</span>
                    </div>
                    <div className="w-full bg-white/30 rounded-full h-1 mt-1.5">
                      <div 
                        className="bg-white rounded-full h-1 transition-all duration-500"
                        style={{ width: `${Math.min((stats.activity.active_7_days / stats.total_admins) * 100, 100)}%` }}
                      ></div>
                    </div>
                  </div>
                  <div className="bg-white/20 rounded-lg p-2 backdrop-blur-sm">
                    <div className="flex items-center justify-between mb-1">
                      <span className="text-orange-100 text-xs font-medium">New (30d)</span>
                      <span className="text-xl font-bold">{stats.activity.new_30_days}</span>
                    </div>
                    <div className="w-full bg-white/30 rounded-full h-1 mt-1.5">
                      <div 
                        className="bg-white rounded-full h-1 transition-all duration-500"
                        style={{ width: `${Math.min((stats.activity.new_30_days / stats.total_admins) * 100, 100)}%` }}
                      ></div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
      )}

      {/* --- FILTER BAR --- */}
      <div className="bg-white p-4 rounded-lg shadow mb-6 border border-gray-100">
        <div className="flex flex-wrap gap-4 items-end">
          <div className="flex-1 min-w-[200px]">
            <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Search</label>
            <input
              type="text"
              placeholder="Search by name or email..."
              className="w-full border rounded p-2 text-sm bg-gray-50"
              value={searchParams.get('search') || ''}
              onChange={(e) => {
                const value = e.target.value;
                if (value.trim()) {
                  updateUrl('search', value.trim());
                } else {
                  const params = new URLSearchParams(searchParams.toString());
                  params.delete('search');
                  params.set('page', '1');
                  router.push(`${pathname}?${params.toString()}`);
                }
              }}
            />
          </div>

          <div className="w-48">
            <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Role</label>
            <select className="w-full border rounded p-2 text-sm bg-gray-50" value={searchParams.get('role') || ''} onChange={(e) => updateUrl('role', e.target.value)}>
              <option value="">All Roles</option>
              <option value="SUPER_ADMIN">Super Admin</option>
              <option value="MUNICIPALITY_ADMIN">Municipality Admin</option>
              <option value="CLUB_ADMIN">Club Admin</option>
            </select>
          </div>

          <div className="w-48">
            <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Municipality</label>
            <select className="w-full border rounded p-2 text-sm bg-gray-50" value={searchParams.get('assigned_municipality') || ''} onChange={(e) => updateUrl('assigned_municipality', e.target.value)}>
              <option value="">All Municipalities</option>
              {Array.isArray(municipalities) && municipalities.map(m => <option key={m.id} value={m.id.toString()}>{m.name}</option>)}
            </select>
          </div>

          <div className="w-48">
            <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Club</label>
            <select className="w-full border rounded p-2 text-sm bg-gray-50" value={searchParams.get('assigned_club') || ''} onChange={(e) => updateUrl('assigned_club', e.target.value)}>
              <option value="">All Clubs</option>
              {Array.isArray(clubs) && clubs.map(c => <option key={c.id} value={c.id.toString()}>{c.name}</option>)}
            </select>
          </div>

          <div className="w-32">
            <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Gender</label>
            <select className="w-full border rounded p-2 text-sm bg-gray-50" value={searchParams.get('legal_gender') || ''} onChange={(e) => updateUrl('legal_gender', e.target.value)}>
              <option value="">Any</option>
              <option value="MALE">Male</option>
              <option value="FEMALE">Female</option>
              <option value="OTHER">Other</option>
            </select>
          </div>

          <button onClick={() => router.push(pathname)} className="px-4 py-2 text-sm text-gray-500 hover:text-red-500 font-medium pb-2.5">
            Clear Filters
          </button>
        </div>
      </div>

      {/* --- LIST --- */}
      <div className="bg-white rounded-lg shadow overflow-hidden mb-6">
        {isLoading ? (
          <div className="p-8 text-center text-gray-500">Loading admins...</div>
        ) : users.length === 0 ? (
          <div className="p-8 text-center text-gray-500">No results found.</div>
        ) : (
          <table className="min-w-full divide-y divide-gray-200">
            <thead className="bg-gray-50">
              <tr>
                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">User</th>
                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Role</th>
                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Context</th>
                <th className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">Actions</th>
              </tr>
            </thead>
            <tbody className="bg-white divide-y divide-gray-200">
              {users.map((user) => (
                <tr key={user.id}>
                  <td className="px-6 py-4 whitespace-nowrap">
                    <div className="flex items-center">
                      {user.avatar && !avatarErrors.has(user.id) ? (
                        <img 
                          src={getMediaUrl(user.avatar) || ''}
                          alt="Avatar"
                          className="w-10 h-10 rounded-full object-cover mr-3"
                          onError={() => {
                            setAvatarErrors(prev => new Set(prev).add(user.id));
                          }}
                        />
                      ) : (
                        <div className={`w-10 h-10 rounded-full ${getAvatarColor()} flex items-center justify-center font-semibold text-sm mr-3`}>
                          {getInitials(user.first_name, user.last_name)}
                        </div>
                      )}
                      <div>
                        <div className="text-sm font-medium text-gray-900">{user.first_name} {user.last_name}</div>
                        <div className="text-sm text-gray-500">{user.email}</div>
                      </div>
                    </div>
                  </td>
                  <td className="px-6 py-4 whitespace-nowrap">
                    <span className={`px-2 inline-flex text-xs leading-5 font-semibold rounded-full 
                      ${user.role === 'SUPER_ADMIN' ? 'bg-red-100 text-red-800' : 
                        user.role === 'MUNICIPALITY_ADMIN' ? 'bg-purple-100 text-purple-800' : 
                        'bg-green-100 text-green-800'}`}>
                      {user.role.replace('_', ' ')}
                    </span>
                  </td>
                  <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                    {user.role === 'MUNICIPALITY_ADMIN' && (
                       Array.isArray(municipalities) ? municipalities.find(m => m.id === user.assigned_municipality)?.name || 'Unassigned' : 'Unassigned'
                    )}
                    {user.role === 'CLUB_ADMIN' && (
                       Array.isArray(clubs) ? clubs.find(c => c.id === user.assigned_club)?.name || 'Unassigned' : 'Unassigned'
                    )}
                    {user.role === 'SUPER_ADMIN' && 'Global'}
                  </td>
                  <td className="px-6 py-4 whitespace-nowrap text-right text-sm font-medium space-x-4">
                    <button onClick={() => handleOpenEdit(user)} className="text-indigo-600 hover:text-indigo-900 font-bold">Edit</button>
                    <button onClick={() => handleDeleteClick(user)} className="text-red-600 hover:text-red-900">Delete</button>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        )}
      </div>

      {/* --- PAGINATION CONTROLS (KEPT EXISTING) --- */}
      <div className="flex items-center justify-between border-t border-gray-200 bg-white px-4 py-3 sm:px-6 rounded-lg shadow">
        <div className="flex flex-1 justify-between sm:hidden">
          <button 
            disabled={currentPage === 1}
            onClick={() => updateUrl('page', (currentPage - 1).toString())}
            className="relative inline-flex items-center rounded-md border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50 disabled:opacity-50"
          >
            Previous
          </button>
          <button 
            disabled={currentPage >= totalPages}
            onClick={() => updateUrl('page', (currentPage + 1).toString())}
            className="relative ml-3 inline-flex items-center rounded-md border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50 disabled:opacity-50"
          >
            Next
          </button>
        </div>
        <div className="hidden sm:flex sm:flex-1 sm:items-center sm:justify-between">
          <div>
            <p className="text-sm text-gray-700">
              Showing page <span className="font-medium">{currentPage}</span> of <span className="font-medium">{totalPages}</span>
              {' '}(Total: {totalCount})
            </p>
          </div>
          <div>
            <nav className="isolate inline-flex -space-x-px rounded-md shadow-sm" aria-label="Pagination">
              <button
                disabled={currentPage === 1}
                onClick={() => updateUrl('page', (currentPage - 1).toString())}
                className="relative inline-flex items-center rounded-l-md px-2 py-2 text-gray-400 ring-1 ring-inset ring-gray-300 hover:bg-gray-50 focus:z-20 focus:outline-offset-0 disabled:opacity-50"
              >
                <span className="sr-only">Previous</span>
                ‚Üê Prev
              </button>
              
              {/* Simple Pagination Numbers */}
              {[...Array(totalPages)].map((_, i) => {
                const p = i + 1;
                return (
                  <button
                    key={p}
                    onClick={() => updateUrl('page', p.toString())}
                    className={`relative inline-flex items-center px-4 py-2 text-sm font-semibold 
                      ${p === currentPage 
                        ? 'bg-blue-600 text-white focus:z-20 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-blue-600' 
                        : 'text-gray-900 ring-1 ring-inset ring-gray-300 hover:bg-gray-50 focus:z-20 focus:outline-offset-0'}`}
                  >
                    {p}
                  </button>
                );
              })}

              <button
                disabled={currentPage >= totalPages}
                onClick={() => updateUrl('page', (currentPage + 1).toString())}
                className="relative inline-flex items-center rounded-r-md px-2 py-2 text-gray-400 ring-1 ring-inset ring-gray-300 hover:bg-gray-50 focus:z-20 focus:outline-offset-0 disabled:opacity-50"
              >
                <span className="sr-only">Next</span>
                Next ‚Üí
              </button>
            </nav>
          </div>
        </div>
      </div>

      {/* --- MODAL --- */}
      {showModal && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-xl shadow-2xl w-full max-w-2xl p-8 max-h-[90vh] overflow-y-auto">
            <h2 className="text-2xl font-bold mb-6 text-gray-800">{isEditing ? 'Edit Admin' : 'Create Admin'}</h2>
            <form onSubmit={handleSubmit} className="space-y-6">
              
              {/* ADMIN TYPE */}
              <div className="grid grid-cols-3 gap-4">
                {['SUPER_ADMIN', 'MUNICIPALITY_ADMIN', 'CLUB_ADMIN'].map((role) => (
                  <button key={role} type="button" 
                    onClick={() => !isEditing && setAdminType(role)}
                    className={`py-3 px-2 rounded-lg text-sm font-bold border-2 transition
                      ${adminType === role ? 'border-blue-600 bg-blue-50 text-blue-700' : 'border-gray-200 text-gray-600'}
                      ${isEditing && adminType !== role ? 'opacity-50 cursor-not-allowed' : ''}
                    `}>
                    {role.replace('_', ' ')}
                  </button>
                ))}
              </div>

              {/* FIELDS */}
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <input required type="text" placeholder="First Name" className="border p-2 rounded" value={formData.first_name} onChange={e => setFormData({...formData, first_name: e.target.value})} />
                <input required type="text" placeholder="Last Name" className="border p-2 rounded" value={formData.last_name} onChange={e => setFormData({...formData, last_name: e.target.value})} />
                <input type="text" placeholder="Nickname" className="border p-2 rounded" value={formData.nickname} onChange={e => setFormData({...formData, nickname: e.target.value})} />
                <select className="border p-2 rounded" value={formData.legal_gender} onChange={e => setFormData({...formData, legal_gender: e.target.value})}>
                  <option value="MALE">Male</option> <option value="FEMALE">Female</option> <option value="OTHER">Other</option>
                </select>
                <input required type="email" placeholder="Email" className="border p-2 rounded" value={formData.email} onChange={e => setFormData({...formData, email: e.target.value})} />
                <input type="password" placeholder={isEditing ? "New Password" : "Password"} className="border p-2 rounded" required={!isEditing} value={formData.password} onChange={e => setFormData({...formData, password: e.target.value})} />
                <input type="text" placeholder="Phone" className="border p-2 rounded" value={formData.phone_number} onChange={e => setFormData({...formData, phone_number: e.target.value})} />
                {adminType === 'CLUB_ADMIN' && <input type="text" placeholder="Profession" className="border p-2 rounded" value={formData.profession} onChange={e => setFormData({...formData, profession: e.target.value})} />}
              </div>

              {/* AVATAR */}
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">Avatar</label>
                <input type="file" accept="image/jpeg,image/jpg,image/png,image/svg+xml,image/gif" className="w-full border p-2 rounded" onChange={handleAvatarChange} />
                <p className="text-xs text-gray-500 mt-1">Accepted formats: JPG, PNG, SVG, GIF</p>
                {avatarPreview && (
                  <div className="mt-2">
                    <p className="text-xs text-gray-500 mb-1">Preview:</p>
                    <img src={avatarPreview} alt="Preview" className="w-20 h-20 rounded-full object-cover border border-gray-300" />
                  </div>
                )}
              </div>

              {/* ASSIGNMENT */}
              {(adminType === 'MUNICIPALITY_ADMIN' || adminType === 'CLUB_ADMIN') && (
                <div className="bg-gray-50 p-4 rounded-lg border">
                  {adminType === 'MUNICIPALITY_ADMIN' && (
                    <select className="w-full border p-2 rounded" value={formData.assigned_municipality} onChange={e => setFormData({...formData, assigned_municipality: e.target.value})} required>
                      <option value="">Select Municipality...</option>
                      {Array.isArray(municipalities) && municipalities.map(m => <option key={m.id} value={m.id.toString()}>{m.name}</option>)}
                    </select>
                  )}
                  {adminType === 'CLUB_ADMIN' && (
                    <select className="w-full border p-2 rounded" value={formData.assigned_club} onChange={e => setFormData({...formData, assigned_club: e.target.value})} required>
                      <option value="">Select Club...</option>
                      {Array.isArray(clubs) && clubs.map(c => <option key={c.id} value={c.id.toString()}>{c.name}</option>)}
                    </select>
                  )}
                </div>
              )}

              <div className="flex items-center gap-2">
                <input type="checkbox" id="hideContact" checked={formData.hide_contact_info} onChange={e => setFormData({...formData, hide_contact_info: e.target.checked})} />
                <label htmlFor="hideContact" className="text-sm text-gray-700">Hide Contact Info</label>
              </div>

              <div className="flex justify-end gap-4 pt-4 border-t">
                <button type="button" onClick={() => setShowModal(false)} className="text-gray-500 hover:text-gray-700">Cancel</button>
                <button type="submit" className="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700">
                  {isEditing ? 'Save' : 'Create'}
                </button>
              </div>

            </form>
          </div>
        </div>
      )}

      {/* Delete Confirmation Modal */}
      <DeleteConfirmationModal
        isVisible={showDeleteModal}
        onClose={() => {
          if (!isDeleting) {
            setShowDeleteModal(false);
            setUserToDelete(null);
          }
        }}
        onConfirm={handleDeleteConfirm}
        itemName={userToDelete?.name}
        isLoading={isDeleting}
      />

      {/* Toast Notification */}
      <Toast
        message={toast.message}
        type={toast.type}
        isVisible={toast.isVisible}
        onClose={() => setToast({ ...toast, isVisible: false })}
      />
    </div>
  );
}

export default function ManageAdminsPage() {
  return (
    <Suspense fallback={<div className="p-8 text-center">Loading...</div>}>
      <ManageAdminsPageContent />
    </Suspense>
  );
}

--- END OF FILE: ./frontend/app/admin/super/admins/page.tsx ---


--- START OF FILE: ./frontend/app/admin/super/groups/page.tsx ---
'use client';

import GroupManager from '../../../components/GroupManager';

export default function SuperAdminGroupsPage() {
  return (
    <div className="max-w-7xl mx-auto p-4">
      <GroupManager basePath="/admin/super/groups" />
    </div>
  );
}
--- END OF FILE: ./frontend/app/admin/super/groups/page.tsx ---


--- START OF FILE: ./frontend/app/admin/super/groups/requests/page.tsx ---
'use client';
import GroupRequestsManager from '../../../../components/GroupRequestsManager';
export default function Page() { return <div className="p-8 max-w-6xl mx-auto"><GroupRequestsManager /></div>; }
--- END OF FILE: ./frontend/app/admin/super/groups/requests/page.tsx ---


--- START OF FILE: ./frontend/app/admin/super/groups/edit/[id]/page.tsx ---
'use client';

import { useState, useEffect } from 'react';
import { useParams } from 'next/navigation';
import api from '@/lib/api'; 
import GroupForm from '@/app/components/GroupForm';

export default function EditGroupPage() {
  const params = useParams();
  const id = params?.id as string;
  
  const [group, setGroup] = useState(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState('');

  useEffect(() => {
    if (id) {
      const fetchGroup = async () => {
        try {
          const res = await api.get(`/groups/${id}/`);
          setGroup(res.data);
        } catch (err) {
          console.error(err);
          setError('Failed to load group data.');
        } finally {
          setLoading(false);
        }
      };
      fetchGroup();
    }
  }, [id]);

  if (loading) return <div className="p-12 text-center text-gray-500">Loading group settings...</div>;
  if (error || !group) return <div className="p-12 text-center text-red-500">{error || 'Group not found'}</div>;

  return (
    <div className="max-w-4xl mx-auto p-4">
      <div className="mb-8">
        <h1 className="text-2xl font-bold text-gray-900">Edit Group</h1>
        <p className="text-gray-500">Update membership rules and settings.</p>
      </div>
      
      <GroupForm 
        initialData={group} 
        redirectPath="/admin/super/groups" 
      />
    </div>
  );
}
--- END OF FILE: ./frontend/app/admin/super/groups/edit/[id]/page.tsx ---


--- START OF FILE: ./frontend/app/admin/super/groups/[id]/page.tsx ---
'use client';

import { useParams } from 'next/navigation';
import GroupDetailView from '../../../../components/GroupDetailView';
import Link from 'next/link';

export default function GroupPage() {
  const params = useParams();
  const id = params?.id as string;

  return (
    <div className="max-w-7xl mx-auto p-4">
      <div className="mb-6">
        <Link href="/admin/super/groups" className="text-gray-500 hover:text-gray-900 font-medium flex items-center gap-1">
          ‚Üê Back to Groups
        </Link>
      </div>
      <GroupDetailView groupId={id} basePath="/admin/super/groups" />
    </div>
  );
}
--- END OF FILE: ./frontend/app/admin/super/groups/[id]/page.tsx ---


--- START OF FILE: ./frontend/app/admin/super/groups/create/page.tsx ---
'use client';

import GroupForm from '../../../../components/GroupForm';

export default function CreateGroupPage() {
  return (
    <div className="max-w-4xl mx-auto p-4">
      <div className="mb-8">
        <h1 className="text-2xl font-bold text-gray-900">Create New Group</h1>
        <p className="text-gray-500">Define the rules for who belongs in this group.</p>
      </div>
      
      <GroupForm redirectPath="/admin/super/groups" />
    </div>
  );
}
--- END OF FILE: ./frontend/app/admin/super/groups/create/page.tsx ---


--- START OF FILE: ./frontend/app/admin/super/youth/page.tsx ---
'use client';

import { useState, useEffect, Suspense, useMemo } from 'react';
import { useRouter, useSearchParams, usePathname } from 'next/navigation';
import Link from 'next/link';
import api from '../../../../lib/api';
import { getMediaUrl } from '../../../utils';
import Toast from '../../../components/Toast';
import DeleteConfirmationModal from '../../../components/DeleteConfirmationModal';
import CustomFieldsForm from '../../../components/CustomFieldsForm';

interface Option { id: number; name: string; [key: string]: any; }
interface GuardianOption { id: number; first_name: string; last_name: string; email: string; }
interface MunicipalityOption extends Option { country?: number | { id: number; name: string }; }
interface ClubOption extends Option { municipality?: number | { id: number; name: string }; municipality_name?: string; }

function ManageYouthPageContent() {
  const router = useRouter();
  const pathname = usePathname();
  const searchParams = useSearchParams();

  // --- STATE ---
  const [users, setUsers] = useState<any[]>([]);
  const [totalCount, setTotalCount] = useState(0);
  const [isLoading, setIsLoading] = useState(true);
  const [stats, setStats] = useState<any>(null);
  const [analyticsExpanded, setAnalyticsExpanded] = useState(true);
  const [avatarErrors, setAvatarErrors] = useState<Set<number>>(new Set());
  
  // Toast State
  const [toast, setToast] = useState<{ message: string; type: 'success' | 'error' | 'info' | 'warning'; isVisible: boolean }>({
    message: '',
    type: 'success',
    isVisible: false,
  });

  // Dropdowns
  const [clubs, setClubs] = useState<ClubOption[]>([]);
  const [interests, setInterests] = useState<Option[]>([]);
  const [guardiansList, setGuardiansList] = useState<GuardianOption[]>([]);
  const [countries, setCountries] = useState<Option[]>([]);
  const [municipalities, setMunicipalities] = useState<MunicipalityOption[]>([]);

  // Modal
  const [showModal, setShowModal] = useState(false);
  const [isEditing, setIsEditing] = useState(false);
  const [editUserId, setEditUserId] = useState<number | null>(null);
  const [avatarFile, setAvatarFile] = useState<File | null>(null);
  const [avatarPreview, setAvatarPreview] = useState<string | null>(null);
  
  // Delete Confirmation Modal State
  const [showDeleteModal, setShowDeleteModal] = useState(false);
  const [userToDelete, setUserToDelete] = useState<{ id: number; name: string } | null>(null);
  const [isDeleting, setIsDeleting] = useState(false);
  
  // Guardian search
  const [guardianSearchTerm, setGuardianSearchTerm] = useState('');
  const [showGuardianDropdown, setShowGuardianDropdown] = useState(false);
  
  // Interest search
  const [interestSearchTerm, setInterestSearchTerm] = useState('');
  const [showInterestDropdown, setShowInterestDropdown] = useState(false);

  const initialFormState = {
    email: '', password: '', first_name: '', last_name: '', nickname: '',
    legal_gender: 'MALE', preferred_gender: '', phone_number: '',
    date_of_birth: '', grade: '', preferred_club: '', 
    verification_status: 'UNVERIFIED',
    interests: [] as number[],
    guardians: [] as number[], // Array of Guardian IDs
  };

  const [formData, setFormData] = useState(initialFormState);
  const [customFieldValues, setCustomFieldValues] = useState<Record<number, any>>({});

  // --- LOAD DATA ---
  useEffect(() => {
    fetchDropdowns();
    fetchStats();
  }, []);

  useEffect(() => {
    fetchYouth();
  }, [searchParams]);

  // Handle edit parameter from URL (e.g., from view page)
  useEffect(() => {
    const editId = searchParams.get('edit');
    if (editId && !isEditing && !showModal) {
      const userId = parseInt(editId);
      // Try to find user in current list first
      const userToEdit = users.find(u => u.id === userId);
      if (userToEdit) {
        handleOpenEdit(userToEdit);
      } else if (users.length > 0) {
        // User not in current page, fetch it directly
        api.get(`/users/${userId}/`).then(res => {
          handleOpenEdit(res.data);
        }).catch(err => {
          console.error('Failed to load user for editing:', err);
        });
      }
    }
  }, [searchParams, users.length, isEditing, showModal]);

  const fetchStats = async () => {
    try {
      const res = await api.get('/users/youth_stats/');
      setStats(res.data);
    } catch (err) { console.error(err); }
  };

  const fetchDropdowns = async () => {
    try {
      // Fetch all clubs without pagination for dropdown
      const clubRes = await api.get('/clubs/?page_size=1000');
      const clubsData = Array.isArray(clubRes.data) ? clubRes.data : (clubRes.data?.results || []);
      setClubs(clubsData);
      
      const interestRes = await api.get('/interests/');
      setInterests(Array.isArray(interestRes.data) ? interestRes.data : (interestRes.data?.results || []));

      const guardianRes = await api.get('/users/list_guardians/');
      setGuardiansList(guardianRes.data);
      
      const countryRes = await api.get('/countries/');
      setCountries(Array.isArray(countryRes.data) ? countryRes.data : (countryRes.data?.results || []));
      
      const muniRes = await api.get('/municipalities/');
      setMunicipalities(Array.isArray(muniRes.data) ? muniRes.data : (muniRes.data?.results || []));
    } catch (err) { console.error(err); }
  };

  const fetchYouth = async () => {
    setIsLoading(true);
    try {
      const params = new URLSearchParams();
      params.set('role', 'YOUTH_MEMBER');
      
      // Copy all filter parameters
      const page = searchParams.get('page');
      if (page) params.set('page', page);
      
      const search = searchParams.get('search');
      if (search) params.set('search', search);
      
      const ageFrom = searchParams.get('age_from');
      if (ageFrom) params.set('age_from', ageFrom);
      
      const ageTo = searchParams.get('age_to');
      if (ageTo) params.set('age_to', ageTo);
      
      const gradeFrom = searchParams.get('grade_from');
      if (gradeFrom) params.set('grade_from', gradeFrom);
      
      const gradeTo = searchParams.get('grade_to');
      if (gradeTo) params.set('grade_to', gradeTo);
      
      const verificationStatus = searchParams.get('verification_status');
      if (verificationStatus) params.set('verification_status', verificationStatus);
      
      const country = searchParams.get('country');
      if (country) params.set('country', country);
      
      const municipality = searchParams.get('municipality');
      if (municipality) params.set('municipality', municipality);
      
      const preferredClub = searchParams.get('preferred_club');
      if (preferredClub) params.set('preferred_club', preferredClub);
      
      const gender = searchParams.get('legal_gender');
      if (gender) params.set('legal_gender', gender);
      
      const res = await api.get(`/users/?${params.toString()}`);
      setUsers(res.data.results);
      setTotalCount(res.data.count);
    } catch (err) { console.error(err); } 
    finally { setIsLoading(false); }
  };

  const updateUrl = (key: string, value: string) => {
    const params = new URLSearchParams(searchParams.toString());
    if (value) params.set(key, value); else params.delete(key);
    if (key !== 'page') params.set('page', '1');
    router.push(`${pathname}?${params.toString()}`);
  };

  // --- HANDLERS ---
  const handleOpenCreate = () => {
    setIsEditing(false);
    setEditUserId(null);
    setFormData(initialFormState);
    setCustomFieldValues({});
    setAvatarFile(null);
    setAvatarPreview(null);
    setGuardianSearchTerm('');
    setShowGuardianDropdown(false);
    setInterestSearchTerm('');
    setShowInterestDropdown(false);
    setShowModal(true);
  };

  const handleOpenEdit = (user: any) => {
    setIsEditing(true);
    setEditUserId(user.id);
    
    // Normalize interests/guardians (handle API variations)
    const interestIds = user.interests?.map((i: any) => typeof i === 'object' ? i.id : i) || [];
    // The serializer now returns 'guardians' as a list of IDs directly
    const guardianIds = user.guardians || [];
    
    setFormData({
      email: user.email, password: '', 
      first_name: user.first_name || '', last_name: user.last_name || '',
      nickname: user.nickname || '', 
      legal_gender: user.legal_gender || 'MALE', preferred_gender: user.preferred_gender || '',
      phone_number: user.phone_number || '', 
      date_of_birth: user.date_of_birth || '',
      grade: user.grade || '', 
      preferred_club: typeof user.preferred_club === 'object' 
        ? (user.preferred_club?.id?.toString() || '')
        : (user.preferred_club?.toString() || ''),
      verification_status: user.verification_status || 'UNVERIFIED',
      interests: interestIds,
      guardians: guardianIds
    });
    setAvatarFile(null);
    setAvatarPreview(user.avatar ? getMediaUrl(user.avatar) : null);
    setGuardianSearchTerm('');
    setShowGuardianDropdown(false);
    setInterestSearchTerm('');
    setShowInterestDropdown(false);
    setShowModal(true);
  };

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    try {
      const data = new FormData();
      
      // Basic fields
      Object.entries(formData).forEach(([key, value]) => {
        if (key === 'password' && !value) return;
        if (key === 'interests') return; 
        if (key === 'guardians') return;
        data.append(key, value.toString());
      });
      
      // Handle Arrays
      formData.interests.forEach(id => data.append('interests', id.toString()));
      formData.guardians.forEach(id => data.append('guardians', id.toString()));
      
      data.append('role', 'YOUTH_MEMBER');
      if (avatarFile) data.append('avatar', avatarFile);

      const config = { headers: { 'Content-Type': 'multipart/form-data' } };
      let userId: number;
      if (isEditing && editUserId) {
        await api.patch(`/users/${editUserId}/`, data, config);
        userId = editUserId;
        setToast({
          message: 'Youth member updated successfully!',
          type: 'success',
          isVisible: true,
        });
      } else {
        const res = await api.post('/users/', data, config);
        userId = res.data.id;
        setToast({
          message: 'Youth member created successfully!',
          type: 'success',
          isVisible: true,
        });
      }

      // Save custom field values
      if (Object.keys(customFieldValues).length > 0) {
        try {
          await api.post('/custom-fields/save_values_for_user/', {
            user_id: userId,
            values: customFieldValues,
          });
        } catch (err) {
          console.error('Failed to save custom field values:', err);
        }
      }

      setShowModal(false);
      fetchYouth();
      fetchStats();
    } catch (err) { 
      setToast({
        message: 'Operation failed. Please try again.',
        type: 'error',
        isVisible: true,
      });
      console.error(err); 
    }
  };

  const handleDeleteClick = (user: any) => {
    setUserToDelete({ id: user.id, name: `${user.first_name} ${user.last_name}` });
    setShowDeleteModal(true);
  };

  const handleDeleteConfirm = async () => {
    if (!userToDelete) return;

    setIsDeleting(true);
    try { 
      await api.delete(`/users/${userToDelete.id}/`);
      setToast({
        message: 'Youth member deleted successfully!',
        type: 'success',
        isVisible: true,
      });
      setShowDeleteModal(false);
      setUserToDelete(null);
      fetchYouth(); 
      fetchStats(); 
    } 
    catch (err) { 
      setToast({
        message: 'Failed to delete youth member.',
        type: 'error',
        isVisible: true,
      });
    } finally {
      setIsDeleting(false);
    }
  };

  const handleAvatarChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (file) {
      setAvatarFile(file);
      const reader = new FileReader();
      reader.onloadend = () => setAvatarPreview(reader.result as string);
      reader.readAsDataURL(file);
    }
  };

  const toggleInterest = (id: number) => {
    setFormData(prev => {
      const exists = prev.interests.includes(id);
      if (exists) return { ...prev, interests: prev.interests.filter(i => i !== id) };
      return { ...prev, interests: [...prev.interests, id] };
    });
    setInterestSearchTerm('');
    setShowInterestDropdown(false);
  };

  const removeInterest = (id: number) => {
    setFormData(prev => ({
      ...prev,
      interests: prev.interests.filter(i => i !== id)
    }));
  };

  // Filter interests based on search term
  const filteredInterests = interests.filter(interest => {
    const searchLower = interestSearchTerm.toLowerCase();
    const name = interest.name.toLowerCase();
    return name.includes(searchLower) && !formData.interests.includes(interest.id);
  });

  // Get selected interest details
  const getSelectedInterests = () => {
    return formData.interests.map(id => interests.find(i => i.id === id)).filter(Boolean) as Option[];
  };

  const toggleGuardian = (id: number) => {
    setFormData(prev => {
      const exists = prev.guardians.includes(id);
      if (exists) return { ...prev, guardians: prev.guardians.filter(i => i !== id) };
      return { ...prev, guardians: [...prev.guardians, id] };
    });
    setGuardianSearchTerm('');
    setShowGuardianDropdown(false);
  };

  const removeGuardian = (id: number) => {
    setFormData(prev => ({
      ...prev,
      guardians: prev.guardians.filter(i => i !== id)
    }));
  };

  // Filter guardians based on search term
  const filteredGuardians = guardiansList.filter(g => {
    const searchLower = guardianSearchTerm.toLowerCase();
    const fullName = `${g.first_name} ${g.last_name}`.toLowerCase();
    const email = g.email.toLowerCase();
    return (fullName.includes(searchLower) || email.includes(searchLower)) && 
           !formData.guardians.includes(g.id);
  });

  // Get selected guardian details
  const getSelectedGuardians = () => {
    return formData.guardians.map(id => guardiansList.find(g => g.id === id)).filter(Boolean) as GuardianOption[];
  };

  // Helper function to get initials from name
  const getInitials = (firstName: string = '', lastName: string = '') => {
    const first = firstName?.charAt(0)?.toUpperCase() || '';
    const last = lastName?.charAt(0)?.toUpperCase() || '';
    return first + last || '?';
  };

  // Helper function to get avatar color (consistent for all youth members)
  const getAvatarColor = () => {
    return 'bg-blue-200 text-blue-800';
  };

  // Filter municipalities based on selected country
  const filteredMunicipalities = useMemo(() => {
    const selectedCountry = searchParams.get('country');
    if (!selectedCountry) return municipalities;
    const countryId = parseInt(selectedCountry);
    return municipalities.filter(m => {
      // Handle both cases: m.country is an ID or m.country is an object with id
      return (typeof m.country === 'number' && m.country === countryId) ||
             (typeof m.country === 'object' && m.country?.id === countryId);
    });
  }, [municipalities, searchParams]);

  // Filter clubs based on selected municipality
  const filteredClubs = useMemo(() => {
    const selectedMunicipality = searchParams.get('municipality');
    const selectedCountry = searchParams.get('country');
    
    // If no filters selected, return all clubs
    if (!selectedMunicipality && !selectedCountry) {
      return clubs;
    }
    
    // Filter by municipality if selected (primary filter)
    if (selectedMunicipality) {
      const municipalityId = Number(selectedMunicipality);
      if (isNaN(municipalityId)) return clubs;
      
      return clubs.filter(c => {
        // Get club's municipality ID - handle different data types
        const clubMunicipalityId = typeof c.municipality === 'number' 
          ? c.municipality 
          : typeof c.municipality === 'string' 
          ? Number(c.municipality)
          : typeof c.municipality === 'object' && c.municipality?.id
          ? Number(c.municipality.id)
          : null;
        
        // Direct ID comparison
        if (clubMunicipalityId !== null && !isNaN(clubMunicipalityId)) {
          return clubMunicipalityId === municipalityId;
        }
        
        // Fallback: match by municipality_name
        if (c.municipality_name) {
          const matchingMunicipality = municipalities.find(m => m.id === municipalityId);
          return matchingMunicipality?.name === c.municipality_name;
        }
        
        return false;
      });
    }
    
    // Filter by country if selected (but no municipality)
    if (selectedCountry) {
      const countryId = Number(selectedCountry);
      if (isNaN(countryId)) return clubs;
      
      return clubs.filter(c => {
        // Get club's municipality ID
        const clubMunicipalityId = typeof c.municipality === 'number' 
          ? c.municipality 
          : typeof c.municipality === 'string' 
          ? Number(c.municipality)
          : typeof c.municipality === 'object' && c.municipality?.id
          ? Number(c.municipality.id)
          : null;
        
        if (clubMunicipalityId === null || isNaN(clubMunicipalityId)) return false;
        
        // Find municipality and check its country
        const clubMunicipality = municipalities.find(m => m.id === clubMunicipalityId);
        if (!clubMunicipality) return false;
        
        const municipalityCountryId = typeof clubMunicipality.country === 'number'
          ? clubMunicipality.country
          : typeof clubMunicipality.country === 'string'
          ? Number(clubMunicipality.country)
          : typeof clubMunicipality.country === 'object' && clubMunicipality.country?.id
          ? Number(clubMunicipality.country.id)
          : null;
        
        return municipalityCountryId === countryId;
      });
    }
    
    return clubs;
  }, [clubs, searchParams, municipalities]);

  const currentPage = Number(searchParams.get('page')) || 1;
  const totalPages = Math.ceil(totalCount / 10);

  return (
    <div>
      <div className="flex justify-between items-center mb-6">
        <h1 className="text-2xl font-bold text-gray-800">Manage Youth Members</h1>
        <button onClick={handleOpenCreate} className="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 shadow">
          + Create New Member
        </button>
      </div>

      {/* --- ANALYTICS HUD --- */}
      {stats && (
        <div className="mb-6">
          {/* Toggle Button */}
          <button
            onClick={() => setAnalyticsExpanded(!analyticsExpanded)}
            className="flex items-center justify-between w-full bg-white rounded-lg shadow-sm border border-gray-200 p-3 hover:bg-gray-50 transition-colors mb-3"
          >
            <div className="flex items-center gap-2">
              <svg className="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
              </svg>
              <span className="text-sm font-semibold text-gray-700">Analytics Dashboard</span>
            </div>
            <svg 
              className={`w-5 h-5 text-gray-600 transition-transform duration-200 ${analyticsExpanded ? 'rotate-180' : ''}`}
              fill="none" 
              stroke="currentColor" 
              viewBox="0 0 24 24"
            >
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
            </svg>
          </button>

          {/* Analytics Cards - Collapsible */}
          <div 
            className={`grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 transition-all duration-500 ease-in-out ${
              analyticsExpanded 
                ? 'max-h-[600px] opacity-100 translate-y-0' 
                : 'max-h-0 opacity-0 -translate-y-4 pointer-events-none'
            } overflow-hidden`}
          >
            {/* Card 1: Total Youth */}
            <div className="bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl shadow-md p-4 text-white transform hover:scale-105 transition-all duration-200">
              <div className="flex items-center justify-between mb-2">
                <div className="bg-white/20 rounded-lg p-2">
                  <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" />
                  </svg>
                </div>
              </div>
              <h3 className="text-blue-100 text-xs font-semibold uppercase tracking-wider mb-1">Total Youth</h3>
              <p className="text-3xl font-bold mb-0.5">{stats.total_youth}</p>
              <p className="text-blue-100 text-xs">Active members</p>
            </div>

            {/* Card 2: Active (7 Days) */}
            <div className="bg-gradient-to-br from-green-500 to-green-600 rounded-xl shadow-md p-4 text-white transform hover:scale-105 transition-all duration-200">
              <div className="flex items-center justify-between mb-2">
                <div className="bg-white/20 rounded-lg p-2">
                  <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                  </svg>
                </div>
              </div>
              <h3 className="text-green-100 text-xs font-semibold uppercase tracking-wider mb-1">Active (7 Days)</h3>
              <p className="text-3xl font-bold mb-0.5">{stats.activity.active_7_days}</p>
              <p className="text-green-100 text-xs">Recently active</p>
            </div>

            {/* Card 3: Grade Breakdown */}
            <div className="bg-white rounded-xl shadow-md p-4 border border-gray-100 hover:shadow-lg transition-all duration-200 col-span-1 md:col-span-2">
              <div className="flex items-center justify-between mb-2">
                <h3 className="text-gray-600 text-xs font-bold uppercase tracking-wider">Grade Breakdown</h3>
                <div className="bg-orange-100 rounded-lg p-1.5">
                  <svg className="w-4 h-4 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
                  </svg>
                </div>
              </div>
              <div className="flex flex-wrap gap-2">
                {Object.entries(stats.grades).map(([grade, count]: any) => (
                  <div key={grade} className="bg-orange-50 px-2.5 py-1.5 rounded-lg border border-orange-100 flex items-center gap-1.5">
                    <span className="text-xs text-gray-600 font-medium">Gr {grade}:</span>
                    <span className="text-sm font-bold text-orange-600">{count}</span>
                  </div>
                ))}
              </div>
            </div>
          </div>
        </div>
      )}

      {/* --- FILTER BAR --- */}
      <div className="bg-white p-4 rounded-lg shadow mb-6 border border-gray-100">
        <div className="flex flex-wrap gap-4 items-end">
          {/* Search */}
          <div className="flex-1 min-w-[200px]">
            <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Search</label>
            <input
              type="text"
              placeholder="Search by name or email..."
              className="w-full border rounded p-2 text-sm bg-gray-50"
              value={searchParams.get('search') || ''}
              onChange={(e) => {
                const value = e.target.value;
                if (value.trim()) {
                  updateUrl('search', value.trim());
                } else {
                  const params = new URLSearchParams(searchParams.toString());
                  params.delete('search');
                  params.set('page', '1');
                  router.push(`${pathname}?${params.toString()}`);
                }
              }}
            />
          </div>

          {/* Age Range */}
          <div className="w-24">
            <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Age From</label>
            <input
              type="number"
              min="0"
              max="100"
              placeholder="Min"
              className="w-full border rounded p-2 text-sm bg-gray-50"
              value={searchParams.get('age_from') || ''}
              onChange={(e) => updateUrl('age_from', e.target.value)}
            />
          </div>
          <div className="w-24">
            <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Age To</label>
            <input
              type="number"
              min="0"
              max="100"
              placeholder="Max"
              className="w-full border rounded p-2 text-sm bg-gray-50"
              value={searchParams.get('age_to') || ''}
              onChange={(e) => updateUrl('age_to', e.target.value)}
            />
          </div>

          {/* Grade Range */}
          <div className="w-24">
            <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Grade From</label>
            <input
              type="number"
              min="1"
              max="12"
              placeholder="Min"
              className="w-full border rounded p-2 text-sm bg-gray-50"
              value={searchParams.get('grade_from') || ''}
              onChange={(e) => updateUrl('grade_from', e.target.value)}
            />
          </div>
          <div className="w-24">
            <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Grade To</label>
            <input
              type="number"
              min="1"
              max="12"
              placeholder="Max"
              className="w-full border rounded p-2 text-sm bg-gray-50"
              value={searchParams.get('grade_to') || ''}
              onChange={(e) => updateUrl('grade_to', e.target.value)}
            />
          </div>

          {/* Status */}
          <div className="w-40">
            <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Status</label>
            <select
              className="w-full border rounded p-2 text-sm bg-gray-50"
              value={searchParams.get('verification_status') || ''}
              onChange={(e) => updateUrl('verification_status', e.target.value)}
            >
              <option value="">All Statuses</option>
              <option value="UNVERIFIED">Unverified</option>
              <option value="PENDING">Pending</option>
              <option value="VERIFIED">Verified</option>
            </select>
          </div>

          {/* Country */}
          <div className="w-48">
            <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Country</label>
            <select
              className="w-full border rounded p-2 text-sm bg-gray-50"
              value={searchParams.get('country') || ''}
              onChange={(e) => {
                const value = e.target.value;
                // Clear municipality and club when country changes
                const params = new URLSearchParams(searchParams.toString());
                if (value) {
                  params.set('country', value);
                } else {
                  params.delete('country');
                }
                params.delete('municipality');
                params.delete('preferred_club');
                params.set('page', '1');
                router.push(`${pathname}?${params.toString()}`);
              }}
            >
              <option value="">All Countries</option>
              {Array.isArray(countries) && countries.map(c => (
                <option key={c.id} value={c.id.toString()}>{c.name}</option>
              ))}
            </select>
          </div>

          {/* Municipality */}
          <div className="w-48">
            <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Municipality</label>
            <select
              className="w-full border rounded p-2 text-sm bg-gray-50"
              value={searchParams.get('municipality') || ''}
              onChange={(e) => {
                const value = e.target.value;
                // Clear club when municipality changes
                const params = new URLSearchParams(searchParams.toString());
                if (value) {
                  params.set('municipality', value);
                } else {
                  params.delete('municipality');
                }
                params.delete('preferred_club');
                params.set('page', '1');
                router.push(`${pathname}?${params.toString()}`);
              }}
            >
              <option value="">All Municipalities</option>
              {filteredMunicipalities.map(m => (
                <option key={m.id} value={m.id.toString()}>{m.name}</option>
              ))}
            </select>
          </div>

          {/* Club */}
          <div className="w-48">
            <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Club</label>
            <select
              className="w-full border rounded p-2 text-sm bg-gray-50"
              value={searchParams.get('preferred_club') || ''}
              onChange={(e) => updateUrl('preferred_club', e.target.value)}
              disabled={searchParams.get('municipality') ? false : (searchParams.get('country') ? false : false)}
            >
              <option value="">
                {searchParams.get('municipality') 
                  ? `Clubs in Selected Municipality (${filteredClubs.length})` 
                  : searchParams.get('country')
                  ? `Clubs in Selected Country (${filteredClubs.length})`
                  : 'All Clubs'}
              </option>
              {filteredClubs.map(c => (
                <option key={c.id} value={c.id.toString()}>{c.name}</option>
              ))}
            </select>
            {searchParams.get('municipality') && filteredClubs.length === 0 && (
              <p className="text-xs text-gray-500 mt-1">No clubs found for selected municipality</p>
            )}
          </div>

          {/* Gender */}
          <div className="w-32">
            <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Gender</label>
            <select
              className="w-full border rounded p-2 text-sm bg-gray-50"
              value={searchParams.get('legal_gender') || ''}
              onChange={(e) => updateUrl('legal_gender', e.target.value)}
            >
              <option value="">Any</option>
              <option value="MALE">Male</option>
              <option value="FEMALE">Female</option>
              <option value="OTHER">Other</option>
            </select>
          </div>

          <button
            onClick={() => router.push(pathname)}
            className="px-4 py-2 text-sm text-gray-500 hover:text-red-500 font-medium pb-2.5"
          >
            Clear Filters
          </button>
        </div>
      </div>

      {/* --- LIST --- */}
      <div className="bg-white rounded-lg shadow overflow-hidden mb-6">
        <table className="min-w-full divide-y divide-gray-200">
          <thead className="bg-gray-50">
            <tr>
              <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">User</th>
              <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
              <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Grade / DOB</th>
              <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Club</th>
              <th className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">Actions</th>
            </tr>
          </thead>
          <tbody className="bg-white divide-y divide-gray-200">
            {users.map((user) => (
              <tr key={user.id}>
                <td className="px-6 py-4 whitespace-nowrap">
                  <div className="flex items-center">
                    {user.avatar && !avatarErrors.has(user.id) ? (
                      <img 
                        src={getMediaUrl(user.avatar) || ''}
                        alt="Avatar"
                        className="w-10 h-10 rounded-full object-cover mr-3"
                        onError={() => {
                          setAvatarErrors(prev => new Set(prev).add(user.id));
                        }}
                      />
                    ) : (
                      <div className={`w-10 h-10 rounded-full ${getAvatarColor()} flex items-center justify-center font-semibold text-sm mr-3`}>
                        {getInitials(user.first_name, user.last_name)}
                      </div>
                    )}
                    <div>
                        <div className="text-sm font-medium text-gray-900">{user.first_name} {user.last_name}</div>
                        <div className="text-xs text-gray-500">{user.email}</div>
                    </div>
                  </div>
                </td>
                <td className="px-6 py-4 whitespace-nowrap">
                   <span className={`px-2 py-1 text-xs font-bold rounded-full ${
                       user.verification_status === 'VERIFIED' ? 'bg-green-100 text-green-800' :
                       user.verification_status === 'PENDING' ? 'bg-yellow-100 text-yellow-800' :
                       'bg-gray-100 text-gray-600'
                   }`}>
                       {user.verification_status || 'UNVERIFIED'}
                   </span>
                </td>
                <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                  Grade: <span className="font-bold">{user.grade || '-'}</span><br/>
                  <span className="text-xs">{user.date_of_birth}</span>
                </td>
                <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                  {clubs.find(c => c.id === user.preferred_club)?.name || '-'}
                </td>
                <td className="px-6 py-4 whitespace-nowrap text-right text-sm font-medium space-x-4">
                  <Link href={`/admin/super/youth/${user.id}`} className="text-blue-600 hover:text-blue-900 font-bold">View</Link>
                  <button onClick={() => handleOpenEdit(user)} className="text-indigo-600 hover:text-indigo-900 font-bold">Edit</button>
                  <button onClick={() => handleDeleteClick(user)} className="text-red-600 hover:text-red-900">Delete</button>
                </td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>

      {/* --- PAGINATION CONTROLS --- */}
      <div className="flex items-center justify-between border-t border-gray-200 bg-white px-4 py-3 sm:px-6 rounded-lg shadow">
        <div className="flex flex-1 justify-between sm:hidden">
          <button 
            disabled={currentPage === 1}
            onClick={() => updateUrl('page', (currentPage - 1).toString())}
            className="relative inline-flex items-center rounded-md border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50 disabled:opacity-50"
          >
            Previous
          </button>
          <button 
            disabled={currentPage >= totalPages}
            onClick={() => updateUrl('page', (currentPage + 1).toString())}
            className="relative ml-3 inline-flex items-center rounded-md border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50 disabled:opacity-50"
          >
            Next
          </button>
        </div>
        <div className="hidden sm:flex sm:flex-1 sm:items-center sm:justify-between">
          <div>
            <p className="text-sm text-gray-700">
              Showing page <span className="font-medium">{currentPage}</span> of <span className="font-medium">{totalPages}</span>
              {' '}(Total: {totalCount})
            </p>
          </div>
          <div>
            <nav className="isolate inline-flex -space-x-px rounded-md shadow-sm" aria-label="Pagination">
              <button
                disabled={currentPage === 1}
                onClick={() => updateUrl('page', (currentPage - 1).toString())}
                className="relative inline-flex items-center rounded-l-md px-2 py-2 text-gray-400 ring-1 ring-inset ring-gray-300 hover:bg-gray-50 focus:z-20 focus:outline-offset-0 disabled:opacity-50"
              >
                <span className="sr-only">Previous</span>
                ‚Üê Prev
              </button>
              
              {/* Simple Pagination Numbers */}
              {[...Array(totalPages)].map((_, i) => {
                const p = i + 1;
                return (
                  <button
                    key={p}
                    onClick={() => updateUrl('page', p.toString())}
                    className={`relative inline-flex items-center px-4 py-2 text-sm font-semibold 
                      ${p === currentPage 
                        ? 'bg-blue-600 text-white focus:z-20 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-blue-600' 
                        : 'text-gray-900 ring-1 ring-inset ring-gray-300 hover:bg-gray-50 focus:z-20 focus:outline-offset-0'}`}
                  >
                    {p}
                  </button>
                );
              })}

              <button
                disabled={currentPage >= totalPages}
                onClick={() => updateUrl('page', (currentPage + 1).toString())}
                className="relative inline-flex items-center rounded-r-md px-2 py-2 text-gray-400 ring-1 ring-inset ring-gray-300 hover:bg-gray-50 focus:z-20 focus:outline-offset-0 disabled:opacity-50"
              >
                <span className="sr-only">Next</span>
                Next ‚Üí
              </button>
            </nav>
          </div>
        </div>
      </div>

      {/* --- MODAL --- */}
      {showModal && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-xl shadow-2xl w-full max-w-2xl p-8 max-h-[90vh] overflow-y-auto">
            <h2 className="text-2xl font-bold mb-6 text-gray-800">{isEditing ? 'Edit Youth' : 'Create Youth'}</h2>
            <form onSubmit={handleSubmit} className="space-y-6">
              
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <input required type="text" placeholder="First Name" className="border p-2 rounded" value={formData.first_name} onChange={e => setFormData({...formData, first_name: e.target.value})} />
                <input required type="text" placeholder="Last Name" className="border p-2 rounded" value={formData.last_name} onChange={e => setFormData({...formData, last_name: e.target.value})} />
                <input type="text" placeholder="Nickname" className="border p-2 rounded" value={formData.nickname} onChange={e => setFormData({...formData, nickname: e.target.value})} />
                
                <input required type="email" placeholder="Email" className="border p-2 rounded" value={formData.email} onChange={e => setFormData({...formData, email: e.target.value})} />
                <input type="password" placeholder={isEditing ? "New Password" : "Password"} className="border p-2 rounded" required={!isEditing} value={formData.password} onChange={e => setFormData({...formData, password: e.target.value})} />
                <input type="text" placeholder="Phone" className="border p-2 rounded" value={formData.phone_number} onChange={e => setFormData({...formData, phone_number: e.target.value})} />
              </div>

              {/* VERIFICATION (Admin Only) */}
              <div className="bg-blue-50 p-4 rounded-lg border border-blue-100">
                  <label className="block text-sm font-bold text-blue-800 mb-2">Verification Status</label>
                  <div className="flex gap-4">
                      {['UNVERIFIED', 'PENDING', 'VERIFIED'].map(status => (
                          <label key={status} className="flex items-center space-x-2 cursor-pointer">
                              <input 
                                  type="radio" 
                                  name="verification_status"
                                  value={status}
                                  checked={formData.verification_status === status}
                                  onChange={e => setFormData({...formData, verification_status: e.target.value})}
                                  className="text-blue-600"
                              />
                              <span className="text-sm font-medium">{status}</span>
                          </label>
                      ))}
                  </div>
              </div>

              {/* DEMOGRAPHICS */}
              <div className="bg-gray-50 p-4 rounded-lg border grid grid-cols-2 gap-4">
                  <div>
                      <label className="block text-xs font-bold uppercase text-gray-500 mb-1">Date of Birth</label>
                      <input type="date" className="w-full border p-2 rounded" value={formData.date_of_birth} onChange={e => setFormData({...formData, date_of_birth: e.target.value})} />
                  </div>
                  <div>
                      <label className="block text-xs font-bold uppercase text-gray-500 mb-1">Grade</label>
                      <input type="number" placeholder="e.g. 7" className="w-full border p-2 rounded" value={formData.grade} onChange={e => setFormData({...formData, grade: e.target.value})} />
                  </div>
                  <div>
                    <label className="block text-xs font-bold uppercase text-gray-500 mb-1">Legal Gender</label>
                    <select className="w-full border p-2 rounded" value={formData.legal_gender} onChange={e => setFormData({...formData, legal_gender: e.target.value})}>
                        <option value="MALE">Male</option> <option value="FEMALE">Female</option> <option value="OTHER">Other</option>
                    </select>
                  </div>
                  <div>
                    <label className="block text-xs font-bold uppercase text-gray-500 mb-1">Preferred Gender</label>
                    <input type="text" className="w-full border p-2 rounded" value={formData.preferred_gender} onChange={e => setFormData({...formData, preferred_gender: e.target.value})} />
                  </div>
              </div>

              {/* GUARDIANS & CLUB & INTERESTS */}
              <div>
                  <label className="block text-sm font-bold mb-2">Preferred Club</label>
                  <select className="w-full border p-2 rounded mb-4" value={formData.preferred_club} onChange={e => setFormData({...formData, preferred_club: e.target.value})}>
                      <option value="">Select Club...</option>
                      {clubs.map(c => <option key={c.id} value={c.id}>{c.name}</option>)}
                  </select>

                  <label className="block text-sm font-bold mb-2">Assign Guardians</label>
                  
                  {/* Selected Guardians Display */}
                  {formData.guardians.length > 0 && (
                    <div className="flex flex-wrap gap-2 mb-3 p-3 bg-blue-50 rounded-lg border border-blue-200">
                      {getSelectedGuardians().map(g => (
                        <span 
                          key={g.id}
                          className="inline-flex items-center gap-1.5 px-3 py-1.5 bg-blue-600 text-white text-sm rounded-full font-medium"
                        >
                          {g.first_name} {g.last_name}
                          <button
                            type="button"
                            onClick={() => removeGuardian(g.id)}
                            className="hover:bg-blue-700 rounded-full p-0.5 transition-colors"
                            aria-label={`Remove ${g.first_name} ${g.last_name}`}
                          >
                            <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                            </svg>
                          </button>
                        </span>
                      ))}
                    </div>
                  )}

                  {/* Searchable Dropdown */}
                  <div className="relative mb-4">
                    <div className="relative">
                      <input
                        type="text"
                        placeholder="Search guardians by name or email..."
                        value={guardianSearchTerm}
                        onChange={(e) => {
                          setGuardianSearchTerm(e.target.value);
                          setShowGuardianDropdown(true);
                        }}
                        onFocus={() => setShowGuardianDropdown(true)}
                        className="w-full border border-gray-300 rounded-lg p-2.5 pr-10 focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                      />
                      <svg 
                        className="absolute right-3 top-1/2 transform -translate-y-1/2 w-5 h-5 text-gray-400 pointer-events-none"
                        fill="none" 
                        stroke="currentColor" 
                        viewBox="0 0 24 24"
                      >
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                      </svg>
                    </div>

                    {/* Dropdown List */}
                    {showGuardianDropdown && (
                      <>
                        <div 
                          className="fixed inset-0 z-10" 
                          onClick={() => setShowGuardianDropdown(false)}
                        ></div>
                        <div className="absolute z-20 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-60 overflow-y-auto">
                          {filteredGuardians.length > 0 ? (
                            filteredGuardians.map(g => (
                              <button
                                key={g.id}
                                type="button"
                                onClick={() => toggleGuardian(g.id)}
                                className="w-full text-left px-4 py-2.5 hover:bg-blue-50 transition-colors border-b border-gray-100 last:border-b-0"
                              >
                                <div className="font-medium text-gray-900">{g.first_name} {g.last_name}</div>
                                <div className="text-xs text-gray-500">{g.email}</div>
                              </button>
                            ))
                          ) : guardianSearchTerm ? (
                            <div className="px-4 py-3 text-sm text-gray-500 text-center">
                              No guardians found matching "{guardianSearchTerm}"
                            </div>
                          ) : (
                            <div className="px-4 py-3 text-sm text-gray-500 text-center">
                              {formData.guardians.length === 0 
                                ? 'No guardians available. Create a guardian first.'
                                : 'All guardians are already selected.'}
                            </div>
                          )}
                        </div>
                      </>
                    )}
                  </div>

                  <label className="block text-sm font-bold mb-2">Interests</label>
                  
                  {/* Selected Interests Display */}
                  {formData.interests.length > 0 && (
                    <div className="flex flex-wrap gap-2 mb-3 p-3 bg-purple-50 rounded-lg border border-purple-200">
                      {getSelectedInterests().map(interest => (
                        <span 
                          key={interest.id}
                          className="inline-flex items-center gap-1.5 px-3 py-1.5 bg-purple-600 text-white text-sm rounded-full font-medium"
                        >
                          {interest.name}
                          <button
                            type="button"
                            onClick={() => removeInterest(interest.id)}
                            className="hover:bg-purple-700 rounded-full p-0.5 transition-colors"
                            aria-label={`Remove ${interest.name}`}
                          >
                            <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                            </svg>
                          </button>
                        </span>
                      ))}
                    </div>
                  )}

                  {/* Searchable Dropdown */}
                  <div className="relative mb-4">
                    <div className="relative">
                      <input
                        type="text"
                        placeholder="Search interests by name..."
                        value={interestSearchTerm}
                        onChange={(e) => {
                          setInterestSearchTerm(e.target.value);
                          setShowInterestDropdown(true);
                        }}
                        onFocus={() => setShowInterestDropdown(true)}
                        className="w-full border border-gray-300 rounded-lg p-2.5 pr-10 focus:ring-2 focus:ring-purple-500 focus:border-purple-500"
                      />
                      <svg 
                        className="absolute right-3 top-1/2 transform -translate-y-1/2 w-5 h-5 text-gray-400 pointer-events-none"
                        fill="none" 
                        stroke="currentColor" 
                        viewBox="0 0 24 24"
                      >
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                      </svg>
                    </div>

                    {/* Dropdown List */}
                    {showInterestDropdown && (
                      <>
                        <div 
                          className="fixed inset-0 z-10" 
                          onClick={() => setShowInterestDropdown(false)}
                        ></div>
                        <div className="absolute z-20 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-60 overflow-y-auto">
                          {filteredInterests.length > 0 ? (
                            filteredInterests.map(interest => (
                              <button
                                key={interest.id}
                                type="button"
                                onClick={() => toggleInterest(interest.id)}
                                className="w-full text-left px-4 py-2.5 hover:bg-purple-50 transition-colors border-b border-gray-100 last:border-b-0"
                              >
                                <div className="font-medium text-gray-900">{interest.name}</div>
                              </button>
                            ))
                          ) : interestSearchTerm ? (
                            <div className="px-4 py-3 text-sm text-gray-500 text-center">
                              No interests found matching "{interestSearchTerm}"
                            </div>
                          ) : (
                            <div className="px-4 py-3 text-sm text-gray-500 text-center">
                              {formData.interests.length === 0 
                                ? 'No interests available. Create interests in the admin panel first.'
                                : 'All interests are already selected.'}
                            </div>
                          )}
                        </div>
                      </>
                    )}
                  </div>
              </div>

               {/* AVATAR */}
               <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">Avatar</label>
                <input type="file" accept="image/*" className="w-full border p-2 rounded" onChange={handleAvatarChange} />
                {avatarPreview && <img src={avatarPreview} alt="Preview" className="w-16 h-16 mt-2 rounded-full object-cover border" />}
              </div>

              {/* Custom Fields */}
              <CustomFieldsForm
                targetRole="YOUTH_MEMBER"
                context="USER_PROFILE"
                values={customFieldValues}
                onChange={(fieldId, value) => {
                  setCustomFieldValues((prev) => ({
                    ...prev,
                    [fieldId]: value,
                  }));
                }}
                userId={isEditing ? editUserId : null}
                userMunicipalityId={null}
                userClubId={formData.preferred_club ? Number(formData.preferred_club) : null}
              />

              <div className="flex justify-end gap-4 pt-4 border-t">
                <button type="button" onClick={() => setShowModal(false)} className="text-gray-500">Cancel</button>
                <button type="submit" className="bg-blue-600 text-white px-6 py-2 rounded">
                  {isEditing ? 'Save Changes' : 'Create Youth'}
                </button>
              </div>
            </form>
          </div>
        </div>
      )}

      {/* Delete Confirmation Modal */}
      <DeleteConfirmationModal
        isVisible={showDeleteModal}
        onClose={() => {
          if (!isDeleting) {
            setShowDeleteModal(false);
            setUserToDelete(null);
          }
        }}
        onConfirm={handleDeleteConfirm}
        itemName={userToDelete?.name}
        isLoading={isDeleting}
      />

      {/* Toast Notification */}
      <Toast
        message={toast.message}
        type={toast.type}
        isVisible={toast.isVisible}
        onClose={() => setToast({ ...toast, isVisible: false })}
      />
    </div>
  );
}

export default function ManageYouthPage() {
  return (
    <Suspense fallback={<div>Loading...</div>}>
      <ManageYouthPageContent />
    </Suspense>
  );
}

--- END OF FILE: ./frontend/app/admin/super/youth/page.tsx ---


--- START OF FILE: ./frontend/app/admin/super/youth/[id]/page.tsx ---
'use client';

import { useState, useEffect, Suspense } from 'react';
import { useRouter, useParams } from 'next/navigation';
import Link from 'next/link';
import api from '../../../../../lib/api';
import { getMediaUrl } from '../../../../utils';
import CustomFieldsDisplay from '../../../../components/CustomFieldsDisplay';

interface Option { id: number; name: string; }
interface GuardianOption { id: number; first_name: string; last_name: string; email: string; }

function YouthViewPageContent() {
  const router = useRouter();
  const params = useParams();
  const youthId = params?.id as string;

  const [user, setUser] = useState<any>(null);
  const [clubs, setClubs] = useState<Option[]>([]);
  const [interests, setInterests] = useState<Option[]>([]);
  const [guardiansList, setGuardiansList] = useState<GuardianOption[]>([]);
  const [isLoading, setIsLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);

  useEffect(() => {
    if (youthId) {
      fetchData();
    }
  }, [youthId]);

  const fetchData = async () => {
    setIsLoading(true);
    setError(null);
    try {
      // Fetch user data
      const userRes = await api.get(`/users/${youthId}/`);
      setUser(userRes.data);

      // Fetch dropdowns for display
      const clubRes = await api.get('/clubs/');
      setClubs(Array.isArray(clubRes.data) ? clubRes.data : (clubRes.data?.results || []));
      
      const interestRes = await api.get('/interests/');
      setInterests(Array.isArray(interestRes.data) ? interestRes.data : (interestRes.data?.results || []));

      const guardianRes = await api.get('/users/list_guardians/');
      setGuardiansList(guardianRes.data);
    } catch (err: any) {
      setError(err?.response?.status === 404 ? 'Youth member not found' : 'Failed to load youth member');
      console.error(err);
    } finally {
      setIsLoading(false);
    }
  };

  // Calculate age from date of birth
  const calculateAge = (dateOfBirth: string | null) => {
    if (!dateOfBirth) return null;
    const today = new Date();
    const birthDate = new Date(dateOfBirth);
    let age = today.getFullYear() - birthDate.getFullYear();
    const monthDiff = today.getMonth() - birthDate.getMonth();
    if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
      age--;
    }
    return age;
  };

  if (isLoading) {
    return (
      <div className="p-8 text-center">
        <p className="text-gray-500">Loading youth member details...</p>
      </div>
    );
  }

  if (error || !user) {
    return (
      <div className="p-8">
        <div className="bg-red-50 border border-red-200 rounded-lg p-4 mb-4">
          <p className="text-red-800">{error || 'Youth member not found'}</p>
        </div>
        <Link href="/admin/super/youth" className="text-blue-600 hover:text-blue-800">
          ‚Üê Back to Youth Members
        </Link>
      </div>
    );
  }

  // Normalize interests/guardians (handle API variations)
  const interestIds = user.interests?.map((i: any) => typeof i === 'object' ? i.id : i) || [];
  const guardianIds = user.guardians || [];

  return (
    <div className="p-8">
      {/* HEADER */}
      <div className="flex items-center justify-between mb-6">
        <Link href="/admin/super/youth" className="text-blue-600 hover:text-blue-800 font-medium">
          ‚Üê Back to Youth Members
        </Link>
        <div className="flex gap-4">
          <button
            onClick={() => router.push(`/admin/super/youth?edit=${user.id}`)}
            className="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700"
          >
            Edit Profile
          </button>
        </div>
      </div>

      {/* PROFILE HEADER */}
      <div className="bg-white rounded-xl shadow-lg overflow-hidden mb-6">
        <div className="p-8">
          <div className="flex items-center gap-6 pb-6 border-b">
            {user.avatar && (
              <img 
                src={getMediaUrl(user.avatar) || ''} 
                alt={`${user.first_name} ${user.last_name}`}
                className="w-32 h-32 rounded-full object-cover border-4 border-gray-200"
                onError={(e) => (e.target as HTMLImageElement).style.display='none'} 
              />
            )}
            <div className="flex-1">
              <h1 className="text-4xl font-bold text-gray-900 mb-2">
                {user.first_name} {user.last_name}
                {user.nickname && <span className="text-2xl font-normal text-gray-500 ml-3">({user.nickname})</span>}
              </h1>
              <p className="text-lg text-gray-600 mb-3">{user.email}</p>
              <div className="flex items-center gap-4">
                <span className={`px-3 py-1 text-xs font-bold rounded-full ${
                  user.verification_status === 'VERIFIED' ? 'bg-green-100 text-green-800' :
                  user.verification_status === 'PENDING' ? 'bg-yellow-100 text-yellow-800' :
                  'bg-gray-100 text-gray-600'
                }`}>
                  {user.verification_status || 'UNVERIFIED'}
                </span>
                {user.phone_number && (
                  <span className="text-sm text-gray-600">üìû {user.phone_number}</span>
                )}
                {user.is_active !== undefined && (
                  <span className={`px-2 py-1 rounded text-xs font-bold ${
                    user.is_active ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'
                  }`}>
                    {user.is_active ? 'Active' : 'Inactive'}
                  </span>
                )}
              </div>
            </div>
          </div>
        </div>
      </div>

      <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
        {/* MAIN CONTENT */}
        <div className="lg:col-span-2 space-y-6">
          {/* BASIC INFORMATION */}
          <div className="bg-white rounded-xl shadow p-6">
            <h2 className="text-2xl font-bold text-gray-800 mb-4">Basic Information</h2>
            <div className="grid grid-cols-2 gap-4">
              <div>
                <p className="text-sm text-gray-500 font-bold uppercase mb-1">First Name</p>
                <p className="text-gray-900 font-medium">{user.first_name || '-'}</p>
              </div>
              <div>
                <p className="text-sm text-gray-500 font-bold uppercase mb-1">Last Name</p>
                <p className="text-gray-900 font-medium">{user.last_name || '-'}</p>
              </div>
              <div>
                <p className="text-sm text-gray-500 font-bold uppercase mb-1">Email</p>
                <p className="text-gray-900 font-medium">{user.email || '-'}</p>
              </div>
              <div>
                <p className="text-sm text-gray-500 font-bold uppercase mb-1">Phone Number</p>
                <p className="text-gray-900 font-medium">{user.phone_number || '-'}</p>
              </div>
              <div>
                <p className="text-sm text-gray-500 font-bold uppercase mb-1">Date of Birth</p>
                <p className="text-gray-900 font-medium">{user.date_of_birth || '-'}</p>
              </div>
              <div>
                <p className="text-sm text-gray-500 font-bold uppercase mb-1">Age</p>
                <p className="text-gray-900 font-medium">{calculateAge(user.date_of_birth) || '-'}</p>
              </div>
            </div>
          </div>

          {/* DEMOGRAPHICS */}
          <div className="bg-white rounded-xl shadow p-6">
            <h2 className="text-2xl font-bold text-gray-800 mb-4">Demographics</h2>
            <div className="grid grid-cols-2 gap-4">
              <div>
                <p className="text-sm text-gray-500 font-bold uppercase mb-1">Grade</p>
                <p className="text-gray-900 font-medium">{user.grade || '-'}</p>
              </div>
              <div>
                <p className="text-sm text-gray-500 font-bold uppercase mb-1">Legal Gender</p>
                <p className="text-gray-900 font-medium">{user.legal_gender || '-'}</p>
              </div>
              <div>
                <p className="text-sm text-gray-500 font-bold uppercase mb-1">Preferred Gender</p>
                <p className="text-gray-900 font-medium">{user.preferred_gender || '-'}</p>
              </div>
              <div>
                <p className="text-sm text-gray-500 font-bold uppercase mb-1">Preferred Club</p>
                <p className="text-gray-900 font-medium">
                  {clubs.find(c => c.id === user.preferred_club)?.name || '-'}
                </p>
              </div>
            </div>
          </div>

          {/* GUARDIANS */}
          {guardianIds.length > 0 && (
            <div className="bg-white rounded-xl shadow p-6">
              <h2 className="text-2xl font-bold text-gray-800 mb-4">Assigned Guardians</h2>
              <div className="space-y-3">
                {guardianIds.map((guardianId: number) => {
                  const guardian = guardiansList.find(g => g.id === guardianId);
                  return guardian ? (
                    <div key={guardianId} className="flex items-center gap-3 p-3 bg-gray-50 rounded-lg border">
                      <div className="flex-1">
                        <p className="text-sm font-medium text-gray-900">
                          {guardian.first_name} {guardian.last_name}
                        </p>
                        <p className="text-xs text-gray-500">{guardian.email}</p>
                      </div>
                    </div>
                  ) : null;
                })}
              </div>
            </div>
          )}

          {/* INTERESTS */}
          {interestIds.length > 0 && (
            <div className="bg-white rounded-xl shadow p-6">
              <h2 className="text-2xl font-bold text-gray-800 mb-4">Interests</h2>
              <div className="flex flex-wrap gap-2">
                {interestIds.map((interestId: number) => {
                  const interestData = interests.find(i => i.id === interestId);
                  return interestData ? (
                    <span 
                      key={interestId}
                      className="px-3 py-1 bg-blue-100 text-blue-800 text-sm font-medium rounded-full"
                    >
                      {interestData.name}
                    </span>
                  ) : null;
                })}
              </div>
            </div>
          )}

          {/* CUSTOM FIELDS */}
          <CustomFieldsDisplay
            userId={user.id}
            targetRole="YOUTH_MEMBER"
            context="USER_PROFILE"
          />
        </div>

        {/* SIDEBAR */}
        <div className="space-y-6">
          {/* ACCOUNT INFO */}
          <div className="bg-white rounded-xl shadow p-6">
            <h3 className="text-lg font-bold text-gray-800 mb-4">Account Information</h3>
            <div className="space-y-3">
              <div>
                <p className="text-xs text-gray-500 font-bold uppercase mb-1">Date Joined</p>
                <p className="text-sm font-medium">
                  {user.date_joined ? new Date(user.date_joined).toLocaleDateString() : '-'}
                </p>
              </div>
              <div>
                <p className="text-xs text-gray-500 font-bold uppercase mb-1">Last Login</p>
                <p className="text-sm font-medium">
                  {user.last_login ? new Date(user.last_login).toLocaleDateString() : 'Never'}
                </p>
              </div>
              <div>
                <p className="text-xs text-gray-500 font-bold uppercase mb-1">Account Status</p>
                <span className={`inline-block px-2 py-1 rounded text-xs font-bold ${
                  user.is_active ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'
                }`}>
                  {user.is_active ? 'Active' : 'Inactive'}
                </span>
              </div>
              <div>
                <p className="text-xs text-gray-500 font-bold uppercase mb-1">Preferred Language</p>
                <p className="text-sm font-medium">{user.preferred_language || '-'}</p>
              </div>
            </div>
          </div>

          {/* ACTIONS */}
          <div className="bg-white rounded-xl shadow p-6">
            <h3 className="text-lg font-bold text-gray-800 mb-4">Actions</h3>
            <div className="space-y-2">
              <button
                onClick={() => router.push(`/admin/super/youth?edit=${user.id}`)}
                className="w-full bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 text-center"
              >
                Edit Profile
              </button>
              <Link
                href="/admin/super/youth"
                className="block w-full bg-gray-100 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-200 text-center"
              >
                Back to List
              </Link>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
}

export default function YouthViewPage() {
  return (
    <Suspense fallback={<div className="p-8 text-center">Loading...</div>}>
      <YouthViewPageContent />
    </Suspense>
  );
}


--- END OF FILE: ./frontend/app/admin/super/youth/[id]/page.tsx ---


--- START OF FILE: ./frontend/app/admin/super/guardians/page.tsx ---
'use client';

import { useState, useEffect, Suspense } from 'react';
import { useRouter, useSearchParams, usePathname } from 'next/navigation';
import Link from 'next/link';
import api from '../../../../lib/api';
import { getMediaUrl } from '../../../utils';
import Toast from '../../../components/Toast';
import DeleteConfirmationModal from '../../../components/DeleteConfirmationModal';
import CustomFieldsForm from '../../../components/CustomFieldsForm';

interface YouthOption { id: number; first_name: string; last_name: string; email: string; grade: number; }

function ManageGuardiansPageContent() {
  const router = useRouter();
  const pathname = usePathname();
  const searchParams = useSearchParams();

  // --- STATE ---
  const [users, setUsers] = useState<any[]>([]);
  const [totalCount, setTotalCount] = useState(0);
  const [isLoading, setIsLoading] = useState(true);
  const [stats, setStats] = useState<any>(null);
  const [analyticsExpanded, setAnalyticsExpanded] = useState(true);
  const [avatarErrors, setAvatarErrors] = useState<Set<number>>(new Set());
  
  // Toast State
  const [toast, setToast] = useState<{ message: string; type: 'success' | 'error' | 'info' | 'warning'; isVisible: boolean }>({
    message: '',
    type: 'success',
    isVisible: false,
  });

  // Dropdowns
  const [youthList, setYouthList] = useState<YouthOption[]>([]);

  // Modal
  const [showModal, setShowModal] = useState(false);
  const [isEditing, setIsEditing] = useState(false);
  const [editUserId, setEditUserId] = useState<number | null>(null);
  const [avatarFile, setAvatarFile] = useState<File | null>(null);
  const [avatarPreview, setAvatarPreview] = useState<string | null>(null);
  
  // Youth search
  const [youthSearchTerm, setYouthSearchTerm] = useState('');
  const [showYouthDropdown, setShowYouthDropdown] = useState(false);
  
  // Delete Confirmation Modal State
  const [showDeleteModal, setShowDeleteModal] = useState(false);
  const [userToDelete, setUserToDelete] = useState<{ id: number; name: string } | null>(null);
  const [isDeleting, setIsDeleting] = useState(false);

  const initialFormState = {
    email: '', password: '', first_name: '', last_name: '', 
    phone_number: '', legal_gender: 'MALE',
    verification_status: 'UNVERIFIED',
    youth_members: [] as number[], // Array of Youth IDs
  };

  const [formData, setFormData] = useState(initialFormState);
  const [customFieldValues, setCustomFieldValues] = useState<Record<number, any>>({});

  // --- LOAD DATA ---
  useEffect(() => {
    fetchDropdowns();
    fetchStats();
  }, []);

  useEffect(() => {
    fetchGuardians();
  }, [searchParams]);

  // Handle edit parameter from URL (e.g., from view page)
  useEffect(() => {
    const editId = searchParams.get('edit');
    if (editId && !isEditing && !showModal) {
      const userId = parseInt(editId);
      // Try to find user in current list first
      const userToEdit = users.find(u => u.id === userId);
      if (userToEdit) {
        handleOpenEdit(userToEdit);
      } else if (users.length > 0) {
        // User not in current page, fetch it directly
        api.get(`/users/${userId}/`).then(res => {
          handleOpenEdit(res.data);
        }).catch(err => {
          console.error('Failed to load user for editing:', err);
        });
      }
    }
  }, [searchParams, users.length, isEditing, showModal]);

  const fetchStats = async () => {
    try {
      const res = await api.get('/users/guardian_stats/');
      setStats(res.data);
    } catch (err) { console.error(err); }
  };

  const fetchDropdowns = async () => {
    try {
      const youthRes = await api.get('/users/list_youth/');
      setYouthList(youthRes.data);
    } catch (err) { console.error(err); }
  };

  const fetchGuardians = async () => {
    setIsLoading(true);
    try {
      const params = new URLSearchParams();
      // Always force role to GUARDIAN - this page only shows guardians
      params.set('role', 'GUARDIAN');
      
      // Add filters from URL
      const search = searchParams.get('search');
      if (search) params.set('search', search);
      
      const gender = searchParams.get('legal_gender');
      if (gender) params.set('legal_gender', gender);
      
      const status = searchParams.get('verification_status');
      if (status) params.set('verification_status', status);
      
      const page = searchParams.get('page');
      if (page) params.set('page', page);
      
      const res = await api.get(`/users/?${params.toString()}`);
      
      // Handle paginated response
      if (res.data.results) {
        const guardiansOnly = res.data.results.filter((user: any) => user.role === 'GUARDIAN');
        setUsers(guardiansOnly);
        setTotalCount(res.data.count || guardiansOnly.length);
      } else {
        // Non-paginated response
        const guardiansOnly = (Array.isArray(res.data) ? res.data : []).filter((user: any) => user.role === 'GUARDIAN');
        setUsers(guardiansOnly);
        setTotalCount(guardiansOnly.length);
      }
    } catch (err) { 
      console.error('Error fetching guardians:', err); 
    } 
    finally { setIsLoading(false); }
  };

  const updateUrl = (key: string, value: string) => {
    const params = new URLSearchParams(searchParams.toString());
    if (value) params.set(key, value); else params.delete(key);
    if (key !== 'page') params.set('page', '1');
    router.push(`${pathname}?${params.toString()}`);
  };

  // --- HANDLERS ---
  const handleOpenCreate = () => {
    setIsEditing(false);
    setEditUserId(null);
    setFormData(initialFormState);
    setCustomFieldValues({});
    setAvatarFile(null);
    setAvatarPreview(null);
    setYouthSearchTerm('');
    setShowYouthDropdown(false);
    setShowModal(true);
  };

  const handleOpenEdit = async (user: any) => {
    setIsEditing(true);
    setEditUserId(user.id);
    
    // The serializer now returns 'youth_members' as a list of IDs
    const youthIds = user.youth_members || [];
    
    setFormData({
      email: user.email, password: '', 
      first_name: user.first_name || '', last_name: user.last_name || '',
      phone_number: user.phone_number || '',
      legal_gender: user.legal_gender || 'MALE',
      verification_status: user.verification_status || 'UNVERIFIED',
      youth_members: youthIds
    });
    setAvatarFile(null);
    setAvatarPreview(user.avatar ? getMediaUrl(user.avatar) : null);
    setYouthSearchTerm('');
    setShowYouthDropdown(false);
    
    // Load custom field values for this user
    try {
      const userRes = await api.get(`/users/${user.id}/`);
      const customFieldValuesData = userRes.data.custom_field_values || [];
      const values: Record<number, any> = {};
      customFieldValuesData.forEach((cfv: any) => {
        values[cfv.field] = cfv.value;
      });
      setCustomFieldValues(values);
    } catch (err) {
      console.error('Failed to load custom field values:', err);
      setCustomFieldValues({});
    }
    
    setShowModal(true);
  };

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    try {
      const data = new FormData();
      
      // Basic fields
      Object.entries(formData).forEach(([key, value]) => {
        if (key === 'password' && !value) return;
        if (key === 'youth_members') return;
        data.append(key, value.toString());
      });
      
      // Handle Youth Array
      formData.youth_members.forEach(id => data.append('youth_members', id.toString()));
      
      data.append('role', 'GUARDIAN');
      if (avatarFile) data.append('avatar', avatarFile);

      const config = { headers: { 'Content-Type': 'multipart/form-data' } };
      let userId: number;
      if (isEditing && editUserId) {
        await api.patch(`/users/${editUserId}/`, data, config);
        userId = editUserId;
        setToast({
          message: 'Guardian updated successfully!',
          type: 'success',
          isVisible: true,
        });
      } else {
        const res = await api.post('/users/', data, config);
        userId = res.data.id;
        setToast({
          message: 'Guardian created successfully!',
          type: 'success',
          isVisible: true,
        });
      }

      // Save custom field values
      if (Object.keys(customFieldValues).length > 0) {
        try {
          await api.post('/custom-fields/save_values_for_user/', {
            user_id: userId,
            values: customFieldValues,
          });
        } catch (err) {
          console.error('Failed to save custom field values:', err);
        }
      }

      setShowModal(false);
      fetchGuardians();
      fetchStats();
    } catch (err) { 
      setToast({
        message: 'Operation failed. Please try again.',
        type: 'error',
        isVisible: true,
      });
      console.error(err); 
    }
  };

  const handleDeleteClick = (user: any) => {
    setUserToDelete({ id: user.id, name: `${user.first_name} ${user.last_name}` });
    setShowDeleteModal(true);
  };

  const handleDeleteConfirm = async () => {
    if (!userToDelete) return;

    setIsDeleting(true);
    try { 
      await api.delete(`/users/${userToDelete.id}/`);
      setToast({
        message: 'Guardian deleted successfully!',
        type: 'success',
        isVisible: true,
      });
      setShowDeleteModal(false);
      setUserToDelete(null);
      fetchGuardians(); 
      fetchStats(); 
    } 
    catch (err) { 
      setToast({
        message: 'Failed to delete guardian.',
        type: 'error',
        isVisible: true,
      });
    } finally {
      setIsDeleting(false);
    }
  };

  const handleAvatarChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (file) {
      setAvatarFile(file);
      const reader = new FileReader();
      reader.onloadend = () => setAvatarPreview(reader.result as string);
      reader.readAsDataURL(file);
    }
  };

  const toggleYouth = (id: number) => {
    setFormData(prev => {
      const exists = prev.youth_members.includes(id);
      if (exists) return { ...prev, youth_members: prev.youth_members.filter(i => i !== id) };
      return { ...prev, youth_members: [...prev.youth_members, id] };
    });
    setYouthSearchTerm('');
    setShowYouthDropdown(false);
  };

  const removeYouth = (id: number) => {
    setFormData(prev => ({
      ...prev,
      youth_members: prev.youth_members.filter(i => i !== id)
    }));
  };

  // Filter youth based on search term
  const filteredYouth = youthList.filter(y => {
    const searchLower = youthSearchTerm.toLowerCase();
    const fullName = `${y.first_name} ${y.last_name}`.toLowerCase();
    const email = y.email.toLowerCase();
    return (fullName.includes(searchLower) || email.includes(searchLower)) && 
           !formData.youth_members.includes(y.id);
  });

  // Get selected youth details
  const getSelectedYouth = () => {
    return formData.youth_members.map(id => youthList.find(y => y.id === id)).filter(Boolean) as YouthOption[];
  };

  // Helper function to get initials from name
  const getInitials = (firstName: string = '', lastName: string = '') => {
    const first = firstName?.charAt(0)?.toUpperCase() || '';
    const last = lastName?.charAt(0)?.toUpperCase() || '';
    return first + last || '?';
  };

  // Helper function to get avatar color (consistent for all guardians)
  const getAvatarColor = () => {
    return 'bg-blue-200 text-blue-800';
  };

  const currentPage = Number(searchParams.get('page')) || 1;
  const totalPages = Math.ceil(totalCount / 10);

  return (
    <div>
      <div className="flex justify-between items-center mb-6">
        <h1 className="text-2xl font-bold text-gray-800">Manage Guardians</h1>
        <button onClick={handleOpenCreate} className="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 shadow">
          + Create New Guardian
        </button>
      </div>

      {/* --- ANALYTICS HUD --- */}
      {stats && (
        <div className="mb-6">
          {/* Toggle Button */}
          <button
            onClick={() => setAnalyticsExpanded(!analyticsExpanded)}
            className="flex items-center justify-between w-full bg-white rounded-lg shadow-sm border border-gray-200 p-3 hover:bg-gray-50 transition-colors mb-3"
          >
            <div className="flex items-center gap-2">
              <svg className="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
              </svg>
              <span className="text-sm font-semibold text-gray-700">Analytics Dashboard</span>
            </div>
            <svg 
              className={`w-5 h-5 text-gray-600 transition-transform duration-200 ${analyticsExpanded ? 'rotate-180' : ''}`}
              fill="none" 
              stroke="currentColor" 
              viewBox="0 0 24 24"
            >
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
            </svg>
          </button>

          {/* Analytics Cards - Collapsible */}
          <div 
            className={`grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 transition-all duration-500 ease-in-out ${
              analyticsExpanded 
                ? 'max-h-[600px] opacity-100 translate-y-0' 
                : 'max-h-0 opacity-0 -translate-y-4 pointer-events-none'
            } overflow-hidden`}
          >
            {/* Card 1: Total Guardians */}
            <div className="bg-gradient-to-br from-blue-500 to-blue-600 rounded-xl shadow-md p-4 text-white transform hover:scale-105 transition-all duration-200">
              <div className="flex items-center justify-between mb-2">
                <div className="bg-white/20 rounded-lg p-2">
                  <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                  </svg>
                </div>
              </div>
              <h3 className="text-blue-100 text-xs font-semibold uppercase tracking-wider mb-1">Total Guardians</h3>
              <p className="text-3xl font-bold mb-0.5">{stats.total_guardians}</p>
              <p className="text-blue-100 text-xs">Active guardians</p>
            </div>

            {/* Card 2: Verified */}
            <div className="bg-gradient-to-br from-green-500 to-green-600 rounded-xl shadow-md p-4 text-white transform hover:scale-105 transition-all duration-200">
              <div className="flex items-center justify-between mb-2">
                <div className="bg-white/20 rounded-lg p-2">
                  <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                  </svg>
                </div>
              </div>
              <h3 className="text-green-100 text-xs font-semibold uppercase tracking-wider mb-1">Verified</h3>
              <p className="text-3xl font-bold mb-0.5">{stats.verification.verified}</p>
              <p className="text-green-100 text-xs">Identity verified</p>
            </div>

            {/* Card 3: Pending */}
            <div className="bg-gradient-to-br from-yellow-500 to-yellow-600 rounded-xl shadow-md p-4 text-white transform hover:scale-105 transition-all duration-200">
              <div className="flex items-center justify-between mb-2">
                <div className="bg-white/20 rounded-lg p-2">
                  <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                  </svg>
                </div>
              </div>
              <h3 className="text-yellow-100 text-xs font-semibold uppercase tracking-wider mb-1">Pending</h3>
              <p className="text-3xl font-bold mb-0.5">{stats.verification.pending}</p>
              <p className="text-yellow-100 text-xs">Awaiting verification</p>
            </div>

            {/* Card 4: Active (7 Days) */}
            <div className="bg-gradient-to-br from-purple-500 to-purple-600 rounded-xl shadow-md p-4 text-white transform hover:scale-105 transition-all duration-200">
              <div className="flex items-center justify-between mb-2">
                <div className="bg-white/20 rounded-lg p-2">
                  <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" />
                  </svg>
                </div>
              </div>
              <h3 className="text-purple-100 text-xs font-semibold uppercase tracking-wider mb-1">Active (7 Days)</h3>
              <p className="text-3xl font-bold mb-0.5">{stats.activity.active_7_days}</p>
              <p className="text-purple-100 text-xs">Recently active</p>
            </div>
          </div>
        </div>
      )}

      {/* --- FILTER BAR --- */}
      <div className="bg-white p-4 rounded-lg shadow mb-6 border border-gray-100">
        <div className="flex flex-wrap gap-4 items-end">
          {/* Search Field */}
          <div className="flex-1 min-w-[200px]">
            <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Search</label>
            <input
              type="text"
              placeholder="First name, last name, or email..."
              className="w-full border rounded p-2 text-sm bg-gray-50"
              value={searchParams.get('search') || ''}
              onChange={(e) => updateUrl('search', e.target.value)}
            />
          </div>

          {/* Gender */}
          <div className="w-40">
            <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Gender</label>
            <select
              className="w-full border rounded p-2 text-sm bg-gray-50"
              value={searchParams.get('legal_gender') || ''}
              onChange={(e) => updateUrl('legal_gender', e.target.value)}
            >
              <option value="">All Genders</option>
              <option value="MALE">Male</option>
              <option value="FEMALE">Female</option>
              <option value="OTHER">Other</option>
            </select>
          </div>

          {/* Status */}
          <div className="w-40">
            <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Status</label>
            <select
              className="w-full border rounded p-2 text-sm bg-gray-50"
              value={searchParams.get('verification_status') || ''}
              onChange={(e) => updateUrl('verification_status', e.target.value)}
            >
              <option value="">All Statuses</option>
              <option value="UNVERIFIED">Unverified</option>
              <option value="PENDING">Pending</option>
              <option value="VERIFIED">Verified</option>
            </select>
          </div>

          {/* Clear Filters Button */}
          <button
            onClick={() => router.push(pathname)}
            className="px-4 py-2 text-sm text-gray-600 hover:text-red-600 hover:bg-red-50 border border-gray-300 rounded transition-colors"
          >
            Clear Filters
          </button>
        </div>
      </div>

      {/* --- LIST --- */}
      <div className="bg-white rounded-lg shadow overflow-hidden mb-6">
        <table className="min-w-full divide-y divide-gray-200">
          <thead className="bg-gray-50">
            <tr>
              <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Guardian</th>
              <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
              <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Connected Youth</th>
              <th className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">Actions</th>
            </tr>
          </thead>
          <tbody className="bg-white divide-y divide-gray-200">
            {users.map((user) => (
              <tr key={user.id}>
                <td className="px-6 py-4 whitespace-nowrap">
                  <div className="flex items-center">
                    {user.avatar && !avatarErrors.has(user.id) ? (
                      <img 
                        src={getMediaUrl(user.avatar) || ''}
                        alt="Avatar"
                        className="w-10 h-10 rounded-full object-cover mr-3"
                        onError={() => {
                          setAvatarErrors(prev => new Set(prev).add(user.id));
                        }}
                      />
                    ) : (
                      <div className={`w-10 h-10 rounded-full ${getAvatarColor()} flex items-center justify-center font-semibold text-sm mr-3`}>
                        {getInitials(user.first_name, user.last_name)}
                      </div>
                    )}
                    <div>
                        <div className="text-sm font-medium text-gray-900">{user.first_name} {user.last_name}</div>
                        <div className="text-xs text-gray-500">{user.email}</div>
                    </div>
                  </div>
                </td>
                <td className="px-6 py-4 whitespace-nowrap">
                   <span className={`px-2 py-1 text-xs font-bold rounded-full ${
                       user.verification_status === 'VERIFIED' ? 'bg-green-100 text-green-800' :
                       user.verification_status === 'PENDING' ? 'bg-yellow-100 text-yellow-800' :
                       'bg-gray-100 text-gray-600'
                   }`}>
                       {user.verification_status || 'UNVERIFIED'}
                   </span>
                </td>
                <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                  <span className="font-bold">{user.youth_members ? user.youth_members.length : 0}</span> linked
                </td>
                <td className="px-6 py-4 whitespace-nowrap text-right text-sm font-medium space-x-4">
                  <Link href={`/admin/super/guardians/${user.id}`} className="text-blue-600 hover:text-blue-900 font-bold">View</Link>
                  <button onClick={() => handleOpenEdit(user)} className="text-indigo-600 hover:text-indigo-900 font-bold">Edit</button>
                  <button onClick={() => handleDeleteClick(user)} className="text-red-600 hover:text-red-900">Delete</button>
                </td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>

      {/* --- PAGINATION CONTROLS --- */}
      <div className="flex items-center justify-between border-t border-gray-200 bg-white px-4 py-3 sm:px-6 rounded-lg shadow">
        <div className="flex flex-1 justify-between sm:hidden">
          <button 
            disabled={currentPage === 1}
            onClick={() => updateUrl('page', (currentPage - 1).toString())}
            className="relative inline-flex items-center rounded-md border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50 disabled:opacity-50"
          >
            Previous
          </button>
          <button 
            disabled={currentPage >= totalPages}
            onClick={() => updateUrl('page', (currentPage + 1).toString())}
            className="relative ml-3 inline-flex items-center rounded-md border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50 disabled:opacity-50"
          >
            Next
          </button>
        </div>
        <div className="hidden sm:flex sm:flex-1 sm:items-center sm:justify-between">
          <div>
            <p className="text-sm text-gray-700">
              Showing page <span className="font-medium">{currentPage}</span> of <span className="font-medium">{totalPages}</span>
              {' '}(Total: {totalCount})
            </p>
          </div>
          <div>
            <nav className="isolate inline-flex -space-x-px rounded-md shadow-sm" aria-label="Pagination">
              <button
                disabled={currentPage === 1}
                onClick={() => updateUrl('page', (currentPage - 1).toString())}
                className="relative inline-flex items-center rounded-l-md px-2 py-2 text-gray-400 ring-1 ring-inset ring-gray-300 hover:bg-gray-50 focus:z-20 focus:outline-offset-0 disabled:opacity-50"
              >
                <span className="sr-only">Previous</span>
                ‚Üê Prev
              </button>
              
              {/* Simple Pagination Numbers */}
              {[...Array(totalPages)].map((_, i) => {
                const p = i + 1;
                return (
                  <button
                    key={p}
                    onClick={() => updateUrl('page', p.toString())}
                    className={`relative inline-flex items-center px-4 py-2 text-sm font-semibold 
                      ${p === currentPage 
                        ? 'bg-blue-600 text-white focus:z-20 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-blue-600' 
                        : 'text-gray-900 ring-1 ring-inset ring-gray-300 hover:bg-gray-50 focus:z-20 focus:outline-offset-0'}`}
                  >
                    {p}
                  </button>
                );
              })}

              <button
                disabled={currentPage >= totalPages}
                onClick={() => updateUrl('page', (currentPage + 1).toString())}
                className="relative inline-flex items-center rounded-r-md px-2 py-2 text-gray-400 ring-1 ring-inset ring-gray-300 hover:bg-gray-50 focus:z-20 focus:outline-offset-0 disabled:opacity-50"
              >
                <span className="sr-only">Next</span>
                Next ‚Üí
              </button>
            </nav>
          </div>
        </div>
      </div>

      {/* --- MODAL --- */}
      {showModal && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-xl shadow-2xl w-full max-w-2xl p-8 max-h-[90vh] overflow-y-auto">
            <h2 className="text-2xl font-bold mb-6 text-gray-800">{isEditing ? 'Edit Guardian' : 'Create Guardian'}</h2>
            <form onSubmit={handleSubmit} className="space-y-6">
              
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <input required type="text" placeholder="First Name" className="border p-2 rounded" value={formData.first_name} onChange={e => setFormData({...formData, first_name: e.target.value})} />
                <input required type="text" placeholder="Last Name" className="border p-2 rounded" value={formData.last_name} onChange={e => setFormData({...formData, last_name: e.target.value})} />
                
                <input required type="email" placeholder="Email" className="border p-2 rounded" value={formData.email} onChange={e => setFormData({...formData, email: e.target.value})} />
                <input type="password" placeholder={isEditing ? "New Password" : "Password"} className="border p-2 rounded" required={!isEditing} value={formData.password} onChange={e => setFormData({...formData, password: e.target.value})} />
                
                <input type="text" placeholder="Phone" className="border p-2 rounded" value={formData.phone_number} onChange={e => setFormData({...formData, phone_number: e.target.value})} />
                
                <select className="border p-2 rounded" value={formData.legal_gender} onChange={e => setFormData({...formData, legal_gender: e.target.value})}>
                    <option value="MALE">Male</option> <option value="FEMALE">Female</option> <option value="OTHER">Other</option>
                </select>
              </div>

              {/* VERIFICATION */}
              <div className="bg-blue-50 p-4 rounded-lg border border-blue-100">
                  <label className="block text-sm font-bold text-blue-800 mb-2">Verification Status</label>
                  <div className="flex gap-4">
                      {['UNVERIFIED', 'PENDING', 'VERIFIED'].map(status => (
                          <label key={status} className="flex items-center space-x-2 cursor-pointer">
                              <input 
                                  type="radio" 
                                  name="verification_status"
                                  value={status}
                                  checked={formData.verification_status === status}
                                  onChange={e => setFormData({...formData, verification_status: e.target.value})}
                                  className="text-blue-600"
                              />
                              <span className="text-sm font-medium">{status}</span>
                          </label>
                      ))}
                  </div>
              </div>

              {/* YOUTH ASSIGNMENT */}
              <div>
                  <label className="block text-sm font-bold mb-2">Assign Youth Members</label>
                  
                  {/* Selected Youth Display */}
                  {formData.youth_members.length > 0 && (
                    <div className="flex flex-wrap gap-2 mb-3 p-3 bg-green-50 rounded-lg border border-green-200">
                      {getSelectedYouth().map(y => (
                        <span 
                          key={y.id}
                          className="inline-flex items-center gap-1.5 px-3 py-1.5 bg-green-600 text-white text-sm rounded-full font-medium"
                        >
                          {y.first_name} {y.last_name} {y.grade && `(Gr ${y.grade})`}
                          <button
                            type="button"
                            onClick={() => removeYouth(y.id)}
                            className="hover:bg-green-700 rounded-full p-0.5 transition-colors"
                            aria-label={`Remove ${y.first_name} ${y.last_name}`}
                          >
                            <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                            </svg>
                          </button>
                        </span>
                      ))}
                    </div>
                  )}

                  {/* Searchable Dropdown */}
                  <div className="relative mb-4">
                    <div className="relative">
                      <input
                        type="text"
                        placeholder="Search youth members by name or email..."
                        value={youthSearchTerm}
                        onChange={(e) => {
                          setYouthSearchTerm(e.target.value);
                          setShowYouthDropdown(true);
                        }}
                        onFocus={() => setShowYouthDropdown(true)}
                        className="w-full border border-gray-300 rounded-lg p-2.5 pr-10 focus:ring-2 focus:ring-green-500 focus:border-green-500"
                      />
                      <svg 
                        className="absolute right-3 top-1/2 transform -translate-y-1/2 w-5 h-5 text-gray-400 pointer-events-none"
                        fill="none" 
                        stroke="currentColor" 
                        viewBox="0 0 24 24"
                      >
                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                      </svg>
                    </div>

                    {/* Dropdown List */}
                    {showYouthDropdown && (
                      <>
                        <div 
                          className="fixed inset-0 z-10" 
                          onClick={() => setShowYouthDropdown(false)}
                        ></div>
                        <div className="absolute z-20 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-60 overflow-y-auto">
                          {filteredYouth.length > 0 ? (
                            filteredYouth.map(y => (
                              <button
                                key={y.id}
                                type="button"
                                onClick={() => toggleYouth(y.id)}
                                className="w-full text-left px-4 py-2.5 hover:bg-green-50 transition-colors border-b border-gray-100 last:border-b-0"
                              >
                                <div className="font-medium text-gray-900">{y.first_name} {y.last_name}</div>
                                <div className="text-xs text-gray-500">{y.email} {y.grade && `‚Ä¢ Grade ${y.grade}`}</div>
                              </button>
                            ))
                          ) : youthSearchTerm ? (
                            <div className="px-4 py-3 text-sm text-gray-500 text-center">
                              No youth members found matching "{youthSearchTerm}"
                            </div>
                          ) : (
                            <div className="px-4 py-3 text-sm text-gray-500 text-center">
                              {formData.youth_members.length === 0 
                                ? 'No youth members found. Create a youth member first.'
                                : 'All youth members are already selected.'}
                            </div>
                          )}
                        </div>
                      </>
                    )}
                  </div>
              </div>

               {/* AVATAR */}
               <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">Avatar</label>
                <input type="file" accept="image/*" className="w-full border p-2 rounded" onChange={handleAvatarChange} />
                {avatarPreview && <img src={avatarPreview} alt="Preview" className="w-16 h-16 mt-2 rounded-full object-cover border" />}
              </div>

              {/* Custom Fields */}
              <CustomFieldsForm
                targetRole="GUARDIAN"
                context="USER_PROFILE"
                values={customFieldValues}
                onChange={(fieldId, value) => {
                  setCustomFieldValues((prev) => ({
                    ...prev,
                    [fieldId]: value,
                  }));
                }}
                userId={isEditing ? editUserId : null}
                userMunicipalityId={null}
                userClubId={null}
              />

              <div className="flex justify-end gap-4 pt-4 border-t">
                <button type="button" onClick={() => setShowModal(false)} className="text-gray-500">Cancel</button>
                <button type="submit" className="bg-blue-600 text-white px-6 py-2 rounded">
                  {isEditing ? 'Save Changes' : 'Create Guardian'}
                </button>
              </div>
            </form>
          </div>
        </div>
      )}

      {/* Delete Confirmation Modal */}
      <DeleteConfirmationModal
        isVisible={showDeleteModal}
        onClose={() => {
          if (!isDeleting) {
            setShowDeleteModal(false);
            setUserToDelete(null);
          }
        }}
        onConfirm={handleDeleteConfirm}
        itemName={userToDelete?.name}
        isLoading={isDeleting}
      />

      {/* Toast Notification */}
      <Toast
        message={toast.message}
        type={toast.type}
        isVisible={toast.isVisible}
        onClose={() => setToast({ ...toast, isVisible: false })}
      />
    </div>
  );
}

export default function ManageGuardiansPage() {
  return (
    <Suspense fallback={<div>Loading...</div>}>
      <ManageGuardiansPageContent />
    </Suspense>
  );
}
--- END OF FILE: ./frontend/app/admin/super/guardians/page.tsx ---


--- START OF FILE: ./frontend/app/admin/super/guardians/[id]/page.tsx ---
'use client';

import { useState, useEffect, Suspense } from 'react';
import { useRouter, useParams } from 'next/navigation';
import Link from 'next/link';
import api from '../../../../../lib/api';
import { getMediaUrl } from '../../../../utils';
import CustomFieldsDisplay from '../../../../components/CustomFieldsDisplay';

interface YouthOption { id: number; first_name: string; last_name: string; email: string; grade: number; }

function GuardianViewPageContent() {
  const router = useRouter();
  const params = useParams();
  const guardianId = params?.id as string;

  const [user, setUser] = useState<any>(null);
  const [youthList, setYouthList] = useState<YouthOption[]>([]);
  const [isLoading, setIsLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);

  useEffect(() => {
    if (guardianId) {
      fetchData();
    }
  }, [guardianId]);

  const fetchData = async () => {
    setIsLoading(true);
    setError(null);
    try {
      // Fetch user data
      const userRes = await api.get(`/users/${guardianId}/`);
      setUser(userRes.data);

      // Fetch youth list for display
      const youthRes = await api.get('/users/list_youth/');
      setYouthList(youthRes.data);
    } catch (err: any) {
      setError(err?.response?.status === 404 ? 'Guardian not found' : 'Failed to load guardian');
      console.error(err);
    } finally {
      setIsLoading(false);
    }
  };

  if (isLoading) {
    return (
      <div className="p-8 text-center">
        <p className="text-gray-500">Loading guardian details...</p>
      </div>
    );
  }

  if (error || !user) {
    return (
      <div className="p-8">
        <div className="bg-red-50 border border-red-200 rounded-lg p-4 mb-4">
          <p className="text-red-800">{error || 'Guardian not found'}</p>
        </div>
        <Link href="/admin/super/guardians" className="text-blue-600 hover:text-blue-800">
          ‚Üê Back to Guardians
        </Link>
      </div>
    );
  }

  // Normalize youth_members (handle API variations)
  const youthIds = user.youth_members || [];

  return (
    <div className="p-8">
      {/* HEADER */}
      <div className="flex items-center justify-between mb-6">
        <Link href="/admin/super/guardians" className="text-blue-600 hover:text-blue-800 font-medium">
          ‚Üê Back to Guardians
        </Link>
        <div className="flex gap-4">
          <button
            onClick={() => router.push(`/admin/super/guardians?edit=${user.id}`)}
            className="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700"
          >
            Edit Profile
          </button>
        </div>
      </div>

      {/* PROFILE HEADER */}
      <div className="bg-white rounded-xl shadow-lg overflow-hidden mb-6">
        <div className="p-8">
          <div className="flex items-center gap-6 pb-6 border-b">
            {user.avatar && (
              <img 
                src={getMediaUrl(user.avatar) || ''} 
                alt={`${user.first_name} ${user.last_name}`}
                className="w-32 h-32 rounded-full object-cover border-4 border-gray-200"
                onError={(e) => (e.target as HTMLImageElement).style.display='none'} 
              />
            )}
            <div className="flex-1">
              <h1 className="text-4xl font-bold text-gray-900 mb-2">
                {user.first_name} {user.last_name}
              </h1>
              <p className="text-lg text-gray-600 mb-3">{user.email}</p>
              <div className="flex items-center gap-4">
                <span className={`px-3 py-1 text-xs font-bold rounded-full ${
                  user.verification_status === 'VERIFIED' ? 'bg-green-100 text-green-800' :
                  user.verification_status === 'PENDING' ? 'bg-yellow-100 text-yellow-800' :
                  'bg-gray-100 text-gray-600'
                }`}>
                  {user.verification_status || 'UNVERIFIED'}
                </span>
                {user.phone_number && (
                  <span className="text-sm text-gray-600">üìû {user.phone_number}</span>
                )}
                {user.is_active !== undefined && (
                  <span className={`px-2 py-1 rounded text-xs font-bold ${
                    user.is_active ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'
                  }`}>
                    {user.is_active ? 'Active' : 'Inactive'}
                  </span>
                )}
              </div>
            </div>
          </div>
        </div>
      </div>

      <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
        {/* MAIN CONTENT */}
        <div className="lg:col-span-2 space-y-6">
          {/* BASIC INFORMATION */}
          <div className="bg-white rounded-xl shadow p-6">
            <h2 className="text-2xl font-bold text-gray-800 mb-4">Basic Information</h2>
            <div className="grid grid-cols-2 gap-4">
              <div>
                <p className="text-sm text-gray-500 font-bold uppercase mb-1">First Name</p>
                <p className="text-gray-900 font-medium">{user.first_name || '-'}</p>
              </div>
              <div>
                <p className="text-sm text-gray-500 font-bold uppercase mb-1">Last Name</p>
                <p className="text-gray-900 font-medium">{user.last_name || '-'}</p>
              </div>
              <div>
                <p className="text-sm text-gray-500 font-bold uppercase mb-1">Email</p>
                <p className="text-gray-900 font-medium">{user.email || '-'}</p>
              </div>
              <div>
                <p className="text-sm text-gray-500 font-bold uppercase mb-1">Phone Number</p>
                <p className="text-gray-900 font-medium">{user.phone_number || '-'}</p>
              </div>
              <div>
                <p className="text-sm text-gray-500 font-bold uppercase mb-1">Legal Gender</p>
                <p className="text-gray-900 font-medium">{user.legal_gender || '-'}</p>
              </div>
            </div>
          </div>

          {/* CONNECTED YOUTH MEMBERS */}
          {youthIds.length > 0 && (
            <div className="bg-white rounded-xl shadow p-6">
              <h2 className="text-2xl font-bold text-gray-800 mb-4">Connected Youth Members</h2>
              <div className="space-y-3">
                {youthIds.map((youthId: number) => {
                  const youth = youthList.find(y => y.id === youthId);
                  return youth ? (
                    <div key={youthId} className="flex items-center gap-3 p-3 bg-gray-50 rounded-lg border">
                      <div className="flex-1">
                        <p className="text-sm font-medium text-gray-900">
                          {youth.first_name} {youth.last_name} (Grade {youth.grade})
                        </p>
                        <p className="text-xs text-gray-500">{youth.email}</p>
                      </div>
                    </div>
                  ) : null;
                })}
              </div>
            </div>
          )}

          {youthIds.length === 0 && (
            <div className="bg-white rounded-xl shadow p-6">
              <h2 className="text-2xl font-bold text-gray-800 mb-4">Connected Youth Members</h2>
              <p className="text-gray-500">No youth members connected to this guardian.</p>
            </div>
          )}

          {/* CUSTOM FIELDS */}
          <CustomFieldsDisplay
            userId={user.id}
            targetRole="GUARDIAN"
            context="USER_PROFILE"
          />
        </div>

        {/* SIDEBAR */}
        <div className="space-y-6">
          {/* ACCOUNT INFO */}
          <div className="bg-white rounded-xl shadow p-6">
            <h3 className="text-lg font-bold text-gray-800 mb-4">Account Information</h3>
            <div className="space-y-3">
              <div>
                <p className="text-xs text-gray-500 font-bold uppercase mb-1">Date Joined</p>
                <p className="text-sm font-medium">
                  {user.date_joined ? new Date(user.date_joined).toLocaleDateString() : '-'}
                </p>
              </div>
              <div>
                <p className="text-xs text-gray-500 font-bold uppercase mb-1">Last Login</p>
                <p className="text-sm font-medium">
                  {user.last_login ? new Date(user.last_login).toLocaleDateString() : 'Never'}
                </p>
              </div>
              <div>
                <p className="text-xs text-gray-500 font-bold uppercase mb-1">Account Status</p>
                <span className={`inline-block px-2 py-1 rounded text-xs font-bold ${
                  user.is_active ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'
                }`}>
                  {user.is_active ? 'Active' : 'Inactive'}
                </span>
              </div>
              <div>
                <p className="text-xs text-gray-500 font-bold uppercase mb-1">Preferred Language</p>
                <p className="text-sm font-medium">{user.preferred_language || '-'}</p>
              </div>
            </div>
          </div>

          {/* ACTIONS */}
          <div className="bg-white rounded-xl shadow p-6">
            <h3 className="text-lg font-bold text-gray-800 mb-4">Actions</h3>
            <div className="space-y-2">
              <button
                onClick={() => router.push(`/admin/super/guardians?edit=${user.id}`)}
                className="w-full bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 text-center"
              >
                Edit Profile
              </button>
              <Link
                href="/admin/super/guardians"
                className="block w-full bg-gray-100 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-200 text-center"
              >
                Back to List
              </Link>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
}

export default function GuardianViewPage() {
  return (
    <Suspense fallback={<div className="p-8 text-center">Loading...</div>}>
      <GuardianViewPageContent />
    </Suspense>
  );
}


--- END OF FILE: ./frontend/app/admin/super/guardians/[id]/page.tsx ---


--- START OF FILE: ./frontend/app/admin/super/profile/page.tsx ---
'use client';

import { Suspense, useEffect, useState } from 'react';
import api from '../../../../lib/api';
import { getMediaUrl } from '../../../utils';
import Toast from '../../../components/Toast';
import { useAuth } from '../../../../context/AuthContext';

interface ProfileForm {
  first_name: string;
  last_name: string;
  email: string;
  phone_number: string;
  preferred_language: string;
  nickname: string;
  hide_contact_info: boolean;
  password: string;
}

interface LoginHistoryItem {
  id: number;
  timestamp: string;
  ip_address: string | null;
  user_agent: string;
}

const formatRole = (role?: string) => {
  if (!role) return 'Unknown';
  return role
    .toLowerCase()
    .split('_')
    .map((word) => word.charAt(0).toUpperCase() + word.slice(1))
    .join(' ');
};

const formatDateTime = (value: string | null | undefined) => {
  if (!value) return 'Never';
  return new Date(value).toLocaleString(undefined, {
    year: 'numeric',
    month: 'short',
    day: 'numeric',
    hour: '2-digit',
    minute: '2-digit',
  });
};

function SuperProfileContent() {
  const { user, loading } = useAuth();
  const [profile, setProfile] = useState<ProfileForm>({
    first_name: '',
    last_name: '',
    email: '',
    phone_number: '',
    preferred_language: 'sv',
    nickname: '',
    hide_contact_info: false,
    password: '',
  });
  const [avatarPreview, setAvatarPreview] = useState<string | null>(null);
  const [avatarFile, setAvatarFile] = useState<File | null>(null);
  const [lastLogin, setLastLogin] = useState<string | null>(null);
  const [loginHistory, setLoginHistory] = useState<LoginHistoryItem[]>([]);
  const [isSaving, setIsSaving] = useState(false);
  const [toast, setToast] = useState<{ message: string; type: 'success' | 'error'; isVisible: boolean }>({
    message: '',
    type: 'success',
    isVisible: false,
  });

  useEffect(() => {
    if (!user?.id) return;

    const loadProfile = async () => {
      try {
        const res = await api.get(`/users/${user.id}/`);
        const data = res.data;
        setProfile({
          first_name: data.first_name || '',
          last_name: data.last_name || '',
          email: data.email || '',
          phone_number: data.phone_number || '',
          preferred_language: data.preferred_language || 'sv',
          nickname: data.nickname || '',
          hide_contact_info: data.hide_contact_info ?? false,
          password: '',
        });
        setAvatarPreview(data.avatar ? getMediaUrl(data.avatar) : null);
        setLastLogin(data.last_login || null);
      } catch (err) {
        console.error('Failed to load profile', err);
      }
    };

    const loadLoginHistory = async () => {
      try {
        const res = await api.get('/users/login_history/');
        setLoginHistory(res.data || []);
      } catch (err) {
        console.error('Failed to load login history', err);
      }
    };

    loadProfile();
    loadLoginHistory();
  }, [user?.id]);

  const handleChange = (field: keyof ProfileForm, value: string | boolean) => {
    setProfile((prev) => ({ ...prev, [field]: value }));
  };

  const handleAvatarChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (file) {
      setAvatarFile(file);
      const reader = new FileReader();
      reader.onloadend = () => setAvatarPreview(reader.result as string);
      reader.readAsDataURL(file);
    }
  };

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    if (!user?.id) return;

    setIsSaving(true);
    try {
      const formData = new FormData();
      Object.entries(profile).forEach(([key, value]) => {
        if (key === 'password' && !value) return;
        formData.append(key, typeof value === 'boolean' ? String(value) : value);
      });
      if (avatarFile) {
        formData.append('avatar', avatarFile);
      }
      formData.append('role', 'SUPER_ADMIN');

      await api.patch(`/users/${user.id}/`, formData, {
        headers: { 'Content-Type': 'multipart/form-data' },
      });
      setToast({ message: 'Profile updated successfully!', type: 'success', isVisible: true });
      setProfile((prev) => ({ ...prev, password: '' }));
    } catch (err) {
      console.error('Failed to update profile', err);
      setToast({ message: 'Failed to update profile.', type: 'error', isVisible: true });
    } finally {
      setIsSaving(false);
    }
  };

  if (loading || !user) {
    return <div className="p-8 text-center text-gray-500">Loading profile...</div>;
  }

  const latestLoginTimestamp = loginHistory.length > 0 ? loginHistory[0].timestamp : lastLogin;

  return (
    <div className="space-y-8">
      <div>
        <p className="text-sm text-red-500 uppercase font-semibold">Super Admin</p>
        <h1 className="text-3xl font-bold text-gray-900">My Profile</h1>
        <p className="text-gray-600 mt-1">Update your personal information and review your recent login activity.</p>
      </div>

      <div className="grid grid-cols-1 xl:grid-cols-3 gap-6">
        <div className="xl:col-span-2 bg-white rounded-2xl shadow p-6">
          <h2 className="text-xl font-bold text-gray-800 mb-4">Profile Details</h2>
          <form onSubmit={handleSubmit} className="space-y-6">
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label className="block text-sm font-semibold text-gray-700 mb-1">First Name</label>
                <input
                  type="text"
                  className="w-full border rounded-lg p-2"
                  value={profile.first_name}
                  onChange={(e) => handleChange('first_name', e.target.value)}
                  required
                />
              </div>
              <div>
                <label className="block text-sm font-semibold text-gray-700 mb-1">Last Name</label>
                <input
                  type="text"
                  className="w-full border rounded-lg p-2"
                  value={profile.last_name}
                  onChange={(e) => handleChange('last_name', e.target.value)}
                  required
                />
              </div>
              <div>
                <label className="block text-sm font-semibold text-gray-700 mb-1">Email</label>
                <input
                  type="email"
                  className="w-full border rounded-lg p-2"
                  value={profile.email}
                  onChange={(e) => handleChange('email', e.target.value)}
                  required
                />
              </div>
              <div>
                <label className="block text-sm font-semibold text-gray-700 mb-1">Phone Number</label>
                <input
                  type="text"
                  className="w-full border rounded-lg p-2"
                  value={profile.phone_number}
                  onChange={(e) => handleChange('phone_number', e.target.value)}
                />
              </div>
              <div>
                <label className="block text-sm font-semibold text-gray-700 mb-1">Preferred Language</label>
                <select
                  className="w-full border rounded-lg p-2"
                  value={profile.preferred_language}
                  onChange={(e) => handleChange('preferred_language', e.target.value)}
                >
                  <option value="sv">Swedish</option>
                  <option value="en">English</option>
                  <option value="fi">Finnish</option>
                </select>
              </div>
              <div>
                <label className="block text-sm font-semibold text-gray-700 mb-1">Nickname</label>
                <input
                  type="text"
                  className="w-full border rounded-lg p-2"
                  value={profile.nickname}
                  onChange={(e) => handleChange('nickname', e.target.value)}
                />
              </div>
              <div>
                <label className="block text-sm font-semibold text-gray-700 mb-1">New Password</label>
                <input
                  type="password"
                  className="w-full border rounded-lg p-2"
                  placeholder="Leave blank to keep current"
                  value={profile.password}
                  onChange={(e) => handleChange('password', e.target.value)}
                />
              </div>
            </div>

            <div className="flex items-center gap-3">
              <input
                id="hide_contact"
                type="checkbox"
                className="h-4 w-4 text-red-600"
                checked={profile.hide_contact_info}
                onChange={(e) => handleChange('hide_contact_info', e.target.checked)}
              />
              <label htmlFor="hide_contact" className="text-sm text-gray-700">
                Hide my contact info from public listings
              </label>
            </div>

            <div>
              <label className="block text-sm font-semibold text-gray-700 mb-1">Avatar</label>
              <input type="file" accept="image/*" onChange={handleAvatarChange} />
              {avatarPreview && (
                <img src={avatarPreview} alt="Avatar preview" className="w-20 h-20 rounded-full object-cover mt-3" />
              )}
            </div>

            <div className="flex justify-end gap-4 pt-4 border-t">
              <button
                type="submit"
                className="bg-red-600 text-white px-6 py-2 rounded-lg hover:bg-red-700 disabled:opacity-50"
                disabled={isSaving}
              >
                {isSaving ? 'Saving...' : 'Save Changes'}
              </button>
            </div>
          </form>
        </div>

        <div className="space-y-6">
          <div className="bg-white rounded-2xl shadow p-6">
            <h3 className="text-lg font-bold text-gray-800 mb-4">Account Summary</h3>
            <div className="space-y-3 text-sm text-gray-700">
              <div className="flex justify-between">
                <span className="text-gray-500">Role</span>
                <span className="font-semibold">{formatRole(user.role)}</span>
              </div>
              <div className="flex justify-between">
                <span className="text-gray-500">Last Login</span>
                <span className="font-semibold">
                  {formatDateTime(latestLoginTimestamp)}
                </span>
              </div>
            </div>
          </div>

          <div className="bg-white rounded-2xl shadow p-6">
            <h3 className="text-lg font-bold text-gray-800 mb-4">Recent Logins</h3>
            {loginHistory.length === 0 ? (
              <p className="text-sm text-gray-500">No login history recorded yet.</p>
            ) : (
              <ul className="space-y-3 text-sm">
                {loginHistory.map((entry) => (
                  <li key={entry.id} className="border-b pb-2 last:border-b-0">
                    <span className="font-semibold text-gray-900">
                      {formatDateTime(entry.timestamp)}
                    </span>
                  </li>
                ))}
              </ul>
            )}
          </div>
        </div>
      </div>

      <Toast
        message={toast.message}
        type={toast.type}
        isVisible={toast.isVisible}
        onClose={() => setToast({ ...toast, isVisible: false })}
      />
    </div>
  );
}

export default function SuperProfilePage() {
  return (
    <Suspense fallback={<div className="p-8 text-center">Loading profile...</div>}>
      <SuperProfileContent />
    </Suspense>
  );
}


--- END OF FILE: ./frontend/app/admin/super/profile/page.tsx ---


--- START OF FILE: ./frontend/app/admin/super/news/page.tsx ---
'use client';

import { useState, useEffect } from 'react';
import api from '../../../../lib/api';
import { getMediaUrl } from '../../../utils';
import Toast from '../../../components/Toast';
import RichTextEditor from '../../../components/RichTextEditor';
import DeleteConfirmationModal from '../../../components/DeleteConfirmationModal';

// --- TYPES ---
interface Tag { id: number; name: string; }
interface Article {
  id: number;
  title: string;
  excerpt: string;
  author_name: string;
  is_published: boolean;
  is_hero: boolean;
  published_at: string;
  tags_details: Tag[];
  hero_image: string;
  content?: string; // Full content
  target_roles: string[];
  tags: number[]; // IDs for editing
}

const ROLES = [
  { id: 'SUPER_ADMIN', label: 'Super Admin' },
  { id: 'MUNICIPALITY_ADMIN', label: 'Municipality Admin' },
  { id: 'CLUB_ADMIN', label: 'Club Admin' },
  { id: 'YOUTH_MEMBER', label: 'Youth Member' },
  { id: 'GUARDIAN', label: 'Guardian' },
];

export default function ManageNewsPage() {
  // --- STATE ---
  const [articles, setArticles] = useState<Article[]>([]);
  const [tagsList, setTagsList] = useState<Tag[]>([]);
  const [isLoading, setIsLoading] = useState(true);
  
  const [showModal, setShowModal] = useState(false);
  const [isEditing, setIsEditing] = useState(false);
  const [editId, setEditId] = useState<number | null>(null);
  const [toast, setToast] = useState<{ message: string; type: 'success' | 'error'; isVisible: boolean }>({
    message: '', type: 'success', isVisible: false,
  });
  
  // Delete Confirmation Modal State
  const [showDeleteModal, setShowDeleteModal] = useState(false);
  const [articleToDelete, setArticleToDelete] = useState<{ id: number; title: string } | null>(null);
  const [isDeleting, setIsDeleting] = useState(false);

  // Form State
  const [title, setTitle] = useState('');
  const [excerpt, setExcerpt] = useState('');
  const [content, setContent] = useState('');
  const [selectedTags, setSelectedTags] = useState<number[]>([]);
  const [targetRoles, setTargetRoles] = useState<string[]>(['ALL']); // Default to ALL
  const [isPublished, setIsPublished] = useState(false);
  const [isHero, setIsHero] = useState(false);
  const [heroFile, setHeroFile] = useState<File | null>(null);
  const [heroPreview, setHeroPreview] = useState<string | null>(null);

  // --- LOAD DATA ---
  useEffect(() => {
    fetchData();
  }, []);

  const fetchData = async () => {
    setIsLoading(true);
    try {
      const [newsRes, tagsRes] = await Promise.all([
        api.get('/news/'), // Get news
        api.get('/news_tags/') // Get tags for dropdown
      ]);
      setArticles(Array.isArray(newsRes.data) ? newsRes.data : newsRes.data.results);
      setTagsList(Array.isArray(tagsRes.data) ? tagsRes.data : tagsRes.data.results);
    } catch (err) {
      console.error(err);
    } finally {
      setIsLoading(false);
    }
  };

  // --- HANDLERS ---

  const handleOpenCreate = () => {
    setIsEditing(false);
    setEditId(null);
    resetForm();
    setShowModal(true);
  };

  const handleOpenEdit = (article: Article) => {
    setIsEditing(true);
    setEditId(article.id);
    
    setTitle(article.title);
    setExcerpt(article.excerpt);
    setContent(article.content || ''); // Content might not be in list view if you optimize query, but for now it likely is
    setSelectedTags(article.tags || []); 
    setTargetRoles(article.target_roles || ['ALL']);
    setIsPublished(article.is_published);
    setIsHero(article.is_hero);
    
    setHeroFile(null);
    setHeroPreview(article.hero_image ? getMediaUrl(article.hero_image) : null);
    
    setShowModal(true);
  };

  const resetForm = () => {
    setTitle('');
    setExcerpt('');
    setContent('');
    setSelectedTags([]);
    setTargetRoles(['ALL']);
    setIsPublished(false);
    setIsHero(false);
    setHeroFile(null);
    setHeroPreview(null);
  };

  const handleFileChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    if (e.target.files?.[0]) {
      setHeroFile(e.target.files[0]);
      setHeroPreview(URL.createObjectURL(e.target.files[0]));
    }
  };

  const toggleTag = (id: number) => {
    setSelectedTags(prev => prev.includes(id) ? prev.filter(t => t !== id) : [...prev, id]);
  };

  const toggleRole = (role: string) => {
    if (role === 'ALL') {
      // If 'ALL' is already selected, unselect it (allow user to choose specific roles)
      if (targetRoles.includes('ALL')) {
        setTargetRoles([]);
      } else {
        // If 'ALL' is not selected, select it and clear other roles
        setTargetRoles(['ALL']);
      }
      return;
    }
    
    // For specific roles: if 'ALL' is selected, unselect it first
    let newRoles = targetRoles.includes('ALL') ? [] : [...targetRoles];
    
    // Toggle the specific role
    if (newRoles.includes(role)) {
      newRoles = newRoles.filter(r => r !== role);
    } else {
      newRoles.push(role);
    }
    
    // If no roles are selected, default back to 'ALL'
    if (newRoles.length === 0) {
      newRoles = ['ALL'];
    }
    
    setTargetRoles(newRoles);
  };

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    
    // Ensure at least one role is selected
    const rolesToSubmit = targetRoles.length > 0 ? targetRoles : ['ALL'];
    
    const data = new FormData();
    data.append('title', title);
    data.append('excerpt', excerpt);
    data.append('content', content);
    data.append('target_roles_data', JSON.stringify(rolesToSubmit));
    data.append('is_published', isPublished.toString());
    data.append('is_hero', isHero.toString());
    
    selectedTags.forEach(id => data.append('tags', id.toString()));
    
    if (heroFile) data.append('hero_image', heroFile);

    try {
      const config = { headers: { 'Content-Type': 'multipart/form-data' } };
      
      if (isEditing && editId) {
        await api.patch(`/news/${editId}/`, data, config);
        setToast({ message: 'News updated!', type: 'success', isVisible: true });
      } else {
        await api.post('/news/', data, config);
        setToast({ message: 'News created!', type: 'success', isVisible: true });
      }
      
      setShowModal(false);
      fetchData();
    } catch (err) {
      console.error(err);
      setToast({ message: 'Failed to save news.', type: 'error', isVisible: true });
    }
  };

  const handleDeleteClick = (article: Article) => {
    setArticleToDelete({ id: article.id, title: article.title });
    setShowDeleteModal(true);
  };

  const handleDeleteConfirm = async () => {
    if (!articleToDelete) return;

    setIsDeleting(true);
    try {
      await api.delete(`/news/${articleToDelete.id}/`);
      setToast({ message: 'Deleted.', type: 'success', isVisible: true });
      setShowDeleteModal(false);
      setArticleToDelete(null);
      fetchData();
    } catch (err) {
      setToast({ message: 'Failed to delete.', type: 'error', isVisible: true });
    } finally {
      setIsDeleting(false);
    }
  };

  return (
    <div className="p-8">
      <div className="flex justify-between items-center mb-6">
        <h1 className="text-2xl font-bold text-gray-800">News Management</h1>
        <button onClick={handleOpenCreate} className="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
          + Create Article
        </button>
      </div>

      {/* LIST */}
      <div className="bg-white rounded-lg shadow overflow-hidden">
        {isLoading ? <div className="p-8 text-center">Loading...</div> : (
          <table className="min-w-full divide-y divide-gray-200">
            <thead className="bg-gray-50">
              <tr>
                <th className="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase">Article</th>
                <th className="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase">Status</th>
                <th className="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase">Author</th>
                <th className="px-6 py-3 text-right">Actions</th>
              </tr>
            </thead>
            <tbody className="divide-y divide-gray-200">
              {articles.map(item => (
                <tr key={item.id}>
                  <td className="px-6 py-4">
                    <div className="flex items-center gap-3">
                      {item.hero_image && (
                        <img src={getMediaUrl(item.hero_image) || ''} alt="Hero" className="w-12 h-12 object-cover rounded" />
                      )}
                      <div>
                        <div className="font-bold text-gray-900">{item.title}</div>
                        <div className="text-xs text-gray-500 truncate max-w-xs">{item.excerpt}</div>
                        {item.is_hero && <span className="text-xs bg-yellow-100 text-yellow-800 px-1 rounded font-bold">HERO</span>}
                      </div>
                    </div>
                  </td>
                  <td className="px-6 py-4">
                    {item.is_published 
                      ? <span className="text-green-600 bg-green-100 px-2 py-1 rounded text-xs font-bold">Published</span>
                      : <span className="text-gray-600 bg-gray-100 px-2 py-1 rounded text-xs font-bold">Draft</span>
                    }
                  </td>
                  <td className="px-6 py-4 text-sm text-gray-600">{item.author_name}</td>
                  <td className="px-6 py-4 text-right text-sm space-x-3">
                    <button onClick={() => handleOpenEdit(item)} className="text-blue-600 font-bold">Edit</button>
                    <button onClick={() => handleDeleteClick(item)} className="text-red-600 font-bold">Delete</button>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        )}
      </div>

      {/* MODAL */}
      {showModal && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-xl shadow-2xl w-full max-w-4xl h-[90vh] flex flex-col">
            <div className="p-6 border-b flex justify-between items-center">
              <h2 className="text-xl font-bold">{isEditing ? 'Edit Article' : 'Create Article'}</h2>
              <button onClick={() => setShowModal(false)} className="text-gray-500 text-xl">√ó</button>
            </div>
            
            <form onSubmit={handleSubmit} className="flex-1 overflow-y-auto p-6 space-y-6">
              
              <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                {/* LEFT COLUMN: Main Content */}
                <div className="md:col-span-2 space-y-4">
                  <div>
                    <label className="block text-sm font-bold mb-1">Title</label>
                    <input required type="text" className="w-full border p-2 rounded font-bold text-lg" value={title} onChange={e => setTitle(e.target.value)} />
                  </div>
                  <div>
                    <label className="block text-sm font-bold mb-1">Excerpt (Summary)</label>
                    <textarea required rows={2} className="w-full border p-2 rounded text-sm" value={excerpt} onChange={e => setExcerpt(e.target.value)} />
                  </div>
                  <div>
                    <label className="block text-sm font-bold mb-1">Body Content</label>
                    <RichTextEditor value={content} onChange={setContent} />
                  </div>
                </div>

                {/* RIGHT COLUMN: Settings */}
                <div className="space-y-6 bg-gray-50 p-4 rounded-lg h-fit">
                  
                  {/* Hero Image */}
                  <div>
                    <label className="block text-sm font-bold mb-2">Hero Image</label>
                    <input type="file" accept="image/*" onChange={handleFileChange} className="text-sm w-full" />
                    {heroPreview && <img src={heroPreview} alt="Preview" className="mt-2 w-full h-32 object-cover rounded border" />}
                  </div>

                  {/* Checkboxes */}
                  <div className="space-y-2">
                    <label className="flex items-center gap-2 cursor-pointer">
                      <input type="checkbox" checked={isPublished} onChange={e => setIsPublished(e.target.checked)} className="w-5 h-5 text-blue-600" />
                      <span className="font-bold text-gray-700">Publish Article</span>
                    </label>
                    <label className="flex items-center gap-2 cursor-pointer">
                      <input type="checkbox" checked={isHero} onChange={e => setIsHero(e.target.checked)} className="w-5 h-5 text-yellow-500" />
                      <span className="font-bold text-gray-700">Set as Main Hero</span>
                    </label>
                    <p className="text-xs text-gray-500 pl-7">Setting this will remove Hero status from any other article.</p>
                  </div>

                  {/* Targeting */}
                  <div>
                    <label className="block text-sm font-bold mb-2">Target Audience</label>
                    <div className="space-y-1 max-h-40 overflow-y-auto border p-2 rounded bg-white">
                      <label className="flex items-center gap-2 text-sm">
                        <input type="checkbox" checked={targetRoles.includes('ALL')} onChange={() => toggleRole('ALL')} />
                        <span className="font-bold">Everyone</span>
                      </label>
                      {!targetRoles.includes('ALL') && ROLES.map(role => (
                        <label key={role.id} className="flex items-center gap-2 text-sm">
                          <input type="checkbox" checked={targetRoles.includes(role.id)} onChange={() => toggleRole(role.id)} />
                          <span>{role.label}</span>
                        </label>
                      ))}
                    </div>
                  </div>

                  {/* Tags */}
                  <div>
                    <label className="block text-sm font-bold mb-2">Tags</label>
                    <div className="flex flex-wrap gap-2">
                      {tagsList.map(tag => (
                        <button 
                          key={tag.id} 
                          type="button"
                          onClick={() => toggleTag(tag.id)}
                          className={`px-2 py-1 rounded text-xs font-bold border transition
                            ${selectedTags.includes(tag.id) ? 'bg-blue-600 text-white border-blue-600' : 'bg-white text-gray-600 border-gray-300'}
                          `}
                        >
                          {tag.name}
                        </button>
                      ))}
                    </div>
                  </div>

                </div>
              </div>

            </form>

            <div className="p-6 border-t flex justify-end gap-4">
              <button onClick={() => setShowModal(false)} className="text-gray-500">Cancel</button>
              <button onClick={handleSubmit} className="bg-blue-600 text-white px-6 py-2 rounded font-bold hover:bg-blue-700">Save</button>
            </div>
          </div>
        </div>
      )}

      {/* Delete Confirmation Modal */}
      <DeleteConfirmationModal
        isVisible={showDeleteModal}
        onClose={() => {
          if (!isDeleting) {
            setShowDeleteModal(false);
            setArticleToDelete(null);
          }
        }}
        onConfirm={handleDeleteConfirm}
        itemName={articleToDelete?.title}
        isLoading={isDeleting}
      />

      <Toast message={toast.message} type={toast.type} isVisible={toast.isVisible} onClose={() => setToast({ ...toast, isVisible: false })} />
    </div>
  );
}
--- END OF FILE: ./frontend/app/admin/super/news/page.tsx ---


--- START OF FILE: ./frontend/app/admin/super/news/tags/page.tsx ---
'use client';

import { useState, useEffect } from 'react';
import api from '../../../../../lib/api';
import Toast from '../../../../components/Toast';
import DeleteConfirmationModal from '../../../../components/DeleteConfirmationModal';

interface NewsTag {
  id: number;
  name: string;
  slug: string;
}

export default function ManageNewsTagsPage() {
  const [tags, setTags] = useState<NewsTag[]>([]);
  const [isLoading, setIsLoading] = useState(true);
  const [showModal, setShowModal] = useState(false);
  
  // Form State
  const [name, setName] = useState('');
  const [slug, setSlug] = useState('');

  const [toast, setToast] = useState<{ message: string; type: 'success' | 'error'; isVisible: boolean }>({
    message: '',
    type: 'success',
    isVisible: false,
  });
  
  // Delete Confirmation Modal State
  const [showDeleteModal, setShowDeleteModal] = useState(false);
  const [tagToDelete, setTagToDelete] = useState<{ id: number; name: string } | null>(null);
  const [isDeleting, setIsDeleting] = useState(false);

  useEffect(() => {
    fetchTags();
  }, []);

  const fetchTags = async () => {
    setIsLoading(true);
    try {
      const res = await api.get('/news_tags/');
      // API returns either array or paginated object. Handle both.
      const data = Array.isArray(res.data) ? res.data : res.data.results;
      setTags(data || []);
    } catch (err) {
      console.error("Failed to fetch tags", err);
    } finally {
      setIsLoading(false);
    }
  };

  // Auto-generate slug when Name changes
  const handleNameChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const val = e.target.value;
    setName(val);
    // Simple slugify: lowercase, replace spaces with dashes, remove non-alphanumeric
    const generatedSlug = val.toLowerCase().replace(/ /g, '-').replace(/[^\w-]+/g, '');
    setSlug(generatedSlug);
  };

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    try {
      await api.post('/news_tags/', { name, slug });
      setToast({ message: 'Tag created successfully!', type: 'success', isVisible: true });
      setShowModal(false);
      setName('');
      setSlug('');
      fetchTags();
    } catch (err) {
      console.error(err);
      setToast({ message: 'Failed to create tag. Name or Slug might be duplicate.', type: 'error', isVisible: true });
    }
  };

  const handleDeleteClick = (tag: NewsTag) => {
    setTagToDelete({ id: tag.id, name: tag.name });
    setShowDeleteModal(true);
  };

  const handleDeleteConfirm = async () => {
    if (!tagToDelete) return;

    setIsDeleting(true);
    try {
      await api.delete(`/news_tags/${tagToDelete.id}/`);
      setToast({ message: 'Tag deleted.', type: 'success', isVisible: true });
      setShowDeleteModal(false);
      setTagToDelete(null);
      fetchTags();
    } catch (err) {
      setToast({ message: 'Failed to delete tag.', type: 'error', isVisible: true });
    } finally {
      setIsDeleting(false);
    }
  };

  return (
    <div className="p-8 max-w-5xl mx-auto">
      <div className="flex justify-between items-center mb-6">
        <div>
          <h1 className="text-2xl font-bold text-gray-800">News Tags</h1>
          <p className="text-gray-500 text-sm">Categories for filtering news articles.</p>
        </div>
        <button 
          onClick={() => setShowModal(true)} 
          className="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 shadow"
        >
          + Create Tag
        </button>
      </div>

      <div className="bg-white rounded-xl shadow overflow-hidden border border-gray-100">
        {isLoading ? (
          <div className="p-8 text-center text-gray-500">Loading tags...</div>
        ) : tags.length === 0 ? (
          <div className="p-8 text-center text-gray-500">No tags found. Create one to get started.</div>
        ) : (
          <table className="min-w-full divide-y divide-gray-200">
            <thead className="bg-gray-50">
              <tr>
                <th className="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase">Name</th>
                <th className="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase">Slug (URL)</th>
                <th className="px-6 py-3 text-right text-xs font-bold text-gray-500 uppercase">Action</th>
              </tr>
            </thead>
            <tbody className="bg-white divide-y divide-gray-200">
              {tags.map((tag) => (
                <tr key={tag.id}>
                  <td className="px-6 py-4 text-sm font-semibold text-gray-900">
                    <span className="bg-gray-100 px-2 py-1 rounded">{tag.name}</span>
                  </td>
                  <td className="px-6 py-4 text-sm text-gray-500 font-mono">
                    {tag.slug}
                  </td>
                  <td className="px-6 py-4 text-right">
                    <button onClick={() => handleDeleteClick(tag)} className="text-red-600 hover:text-red-800 font-bold text-sm">
                      Delete
                    </button>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        )}
      </div>

      {/* MODAL */}
      {showModal && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-xl shadow-2xl w-full max-w-md p-8">
            <h2 className="text-xl font-bold mb-4 text-gray-800">Create New Tag</h2>
            <form onSubmit={handleSubmit} className="space-y-4">
              <div>
                <label className="block text-sm font-bold mb-1 text-gray-700">Tag Name</label>
                <input 
                  required 
                  type="text" 
                  className="w-full border p-2 rounded focus:ring-2 focus:ring-blue-500" 
                  placeholder="e.g. Summer Events"
                  value={name} 
                  onChange={handleNameChange} 
                />
              </div>
              <div>
                <label className="block text-sm font-bold mb-1 text-gray-700">Slug</label>
                <input 
                  required 
                  type="text" 
                  className="w-full border p-2 rounded bg-gray-100 text-gray-600" 
                  placeholder="e.g. summer-events"
                  value={slug} 
                  onChange={(e) => setSlug(e.target.value)}
                />
                <p className="text-xs text-gray-400 mt-1">Used in the URL. Auto-generated, but editable.</p>
              </div>
              <div className="flex justify-end gap-3 pt-4">
                <button type="button" onClick={() => setShowModal(false)} className="text-gray-500 hover:text-gray-700">Cancel</button>
                <button type="submit" className="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Create</button>
              </div>
            </form>
          </div>
        </div>
      )}

      {/* Delete Confirmation Modal */}
      <DeleteConfirmationModal
        isVisible={showDeleteModal}
        onClose={() => {
          if (!isDeleting) {
            setShowDeleteModal(false);
            setTagToDelete(null);
          }
        }}
        onConfirm={handleDeleteConfirm}
        itemName={tagToDelete?.name}
        message={tagToDelete ? `Are you sure you want to delete "${tagToDelete.name}"? It will be removed from all news articles. This action cannot be undone.` : undefined}
        isLoading={isDeleting}
      />

      <Toast
        message={toast.message}
        type={toast.type}
        isVisible={toast.isVisible}
        onClose={() => setToast({ ...toast, isVisible: false })}
      />
    </div>
  );
}
--- END OF FILE: ./frontend/app/admin/super/news/tags/page.tsx ---


--- START OF FILE: ./frontend/app/admin/super/news-feed/page.tsx ---
'use client';

import NewsFeed from '../../../components/NewsFeed';

export default function SuperAdminNewsFeed() {
  return (
    <div className="max-w-7xl mx-auto">
      <div className="mb-8">
        <h1 className="text-3xl font-bold text-gray-900">News Feed</h1>
        <p className="text-gray-500">Latest updates and featured stories.</p>
      </div>
      
      {/* We simply render the component here */}
      <NewsFeed basePath="/admin/super/news-feed" />
    </div>
  );
}
--- END OF FILE: ./frontend/app/admin/super/news-feed/page.tsx ---


--- START OF FILE: ./frontend/app/admin/super/news-feed/archive/page.tsx ---
'use client';

import Link from 'next/link';
import NewsArchive from '../../../../components/NewsArchive';

export default function SuperAdminNewsArchive() {
  return (
    <div className="max-w-7xl mx-auto">
      <div className="mb-8 flex items-center gap-4">
        <Link 
          href="/admin/super/news-feed"
          className="p-2 rounded-full bg-white shadow-sm border border-gray-200 text-gray-500 hover:text-blue-600 transition"
        >
          <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 19l-7-7m0 0l7-7m-7 7h18" />
          </svg>
        </Link>
        <div>
          <h1 className="text-3xl font-bold text-gray-900">News Archive</h1>
          <p className="text-gray-500">Browse all published articles.</p>
        </div>
      </div>
      
      {/* Pass the base path and publishedOnly flag so only published articles assigned to ALL or SUPER_ADMIN are shown */}
      <NewsArchive basePath="/admin/super/news-feed" publishedOnly={true} />
    </div>
  );
}
--- END OF FILE: ./frontend/app/admin/super/news-feed/archive/page.tsx ---


--- START OF FILE: ./frontend/app/admin/super/news-feed/[id]/page.tsx ---
'use client';

import { useParams } from 'next/navigation';
import NewsArticleReader from '../../../../components/NewsArticleReader';

export default function SuperAdminArticlePage() {
  const params = useParams();
  const id = params?.id as string;

  return (
    <NewsArticleReader 
      articleId={id} 
      backLink="/admin/super/news-feed" 
    />
  );
}
--- END OF FILE: ./frontend/app/admin/super/news-feed/[id]/page.tsx ---


--- START OF FILE: ./frontend/app/admin/super/custom-fields/page.tsx ---
'use client';

import CustomFieldManager from '../../../components/CustomFieldManager';

export default function SuperCustomFieldsPage() {
  return (
    <div className="max-w-7xl mx-auto">
      <div className="mb-8">
        <h1 className="text-3xl font-bold text-gray-900">Global Custom Fields</h1>
        <p className="text-gray-500">
          Manage fields that appear on <strong>ALL</strong> user profiles across the platform.
        </p>
      </div>
      
      <CustomFieldManager scope="SUPER" />
    </div>
  );
}
--- END OF FILE: ./frontend/app/admin/super/custom-fields/page.tsx ---


--- START OF FILE: ./frontend/app/admin/super/countries/page.tsx ---
'use client';

import { useState, useEffect, Suspense } from 'react';
import { useRouter, useSearchParams, usePathname } from 'next/navigation';
import api from '../../../../lib/api';
import { getMediaUrl } from '../../../utils';
import Toast from '../../../components/Toast';
import DeleteConfirmationModal from '../../../components/DeleteConfirmationModal';

function ManageCountriesPageContent() {
  const router = useRouter();
  const pathname = usePathname();
  const searchParams = useSearchParams();

  // --- STATE ---
  const [countries, setCountries] = useState<any[]>([]);
  const [isLoading, setIsLoading] = useState(true);
  
  // Toast State
  const [toast, setToast] = useState<{ message: string; type: 'success' | 'error' | 'info' | 'warning'; isVisible: boolean }>({
    message: '',
    type: 'success',
    isVisible: false,
  });

  // Modal
  const [showModal, setShowModal] = useState(false);
  const [isEditing, setIsEditing] = useState(false);
  const [editId, setEditId] = useState<number | null>(null);
  
  // Form Files
  const [avatarFile, setAvatarFile] = useState<File | null>(null);
  const [avatarPreview, setAvatarPreview] = useState<string | null>(null);
  
  // Delete Confirmation Modal State
  const [showDeleteModal, setShowDeleteModal] = useState(false);
  const [countryToDelete, setCountryToDelete] = useState<{ id: number; name: string } | null>(null);
  const [isDeleting, setIsDeleting] = useState(false);

  const initialFormState = {
    name: '',
    country_code: '',
    description: '',
    currency_code: '',
    default_language: '',
    timezone: ''
  };

  const [formData, setFormData] = useState(initialFormState);

  // --- LOAD DATA ---
  useEffect(() => {
    fetchCountries();
  }, []);

  const fetchCountries = async () => {
    setIsLoading(true);
    try {
      const res = await api.get('/countries/');
      const data = Array.isArray(res.data) ? res.data : (res.data.results || []);
      setCountries(data);
    } catch (err) {
      console.error(err);
    } finally {
      setIsLoading(false);
    }
  };

  // --- ACTIONS ---
  const handleOpenCreate = () => {
    setIsEditing(false);
    setEditId(null);
    setFormData(initialFormState);
    setAvatarFile(null);
    setAvatarPreview(null);
    setShowModal(true);
  };

  const handleOpenEdit = (country: any) => {
    setIsEditing(true);
    setEditId(country.id);
    
    setFormData({
      name: country.name,
      country_code: country.country_code,
      description: country.description || '',
      currency_code: country.currency_code || '',
      default_language: country.default_language || '',
      timezone: country.timezone || ''
    });
    setAvatarFile(null);
    setAvatarPreview(country.avatar ? getMediaUrl(country.avatar) : null);
    setShowModal(true);
  };

  const handleDeleteClick = (country: any) => {
    setCountryToDelete({ id: country.id, name: country.name });
    setShowDeleteModal(true);
  };

  const handleDeleteConfirm = async () => {
    if (!countryToDelete) return;

    setIsDeleting(true);
    try {
      await api.delete(`/countries/${countryToDelete.id}/`);
      setToast({
        message: 'Country deleted successfully!',
        type: 'success',
        isVisible: true,
      });
      setShowDeleteModal(false);
      setCountryToDelete(null);
      fetchCountries();
    } catch (err) {
      setToast({
        message: 'Failed to delete country.',
        type: 'error',
        isVisible: true,
      });
    } finally {
      setIsDeleting(false);
    }
  };

  const handleAvatarChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (file) {
      setAvatarFile(file);
      const reader = new FileReader();
      reader.onloadend = () => setAvatarPreview(reader.result as string);
      reader.readAsDataURL(file);
    }
  };

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    try {
      const data = new FormData();
      data.append('name', formData.name);
      data.append('country_code', formData.country_code);
      data.append('description', formData.description);
      data.append('currency_code', formData.currency_code);
      data.append('default_language', formData.default_language);
      data.append('timezone', formData.timezone);
      
      if (avatarFile) data.append('avatar', avatarFile);

      const config = { headers: { 'Content-Type': 'multipart/form-data' } };
      
      if (isEditing && editId) {
        await api.patch(`/countries/${editId}/`, data, config);
        setToast({
          message: 'Country updated successfully!',
          type: 'success',
          isVisible: true,
        });
      } else {
        await api.post('/countries/', data, config);
        setToast({
          message: 'Country created successfully!',
          type: 'success',
          isVisible: true,
        });
      }

      setShowModal(false);
      fetchCountries();
    } catch (err) {
      setToast({
        message: 'Operation failed. Please try again.',
        type: 'error',
        isVisible: true,
      });
      console.error(err);
    }
  };

  return (
    <div>
      <div className="flex justify-between items-center mb-6">
        <h1 className="text-2xl font-bold text-gray-800">Manage Countries</h1>
        <button onClick={handleOpenCreate} className="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 shadow">
          + Add Country
        </button>
      </div>

      {/* --- LIST --- */}
      <div className="bg-white rounded-lg shadow overflow-hidden mb-6">
        {isLoading ? (
          <div className="p-8 text-center text-gray-500">Loading...</div>
        ) : countries.length === 0 ? (
          <div className="p-8 text-center text-gray-500">No countries found. Add one to get started.</div>
        ) : (
          <table className="min-w-full divide-y divide-gray-200">
            <thead className="bg-gray-50">
              <tr>
                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Country</th>
                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Code</th>
                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Currency</th>
                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Lang</th>
                <th className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">Actions</th>
              </tr>
            </thead>
            <tbody className="bg-white divide-y divide-gray-200">
              {countries.map((country) => (
                <tr key={country.id}>
                  <td className="px-6 py-4 whitespace-nowrap">
                    <div className="flex items-center">
                      {country.avatar ? (
                        <img 
                          src={getMediaUrl(country.avatar) || ''}
                          alt={country.name}
                          className="w-10 h-10 rounded-full object-cover mr-3 border bg-gray-50"
                          onError={(e) => { (e.target as HTMLImageElement).style.display = 'none'; }}
                        />
                      ) : (
                        <div className="w-10 h-10 rounded-full bg-gray-100 mr-3 flex items-center justify-center text-gray-400 text-xs font-bold">
                          {country.country_code}
                        </div>
                      )}
                      <div className="text-sm font-bold text-gray-900">{country.name}</div>
                    </div>
                  </td>
                  <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
                    {country.country_code}
                  </td>
                  <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
                    {country.currency_code || '-'}
                  </td>
                  <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
                    {country.default_language || '-'}
                  </td>
                  <td className="px-6 py-4 whitespace-nowrap text-right text-sm font-medium space-x-4">
                    <button onClick={() => handleOpenEdit(country)} className="text-indigo-600 hover:text-indigo-900 font-bold">Edit</button>
                    <button onClick={() => handleDeleteClick(country)} className="text-red-600 hover:text-red-900">Delete</button>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        )}
      </div>

      {/* --- MODAL --- */}
      {showModal && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-xl shadow-2xl w-full max-w-2xl p-8 max-h-[90vh] overflow-y-auto">
            <h2 className="text-2xl font-bold mb-6 text-gray-800">{isEditing ? 'Edit Country' : 'New Country'}</h2>
            <form onSubmit={handleSubmit} className="space-y-6">
              
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label className="block text-sm font-bold mb-1 text-gray-700">Name</label>
                  <input 
                    required 
                    type="text" 
                    placeholder="e.g. Sweden" 
                    className="w-full border p-2 rounded focus:ring-2 focus:ring-blue-500 outline-none" 
                    value={formData.name} 
                    onChange={e => setFormData({...formData, name: e.target.value})} 
                  />
                </div>
                <div>
                  <label className="block text-sm font-bold mb-1 text-gray-700">Country Code (ISO)</label>
                  <input 
                    required 
                    type="text" 
                    placeholder="e.g. SE" 
                    maxLength={5}
                    className="w-full border p-2 rounded focus:ring-2 focus:ring-blue-500 outline-none uppercase" 
                    value={formData.country_code} 
                    onChange={e => setFormData({...formData, country_code: e.target.value.toUpperCase()})} 
                  />
                </div>
              </div>

              <div>
                <label className="block text-sm font-bold mb-1 text-gray-700">Description</label>
                <textarea 
                  required
                  rows={3}
                  placeholder="General description of the country settings..." 
                  className="w-full border p-2 rounded focus:ring-2 focus:ring-blue-500 outline-none" 
                  value={formData.description} 
                  onChange={e => setFormData({...formData, description: e.target.value})} 
                />
              </div>

              <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                  <label className="block text-sm font-bold mb-1 text-gray-700">Currency</label>
                  <input 
                    type="text" 
                    placeholder="e.g. SEK" 
                    className="w-full border p-2 rounded focus:ring-2 focus:ring-blue-500 outline-none uppercase" 
                    value={formData.currency_code} 
                    onChange={e => setFormData({...formData, currency_code: e.target.value.toUpperCase()})} 
                  />
                </div>
                <div>
                  <label className="block text-sm font-bold mb-1 text-gray-700">Language</label>
                  <input 
                    type="text" 
                    placeholder="e.g. sv" 
                    className="w-full border p-2 rounded focus:ring-2 focus:ring-blue-500 outline-none" 
                    value={formData.default_language} 
                    onChange={e => setFormData({...formData, default_language: e.target.value})} 
                  />
                </div>
                <div>
                  <label className="block text-sm font-bold mb-1 text-gray-700">Timezone</label>
                  <input 
                    type="text" 
                    placeholder="e.g. Europe/Stockholm" 
                    className="w-full border p-2 rounded focus:ring-2 focus:ring-blue-500 outline-none" 
                    value={formData.timezone} 
                    onChange={e => setFormData({...formData, timezone: e.target.value})} 
                  />
                </div>
              </div>

              {/* AVATAR UPLOAD */}
              <div>
                <label className="block text-sm font-bold mb-2 text-gray-700">Flag / Avatar</label>
                <input 
                  type="file" 
                  accept="image/*" 
                  className="w-full border p-2 rounded text-sm" 
                  onChange={handleAvatarChange} 
                />
                {avatarPreview && (
                  <div className="mt-3 flex justify-center bg-gray-50 p-4 rounded border border-dashed">
                    <img src={avatarPreview} alt="Preview" className="h-20 object-contain" />
                  </div>
                )}
              </div>

              <div className="flex justify-end gap-4 pt-4 border-t">
                <button type="button" onClick={() => setShowModal(false)} className="text-gray-500 hover:text-gray-700">Cancel</button>
                <button type="submit" className="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700 transition">
                  {isEditing ? 'Save Changes' : 'Create'}
                </button>
              </div>
            </form>
          </div>
        </div>
      )}

      {/* Delete Confirmation Modal */}
      <DeleteConfirmationModal
        isVisible={showDeleteModal}
        onClose={() => {
          if (!isDeleting) {
            setShowDeleteModal(false);
            setCountryToDelete(null);
          }
        }}
        onConfirm={handleDeleteConfirm}
        itemName={countryToDelete?.name}
        message={countryToDelete ? `Are you sure you want to delete "${countryToDelete.name}"? This may affect all municipalities and clubs linked to this country. This action cannot be undone.` : undefined}
        isLoading={isDeleting}
      />

      {/* Toast Notification */}
      <Toast
        message={toast.message}
        type={toast.type}
        isVisible={toast.isVisible}
        onClose={() => setToast({ ...toast, isVisible: false })}
      />
    </div>
  );
}

export default function ManageCountriesPage() {
  return (
    <Suspense fallback={<div>Loading...</div>}>
      <ManageCountriesPageContent />
    </Suspense>
  );
}


--- END OF FILE: ./frontend/app/admin/super/countries/page.tsx ---


--- START OF FILE: ./frontend/app/admin/super/interests/page.tsx ---
'use client';

import { useState, useEffect, Suspense } from 'react';
import { useRouter, useSearchParams, usePathname } from 'next/navigation';
import api from '../../../../lib/api';
import { getMediaUrl } from '../../../utils';
import Toast from '../../../components/Toast';
import DeleteConfirmationModal from '../../../components/DeleteConfirmationModal';

function ManageInterestsPageContent() {
  const router = useRouter();
  const pathname = usePathname();
  const searchParams = useSearchParams();

  // --- STATE ---
  const [interests, setInterests] = useState<any[]>([]);
  const [totalCount, setTotalCount] = useState(0);
  const [isLoading, setIsLoading] = useState(true);
  
  // Toast State
  const [toast, setToast] = useState<{ message: string; type: 'success' | 'error' | 'info' | 'warning'; isVisible: boolean }>({
    message: '',
    type: 'success',
    isVisible: false,
  });

  // Modal
  const [showModal, setShowModal] = useState(false);
  const [isEditing, setIsEditing] = useState(false);
  const [editId, setEditId] = useState<number | null>(null);
  
  // Form Files
  const [avatarFile, setAvatarFile] = useState<File | null>(null);
  const [avatarPreview, setAvatarPreview] = useState<string | null>(null);
  
  // Delete Confirmation Modal State
  const [showDeleteModal, setShowDeleteModal] = useState(false);
  const [interestToDelete, setInterestToDelete] = useState<{ id: number; name: string } | null>(null);
  const [isDeleting, setIsDeleting] = useState(false);

  const initialFormState = {
    name: '',
    icon: '', // For Emoji
  };

  const [formData, setFormData] = useState(initialFormState);

  // --- LOAD DATA ---
  useEffect(() => {
    fetchInterests();
  }, [searchParams]);

  const fetchInterests = async () => {
    setIsLoading(true);
    try {
      const params = new URLSearchParams();
      const page = searchParams.get('page');
      if (page) params.set('page', page);
      
      const res = await api.get(`/interests/?${params.toString()}`);
      
      // Handle both paginated and non-paginated responses
      if (Array.isArray(res.data)) {
        // Non-paginated response (array)
        setInterests(res.data);
        setTotalCount(res.data.length);
      } else {
        // Paginated response (object with results and count)
        setInterests(res.data.results || []);
        setTotalCount(res.data.count || (res.data.results?.length || 0));
      }
    } catch (err) {
      console.error(err);
    } finally {
      setIsLoading(false);
    }
  };

  const updateUrl = (key: string, value: string) => {
    const params = new URLSearchParams(searchParams.toString());
    if (value) params.set(key, value); else params.delete(key);
    if (key !== 'page') params.set('page', '1');
    router.push(`${pathname}?${params.toString()}`);
  };

  // --- ACTIONS ---
  const handleOpenCreate = () => {
    setIsEditing(false);
    setEditId(null);
    setFormData(initialFormState);
    setAvatarFile(null);
    setAvatarPreview(null);
    setShowModal(true);
  };

  const handleOpenEdit = (interest: any) => {
    setIsEditing(true);
    setEditId(interest.id);
    
    setFormData({
      name: interest.name,
      icon: interest.icon || '',
    });
    setAvatarFile(null);
    setAvatarPreview(interest.avatar ? getMediaUrl(interest.avatar) : null);
    setShowModal(true);
  };

  const handleDeleteClick = (interest: any) => {
    setInterestToDelete({ id: interest.id, name: interest.name });
    setShowDeleteModal(true);
  };

  const handleDeleteConfirm = async () => {
    if (!interestToDelete) return;

    setIsDeleting(true);
    try {
      await api.delete(`/interests/${interestToDelete.id}/`);
      setToast({
        message: 'Interest deleted successfully!',
        type: 'success',
        isVisible: true,
      });
      setShowDeleteModal(false);
      setInterestToDelete(null);
      fetchInterests();
    } catch (err) {
      setToast({
        message: 'Failed to delete interest.',
        type: 'error',
        isVisible: true,
      });
    } finally {
      setIsDeleting(false);
    }
  };

  const handleAvatarChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (file) {
      setAvatarFile(file);
      const reader = new FileReader();
      reader.onloadend = () => setAvatarPreview(reader.result as string);
      reader.readAsDataURL(file);
    }
  };

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    try {
      const data = new FormData();
      data.append('name', formData.name);
      data.append('icon', formData.icon);
      
      if (avatarFile) data.append('avatar', avatarFile);

      const config = { headers: { 'Content-Type': 'multipart/form-data' } };
      
      // FIXED URLs
      if (isEditing && editId) {
        await api.patch(`/interests/${editId}/`, data, config);
        setToast({
          message: 'Interest updated successfully!',
          type: 'success',
          isVisible: true,
        });
      } else {
        await api.post('/interests/', data, config);
        setToast({
          message: 'Interest created successfully!',
          type: 'success',
          isVisible: true,
        });
      }

      setShowModal(false);
      fetchInterests();
    } catch (err) {
      setToast({
        message: 'Operation failed. Please try again.',
        type: 'error',
        isVisible: true,
      });
      console.error(err);
    }
  };

  const currentPage = Number(searchParams.get('page')) || 1;
  const totalPages = totalCount > 0 ? Math.ceil(totalCount / 10) : 1;

  return (
    <div>
      <div className="flex justify-between items-center mb-6">
        <h1 className="text-2xl font-bold text-gray-800">Manage Interests</h1>
        <button onClick={handleOpenCreate} className="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 shadow">
          + Add Interest
        </button>
      </div>

      {/* --- LIST --- */}
      <div className="bg-white rounded-lg shadow overflow-hidden mb-6">
        {isLoading ? (
          <div className="p-8 text-center text-gray-500">Loading...</div>
        ) : interests.length === 0 ? (
          <div className="p-8 text-center text-gray-500">No interests found. Add one to get started.</div>
        ) : (
          <table className="min-w-full divide-y divide-gray-200">
            <thead className="bg-gray-50">
              <tr>
                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Interest</th>
                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Icon (Emoji)</th>
                <th className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">Actions</th>
              </tr>
            </thead>
            <tbody className="bg-white divide-y divide-gray-200">
              {interests.map((interest) => (
                <tr key={interest.id}>
                  <td className="px-6 py-4 whitespace-nowrap">
                    <div className="flex items-center">
                      {/* Show Avatar if exists */}
                      {interest.avatar ? (
                        <img 
                          src={getMediaUrl(interest.avatar) || ''}
                          alt={interest.name}
                          className="w-10 h-10 rounded-lg object-cover mr-3 border bg-gray-50"
                          onError={(e) => { (e.target as HTMLImageElement).style.display = 'none'; }}
                        />
                      ) : (
                        <div className="w-10 h-10 rounded-lg bg-gray-100 mr-3 flex items-center justify-center text-gray-400 text-xs">
                          No img
                        </div>
                      )}
                      <div className="text-sm font-bold text-gray-900">{interest.name}</div>
                    </div>
                  </td>
                  <td className="px-6 py-4 whitespace-nowrap text-2xl">
                    {interest.icon}
                  </td>
                  <td className="px-6 py-4 whitespace-nowrap text-right text-sm font-medium space-x-4">
                    <button onClick={() => handleOpenEdit(interest)} className="text-indigo-600 hover:text-indigo-900 font-bold">Edit</button>
                    <button onClick={() => handleDeleteClick(interest)} className="text-red-600 hover:text-red-900">Delete</button>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        )}
      </div>

      {/* --- PAGINATION CONTROLS --- */}
      {totalCount > 0 && (
        <div className="flex items-center justify-between border-t border-gray-200 bg-white px-4 py-3 sm:px-6 rounded-lg shadow">
          <div className="flex flex-1 justify-between sm:hidden">
            <button 
              disabled={currentPage === 1}
              onClick={() => updateUrl('page', (currentPage - 1).toString())}
              className="relative inline-flex items-center rounded-md border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50 disabled:opacity-50"
            >
              Previous
            </button>
            <button 
              disabled={currentPage >= totalPages}
              onClick={() => updateUrl('page', (currentPage + 1).toString())}
              className="relative ml-3 inline-flex items-center rounded-md border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50 disabled:opacity-50"
            >
              Next
            </button>
          </div>
          <div className="hidden sm:flex sm:flex-1 sm:items-center sm:justify-between">
            <div>
              <p className="text-sm text-gray-700">
                Showing page <span className="font-medium">{currentPage}</span> of <span className="font-medium">{totalPages}</span>
                {' '}(Total: {totalCount})
              </p>
            </div>
            <div>
              <nav className="isolate inline-flex -space-x-px rounded-md shadow-sm" aria-label="Pagination">
                <button
                  disabled={currentPage === 1}
                  onClick={() => updateUrl('page', (currentPage - 1).toString())}
                  className="relative inline-flex items-center rounded-l-md px-2 py-2 text-gray-400 ring-1 ring-inset ring-gray-300 hover:bg-gray-50 focus:z-20 focus:outline-offset-0 disabled:opacity-50"
                >
                  <span className="sr-only">Previous</span>
                  ‚Üê Prev
                </button>
                
                {/* Simple Pagination Numbers */}
                {[...Array(totalPages)].map((_, i) => {
                  const p = i + 1;
                  return (
                    <button
                      key={p}
                      onClick={() => updateUrl('page', p.toString())}
                      className={`relative inline-flex items-center px-4 py-2 text-sm font-semibold 
                        ${p === currentPage 
                          ? 'bg-blue-600 text-white focus:z-20 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-blue-600' 
                          : 'text-gray-900 ring-1 ring-inset ring-gray-300 hover:bg-gray-50 focus:z-20 focus:outline-offset-0'}`}
                    >
                      {p}
                    </button>
                  );
                })}

                <button
                  disabled={currentPage >= totalPages}
                  onClick={() => updateUrl('page', (currentPage + 1).toString())}
                  className="relative inline-flex items-center rounded-r-md px-2 py-2 text-gray-400 ring-1 ring-inset ring-gray-300 hover:bg-gray-50 focus:z-20 focus:outline-offset-0 disabled:opacity-50"
                >
                  <span className="sr-only">Next</span>
                  Next ‚Üí
                </button>
              </nav>
            </div>
          </div>
        </div>
      )}

      {/* --- MODAL --- */}
      {showModal && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-xl shadow-2xl w-full max-w-md p-8">
            <h2 className="text-2xl font-bold mb-6 text-gray-800">{isEditing ? 'Edit Interest' : 'New Interest'}</h2>
            <form onSubmit={handleSubmit} className="space-y-6">
              
              <div>
                <label className="block text-sm font-bold mb-1 text-gray-700">Name</label>
                <input 
                  required 
                  type="text" 
                  placeholder="e.g. Football" 
                  className="w-full border p-2 rounded focus:ring-2 focus:ring-blue-500 outline-none" 
                  value={formData.name} 
                  onChange={e => setFormData({...formData, name: e.target.value})} 
                />
              </div>

              <div>
                <label className="block text-sm font-bold mb-1 text-gray-700">Icon (Emoji)</label>
                <input 
                  type="text" 
                  placeholder="e.g. ‚öΩ" 
                  className="w-full border p-2 rounded focus:ring-2 focus:ring-blue-500 outline-none" 
                  value={formData.icon} 
                  onChange={e => setFormData({...formData, icon: e.target.value})} 
                />
                <p className="text-xs text-gray-500 mt-1">Type an emoji (Win + . or Cmd + Ctrl + Space)</p>
              </div>

              {/* AVATAR UPLOAD */}
              <div>
                <label className="block text-sm font-bold mb-2 text-gray-700">Cover Image / Icon (SVG/PNG)</label>
                <input 
                  type="file" 
                  accept="image/*" 
                  className="w-full border p-2 rounded text-sm" 
                  onChange={handleAvatarChange} 
                />
                {avatarPreview && (
                  <div className="mt-3 flex justify-center bg-gray-50 p-4 rounded border border-dashed">
                    <img src={avatarPreview} alt="Preview" className="h-20 object-contain" />
                  </div>
                )}
              </div>

              <div className="flex justify-end gap-4 pt-4 border-t">
                <button type="button" onClick={() => setShowModal(false)} className="text-gray-500 hover:text-gray-700">Cancel</button>
                <button type="submit" className="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700 transition">
                  {isEditing ? 'Save Changes' : 'Create'}
                </button>
              </div>
            </form>
          </div>
        </div>
      )}

      {/* Delete Confirmation Modal */}
      <DeleteConfirmationModal
        isVisible={showDeleteModal}
        onClose={() => {
          if (!isDeleting) {
            setShowDeleteModal(false);
            setInterestToDelete(null);
          }
        }}
        onConfirm={handleDeleteConfirm}
        itemName={interestToDelete?.name}
        message={interestToDelete ? `Are you sure you want to delete "${interestToDelete.name}"? This will remove this interest from all users who selected it. This action cannot be undone.` : undefined}
        isLoading={isDeleting}
      />

      {/* Toast Notification */}
      <Toast
        message={toast.message}
        type={toast.type}
        isVisible={toast.isVisible}
        onClose={() => setToast({ ...toast, isVisible: false })}
      />
    </div>
  );
}

export default function ManageInterestsPage() {
  return (
    <Suspense fallback={<div>Loading...</div>}>
      <ManageInterestsPageContent />
    </Suspense>
  );
}
--- END OF FILE: ./frontend/app/admin/super/interests/page.tsx ---


--- START OF FILE: ./frontend/app/admin/municipality/layout.tsx ---
'use client';

import { useEffect, useState } from 'react';
import Link from 'next/link';
import { usePathname } from 'next/navigation';
import { useAuth } from '../../../context/AuthContext';
import { getMediaUrl } from '../../utils';
import api from '../../../lib/api';

const getInitials = (first?: string | null, last?: string | null) => {
  const firstInitial = first?.charAt(0)?.toUpperCase() || '';
  const lastInitial = last?.charAt(0)?.toUpperCase() || '';
  return firstInitial + lastInitial || 'U';
};

export default function MunicipalityAdminLayout({ children }: { children: React.ReactNode }) {
  const pathname = usePathname();
  const { logout, user, messageCount, refreshMessageCount } = useAuth();
  const [pendingRequestsCount, setPendingRequestsCount] = useState(0);

  useEffect(() => {
    refreshMessageCount();
    refreshPendingRequestsCount();
  }, []);

  const refreshPendingRequestsCount = async () => {
    if (!user) {
      setPendingRequestsCount(0);
      return;
    }
    
    try {
      const res = await api.get('/group-requests/');
      const data = Array.isArray(res.data) ? res.data : (res.data.results || []);
      setPendingRequestsCount(data.length);
    } catch (err: any) {
      // Silently handle 401 (unauthorized) - user might not be logged in or token expired
      if (err?.response?.status === 401) {
        setPendingRequestsCount(0);
        return;
      }
      console.error('Failed to load pending requests count', err);
      setPendingRequestsCount(0);
    }
  };

  const navigation = [
    { name: 'Overview', href: '/admin/municipality' },
    { name: 'My Municipality', href: '/admin/municipality/settings' },
    { name: 'Manage Clubs', href: '/admin/municipality/clubs' },
    { name: 'Manage Admins', href: '/admin/municipality/admins' },
    { name: 'Manage Youth', href: '/admin/municipality/youth' },
    { name: 'Manage Guardians', href: '/admin/municipality/guardians' },
    { name: 'News Feed', href: '/admin/municipality/news-feed' },
    { name: 'Manage Posts', href: '/admin/municipality/posts' },
    { name: 'Groups', href: '/admin/municipality/groups' },
    { name: 'Applications', href: '/admin/municipality/groups/requests', showBadge: true },
    { name: 'Manage Rewards', href: '/admin/municipality/rewards' },
    { name: 'Message Board', href: '/admin/municipality/msgboard', showBadge: true },
    { name: 'Custom Fields', href: '/admin/municipality/custom-fields' },
  ];

  return (
    <div className="min-h-screen bg-gray-100 flex">
      {/* SIDEBAR */}
      <aside className="w-64 bg-slate-900 text-white flex flex-col flex-shrink-0">
        <div className="p-6 border-b border-slate-800 flex items-center gap-3">
          <Link href="/admin/municipality/profile" className="inline-block">
            {user?.avatar ? (
              <img
                src={getMediaUrl(user.avatar) || ''}
                alt="Profile avatar"
                className="w-12 h-12 rounded-full object-cover border-2 border-blue-400"
              />
            ) : (
              <div className="w-12 h-12 rounded-full bg-blue-500 text-white flex items-center justify-center text-lg font-semibold border-2 border-blue-400">
                {getInitials(user?.first_name, user?.last_name)}
              </div>
            )}
          </Link>
          <div className="leading-tight">
            <h2 className="text-base font-semibold text-blue-100">
              {user?.first_name || ''} {user?.last_name || ''}
            </h2>
            <p className="text-[11px] uppercase tracking-wide text-slate-400">
              {user?.role?.replace(/_/g, ' ') || 'Municipality Admin'}
            </p>
          </div>
        </div>
        
        <nav className="flex-1 p-4 space-y-2">
          {navigation.map((item) => {
            const isActive = pathname === item.href;
            return (
              <Link
                key={item.name}
                href={item.href}
                className={`flex items-center justify-between px-4 py-3 rounded-lg text-sm font-medium transition-colors ${
                  isActive
                    ? 'bg-blue-600 text-white shadow-md'
                    : 'text-slate-300 hover:bg-slate-800 hover:text-white'
                }`}
              >
                <span>{item.name}</span>
                {item.showBadge && item.href.includes('/requests') && pendingRequestsCount > 0 && (
                  <span className="ml-2 inline-flex items-center justify-center rounded-full bg-red-500 text-white text-xs font-bold min-w-[1.5rem] px-2 py-0.5">
                    {pendingRequestsCount}
                  </span>
                )}
                {item.showBadge && !item.href.includes('/requests') && messageCount > 0 && (
                  <span className="ml-2 inline-flex items-center justify-center rounded-full bg-red-500 text-white text-xs font-bold min-w-[1.5rem] px-2 py-0.5">
                    {messageCount}
                  </span>
                )}
              </Link>
            );
          })}
        </nav>

        <div className="p-4 border-t border-slate-800">
          <button 
            onClick={logout}
            className="w-full py-2 px-4 bg-red-600 hover:bg-red-700 rounded text-sm font-bold transition"
          >
            Sign Out
          </button>
        </div>
      </aside>

      {/* MAIN CONTENT AREA */}
      <main className="flex-1 p-8 overflow-y-auto">
        {children}
      </main>
    </div>
  );
}


--- END OF FILE: ./frontend/app/admin/municipality/layout.tsx ---


--- START OF FILE: ./frontend/app/admin/municipality/page.tsx ---
'use client';

import { useAuth } from '../../../context/AuthContext';

export default function MunicipalityDashboard() {
  const { user } = useAuth();

  return (
    <div className="p-10">
      <h1 className="text-3xl font-bold text-blue-600 mb-3">Municipality Admin</h1>
      <p className="text-gray-600 mb-6">Welcome, {user?.first_name || 'Municipality Admin'}.</p>
      <div className="bg-white p-6 rounded-lg shadow">
        <p>Manage your municipality data and settings from the navigation menu.</p>
      </div>
    </div>
  );
}
--- END OF FILE: ./frontend/app/admin/municipality/page.tsx ---


--- START OF FILE: ./frontend/app/admin/municipality/settings/page.tsx ---
'use client';

import { useState, useEffect } from 'react';
import api from '../../../../lib/api';
import { useAuth } from '../../../../context/AuthContext';
import { getMediaUrl } from '../../../utils';
import Toast from '../../../components/Toast';

export default function MyMunicipalityPage() {
  const { user, loading } = useAuth();
  const [isLoading, setIsLoading] = useState(true);
  const [isSaving, setIsSaving] = useState(false);
  const [toast, setToast] = useState<{ message: string; type: 'success' | 'error' | 'info' | 'warning'; isVisible: boolean }>({
    message: '',
    type: 'success',
    isVisible: false,
  });
  
  // Data State
  const [muniData, setMuniData] = useState<any>(null);
  
  // Files
  const [avatarFile, setAvatarFile] = useState<File | null>(null);
  const [avatarPreview, setAvatarPreview] = useState<string | null>(null);
  const [heroFile, setHeroFile] = useState<File | null>(null);
  const [heroPreview, setHeroPreview] = useState<string | null>(null);

  // Form State
  const [formData, setFormData] = useState({
    name: '',
    municipality_code: '',
    description: '',
    terms_and_conditions: '',
    email: '',
    phone: '',
    website_link: '',
    allow_self_registration: true,
    facebook: '',
    instagram: ''
  });

  useEffect(() => {
    if (!loading && user) {
      fetchMunicipality();
    }
  }, [user, loading]);

  const fetchMunicipality = async () => {
    if (!user?.assigned_municipality) return; // Safety check

    try {
      // Since we filtered the QuerySet in Backend to only show assigned_muni,
      // we can technically fetch /municipalities/ and take the first result,
      // OR fetch by ID directly. ID is safer.
      
      // Note: user.assigned_municipality might be an Object or ID depending on serializer.
      // If it's an object, use .id. If it's a number, use it directly.
      const muniId = typeof user.assigned_municipality === 'object' 
        ? (user.assigned_municipality as any).id 
        : user.assigned_municipality;

      const res = await api.get(`/municipalities/${muniId}/`);
      const item = res.data;
      setMuniData(item);

      // Parse social media
      let social = { facebook: '', instagram: '' };
      try {
        if (item.social_media) {
          if (typeof item.social_media === 'string') social = { ...social, ...JSON.parse(item.social_media) };
          else if (typeof item.social_media === 'object') social = { ...social, ...item.social_media };
        }
      } catch (e) {}

      setFormData({
        name: item.name,
        municipality_code: item.municipality_code || '',
        description: item.description || '',
        terms_and_conditions: item.terms_and_conditions || '',
        email: item.email || '',
        phone: item.phone || '',
        website_link: item.website_link || '',
        allow_self_registration: item.allow_self_registration ?? true,
        facebook: social.facebook || '',
        instagram: social.instagram || ''
      });

      setAvatarPreview(item.avatar ? getMediaUrl(item.avatar) : null);
      setHeroPreview(item.hero_image ? getMediaUrl(item.hero_image) : null);

    } catch (err) {
      console.error("Failed to load municipality", err);
    } finally {
      setIsLoading(false);
    }
  };

  const handleFileChange = (e: React.ChangeEvent<HTMLInputElement>, type: 'avatar' | 'hero') => {
    const file = e.target.files?.[0];
    if (file) {
      const reader = new FileReader();
      reader.onloadend = () => {
        if (type === 'avatar') {
          setAvatarFile(file);
          setAvatarPreview(reader.result as string);
        } else {
          setHeroFile(file);
          setHeroPreview(reader.result as string);
        }
      };
      reader.readAsDataURL(file);
    }
  };

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setIsSaving(true);
    
    try {
      const data = new FormData();
      const socialMediaJson = JSON.stringify({
        facebook: formData.facebook,
        instagram: formData.instagram
      });

      // We only append editable fields
      data.append('name', formData.name);
      data.append('municipality_code', formData.municipality_code);
      data.append('description', formData.description);
      data.append('terms_and_conditions', formData.terms_and_conditions);
      data.append('email', formData.email);
      data.append('phone', formData.phone);
      data.append('website_link', formData.website_link);
      data.append('allow_self_registration', formData.allow_self_registration.toString());
      data.append('social_media', socialMediaJson);
      
      // Note: We do NOT send 'country' here, as it shouldn't change.

      if (avatarFile) data.append('avatar', avatarFile);
      if (heroFile) data.append('hero_image', heroFile);

      const config = { headers: { 'Content-Type': 'multipart/form-data' } };
      
      await api.patch(`/municipalities/${muniData.id}/`, data, config);
      
      setToast({
        message: 'Settings saved successfully!',
        type: 'success',
        isVisible: true,
      });
      // Re-fetch to clean up state
      fetchMunicipality();
      setAvatarFile(null);
      setHeroFile(null);

    } catch (err) {
      setToast({
        message: 'Failed to save settings. Please try again.',
        type: 'error',
        isVisible: true,
      });
      console.error(err);
    } finally {
      setIsSaving(false);
    }
  };

  if (loading || isLoading) return <div className="p-10 text-center">Loading...</div>;
  if (!muniData) return <div className="p-10 text-center">No Municipality Assigned. Contact Super Admin.</div>;

  return (
    <div className="space-y-6">
      <div className="rounded-2xl bg-gradient-to-r from-blue-600 to-purple-600 text-white p-8 shadow-lg">
        <div className="flex flex-col md:flex-row md:items-center md:justify-between gap-6">
          <div>
            <p className="text-sm uppercase tracking-widest text-white/70 font-semibold">Municipality Admin</p>
            <h1 className="text-3xl font-bold mt-1">My Municipality Settings</h1>
            <p className="text-white/80 mt-2 max-w-2xl">
              Keep your municipality profile up to date. Changes are instantly reflected in the Youth App.
            </p>
          </div>
          <div className="flex gap-4">
            <div className="bg-white/15 rounded-xl px-6 py-4 text-center">
              <p className="text-xs uppercase tracking-widest text-white/70">Municipality</p>
              <p className="text-xl font-bold">{formData.name || '‚Äî'}</p>
            </div>
            <div className="bg-white/15 rounded-xl px-6 py-4 text-center">
              <p className="text-xs uppercase tracking-widest text-white/70">Code</p>
              <p className="text-xl font-bold">{formData.municipality_code || '‚Äî'}</p>
            </div>
          </div>
        </div>
      </div>

      <div className="bg-white rounded-2xl shadow-xl p-8 border border-slate-100">
        <form className="space-y-10" onSubmit={handleSubmit}>
          
          {/* IMAGES SECTION */}
          <section className="space-y-4">
            <div className="flex items-center justify-between">
              <div>
                <h3 className="text-lg font-semibold text-slate-900">Branding</h3>
                <p className="text-sm text-slate-500">Update your municipality logo and hero banner.</p>
              </div>
            </div>
            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div className="bg-slate-50 p-4 rounded-xl border border-dashed border-slate-200">
                <label className="block text-xs font-semibold uppercase text-slate-500 mb-3">Logo / Avatar</label>
                <div className="flex items-center gap-4">
                  {avatarPreview ? (
                    <img src={avatarPreview} className="w-20 h-20 object-contain bg-white rounded-xl shadow" alt="Avatar" />
                  ) : (
                    <div className="w-20 h-20 bg-slate-200 rounded-xl flex items-center justify-center text-slate-400 text-sm">No Img</div>
                  )}
                  <input type="file" accept="image/*" className="text-sm" onChange={e => handleFileChange(e, 'avatar')} />
                </div>
              </div>

              <div className="bg-slate-50 p-4 rounded-xl border border-dashed border-slate-200">
                <label className="block text-xs font-semibold uppercase text-slate-500 mb-3">Hero Banner</label>
                <div className="space-y-3">
                  {heroPreview ? (
                    <img src={heroPreview} className="w-full h-32 object-cover rounded-xl shadow" alt="Hero" />
                  ) : (
                    <div className="w-full h-32 bg-slate-200 rounded-xl flex items-center justify-center text-slate-400 text-sm">No Hero Image</div>
                  )}
                  <input type="file" accept="image/*" className="text-sm" onChange={e => handleFileChange(e, 'hero')} />
                </div>
              </div>
            </div>
          </section>

          {/* BASIC INFO */}
          <section className="space-y-4">
            <div>
              <h3 className="text-lg font-semibold text-slate-900">Basic Details</h3>
              <p className="text-sm text-slate-500">General information visible across the app.</p>
            </div>
            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div>
                <label className="block text-sm font-semibold mb-2 text-slate-700">Municipality Name</label>
                <input type="text" className="w-full border border-slate-200 p-3 rounded-xl focus:ring-2 focus:ring-blue-500" 
                  value={formData.name} onChange={e => setFormData({...formData, name: e.target.value})} />
              </div>
              <div>
                <label className="block text-sm font-semibold mb-2 text-slate-700">Municipality Code</label>
                <input type="text" className="w-full border border-slate-200 p-3 rounded-xl focus:ring-2 focus:ring-blue-500" 
                  value={formData.municipality_code} onChange={e => setFormData({...formData, municipality_code: e.target.value})} />
              </div>
            </div>
            <div>
              <label className="block text-sm font-semibold mb-2 text-slate-700">Description</label>
              <textarea rows={3} className="w-full border border-slate-200 p-3 rounded-xl focus:ring-2 focus:ring-blue-500" 
                value={formData.description} onChange={e => setFormData({...formData, description: e.target.value})} />
            </div>
          </section>

          {/* CONTACT & SOCIALS */}
          <section className="space-y-4">
            <div>
              <h3 className="text-lg font-semibold text-slate-900">Contact & Socials</h3>
              <p className="text-sm text-slate-500">How users can reach your municipality.</p>
            </div>
            <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
              <div>
                <label className="block text-sm font-semibold mb-2 text-slate-700">Email</label>
                <input type="email" className="w-full border border-slate-200 p-3 rounded-xl focus:ring-2 focus:ring-blue-500" 
                  value={formData.email} onChange={e => setFormData({...formData, email: e.target.value})} />
              </div>
              <div>
                <label className="block text-sm font-semibold mb-2 text-slate-700">Phone</label>
                <input type="text" className="w-full border border-slate-200 p-3 rounded-xl focus:ring-2 focus:ring-blue-500" 
                  value={formData.phone} onChange={e => setFormData({...formData, phone: e.target.value})} />
              </div>
              <div>
                <label className="block text-sm font-semibold mb-2 text-slate-700">Website</label>
                <input type="url" className="w-full border border-slate-200 p-3 rounded-xl focus:ring-2 focus:ring-blue-500" 
                  value={formData.website_link} onChange={e => setFormData({...formData, website_link: e.target.value})} />
              </div>
            </div>
            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div>
                <label className="block text-sm font-semibold mb-2 text-slate-700">Facebook URL</label>
                <input type="text" className="w-full border border-slate-200 p-3 rounded-xl focus:ring-2 focus:ring-blue-500" 
                  value={formData.facebook} onChange={e => setFormData({...formData, facebook: e.target.value})} />
              </div>
              <div>
                <label className="block text-sm font-semibold mb-2 text-slate-700">Instagram URL</label>
                <input type="text" className="w-full border border-slate-200 p-3 rounded-xl focus:ring-2 focus:ring-blue-500" 
                  value={formData.instagram} onChange={e => setFormData({...formData, instagram: e.target.value})} />
              </div>
            </div>
          </section>

          {/* SETTINGS */}
          <section className="space-y-4">
            <div>
              <h3 className="text-lg font-semibold text-slate-900">Settings</h3>
              <p className="text-sm text-slate-500">Control member registration and policies.</p>
            </div>
            <div className="flex items-center gap-3 p-4 border border-slate-200 rounded-xl bg-slate-50">
                <input 
                  type="checkbox" 
                  id="selfReg"
                  className="w-5 h-5 text-blue-600"
                  checked={formData.allow_self_registration}
                  onChange={e => setFormData({...formData, allow_self_registration: e.target.checked})}
                />
                <label htmlFor="selfReg" className="font-medium text-slate-900 cursor-pointer">
                  Allow youth/guardians to self-register for verification
                </label>
            </div>
            <div>
              <label className="block text-sm font-semibold mb-2 text-slate-700">Terms & Conditions</label>
              <textarea rows={4} className="w-full border border-slate-200 p-3 rounded-xl focus:ring-2 focus:ring-blue-500" 
                value={formData.terms_and_conditions} onChange={e => setFormData({...formData, terms_and_conditions: e.target.value})} />
            </div>
          </section>

          <div className="flex justify-end border-t border-slate-100 pt-6">
            <button 
              type="submit"
              disabled={isSaving}
              className="bg-blue-600 text-white px-8 py-3 rounded-xl font-semibold shadow hover:bg-blue-700 transition disabled:opacity-50"
            >
              {isSaving ? 'Saving...' : 'Save Changes'}
            </button>
          </div>
        </form>
      </div>

      <Toast
        message={toast.message}
        type={toast.type}
        isVisible={toast.isVisible}
        onClose={() => setToast({ ...toast, isVisible: false })}
      />
    </div>
  );
}
--- END OF FILE: ./frontend/app/admin/municipality/settings/page.tsx ---


--- START OF FILE: ./frontend/app/admin/municipality/posts/page.tsx ---
'use client';

import { useEffect, useState } from 'react';
import Link from 'next/link';
import api from '../../../../lib/api';
import { Post } from '../../../../types/post';
import DeleteConfirmationModal from '../../../components/DeleteConfirmationModal';
import Toast from '../../../components/Toast';

export default function SuperAdminPostsPage() {
    const [posts, setPosts] = useState<any[]>([]); // Use any to handle the nested details easier
    const [stats, setStats] = useState<any>(null);
    const [loading, setLoading] = useState(true);
    
    // Delete Modal State
    const [showDeleteModal, setShowDeleteModal] = useState(false);
    const [postToDelete, setPostToDelete] = useState<{ id: number; title: string } | null>(null);
    const [isDeleting, setIsDeleting] = useState(false);
    
    // Toast State
    const [toast, setToast] = useState<{ message: string; type: 'success' | 'error' | 'info' | 'warning'; isVisible: boolean }>({
        message: '',
        type: 'success',
        isVisible: false,
    });

    const fetchData = async () => {
        try {
            const postsRes = await api.get('/posts/');
            setPosts(postsRes.data.results || postsRes.data);

            const statsRes = await api.get('/posts/analytics_overview/');
            setStats(statsRes.data);
        } catch (err) {
            console.error("Failed to fetch posts", err);
        } finally {
            setLoading(false);
        }
    };

    useEffect(() => {
        fetchData();
    }, []);

    const handleDeleteClick = (post: Post) => {
        setPostToDelete({ id: post.id, title: post.title });
        setShowDeleteModal(true);
    };

    const handleDeleteConfirm = async () => {
        if (!postToDelete) return;

        setIsDeleting(true);
        try {
            await api.delete(`/posts/${postToDelete.id}/`);
            setToast({ message: 'Post deleted successfully!', type: 'success', isVisible: true });
            setShowDeleteModal(false);
            setPostToDelete(null);
            fetchData(); 
        } catch (err) {
            setToast({ message: 'Failed to delete post.', type: 'error', isVisible: true });
        } finally {
            setIsDeleting(false);
        }
    };

    // Helper to determine what to show in the "Scope" column
    const getScopeBadge = (post: any) => {
        if (post.is_global) {
            return <span className="bg-purple-100 text-purple-800 px-2 py-1 rounded-full text-xs font-bold">üåç Global</span>;
        }
        
        // Super Admin creating for specific Munis
        if (post.target_municipalities_details && post.target_municipalities_details.length > 0) {
            const count = post.target_municipalities_details.length;
            const name = post.target_municipalities_details[0].name;
            return (
                <span className="bg-blue-100 text-blue-800 px-2 py-1 rounded-full text-xs font-bold">
                    üèõÔ∏è {count > 1 ? `${count} Municipalities` : name}
                </span>
            );
        }

        // Super/Muni Admin creating for specific Clubs
        if (post.target_clubs_details && post.target_clubs_details.length > 0) {
            const count = post.target_clubs_details.length;
            const name = post.target_clubs_details[0].name;
            return (
                <span className="bg-green-100 text-green-800 px-2 py-1 rounded-full text-xs font-bold">
                    ‚öΩ {count > 1 ? `${count} Clubs` : name}
                </span>
            );
        }

        // Fallback based on ownership
        if (post.owner_role === 'MUNICIPALITY_ADMIN') return <span className="text-gray-500 text-xs">Municipality</span>;
        if (post.owner_role === 'CLUB_ADMIN') return <span className="text-gray-500 text-xs">Club</span>;

        return <span className="text-gray-400 text-xs">-</span>;
    };

    if (loading) return <div className="p-8 text-center">Loading posts...</div>;

    return (
        <div className="space-y-6">
            {/* Header */}
            <div className="flex justify-between items-center">
                <h1 className="text-2xl font-bold text-gray-800">Post Management</h1>
                <Link 
                    href="/admin/super/posts/create"
                    className="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md font-medium"
                >
                    + Create New Post
                </Link>
            </div>

            {/* Analytics Cards */}
            {stats && (
                <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div className="bg-white p-4 rounded-lg shadow border-l-4 border-blue-500">
                        <p className="text-sm text-gray-500">Total Posts</p>
                        <p className="text-2xl font-bold">{stats.total_posts}</p>
                    </div>
                    <div className="bg-white p-4 rounded-lg shadow border-l-4 border-green-500">
                        <p className="text-sm text-gray-500">New (7 Days)</p>
                        <p className="text-2xl font-bold">{stats.created_last_7_days}</p>
                    </div>
                    <div className="bg-white p-4 rounded-lg shadow border-l-4 border-purple-500">
                        <p className="text-sm text-gray-500">New (30 Days)</p>
                        <p className="text-2xl font-bold">{stats.created_last_30_days}</p>
                    </div>
                    <div className="bg-white p-4 rounded-lg shadow border-l-4 border-orange-500">
                        <p className="text-sm text-gray-500">Avg Views</p>
                        <p className="text-2xl font-bold">{stats.average_views}</p>
                    </div>
                </div>
            )}

            {/* Posts Table */}
            <div className="bg-white shadow rounded-lg overflow-hidden">
                <table className="min-w-full divide-y divide-gray-200">
                    <thead className="bg-gray-50">
                        <tr>
                            <th className="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Title</th>
                            <th className="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Scope</th>
                            <th className="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Type</th>
                            <th className="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Status</th>
                            <th className="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Views</th>
                            <th className="px-6 py-3 text-right text-xs font-bold text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody className="bg-white divide-y divide-gray-200">
                        {posts.length === 0 ? (
                            <tr>
                                <td colSpan={6} className="px-6 py-8 text-center text-gray-500">
                                    No posts found. Create your first one!
                                </td>
                            </tr>
                        ) : (
                            posts.map((post) => (
                                <tr key={post.id} className="hover:bg-gray-50 transition">
                                    <td className="px-6 py-4">
                                        <div className="text-sm font-bold text-gray-900">
                                            {post.is_pinned && <span className="mr-2 text-red-500" title="Pinned">üìå</span>}
                                            {post.title}
                                        </div>
                                        <div className="text-xs text-gray-500">
                                            By {post.author?.first_name || 'Unknown'} ‚Ä¢ {new Date(post.created_at).toLocaleDateString()}
                                        </div>
                                    </td>
                                    
                                    {/* NEW SCOPE COLUMN */}
                                    <td className="px-6 py-4">
                                        {getScopeBadge(post)}
                                    </td>

                                    <td className="px-6 py-4">
                                        <span className="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-gray-100 text-gray-800 border border-gray-200">
                                            {post.post_type}
                                        </span>
                                    </td>
                                    <td className="px-6 py-4">
                                        <span className={`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-bold ${
                                            post.status === 'PUBLISHED' ? 'bg-green-100 text-green-800' :
                                            post.status === 'DRAFT' ? 'bg-yellow-100 text-yellow-800' :
                                            'bg-gray-100 text-gray-800'
                                        }`}>
                                            {post.status}
                                        </span>
                                    </td>
                                    <td className="px-6 py-4 text-sm text-gray-500">
                                        {post.view_count}
                                    </td>
                                    <td className="px-6 py-4 text-right text-sm font-medium space-x-3">
                                        <Link href={`/admin/super/posts/${post.id}`} className="text-indigo-600 hover:text-indigo-900">
                                            View
                                        </Link>
                                        <Link href={`/admin/super/posts/edit/${post.id}`} className="text-blue-600 hover:text-blue-900">
                                            Edit
                                        </Link>
                                        <button 
                                            onClick={() => handleDeleteClick(post)}
                                            className="text-red-600 hover:text-red-900"
                                        >
                                            Delete
                                        </button>
                                    </td>
                                </tr>
                            ))
                        )}
                    </tbody>
                </table>
            </div>

            <DeleteConfirmationModal
                isVisible={showDeleteModal}
                onClose={() => { if (!isDeleting) { setShowDeleteModal(false); setPostToDelete(null); } }}
                onConfirm={handleDeleteConfirm}
                itemName={postToDelete?.title}
                isLoading={isDeleting}
            />
            <Toast message={toast.message} type={toast.type} isVisible={toast.isVisible} onClose={() => setToast({ ...toast, isVisible: false })} />
        </div>
    );
}

--- END OF FILE: ./frontend/app/admin/municipality/posts/page.tsx ---


--- START OF FILE: ./frontend/app/admin/municipality/posts/edit/[id]/page.tsx ---
'use client';

import { useEffect, useState } from 'react';
import { useRouter, useParams } from 'next/navigation';
import api from '../../../../../../lib/api';
import PostForm from '../../../../../components/posts/PostForm';
import { Post } from '../../../../../../types/post';

export default function EditPostPage() {
    const router = useRouter();
    const params = useParams();
    const postId = params?.id as string;
    
    const [post, setPost] = useState<Post | null>(null);
    const [loading, setLoading] = useState(true);

    useEffect(() => {
        if (!postId) return;
        
        const fetchPost = async () => {
            try {
                const res = await api.get(`/posts/${postId}/`);
                setPost(res.data);
            } catch (err) {
                console.error("Failed to fetch post", err);
                alert("Post not found");
                router.push('/admin/municipality/posts');
            } finally {
                setLoading(false);
            }
        };
        fetchPost();
    }, [postId, router]);

    if (loading) return <div className="p-8 text-center text-gray-500">Loading post data...</div>;
    if (!post) return null;

    return (
        <div className="max-w-4xl mx-auto">
            <div className="mb-6">
                <button 
                    onClick={() => router.back()}
                    className="text-sm text-gray-500 hover:text-gray-700 mb-2"
                >
                    ‚Üê Cancel & Back
                </button>
                <h1 className="text-2xl font-bold text-gray-900">Edit Post</h1>
            </div>

            <PostForm 
                initialData={post}
                role="municipality" // <--- Ensures "Global" option is HIDDEN
                onSuccess={() => router.push(`/admin/municipality/posts/${post.id}`)} 
            />
        </div>
    );
}
--- END OF FILE: ./frontend/app/admin/municipality/posts/edit/[id]/page.tsx ---


--- START OF FILE: ./frontend/app/admin/municipality/posts/[id]/page.tsx ---
'use client';

import { useEffect, useMemo, useState } from 'react';
import Link from 'next/link';
import { useRouter, useParams } from 'next/navigation';
import api from '../../../../../lib/api';
import { Post } from '../../../../../types/post';

export default function PostDetailPage() {
    const router = useRouter();
    const params = useParams();
    const postId = params?.id as string;
    
    const [post, setPost] = useState<Post | null>(null);
    const [comments, setComments] = useState<any[]>([]);
    const [loading, setLoading] = useState(true);
    const [customFieldMap, setCustomFieldMap] = useState<Record<number, string>>({});

    const fetchData = async () => {
        if (!postId) return;
        
        try {
            // 1. Fetch Post Details
            const postRes = await api.get(`/posts/${postId}/`);
            setPost(postRes.data);

            // 2. Fetch Comments for this post
            const commentsRes = await api.get(`/post-comments/?post_id=${postId}`);
            setComments(commentsRes.data.results || commentsRes.data);
        } catch (err) {
            console.error(err);
        } finally {
            setLoading(false);
        }
    };

    useEffect(() => {
        fetchData();
    }, [postId]);

    const handleApproveComment = async (commentId: number, currentStatus: boolean) => {
        try {
            await api.patch(`/post-comments/${commentId}/`, { is_approved: !currentStatus });
            fetchData(); // Refresh list
        } catch (err) {
            alert('Failed to update comment');
        }
    };

    const handleDeleteComment = async (commentId: number) => {
        if (!confirm("Delete this comment permanently?")) return;
        try {
            await api.delete(`/post-comments/${commentId}/`);
            fetchData(); // Refresh list
        } catch (err) {
            alert('Failed to delete comment');
        }
    };

    const hasCustomFieldRules = useMemo(() => {
        if (!post?.target_custom_fields) return false;
        return Object.keys(post.target_custom_fields).length > 0;
    }, [post?.target_custom_fields]);

    useEffect(() => {
        const fetchCustomFieldNames = async () => {
            if (!hasCustomFieldRules) return;
            try {
                const res = await api.get('/custom-fields/');
                const definitions = res.data.results || res.data || [];
                const map = definitions.reduce((acc: Record<number, string>, field: any) => {
                    acc[field.id] = field.name;
                    return acc;
                }, {});
                setCustomFieldMap(map);
            } catch (error) {
                console.error('Failed to load custom fields', error);
            }
        };

        fetchCustomFieldNames();
    }, [hasCustomFieldRules]);

    if (loading) return <div className="p-8">Loading...</div>;
    if (!post) return <div className="p-8">Post not found</div>;

    return (
        <div className="space-y-6 max-w-6xl mx-auto">
            {/* --- HEADER --- */}
            <div className="flex justify-between items-start">
                <div>
                    <button onClick={() => router.push('/admin/super/posts')} className="text-sm text-gray-500 mb-1 hover:underline">‚Üê Back to List</button>
                    <h1 className="text-3xl font-bold text-gray-900">{post.title}</h1>
                    <div className="flex items-center gap-3 mt-2">
                        <span className={`px-2 py-1 rounded-full text-xs font-bold ${
                            post.status === 'PUBLISHED' ? 'bg-green-100 text-green-800' :
                            post.status === 'DRAFT' ? 'bg-yellow-100 text-yellow-800' :
                            'bg-gray-100 text-gray-800'
                        }`}>
                            {post.status}
                        </span>
                        <span className="text-sm text-gray-500">Created: {new Date(post.created_at).toLocaleDateString()}</span>
                        {post.is_pinned && <span className="text-sm text-red-500 font-medium">üìå Pinned</span>}
                    </div>
                </div>
                <div className="flex gap-3">
                    <Link 
                        href={`/admin/super/posts/edit/${post.id}`}
                        className="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 font-medium"
                    >
                        Edit Post
                    </Link>
                </div>
            </div>

            <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                
                {/* --- LEFT COL: PREVIEW --- */}
                <div className="lg:col-span-2 space-y-6">
                    {/* Content Preview Card */}
                    <div className="bg-white p-6 rounded-lg shadow">
                        <h3 className="text-lg font-bold text-gray-800 mb-4 border-b pb-2">Content Preview</h3>
                        
                        {/* Video Display */}
                        {post.post_type === 'VIDEO' && post.video_url && (
                            <div className="mb-4 bg-black rounded overflow-hidden aspect-video flex items-center justify-center text-white">
                                {/* Simple placeholder if specific youtube embed logic isn't added yet */}
                                <a href={post.video_url} target="_blank" rel="noreferrer" className="underline">
                                    Watch Video ({post.video_url})
                                </a>
                            </div>
                        )}

                        {/* Image Display */}
                        {post.post_type === 'IMAGE' && post.images && post.images.length > 0 && (
                            <div className="flex gap-2 overflow-x-auto mb-4 pb-2">
                                {post.images.map(img => (
                                    <img key={img.id} src={img.image} className="h-48 rounded object-cover border" alt="Post media" />
                                ))}
                            </div>
                        )}

                        {/* Text Content */}
                        <div 
                            className="prose max-w-none text-gray-700 bg-gray-50 p-4 rounded border"
                            dangerouslySetInnerHTML={{ __html: post.content }} 
                        />
                    </div>

                    {/* Comments Manager */}
                    <div className="bg-white p-6 rounded-lg shadow">
                        <div className="flex justify-between items-center mb-4">
                            <h3 className="text-lg font-bold text-gray-800">Comments ({comments.length})</h3>
                            <span className="text-xs text-gray-500">Moderation: {post.require_moderation ? 'On' : 'Off'}</span>
                        </div>
                        
                        <div className="space-y-4 max-h-96 overflow-y-auto">
                            {comments.length === 0 ? (
                                <p className="text-gray-400 italic">No comments yet.</p>
                            ) : (
                                comments.map(comment => (
                                    <div key={comment.id} className={`p-3 rounded border ${comment.is_approved ? 'bg-white' : 'bg-red-50 border-red-200'}`}>
                                        <div className="flex justify-between">
                                            <p className="text-sm font-bold text-gray-700">
                                                {comment.author?.first_name} {comment.author?.last_name}
                                                <span className="text-gray-400 font-normal ml-2 text-xs">
                                                    {new Date(comment.created_at).toLocaleString()}
                                                </span>
                                            </p>
                                            <div className="flex gap-2">
                                                <button 
                                                    onClick={() => handleApproveComment(comment.id, comment.is_approved)}
                                                    className={`text-xs px-2 py-1 rounded ${comment.is_approved ? 'bg-yellow-100 text-yellow-700' : 'bg-green-100 text-green-700'}`}
                                                >
                                                    {comment.is_approved ? 'Hide' : 'Approve'}
                                                </button>
                                                <button 
                                                    onClick={() => handleDeleteComment(comment.id)}
                                                    className="text-xs px-2 py-1 rounded bg-red-100 text-red-700 hover:bg-red-200"
                                                >
                                                    Delete
                                                </button>
                                            </div>
                                        </div>
                                        <p className="text-gray-800 mt-1 text-sm">{comment.content}</p>
                                        {!comment.is_approved && (
                                            <p className="text-xs text-red-600 font-bold mt-1">‚ö† Pending Approval</p>
                                        )}
                                    </div>
                                ))
                            )}
                        </div>
                    </div>
                </div>

                {/* --- RIGHT COL: DETAILS & ANALYTICS --- */}
                <div className="space-y-6">
                    
                    {/* Analytics Card */}
                    <div className="bg-white p-6 rounded-lg shadow border-t-4 border-blue-500">
                        <h3 className="font-bold text-gray-800 mb-4">Analytics</h3>
                        <div className="grid grid-cols-2 gap-4 text-center">
                            <div className="p-2 bg-gray-50 rounded">
                                <p className="text-2xl font-bold text-blue-600">{post.view_count}</p>
                                <p className="text-xs text-gray-500">Views</p>
                            </div>
                            <div className="p-2 bg-gray-50 rounded">
                                <p className="text-2xl font-bold text-green-600">{comments.length}</p>
                                <p className="text-xs text-gray-500">Comments</p>
                            </div>
                        </div>
                    </div>

                    {/* Targeting Summary */}
                    <div className="bg-white p-6 rounded-lg shadow">
                        <h3 className="font-bold text-gray-800 mb-4">Target Audience</h3>
                        <ul className="space-y-3 text-sm">
                            <li className="flex justify-between">
                                <span className="text-gray-500">Member Type:</span>
                                <span className="font-medium">{post.target_member_type}</span>
                            </li>
                            {post.target_groups.length > 0 ? (
                                <div>
                                    <p className="text-gray-500 mb-1">Targeted Groups:</p>
                                    <div className="flex flex-wrap gap-1">
                                        {post.target_groups.map(g => (
                                            <span key={g} className="px-2 py-0.5 bg-blue-100 text-blue-800 rounded text-xs">Group ID {g}</span>
                                        ))}
                                    </div>
                                </div>
                            ) : (
                                <>
                                    <li className="flex justify-between">
                                        <span className="text-gray-500">Age Range:</span>
                                        <span className="font-medium">
                                            {post.target_min_age || 0} - {post.target_max_age || 'Any'}
                                        </span>
                                    </li>
                                    <li className="flex justify-between">
                                        <span className="text-gray-500">Gender:</span>
                                        <span className="font-medium">
                                            {post.target_genders.length > 0 ? post.target_genders.join(', ') : 'All'}
                                        </span>
                                    </li>
                                    <li className="flex justify-between">
                                        <span className="text-gray-500">Grades:</span>
                                        <span className="font-medium">
                                            {post.target_grades.length > 0 ? post.target_grades.join(', ') : 'All'}
                                        </span>
                                    </li>
                                </>
                            )}
                            {hasCustomFieldRules && (
                                <li className="flex flex-col gap-2">
                                    <span className="text-gray-500">Custom Field Rules:</span>
                                    <div className="flex flex-col gap-1">
                                        {Object.entries(post.target_custom_fields || {}).map(([fieldId, value]) => {
                                            const id = Number(fieldId);
                                            const fieldName = customFieldMap[id] || `Custom Field #${fieldId}`;
                                            let displayValue: string;
                                            if (typeof value === 'boolean') displayValue = value ? 'Yes' : 'No';
                                            else displayValue = Array.isArray(value) ? value.join(', ') : String(value);
                                            return (
                                                <span
                                                    key={fieldId}
                                                    className="text-sm text-gray-700 bg-gray-50 px-2 py-1 rounded border border-gray-100"
                                                >
                                                    <strong>{fieldName}:</strong> {displayValue || 'Any'}
                                                </span>
                                            );
                                        })}
                                    </div>
                                </li>
                            )}
                        </ul>
                    </div>

                    {/* Settings Summary */}
                    <div className="bg-white p-6 rounded-lg shadow">
                        <h3 className="font-bold text-gray-800 mb-4">Configuration</h3>
                        <ul className="space-y-2 text-sm text-gray-600">
                            <li>‚Ä¢ {post.allow_comments ? '‚úÖ Comments Allowed' : '‚ùå Comments Disabled'}</li>
                            <li>‚Ä¢ {post.require_moderation ? '‚úÖ Moderation On' : '‚ö™ Moderation Off'}</li>
                            <li>‚Ä¢ {post.send_push_notification ? '‚úÖ Push Notification Sent' : '‚ö™ No Push Notification'}</li>
                            {post.visibility_end_date && (
                                <li className="text-orange-600">‚Ä¢ Expires: {new Date(post.visibility_end_date).toLocaleDateString()}</li>
                            )}
                        </ul>
                    </div>

                </div>
            </div>
        </div>
    );
}
--- END OF FILE: ./frontend/app/admin/municipality/posts/[id]/page.tsx ---


--- START OF FILE: ./frontend/app/admin/municipality/posts/create/page.tsx ---
'use client';

import { useRouter } from 'next/navigation';
import PostForm from '../../../../components/posts/PostForm';

export default function CreatePostPage() {
    const router = useRouter();

    return (
        <div className="max-w-4xl mx-auto">
            <div className="mb-6">
                <button 
                    onClick={() => router.back()}
                    className="text-sm text-gray-500 hover:text-gray-700 mb-2"
                >
                    ‚Üê Back to Posts
                </button>
                <h1 className="text-2xl font-bold text-gray-900">Create New Post</h1>
                <p className="text-gray-500">Share updates, news, or media with your members.</p>
            </div>

            <PostForm 
                role="municipality" // <--- This ensures only Municipality options are shown
                onSuccess={() => router.push('/admin/municipality/posts')} 
            />
        </div>
    );
}
--- END OF FILE: ./frontend/app/admin/municipality/posts/create/page.tsx ---


--- START OF FILE: ./frontend/app/admin/municipality/clubs/page.tsx ---
'use client';

import { useState, useEffect, Suspense } from 'react';
import Link from 'next/link';
import { useRouter, useSearchParams, usePathname } from 'next/navigation';
import api from '../../../../lib/api';
import { useAuth } from '../../../../context/AuthContext';
import { getMediaUrl } from '../../../utils';
import Toast from '../../../components/Toast';
import DeleteConfirmationModal from '../../../components/DeleteConfirmationModal';

const WEEKDAYS = [
  { id: 1, name: 'Monday' }, { id: 2, name: 'Tuesday' }, { id: 3, name: 'Wednesday' },
  { id: 4, name: 'Thursday' }, { id: 5, name: 'Friday' }, { id: 6, name: 'Saturday' }, { id: 7, name: 'Sunday' },
];

const CYCLES = [
  { id: 'ALL', name: 'Every Week' },
  { id: 'ODD', name: 'Odd Weeks' },
  { id: 'EVEN', name: 'Even Weeks' },
];

const GENDER_RESTRICTIONS = [
  { id: 'ALL', name: 'All Genders' },
  { id: 'BOYS', name: 'Boys Only' },
  { id: 'GIRLS', name: 'Girls Only' },
  { id: 'OTHER', name: 'Other' },
];

function ManageMuniClubsPageContent() {
  const router = useRouter();
  const pathname = usePathname();
  const searchParams = useSearchParams();
  const { user } = useAuth();

  // --- STATE ---
  const [clubs, setClubs] = useState<any[]>([]);
  const [totalCount, setTotalCount] = useState(0);
  const [isLoading, setIsLoading] = useState(true);
  
  const [toast, setToast] = useState<{ message: string; type: 'success' | 'error'; isVisible: boolean }>({
    message: '', type: 'success', isVisible: false,
  });

  // Modal & Files
  const [showModal, setShowModal] = useState(false);
  const [isEditing, setIsEditing] = useState(false);
  const [editId, setEditId] = useState<number | null>(null);
  const [avatarFile, setAvatarFile] = useState<File | null>(null);
  const [avatarPreview, setAvatarPreview] = useState<string | null>(null);
  const [heroFile, setHeroFile] = useState<File | null>(null);
  const [heroPreview, setHeroPreview] = useState<string | null>(null);
  
  // Delete Confirmation Modal State
  const [showDeleteModal, setShowDeleteModal] = useState(false);
  const [clubToDelete, setClubToDelete] = useState<{ id: number; name: string } | null>(null);
  const [isDeleting, setIsDeleting] = useState(false);

  // Opening Hours
  const [openingHours, setOpeningHours] = useState<any[]>([]);
  const [hourError, setHourError] = useState('');

  // Form Data (No municipality field needed, backend handles it)
  const initialFormState = {
    name: '', email: '', phone: '',
    description: '', terms_and_conditions: '', club_policies: '',
    address: '', club_categories: '', latitude: '', longitude: '',
  };
  const [formData, setFormData] = useState(initialFormState);

  // New Hour Form
  const initialHourState = {
    weekday: 1, week_cycle: 'ALL',
    open_time: '14:00', close_time: '20:00',
    title: '', gender_restriction: 'ALL',
    restriction_mode: 'NONE', // NONE, AGE, GRADE
    min_value: '', max_value: ''
  };
  const [newHour, setNewHour] = useState(initialHourState);

  useEffect(() => {
    fetchClubs();
  }, [searchParams]);

  const fetchClubs = async () => {
    setIsLoading(true);
    try {
      const params = new URLSearchParams();
      const page = searchParams.get('page');
      if (page) params.set('page', page);
      const search = searchParams.get('search');
      if (search) params.set('search', search);
      
      // API automatically filters for this user's municipality
      const clubRes = await api.get(`/clubs/?${params.toString()}`);
      
      if (Array.isArray(clubRes.data)) {
        setClubs(clubRes.data);
        setTotalCount(clubRes.data.length);
      } else {
        setClubs(clubRes.data.results || []);
        setTotalCount(clubRes.data.count || 0);
      }
    } catch (err) {
      console.error(err);
    } finally {
      setIsLoading(false);
    }
  };

  const updateUrl = (key: string, value: string) => {
    const params = new URLSearchParams(searchParams.toString());
    if (value) params.set(key, value); else params.delete(key);
    if (key !== 'page') params.set('page', '1');
    router.push(`${pathname}?${params.toString()}`);
  };

  const handleOpenCreate = () => {
    setIsEditing(false); setEditId(null);
    setFormData(initialFormState);
    setOpeningHours([]); setNewHour(initialHourState);
    setAvatarFile(null); setAvatarPreview(null);
    setHeroFile(null); setHeroPreview(null);
    setShowModal(true);
  };

  const handleOpenEdit = (item: any) => {
    setIsEditing(true); setEditId(item.id);
    setFormData({
      name: item.name,
      email: item.email || '', phone: item.phone || '',
      description: item.description || '', terms_and_conditions: item.terms_and_conditions || '',
      club_policies: item.club_policies || '', address: item.address || '',
      club_categories: item.club_categories || '',
      latitude: item.latitude?.toString() || '', longitude: item.longitude?.toString() || '',
    });
    setOpeningHours(item.regular_hours || []);
    setAvatarFile(null); setAvatarPreview(item.avatar ? getMediaUrl(item.avatar) : null);
    setHeroFile(null); setHeroPreview(item.hero_image ? getMediaUrl(item.hero_image) : null);
    setNewHour(initialHourState);
    setShowModal(true);
  };

  const handleDeleteClick = (club: any) => {
    setClubToDelete({ id: club.id, name: club.name });
    setShowDeleteModal(true);
  };

  const handleDeleteConfirm = async () => {
    if (!clubToDelete) return;

    setIsDeleting(true);
    try { 
      await api.delete(`/clubs/${clubToDelete.id}/`);
      setToast({ message: 'Club deleted successfully!', type: 'success', isVisible: true });
      setShowDeleteModal(false);
      setClubToDelete(null);
      fetchClubs(); 
    } 
    catch (err) { 
      setToast({ message: 'Failed to delete club.', type: 'error', isVisible: true });
    } finally {
      setIsDeleting(false);
    }
  };

  const handleFileChange = (e: React.ChangeEvent<HTMLInputElement>, type: 'avatar' | 'hero') => {
    const file = e.target.files?.[0];
    if (file) {
      const reader = new FileReader();
      reader.onloadend = () => {
        if (type === 'avatar') { setAvatarFile(file); setAvatarPreview(reader.result as string); } 
        else { setHeroFile(file); setHeroPreview(reader.result as string); }
      };
      reader.readAsDataURL(file);
    }
  };

  // --- HOURS VALIDATION (Copy from Super Admin) ---
  const checkOverlap = (newItem: any) => {
    const toMins = (t: string) => {
      const [h, m] = t.split(':').map(Number);
      return h * 60 + m;
    };
    const start = toMins(newItem.open_time);
    const end = toMins(newItem.close_time);
    if (end <= start) return "Close time must be after Open time.";

    for (const h of openingHours) {
      if (h.weekday !== newItem.weekday) continue;
      const cycleOverlap = h.week_cycle === 'ALL' || newItem.week_cycle === 'ALL' || h.week_cycle === newItem.week_cycle;
      if (!cycleOverlap) continue;
      const s2 = toMins(h.open_time);
      const e2 = toMins(h.close_time);
      if (start < e2 && end > s2) {
        return `Overlap detected with existing hour: ${h.open_time}-${h.close_time}`;
      }
    }
    return null;
  };

  const addHour = () => {
    setHourError('');
    const error = checkOverlap(newHour);
    if (error) { setHourError(error); return; }
    setOpeningHours([...openingHours, { ...newHour }]);
    setNewHour({ ...newHour, title: '', min_value: '', max_value: '' }); 
  };

  const removeHour = (index: number) => {
    const updated = [...openingHours];
    updated.splice(index, 1);
    setOpeningHours(updated);
  };

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    const trimmedName = formData.name?.trim();
    if (!trimmedName) { alert('Club Name is required'); return; }

    try {
      const data = new FormData();
      data.append('name', trimmedName);
      
      const assignedMunicipality =
        typeof user?.assigned_municipality === 'object'
          ? user?.assigned_municipality?.id
          : user?.assigned_municipality;

      if (assignedMunicipality) {
        data.append('municipality', assignedMunicipality.toString());
      }
      
      // Append other fields
      const fields = ['email', 'phone', 'description', 'terms_and_conditions', 'club_policies', 'address', 'club_categories', 'latitude', 'longitude'];
      fields.forEach(field => {
        // @ts-ignore
        if (formData[field]?.trim()) data.append(field, formData[field].trim());
      });

      // Clean Hours
      const cleanedHours = openingHours.map(hour => {
        const cleaned: any = {
            weekday: hour.weekday, week_cycle: hour.week_cycle || 'ALL',
            open_time: hour.open_time, close_time: hour.close_time,
            title: hour.title || '', gender_restriction: hour.gender_restriction || 'ALL',
            restriction_mode: hour.restriction_mode || 'NONE',
        };
        if (cleaned.restriction_mode !== 'NONE') {
          cleaned.min_value = hour.min_value ? parseInt(hour.min_value) : null;
          cleaned.max_value = hour.max_value ? parseInt(hour.max_value) : null;
        }
        return cleaned;
      });
      
      data.append('regular_hours_data', JSON.stringify(cleanedHours));
      if (avatarFile) data.append('avatar', avatarFile);
      if (heroFile) data.append('hero_image', heroFile);

      const config = { headers: { 'Content-Type': 'multipart/form-data' } };
      if (isEditing && editId) {
        await api.patch(`/clubs/${editId}/`, data, config);
        setToast({ message: 'Club updated!', type: 'success', isVisible: true });
      } else {
        await api.post('/clubs/', data, config);
        setToast({ message: 'Club created!', type: 'success', isVisible: true });
      }

      setShowModal(false);
      fetchClubs();
    } catch (err: any) {
      const backendMessage = err?.response?.data
        ? typeof err.response.data === 'string'
          ? err.response.data
          : JSON.stringify(err.response.data)
        : 'Operation failed.';
      setToast({ message: backendMessage, type: 'error', isVisible: true });
      console.error(err);
    }
  };

  const currentPage = Number(searchParams.get('page')) || 1;
  const totalPages = totalCount > 0 ? Math.ceil(totalCount / 10) : 1;

  return (
    <div>
      <div className="flex justify-between items-center mb-6">
        <h1 className="text-2xl font-bold text-gray-800">Manage My Clubs</h1>
        <button onClick={handleOpenCreate} className="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 shadow">+ Add Club</button>
      </div>

      {/* --- FILTER BAR --- */}
      <div className="bg-white p-4 rounded-lg shadow mb-6 border border-gray-100">
        <div className="flex flex-wrap gap-4 items-end">
          <div className="flex-1 min-w-[200px]">
            <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Search</label>
            <input type="text" placeholder="Search clubs..." className="w-full border rounded p-2 text-sm bg-gray-50"
              value={searchParams.get('search') || ''}
              onChange={(e) => updateUrl('search', e.target.value)}
            />
          </div>
        </div>
      </div>

      {/* LIST */}
      <div className="bg-white rounded-lg shadow overflow-hidden mb-6">
        {isLoading ? <div className="p-8 text-center">Loading...</div> : (
          <table className="min-w-full divide-y divide-gray-200">
            <thead className="bg-gray-50">
              <tr>
                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Club</th>
                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Email</th>
                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Phone</th>
                <th className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">Actions</th>
              </tr>
            </thead>
            <tbody className="bg-white divide-y divide-gray-200">
              {clubs.map((club) => (
                <tr key={club.id}>
                  <td className="px-6 py-4 whitespace-nowrap">
                    <div className="flex items-center">
                      {club.avatar ? <img src={getMediaUrl(club.avatar) || ''} className="w-10 h-10 rounded-full object-cover mr-3" /> : <div className="w-10 h-10 bg-gray-200 rounded-full mr-3 flex items-center justify-center text-xs">C</div>}
                      <div className="text-sm font-bold">{club.name}</div>
                    </div>
                  </td>
                  <td className="px-6 py-4 whitespace-nowrap text-sm">{club.email}</td>
                  <td className="px-6 py-4 whitespace-nowrap text-sm">{club.phone}</td>
                  <td className="px-6 py-4 whitespace-nowrap text-right text-sm space-x-4">
                    <Link
                      href={`/admin/municipality/clubs/${club.id}`}
                      className="text-purple-600 hover:text-purple-800 font-bold"
                    >
                      View
                    </Link>
                    <button onClick={() => handleOpenEdit(club)} className="text-indigo-600 font-bold">Edit</button>
                    <button onClick={() => handleDeleteClick(club)} className="text-red-600 hover:text-red-900">Delete</button>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        )}
      </div>

      {/* MODAL (Simplified for Municipality Admin - No Municipality Dropdown) */}
      {showModal && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-xl shadow-2xl w-full max-w-5xl p-8 max-h-[90vh] overflow-y-auto">
            <h2 className="text-2xl font-bold mb-6 text-gray-800">{isEditing ? 'Edit Club' : 'New Club'}</h2>
            <form onSubmit={handleSubmit} className="space-y-6">
              <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                {/* Left Col */}
                <div className="space-y-4">
                  <div><label className="text-sm font-bold">Club Name</label><input required type="text" className="w-full border p-2 rounded" value={formData.name} onChange={e => setFormData({...formData, name: e.target.value})} /></div>
                  {/* Note: No Municipality Dropdown Here! */}
                  <div className="grid grid-cols-2 gap-2">
                    <input required type="email" placeholder="Email" className="border p-2 rounded" value={formData.email} onChange={e => setFormData({...formData, email: e.target.value})} />
                    <input required type="text" placeholder="Phone" className="border p-2 rounded" value={formData.phone} onChange={e => setFormData({...formData, phone: e.target.value})} />
                  </div>
                  <div><label className="text-sm font-bold">Description</label><textarea required rows={3} className="w-full border p-2 rounded" value={formData.description} onChange={e => setFormData({...formData, description: e.target.value})} /></div>
                  <div><label className="text-sm font-bold">Address</label><input type="text" className="w-full border p-2 rounded" value={formData.address} onChange={e => setFormData({...formData, address: e.target.value})} /></div>
                  <div className="grid grid-cols-2 gap-2">
                    <div><label className="text-sm font-bold">Latitude</label><input type="number" step="any" className="w-full border p-2 rounded" value={formData.latitude} onChange={e => setFormData({...formData, latitude: e.target.value})} /></div>
                    <div><label className="text-sm font-bold">Longitude</label><input type="number" step="any" className="w-full border p-2 rounded" value={formData.longitude} onChange={e => setFormData({...formData, longitude: e.target.value})} /></div>
                  </div>
                  <div><label className="text-sm font-bold">Categories</label><input type="text" className="w-full border p-2 rounded" value={formData.club_categories} onChange={e => setFormData({...formData, club_categories: e.target.value})} /></div>
                </div>
                
                {/* Right Col */}
                <div className="space-y-4">
                  <div className="grid grid-cols-2 gap-2 bg-gray-50 p-2 rounded">
                    <div><label className="text-xs font-bold uppercase">Avatar</label><input type="file" className="w-full text-xs" onChange={e => handleFileChange(e, 'avatar')} />{avatarPreview && <img src={avatarPreview} className="h-10 mt-1" />}</div>
                    <div><label className="text-xs font-bold uppercase">Hero</label><input type="file" className="w-full text-xs" onChange={e => handleFileChange(e, 'hero')} />{heroPreview && <img src={heroPreview} className="h-10 mt-1 rounded" />}</div>
                  </div>
                  <div><label className="text-sm font-bold">Terms & Conditions</label><textarea required rows={2} className="w-full border p-2 rounded text-sm" value={formData.terms_and_conditions} onChange={e => setFormData({...formData, terms_and_conditions: e.target.value})} /></div>
                  <div><label className="text-sm font-bold">Club Policies</label><textarea required rows={2} className="w-full border p-2 rounded text-sm" value={formData.club_policies} onChange={e => setFormData({...formData, club_policies: e.target.value})} /></div>
                </div>
              </div>

              {/* HOURS BUILDER (Identical to Super Admin) */}
              <div className="border-t pt-4 mt-4">
                <h3 className="text-lg font-bold text-gray-700 mb-4">Opening Hours</h3>
                <div className="bg-gray-50 p-3 rounded mb-4 border space-y-3">
                  <div className="flex flex-wrap gap-2">
                    <select className="border p-1 rounded text-sm w-32" value={newHour.weekday} onChange={e => setNewHour({...newHour, weekday: parseInt(e.target.value)})}>
                      {WEEKDAYS.map(d => <option key={d.id} value={d.id}>{d.name}</option>)}
                    </select>
                    <select className="border p-1 rounded text-sm w-32" value={newHour.week_cycle} onChange={e => setNewHour({...newHour, week_cycle: e.target.value})}>
                      {CYCLES.map(c => <option key={c.id} value={c.id}>{c.name}</option>)}
                    </select>
                    <input type="time" className="border p-1 rounded text-sm" value={newHour.open_time} onChange={e => setNewHour({...newHour, open_time: e.target.value})} />
                    <span>-</span>
                    <input type="time" className="border p-1 rounded text-sm" value={newHour.close_time} onChange={e => setNewHour({...newHour, close_time: e.target.value})} />
                  </div>
                  <div className="flex flex-wrap gap-2 items-center">
                    <select className="border p-1 rounded text-sm w-32 bg-white" value={newHour.restriction_mode} onChange={e => setNewHour({...newHour, restriction_mode: e.target.value})}>
                      <option value="NONE">No Restriction</option>
                      <option value="AGE">Age Range</option>
                      <option value="GRADE">Grade Range</option>
                    </select>
                    {newHour.restriction_mode !== 'NONE' && (
                      <div className="flex items-center gap-1">
                        <input type="number" placeholder="From" className="border p-1 rounded text-sm w-16" value={newHour.min_value} onChange={e => setNewHour({...newHour, min_value: e.target.value})} />
                        <span className="text-gray-500">-</span>
                        <input type="number" placeholder="To" className="border p-1 rounded text-sm w-16" value={newHour.max_value} onChange={e => setNewHour({...newHour, max_value: e.target.value})} />
                      </div>
                    )}
                    <select className="border p-1 rounded text-sm w-36 bg-white" value={newHour.gender_restriction} onChange={e => setNewHour({...newHour, gender_restriction: e.target.value})}>
                      {GENDER_RESTRICTIONS.map(g => <option key={g.id} value={g.id}>{g.name}</option>)}
                    </select>
                    <input type="text" placeholder="Title" className="border p-1 rounded text-sm flex-1" value={newHour.title} onChange={e => setNewHour({...newHour, title: e.target.value})} />
                    <button type="button" onClick={addHour} className="bg-green-600 text-white px-3 py-1 rounded text-sm hover:bg-green-700 ml-auto">+ Add</button>
                  </div>
                  {hourError && <p className="text-red-600 text-xs font-bold">{hourError}</p>}
                </div>

                <div className="space-y-2 max-h-60 overflow-y-auto">
                  {openingHours.map((hour, idx) => (
                    <div key={idx} className="flex justify-between items-center bg-white border p-2 rounded shadow-sm text-sm">
                       <div>
                         <span className="font-bold">{WEEKDAYS.find(d => d.id === hour.weekday)?.name}</span> 
                         <span className="mx-2 text-gray-400">|</span>
                         <span>{hour.open_time} - {hour.close_time}</span>
                       </div>
                       <button type="button" onClick={() => removeHour(idx)} className="text-red-500 font-bold">√ó</button>
                    </div>
                  ))}
                </div>
              </div>

              <div className="flex justify-end gap-4 pt-4 border-t">
                <button type="button" onClick={() => setShowModal(false)} className="text-gray-500">Cancel</button>
                <button type="submit" className="bg-purple-600 text-white px-6 py-2 rounded hover:bg-purple-700">{isEditing ? 'Save' : 'Create'}</button>
              </div>
            </form>
          </div>
        </div>
      )}

      {/* Delete Confirmation Modal */}
      <DeleteConfirmationModal
        isVisible={showDeleteModal}
        onClose={() => {
          if (!isDeleting) {
            setShowDeleteModal(false);
            setClubToDelete(null);
          }
        }}
        onConfirm={handleDeleteConfirm}
        itemName={clubToDelete?.name}
        isLoading={isDeleting}
      />

      <Toast message={toast.message} type={toast.type} isVisible={toast.isVisible} onClose={() => setToast({ ...toast, isVisible: false })} />
    </div>
  );
}

export default function ManageMuniClubsPage() {
  return <Suspense fallback={<div>Loading...</div>}><ManageMuniClubsPageContent /></Suspense>;
}
--- END OF FILE: ./frontend/app/admin/municipality/clubs/page.tsx ---


--- START OF FILE: ./frontend/app/admin/municipality/clubs/[id]/page.tsx ---
'use client';

import { useState, useEffect, Suspense } from 'react';
import { useRouter, useParams } from 'next/navigation';
import Link from 'next/link';
import { GoogleMap, Marker, LoadScript } from '@react-google-maps/api';
import api from '../../../../../lib/api';
import { getMediaUrl } from '../../../../utils';

const WEEKDAYS = [
  { id: 1, name: 'Monday' }, { id: 2, name: 'Tuesday' }, { id: 3, name: 'Wednesday' },
  { id: 4, name: 'Thursday' }, { id: 5, name: 'Friday' }, { id: 6, name: 'Saturday' }, { id: 7, name: 'Sunday' },
];

const CYCLES = [
  { id: 'ALL', name: 'Every Week' },
  { id: 'ODD', name: 'Odd Weeks' },
  { id: 'EVEN', name: 'Even Weeks' },
];

function ClubViewPageContent() {
  const router = useRouter();
  const params = useParams();
  const clubId = params?.id as string;

  const [club, setClub] = useState<any>(null);
  const [isLoading, setIsLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);

  useEffect(() => {
    if (clubId) {
      fetchClub();
    }
  }, [clubId]);

  const fetchClub = async () => {
    setIsLoading(true);
    setError(null);
    try {
      // The backend automatically checks if this club belongs to the municipality admin
      const res = await api.get(`/clubs/${clubId}/`);
      setClub(res.data);
    } catch (err: any) {
      setError(err?.response?.status === 404 ? 'Club not found or access denied' : 'Failed to load club');
      console.error(err);
    } finally {
      setIsLoading(false);
    }
  };

  if (isLoading) {
    return (
      <div className="p-8 text-center">
        <p className="text-gray-500">Loading club details...</p>
      </div>
    );
  }

  if (error || !club) {
    return (
      <div className="p-8">
        <div className="bg-red-50 border border-red-200 rounded-lg p-4 mb-4">
          <p className="text-red-800">{error || 'Club not found'}</p>
        </div>
        <Link href="/admin/municipality/clubs" className="text-purple-600 hover:text-purple-800">
          ‚Üê Back to Clubs
        </Link>
      </div>
    );
  }

  return (
    <div className="p-8">
      {/* HEADER */}
      <div className="flex items-center justify-between mb-6">
        <Link href="/admin/municipality/clubs" className="text-purple-600 hover:text-purple-800 font-medium">
          ‚Üê Back to My Clubs
        </Link>
        <div className="flex gap-4">
          <button
            onClick={() => router.push(`/admin/municipality/clubs?edit=${club.id}`)}
            className="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 shadow"
          >
            Edit Club
          </button>
        </div>
      </div>

      {/* CLUB HEADER */}
      <div className="bg-white rounded-xl shadow-lg overflow-hidden mb-6">
        <div className="relative">
          {club.hero_image && (
            <img
              src={getMediaUrl(club.hero_image) || ''}
              alt={club.name}
              className="w-full h-64 object-cover"
              onError={(e) => (e.target as HTMLImageElement).style.display = 'none'}
            />
          )}
          <div className={`p-8 ${club.hero_image ? 'absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/70 to-transparent' : ''}`}>
            <div className="flex items-end gap-6">
              {club.avatar && (
                <img
                  src={getMediaUrl(club.avatar) || ''}
                  alt={club.name}
                  className={`w-24 h-24 rounded-full object-cover border-4 ${club.hero_image ? 'border-white' : 'border-gray-200'}`}
                  onError={(e) => (e.target as HTMLImageElement).style.display = 'none'}
                />
              )}
              <div className={club.hero_image ? 'text-white' : ''}>
                <h1 className="text-4xl font-bold mb-2">{club.name}</h1>
                <p className="text-lg opacity-90">{club.municipality_name}</p>
                {club.address && (
                  <p className="text-sm opacity-80 mt-2">üìç {club.address}</p>
                )}
              </div>
            </div>
          </div>
        </div>
      </div>

      <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
        {/* MAIN CONTENT */}
        <div className="lg:col-span-2 space-y-6">
          {/* DESCRIPTION */}
          <div className="bg-white rounded-xl shadow p-6">
            <h2 className="text-2xl font-bold text-gray-800 mb-4">About</h2>
            <p className="text-gray-700 whitespace-pre-wrap">{club.description || 'No description provided.'}</p>
          </div>

          {/* CONTACT INFO */}
          <div className="bg-white rounded-xl shadow p-6">
            <h2 className="text-2xl font-bold text-gray-800 mb-4">Contact Information</h2>
            <div className="grid grid-cols-2 gap-4">
              <div>
                <p className="text-sm text-gray-500 font-bold uppercase">Email</p>
                <p className="font-medium">{club.email || '-'}</p>
              </div>
              <div>
                <p className="text-sm text-gray-500 font-bold uppercase">Phone</p>
                <p className="font-medium">{club.phone || '-'}</p>
              </div>
              {club.address && (
                <div className="col-span-2">
                  <p className="text-sm text-gray-500 font-bold uppercase">Address</p>
                  <p className="font-medium">{club.address}</p>
                </div>
              )}
              {(club.latitude && club.longitude) && (
                <div className="col-span-2">
                  <p className="text-sm text-gray-500 font-bold uppercase mb-2">Location</p>
                  <p className="text-sm text-gray-600 mb-2">Coordinates: {club.latitude}, {club.longitude}</p>
                  <a
                    href={`https://www.google.com/maps?q=${club.latitude},${club.longitude}`}
                    target="_blank"
                    rel="noopener noreferrer"
                    className="text-purple-600 hover:text-purple-800 underline text-sm mb-3 inline-block"
                  >
                    Open in Google Maps ‚Üí
                  </a>
                </div>
              )}
            </div>
          </div>

          {/* GOOGLE MAP */}
          {club.latitude && club.longitude && (
            <div className="bg-white rounded-xl shadow p-6">
              <h2 className="text-2xl font-bold text-gray-800 mb-4">Map Location</h2>
              {process.env.NEXT_PUBLIC_GOOGLE_MAPS_API_KEY ? (
                <div className="w-full h-96 rounded-lg overflow-hidden border border-gray-200">
                  <LoadScript googleMapsApiKey={process.env.NEXT_PUBLIC_GOOGLE_MAPS_API_KEY}>
                    <GoogleMap
                      mapContainerStyle={{ width: '100%', height: '100%' }}
                      center={{
                        lat: parseFloat(club.latitude),
                        lng: parseFloat(club.longitude)
                      }}
                      zoom={15}
                      options={{
                        zoomControl: true,
                        streetViewControl: true,
                        mapTypeControl: true,
                        fullscreenControl: true,
                      }}
                    >
                      <Marker
                        position={{
                          lat: parseFloat(club.latitude),
                          lng: parseFloat(club.longitude)
                        }}
                        title={club.name}
                      />
                    </GoogleMap>
                  </LoadScript>
                </div>
              ) : (
                <div className="w-full h-96 rounded-lg overflow-hidden border border-gray-200 bg-gray-100 flex items-center justify-center">
                  <div className="text-center p-4">
                    <p className="text-gray-600 mb-2">Google Maps API key not configured</p>
                    <p className="text-sm text-gray-500">Add NEXT_PUBLIC_GOOGLE_MAPS_API_KEY to your .env.local file</p>
                    <a
                      href={`https://www.google.com/maps?q=${club.latitude},${club.longitude}`}
                      target="_blank"
                      rel="noopener noreferrer"
                      className="text-purple-600 hover:text-purple-800 underline text-sm mt-2 inline-block"
                    >
                      Open in Google Maps instead ‚Üí
                    </a>
                  </div>
                </div>
              )}
            </div>
          )}

          {/* OPENING HOURS */}
          {club.regular_hours && club.regular_hours.length > 0 && (
            <div className="bg-white rounded-xl shadow p-6">
              <h2 className="text-2xl font-bold text-gray-800 mb-4">Opening Hours</h2>
              <div className="space-y-3">
                {club.regular_hours.map((hour: any, idx: number) => {
                  const dayName = WEEKDAYS.find(d => d.id === hour.weekday)?.name;
                  const cycleName = CYCLES.find(c => c.id === hour.week_cycle)?.name;
                  const timeStr = `${hour.open_time.substring(0,5)} - ${hour.close_time.substring(0,5)}`;
                  
                  return (
                    <div key={idx} className="border rounded-lg p-4 hover:bg-gray-50 transition">
                      <div className="flex justify-between items-start">
                        <div className="flex-1">
                          <div className="flex items-center gap-3 mb-2">
                            <span className="font-bold text-gray-900 w-28">{dayName}</span>
                            <span className="text-xs text-gray-500 uppercase bg-gray-100 px-2 py-1 rounded">{cycleName}</span>
                            <span className="text-gray-700 font-medium">{timeStr}</span>
                          </div>
                          {hour.title && (
                            <p className="text-sm text-gray-600 italic ml-28">{hour.title}</p>
                          )}
                        </div>
                        <div className="flex gap-2 items-center">
                          {hour.restriction_mode !== 'NONE' && hour.min_value && hour.max_value && (
                            <span className="bg-yellow-100 text-yellow-800 px-2 py-1 rounded text-xs font-bold">
                              {hour.restriction_mode === 'AGE' ? 'Age' : 'Grade'} {hour.min_value}-{hour.max_value}
                            </span>
                          )}
                          {hour.gender_restriction !== 'ALL' && (
                            <span className="bg-purple-100 text-purple-800 px-2 py-1 rounded text-xs font-bold">
                              {hour.gender_restriction}
                            </span>
                          )}
                        </div>
                      </div>
                    </div>
                  );
                })}
              </div>
            </div>
          )}

          {/* LEGAL DOCUMENTS */}
          {(club.terms_and_conditions || club.club_policies) && (
            <div className="bg-white rounded-xl shadow p-6">
              <h2 className="text-2xl font-bold text-gray-800 mb-4">Legal Documents</h2>
              <div className="space-y-4">
                {club.terms_and_conditions && (
                  <div>
                    <h3 className="text-lg font-bold text-gray-700 mb-2">Terms & Conditions</h3>
                    <p className="text-sm text-gray-600 whitespace-pre-wrap">{club.terms_and_conditions}</p>
                  </div>
                )}
                {club.club_policies && (
                  <div>
                    <h3 className="text-lg font-bold text-gray-700 mb-2">Club Policies</h3>
                    <p className="text-sm text-gray-600 whitespace-pre-wrap">{club.club_policies}</p>
                  </div>
                )}
              </div>
            </div>
          )}
        </div>

        {/* SIDEBAR */}
        <div className="space-y-6">
          {/* QUICK INFO */}
          <div className="bg-white rounded-xl shadow p-6">
            <h3 className="text-lg font-bold text-gray-800 mb-4">Quick Info</h3>
            <div className="space-y-3">
              {club.club_categories && (
                <div>
                  <p className="text-xs text-gray-500 font-bold uppercase">Categories</p>
                  <p className="text-sm font-medium">{club.club_categories}</p>
                </div>
              )}
              {club.allowed_age_groups && (
                <div>
                  <p className="text-xs text-gray-500 font-bold uppercase">Age Groups</p>
                  <p className="text-sm font-medium">{club.allowed_age_groups}</p>
                </div>
              )}
            </div>
          </div>

          {/* ACTIONS */}
          <div className="bg-white rounded-xl shadow p-6">
            <h3 className="text-lg font-bold text-gray-800 mb-4">Actions</h3>
            <div className="space-y-2">
              <button
                onClick={() => router.push(`/admin/municipality/clubs?edit=${club.id}`)}
                className="w-full bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 text-center"
              >
                Edit Club
              </button>
              <Link
                href="/admin/municipality/clubs"
                className="block w-full bg-gray-100 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-200 text-center"
              >
                Back to List
              </Link>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
}

export default function ClubViewPage() {
  return (
    <Suspense fallback={<div className="p-8 text-center">Loading...</div>}>
      <ClubViewPageContent />
    </Suspense>
  );
}
--- END OF FILE: ./frontend/app/admin/municipality/clubs/[id]/page.tsx ---


--- START OF FILE: ./frontend/app/admin/municipality/rewards/page.tsx ---
'use client';

import RewardManager from '../../../components/RewardManager';

export default function MunicipalityRewardsPage() {
  return (
    <div className="max-w-7xl mx-auto p-4">
      {/* The component handles fetching only municipality-specific rewards automatically */}
      <RewardManager basePath="/admin/municipality/rewards" />
    </div>
  );
}
--- END OF FILE: ./frontend/app/admin/municipality/rewards/page.tsx ---


--- START OF FILE: ./frontend/app/admin/municipality/rewards/edit/[id]/page.tsx ---
'use client';

import { useState, useEffect } from 'react';
import { useParams } from 'next/navigation';
import api from '@/lib/api'; 
import RewardForm from '@/app/components/RewardForm';

export default function EditRewardPage() {
  const params = useParams();
  const id = params?.id as string;
  
  const [reward, setReward] = useState(null);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    if (id) {
      api.get(`/rewards/${id}/`)
        .then(res => {
          setReward(res.data);
          setLoading(false);
        })
        .catch(err => {
          console.error(err);
          setLoading(false);
        });
    }
  }, [id]);

  if (loading) return <div className="p-12 text-center text-gray-500">Loading...</div>;
  if (!reward) return <div className="p-12 text-center text-red-500">Reward not found.</div>;

  return (
    <div className="max-w-5xl mx-auto p-4">
      <div className="mb-8">
        <h1 className="text-3xl font-bold text-gray-900">Edit Reward</h1>
      </div>
      
      <RewardForm 
        initialData={reward} 
        redirectPath="/admin/municipality/rewards" 
      />
    </div>
  );
}
--- END OF FILE: ./frontend/app/admin/municipality/rewards/edit/[id]/page.tsx ---


--- START OF FILE: ./frontend/app/admin/municipality/rewards/[id]/page.tsx ---
'use client';

import { useParams } from 'next/navigation';
import RewardDetailView from '@/app/components/RewardDetailView';

export default function RewardDetailPage() {
  const params = useParams();
  const id = params?.id as string;

  return (
    <div className="max-w-7xl mx-auto p-4">
      <RewardDetailView 
        rewardId={id} 
        basePath="/admin/municipality/rewards" 
      />
    </div>
  );
}
--- END OF FILE: ./frontend/app/admin/municipality/rewards/[id]/page.tsx ---


--- START OF FILE: ./frontend/app/admin/municipality/rewards/create/page.tsx ---
'use client';

import RewardForm from '../../../../components/RewardForm';

export default function CreateRewardPage() {
  return (
    <div className="max-w-5xl mx-auto p-4">
      <div className="mb-8">
        <h1 className="text-3xl font-bold text-gray-900">Create Municipality Reward</h1>
        <p className="text-gray-500">
          This reward will be owned by your municipality.
        </p>
      </div>
      
      <RewardForm redirectPath="/admin/municipality/rewards" />
    </div>
  );
}
--- END OF FILE: ./frontend/app/admin/municipality/rewards/create/page.tsx ---


--- START OF FILE: ./frontend/app/admin/municipality/admins/page.tsx ---
'use client';

import { useState, useEffect, Suspense } from 'react';
import { useRouter, useSearchParams, usePathname } from 'next/navigation';
import api from '../../../../lib/api';
import { getMediaUrl } from '../../../utils';
import Toast from '../../../components/Toast';
import { useAuth } from '../../../../context/AuthContext';
import DeleteConfirmationModal from '../../../components/DeleteConfirmationModal';

interface Option { id: number; name: string; }

function ManageMuniAdminsPageContent() {
  const router = useRouter();
  const pathname = usePathname();
  const searchParams = useSearchParams();
  const { user: currentUser } = useAuth();

  // --- STATE ---
  const [users, setUsers] = useState<any[]>([]);
  const [totalCount, setTotalCount] = useState(0); 
  const [isLoading, setIsLoading] = useState(true);
  const [clubs, setClubs] = useState<Option[]>([]);
  
  const [toast, setToast] = useState<{ message: string; type: 'success' | 'error' | 'info' | 'warning'; isVisible: boolean }>({
    message: '', type: 'success', isVisible: false,
  });

  // Modal & Form State
  const [showModal, setShowModal] = useState(false);
  const [isEditing, setIsEditing] = useState(false);
  const [editUserId, setEditUserId] = useState<number | null>(null);
  
  // Delete Confirmation Modal State
  const [showDeleteModal, setShowDeleteModal] = useState(false);
  const [userToDelete, setUserToDelete] = useState<{ id: number; name: string } | null>(null);
  const [isDeleting, setIsDeleting] = useState(false);

  const initialFormState = {
    email: '', password: '', first_name: '', last_name: '', nickname: '',
    legal_gender: 'MALE', phone_number: '', profession: '',
    assigned_club: '', hide_contact_info: false
  };

  const [formData, setFormData] = useState(initialFormState);
  // Default to Club Admin (most common action)
  const [adminType, setAdminType] = useState('CLUB_ADMIN');
  const [avatarFile, setAvatarFile] = useState<File | null>(null);
  const [avatarPreview, setAvatarPreview] = useState<string | null>(null);

  // --- INITIAL DATA LOAD ---
  useEffect(() => {
    fetchClubs();
  }, []);

  useEffect(() => {
    fetchAdmins();
  }, [searchParams]);

  const fetchClubs = async () => {
    try {
      // API automatically filters clubs for this municipality
      const res = await api.get('/clubs/');
      const data = Array.isArray(res.data) ? res.data : (res.data.results || []);
      setClubs(data);
    } catch (err) {
      console.error(err);
    }
  };

  const fetchAdmins = async () => {
    setIsLoading(true);
    try {
      const params = new URLSearchParams(searchParams.toString());
      
      // If no role selected, fetch both valid roles for this view
      if (!params.get('role')) {
          // We handle this by fetching all and filtering on client side or making 2 requests.
          // Since backend scopes data, we can just ask for users and filter out Youth/Guardians visually or via API logic.
          // A cleaner way for the UI:
          const adminRoles = ['MUNICIPALITY_ADMIN', 'CLUB_ADMIN'];
          
          // We fetch all, the backend already excludes Super Admins and other munis
          const res = await api.get(`/users/?${params.toString()}`);
          
          let allUsers = res.data.results || [];
          // Filter to only show Admins (exclude Youth/Guardian if they appear)
          allUsers = allUsers.filter((u: any) => adminRoles.includes(u.role));
          
          setUsers(allUsers);
          setTotalCount(allUsers.length);
      } else {
          // Role specifically requested
          const res = await api.get(`/users/?${params.toString()}`);
          setUsers(res.data.results || []);
          setTotalCount(res.data.count);
      }
    } catch (err) {
      console.error(err);
    } finally {
      setIsLoading(false);
    }
  };

  const updateUrl = (key: string, value: string) => {
    const params = new URLSearchParams(searchParams.toString());
    if (value) params.set(key, value); else params.delete(key);
    if (key !== 'page') params.set('page', '1');
    router.push(`${pathname}?${params.toString()}`);
  };

  // --- ACTIONS ---

  const handleOpenCreate = () => {
    setIsEditing(false);
    setEditUserId(null);
    setFormData(initialFormState);
    setAdminType('CLUB_ADMIN');
    setAvatarFile(null);
    setAvatarPreview(null);
    setShowModal(true);
  };

  const handleOpenEdit = (user: any) => {
    setIsEditing(true);
    setEditUserId(user.id);
    setAdminType(user.role);
    setFormData({
      email: user.email, password: '', 
      first_name: user.first_name || '', last_name: user.last_name || '',
      nickname: user.nickname || '', legal_gender: user.legal_gender || 'MALE',
      phone_number: user.phone_number || '', profession: user.profession || '',
      assigned_club: user.assigned_club || '',
      hide_contact_info: user.hide_contact_info || false
    });
    setAvatarFile(null);
    setAvatarPreview(user.avatar ? getMediaUrl(user.avatar) : null);
    setShowModal(true);
  };

  const handleDeleteClick = (user: any) => {
    // Prevent admins from deleting themselves
    if (currentUser && currentUser.id === user.id) {
      setToast({ 
        message: 'You cannot delete your own account.', 
        type: 'warning', 
        isVisible: true 
      });
      return;
    }

    setUserToDelete({ id: user.id, name: `${user.first_name} ${user.last_name}` });
    setShowDeleteModal(true);
  };

  const handleDeleteConfirm = async () => {
    if (!userToDelete) return;

    setIsDeleting(true);
    try {
      await api.delete(`/users/${userToDelete.id}/`);
      setToast({ message: 'User deleted.', type: 'success', isVisible: true });
      setShowDeleteModal(false);
      setUserToDelete(null);
      fetchAdmins();
    } catch (err) { 
      setToast({ message: 'Failed to delete.', type: 'error', isVisible: true });
    } finally {
      setIsDeleting(false);
    }
  };

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    try {
      const data = new FormData();
      Object.entries(formData).forEach(([key, value]) => {
        if (key === 'password' && !value) return; 
        data.append(key, value.toString());
      });
      data.append('role', adminType);
      
      // Backend automatically assigns municipality
      
      if (avatarFile) data.append('avatar', avatarFile);

      const config = { headers: { 'Content-Type': 'multipart/form-data' } };
      if (isEditing && editUserId) await api.patch(`/users/${editUserId}/`, data, config);
      else await api.post('/users/', data, config);

      setShowModal(false);
      setToast({ message: isEditing ? 'Updated successfully!' : 'Created successfully!', type: 'success', isVisible: true });
      fetchAdmins();
    } catch (err) { 
      setToast({ message: 'Operation failed.', type: 'error', isVisible: true });
    }
  };

  const handleAvatarChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (file) {
      setAvatarFile(file);
      const reader = new FileReader();
      reader.onloadend = () => setAvatarPreview(reader.result as string);
      reader.readAsDataURL(file);
    }
  };

  const currentPage = Number(searchParams.get('page')) || 1;
  const totalPages = Math.ceil(totalCount / 10);

  return (
    <div>
      <div className="flex justify-between items-center mb-6">
        <h1 className="text-2xl font-bold text-gray-800">Manage Staff</h1>
        <button onClick={handleOpenCreate} className="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 shadow">
          + Create New Staff
        </button>
      </div>

      {/* --- FILTER BAR --- */}
      <div className="bg-white p-4 rounded-lg shadow mb-6 border border-gray-100">
        <div className="flex flex-wrap gap-4 items-end">
          <div className="flex-1 min-w-[200px]">
            <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Search</label>
            <input
              type="text"
              placeholder="Search name or email..."
              className="w-full border rounded p-2 text-sm bg-gray-50"
              value={searchParams.get('search') || ''}
              onChange={(e) => updateUrl('search', e.target.value)}
            />
          </div>

          <div className="w-48">
            <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Role</label>
            <select className="w-full border rounded p-2 text-sm bg-gray-50" value={searchParams.get('role') || ''} onChange={(e) => updateUrl('role', e.target.value)}>
              <option value="">All Roles</option>
              <option value="MUNICIPALITY_ADMIN">Municipality Admin</option>
              <option value="CLUB_ADMIN">Club Admin</option>
            </select>
          </div>

          <div className="w-48">
            <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Club</label>
            <select className="w-full border rounded p-2 text-sm bg-gray-50" value={searchParams.get('assigned_club') || ''} onChange={(e) => updateUrl('assigned_club', e.target.value)}>
              <option value="">All Clubs</option>
              {clubs.map(c => <option key={c.id} value={c.id.toString()}>{c.name}</option>)}
            </select>
          </div>

          <button onClick={() => router.push(pathname)} className="px-4 py-2 text-sm text-gray-500 hover:text-red-500 font-medium pb-2.5">
            Clear Filters
          </button>
        </div>
      </div>

      {/* --- LIST --- */}
      <div className="bg-white rounded-lg shadow overflow-hidden mb-6">
        {isLoading ? (
          <div className="p-8 text-center text-gray-500">Loading staff...</div>
        ) : users.length === 0 ? (
          <div className="p-8 text-center text-gray-500">No staff found.</div>
        ) : (
          <table className="min-w-full divide-y divide-gray-200">
            <thead className="bg-gray-50">
              <tr>
                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">User</th>
                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Role</th>
                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Assignment</th>
                <th className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">Actions</th>
              </tr>
            </thead>
            <tbody className="bg-white divide-y divide-gray-200">
              {users.map((user) => (
                <tr key={user.id}>
                  <td className="px-6 py-4 whitespace-nowrap">
                    <div className="flex items-center">
                      {user.avatar ? (
                        <img src={getMediaUrl(user.avatar) || ''} className="w-10 h-10 rounded-full object-cover mr-3" />
                      ) : (
                        <div className="w-10 h-10 rounded-full bg-gray-200 flex items-center justify-center text-gray-600 text-sm font-bold mr-3">
                           {user.first_name?.[0]}{user.last_name?.[0]}
                        </div>
                      )}
                      <div>
                        <div className="text-sm font-medium text-gray-900">{user.first_name} {user.last_name}</div>
                        <div className="text-sm text-gray-500">{user.email}</div>
                      </div>
                    </div>
                  </td>
                  <td className="px-6 py-4 whitespace-nowrap">
                    <span className={`px-2 inline-flex text-xs leading-5 font-semibold rounded-full 
                      ${user.role === 'MUNICIPALITY_ADMIN' ? 'bg-purple-100 text-purple-800' : 'bg-green-100 text-green-800'}`}>
                      {user.role.replace('_', ' ')}
                    </span>
                  </td>
                  <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                    {user.role === 'CLUB_ADMIN' && (
                       clubs.find(c => c.id === user.assigned_club)?.name || 'Unassigned'
                    )}
                    {user.role === 'MUNICIPALITY_ADMIN' && 'Municipality'}
                  </td>
                  <td className="px-6 py-4 whitespace-nowrap text-right text-sm font-medium space-x-4">
                    <button onClick={() => handleOpenEdit(user)} className="text-indigo-600 hover:text-indigo-900 font-bold">Edit</button>
                    <button onClick={() => handleDeleteClick(user)} className="text-red-600 hover:text-red-900">Delete</button>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        )}
      </div>

      {/* --- PAGINATION --- */}
      <div className="flex items-center justify-between border-t border-gray-200 bg-white px-4 py-3 sm:px-6 rounded-lg shadow">
        {/* (Standard Pagination Code reused from other pages) */}
        <div className="flex-1 flex justify-between sm:hidden">
             <button disabled={currentPage === 1} onClick={() => updateUrl('page', (currentPage - 1).toString())} className="relative inline-flex items-center rounded-md border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50 disabled:opacity-50">Previous</button>
             <button disabled={currentPage >= totalPages} onClick={() => updateUrl('page', (currentPage + 1).toString())} className="relative ml-3 inline-flex items-center rounded-md border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50 disabled:opacity-50">Next</button>
        </div>
        <div className="hidden sm:flex sm:flex-1 sm:items-center sm:justify-between">
            <div><p className="text-sm text-gray-700">Page {currentPage} of {totalPages}</p></div>
            <div>
                <nav className="isolate inline-flex -space-x-px rounded-md shadow-sm">
                    <button disabled={currentPage === 1} onClick={() => updateUrl('page', (currentPage - 1).toString())} className="relative inline-flex items-center rounded-l-md px-2 py-2 text-gray-400 ring-1 ring-inset ring-gray-300 hover:bg-gray-50 disabled:opacity-50">Prev</button>
                    <button disabled={currentPage >= totalPages} onClick={() => updateUrl('page', (currentPage + 1).toString())} className="relative inline-flex items-center rounded-r-md px-2 py-2 text-gray-400 ring-1 ring-inset ring-gray-300 hover:bg-gray-50 disabled:opacity-50">Next</button>
                </nav>
            </div>
        </div>
      </div>

      {/* --- MODAL --- */}
      {showModal && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-xl shadow-2xl w-full max-w-2xl p-8 max-h-[90vh] overflow-y-auto">
            <h2 className="text-2xl font-bold mb-6 text-gray-800">{isEditing ? 'Edit Staff' : 'Create New Staff'}</h2>
            <form onSubmit={handleSubmit} className="space-y-6">
              
              {/* ROLE TYPE (Restricted) */}
              <div className="grid grid-cols-2 gap-4">
                {['MUNICIPALITY_ADMIN', 'CLUB_ADMIN'].map((role) => (
                  <button key={role} type="button" 
                    onClick={() => !isEditing && setAdminType(role)}
                    className={`py-3 px-2 rounded-lg text-sm font-bold border-2 transition
                      ${adminType === role ? 'border-purple-600 bg-purple-50 text-purple-700' : 'border-gray-200 text-gray-600'}
                      ${isEditing && adminType !== role ? 'opacity-50 cursor-not-allowed' : ''}
                    `}>
                    {role.replace('_', ' ')}
                  </button>
                ))}
              </div>

              {/* FIELDS */}
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <input required type="text" placeholder="First Name" className="border p-2 rounded" value={formData.first_name} onChange={e => setFormData({...formData, first_name: e.target.value})} />
                <input required type="text" placeholder="Last Name" className="border p-2 rounded" value={formData.last_name} onChange={e => setFormData({...formData, last_name: e.target.value})} />
                <input type="text" placeholder="Nickname" className="border p-2 rounded" value={formData.nickname} onChange={e => setFormData({...formData, nickname: e.target.value})} />
                <select className="border p-2 rounded" value={formData.legal_gender} onChange={e => setFormData({...formData, legal_gender: e.target.value})}>
                  <option value="MALE">Male</option> <option value="FEMALE">Female</option> <option value="OTHER">Other</option>
                </select>
                <input required type="email" placeholder="Email" className="border p-2 rounded" value={formData.email} onChange={e => setFormData({...formData, email: e.target.value})} />
                <input type="password" placeholder={isEditing ? "New Password" : "Password"} className="border p-2 rounded" required={!isEditing} value={formData.password} onChange={e => setFormData({...formData, password: e.target.value})} />
                <input type="text" placeholder="Phone" className="border p-2 rounded" value={formData.phone_number} onChange={e => setFormData({...formData, phone_number: e.target.value})} />
                {adminType === 'CLUB_ADMIN' && <input type="text" placeholder="Profession" className="border p-2 rounded" value={formData.profession} onChange={e => setFormData({...formData, profession: e.target.value})} />}
              </div>

              {/* AVATAR */}
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">Avatar</label>
                <input type="file" accept="image/*" className="w-full border p-2 rounded" onChange={handleAvatarChange} />
                {avatarPreview && <img src={avatarPreview} alt="Preview" className="w-16 h-16 mt-2 rounded-full object-cover border" />}
              </div>

              {/* ASSIGNMENT (Restricted: Only Club selection if applicable) */}
              {adminType === 'CLUB_ADMIN' && (
                <div className="bg-gray-50 p-4 rounded-lg border">
                  <label className="block text-sm font-bold mb-1 text-gray-700">Assign Club</label>
                  <select className="w-full border p-2 rounded" value={formData.assigned_club} onChange={e => setFormData({...formData, assigned_club: e.target.value})} required>
                    <option value="">Select Club...</option>
                    {clubs.map(c => <option key={c.id} value={c.id.toString()}>{c.name}</option>)}
                  </select>
                </div>
              )}

              <div className="flex items-center gap-2">
                <input type="checkbox" id="hideContact" checked={formData.hide_contact_info} onChange={e => setFormData({...formData, hide_contact_info: e.target.checked})} />
                <label htmlFor="hideContact" className="text-sm text-gray-700">Hide Contact Info</label>
              </div>

              <div className="flex justify-end gap-4 pt-4 border-t">
                <button type="button" onClick={() => setShowModal(false)} className="text-gray-500">Cancel</button>
                <button type="submit" className="bg-purple-600 text-white px-6 py-2 rounded hover:bg-purple-700">
                  {isEditing ? 'Save' : 'Create'}
                </button>
              </div>
            </form>
          </div>
        </div>
      )}

      {/* Delete Confirmation Modal */}
      <DeleteConfirmationModal
        isVisible={showDeleteModal}
        onClose={() => {
          if (!isDeleting) {
            setShowDeleteModal(false);
            setUserToDelete(null);
          }
        }}
        onConfirm={handleDeleteConfirm}
        itemName={userToDelete?.name}
        isLoading={isDeleting}
      />

      <Toast message={toast.message} type={toast.type} isVisible={toast.isVisible} onClose={() => setToast({ ...toast, isVisible: false })} />
    </div>
  );
}

export default function ManageMuniAdminsPage() {
  return (
    <Suspense fallback={<div className="p-8 text-center">Loading...</div>}>
      <ManageMuniAdminsPageContent />
    </Suspense>
  );
}
--- END OF FILE: ./frontend/app/admin/municipality/admins/page.tsx ---


--- START OF FILE: ./frontend/app/admin/municipality/groups/page.tsx ---
'use client';
import GroupManager from '../../../components/GroupManager';
export default function Page() { return <div className="p-8"><GroupManager basePath="/admin/municipality/groups" /></div>; }
--- END OF FILE: ./frontend/app/admin/municipality/groups/page.tsx ---


--- START OF FILE: ./frontend/app/admin/municipality/groups/requests/page.tsx ---
'use client';
import GroupRequestsManager from '../../../../components/GroupRequestsManager';
export default function Page() { return <div className="p-8 max-w-6xl mx-auto"><GroupRequestsManager /></div>; }
--- END OF FILE: ./frontend/app/admin/municipality/groups/requests/page.tsx ---


--- START OF FILE: ./frontend/app/admin/municipality/groups/edit/[id]/page.tsx ---
'use client';

import { useState, useEffect } from 'react';
import { useParams } from 'next/navigation';
import api from '@/lib/api'; 
import GroupForm from '@/app/components/GroupForm';

export default function EditGroupPage() {
  const params = useParams();
  const id = params?.id as string;
  
  const [group, setGroup] = useState(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState('');

  useEffect(() => {
    if (id) {
      const fetchGroup = async () => {
        try {
          const res = await api.get(`/groups/${id}/`);
          setGroup(res.data);
        } catch (err) {
          console.error(err);
          setError('Failed to load group data.');
        } finally {
          setLoading(false);
        }
      };
      fetchGroup();
    }
  }, [id]);

  if (loading) return <div className="p-12 text-center text-gray-500">Loading group settings...</div>;
  if (error || !group) return <div className="p-12 text-center text-red-500">{error || 'Group not found'}</div>;

  return (
    <div className="max-w-4xl mx-auto p-4">
      <div className="mb-8">
        <h1 className="text-2xl font-bold text-gray-900">Edit Group</h1>
        <p className="text-gray-500">Update membership rules and settings.</p>
      </div>
      
      <GroupForm 
        initialData={group} 
        redirectPath="/admin/super/groups" 
      />
    </div>
  );
}
--- END OF FILE: ./frontend/app/admin/municipality/groups/edit/[id]/page.tsx ---


--- START OF FILE: ./frontend/app/admin/municipality/groups/[id]/page.tsx ---
'use client';
import { useParams } from 'next/navigation';
import GroupDetailView from '../../../../components/GroupDetailView';
export default function Page() { 
  const { id } = useParams() as { id: string };
  return <div className="p-8"><GroupDetailView groupId={id} basePath="/admin/municipality/groups" /></div>; 
}
--- END OF FILE: ./frontend/app/admin/municipality/groups/[id]/page.tsx ---


--- START OF FILE: ./frontend/app/admin/municipality/groups/create/page.tsx ---
'use client';
import GroupForm from '../../../../components/GroupForm';
export default function Page() { 
  return <div className="p-8"><h1 className="text-2xl font-bold mb-6">New Municipality Group</h1><GroupForm redirectPath="/admin/municipality/groups" /></div>; 
}
--- END OF FILE: ./frontend/app/admin/municipality/groups/create/page.tsx ---


--- START OF FILE: ./frontend/app/admin/municipality/msgboard/page.tsx ---
'use client';

import { useEffect, useState, Suspense } from 'react';
import api from '../../../../lib/api';
import Toast from '../../../components/Toast';
import { useAuth } from '../../../../context/AuthContext';
import DeleteConfirmationModal from '../../../components/DeleteConfirmationModal';

interface SystemMessage {
  id: number;
  title: string;
  message: string;
  message_type: 'INFO' | 'IMPORTANT' | 'WARNING';
  created_at: string;
  expires_at: string;
  is_sticky: boolean;
  external_link?: string | null;
}

const MESSAGE_STYLES: Record<SystemMessage['message_type'], { badge: string; border: string }> = {
  INFO: {
    badge: 'bg-blue-100 text-blue-800',
    border: 'border-blue-200',
  },
  IMPORTANT: {
    badge: 'bg-orange-100 text-orange-800',
    border: 'border-orange-200',
  },
  WARNING: {
    badge: 'bg-red-100 text-red-800',
    border: 'border-red-200',
  },
};

const formatDate = (value: string) =>
  new Date(value).toLocaleString(undefined, {
    year: 'numeric',
    month: 'short',
    day: 'numeric',
    hour: '2-digit',
    minute: '2-digit',
  });

function MunicipalityMessageBoardContent() {
  const [messages, setMessages] = useState<SystemMessage[]>([]);
  const [loading, setLoading] = useState(true);
  const [toast, setToast] = useState<{ message: string; type: 'success' | 'error'; isVisible: boolean }>({
    message: '',
    type: 'success',
    isVisible: false,
  });
  const { refreshMessageCount } = useAuth();
  
  // Hide Confirmation Modal State
  const [showHideModal, setShowHideModal] = useState(false);
  const [messageToHide, setMessageToHide] = useState<{ id: number; title: string } | null>(null);
  const [isHiding, setIsHiding] = useState(false);

  const fetchMessages = async () => {
    setLoading(true);
    try {
      const res = await api.get('/messages/active_list/');
      const list: SystemMessage[] = Array.isArray(res.data) ? res.data : [];
      list.sort((a, b) => new Date(b.created_at).getTime() - new Date(a.created_at).getTime());
      setMessages(list);
      refreshMessageCount();
    } catch (err) {
      console.error(err);
      setToast({ message: 'Failed to load messages.', type: 'error', isVisible: true });
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => {
    fetchMessages();
  }, []);

  const handleHideClick = (msg: SystemMessage) => {
    if (msg.is_sticky) return;
    setMessageToHide({ id: msg.id, title: msg.title });
    setShowHideModal(true);
  };

  const handleHideConfirm = async () => {
    if (!messageToHide) return;

    setIsHiding(true);
    try {
      await api.post(`/messages/${messageToHide.id}/dismiss/`);
      setToast({ message: 'Message hidden.', type: 'success', isVisible: true });
      setShowHideModal(false);
      setMessageToHide(null);
      fetchMessages();
    } catch (err) {
      console.error(err);
      setToast({ message: 'Failed to hide message.', type: 'error', isVisible: true });
    } finally {
      setIsHiding(false);
    }
  };

  return (
    <div className="space-y-6">
      <div className="flex flex-wrap justify-between items-center gap-4">
        <div>
          <p className="text-sm text-purple-500 uppercase font-semibold tracking-wide">Municipality Admin</p>
          <h1 className="text-3xl font-bold text-gray-900">Internal Message Board</h1>
          <p className="text-gray-600">All active notices targeted to your role appear here.</p>
        </div>
        <button
          onClick={fetchMessages}
          className="px-4 py-2 rounded-lg border border-purple-200 text-sm text-purple-700 hover:bg-purple-50"
        >
          Refresh
        </button>
      </div>

      {loading ? (
        <div className="bg-white rounded-xl shadow p-6 text-center text-gray-500">Loading messages‚Ä¶</div>
      ) : messages.length === 0 ? (
        <div className="bg-white rounded-xl shadow p-8 text-center text-gray-500">
          No active messages for your role right now.
        </div>
      ) : (
        <div className="space-y-4">
          {messages.map((msg) => {
            const styles = MESSAGE_STYLES[msg.message_type] || MESSAGE_STYLES.INFO;
            return (
              <div
                key={msg.id}
                className={`bg-white border ${styles.border} rounded-xl shadow-sm p-5 flex flex-col gap-3`}
              >
                <div className="flex flex-wrap justify-between items-start gap-3">
                  <div>
                    <div className="flex items-center gap-2">
                      <span className={`text-xs font-semibold px-2 py-1 rounded-full ${styles.badge}`}>
                        {msg.message_type}
                      </span>
                      {msg.is_sticky && (
                        <span className="text-[11px] uppercase tracking-wide text-red-500 font-semibold">
                          Sticky
                        </span>
                      )}
                    </div>
                    <h2 className="text-lg font-semibold text-gray-900 mt-1">{msg.title}</h2>
                  </div>
                  <div className="text-right text-xs text-gray-500">
                    <div>Created: {formatDate(msg.created_at)}</div>
                    <div>Expires: {formatDate(msg.expires_at)}</div>
                  </div>
                </div>

                <p className="text-gray-700 whitespace-pre-line">{msg.message}</p>

                {msg.external_link && (
                  <a
                    href={msg.external_link}
                    target="_blank"
                    rel="noopener noreferrer"
                    className="text-sm text-purple-600 font-semibold hover:underline"
                  >
                    View more ‚Üó
                  </a>
                )}

                <div className="flex justify-end gap-3 text-sm">
                  <button
                    onClick={() => handleHideClick(msg)}
                    disabled={msg.is_sticky}
                    className={`px-4 py-2 rounded-lg border text-sm font-semibold transition ${
                      msg.is_sticky
                        ? 'border-gray-200 text-gray-400 cursor-not-allowed'
                        : 'border-red-200 text-red-600 hover:bg-red-50'
                    }`}
                  >
                    Hide
                  </button>
                </div>
              </div>
            );
          })}
        </div>
      )}

      {/* Hide Confirmation Modal */}
      <DeleteConfirmationModal
        isVisible={showHideModal}
        onClose={() => {
          if (!isHiding) {
            setShowHideModal(false);
            setMessageToHide(null);
          }
        }}
        onConfirm={handleHideConfirm}
        title="Hide Message"
        itemName={messageToHide?.title}
        message={messageToHide ? `Are you sure you want to hide "${messageToHide.title}"? You can refresh the page to see it again.` : undefined}
        confirmButtonText="Hide"
        isLoading={isHiding}
      />

      <Toast
        message={toast.message}
        type={toast.type}
        isVisible={toast.isVisible}
        onClose={() => setToast({ ...toast, isVisible: false })}
      />
    </div>
  );
}

export default function MunicipalityMessageBoardPage() {
  return (
    <Suspense fallback={<div className="p-8 text-center text-gray-500">Loading message board‚Ä¶</div>}>
      <MunicipalityMessageBoardContent />
    </Suspense>
  );
}

--- END OF FILE: ./frontend/app/admin/municipality/msgboard/page.tsx ---


--- START OF FILE: ./frontend/app/admin/municipality/youth/page.tsx ---
'use client';

import { useState, useEffect, Suspense } from 'react';
import { useRouter, useSearchParams, usePathname } from 'next/navigation';
import Link from 'next/link';
import api from '../../../../lib/api';
import { useAuth } from '../../../../context/AuthContext';
import { getMediaUrl } from '../../../utils';
import Toast from '../../../components/Toast';
import DeleteConfirmationModal from '../../../components/DeleteConfirmationModal';
import CustomFieldsForm from '../../../components/CustomFieldsForm';

interface Option { id: number; name: string; }
interface GuardianOption { id: number; first_name: string; last_name: string; email: string; }

function ManageMunicipalityYouthPageContent() {
  const router = useRouter();
  const pathname = usePathname();
  const searchParams = useSearchParams();
  const { user } = useAuth();

  const [users, setUsers] = useState<any[]>([]);
  const [totalCount, setTotalCount] = useState(0);
  const [isLoading, setIsLoading] = useState(true);
  const [stats, setStats] = useState<any>(null);
  const [analyticsExpanded, setAnalyticsExpanded] = useState(true);
  const [avatarErrors, setAvatarErrors] = useState<Set<number>>(new Set());

  const [toast, setToast] = useState<{ message: string; type: 'success' | 'error'; isVisible: boolean }>({
    message: '',
    type: 'success',
    isVisible: false,
  });

  const [clubs, setClubs] = useState<Option[]>([]);
  const [interests, setInterests] = useState<Option[]>([]);
  const [guardiansList, setGuardiansList] = useState<GuardianOption[]>([]);

  const [showModal, setShowModal] = useState(false);
  const [isEditing, setIsEditing] = useState(false);
  const [editUserId, setEditUserId] = useState<number | null>(null);
  const [avatarFile, setAvatarFile] = useState<File | null>(null);
  const [avatarPreview, setAvatarPreview] = useState<string | null>(null);
  
  // Delete Confirmation Modal State
  const [showDeleteModal, setShowDeleteModal] = useState(false);
  const [userToDelete, setUserToDelete] = useState<{ id: number; name: string } | null>(null);
  const [isDeleting, setIsDeleting] = useState(false);

  const [guardianSearchTerm, setGuardianSearchTerm] = useState('');
  const [showGuardianDropdown, setShowGuardianDropdown] = useState(false);
  const [interestSearchTerm, setInterestSearchTerm] = useState('');
  const [showInterestDropdown, setShowInterestDropdown] = useState(false);

  const initialFormState = {
    email: '', password: '', first_name: '', last_name: '', nickname: '',
    legal_gender: 'MALE', preferred_gender: '', phone_number: '',
    date_of_birth: '', grade: '', preferred_club: '',
    verification_status: 'UNVERIFIED',
    interests: [] as number[],
    guardians: [] as number[],
  };

  const [formData, setFormData] = useState(initialFormState);
  const [customFieldValues, setCustomFieldValues] = useState<Record<number, any>>({});

  useEffect(() => {
    fetchDropdowns();
    fetchStats();
  }, []);

  useEffect(() => {
    fetchYouth();
  }, [searchParams]);

  const fetchStats = async () => {
    try {
      const res = await api.get('/users/youth_stats/');
      setStats(res.data);
    } catch (err) {
      console.error(err);
    }
  };

  const fetchDropdowns = async () => {
    try {
      const clubRes = await api.get('/clubs/?page_size=1000');
      setClubs(Array.isArray(clubRes.data) ? clubRes.data : (clubRes.data?.results || []));

      const interestRes = await api.get('/interests/');
      setInterests(Array.isArray(interestRes.data) ? interestRes.data : (interestRes.data?.results || []));

      const guardianRes = await api.get('/users/list_guardians/');
      setGuardiansList(guardianRes.data);
    } catch (err) {
      console.error(err);
    }
  };

  const fetchYouth = async () => {
    setIsLoading(true);
    try {
      const params = new URLSearchParams();
      params.set('role', 'YOUTH_MEMBER');

      const page = searchParams.get('page');
      if (page) params.set('page', page);
      const search = searchParams.get('search');
      if (search) params.set('search', search);
      const ageFrom = searchParams.get('age_from');
      if (ageFrom) params.set('age_from', ageFrom);
      const ageTo = searchParams.get('age_to');
      if (ageTo) params.set('age_to', ageTo);
      const gradeFrom = searchParams.get('grade_from');
      if (gradeFrom) params.set('grade_from', gradeFrom);
      const gradeTo = searchParams.get('grade_to');
      if (gradeTo) params.set('grade_to', gradeTo);
      const status = searchParams.get('verification_status');
      if (status) params.set('verification_status', status);
      const club = searchParams.get('preferred_club');
      if (club) params.set('preferred_club', club);
      const gender = searchParams.get('legal_gender');
      if (gender) params.set('legal_gender', gender);

      const res = await api.get(`/users/?${params.toString()}`);
      const results = res.data.results || [];
      setUsers(results);
      setTotalCount(res.data.count ?? results.length);
    } catch (err) {
      console.error(err);
    } finally {
      setIsLoading(false);
    }
  };

  const updateUrl = (key: string, value: string) => {
    const params = new URLSearchParams(searchParams.toString());
    if (value) params.set(key, value); else params.delete(key);
    if (key !== 'page') params.set('page', '1');
    router.push(`${pathname}?${params.toString()}`);
  };

  const handleOpenCreate = () => {
    setIsEditing(false);
    setEditUserId(null);
    setFormData(initialFormState);
    setCustomFieldValues({});
    setAvatarFile(null);
    setAvatarPreview(null);
    setGuardianSearchTerm('');
    setInterestSearchTerm('');
    setShowGuardianDropdown(false);
    setShowInterestDropdown(false);
    setShowModal(true);
  };

  const handleOpenEdit = async (youth: any) => {
    setIsEditing(true);
    setEditUserId(youth.id);
    setFormData({
      email: youth.email,
      password: '',
      first_name: youth.first_name || '',
      last_name: youth.last_name || '',
      nickname: youth.nickname || '',
      legal_gender: youth.legal_gender || 'MALE',
      preferred_gender: youth.preferred_gender || '',
      phone_number: youth.phone_number || '',
      date_of_birth: youth.date_of_birth || '',
      grade: youth.grade?.toString() || '',
      preferred_club:
        typeof youth.preferred_club === 'object'
          ? youth.preferred_club?.id?.toString() || ''
          : youth.preferred_club?.toString() || '',
      verification_status: youth.verification_status || 'UNVERIFIED',
      interests:
        youth.interests?.map((i: any) => (typeof i === 'object' ? i.id : i)) || [],
      guardians: youth.guardians || [],
    });
    setAvatarFile(null);
    setAvatarPreview(youth.avatar ? getMediaUrl(youth.avatar) : null);
    setGuardianSearchTerm('');
    setInterestSearchTerm('');
    setShowGuardianDropdown(false);
    setShowInterestDropdown(false);
    
    // Load custom field values for this user
    try {
      const userRes = await api.get(`/users/${youth.id}/`);
      const customFieldValuesData = userRes.data.custom_field_values || [];
      const values: Record<number, any> = {};
      customFieldValuesData.forEach((cfv: any) => {
        values[cfv.field] = cfv.value;
      });
      setCustomFieldValues(values);
    } catch (err) {
      console.error('Failed to load custom field values:', err);
      setCustomFieldValues({});
    }
    
    setShowModal(true);
  };

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    try {
      const data = new FormData();
      Object.entries(formData).forEach(([key, value]) => {
        if (key === 'password' && !value) return;
        if (key === 'interests' || key === 'guardians') return;
        data.append(key, value?.toString() || '');
      });

      formData.interests.forEach((id) => data.append('interests', id.toString()));
      formData.guardians.forEach((id) => data.append('guardians', id.toString()));
      data.append('role', 'YOUTH_MEMBER');
      if (avatarFile) data.append('avatar', avatarFile);

      const config = { headers: { 'Content-Type': 'multipart/form-data' } };
      let userId: number;
      if (isEditing && editUserId) {
        await api.patch(`/users/${editUserId}/`, data, config);
        userId = editUserId;
        setToast({ message: 'Youth member updated successfully!', type: 'success', isVisible: true });
      } else {
        const res = await api.post('/users/', data, config);
        userId = res.data.id;
        setToast({ message: 'Youth member created successfully!', type: 'success', isVisible: true });
      }

      // Save custom field values
      if (Object.keys(customFieldValues).length > 0) {
        try {
          await api.post('/custom-fields/save_values_for_user/', {
            user_id: userId,
            values: customFieldValues,
          });
        } catch (err) {
          console.error('Failed to save custom field values:', err);
        }
      }

      setShowModal(false);
      fetchYouth();
      fetchStats();
    } catch (err) {
      setToast({ message: 'Operation failed. Please try again.', type: 'error', isVisible: true });
      console.error(err);
    }
  };

  const handleDeleteClick = (youth: any) => {
    setUserToDelete({ id: youth.id, name: `${youth.first_name} ${youth.last_name}` });
    setShowDeleteModal(true);
  };

  const handleDeleteConfirm = async () => {
    if (!userToDelete) return;

    setIsDeleting(true);
    try {
      await api.delete(`/users/${userToDelete.id}/`);
      setToast({ message: 'Youth member deleted successfully!', type: 'success', isVisible: true });
      setShowDeleteModal(false);
      setUserToDelete(null);
      fetchYouth();
      fetchStats();
    } catch (err) {
      setToast({ message: 'Failed to delete youth member.', type: 'error', isVisible: true });
    } finally {
      setIsDeleting(false);
    }
  };

  const handleAvatarChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (file) {
      setAvatarFile(file);
      const reader = new FileReader();
      reader.onloadend = () => setAvatarPreview(reader.result as string);
      reader.readAsDataURL(file);
    }
  };

  const toggleInterest = (id: number) => {
    setFormData((prev) => ({
      ...prev,
      interests: prev.interests.includes(id)
        ? prev.interests.filter((i) => i !== id)
        : [...prev.interests, id],
    }));
    setInterestSearchTerm('');
    setShowInterestDropdown(false);
  };

  const removeInterest = (id: number) => {
    setFormData((prev) => ({
      ...prev,
      interests: prev.interests.filter((i) => i !== id),
    }));
  };

  const toggleGuardian = (id: number) => {
    setFormData((prev) => ({
      ...prev,
      guardians: prev.guardians.includes(id)
        ? prev.guardians.filter((i) => i !== id)
        : [...prev.guardians, id],
    }));
    setGuardianSearchTerm('');
    setShowGuardianDropdown(false);
  };

  const removeGuardian = (id: number) => {
    setFormData((prev) => ({
      ...prev,
      guardians: prev.guardians.filter((i) => i !== id),
    }));
  };

  const filteredInterests = interests.filter(
    (interest) =>
      interest.name.toLowerCase().includes(interestSearchTerm.toLowerCase()) &&
      !formData.interests.includes(interest.id)
  );

  const filteredGuardians = guardiansList.filter((guardian) => {
    const target = `${guardian.first_name} ${guardian.last_name} ${guardian.email}`.toLowerCase();
    return (
      target.includes(guardianSearchTerm.toLowerCase()) &&
      !formData.guardians.includes(guardian.id)
    );
  });

  const getSelectedInterests = () =>
    formData.interests.map((id) => interests.find((interest) => interest.id === id)).filter(Boolean) as Option[];

  const getSelectedGuardians = () =>
    formData.guardians.map((id) => guardiansList.find((guardian) => guardian.id === id)).filter(Boolean) as GuardianOption[];

  const getInitials = (first = '', last = '') => {
    const a = first.charAt(0)?.toUpperCase() || '';
    const b = last.charAt(0)?.toUpperCase() || '';
    return a + b || '?';
  };

  const getAvatarColor = () => 'bg-purple-100 text-purple-700';

  const currentPage = Number(searchParams.get('page')) || 1;
  const totalPages = totalCount > 0 ? Math.ceil(totalCount / 10) : 1;

  return (
    <div>
      <div className="flex justify-between items-center mb-6">
        <div>
          <p className="text-sm text-purple-500 uppercase font-semibold">Municipality Admin</p>
          <h1 className="text-2xl font-bold text-gray-900">Manage Youth Members</h1>
        </div>
        <button onClick={handleOpenCreate} className="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-–øurple-700 shadow">
          + Add Youth
        </button>
      </div>

      {stats && (
        <div className="mb-6">
          <button
            onClick={() => setAnalyticsExpanded(!analyticsExpanded)}
            className="flex items-center justify-between w-full bg-white rounded-lg shadow-sm border border-gray-200 p-3 hover:bg-gray-50 transition-colors mb-3"
          >
            <div className="flex items-center gap-2">
              <svg className="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
              </svg>
              <span className="text-sm font-semibold text-gray-700">Analytics</span>
            </div>
            <svg
              className={`w-5 h-5 text-gray-600 transition-transform duration-200 ${analyticsExpanded ? 'rotate-180' : ''}`}
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
            </svg>
          </button>

          <div
            className={`grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 transition-all duration-500 ease-in-out ${
              analyticsExpanded ? 'max-h-[600px] opacity-100 translate-y-0' : 'max-h-0 opacity-0 -translate-y-4 pointer-events-none'
            } overflow-hidden`}
          >
            <div className="bg-gradient-to-br from-purple-500 to-purple-600 rounded-xl shadow-md p-4 text-white">
              <h3 className="text-xs font-semibold uppercase text-white/80">Total Youth</h3>
              <p className="text-3xl font-bold mt-1">{stats.total_youth}</p>
            </div>
            <div className="bg-white rounded-xl shadow p-4 border border-purple-50">
              <h3 className="text-xs font-semibold uppercase text-gray-500 mb-2">Active (7 days)</h3>
              <p className="text-2xl font-bold text-gray-800">{stats.activity.active_7_days}</p>
            </div>
            <div className="bg-white rounded-xl shadow p-4 border border-purple-50">
              <h3 className="text-xs font-semibold uppercase text-gray-500 mb-2">Verified</h3>
              <p className="text-xl font-bold text-green-600">{stats.gender?.female ?? 0}</p>
            </div>
            <div className="bg-white rounded-xl shadow p-4 border border-purple-50">
              <h3 className="text-xs font-semibold uppercase text-gray-500 mb-2">Grades Tracked</h3>
              <p className="text-xl font-bold text-purple-600">{Object.keys(stats.grades || {}).length}</p>
            </div>
          </div>
        </div>
      )}

      <div className="bg-white p-4 rounded-lg shadow mb-6 border border-gray-100">
        <div className="flex flex-wrap gap-4 items-end">
          <div className="flex-1 min-w-[200px]">
            <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Search</label>
            <input
              type="text"
              placeholder="Search name or email..."
              className="w-full border rounded p-2 text-sm bg-gray-50"
              value={searchParams.get('search') || ''}
              onChange={(e) => updateUrl('search', e.target.value)}
            />
          </div>

          <div className="w-20">
            <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Age From</label>
            <input
              type="number"
              className="w-full border rounded p-2 text-sm bg-gray-50"
              value={searchParams.get('age_from') || ''}
              onChange={(e) => updateUrl('age_from', e.target.value)}
            />
          </div>

          <div className="w-20">
            <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Age To</label>
            <input
              type="number"
              className="w-full border rounded p-2 text-sm bg-gray-50"
              value={searchParams.get('age_to') || ''}
              onChange={(e) => updateUrl('age_to', e.target.value)}
            />
          </div>

          <div className="w-24">
            <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Grade From</label>
            <input
              type="number"
              className="w-full border rounded p-2 text-sm bg-gray-50"
              value={searchParams.get('grade_from') || ''}
              onChange={(e) => updateUrl('grade_from', e.target.value)}
            />
          </div>

          <div className="w-24">
            <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Grade To</label>
            <input
              type="number"
              className="w-full border rounded p-2 text-sm bg-gray-50"
              value={searchParams.get('grade_to') || ''}
              onChange={(e) => updateUrl('grade_to', e.target.value)}
            />
          </div>

          <div className="w-44">
            <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Status</label>
            <select
              className="w-full border rounded p-2 text-sm bg-gray-50"
              value={searchParams.get('verification_status') || ''}
              onChange={(e) => updateUrl('verification_status', e.target.value)}
            >
              <option value="">All Statuses</option>
              <option value="UNVERIFIED">Unverified</option>
              <option value="PENDING">Pending</option>
              <option value="VERIFIED">Verified</option>
            </select>
          </div>

          <div className="w-48">
            <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Club</label>
            <select
              className="w-full border rounded p-2 text-sm bg-gray-50"
              value={searchParams.get('preferred_club') || ''}
              onChange={(e) => updateUrl('preferred_club', e.target.value)}
            >
              <option value="">All Clubs</option>
              {clubs.map((club) => (
                <option key={club.id} value={club.id.toString()}>
                  {club.name}
                </option>
              ))}
            </select>
          </div>

          <div className="w-32">
            <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Gender</label>
            <select
              className="w-full border rounded p-2 text-sm bg-gray-50"
              value={searchParams.get('legal_gender') || ''}
              onChange={(e) => updateUrl('legal_gender', e.target.value)}
            >
              <option value="">Any</option>
              <option value="MALE">Male</option>
              <option value="FEMALE">Female</option>
              <option value="OTHER">Other</option>
            </select>
          </div>

          <button onClick={() => router.push(pathname)} className="px-4 py-2 text-sm text-gray-600 hover:text-red-500">
            Clear Filters
          </button>
        </div>
      </div>

      <div className="bg-white rounded-lg shadow overflow-hidden mb-6">
        {isLoading ? (
          <div className="p-8 text-center text-gray-500">Loading youth...</div>
        ) : users.length === 0 ? (
          <div className="p-8 text-center text-gray-500">No youth members found.</div>
        ) : (
          <table className="min-w-full divide-y divide-gray-200">
            <thead className="bg-gray-50">
              <tr>
                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">User</th>
                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Club</th>
                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Grade / DOB</th>
                <th className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">Actions</th>
              </tr>
            </thead>
            <tbody className="bg-white divide-y divide-gray-200">
              {users.map((youth) => (
                <tr key={youth.id}>
                  <td className="px-6 py-4">
                    <div className="flex items-center">
                      {youth.avatar && !avatarErrors.has(youth.id) ? (
                        <img
                          src={getMediaUrl(youth.avatar) || ''}
                          alt="Avatar"
                          className="w-10 h-10 rounded-full object-cover mr-3"
                          onError={() =>
                            setAvatarErrors((prev) => {
                              const next = new Set(prev);
                              next.add(youth.id);
                              return next;
                            })
                          }
                        />
                      ) : (
                        <div className={`w-10 h-10 rounded-full ${getAvatarColor()} flex items-center justify-center font-semibold text-sm mr-3`}>
                          {getInitials(youth.first_name, youth.last_name)}
                        </div>
                      )}
                      <div>
                        <div className="text-sm font-semibold text-gray-900">
                          {youth.first_name} {youth.last_name}
                        </div>
                        <div className="text-xs text-gray-500">{youth.email}</div>
                      </div>
                    </div>
                  </td>
                  <td className="px-6 py-4 text-sm text-gray-600">
                    {clubs.find((club) => club.id === youth.preferred_club)?.name || '‚Äî'}
                  </td>
                  <td className="px-6 py-4 text-sm text-gray-600">
                    Grade: <span className="font-semibold">{youth.grade || '-'}</span>
                    <br />
                    <span className="text-xs">{youth.date_of_birth || '-'}</span>
                  </td>
                  <td className="px-6 py-4 whitespace-nowrap text-right text-sm space-x-4">
                    <Link href={`/admin/municipality/youth/${youth.id}`} className="text-purple-600 font-bold">
                      View
                    </Link>
                    <button onClick={() => handleOpenEdit(youth)} className="text-indigo-600 font-bold">
                      Edit
                    </button>
                    <button onClick={() => handleDeleteClick(youth)} className="text-red-600">
                      Delete
                    </button>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        )}
      </div>

      <div className="flex items-center justify-between border-t border-gray-200 bg-white px-4 py-3 sm:px-6 rounded-lg shadow">
        <div className="text-sm text-gray-600">Total youth: {totalCount}</div>
        <div className="flex items-center gap-2">
          <button
            disabled={currentPage === 1}
            onClick={() => updateUrl('page', (currentPage - 1).toString())}
            className="px-3 py-1 rounded border text-sm disabled:opacity-50"
          >
            Previous
          </button>
          <span className="text-sm text-gray-600">
            Page {currentPage} of {totalPages}
          </span>
          <button
            disabled={currentPage >= totalPages}
            onClick={() => updateUrl('page', (currentPage + 1).toString())}
            className="px-3 py-1 rounded border text-sm disabled:opacity-50"
          >
            Next
          </button>
        </div>
      </div>

      {showModal && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-xl shadow-2xl w-full max-w-2xl p-8 max-h-[90vh] overflow-y-auto">
            <h2 className="text-2xl font-bold mb-6 text-gray-800">{isEditing ? 'Edit Youth' : 'Create Youth'}</h2>
            <form onSubmit={handleSubmit} className="space-y-6">
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <input
                  required
                  type="text"
                  placeholder="First Name"
                  className="border p-2 rounded"
                  value={formData.first_name}
                  onChange={(e) => setFormData({ ...formData, first_name: e.target.value })}
                />
                <input
                  required
                  type="text"
                  placeholder="Last Name"
                  className="border p-2 rounded"
                  value={formData.last_name}
                  onChange={(e) => setFormData({ ...formData, last_name: e.target.value })}
                />
                <input
                  required
                  type="email"
                  placeholder="Email"
                  className="border p-2 rounded"
                  value={formData.email}
                  onChange={(e) => setFormData({ ...formData, email: e.target.value })}
                />
                <input
                  type="password"
                  placeholder={isEditing ? 'New Password (optional)' : 'Password'}
                  className="border p-2 rounded"
                  required={!isEditing}
                  value={formData.password}
                  onChange={(e) => setFormData({ ...formData, password: e.target.value })}
                />
                <input
                  type="text"
                  placeholder="Nickname"
                  className="border p-2 rounded"
                  value={formData.nickname}
                  onChange={(e) => setFormData({ ...formData, nickname: e.target.value })}
                />
                <input
                  type="text"
                  placeholder="Phone"
                  className="border p-2 rounded"
                  value={formData.phone_number}
                  onChange={(e) => setFormData({ ...formData, phone_number: e.target.value })}
                />
              </div>

              <div className="bg-gray-50 p-4 rounded-lg border grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label className="block text-xs font-bold uppercase text-gray-500 mb-1">Date of Birth</label>
                  <input
                    type="date"
                    className="w-full border p-2 rounded"
                    value={formData.date_of_birth}
                    onChange={(e) => setFormData({ ...formData, date_of_birth: e.target.value })}
                  />
                </div>
                <div>
                  <label className="block text-xs font-bold uppercase text-gray-500 mb-1">Grade</label>
                  <input
                    type="number"
                    className="w-full border p-2 rounded"
                    value={formData.grade}
                    onChange={(e) => setFormData({ ...formData, grade: e.target.value })}
                  />
                </div>
                <div>
                  <label className="block text-xs font-bold uppercase text-gray-500 mb-1">Legal Gender</label>
                  <select
                    className="w-full border p-2 rounded"
                    value={formData.legal_gender}
                    onChange={(e) => setFormData({ ...formData, legal_gender: e.target.value })}
                  >
                    <option value="MALE">Male</option>
                    <option value="FEMALE">Female</option>
                    <option value="OTHER">Other</option>
                  </select>
                </div>
                <div>
                  <label className="block text-xs font-bold uppercase text-gray-500 mb-1">Preferred Gender</label>
                  <input
                    type="text"
                    className="w-full border p-2 rounded"
                    value={formData.preferred_gender}
                    onChange={(e) => setFormData({ ...formData, preferred_gender: e.target.value })}
                  />
                </div>
              </div>

              <div>
                <label className="block text-sm font-bold mb-2">Preferred Club</label>
                <select
                  className="w-full border p-2 rounded mb-4"
                  value={formData.preferred_club}
                  onChange={(e) => setFormData({ ...formData, preferred_club: e.target.value })}
                >
                  <option value="">Select Club...</option>
                  {clubs.map((club) => (
                    <option key={club.id} value={club.id.toString()}>
                      {club.name}
                    </option>
                  ))}
                </select>

                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                  <div>
                    <label className="block text-sm font-bold mb-2">Assign Guardians</label>
                    {formData.guardians.length > 0 && (
                      <div className="flex flex-wrap gap-2 mb-3 p-3 bg-blue-50 rounded-lg border border-blue-200">
                        {getSelectedGuardians().map((guardian) => (
                          <span key={guardian.id} className="inline-flex items-center gap-1.5 px-3 py-1.5 bg-blue-600 text-white text-sm rounded-full font-medium">
                            {guardian.first_name} {guardian.last_name}
                            <button type="button" onClick={() => removeGuardian(guardian.id)} className="hover:bg-blue-700 rounded-full p-0.5 transition-colors">
                              <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                              </svg>
                            </button>
                          </span>
                        ))}
                      </div>
                    )}
                    <div className="relative mb-4">
                      <input
                        type="text"
                        placeholder="Search guardians..."
                        value={guardianSearchTerm}
                        onChange={(e) => {
                          setGuardianSearchTerm(e.target.value);
                          setShowGuardianDropdown(true);
                        }}
                        onFocus={() => setShowGuardianDropdown(true)}
                        className="w-full border border-gray-300 rounded-lg p-2.5 focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                      />
                      {showGuardianDropdown && (
                        <>
                          <div className="fixed inset-0 z-10" onClick={() => setShowGuardianDropdown(false)}></div>
                          <div className="absolute z-20 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-60 overflow-y-auto">
                            {filteredGuardians.length > 0 ? (
                              filteredGuardians.map((guardian) => (
                                <button
                                  key={guardian.id}
                                  type="button"
                                  onClick={() => toggleGuardian(guardian.id)}
                                  className="w-full text-left px-4 py-2.5 hover:bg-blue-50 transition-colors border-b border-gray-100 last:border-b-0"
                                >
                                  <div className="font-medium text-gray-900">{guardian.first_name} {guardian.last_name}</div>
                                  <div className="text-xs text-gray-500">{guardian.email}</div>
                                </button>
                              ))
                            ) : guardianSearchTerm ? (
                              <div className="px-4 py-3 text-sm text-gray-500 text-center">No guardians found</div>
                            ) : (
                              <div className="px-4 py-3 text-sm text-gray-500 text-center">All guardians already selected</div>
                            )}
                          </div>
                        </>
                      )}
                    </div>
                  </div>

                  <div>
                    <label className="block text-sm font-bold mb-2">Interests</label>
                    {formData.interests.length > 0 && (
                      <div className="flex flex-wrap gap-2 mb-3 p-3 bg-purple-50 rounded-lg border border-purple-200">
                        {getSelectedInterests().map((interest) => (
                          <span key={interest.id} className="inline-flex items-center gap-1.5 px-3 py-1.5 bg-purple-600 text-white text-sm rounded-full font-medium">
                            {interest.name}
                            <button type="button" onClick={() => removeInterest(interest.id)} className="hover:bg-purple-700 rounded-full p-0.5 transition-colors">
                              <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                              </svg>
                            </button>
                          </span>
                        ))}
                      </div>
                    )}
                    <div className="relative mb-4">
                      <input
                        type="text"
                        placeholder="Search interests..."
                        value={interestSearchTerm}
                        onChange={(e) => {
                          setInterestSearchTerm(e.target.value);
                          setShowInterestDropdown(true);
                        }}
                        onFocus={() => setShowInterestDropdown(true)}
                        className="w-full border border-gray-300 rounded-lg p-2.5 focus:ring-2 focus:ring-purple-500 focus:border-purple-500"
                      />
                      {showInterestDropdown && (
                        <>
                          <div className="fixed inset-0 z-10" onClick={() => setShowInterestDropdown(false)}></div>
                          <div className="absolute z-20 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-60 overflow-y-auto">
                            {filteredInterests.length > 0 ? (
                              filteredInterests.map((interest) => (
                                <button
                                  key={interest.id}
                                  type="button"
                                  onClick={() => toggleInterest(interest.id)}
                                  className="w-full text-left px-4 py-2.5 hover:bg-purple-50 transition-colors border-b border-gray-100 last:border-b-0"
                                >
                                  <div className="font-medium text-gray-900">{interest.name}</div>
                                </button>
                              ))
                            ) : interestSearchTerm ? (
                              <div className="px-4 py-3 text-sm text-gray-500 text-center">No interests found</div>
                            ) : (
                              <div className="px-4 py-3 text-sm text-gray-500 text-center">All interests already selected</div>
                            )}
                          </div>
                        </>
                      )}
                    </div>
                  </div>
                </div>
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">Avatar</label>
                <input type="file" accept="image/*" className="w-full border p-2 rounded" onChange={handleAvatarChange} />
                {avatarPreview && <img src={avatarPreview} alt="Preview" className="w-16 h-16 mt-2 rounded-full object-cover border" />}
              </div>

              {/* Custom Fields */}
              <CustomFieldsForm
                targetRole="YOUTH_MEMBER"
                context="USER_PROFILE"
                values={customFieldValues}
                onChange={(fieldId, value) => {
                  setCustomFieldValues((prev) => ({
                    ...prev,
                    [fieldId]: value,
                  }));
                }}
                userId={isEditing ? editUserId : null}
                userMunicipalityId={user?.assigned_municipality ? (typeof user.assigned_municipality === 'object' ? user.assigned_municipality.id : user.assigned_municipality) : null}
                userClubId={formData.preferred_club ? (typeof formData.preferred_club === 'string' ? Number(formData.preferred_club) : (typeof formData.preferred_club === 'number' ? formData.preferred_club : null)) : null}
              />

              <div className="flex justify-end gap-4 pt-4 border-t">
                <button type="button" onClick={() => setShowModal(false)} className="text-gray-500">
                  Cancel
                </button>
                <button type="submit" className="bg-purple-600 text-white px-6 py-2 rounded-lg hover:bg-purple-700">
                  {isEditing ? 'Save Changes' : 'Create Youth'}
                </button>
              </div>
            </form>
          </div>
        </div>
      )}

      {/* Delete Confirmation Modal */}
      <DeleteConfirmationModal
        isVisible={showDeleteModal}
        onClose={() => {
          if (!isDeleting) {
            setShowDeleteModal(false);
            setUserToDelete(null);
          }
        }}
        onConfirm={handleDeleteConfirm}
        itemName={userToDelete?.name}
        isLoading={isDeleting}
      />

      <Toast
        message={toast.message}
        type={toast.type}
        isVisible={toast.isVisible}
        onClose={() => setToast({ ...toast, isVisible: false })}
      />
    </div>
  );
}

export default function ManageMunicipalityYouthPage() {
  return (
    <Suspense fallback={<div>Loading...</div>}>
      <ManageMunicipalityYouthPageContent />
    </Suspense>
  );
}
--- END OF FILE: ./frontend/app/admin/municipality/youth/page.tsx ---


--- START OF FILE: ./frontend/app/admin/municipality/youth/[id]/page.tsx ---
'use client';

import { useState, useEffect, Suspense } from 'react';
import { useRouter, useParams } from 'next/navigation';
import Link from 'next/link';
import api from '../../../../../lib/api';
import { getMediaUrl } from '../../../../utils';
import CustomFieldsDisplay from '../../../../components/CustomFieldsDisplay';

interface Option { id: number; name: string; }
interface GuardianOption { id: number; first_name: string; last_name: string; email: string; }

function MunicipalityYouthViewContent() {
  const router = useRouter();
  const params = useParams();
  const youthId = params?.id as string;

  const [youth, setYouth] = useState<any>(null);
  const [clubs, setClubs] = useState<Option[]>([]);
  const [interests, setInterests] = useState<Option[]>([]);
  const [guardiansList, setGuardiansList] = useState<GuardianOption[]>([]);
  const [isLoading, setIsLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);

  useEffect(() => {
    if (youthId) {
      fetchData();
    }
  }, [youthId]);

  const fetchData = async () => {
    setIsLoading(true);
    setError(null);
    try {
      const userRes = await api.get(`/users/${youthId}/`);
      setYouth(userRes.data);

      const clubRes = await api.get('/clubs/?page_size=1000');
      setClubs(Array.isArray(clubRes.data) ? clubRes.data : (clubRes.data?.results || []));

      const interestRes = await api.get('/interests/');
      setInterests(Array.isArray(interestRes.data) ? interestRes.data : (interestRes.data?.results || []));

      const guardianRes = await api.get('/users/list_guardians/');
      setGuardiansList(guardianRes.data);
    } catch (err: any) {
      setError(err?.response?.status === 404 ? 'Youth member not found or access denied.' : 'Failed to load youth member');
    } finally {
      setIsLoading(false);
    }
  };

  const calculateAge = (dateOfBirth: string | null) => {
    if (!dateOfBirth) return null;
    const today = new Date();
    const birthDate = new Date(dateOfBirth);
    let age = today.getFullYear() - birthDate.getFullYear();
    const monthDiff = today.getMonth() - birthDate.getMonth();
    if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) age--;
    return age;
  };

  if (isLoading) {
    return (
      <div className="p-8 text-center">
        <p className="text-gray-500">Loading youth member...</p>
      </div>
    );
  }

  if (error || !youth) {
    return (
      <div className="p-8">
        <div className="bg-red-50 border border-red-200 rounded-lg p-4 mb-4">
          <p className="text-red-800">{error || 'Youth member not found.'}</p>
        </div>
        <Link href="/admin/municipality/youth" className="text-purple-600 hover:text-purple-800 font-semibold">
          ‚Üê Back to Youth Members
        </Link>
      </div>
    );
  }

  const interestIds = youth.interests?.map((i: any) => (typeof i === 'object' ? i.id : i)) || [];
  const guardianIds = youth.guardians || [];

  return (
    <div className="p-8 space-y-6">
      <div className="flex items-center justify-between">
        <Link href="/admin/municipality/youth" className="text-purple-600 hover:text-purple-800 font-semibold">
          ‚Üê Back to Youth Members
        </Link>
        <button
          onClick={() => router.push(`/admin/municipality/youth?edit=${youth.id}`)}
          className="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 shadow"
        >
          Edit Youth
        </button>
      </div>

      <section className="bg-white rounded-2xl shadow-xl p-8">
        <div className="flex flex-col md:flex-row md:items-center gap-6 border-b pb-6">
          {youth.avatar && (
            <img
              src={getMediaUrl(youth.avatar) || ''}
              alt={`${youth.first_name} ${youth.last_name}`}
              className="w-32 h-32 rounded-full object-cover border-4 border-purple-100"
              onError={(e) => ((e.target as HTMLImageElement).style.display = 'none')}
            />
          )}
          <div>
            <p className="text-sm text-purple-500 uppercase font-semibold">Youth Profile</p>
            <h1 className="text-3xl font-bold text-gray-900 mt-1">
              {youth.first_name} {youth.last_name}
              {youth.nickname && <span className="text-xl text-gray-500 ml-2">({youth.nickname})</span>}
            </h1>
            <p className="text-gray-600 mt-2">{youth.email}</p>
            <div className="flex items-center gap-3 mt-3">
              <span className={`px-3 py-1 text-xs font-bold rounded-full ${
                youth.verification_status === 'VERIFIED'
                  ? 'bg-green-100 text-green-700'
                  : youth.verification_status === 'PENDING'
                  ? 'bg-yellow-100 text-yellow-700'
                  : 'bg-gray-100 text-gray-600'
              }`}>
                {youth.verification_status || 'UNVERIFIED'}
              </span>
              {youth.phone_number && <span className="text-sm text-gray-600">üìû {youth.phone_number}</span>}
            </div>
          </div>
        </div>
      </section>

      <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <div className="lg:col-span-2 space-y-6">
          <section className="bg-white rounded-2xl shadow p-6">
            <h2 className="text-xl font-bold text-gray-800 mb-4">Basic Information</h2>
            <div className="grid grid-cols-2 gap-4 text-sm">
              <div>
                <p className="text-gray-500 font-semibold uppercase text-xs mb-1">Date of Birth</p>
                <p className="text-gray-900">{youth.date_of_birth || '-'}</p>
              </div>
              <div>
                <p className="text-gray-500 font-semibold uppercase text-xs mb-1">Age</p>
                <p className="text-gray-900">{calculateAge(youth.date_of_birth) || '-'}</p>
              </div>
              <div>
                <p className="text-gray-500 font-semibold uppercase text-xs mb-1">Grade</p>
                <p className="text-gray-900">{youth.grade || '-'}</p>
              </div>
              <div>
                <p className="text-gray-500 font-semibold uppercase text-xs mb-1">Legal Gender</p>
                <p className="text-gray-900">{youth.legal_gender || '-'}</p>
              </div>
              <div>
                <p className="text-gray-500 font-semibold uppercase text-xs mb-1">Preferred Gender</p>
                <p className="text-gray-900">{youth.preferred_gender || '-'}</p>
              </div>
              <div>
                <p className="text-gray-500 font-semibold uppercase text-xs mb-1">Preferred Club</p>
                <p className="text-gray-900">{clubs.find((c) => c.id === youth.preferred_club)?.name || '-'}</p>
              </div>
            </div>
          </section>

          {guardianIds.length > 0 && (
            <section className="bg-white rounded-2xl shadow p-6">
              <h2 className="text-xl font-bold text-gray-800 mb-4">Assigned Guardians</h2>
              <div className="space-y-3">
                {guardianIds.map((guardianId: number) => {
                  const guardian = guardiansList.find((g) => g.id === guardianId);
                  if (!guardian) return null;
                  return (
                    <div key={guardianId} className="p-3 border rounded-lg bg-gray-50">
                      <p className="text-sm font-semibold text-gray-900">
                        {guardian.first_name} {guardian.last_name}
                      </p>
                      <p className="text-xs text-gray-500">{guardian.email}</p>
                    </div>
                  );
                })}
              </div>
            </section>
          )}

          {interestIds.length > 0 && (
            <section className="bg-white rounded-2xl shadow p-6">
              <h2 className="text-xl font-bold text-gray-800 mb-4">Interests</h2>
              <div className="flex flex-wrap gap-2">
                {interestIds.map((interestId: number) => {
                  const interest = interests.find((i) => i.id === interestId);
                  if (!interest) return null;
                  return (
                    <span
                      key={interestId}
                      className="px-3 py-1 bg-purple-100 text-purple-700 rounded-full text-sm font-medium"
                    >
                      {interest.name}
                    </span>
                  );
                })}
              </div>
            </section>
          )}

          {/* CUSTOM FIELDS */}
          <CustomFieldsDisplay
            userId={youth.id}
            targetRole="YOUTH_MEMBER"
            context="USER_PROFILE"
          />
        </div>

        <aside className="space-y-6">
          <section className="bg-white rounded-2xl shadow p-6">
            <h3 className="text-lg font-bold text-gray-800 mb-3">Account Information</h3>
            <div className="space-y-3 text-sm text-gray-700">
              <div>
                <p className="text-xs text-gray-500 font-semibold uppercase">Date Joined</p>
                <p>{youth.date_joined ? new Date(youth.date_joined).toLocaleDateString() : '-'}</p>
              </div>
              <div>
                <p className="text-xs text-gray-500 font-semibold uppercase">Last Login</p>
                <p>{youth.last_login ? new Date(youth.last_login).toLocaleDateString() : 'Never'}</p>
              </div>
              <div>
                <p className="text-xs text-gray-500 font-semibold uppercase">Preferred Language</p>
                <p>{youth.preferred_language || '-'}</p>
              </div>
              <div>
                <p className="text-xs text-gray-500 font-semibold uppercase">Account Status</p>
                <span
                  className={`px-2 py-1 rounded text-xs font-bold ${
                    youth.is_active ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'
                  }`}
                >
                  {youth.is_active ? 'Active' : 'Inactive'}
                </span>
              </div>
            </div>
          </section>

          <section className="bg-white rounded-2xl shadow p-6 space-y-2">
            <button
              onClick={() => router.push(`/admin/municipality/youth?edit=${youth.id}`)}
              className="w-full bg-purple-600 text-white py-2 rounded-lg font-semibold hover:bg-purple-700"
            >
              Edit Youth
            </button>
            <Link
              href="/admin/municipality/youth"
              className="block w-full text-center bg-gray-100 text-gray-700 py-2 rounded-lg font-semibold hover:bg-gray-200"
            >
              Back to List
            </Link>
          </section>
        </aside>
      </div>
    </div>
  );
}

export default function MunicipalityYouthViewPage() {
  return (
    <Suspense fallback={<div className="p-8 text-center">Loading...</div>}>
      <MunicipalityYouthViewContent />
    </Suspense>
  );
}

--- END OF FILE: ./frontend/app/admin/municipality/youth/[id]/page.tsx ---


--- START OF FILE: ./frontend/app/admin/municipality/guardians/page.tsx ---
'use client';

import { useState, useEffect, Suspense } from 'react';
import { useRouter, useSearchParams, usePathname } from 'next/navigation';
import Link from 'next/link';
import api from '../../../../lib/api';
import { useAuth } from '../../../../context/AuthContext';
import { getMediaUrl } from '../../../utils';
import Toast from '../../../components/Toast';
import DeleteConfirmationModal from '../../../components/DeleteConfirmationModal';
import CustomFieldsForm from '../../../components/CustomFieldsForm';

interface YouthOption {
  id: number;
  first_name: string;
  last_name: string;
  email: string;
  grade: number | null;
}

function ManageMunicipalityGuardiansPageContent() {
  const router = useRouter();
  const pathname = usePathname();
  const searchParams = useSearchParams();

  const [guardians, setGuardians] = useState<any[]>([]);
  const [totalCount, setTotalCount] = useState(0);
  const [isLoading, setIsLoading] = useState(true);
  const [stats, setStats] = useState<any>(null);
  const [analyticsExpanded, setAnalyticsExpanded] = useState(true);
  const [avatarErrors, setAvatarErrors] = useState<Set<number>>(new Set());

  const [toast, setToast] = useState<{ message: string; type: 'success' | 'error' | 'info' | 'warning'; isVisible: boolean }>({
    message: '',
    type: 'success',
    isVisible: false,
  });

  const [youthList, setYouthList] = useState<YouthOption[]>([]);
  const { user } = useAuth();
  const [customFieldValues, setCustomFieldValues] = useState<Record<number, any>>({});

  const [showModal, setShowModal] = useState(false);
  const [isEditing, setIsEditing] = useState(false);
  const [editUserId, setEditUserId] = useState<number | null>(null);
  const [avatarFile, setAvatarFile] = useState<File | null>(null);
  const [avatarPreview, setAvatarPreview] = useState<string | null>(null);
  const [youthSearchTerm, setYouthSearchTerm] = useState('');
  const [showYouthDropdown, setShowYouthDropdown] = useState(false);
  
  // Delete Confirmation Modal State
  const [showDeleteModal, setShowDeleteModal] = useState(false);
  const [userToDelete, setUserToDelete] = useState<{ id: number; name: string } | null>(null);
  const [isDeleting, setIsDeleting] = useState(false);

  const initialFormState = {
    email: '',
    password: '',
    first_name: '',
    last_name: '',
    phone_number: '',
    legal_gender: 'MALE',
    verification_status: 'UNVERIFIED',
    youth_members: [] as number[],
  };
  const [formData, setFormData] = useState(initialFormState);

  useEffect(() => {
    fetchDropdowns();
    fetchStats();
  }, []);

  useEffect(() => {
    fetchGuardians();
  }, [searchParams]);

  useEffect(() => {
    const editId = searchParams.get('edit');
    if (editId && !isEditing && !showModal) {
      const userId = parseInt(editId, 10);
      const existing = guardians.find((g) => g.id === userId);
      if (existing) {
        handleOpenEdit(existing);
      } else if (!isNaN(userId)) {
        api
          .get(`/users/${userId}/`)
          .then((res) => handleOpenEdit(res.data))
          .catch((err) => console.error('Failed to load guardian for edit', err));
      }
    }
  }, [searchParams, guardians, isEditing, showModal]);

  const fetchStats = async () => {
    try {
      const res = await api.get('/users/guardian_stats/');
      setStats(res.data);
    } catch (err) {
      console.error(err);
    }
  };

  const fetchDropdowns = async () => {
    try {
      const youthRes = await api.get('/users/list_youth/');
      setYouthList(Array.isArray(youthRes.data) ? youthRes.data : []);
    } catch (err) {
      console.error(err);
    }
  };

  const fetchGuardians = async () => {
    setIsLoading(true);
    try {
      const params = new URLSearchParams();
      params.set('role', 'GUARDIAN');
      const search = searchParams.get('search');
      if (search) params.set('search', search);
      const gender = searchParams.get('legal_gender');
      if (gender) params.set('legal_gender', gender);
      const status = searchParams.get('verification_status');
      if (status) params.set('verification_status', status);
      const page = searchParams.get('page');
      if (page) params.set('page', page);

      const res = await api.get(`/users/?${params.toString()}`);
      if (res.data?.results) {
        setGuardians(res.data.results);
        setTotalCount(res.data.count ?? res.data.results.length);
      } else {
        const data = Array.isArray(res.data) ? res.data : [];
        setGuardians(data);
        setTotalCount(data.length);
      }
    } catch (err) {
      console.error(err);
    } finally {
      setIsLoading(false);
    }
  };

  const updateUrl = (key: string, value: string) => {
    const params = new URLSearchParams(searchParams.toString());
    if (value) params.set(key, value);
    else params.delete(key);
    if (key !== 'page') params.set('page', '1');
    router.push(`${pathname}?${params.toString()}`);
  };

  const handleOpenCreate = () => {
    setIsEditing(false);
    setEditUserId(null);
    setFormData(initialFormState);
    setAvatarFile(null);
    setAvatarPreview(null);
    setYouthSearchTerm('');
    setShowYouthDropdown(false);
    setShowModal(true);
  };

  const handleOpenEdit = async (guardian: any) => {
    setIsEditing(true);
    setEditUserId(guardian.id);
    setFormData({
      email: guardian.email || '',
      password: '',
      first_name: guardian.first_name || '',
      last_name: guardian.last_name || '',
      phone_number: guardian.phone_number || '',
      legal_gender: guardian.legal_gender || 'MALE',
      verification_status: guardian.verification_status || 'UNVERIFIED',
      youth_members: guardian.youth_members || [],
    });
    setAvatarFile(null);
    setAvatarPreview(guardian.avatar ? getMediaUrl(guardian.avatar) : null);
    setYouthSearchTerm('');
    setShowYouthDropdown(false);
    
    // Load custom field values for this user
    try {
      const userRes = await api.get(`/users/${guardian.id}/`);
      const customFieldValuesData = userRes.data.custom_field_values || [];
      const values: Record<number, any> = {};
      customFieldValuesData.forEach((cfv: any) => {
        values[cfv.field] = cfv.value;
      });
      setCustomFieldValues(values);
    } catch (err) {
      console.error('Failed to load custom field values:', err);
      setCustomFieldValues({});
    }
    
    setShowModal(true);
  };

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    try {
      const data = new FormData();
      Object.entries(formData).forEach(([key, value]) => {
        if (key === 'password' && !value) return;
        if (key === 'youth_members') return;
        data.append(key, value?.toString() || '');
      });
      formData.youth_members.forEach((id) => data.append('youth_members', id.toString()));
      data.append('role', 'GUARDIAN');
      if (avatarFile) data.append('avatar', avatarFile);

      const config = { headers: { 'Content-Type': 'multipart/form-data' } };
      let userId: number;
      if (isEditing && editUserId) {
        await api.patch(`/users/${editUserId}/`, data, config);
        userId = editUserId;
        setToast({ message: 'Guardian updated successfully!', type: 'success', isVisible: true });
      } else {
        const createRes = await api.post('/users/', data, config);
        userId = createRes.data.id;
        setToast({ message: 'Guardian created successfully!', type: 'success', isVisible: true });
      }

      // Save custom field values
      if (Object.keys(customFieldValues).length > 0) {
        try {
          await api.post('/custom-fields/save_values_for_user/', {
            user_id: userId,
            values: customFieldValues,
          });
        } catch (err) {
          console.error('Failed to save custom field values:', err);
        }
      }

      setShowModal(false);
      fetchGuardians();
      fetchStats();
    } catch (err) {
      console.error(err);
      setToast({ message: 'Operation failed. Please try again.', type: 'error', isVisible: true });
    }
  };

  const handleDeleteClick = (guardian: any) => {
    setUserToDelete({ id: guardian.id, name: `${guardian.first_name} ${guardian.last_name}` });
    setShowDeleteModal(true);
  };

  const handleDeleteConfirm = async () => {
    if (!userToDelete) return;

    setIsDeleting(true);
    try {
      await api.delete(`/users/${userToDelete.id}/`);
      setToast({ message: 'Guardian deleted successfully!', type: 'success', isVisible: true });
      setShowDeleteModal(false);
      setUserToDelete(null);
      fetchGuardians();
      fetchStats();
    } catch (err) {
      setToast({ message: 'Failed to delete guardian.', type: 'error', isVisible: true });
    } finally {
      setIsDeleting(false);
    }
  };

  const handleAvatarChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (file) {
      setAvatarFile(file);
      const reader = new FileReader();
      reader.onloadend = () => setAvatarPreview(reader.result as string);
      reader.readAsDataURL(file);
    }
  };

  const toggleYouth = (id: number) => {
    setFormData((prev) => {
      const exists = prev.youth_members.includes(id);
      if (exists) {
        return { ...prev, youth_members: prev.youth_members.filter((y) => y !== id) };
      }
      return { ...prev, youth_members: [...prev.youth_members, id] };
    });
    setYouthSearchTerm('');
    setShowYouthDropdown(false);
  };

  const removeYouth = (id: number) => {
    setFormData((prev) => ({
      ...prev,
      youth_members: prev.youth_members.filter((y) => y !== id),
    }));
  };

  const filteredYouth = youthList.filter((y) => {
    const target = `${y.first_name} ${y.last_name} ${y.email}`.toLowerCase();
    return target.includes(youthSearchTerm.toLowerCase()) && !formData.youth_members.includes(y.id);
  });

  const getSelectedYouth = () =>
    formData.youth_members.map((id) => youthList.find((y) => y.id === id)).filter(Boolean) as YouthOption[];

  const getInitials = (first = '', last = '') => {
    const a = first.charAt(0)?.toUpperCase() || '';
    const b = last.charAt(0)?.toUpperCase() || '';
    return a + b || '?';
  };

  const getAvatarColor = () => 'bg-purple-100 text-purple-700';

  const currentPage = Number(searchParams.get('page')) || 1;
  const totalPages = totalCount > 0 ? Math.ceil(totalCount / 10) : 1;

  return (
    <div>
      <div className="flex flex-wrap justify-between items-center gap-4 mb-6">
        <div>
          <p className="text-sm text-purple-500 uppercase font-semibold">Municipality Admin</p>
          <h1 className="text-2xl font-bold text-gray-900">Manage Guardians</h1>
        </div>
        <button onClick={handleOpenCreate} className="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 shadow">
          + Add Guardian
        </button>
      </div>

      {stats && (
        <div className="mb-6">
          <button
            onClick={() => setAnalyticsExpanded(!analyticsExpanded)}
            className="flex items-center justify-between w-full bg-white rounded-lg shadow-sm border border-gray-200 p-3 hover:bg-gray-50 transition-colors mb-3"
          >
            <div className="flex items-center gap-2">
              <svg className="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
              </svg>
              <span className="text-sm font-semibold text-gray-700">Analytics</span>
            </div>
            <svg
              className={`w-5 h-5 text-gray-600 transition-transform duration-200 ${analyticsExpanded ? 'rotate-180' : ''}`}
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
            </svg>
          </button>

          <div
            className={`grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 transition-all duration-500 ease-in-out ${
              analyticsExpanded ? 'max-h-[600px] opacity-100 translate-y-0' : 'max-h-0 opacity-0 -translate-y-4 pointer-events-none'
            } overflow-hidden`}
          >
            <div className="bg-gradient-to-br from-purple-500 to-purple-600 rounded-xl shadow-md p-4 text-white">
              <h3 className="text-xs font-semibold uppercase text-white/80">Total Guardians</h3>
              <p className="text-3xl font-bold mt-1">{stats.total_guardians}</p>
              <p className="text-xs text-white/80">Active in your municipality</p>
            </div>
            <div className="bg-white rounded-xl shadow p-4 border border-purple-50">
              <h3 className="text-xs font-semibold uppercase text-gray-500 mb-1">Verified</h3>
              <p className="text-2xl font-bold text-gray-900">{stats.verification?.verified ?? 0}</p>
            </div>
            <div className="bg-white rounded-xl shadow p-4 border border-purple-50">
              <h3 className="text-xs font-semibold uppercase text-gray-500 mb-1">Pending</h3>
              <p className="text-2xl font-bold text-gray-900">{stats.verification?.pending ?? 0}</p>
            </div>
            <div className="bg-white rounded-xl shadow p-4 border border-purple-50">
              <h3 className="text-xs font-semibold uppercase text-gray-500 mb-1">Active (7 days)</h3>
              <p className="text-2xl font-bold text-gray-900">{stats.activity?.active_7_days ?? 0}</p>
            </div>
          </div>
        </div>
      )}

      <div className="bg-white p-4 rounded-lg shadow mb-6 border border-gray-100">
        <div className="flex flex-wrap gap-4 items-end">
          <div className="flex-1 min-w-[200px]">
            <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Search</label>
            <input
              type="text"
              placeholder="Name or email..."
              className="w-full border rounded p-2 text-sm bg-gray-50"
              value={searchParams.get('search') || ''}
              onChange={(e) => updateUrl('search', e.target.value)}
            />
          </div>
          <div className="w-40">
            <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Gender</label>
            <select
              className="w-full border rounded p-2 text-sm bg-gray-50"
              value={searchParams.get('legal_gender') || ''}
              onChange={(e) => updateUrl('legal_gender', e.target.value)}
            >
              <option value="">All</option>
              <option value="MALE">Male</option>
              <option value="FEMALE">Female</option>
              <option value="OTHER">Other</option>
            </select>
          </div>
          <div className="w-40">
            <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Status</label>
            <select
              className="w-full border rounded p-2 text-sm bg-gray-50"
              value={searchParams.get('verification_status') || ''}
              onChange={(e) => updateUrl('verification_status', e.target.value)}
            >
              <option value="">All</option>
              <option value="UNVERIFIED">Unverified</option>
              <option value="PENDING">Pending</option>
              <option value="VERIFIED">Verified</option>
            </select>
          </div>
          <button
            onClick={() => router.push(pathname)}
            className="px-4 py-2 text-sm text-gray-600 border border-gray-300 rounded hover:text-red-600 hover:bg-red-50"
          >
            Clear Filters
          </button>
        </div>
      </div>

      <div className="bg-white rounded-lg shadow overflow-hidden mb-6">
        {isLoading ? (
          <div className="p-8 text-center text-gray-500">Loading guardians...</div>
        ) : guardians.length === 0 ? (
          <div className="p-8 text-center text-gray-500">No guardians found for your municipality.</div>
        ) : (
          <table className="min-w-full divide-y divide-gray-200">
            <thead className="bg-gray-50">
              <tr>
                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Guardian</th>
                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Linked Youth</th>
                <th className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">Actions</th>
              </tr>
            </thead>
            <tbody className="bg-white divide-y divide-gray-200">
              {guardians.map((guardian) => (
                <tr key={guardian.id}>
                  <td className="px-6 py-4 whitespace-nowrap">
                    <div className="flex items-center">
                      {guardian.avatar && !avatarErrors.has(guardian.id) ? (
                        <img
                          src={getMediaUrl(guardian.avatar) || ''}
                          alt="Avatar"
                          className="w-10 h-10 rounded-full object-cover mr-3"
                          onError={() =>
                            setAvatarErrors((prev) => {
                              const next = new Set(prev);
                              next.add(guardian.id);
                              return next;
                            })
                          }
                        />
                      ) : (
                        <div className={`w-10 h-10 rounded-full ${getAvatarColor()} flex items-center justify-center font-semibold text-sm mr-3`}>
                          {getInitials(guardian.first_name, guardian.last_name)}
                        </div>
                      )}
                      <div>
                        <div className="text-sm font-medium text-gray-900">{guardian.first_name} {guardian.last_name}</div>
                        <div className="text-xs text-gray-500">{guardian.email}</div>
                      </div>
                    </div>
                  </td>
                  <td className="px-6 py-4 whitespace-nowrap">
                    <span
                      className={`px-2 py-1 text-xs font-bold rounded-full ${
                        guardian.verification_status === 'VERIFIED'
                          ? 'bg-green-100 text-green-800'
                          : guardian.verification_status === 'PENDING'
                          ? 'bg-yellow-100 text-yellow-800'
                          : 'bg-gray-100 text-gray-600'
                      }`}
                    >
                      {guardian.verification_status || 'UNVERIFIED'}
                    </span>
                  </td>
                  <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
                    <span className="font-semibold">{guardian.youth_members ? guardian.youth_members.length : 0}</span> linked
                  </td>
                  <td className="px-6 py-4 whitespace-nowrap text-right text-sm space-x-4">
                    <Link href={`/admin/municipality/guardians/${guardian.id}`} className="text-purple-600 font-bold">
                      View
                    </Link>
                    <button onClick={() => handleOpenEdit(guardian)} className="text-indigo-600 font-bold">
                      Edit
                    </button>
                    <button onClick={() => handleDeleteClick(guardian)} className="text-red-600">
                      Delete
                    </button>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        )}
      </div>

      <div className="flex items-center justify-between border-t border-gray-200 bg-white px-4 py-3 sm:px-6 rounded-lg shadow">
        <div className="text-sm text-gray-600">Total guardians: {totalCount}</div>
        <div className="flex items-center gap-2">
          <button
            disabled={currentPage === 1}
            onClick={() => updateUrl('page', (currentPage - 1).toString())}
            className="px-3 py-1 rounded border text-sm disabled:opacity-50"
          >
            Previous
          </button>
          <span className="text-sm text-gray-600">
            Page {currentPage} of {totalPages}
          </span>
          <button
            disabled={currentPage >= totalPages}
            onClick={() => updateUrl('page', (currentPage + 1).toString())}
            className="px-3 py-1 rounded border text-sm disabled:opacity-50"
          >
            Next
          </button>
        </div>
      </div>

      {showModal && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-xl shadow-2xl w-full max-w-2xl p-8 max-h-[90vh] overflow-y-auto">
            <h2 className="text-2xl font-bold mb-6 text-gray-800">{isEditing ? 'Edit Guardian' : 'Create Guardian'}</h2>
            <form onSubmit={handleSubmit} className="space-y-6">
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <input
                  required
                  type="text"
                  placeholder="First Name"
                  className="border p-2 rounded"
                  value={formData.first_name}
                  onChange={(e) => setFormData({ ...formData, first_name: e.target.value })}
                />
                <input
                  required
                  type="text"
                  placeholder="Last Name"
                  className="border p-2 rounded"
                  value={formData.last_name}
                  onChange={(e) => setFormData({ ...formData, last_name: e.target.value })}
                />
                <input
                  required
                  type="email"
                  placeholder="Email"
                  className="border p-2 rounded"
                  value={formData.email}
                  onChange={(e) => setFormData({ ...formData, email: e.target.value })}
                />
                <input
                  type="password"
                  placeholder={isEditing ? 'New Password (optional)' : 'Password'}
                  className="border p-2 rounded"
                  required={!isEditing}
                  value={formData.password}
                  onChange={(e) => setFormData({ ...formData, password: e.target.value })}
                />
                <input
                  type="text"
                  placeholder="Phone Number"
                  className="border p-2 rounded"
                  value={formData.phone_number}
                  onChange={(e) => setFormData({ ...formData, phone_number: e.target.value })}
                />
                <select
                  className="border p-2 rounded"
                  value={formData.legal_gender}
                  onChange={(e) => setFormData({ ...formData, legal_gender: e.target.value })}
                >
                  <option value="MALE">Male</option>
                  <option value="FEMALE">Female</option>
                  <option value="OTHER">Other</option>
                </select>
              </div>

              <div className="bg-purple-50 p-4 rounded-lg border border-purple-100">
                <label className="block text-sm font-bold text-purple-800 mb-2">Verification Status</label>
                <div className="flex gap-4">
                  {['UNVERIFIED', 'PENDING', 'VERIFIED'].map((status) => (
                    <label key={status} className="flex items-center space-x-2 text-sm font-medium">
                      <input
                        type="radio"
                        name="verification_status"
                        value={status}
                        checked={formData.verification_status === status}
                        onChange={(e) => setFormData({ ...formData, verification_status: e.target.value })}
                      />
                      <span>{status}</span>
                    </label>
                  ))}
                </div>
              </div>

              <div>
                <label className="block text-sm font-bold mb-2">Assign Youth Members</label>
                {formData.youth_members.length > 0 && (
                  <div className="flex flex-wrap gap-2 mb-3 p-3 bg-blue-50 rounded-lg border border-blue-200">
                    {getSelectedYouth().map((youth) => (
                      <span
                        key={youth.id}
                        className="inline-flex items-center gap-1.5 px-3 py-1.5 bg-blue-600 text-white text-sm rounded-full font-medium"
                      >
                        {youth.first_name} {youth.last_name} {youth.grade ? `(Gr ${youth.grade})` : ''}
                        <button
                          type="button"
                          onClick={() => removeYouth(youth.id)}
                          className="hover:bg-blue-700 rounded-full p-0.5"
                        >
                          <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                          </svg>
                        </button>
                      </span>
                    ))}
                  </div>
                )}

                <div className="relative mb-4">
                  <input
                    type="text"
                    placeholder="Search youth members..."
                    value={youthSearchTerm}
                    onChange={(e) => {
                      setYouthSearchTerm(e.target.value);
                      setShowYouthDropdown(true);
                    }}
                    onFocus={() => setShowYouthDropdown(true)}
                    className="w-full border border-gray-300 rounded-lg p-2.5 pr-10 focus:ring-2 focus:ring-purple-500 focus:border-purple-500"
                  />
                  <svg
                    className="absolute right-3 top-1/2 transform -translate-y-1/2 w-5 h-5 text-gray-400 pointer-events-none"
                    fill="none"
                    stroke="currentColor"
                    viewBox="0 0 24 24"
                  >
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                  </svg>

                  {showYouthDropdown && (
                    <>
                      <div className="fixed inset-0 z-10" onClick={() => setShowYouthDropdown(false)}></div>
                      <div className="absolute z-20 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-60 overflow-y-auto">
                        {filteredYouth.length > 0 ? (
                          filteredYouth.map((y) => (
                            <button
                              key={y.id}
                              type="button"
                              onClick={() => toggleYouth(y.id)}
                              className="w-full text-left px-4 py-2.5 hover:bg-purple-50 transition-colors border-b border-gray-100 last:border-b-0"
                            >
                              <div className="font-medium text-gray-900">{y.first_name} {y.last_name}</div>
                              <div className="text-xs text-gray-500">{y.email} {y.grade ? `‚Ä¢ Gr ${y.grade}` : ''}</div>
                            </button>
                          ))
                        ) : youthSearchTerm ? (
                          <div className="px-4 py-3 text-sm text-gray-500 text-center">
                            No youth found for "{youthSearchTerm}"
                          </div>
                        ) : (
                          <div className="px-4 py-3 text-sm text-gray-500 text-center">
                            {formData.youth_members.length === 0 ? 'No youth available.' : 'All youth already selected.'}
                          </div>
                        )}
                      </div>
                    </>
                  )}
                </div>
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">Avatar</label>
                <input type="file" accept="image/*" className="w-full border p-2 rounded" onChange={handleAvatarChange} />
                {avatarPreview && <img src={avatarPreview} alt="Preview" className="w-16 h-16 mt-2 rounded-full object-cover border" />}
              </div>

              <CustomFieldsForm
                targetRole="GUARDIAN"
                context="USER_PROFILE"
                values={customFieldValues}
                onChange={(fieldId, value) => {
                  setCustomFieldValues((prev) => ({
                    ...prev,
                    [fieldId]: value,
                  }));
                }}
                userId={isEditing ? editUserId : null}
                userMunicipalityId={user?.assigned_municipality ? (typeof user.assigned_municipality === 'object' ? user.assigned_municipality.id : user.assigned_municipality) : null}
                userClubId={null}
              />

              <div className="flex justify-end gap-4 pt-4 border-t">
                <button type="button" onClick={() => setShowModal(false)} className="text-gray-500">
                  Cancel
                </button>
                <button type="submit" className="bg-purple-600 text-white px-6 py-2 rounded-lg">
                  {isEditing ? 'Save Changes' : 'Create Guardian'}
                </button>
              </div>
            </form>
          </div>
        </div>
      )}

      {/* Delete Confirmation Modal */}
      <DeleteConfirmationModal
        isVisible={showDeleteModal}
        onClose={() => {
          if (!isDeleting) {
            setShowDeleteModal(false);
            setUserToDelete(null);
          }
        }}
        onConfirm={handleDeleteConfirm}
        itemName={userToDelete?.name}
        isLoading={isDeleting}
      />

      <Toast
        message={toast.message}
        type={toast.type}
        isVisible={toast.isVisible}
        onClose={() => setToast({ ...toast, isVisible: false })}
      />
    </div>
  );
}

export default function ManageMunicipalityGuardiansPage() {
  return (
    <Suspense fallback={<div>Loading...</div>}>
      <ManageMunicipalityGuardiansPageContent />
    </Suspense>
  );
}

--- END OF FILE: ./frontend/app/admin/municipality/guardians/page.tsx ---


--- START OF FILE: ./frontend/app/admin/municipality/guardians/[id]/page.tsx ---
'use client';

import { useState, useEffect, Suspense } from 'react';
import { useRouter, useParams } from 'next/navigation';
import Link from 'next/link';
import api from '../../../../../lib/api';
import { getMediaUrl } from '../../../../utils';
import CustomFieldsDisplay from '../../../../components/CustomFieldsDisplay';

interface YouthOption {
  id: number;
  first_name: string;
  last_name: string;
  email: string;
  grade: number | null;
}

function MunicipalityGuardianViewContent() {
  const router = useRouter();
  const params = useParams();
  const guardianId = params?.id as string;

  const [guardian, setGuardian] = useState<any>(null);
  const [youthList, setYouthList] = useState<YouthOption[]>([]);
  const [isLoading, setIsLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);

  useEffect(() => {
    if (guardianId) {
      fetchData();
    }
  }, [guardianId]);

  const fetchData = async () => {
    setIsLoading(true);
    setError(null);
    try {
      const userRes = await api.get(`/users/${guardianId}/`);
      setGuardian(userRes.data);

      const youthRes = await api.get('/users/list_youth/');
      setYouthList(Array.isArray(youthRes.data) ? youthRes.data : []);
    } catch (err: any) {
      setError(err?.response?.status === 404 ? 'Guardian not found or access denied.' : 'Failed to load guardian');
    } finally {
      setIsLoading(false);
    }
  };

  if (isLoading) {
    return (
      <div className="p-8 text-center">
        <p className="text-gray-500">Loading guardian...</p>
      </div>
    );
  }

  if (error || !guardian) {
    return (
      <div className="p-8">
        <div className="bg-red-50 border border-red-200 rounded-lg p-4 mb-4">
          <p className="text-red-800">{error || 'Guardian not found.'}</p>
        </div>
        <Link href="/admin/municipality/guardians" className="text-purple-600 hover:text-purple-800 font-semibold">
          ‚Üê Back to Guardians
        </Link>
      </div>
    );
  }

  const youthIds = guardian.youth_members || [];

  return (
    <div className="p-8 space-y-6">
      <div className="flex items-center justify-between">
        <Link href="/admin/municipality/guardians" className="text-purple-600 hover:text-purple-800 font-semibold">
          ‚Üê Back to Guardians
        </Link>
        <button
          onClick={() => router.push(`/admin/municipality/guardians?edit=${guardian.id}`)}
          className="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 shadow"
        >
          Edit Guardian
        </button>
      </div>

      <section className="bg-white rounded-2xl shadow-xl p-8">
        <div className="flex flex-col md:flex-row md:items-center gap-6 border-b pb-6">
          {guardian.avatar && (
            <img
              src={getMediaUrl(guardian.avatar) || ''}
              alt={`${guardian.first_name} ${guardian.last_name}`}
              className="w-32 h-32 rounded-full object-cover border-4 border-purple-100"
              onError={(e) => ((e.target as HTMLImageElement).style.display = 'none')}
            />
          )}
          <div>
            <p className="text-sm text-purple-500 uppercase font-semibold">Guardian Profile</p>
            <h1 className="text-3xl font-bold text-gray-900 mt-1">
              {guardian.first_name} {guardian.last_name}
            </h1>
            <p className="text-gray-600 mt-2">{guardian.email}</p>
            <div className="flex items-center gap-3 mt-3">
              <span className={`px-3 py-1 text-xs font-bold rounded-full ${
                guardian.verification_status === 'VERIFIED'
                  ? 'bg-green-100 text-green-700'
                  : guardian.verification_status === 'PENDING'
                  ? 'bg-yellow-100 text-yellow-700'
                  : 'bg-gray-100 text-gray-600'
              }`}>
                {guardian.verification_status || 'UNVERIFIED'}
              </span>
              {guardian.phone_number && <span className="text-sm text-gray-600">üìû {guardian.phone_number}</span>}
            </div>
          </div>
        </div>
      </section>

      <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <div className="lg:col-span-2 space-y-6">
          <section className="bg-white rounded-2xl shadow p-6">
            <h2 className="text-xl font-bold text-gray-800 mb-4">Basic Information</h2>
            <div className="grid grid-cols-2 gap-4 text-sm">
              <div>
                <p className="text-gray-500 font-semibold uppercase text-xs mb-1">First Name</p>
                <p className="text-gray-900">{guardian.first_name || '-'}</p>
              </div>
              <div>
                <p className="text-gray-500 font-semibold uppercase text-xs mb-1">Last Name</p>
                <p className="text-gray-900">{guardian.last_name || '-'}</p>
              </div>
              <div>
                <p className="text-gray-500 font-semibold uppercase text-xs mb-1">Email</p>
                <p className="text-gray-900">{guardian.email || '-'}</p>
              </div>
              <div>
                <p className="text-gray-500 font-semibold uppercase text-xs mb-1">Phone Number</p>
                <p className="text-gray-900">{guardian.phone_number || '-'}</p>
              </div>
              <div>
                <p className="text-gray-500 font-semibold uppercase text-xs mb-1">Legal Gender</p>
                <p className="text-gray-900">{guardian.legal_gender || '-'}</p>
              </div>
            </div>
          </section>

          <section className="bg-white rounded-2xl shadow p-6">
            <h2 className="text-xl font-bold text-gray-800 mb-4">Connected Youth Members</h2>
            {youthIds.length === 0 ? (
              <p className="text-gray-500">No youth members connected to this guardian.</p>
            ) : (
              <div className="space-y-3">
                {youthIds.map((yid: number) => {
                  const youth = youthList.find((y) => y.id === yid);
                  if (!youth) return null;
                  return (
                    <div key={yid} className="p-3 border rounded-lg bg-gray-50">
                      <p className="text-sm font-semibold text-gray-900">
                        {youth.first_name} {youth.last_name} {youth.grade ? `(Grade ${youth.grade})` : ''}
                      </p>
                      <p className="text-xs text-gray-500">{youth.email}</p>
                    </div>
                  );
                })}
              </div>
            )}
          </section>

          {/* CUSTOM FIELDS */}
          <CustomFieldsDisplay
            userId={guardian.id}
            targetRole="GUARDIAN"
            context="USER_PROFILE"
          />
        </div>

        <aside className="space-y-6">
          <section className="bg-white rounded-2xl shadow p-6">
            <h3 className="text-lg font-bold text-gray-800 mb-3">Account Information</h3>
            <div className="space-y-3 text-sm text-gray-700">
              <div>
                <p className="text-xs text-gray-500 font-semibold uppercase">Date Joined</p>
                <p>{guardian.date_joined ? new Date(guardian.date_joined).toLocaleDateString() : '-'}</p>
              </div>
              <div>
                <p className="text-xs text-gray-500 font-semibold uppercase">Last Login</p>
                <p>{guardian.last_login ? new Date(guardian.last_login).toLocaleDateString() : 'Never'}</p>
              </div>
              <div>
                <p className="text-xs text-gray-500 font-semibold uppercase">Preferred Language</p>
                <p>{guardian.preferred_language || '-'}</p>
              </div>
              <div>
                <p className="text-xs text-gray-500 font-semibold uppercase">Account Status</p>
                <span
                  className={`px-2 py-1 rounded text-xs font-bold ${
                    guardian.is_active ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'
                  }`}
                >
                  {guardian.is_active ? 'Active' : 'Inactive'}
                </span>
              </div>
            </div>
          </section>

          <section className="bg-white rounded-2xl shadow p-6 space-y-2">
            <button
              onClick={() => router.push(`/admin/municipality/guardians?edit=${guardian.id}`)}
              className="w-full bg-purple-600 text-white py-2 rounded-lg font-semibold hover:bg-purple-700"
            >
              Edit Guardian
            </button>
            <Link
              href="/admin/municipality/guardians"
              className="block w-full text-center bg-gray-100 text-gray-700 py-2 rounded-lg font-semibold hover:bg-gray-200"
            >
              Back to List
            </Link>
          </section>
        </aside>
      </div>
    </div>
  );
}

export default function MunicipalityGuardianViewPage() {
  return (
    <Suspense fallback={<div className="p-8 text-center">Loading...</div>}>
      <MunicipalityGuardianViewContent />
    </Suspense>
  );
}

--- END OF FILE: ./frontend/app/admin/municipality/guardians/[id]/page.tsx ---


--- START OF FILE: ./frontend/app/admin/municipality/profile/page.tsx ---
'use client';

import { Suspense, useEffect, useState } from 'react';
import api from '../../../../lib/api';
import { getMediaUrl } from '../../../utils';
import Toast from '../../../components/Toast';
import { useAuth } from '../../../../context/AuthContext';

interface ProfileForm {
  first_name: string;
  last_name: string;
  email: string;
  phone_number: string;
  preferred_language: string;
  profession: string;
  nickname: string;
  hide_contact_info: boolean;
  password: string;
}

interface LoginHistoryItem {
  id: number;
  timestamp: string;
  ip_address: string | null;
  user_agent: string;
}

const formatRole = (role?: string) => {
  if (!role) return 'Unknown';
  return role
    .toLowerCase()
    .split('_')
    .map((word) => word.charAt(0).toUpperCase() + word.slice(1))
    .join(' ');
};

const formatDateTime = (value: string | null | undefined) => {
  if (!value) return 'Never';
  return new Date(value).toLocaleString(undefined, {
    year: 'numeric',
    month: 'short',
    day: 'numeric',
    hour: '2-digit',
    minute: '2-digit',
  });
};

function MunicipalityProfileContent() {
  const { user, loading } = useAuth();
  const [profile, setProfile] = useState<ProfileForm>({
    first_name: '',
    last_name: '',
    email: '',
    phone_number: '',
    preferred_language: 'sv',
    profession: '',
    nickname: '',
    hide_contact_info: false,
    password: '',
  });
  const [avatarPreview, setAvatarPreview] = useState<string | null>(null);
  const [avatarFile, setAvatarFile] = useState<File | null>(null);
  const [assignedMunicipalityName, setAssignedMunicipalityName] = useState<string>('');
  const [lastLogin, setLastLogin] = useState<string | null>(null);
  const [loginHistory, setLoginHistory] = useState<LoginHistoryItem[]>([]);
  const [isSaving, setIsSaving] = useState(false);
  const [toast, setToast] = useState<{ message: string; type: 'success' | 'error'; isVisible: boolean }>({
    message: '',
    type: 'success',
    isVisible: false,
  });

  useEffect(() => {
    if (!user?.id) return;

    const loadProfile = async () => {
      try {
        const res = await api.get(`/users/${user.id}/`);
        const data = res.data;
        setProfile({
          first_name: data.first_name || '',
          last_name: data.last_name || '',
          email: data.email || '',
          phone_number: data.phone_number || '',
          preferred_language: data.preferred_language || 'sv',
          profession: data.profession || '',
          nickname: data.nickname || '',
          hide_contact_info: data.hide_contact_info ?? false,
          password: '',
        });
        setAvatarPreview(data.avatar ? getMediaUrl(data.avatar) : null);
        setLastLogin(data.last_login || null);

        if (data.assigned_municipality) {
          try {
            const muniRes = await api.get(`/municipalities/${data.assigned_municipality}/`);
            setAssignedMunicipalityName(muniRes.data?.name || `#${data.assigned_municipality}`);
          } catch {
            setAssignedMunicipalityName(`#${data.assigned_municipality}`);
          }
        }
      } catch (err) {
        console.error('Failed to load profile', err);
      }
    };

    const loadLoginHistory = async () => {
      try {
        const res = await api.get('/users/login_history/');
        setLoginHistory(res.data || []);
      } catch (err) {
        console.error('Failed to load login history', err);
      }
    };

    loadProfile();
    loadLoginHistory();
  }, [user?.id]);

  const handleChange = (field: keyof ProfileForm, value: string | boolean) => {
    setProfile((prev) => ({ ...prev, [field]: value }));
  };

  const handleAvatarChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (file) {
      setAvatarFile(file);
      const reader = new FileReader();
      reader.onloadend = () => setAvatarPreview(reader.result as string);
      reader.readAsDataURL(file);
    }
  };

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    if (!user?.id) return;

    setIsSaving(true);
    try {
      const formData = new FormData();
      Object.entries(profile).forEach(([key, value]) => {
        if (key === 'password' && !value) return;
        formData.append(key, typeof value === 'boolean' ? String(value) : value);
      });
      if (avatarFile) {
        formData.append('avatar', avatarFile);
      }
      formData.append('role', 'MUNICIPALITY_ADMIN');

      await api.patch(`/users/${user.id}/`, formData, {
        headers: { 'Content-Type': 'multipart/form-data' },
      });
      setToast({ message: 'Profile updated successfully!', type: 'success', isVisible: true });
      setProfile((prev) => ({ ...prev, password: '' }));
    } catch (err) {
      console.error('Failed to update profile', err);
      setToast({ message: 'Failed to update profile.', type: 'error', isVisible: true });
    } finally {
      setIsSaving(false);
    }
  };

  if (loading || !user) {
    return <div className="p-8 text-center text-gray-500">Loading profile...</div>;
  }

  const latestLoginTimestamp = loginHistory.length > 0 ? loginHistory[0].timestamp : lastLogin;

  return (
    <div className="space-y-8">
      <div>
        <p className="text-sm text-purple-500 uppercase font-semibold">Municipality Admin</p>
        <h1 className="text-3xl font-bold text-gray-900">My Profile</h1>
        <p className="text-gray-600 mt-1">Update your personal information and review your recent login activity.</p>
      </div>

      <div className="grid grid-cols-1 xl:grid-cols-3 gap-6">
        <div className="xl:col-span-2 bg-white rounded-2xl shadow p-6">
          <h2 className="text-xl font-bold text-gray-800 mb-4">Profile Details</h2>
          <form onSubmit={handleSubmit} className="space-y-6">
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label className="block text-sm font-semibold text-gray-700 mb-1">First Name</label>
                <input
                  type="text"
                  className="w-full border rounded-lg p-2"
                  value={profile.first_name}
                  onChange={(e) => handleChange('first_name', e.target.value)}
                  required
                />
              </div>
              <div>
                <label className="block text-sm font-semibold text-gray-700 mb-1">Last Name</label>
                <input
                  type="text"
                  className="w-full border rounded-lg p-2"
                  value={profile.last_name}
                  onChange={(e) => handleChange('last_name', e.target.value)}
                  required
                />
              </div>
              <div>
                <label className="block text-sm font-semibold text-gray-700 mb-1">Email</label>
                <input
                  type="email"
                  className="w-full border rounded-lg p-2"
                  value={profile.email}
                  onChange={(e) => handleChange('email', e.target.value)}
                  required
                />
              </div>
              <div>
                <label className="block text-sm font-semibold text-gray-700 mb-1">Phone Number</label>
                <input
                  type="text"
                  className="w-full border rounded-lg p-2"
                  value={profile.phone_number}
                  onChange={(e) => handleChange('phone_number', e.target.value)}
                />
              </div>
              <div>
                <label className="block text-sm font-semibold text-gray-700 mb-1">Preferred Language</label>
                <select
                  className="w-full border rounded-lg p-2"
                  value={profile.preferred_language}
                  onChange={(e) => handleChange('preferred_language', e.target.value)}
                >
                  <option value="sv">Swedish</option>
                  <option value="en">English</option>
                  <option value="fi">Finnish</option>
                </select>
              </div>
              <div>
                <label className="block text-sm font-semibold text-gray-700 mb-1">Profession / Title</label>
                <input
                  type="text"
                  className="w-full border rounded-lg p-2"
                  value={profile.profession}
                  onChange={(e) => handleChange('profession', e.target.value)}
                />
              </div>
              <div>
                <label className="block text-sm font-semibold text-gray-700 mb-1">Nickname</label>
                <input
                  type="text"
                  className="w-full border rounded-lg p-2"
                  value={profile.nickname}
                  onChange={(e) => handleChange('nickname', e.target.value)}
                />
              </div>
              <div>
                <label className="block text-sm font-semibold text-gray-700 mb-1">New Password</label>
                <input
                  type="password"
                  className="w-full border rounded-lg p-2"
                  placeholder="Leave blank to keep current"
                  value={profile.password}
                  onChange={(e) => handleChange('password', e.target.value)}
                />
              </div>
            </div>

            <div className="flex items-center gap-3">
              <input
                id="hide_contact"
                type="checkbox"
                className="h-4 w-4 text-purple-600"
                checked={profile.hide_contact_info}
                onChange={(e) => handleChange('hide_contact_info', e.target.checked)}
              />
              <label htmlFor="hide_contact" className="text-sm text-gray-700">
                Hide my contact info from public listings
              </label>
            </div>

            <div>
              <label className="block text-sm font-semibold text-gray-700 mb-1">Assigned Municipality</label>
              <input
                type="text"
                className="w-full border rounded-lg p-2 bg-gray-100"
                value={assignedMunicipalityName || 'Not assigned'}
                disabled
              />
            </div>

            <div>
              <label className="block text-sm font-semibold text-gray-700 mb-1">Avatar</label>
              <input type="file" accept="image/*" onChange={handleAvatarChange} />
              {avatarPreview && (
                <img src={avatarPreview} alt="Avatar preview" className="w-20 h-20 rounded-full object-cover mt-3" />
              )}
            </div>

            <div className="flex justify-end gap-4 pt-4 border-t">
              <button
                type="submit"
                className="bg-purple-600 text-white px-6 py-2 rounded-lg hover:bg-purple-700 disabled:opacity-50"
                disabled={isSaving}
              >
                {isSaving ? 'Saving...' : 'Save Changes'}
              </button>
            </div>
          </form>
        </div>

        <div className="space-y-6">
        <div className="bg-white rounded-2xl shadow p-6">
          <h3 className="text-lg font-bold text-gray-800 mb-4">Account Summary</h3>
          <div className="space-y-3 text-sm text-gray-700">
            <div className="flex justify-between">
              <span className="text-gray-500">Role</span>
              <span className="font-semibold">{formatRole(user.role)}</span>
            </div>
            <div className="flex justify-between">
              <span className="text-gray-500">Last Login</span>
              <span className="font-semibold">
                {formatDateTime(latestLoginTimestamp)}
              </span>
            </div>
          </div>
        </div>

          <div className="bg-white rounded-2xl shadow p-6">
            <h3 className="text-lg font-bold text-gray-800 mb-4">Recent Logins</h3>
            {loginHistory.length === 0 ? (
              <p className="text-sm text-gray-500">No login history recorded yet.</p>
            ) : (
              <ul className="space-y-3 text-sm">
                {loginHistory.map((entry) => (
                  <li key={entry.id} className="border-b pb-2 last:border-b-0">
                    <span className="font-semibold text-gray-900">
                      {formatDateTime(entry.timestamp)}
                    </span>
                  </li>
                ))}
              </ul>
            )}
          </div>
        </div>
      </div>

      <Toast
        message={toast.message}
        type={toast.type}
        isVisible={toast.isVisible}
        onClose={() => setToast({ ...toast, isVisible: false })}
      />
    </div>
  );
}

export default function MunicipalityProfilePage() {
  return (
    <Suspense fallback={<div className="p-8 text-center">Loading profile...</div>}>
      <MunicipalityProfileContent />
    </Suspense>
  );
}

--- END OF FILE: ./frontend/app/admin/municipality/profile/page.tsx ---


--- START OF FILE: ./frontend/app/admin/municipality/news-feed/page.tsx ---
'use client';

import NewsFeed from '../../../components/NewsFeed';

export default function MunicipalityAdminNewsFeed() {
  return (
    <div className="max-w-7xl mx-auto">
      <div className="mb-8">
        <h1 className="text-3xl font-bold text-gray-900">News Feed</h1>
        <p className="text-gray-500">Latest updates and featured stories.</p>
      </div>
      
      {/* We simply render the component here */}
      <NewsFeed basePath="/admin/municipality/news-feed" />
    </div>
  );
}


--- END OF FILE: ./frontend/app/admin/municipality/news-feed/page.tsx ---


--- START OF FILE: ./frontend/app/admin/municipality/news-feed/archive/page.tsx ---
'use client';

import Link from 'next/link';
import NewsArchive from '../../../../components/NewsArchive';

export default function MunicipalityAdminNewsArchive() {
  return (
    <div className="max-w-7xl mx-auto">
      <div className="mb-8 flex items-center gap-4">
        <Link 
          href="/admin/municipality/news-feed"
          className="p-2 rounded-full bg-white shadow-sm border border-gray-200 text-gray-500 hover:text-blue-600 transition"
        >
          <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 19l-7-7m0 0l7-7m-7 7h18" />
          </svg>
        </Link>
        <div>
          <h1 className="text-3xl font-bold text-gray-900">News Archive</h1>
          <p className="text-gray-500">Browse all published articles.</p>
        </div>
      </div>
      
      {/* Pass the base path and publishedOnly flag so cards link correctly and filtering works */}
      <NewsArchive basePath="/admin/municipality/news-feed" publishedOnly={true} />
    </div>
  );
}


--- END OF FILE: ./frontend/app/admin/municipality/news-feed/archive/page.tsx ---


--- START OF FILE: ./frontend/app/admin/municipality/news-feed/[id]/page.tsx ---
'use client';

import { useParams } from 'next/navigation';
import NewsArticleReader from '../../../../components/NewsArticleReader';

export default function MunicipalityAdminArticlePage() {
  const params = useParams();
  const id = params?.id as string;

  return (
    <NewsArticleReader 
      articleId={id} 
      backLink="/admin/municipality/news-feed" 
    />
  );
}


--- END OF FILE: ./frontend/app/admin/municipality/news-feed/[id]/page.tsx ---


--- START OF FILE: ./frontend/app/admin/municipality/custom-fields/page.tsx ---
'use client';

import CustomFieldManager from '../../../components/CustomFieldManager';

export default function MunicipalityCustomFieldsPage() {
  return (
    <div className="max-w-7xl mx-auto">
      <div className="mb-8">
        <h1 className="text-3xl font-bold text-gray-900">Municipality Fields</h1>
        <p className="text-gray-500">
          Create fields applicable to clubs within your municipality. You can limit specific fields to specific clubs.
        </p>
      </div>
      
      <CustomFieldManager scope="MUNICIPALITY" />
    </div>
  );
}
--- END OF FILE: ./frontend/app/admin/municipality/custom-fields/page.tsx ---


--- START OF FILE: ./frontend/app/dashboard/youth/page.tsx ---
'use client';

import { useAuth } from '../../../context/AuthContext';

export default function YouthDashboard() {
  const { user, logout } = useAuth();

  return (
    <div className="min-h-screen bg-gray-100 p-10">
      <div className="flex justify-between items-center mb-8">
        <h1 className="text-3xl font-bold text-blue-500">My Youth Dashboard</h1>
        <div className="flex gap-4 items-center">
          <span className="text-gray-600">Hi, {user?.first_name}!</span>
          <button onClick={logout} className="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">
            Logout
          </button>
        </div>
      </div>
      <div className="bg-white p-6 rounded-lg shadow">
        <p>Check into events, view your interests, and see what's happening!</p>
      </div>
    </div>
  );
}
--- END OF FILE: ./frontend/app/dashboard/youth/page.tsx ---


--- START OF FILE: ./frontend/app/dashboard/guardian/page.tsx ---
'use client';

import { useAuth } from '../../../context/AuthContext';

export default function GuardianDashboard() {
  const { user, logout } = useAuth();

  return (
    <div className="min-h-screen bg-gray-100 p-10">
      <div className="flex justify-between items-center mb-8">
        <h1 className="text-3xl font-bold text-orange-600">Parent Portal</h1>
        <div className="flex gap-4 items-center">
          <span className="text-gray-600">Welcome, {user?.first_name}</span>
          <button onClick={logout} className="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">
            Logout
          </button>
        </div>
      </div>
      <div className="bg-white p-6 rounded-lg shadow">
        <p>Manage your connected youth members and approve events here.</p>
      </div>
    </div>
  );
}
--- END OF FILE: ./frontend/app/dashboard/guardian/page.tsx ---


--- START OF FILE: ./frontend/app/components/SystemAlert.tsx ---
'use client';

import { useState, useEffect } from 'react';
import { usePathname } from 'next/navigation'; 
import api from '../../lib/api';
import { useAuth } from '../../context/AuthContext';

export default function SystemAlert() {
  const { user } = useAuth();
  const [msg, setMsg] = useState<any>(null);
  const [isVisible, setIsVisible] = useState(false);
  const pathname = usePathname();

  useEffect(() => {
    if (user) {
      checkMessage();
    } else {
      setIsVisible(false);
    }
  }, [pathname, user]);

  const checkMessage = async () => {
    try {
      const res = await api.get('/messages/my_latest/');
      const message = res.data;

      // Handle null or empty response
      if (!message || (typeof message === 'object' && Object.keys(message).length === 0)) {
        setIsVisible(false);
        setMsg(null);
        return;
      }

      // CHECK DISMISSAL LOGIC
      const isClosed = localStorage.getItem(`closed_msg_${message.id}`);
      
      // If it's sticky, we show it regardless of history.
      // If it's NOT sticky and was closed, we hide it.
      if (!message.is_sticky && isClosed) {
        setIsVisible(false);
        setMsg(null);
      } else {
        setMsg(message);
        setIsVisible(true);
      }
    } catch (err: any) {
      // Silently fail - don't show errors for missing messages
      // Only log actual errors (not 404s or empty responses)
      if (err?.response?.status !== 404) {
        console.error('Error fetching system message:', err);
      }
      setIsVisible(false);
      setMsg(null);
    }
  };

  const handleDismiss = () => {
    if (!msg) return;
    setIsVisible(false);
    // Remember that this specific message ID was closed
    localStorage.setItem(`closed_msg_${msg.id}`, 'true');
  };

  if (!isVisible || !msg) return null;

  // Theme Configuration
  const themes = {
    INFO: { bg: 'bg-blue-600', icon: '‚ÑπÔ∏è', border: 'border-blue-700' },
    IMPORTANT: { bg: 'bg-orange-500', icon: 'üì¢', border: 'border-orange-600' },
    WARNING: { bg: 'bg-red-600', icon: '‚ö†Ô∏è', border: 'border-red-700' },
  };

  const theme = themes[msg.message_type as keyof typeof themes] || themes.INFO;

  return (
    <div className={`${theme.bg} text-white relative z-50 shadow-md`}>
      <div className="max-w-7xl mx-auto px-4 py-3 flex items-start justify-between gap-4">
        
        {/* Message Content */}
        <div className="flex items-center gap-3 flex-1">
          <span className="text-xl">{theme.icon}</span>
          <div className="text-sm">
            <span className="font-bold uppercase tracking-wide mr-2 opacity-90">
              {msg.title}:
            </span>
            <span className="font-medium opacity-95">
              {msg.message}
            </span>
            {msg.external_link && (
              <a 
                href={msg.external_link} 
                target="_blank" 
                rel="noopener noreferrer"
                className="ml-3 underline hover:text-gray-200 font-bold"
              >
                Read More ‚Üí
              </a>
            )}
          </div>
        </div>

        {/* Close Button */}
        <button 
          onClick={handleDismiss}
          className="text-white/70 hover:text-white hover:bg-black/10 rounded p-1 transition"
          title="Dismiss message"
        >
          ‚úï
        </button>
      </div>
    </div>
  );
}
--- END OF FILE: ./frontend/app/components/SystemAlert.tsx ---


--- START OF FILE: ./frontend/app/components/NewsArticleReader.tsx ---
'use client';

import { useState, useEffect } from 'react';
import Link from 'next/link';
import api from '../../lib/api';
import { getMediaUrl } from '../../app/utils';

interface NewsArticleReaderProps {
  articleId: string;
  backLink: string; // Where the "Back" button goes
}

export default function NewsArticleReader({ articleId, backLink }: NewsArticleReaderProps) {
  const [article, setArticle] = useState<any>(null);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState('');

  useEffect(() => {
    const fetchArticle = async () => {
      try {
        const res = await api.get(`/news/${articleId}/`);
        setArticle(res.data);
      } catch (err: any) {
        setError('Article not found or access denied.');
        console.error(err);
      } finally {
        setLoading(false);
      }
    };

    if (articleId) fetchArticle();
  }, [articleId]);

  if (loading) return <div className="p-10 text-center text-gray-500">Loading article...</div>;
  
  if (error || !article) {
    return (
      <div className="p-10">
        <div className="bg-red-50 text-red-600 p-4 rounded-lg mb-4">{error}</div>
        <Link href={backLink} className="text-blue-600 hover:underline">‚Üê Go Back</Link>
      </div>
    );
  }

  return (
    <div className="max-w-4xl mx-auto pb-20">
      {/* Navigation */}
      <div className="mb-6">
        <Link href={backLink} className="text-gray-500 hover:text-gray-900 font-semibold transition flex items-center gap-2">
          <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 19l-7-7m0 0l7-7m-7 7h18" /></svg>
          Back to Feed
        </Link>
      </div>

      <article className="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
        {/* Hero Image */}
        {article.hero_image && (
          <div className="h-64 md:h-96 w-full relative bg-gray-100">
            <img 
              src={getMediaUrl(article.hero_image) || ''} 
              alt={article.title} 
              className="w-full h-full object-cover"
            />
            <div className="absolute inset-0 bg-gradient-to-t from-black/60 to-transparent" />
            <div className="absolute bottom-0 left-0 p-8">
               <h1 className="text-3xl md:text-5xl font-bold text-white leading-tight text-shadow-md">
                {article.title}
              </h1>
            </div>
          </div>
        )}

        <div className="p-8 md:p-12">
          {/* No hero image fallback title */}
          {!article.hero_image && (
             <h1 className="text-4xl font-bold text-gray-900 mb-8">{article.title}</h1>
          )}

          {/* Meta Data */}
          <div className="flex flex-wrap items-center gap-4 text-sm text-gray-500 mb-8 border-b border-gray-100 pb-8">
            <div className="flex items-center gap-2">
              <div className="w-8 h-8 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center font-bold">
                {article.author_name?.charAt(0) || 'A'}
              </div>
              <span className="font-medium text-gray-900">{article.author_name}</span>
            </div>
            <span>‚Ä¢</span>
            <span>{new Date(article.published_at).toLocaleDateString()}</span>
            
            <div className="ml-auto flex gap-2">
              {article.tags_details?.map((tag: any) => (
                <span key={tag.id} className="bg-gray-100 text-gray-600 px-2 py-1 rounded text-xs font-bold uppercase">
                  {tag.name}
                </span>
              ))}
            </div>
          </div>

          {/* Main Content - HTML Rendered Here */}
          <div 
            className="news-content"
            dangerouslySetInnerHTML={{ __html: article.content }} 
          />
        </div>
      </article>
    </div>
  );
}
--- END OF FILE: ./frontend/app/components/NewsArticleReader.tsx ---


--- START OF FILE: ./frontend/app/components/NewsFeed.tsx ---
'use client';

import { useState, useEffect } from 'react';
import Link from 'next/link';
import api from '../../lib/api';
import { getMediaUrl } from '../../app/utils';

interface Tag {
  id: number;
  name: string;
  slug: string;
}

interface Article {
  id: number;
  title: string;
  excerpt: string;
  hero_image: string | null;
  author_name: string;
  published_at: string;
  tags_details: Tag[];
}

// New Interface for Props
interface NewsFeedProps {
  basePath: string; // e.g., "/admin/super/news-feed" or "/dashboard/youth/news"
}

export default function NewsFeed({ basePath }: NewsFeedProps) {
  const [hero, setHero] = useState<Article | null>(null);
  const [articles, setArticles] = useState<Article[]>([]);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    const fetchData = async () => {
      try {
        const [heroRes, listRes] = await Promise.all([
          api.get('/news/hero/?published_only=true'),
          api.get('/news/?exclude_hero=true&published_only=true&page_size=10')
        ]);

        setHero(heroRes.data || null);
        const listData = Array.isArray(listRes.data) ? listRes.data : listRes.data.results;
        setArticles(listData || []);
      } catch (err) {
        console.error('Failed to load news', err);
      } finally {
        setLoading(false);
      }
    };

    fetchData();
  }, []);

  const formatDate = (dateString: string) => {
    return new Date(dateString).toLocaleDateString('en-US', {
      year: 'numeric', month: 'long', day: 'numeric',
    });
  };

  if (loading) {
    return <div className="p-8 text-center text-gray-500 animate-pulse">Loading latest news...</div>;
  }

  return (
    <div className="space-y-12">
      
      {/* --- HERO SECTION --- */}
      {hero && hero.hero_image && (
        <section className="relative group rounded-3xl overflow-hidden shadow-xl bg-gray-900 aspect-[16/9] md:aspect-[21/9]">
          <img 
            src={getMediaUrl(hero.hero_image) || ''} 
            alt={hero.title} 
            className="absolute inset-0 w-full h-full object-cover opacity-70 group-hover:scale-105 transition-transform duration-700"
          />
          <div className="absolute inset-0 bg-gradient-to-t from-black/90 via-black/30 to-transparent" />

          <div className="absolute bottom-0 left-0 p-8 md:p-12 max-w-4xl">
            <div className="flex flex-wrap gap-2 mb-4">
              {hero.tags_details.map(tag => (
                <span key={tag.id} className="bg-blue-600 text-white text-xs font-bold px-3 py-1 rounded-full uppercase tracking-wide">
                  {tag.name}
                </span>
              ))}
            </div>
            <h2 className="text-3xl md:text-5xl font-bold text-white mb-4 leading-tight text-shadow-sm">
              {hero.title}
            </h2>
            <p className="text-gray-200 text-lg md:text-xl mb-6 line-clamp-2">
              {hero.excerpt}
            </p>
            <div className="flex items-center gap-4">
              <Link 
                // UPDATED LINK
                href={`${basePath}/${hero.id}`} 
                className="bg-white text-gray-900 px-6 py-3 rounded-lg font-bold hover:bg-gray-100 transition shadow-lg"
              >
                Read Full Article
              </Link>
              <span className="text-gray-400 text-sm font-medium hidden md:inline-block">
                {formatDate(hero.published_at)} ‚Ä¢ By {hero.author_name}
              </span>
            </div>
          </div>
        </section>
      )}

      {/* --- RECENT NEWS GRID --- */}
      <section>
        <div className="flex items-center justify-between mb-6">
          <h3 className="text-2xl font-bold text-gray-800">Recent Stories</h3>
          <Link href={`${basePath}/archive`} className="text-blue-600 font-semibold hover:underline">
            View Archive ‚Üí
          </Link>
        </div>

        {articles.length === 0 ? (
          <div className="p-8 text-center bg-white rounded-xl border border-dashed border-gray-300 text-gray-500">
            No recent news available.
          </div>
        ) : (
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
            {articles.map(article => (
              <article key={article.id} className="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden hover:shadow-xl transition flex flex-col h-full">
                <div className="h-48 overflow-hidden relative bg-gray-100">
                  {article.hero_image ? (
                    <img 
                      src={getMediaUrl(article.hero_image) || ''} 
                      alt={article.title} 
                      className="w-full h-full object-cover hover:scale-105 transition-transform duration-500"
                    />
                  ) : (
                    <div className="flex items-center justify-center h-full text-gray-400">No Image</div>
                  )}
                </div>

                <div className="p-6 flex flex-col flex-grow">
                  <div className="flex flex-wrap gap-2 mb-3">
                    {article.tags_details.map(tag => (
                      <span key={tag.id} className="text-xs font-semibold text-blue-600 bg-blue-50 px-2 py-1 rounded">
                        #{tag.name}
                      </span>
                    ))}
                  </div>
                  
                  <h4 className="text-xl font-bold text-gray-900 mb-2 line-clamp-2">{article.title}</h4>
                  <p className="text-gray-600 text-sm mb-4 line-clamp-3 flex-grow">{article.excerpt}</p>
                  
                  <div className="pt-4 border-t border-gray-100 flex items-center justify-between mt-auto">
                    <span className="text-xs text-gray-500 font-medium">{formatDate(article.published_at)}</span>
                    <Link 
                      // UPDATED LINK
                      href={`${basePath}/${article.id}`} 
                      className="text-sm font-bold text-blue-600 hover:text-blue-800"
                    >
                      Read More &rarr;
                    </Link>
                  </div>
                </div>
              </article>
            ))}
          </div>
        )}
      </section>
    </div>
  );
}
--- END OF FILE: ./frontend/app/components/NewsFeed.tsx ---


--- START OF FILE: ./frontend/app/components/CustomFieldsDisplay.tsx ---
'use client';

import { useState, useEffect } from 'react';
import api from '../../lib/api';

interface CustomField {
  id: number;
  name: string;
  help_text: string;
  field_type: 'TEXT' | 'SINGLE_SELECT' | 'MULTI_SELECT' | 'BOOLEAN';
  options: string[];
  required: boolean;
  context: 'USER_PROFILE' | 'EVENT';
  target_roles: string[];
  value?: any;
}

interface CustomFieldsDisplayProps {
  userId: number;
  targetRole: 'YOUTH_MEMBER' | 'GUARDIAN';
  context?: 'USER_PROFILE' | 'EVENT';
}

export default function CustomFieldsDisplay({
  userId,
  targetRole,
  context = 'USER_PROFILE',
}: CustomFieldsDisplayProps) {
  const [fields, setFields] = useState<CustomField[]>([]);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    fetchFields();
  }, [userId, targetRole, context]);

  const fetchFields = async () => {
    setLoading(true);
    try {
      // Fetch all custom fields - the backend will filter based on admin's scope
      const res = await api.get('/custom-fields/');
      const allFields = Array.isArray(res.data.results) ? res.data.results : (Array.isArray(res.data) ? res.data : []);
      
      // Filter by context and target role
      const applicableFields = allFields.filter((field: CustomField) => {
        // Must match context
        if (field.context !== context) return false;
        
        // Must target this role (or "ALL")
        const targetRoles = Array.isArray(field.target_roles) ? field.target_roles : [];
        if (!targetRoles.includes('ALL') && !targetRoles.includes(targetRole)) return false;
        
        return true;
      });

      // Fetch values for this user
      const userRes = await api.get(`/users/${userId}/`);
      const customFieldValuesData = userRes.data.custom_field_values || [];
      const valuesMap: Record<number, any> = {};
      customFieldValuesData.forEach((cfv: any) => {
        valuesMap[cfv.field] = cfv.value;
      });

      // Attach values to fields
      const fieldsWithValues = applicableFields.map((field: CustomField) => ({
        ...field,
        value: valuesMap[field.id],
      }));

      // Only show fields that have values
      setFields(fieldsWithValues.filter((field) => field.value !== null && field.value !== undefined && field.value !== ''));
    } catch (err) {
      console.error('Failed to fetch custom fields:', err);
      setFields([]);
    } finally {
      setLoading(false);
    }
  };

  const formatValue = (field: CustomField, value: any): string => {
    if (value === null || value === undefined || value === '') return '-';
    
    if (field.field_type === 'BOOLEAN') {
      return value ? 'Yes' : 'No';
    }
    
    if (field.field_type === 'MULTI_SELECT') {
      if (Array.isArray(value)) {
        return value.join(', ');
      }
      return String(value);
    }
    
    return String(value);
  };

  if (loading) {
    return null;
  }

  if (fields.length === 0) {
    return null;
  }

  return (
    <div className="bg-white rounded-xl shadow p-6">
      <h2 className="text-2xl font-bold text-gray-800 mb-4">Additional Information</h2>
      <div className="grid grid-cols-2 gap-4">
        {fields.map((field) => (
          <div key={field.id}>
            <p className="text-sm text-gray-500 font-bold uppercase mb-1">{field.name}</p>
            <p className="text-gray-900 font-medium">{formatValue(field, field.value)}</p>
            {field.help_text && (
              <p className="text-xs text-gray-400 mt-0.5">{field.help_text}</p>
            )}
          </div>
        ))}
      </div>
    </div>
  );
}


--- END OF FILE: ./frontend/app/components/CustomFieldsDisplay.tsx ---


--- START OF FILE: ./frontend/app/components/GroupForm.tsx ---
'use client';

import { useState, useEffect } from 'react';
import { useRouter } from 'next/navigation';
import api from '../../lib/api';
import Toast from './Toast';
import MemberSelector from './MemberSelector';
import CustomRuleBuilder from './CustomRuleBuilder';

interface Interest {
  id: number;
  name: string;
}

interface GroupFormProps {
  initialData?: any; // If provided, we are in "Edit Mode"
  redirectPath: string; // Where to go after saving
}

const GRADES = Array.from({ length: 13 }, (_, i) => i + 1); // [1, 2, ... 12, 13]
const GENDERS = [
  { value: 'MALE', label: 'Male' },
  { value: 'FEMALE', label: 'Female' },
  { value: 'OTHER', label: 'Other' },
];

export default function GroupForm({ initialData, redirectPath }: GroupFormProps) {
  const router = useRouter();
  const [loading, setLoading] = useState(false);
  const [interestsList, setInterestsList] = useState<Interest[]>([]);
  const [toast, setToast] = useState({ message: '', type: 'success' as 'success'|'error', isVisible: false });

  // Form State
  const [formData, setFormData] = useState({
    name: '',
    description: '',
    group_type: 'OPEN',
    target_member_type: 'YOUTH',
    min_age: '',
    max_age: '',
    grades: [] as number[],
    genders: [] as string[],
    interests: [] as number[],
    custom_field_rules: {} as Record<string, any>, // NEW: Custom Fields
    members_to_add: [] as number[],
  });

  useEffect(() => {
    // 1. Fetch Interests
    api.get('/interests/').then(res => {
      const data = Array.isArray(res.data) ? res.data : res.data.results;
      setInterestsList(data || []);
    });

    // 2. Load Initial Data (if editing)
    if (initialData) {
      setFormData({
        name: initialData.name,
        description: initialData.description,
        group_type: initialData.group_type,
        target_member_type: initialData.target_member_type,
        min_age: initialData.min_age || '',
        max_age: initialData.max_age || '',
        grades: initialData.grades || [],
        genders: initialData.genders || [],
        interests: initialData.interests || [],
        custom_field_rules: initialData.custom_field_rules || {}, // Load existing rules
        members_to_add: [],
      });
    }
  }, [initialData]);

  // --- Handlers ---

  const toggleGrade = (grade: number) => {
    setFormData(prev => {
      const exists = prev.grades.includes(grade);
      if (exists) return { ...prev, grades: prev.grades.filter(g => g !== grade) };
      return { ...prev, grades: [...prev.grades, grade].sort((a, b) => a - b) };
    });
  };

  const toggleGender = (gender: string) => {
    setFormData(prev => {
      const exists = prev.genders.includes(gender);
      if (exists) return { ...prev, genders: prev.genders.filter(g => g !== gender) };
      return { ...prev, genders: [...prev.genders, gender] };
    });
  };

  const toggleInterest = (id: number) => {
    setFormData(prev => {
      const exists = prev.interests.includes(id);
      if (exists) return { ...prev, interests: prev.interests.filter(i => i !== id) };
      return { ...prev, interests: [...prev.interests, id] };
    });
  };

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setLoading(true);

    const payload = {
      ...formData,
      min_age: formData.min_age ? parseInt(formData.min_age as string) : null,
      max_age: formData.max_age ? parseInt(formData.max_age as string) : null,
    };

    try {
      if (initialData) {
        // Update
        await api.patch(`/groups/${initialData.id}/`, payload);
        setToast({ message: 'Group updated successfully!', type: 'success', isVisible: true });
      } else {
        // Create
        await api.post('/groups/', payload);
        setToast({ message: 'Group created successfully!', type: 'success', isVisible: true });
      }
      
      // Delay redirect slightly to show toast
      setTimeout(() => {
        router.push(redirectPath);
      }, 1000);

    } catch (err) {
      console.error(err);
      setToast({ message: 'Operation failed. Please check your inputs.', type: 'error', isVisible: true });
      setLoading(false);
    }
  };

  return (
    <form onSubmit={handleSubmit} className="space-y-8 bg-white p-8 rounded-xl shadow-sm border border-gray-100 max-w-4xl mx-auto">
      
      {/* SECTION 1: BASIC INFO */}
      <div className="space-y-4">
        <h3 className="text-lg font-bold text-gray-900 border-b pb-2">1. Basic Information</h3>
        
        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <label className="block text-sm font-bold mb-1">Group Name</label>
            <input 
              required
              type="text"
              className="w-full border p-2.5 rounded-lg"
              placeholder="e.g. Summer Football Camp"
              value={formData.name}
              onChange={e => setFormData({...formData, name: e.target.value})}
            />
          </div>
          <div>
            <label className="block text-sm font-bold mb-1">Group Type</label>
            <select 
              className="w-full border p-2.5 rounded-lg"
              value={formData.group_type}
              onChange={e => setFormData({...formData, group_type: e.target.value})}
            >
              <option value="OPEN">Open (Join Freely)</option>
              <option value="APPLICATION">Application Required</option>
              <option value="CLOSED">Closed (Invite Only)</option>
            </select>
          </div>
        </div>

        <div>
          <label className="block text-sm font-bold mb-1">Description</label>
          <textarea 
            rows={3}
            className="w-full border p-2.5 rounded-lg"
            placeholder="Describe what this group is about..."
            value={formData.description}
            onChange={e => setFormData({...formData, description: e.target.value})}
          />
        </div>
      </div>

      {/* SECTION 2: TARGETING RULES */}
      <div className="space-y-6">
        <h3 className="text-lg font-bold text-gray-900 border-b pb-2">2. Membership Rules</h3>
        
        {/* Member Type */}
        <div>
          <label className="block text-sm font-bold mb-2">Target Audience</label>
          <div className="flex gap-4">
            <label className="flex items-center gap-2 cursor-pointer border p-3 rounded-lg hover:bg-gray-50 flex-1">
              <input 
                type="radio" 
                name="member_type"
                value="YOUTH"
                checked={formData.target_member_type === 'YOUTH'}
                onChange={e => setFormData({...formData, target_member_type: e.target.value})}
                className="w-5 h-5 text-indigo-600"
              />
              <span className="font-bold">Youth Members</span>
            </label>
            <label className="flex items-center gap-2 cursor-pointer border p-3 rounded-lg hover:bg-gray-50 flex-1">
              <input 
                type="radio" 
                name="member_type"
                value="GUARDIAN"
                checked={formData.target_member_type === 'GUARDIAN'}
                onChange={e => setFormData({...formData, target_member_type: e.target.value})}
                className="w-5 h-5 text-indigo-600"
              />
              <span className="font-bold">Guardians</span>
            </label>
          </div>
        </div>

        {/* Age Range */}
        <div className="grid grid-cols-2 gap-6">
          <div>
            <label className="block text-sm font-bold mb-1">Min Age</label>
            <input 
              type="number" min="0" max="100"
              className="w-full border p-2.5 rounded-lg"
              placeholder="Any"
              value={formData.min_age}
              onChange={e => setFormData({...formData, min_age: e.target.value})}
            />
          </div>
          <div>
            <label className="block text-sm font-bold mb-1">Max Age</label>
            <input 
              type="number" min="0" max="100"
              className="w-full border p-2.5 rounded-lg"
              placeholder="Any"
              value={formData.max_age}
              onChange={e => setFormData({...formData, max_age: e.target.value})}
            />
          </div>
        </div>

        {/* Grades (Only if Youth) */}
        {formData.target_member_type === 'YOUTH' && (
          <div>
            <label className="block text-sm font-bold mb-2">Allowed Grades</label>
            <div className="flex flex-wrap gap-2">
              {GRADES.map(grade => (
                <button
                  key={grade}
                  type="button"
                  onClick={() => toggleGrade(grade)}
                  className={`w-10 h-10 rounded-full font-bold text-sm transition
                    ${formData.grades.includes(grade) 
                      ? 'bg-indigo-600 text-white shadow-md' 
                      : 'bg-white border border-gray-200 text-gray-600 hover:border-indigo-300'}
                  `}
                >
                  {grade}
                </button>
              ))}
            </div>
            {formData.grades.length === 0 && <p className="text-xs text-gray-400 mt-1">Leave empty to allow all grades.</p>}
          </div>
        )}

        {/* Gender */}
        <div>
          <label className="block text-sm font-bold mb-2">Allowed Genders</label>
          <div className="flex gap-4">
            {GENDERS.map(g => (
              <label key={g.value} className="flex items-center gap-2 cursor-pointer">
                <input 
                  type="checkbox"
                  checked={formData.genders.includes(g.value)}
                  onChange={() => toggleGender(g.value)}
                  className="w-4 h-4 text-indigo-600 rounded"
                />
                <span className="text-sm">{g.label}</span>
              </label>
            ))}
          </div>
          {formData.genders.length === 0 && <p className="text-xs text-gray-400 mt-1">Leave empty to allow all genders.</p>}
        </div>

        {/* Interests */}
        <div>
          <label className="block text-sm font-bold mb-2">Required Interests</label>
          <div className="flex flex-wrap gap-2 max-h-40 overflow-y-auto border p-4 rounded-lg bg-gray-50">
            {interestsList.map(interest => (
              <button
                key={interest.id}
                type="button"
                onClick={() => toggleInterest(interest.id)}
                className={`px-3 py-1.5 rounded-full text-xs font-bold transition
                  ${formData.interests.includes(interest.id)
                    ? 'bg-purple-600 text-white'
                    : 'bg-white border border-gray-200 text-gray-600 hover:border-purple-300'}
                `}
              >
                {interest.name}
              </button>
            ))}
          </div>
          <p className="text-xs text-gray-400 mt-1">Users matching ANY of selected interests will be eligible.</p>
        </div>

        {/* NEW: CUSTOM FIELD RULES */}
        <div>
          <label className="block text-sm font-bold mb-2">Custom Field Rules</label>
          <p className="text-xs text-gray-500 mb-2">Members must match ALL these additional conditions.</p>
          <CustomRuleBuilder 
            currentRules={formData.custom_field_rules}
            onChange={(newRules) => setFormData(prev => ({...prev, custom_field_rules: newRules}))}
          />
        </div>
      </div>

      {/* SECTION 3: ADD MEMBERS */}
      <div className="space-y-4">
        <h3 className="text-lg font-bold text-gray-900 border-b pb-2">3. Add Members</h3>
        <p className="text-sm text-gray-600 mb-4">
          Select users to immediately add to this group. 
          The list below filters based on ALL the rules above (Age, Grade, Interests, Custom Fields).
        </p>
        
        <MemberSelector
          criteria={{
            target_member_type: formData.target_member_type,
            min_age: formData.min_age,
            max_age: formData.max_age,
            grades: formData.grades,
            genders: formData.genders,
            interests: formData.interests,
            // Pass the new rules
            custom_field_rules: formData.custom_field_rules
          }}
          selectedIds={formData.members_to_add}
          onChange={(ids) => setFormData(prev => ({ ...prev, members_to_add: ids }))}
          excludeGroupId={initialData?.id}
        />
      </div>

      {/* FOOTER */}
      <div className="flex justify-end gap-4 border-t pt-6">
        <button
          type="button"
          onClick={() => router.back()}
          className="px-6 py-2.5 rounded-lg text-gray-600 font-medium hover:bg-gray-100 transition"
        >
          Cancel
        </button>
        <button
          type="submit"
          disabled={loading}
          className="px-8 py-2.5 rounded-lg bg-indigo-600 text-white font-bold shadow-lg hover:bg-indigo-700 transition disabled:opacity-50"
        >
          {loading ? 'Saving...' : 'Save Group'}
        </button>
      </div>

      <Toast {...toast} onClose={() => setToast({...toast, isVisible: false})} />
    </form>
  );
}
--- END OF FILE: ./frontend/app/components/GroupForm.tsx ---


--- START OF FILE: ./frontend/app/components/RewardDetailView.tsx ---
'use client';

import { useState, useEffect } from 'react';
import Link from 'next/link';
import api from '../../lib/api';
import { getMediaUrl } from '../utils';

interface RewardDetailProps {
  rewardId: string;
  basePath: string; // e.g. "/admin/super/rewards"
}

export default function RewardDetailView({ rewardId, basePath }: RewardDetailProps) {
  const [reward, setReward] = useState<any>(null);
  const [analytics, setAnalytics] = useState<any>(null);
  const [history, setHistory] = useState<any[]>([]);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    if (rewardId) {
      fetchData();
    }
  }, [rewardId]);

  const fetchData = async () => {
    setLoading(true);
    try {
      const [rewardRes, statsRes, historyRes] = await Promise.all([
        api.get(`/rewards/${rewardId}/`),
        api.get(`/rewards/${rewardId}/analytics_detail/`),
        api.get(`/rewards/${rewardId}/history/`)
      ]);
      setReward(rewardRes.data);
      setAnalytics(statsRes.data);
      setHistory(historyRes.data.results || historyRes.data);
    } catch (err) {
      console.error(err);
    } finally {
      setLoading(false);
    }
  };

  if (loading) return <div className="p-12 text-center text-gray-500">Loading details...</div>;
  if (!reward) return <div className="p-12 text-center text-red-500">Reward not found.</div>;

  return (
    <div className="space-y-8">
      
      {/* 1. HEADER */}
      <div className="flex flex-col md:flex-row justify-between items-start gap-4">
        <div className="flex items-start gap-6">
          {/* Image */}
          <div className="w-24 h-24 bg-gray-100 rounded-xl overflow-hidden border flex-shrink-0">
            {reward.image ? (
              <img src={getMediaUrl(reward.image) || ''} className="w-full h-full object-cover" alt="Reward" />
            ) : (
              <div className="flex items-center justify-center h-full text-2xl">üéÅ</div>
            )}
          </div>
          
          {/* Title & Status */}
          <div>
            <div className="flex items-center gap-3 mb-1">
              <h1 className="text-3xl font-bold text-gray-900">{reward.name}</h1>
              {reward.is_active ? (
                <span className="bg-green-100 text-green-800 text-xs font-bold px-2 py-1 rounded">Active</span>
              ) : (
                <span className="bg-gray-100 text-gray-600 text-xs font-bold px-2 py-1 rounded">Inactive</span>
              )}
            </div>
            
            <p className="text-gray-500 text-sm mb-2">
              Owned by: <span className="font-semibold">{reward.municipality_name || reward.club_name || 'Super Admin'}</span>
            </p>

            <div className="flex gap-2">
              <Link href={`${basePath}/edit/${reward.id}`} className="bg-gray-100 text-gray-700 px-4 py-1.5 rounded-lg text-sm font-bold hover:bg-gray-200">
                Edit Reward
              </Link>
              <Link href={basePath} className="text-gray-500 px-4 py-1.5 rounded-lg text-sm font-bold hover:bg-gray-50">
                Back to List
              </Link>
            </div>
          </div>
        </div>
      </div>

      {/* 2. ANALYTICS GRID */}
      {analytics && (
        <div className="grid grid-cols-2 md:grid-cols-5 gap-4">
          <div className="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
            <p className="text-xs font-bold text-gray-500 uppercase">Total Claims</p>
            <p className="text-2xl font-bold text-blue-600">{analytics.total_uses}</p>
          </div>
          <div className="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
            <p className="text-xs font-bold text-gray-500 uppercase">Last 24h</p>
            <p className="text-2xl font-bold text-gray-900">{analytics.uses_last_24h}</p>
          </div>
          <div className="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
            <p className="text-xs font-bold text-gray-500 uppercase">Last 7 Days</p>
            <p className="text-2xl font-bold text-gray-900">{analytics.uses_last_7d}</p>
          </div>
          <div className="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
            <p className="text-xs font-bold text-gray-500 uppercase">Last 30 Days</p>
            <p className="text-2xl font-bold text-gray-900">{analytics.uses_last_30d}</p>
          </div>
          <div className="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
            <p className="text-xs font-bold text-gray-500 uppercase">Days Left</p>
            <p className="text-2xl font-bold text-orange-600">{analytics.days_remaining !== null ? analytics.days_remaining : '‚àû'}</p>
          </div>
        </div>
      )}

      <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
        
        {/* 3. LEFT COL: INFO & CONFIG */}
        <div className="lg:col-span-2 space-y-6">
          {/* Description */}
          <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
            <h3 className="text-lg font-bold text-gray-900 mb-4">About</h3>
            <p className="text-gray-700 whitespace-pre-wrap">{reward.description}</p>
            
            {(reward.sponsor_name || reward.sponsor_link) && (
              <div className="mt-4 pt-4 border-t border-gray-100">
                <p className="text-xs font-bold text-gray-500 uppercase">Sponsor</p>
                <p className="text-sm font-medium">
                  {reward.sponsor_name || 'Anonymous'} 
                  {reward.sponsor_link && (
                    <a href={reward.sponsor_link} target="_blank" className="ml-2 text-blue-600 hover:underline">
                      (Visit Website)
                    </a>
                  )}
                </p>
              </div>
            )}
          </div>

          {/* Usage History Table */}
          <div className="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
            <div className="p-6 border-b border-gray-100 flex justify-between items-center">
              <h3 className="text-lg font-bold text-gray-900">Claim History</h3>
              <span className="text-xs text-gray-500">Latest claims</span>
            </div>
            <table className="min-w-full divide-y divide-gray-200">
              <thead className="bg-gray-50">
                <tr>
                  <th className="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase">User</th>
                  <th className="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase">Email</th>
                  <th className="px-6 py-3 text-right text-xs font-bold text-gray-500 uppercase">Date Claimed</th>
                </tr>
              </thead>
              <tbody className="divide-y divide-gray-200">
                {history.map((usage) => (
                  <tr key={usage.id} className="hover:bg-gray-50">
                    <td className="px-6 py-4 text-sm font-medium text-gray-900">{usage.user_name}</td>
                    <td className="px-6 py-4 text-sm text-gray-500">{usage.user_email}</td>
                    <td className="px-6 py-4 text-sm text-gray-500 text-right">
                      {/* Show redeemed_at if available, otherwise fallback to created_at */}
                      {(() => {
                        const date = usage.redeemed_at ? new Date(usage.redeemed_at) : (usage.created_at ? new Date(usage.created_at) : null);
                        if (!date) return 'N/A';
                        const dateStr = date.toLocaleDateString();
                        const hours = String(date.getHours()).padStart(2, '0');
                        const minutes = String(date.getMinutes()).padStart(2, '0');
                        return `${dateStr} ${hours}:${minutes}`;
                      })()}
                    </td>
                  </tr>
                ))}
                {history.length === 0 && (
                  <tr>
                    <td colSpan={3} className="px-6 py-8 text-center text-gray-500">
                      No one has claimed this reward yet.
                    </td>
                  </tr>
                )}
              </tbody>
            </table>
          </div>
        </div>

        {/* 4. RIGHT COL: RULES */}
        <div className="space-y-6">
          
          {/* Target Rules */}
          <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
            <h3 className="text-lg font-bold text-gray-900 mb-4">Targeting Rules</h3>
            <div className="space-y-3 text-sm">
              <div>
                <span className="block text-gray-500 text-xs font-bold uppercase">Target Audience</span>
                <span className="font-medium">{reward.target_member_type === 'YOUTH_MEMBER' ? 'Youth Members' : 'Guardians'}</span>
              </div>
              
              <div>
                <span className="block text-gray-500 text-xs font-bold uppercase">Age Range</span>
                <span>{reward.min_age || 0} - {reward.max_age || 'Any'} years</span>
              </div>

              {reward.target_grades && reward.target_grades.length > 0 && (
                <div>
                  <span className="block text-gray-500 text-xs font-bold uppercase">Grades</span>
                  <span>{reward.target_grades.join(', ')}</span>
                </div>
              )}

              {reward.target_genders && reward.target_genders.length > 0 && (
                <div>
                  <span className="block text-gray-500 text-xs font-bold uppercase">Genders</span>
                  <span className="capitalize">{reward.target_genders.join(', ').toLowerCase()}</span>
                </div>
              )}

              {reward.target_groups_details && reward.target_groups_details.length > 0 && (
                <div>
                  <span className="block text-gray-500 text-xs font-bold uppercase mb-1">Specific Groups</span>
                  <div className="flex flex-wrap gap-1">
                    {reward.target_groups_details.map((g: any) => (
                      <span key={g.id} className="bg-blue-50 text-blue-700 px-2 py-0.5 rounded text-xs border border-blue-100">
                        {g.name}
                      </span>
                    ))}
                  </div>
                </div>
              )}
            </div>
          </div>

          {/* Active Triggers */}
          <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
            <h3 className="text-lg font-bold text-gray-900 mb-4">Active Triggers</h3>
            {reward.active_triggers && reward.active_triggers.length > 0 ? (
              <div className="space-y-2">
                {reward.active_triggers.map((t: string) => (
                  <div key={t} className="flex items-center gap-2 bg-green-50 text-green-800 px-3 py-2 rounded-lg border border-green-100">
                    <span>‚ö°</span>
                    <span className="font-bold text-sm">{t}</span>
                  </div>
                ))}
              </div>
            ) : (
              <p className="text-sm text-gray-500">No automatic triggers set. Manual claim only.</p>
            )}
          </div>

          {/* Limits */}
          <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
            <h3 className="text-lg font-bold text-gray-900 mb-4">Availability</h3>
            <div className="space-y-3 text-sm">
              <div>
                <span className="block text-gray-500 text-xs font-bold uppercase">Expires On</span>
                <span className={reward.expiration_date ? '' : 'text-gray-400'}>
                  {reward.expiration_date ? new Date(reward.expiration_date).toLocaleDateString() : 'No Expiration'}
                </span>
              </div>
              <div>
                <span className="block text-gray-500 text-xs font-bold uppercase">Usage Limit</span>
                <span>{reward.usage_limit ? `${reward.usage_limit} total claims` : 'Unlimited'}</span>
              </div>
            </div>
          </div>

        </div>
      </div>
    </div>
  );
}
--- END OF FILE: ./frontend/app/components/RewardDetailView.tsx ---


--- START OF FILE: ./frontend/app/components/NewsArchive.tsx ---
'use client';

import { useState, useEffect } from 'react';
import Link from 'next/link';
import api from '../../lib/api';
import { getMediaUrl } from '../../app/utils';

interface Tag { id: number; name: string; }
interface Article {
  id: number;
  title: string;
  excerpt: string;
  hero_image: string | null;
  author_name: string;
  published_at: string;
  tags_details: Tag[];
}

interface NewsArchiveProps {
  basePath: string; // e.g., "/admin/super/news-feed"
  publishedOnly?: boolean; // If true, only fetch published articles (for non-super-admin views)
}

export default function NewsArchive({ basePath, publishedOnly = false }: NewsArchiveProps) {
  // Data State
  const [articles, setArticles] = useState<Article[]>([]);
  const [tags, setTags] = useState<Tag[]>([]);
  const [totalCount, setTotalCount] = useState(0);
  const [isLoading, setIsLoading] = useState(true);

  // Filter State
  const [search, setSearch] = useState('');
  const [selectedTag, setSelectedTag] = useState('');
  const [sortOrder, setSortOrder] = useState('-published_at'); // Default: Newest first
  const [page, setPage] = useState(1);

  // Load Tags on mount
  useEffect(() => {
    api.get('/news_tags/').then(res => {
      setTags(Array.isArray(res.data) ? res.data : res.data.results || []);
    }).catch(console.error);
  }, []);

  // Fetch Articles whenever filters change
  useEffect(() => {
    fetchArticles();
    // Scroll to top on page change
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }, [page, selectedTag, sortOrder]); // Search is handled separately to prevent spamming while typing

  const fetchArticles = async () => {
    setIsLoading(true);
    try {
      const params = new URLSearchParams();
      params.set('page', page.toString());
      params.set('page_size', '10'); // Requirement: 10 news per list
      params.set('ordering', sortOrder);
      
      if (publishedOnly) params.set('published_only', 'true');
      if (search) params.set('search', search);
      if (selectedTag) params.set('tag', selectedTag);

      const res = await api.get(`/news/?${params.toString()}`);
      
      // Handle backend response (assuming PageNumberPagination)
      if (res.data.results) {
        setArticles(res.data.results);
        setTotalCount(res.data.count);
      } else {
        setArticles(res.data);
        setTotalCount(res.data.length);
      }
    } catch (err) {
      console.error(err);
    } finally {
      setIsLoading(false);
    }
  };

  // Handle Search (User must press Enter or click Search to avoid API spam)
  const handleSearchSubmit = (e: React.FormEvent) => {
    e.preventDefault();
    setPage(1); // Reset to page 1 on new search
    fetchArticles();
  };

  const formatDate = (dateString: string) => {
    return new Date(dateString).toLocaleDateString('en-US', {
      year: 'numeric', month: 'short', day: 'numeric',
    });
  };

  const totalPages = Math.ceil(totalCount / 10);

  return (
    <div className="max-w-7xl mx-auto pb-12">
      
      {/* --- FILTERS BAR --- */}
      <div className="bg-white rounded-xl shadow-sm border border-gray-100 p-4 mb-8">
        <form onSubmit={handleSearchSubmit} className="flex flex-wrap gap-4 items-end">
          
          {/* Search Input */}
          <div className="flex-1 min-w-[200px]">
            <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Search</label>
            <div className="relative">
              <input 
                type="text" 
                placeholder="Title, excerpt, or author..." 
                className="w-full border border-gray-300 rounded-lg p-2.5 pr-10 focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                value={search}
                onChange={(e) => setSearch(e.target.value)}
              />
              <button 
                type="submit"
                className="absolute right-2 top-1/2 -translate-y-1/2 text-gray-400 hover:text-blue-600"
              >
                üîç
              </button>
            </div>
          </div>

          {/* Tag Dropdown */}
          <div className="w-48">
            <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Tag</label>
            <select 
              className="w-full border border-gray-300 rounded-lg p-2.5 bg-white"
              value={selectedTag}
              onChange={(e) => { setSelectedTag(e.target.value); setPage(1); }}
            >
              <option value="">All Tags</option>
              {tags.map(tag => (
                <option key={tag.id} value={tag.id}>{tag.name}</option>
              ))}
            </select>
          </div>

          {/* Sort Dropdown */}
          <div className="w-48">
            <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Sort By</label>
            <select 
              className="w-full border border-gray-300 rounded-lg p-2.5 bg-white"
              value={sortOrder}
              onChange={(e) => { setSortOrder(e.target.value); setPage(1); }}
            >
              <option value="-published_at">Newest First</option>
              <option value="published_at">Oldest First</option>
              <option value="title">Title (A-Z)</option>
            </select>
          </div>

          {/* Clear Button */}
          <button 
            type="button"
            onClick={() => { setSearch(''); setSelectedTag(''); setSortOrder('-published_at'); setPage(1); }}
            className="px-4 py-2.5 text-sm text-gray-600 font-semibold hover:text-red-600 transition"
          >
            Clear
          </button>
        </form>
      </div>

      {/* --- ARTICLES LIST --- */}
      {isLoading ? (
        <div className="text-center py-20">
          <p className="text-gray-500 text-lg animate-pulse">Searching archives...</p>
        </div>
      ) : articles.length === 0 ? (
        <div className="text-center py-20 bg-white rounded-xl border border-dashed border-gray-300">
          <p className="text-gray-500">No articles found matching your filters.</p>
        </div>
      ) : (
        <div className="grid grid-cols-1 gap-6">
          {articles.map(article => (
            <article key={article.id} className="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden hover:shadow-md transition flex flex-col md:flex-row">
              {/* Image (Left on desktop, Top on mobile) */}
              <div className="md:w-64 h-48 md:h-auto relative flex-shrink-0 bg-gray-100">
                {article.hero_image ? (
                  <img 
                    src={getMediaUrl(article.hero_image) || ''} 
                    alt={article.title} 
                    className="w-full h-full object-cover"
                  />
                ) : (
                  <div className="flex items-center justify-center h-full text-gray-400">No Image</div>
                )}
              </div>

              {/* Content */}
              <div className="p-6 flex flex-col flex-grow">
                <div className="flex justify-between items-start mb-2">
                  <div className="flex flex-wrap gap-2">
                    {article.tags_details.map(tag => (
                      <span key={tag.id} className="text-xs font-bold text-blue-600 bg-blue-50 px-2 py-1 rounded">
                        {tag.name}
                      </span>
                    ))}
                  </div>
                  <span className="text-xs text-gray-500 whitespace-nowrap ml-2">
                    {formatDate(article.published_at)}
                  </span>
                </div>

                <h3 className="text-xl font-bold text-gray-900 mb-2">
                  <Link href={`${basePath}/${article.id}`} className="hover:text-blue-600 transition">
                    {article.title}
                  </Link>
                </h3>
                
                <p className="text-gray-600 text-sm mb-4 flex-grow">
                  {article.excerpt}
                </p>

                <div className="flex items-center justify-between pt-4 border-t border-gray-100 mt-auto">
                  <span className="text-xs text-gray-500 font-medium">By {article.author_name}</span>
                  <Link 
                    href={`${basePath}/${article.id}`} 
                    className="text-sm font-bold text-blue-600 hover:text-blue-800"
                  >
                    Read Full Article &rarr;
                  </Link>
                </div>
              </div>
            </article>
          ))}
        </div>
      )}

      {/* --- PAGINATION --- */}
      {totalCount > 0 && (
        <div className="flex items-center justify-between mt-8 border-t border-gray-200 pt-6">
          <p className="text-sm text-gray-600">
            Showing <span className="font-bold">{articles.length}</span> of <span className="font-bold">{totalCount}</span> articles
          </p>
          
          <div className="flex gap-2">
            <button
              disabled={page === 1}
              onClick={() => setPage(p => Math.max(1, p - 1))}
              className="px-4 py-2 rounded-lg border text-sm font-medium hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed"
            >
              Previous
            </button>
            <button
              disabled={page >= totalPages}
              onClick={() => setPage(p => p + 1)}
              className="px-4 py-2 rounded-lg border text-sm font-medium hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed"
            >
              Next
            </button>
          </div>
        </div>
      )}
    </div>
  );
}
--- END OF FILE: ./frontend/app/components/NewsArchive.tsx ---


--- START OF FILE: ./frontend/app/components/CustomRuleBuilder.tsx ---
'use client';

import { useState, useEffect } from 'react';
import api from '../../lib/api';

interface CustomField {
  id: number;
  name: string;
  field_type: 'TEXT' | 'SINGLE_SELECT' | 'MULTI_SELECT' | 'BOOLEAN';
  options: string[];
}

interface CustomRuleBuilderProps {
  currentRules: Record<string, any>; // { "1": "Value", "2": true }
  onChange: (rules: Record<string, any>) => void;
}

export default function CustomRuleBuilder({ currentRules, onChange }: CustomRuleBuilderProps) {
  const [fields, setFields] = useState<CustomField[]>([]);
  const [loading, setLoading] = useState(true);

  // New Rule State
  const [selectedFieldId, setSelectedFieldId] = useState<string>('');
  const [selectedValue, setSelectedValue] = useState<string>('');
  const [selectedBool, setSelectedBool] = useState<string>('true');

  useEffect(() => {
    // Fetch fields available to this admin
    api.get('/custom-fields/').then(res => {
      const data = Array.isArray(res.data) ? res.data : res.data.results;
      setFields(data || []);
      setLoading(false);
    });
  }, []);

  const handleAddRule = () => {
    if (!selectedFieldId) return;
    
    const field = fields.find(f => f.id.toString() === selectedFieldId);
    if (!field) return;

    let val: any = selectedValue;
    if (field.field_type === 'BOOLEAN') {
      val = selectedBool === 'true';
    }

    onChange({
      ...currentRules,
      [selectedFieldId]: val
    });

    // Reset input
    setSelectedValue('');
    setSelectedBool('true');
    setSelectedFieldId('');
  };

  const removeRule = (id: string) => {
    const newRules = { ...currentRules };
    delete newRules[id];
    onChange(newRules);
  };

  if (loading) return <div className="text-sm text-gray-500">Loading fields...</div>;
  if (fields.length === 0) return <div className="text-sm text-gray-400 italic">No custom fields defined.</div>;

  const selectedField = fields.find(f => f.id.toString() === selectedFieldId);

  return (
    <div className="space-y-4">
      
      {/* 1. Rule Creator */}
      <div className="flex flex-wrap gap-2 items-end bg-gray-50 p-3 rounded-lg border border-gray-200">
        
        {/* Select Field */}
        <div className="flex-1 min-w-[150px]">
          <label className="block text-xs font-bold text-gray-500 mb-1">Field</label>
          <select 
            className="w-full border p-2 rounded text-sm"
            value={selectedFieldId}
            onChange={e => { setSelectedFieldId(e.target.value); setSelectedValue(''); }}
          >
            <option value="">Select Field...</option>
            {fields.map(f => (
              <option key={f.id} value={f.id}>{f.name}</option>
            ))}
          </select>
        </div>

        {/* Input Value (Changes based on Type) */}
        <div className="flex-1 min-w-[150px]">
          <label className="block text-xs font-bold text-gray-500 mb-1">Condition (Must Match)</label>
          
          {!selectedField && <input disabled className="w-full border p-2 rounded text-sm bg-gray-100" placeholder="Select field first" />}

          {selectedField && selectedField.field_type === 'BOOLEAN' && (
            <select className="w-full border p-2 rounded text-sm" value={selectedBool} onChange={e => setSelectedBool(e.target.value)}>
              <option value="true">Yes (Checked)</option>
              <option value="false">No (Unchecked)</option>
            </select>
          )}

          {selectedField && (selectedField.field_type === 'SINGLE_SELECT' || selectedField.field_type === 'MULTI_SELECT') && (
            <select className="w-full border p-2 rounded text-sm" value={selectedValue} onChange={e => setSelectedValue(e.target.value)}>
              <option value="">Select Option...</option>
              {selectedField.options.map(opt => <option key={opt} value={opt}>{opt}</option>)}
            </select>
          )}

          {selectedField && selectedField.field_type === 'TEXT' && (
            <input 
              type="text" 
              className="w-full border p-2 rounded text-sm" 
              placeholder="Type value..."
              value={selectedValue}
              onChange={e => setSelectedValue(e.target.value)}
            />
          )}
        </div>

        {/* Add Button */}
        <button 
          type="button" 
          onClick={handleAddRule}
          disabled={!selectedFieldId}
          className="bg-indigo-600 text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-indigo-700 disabled:opacity-50 h-[38px]"
        >
          Add Rule
        </button>
      </div>

      {/* 2. Active Rules List */}
      {Object.keys(currentRules).length > 0 && (
        <div className="flex flex-wrap gap-2">
          {Object.entries(currentRules).map(([id, val]) => {
            const fieldName = fields.find(f => f.id.toString() === id)?.name || `Field #${id}`;
            let displayVal = val.toString();
            if (typeof val === 'boolean') displayVal = val ? 'Yes' : 'No';

            return (
              <span key={id} className="bg-blue-50 text-blue-700 border border-blue-200 px-3 py-1 rounded-full text-sm font-medium flex items-center gap-2">
                <span><b>{fieldName}</b> = {displayVal}</span>
                <button type="button" onClick={() => removeRule(id)} className="hover:text-red-600 font-bold">√ó</button>
              </span>
            );
          })}
        </div>
      )}
    </div>
  );
}
--- END OF FILE: ./frontend/app/components/CustomRuleBuilder.tsx ---


--- START OF FILE: ./frontend/app/components/GroupDetailView.tsx ---
'use client';

import { useState, useEffect } from 'react';
import Link from 'next/link';
import { useRouter } from 'next/navigation';
import api from '../../lib/api';
import Toast from './Toast';
import DeleteConfirmationModal from './DeleteConfirmationModal';

interface GroupDetailProps {
  groupId: string;
  basePath: string; // e.g. "/admin/super/groups"
}

export default function GroupDetailView({ groupId, basePath }: GroupDetailProps) {
  const router = useRouter();
  const [group, setGroup] = useState<any>(null);
  const [analytics, setAnalytics] = useState<any>(null);
  const [members, setMembers] = useState<any[]>([]);
  const [activeTab, setActiveTab] = useState<'DASHBOARD' | 'MEMBERS' | 'SETTINGS'>('DASHBOARD');
  const [loading, setLoading] = useState(true);
  
  // Actions
  const [toast, setToast] = useState({ message: '', type: 'success' as 'success'|'error', isVisible: false });
  const [memberToRemove, setMemberToRemove] = useState<number | null>(null);

  useEffect(() => {
    fetchData();
  }, [groupId]);

  const fetchData = async () => {
    setLoading(true);
    try {
      const [groupRes, analyticsRes, membersRes] = await Promise.all([
        api.get(`/groups/${groupId}/`),
        api.get(`/groups/${groupId}/analytics/`),
        api.get(`/groups/${groupId}/members/`)
      ]);
      setGroup(groupRes.data);
      setAnalytics(analyticsRes.data);
      setMembers(membersRes.data.results || membersRes.data);
    } catch (err) {
      console.error(err);
      setToast({ message: 'Failed to load group details.', type: 'error', isVisible: true });
    } finally {
      setLoading(false);
    }
  };

  const handleDuplicate = async () => {
    if (!confirm("Create a copy of this group?")) return;
    try {
      await api.post(`/groups/${groupId}/duplicate/`);
      setToast({ message: 'Group duplicated! Check the list.', type: 'success', isVisible: true });
      setTimeout(() => router.push(basePath), 1000);
    } catch (err) {
      setToast({ message: 'Failed to duplicate.', type: 'error', isVisible: true });
    }
  };

  const handleApproveMember = async (membershipId: number) => {
    try {
      await api.post(`/groups/${groupId}/approve_member/`, { membership_id: membershipId });
      setToast({ message: 'Member approved.', type: 'success', isVisible: true });
      fetchData(); // Refresh list
    } catch (err) {
      setToast({ message: 'Failed to approve.', type: 'error', isVisible: true });
    }
  };

  const handleRemoveMember = async () => {
    if (!memberToRemove) return;
    try {
      await api.post(`/groups/${groupId}/remove_member/`, { membership_id: memberToRemove });
      setToast({ message: 'Member removed.', type: 'success', isVisible: true });
      setMemberToRemove(null);
      fetchData();
    } catch (err) {
      setToast({ message: 'Failed to remove member.', type: 'error', isVisible: true });
    }
  };

  if (loading) return <div className="p-12 text-center text-gray-500">Loading group details...</div>;
  if (!group) return <div className="p-12 text-center text-red-500">Group not found.</div>;

  return (
    <div className="space-y-6">
      
      {/* HEADER */}
      <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-100 flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
        <div>
          <div className="flex items-center gap-3">
            <h1 className="text-3xl font-bold text-gray-900">{group.name}</h1>
            <span className={`px-2 py-1 rounded text-xs font-bold uppercase
              ${group.group_type === 'OPEN' ? 'bg-green-100 text-green-800' : 
                group.group_type === 'CLOSED' ? 'bg-gray-100 text-gray-800' : 'bg-blue-100 text-blue-800'}
            `}>
              {group.group_type}
            </span>
          </div>
          
          {/* NEW: Context Info (Club/Muni) */}
          <div className="flex items-center gap-2 mt-2 text-sm text-gray-600">
            {group.club_name && (
              <span className="flex items-center gap-1 bg-gray-50 px-2 py-1 rounded border border-gray-200">
                üè¢ <b>Club:</b> {group.club_name}
              </span>
            )}
            {group.municipality_name && (
              <span className="flex items-center gap-1 bg-gray-50 px-2 py-1 rounded border border-gray-200">
                üèõÔ∏è <b>Municipality:</b> {group.municipality_name}
              </span>
            )}
            {!group.club_name && !group.municipality_name && !group.is_system_group && (
              <span className="flex items-center gap-1 bg-gray-50 px-2 py-1 rounded border border-gray-200">
                üåç Global Group
              </span>
            )}
          </div>

          <p className="text-gray-500 mt-2">{group.description || 'No description provided.'}</p>
        </div>
        
        {/* Buttons remain the same */}
        <div className="flex gap-2">
          {!group.is_system_group && (
            <>
              <Link 
                href={`${basePath}/edit/${group.id}`}
                className="bg-gray-100 text-gray-700 px-4 py-2 rounded-lg font-medium hover:bg-gray-200"
              >
                Edit
              </Link>
              <button 
                onClick={handleDuplicate}
                className="bg-indigo-50 text-indigo-700 px-4 py-2 rounded-lg font-medium hover:bg-indigo-100"
              >
                Duplicate
              </button>
            </>
          )}
        </div>
      </div>

      {/* TABS */}
      <div className="border-b border-gray-200">
        <nav className="flex gap-6">
          {['DASHBOARD', 'MEMBERS', 'SETTINGS'].map((tab) => (
            <button
              key={tab}
              onClick={() => setActiveTab(tab as any)}
              className={`pb-4 px-2 text-sm font-medium border-b-2 transition-colors
                ${activeTab === tab 
                  ? 'border-indigo-600 text-indigo-600' 
                  : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'}
              `}
            >
              {tab.charAt(0) + tab.slice(1).toLowerCase()}
            </button>
          ))}
        </nav>
      </div>

      {/* DASHBOARD TAB */}
      {activeTab === 'DASHBOARD' && analytics && (
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
          <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
            <h3 className="text-gray-500 text-xs font-bold uppercase">Total Members</h3>
            <p className="text-3xl font-bold text-gray-900 mt-2">{analytics.total_members}</p>
          </div>
          <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
            <h3 className="text-gray-500 text-xs font-bold uppercase">New This Week</h3>
            <p className="text-3xl font-bold text-green-600 mt-2">+{analytics.new_this_week}</p>
          </div>
          
          {/* Gender Dist */}
          <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-100 col-span-1 md:col-span-2">
            <h3 className="text-gray-500 text-xs font-bold uppercase mb-4">Gender Distribution</h3>
            <div className="flex gap-4">
              {Object.entries(analytics.gender_distribution || {}).map(([key, val]: any) => (
                <div key={key} className="text-center bg-gray-50 p-3 rounded-lg min-w-[80px]">
                  <span className="block text-xl font-bold text-gray-800">{val}</span>
                  <span className="text-xs text-gray-500 uppercase">{key || 'Unset'}</span>
                </div>
              ))}
            </div>
          </div>

          {/* Grade Dist */}
          <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-100 col-span-1 md:col-span-4">
            <h3 className="text-gray-500 text-xs font-bold uppercase mb-4">Grade Distribution</h3>
            <div className="flex flex-wrap gap-3">
              {Object.entries(analytics.grade_distribution || {}).map(([grade, count]: any) => (
                <div key={grade} className="flex items-center gap-2 bg-indigo-50 px-3 py-1.5 rounded-full border border-indigo-100">
                  <span className="text-xs font-bold text-indigo-800">Grade {grade}</span>
                  <span className="bg-white text-indigo-600 px-2 py-0.5 rounded-full text-xs font-bold shadow-sm">{count}</span>
                </div>
              ))}
              {Object.keys(analytics.grade_distribution || {}).length === 0 && <p className="text-sm text-gray-400">No data available.</p>}
            </div>
          </div>
        </div>
      )}

      {/* MEMBERS TAB */}
      {activeTab === 'MEMBERS' && (
        <div className="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
          <table className="min-w-full divide-y divide-gray-200">
            <thead className="bg-gray-50">
              <tr>
                <th className="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase">Member</th>
                <th className="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase">Email</th>
                <th className="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase">Status</th>
                <th className="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase">Joined</th>
                <th className="px-6 py-3 text-right text-xs font-bold text-gray-500 uppercase">Actions</th>
              </tr>
            </thead>
            <tbody className="divide-y divide-gray-200">
              {members.map((m: any) => (
                <tr key={m.id} className="hover:bg-gray-50">
                  <td className="px-6 py-4">
                    <div className="flex items-center gap-3">
                      {m.user_avatar ? (
                        <img src={m.user_avatar} className="w-8 h-8 rounded-full object-cover" />
                      ) : (
                        <div className="w-8 h-8 bg-gray-200 rounded-full flex items-center justify-center text-xs font-bold">
                          {m.user_name.charAt(0)}
                        </div>
                      )}
                      <span className="font-medium text-gray-900">{m.user_name}</span>
                    </div>
                  </td>
                  <td className="px-6 py-4 text-sm text-gray-500">{m.user_email}</td>
                  <td className="px-6 py-4">
                    <span className={`px-2 py-1 rounded text-xs font-bold 
                      ${m.status === 'APPROVED' ? 'bg-green-100 text-green-800' : 
                        m.status === 'PENDING' ? 'bg-yellow-100 text-yellow-800' : 'bg-red-100 text-red-800'}
                    `}>
                      {m.status}
                    </span>
                  </td>
                  <td className="px-6 py-4 text-sm text-gray-500">
                    {new Date(m.joined_at).toLocaleDateString()}
                  </td>
                  <td className="px-6 py-4 text-right space-x-2">
                    {m.status === 'PENDING' && (
                      <button 
                        onClick={() => handleApproveMember(m.id)}
                        className="text-green-600 hover:text-green-800 font-bold text-xs uppercase"
                      >
                        Approve
                      </button>
                    )}
                    <button 
                      onClick={() => setMemberToRemove(m.id)}
                      className="text-red-600 hover:text-red-800 font-bold text-xs uppercase"
                    >
                      Remove
                    </button>
                  </td>
                </tr>
              ))}
              {members.length === 0 && (
                <tr>
                  <td colSpan={5} className="px-6 py-8 text-center text-gray-500">
                    No members in this group yet.
                  </td>
                </tr>
              )}
            </tbody>
          </table>
        </div>
      )}

      {/* SETTINGS TAB */}
      {activeTab === 'SETTINGS' && (
        <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
          <div className="grid grid-cols-2 gap-x-8 gap-y-4 text-sm">
            <div>
              <span className="block text-gray-500 font-bold uppercase text-xs">Target Audience</span>
              <span className="text-gray-900">{group.target_member_type === 'YOUTH' ? 'Youth Members' : 'Guardians'}</span>
            </div>
            <div>
              <span className="block text-gray-500 font-bold uppercase text-xs">Age Range</span>
              <span className="text-gray-900">
                {group.min_age || 0} - {group.max_age || 'Any'} years
              </span>
            </div>
            <div>
              <span className="block text-gray-500 font-bold uppercase text-xs">Allowed Grades</span>
              <span className="text-gray-900">
                {group.grades?.length > 0 ? group.grades.join(', ') : 'All Grades'}
              </span>
            </div>
            <div>
              <span className="block text-gray-500 font-bold uppercase text-xs">Allowed Genders</span>
              <span className="text-gray-900">
                {group.genders?.length > 0 ? group.genders.join(', ') : 'All Genders'}
              </span>
            </div>
            <div className="col-span-2">
              <span className="block text-gray-500 font-bold uppercase text-xs mb-2">Required Interests</span>
              <div className="flex flex-wrap gap-2">
                {group.interests_details?.map((i: any) => (
                  <span key={i.id} className="bg-purple-50 text-purple-700 px-2 py-1 rounded-md text-xs font-medium border border-purple-100">
                    {i.name}
                  </span>
                ))}
                {(!group.interests_details || group.interests_details.length === 0) && (
                  <span className="text-gray-400 italic">None</span>
                )}
              </div>
            </div>
          </div>
        </div>
      )}

      {/* MODALS */}
      <DeleteConfirmationModal
        isVisible={!!memberToRemove}
        onClose={() => setMemberToRemove(null)}
        onConfirm={handleRemoveMember}
        title="Remove Member"
        message="Are you sure you want to remove this member from the group?"
        confirmButtonText="Remove"
      />

      <Toast {...toast} onClose={() => setToast({ ...toast, isVisible: false })} />
    </div>
  );
}
--- END OF FILE: ./frontend/app/components/GroupDetailView.tsx ---


--- START OF FILE: ./frontend/app/components/RewardManager.tsx ---
'use client';

import { useState, useEffect } from 'react';
import Link from 'next/link';
import api from '../../lib/api';
import Toast from './Toast';
import DeleteConfirmationModal from './DeleteConfirmationModal';
import { getMediaUrl } from '../utils';

interface Reward {
  id: number;
  name: string;
  image: string | null;
  owner_role: string;
  municipality_name?: string;
  club_name?: string;
  is_active: boolean;
  expiration_date: string | null;
  usage_limit: number | null;
}

interface Analytics {
  total_created: number;
  active_rewards: number;
  expired_rewards: number;
  total_uses: number;
  uses_last_7_days: number;
}

interface RewardManagerProps {
  basePath: string; // e.g. "/admin/super/rewards"
}

export default function RewardManager({ basePath }: RewardManagerProps) {
  const [rewards, setRewards] = useState<Reward[]>([]);
  const [analytics, setAnalytics] = useState<Analytics | null>(null);
  const [loading, setLoading] = useState(true);
  
  // Actions
  const [toast, setToast] = useState({ message: '', type: 'success' as 'success'|'error', isVisible: false });
  const [rewardToDelete, setRewardToDelete] = useState<Reward | null>(null);

  useEffect(() => {
    fetchData();
  }, []);

  const fetchData = async () => {
    setLoading(true);
    try {
      const [listRes, statsRes] = await Promise.all([
        api.get('/rewards/'),
        api.get('/rewards/analytics_overview/')
      ]);
      
      setRewards(Array.isArray(listRes.data) ? listRes.data : listRes.data.results);
      setAnalytics(statsRes.data);
    } catch (err) {
      console.error(err);
      setToast({ message: 'Failed to load rewards.', type: 'error', isVisible: true });
    } finally {
      setLoading(false);
    }
  };

  const handleDelete = async () => {
    if (!rewardToDelete) return;
    try {
      await api.delete(`/rewards/${rewardToDelete.id}/`);
      setToast({ message: 'Reward deleted successfully.', type: 'success', isVisible: true });
      setRewardToDelete(null);
      fetchData(); // Refresh list
    } catch (err) {
      setToast({ message: 'Failed to delete reward.', type: 'error', isVisible: true });
    }
  };

  const getScopeLabel = (r: Reward) => {
    if (r.owner_role === 'SUPER_ADMIN') return 'üåç Global';
    if (r.owner_role === 'MUNICIPALITY_ADMIN') return `üèõÔ∏è ${r.municipality_name}`;
    if (r.owner_role === 'CLUB_ADMIN') return `‚öΩ ${r.club_name}`;
    return '-';
  };

  if (loading) return <div className="p-12 text-center text-gray-500">Loading rewards...</div>;

  return (
    <div className="space-y-8">
      
      {/* 1. HEADER & ACTIONS */}
      <div className="flex justify-between items-center">
        <h1 className="text-2xl font-bold text-gray-900">Rewards Management</h1>
        <Link 
          href={`${basePath}/create`}
          className="bg-blue-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-blue-700 shadow transition"
        >
          + Create Reward
        </Link>
      </div>

      {/* 2. ANALYTICS CARDS */}
      {analytics && (
        <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
          <div className="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
            <p className="text-xs font-bold text-gray-500 uppercase">Active Rewards</p>
            <p className="text-2xl font-bold text-green-600">{analytics.active_rewards}</p>
          </div>
          <div className="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
            <p className="text-xs font-bold text-gray-500 uppercase">Total Created</p>
            <p className="text-2xl font-bold text-gray-900">{analytics.total_created}</p>
          </div>
          <div className="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
            <p className="text-xs font-bold text-gray-500 uppercase">Total Claims</p>
            <p className="text-2xl font-bold text-blue-600">{analytics.total_uses}</p>
          </div>
          <div className="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
            <p className="text-xs font-bold text-gray-500 uppercase">Claims (7 Days)</p>
            <p className="text-2xl font-bold text-purple-600">{analytics.uses_last_7_days}</p>
          </div>
        </div>
      )}

      {/* 3. LIST TABLE */}
      <div className="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
        <table className="min-w-full divide-y divide-gray-200">
          <thead className="bg-gray-50">
            <tr>
              <th className="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase">Reward</th>
              <th className="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase">Scope</th>
              <th className="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase">Status</th>
              <th className="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase">Expiry</th>
              <th className="px-6 py-3 text-right text-xs font-bold text-gray-500 uppercase">Actions</th>
            </tr>
          </thead>
          <tbody className="divide-y divide-gray-200">
            {rewards.length === 0 ? (
              <tr><td colSpan={5} className="p-8 text-center text-gray-500">No rewards found.</td></tr>
            ) : rewards.map((r) => (
              <tr key={r.id} className="hover:bg-gray-50">
                <td className="px-6 py-4">
                  <div className="flex items-center gap-3">
                    <div className="w-10 h-10 rounded-lg bg-gray-100 flex-shrink-0 overflow-hidden border">
                      {r.image ? (
                        <img src={getMediaUrl(r.image) || ''} className="w-full h-full object-cover" />
                      ) : (
                        <div className="flex items-center justify-center h-full text-lg">üéÅ</div>
                      )}
                    </div>
                    <span className="font-bold text-gray-900">{r.name}</span>
                  </div>
                </td>
                <td className="px-6 py-4 text-sm text-gray-600">{getScopeLabel(r)}</td>
                <td className="px-6 py-4">
                  {r.is_active 
                    ? <span className="bg-green-100 text-green-800 px-2 py-1 rounded-full text-xs font-bold">Active</span>
                    : <span className="bg-gray-100 text-gray-600 px-2 py-1 rounded-full text-xs font-bold">Inactive</span>
                  }
                </td>
                <td className="px-6 py-4 text-sm text-gray-600">
                  {r.expiration_date ? new Date(r.expiration_date).toLocaleDateString() : 'No Expiry'}
                </td>
                <td className="px-6 py-4 text-right space-x-3 text-sm">
                  <Link href={`${basePath}/${r.id}`} className="text-indigo-600 font-bold hover:underline">View</Link>
                  <Link href={`${basePath}/edit/${r.id}`} className="text-blue-600 font-bold hover:underline">Edit</Link>
                  <button onClick={() => setRewardToDelete(r)} className="text-red-600 font-bold hover:underline">Delete</button>
                </td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>

      <DeleteConfirmationModal
        isVisible={!!rewardToDelete}
        onClose={() => setRewardToDelete(null)}
        onConfirm={handleDelete}
        itemName={rewardToDelete?.name}
      />

      <Toast {...toast} onClose={() => setToast({...toast, isVisible: false})} />
    </div>
  );
}
--- END OF FILE: ./frontend/app/components/RewardManager.tsx ---


--- START OF FILE: ./frontend/app/components/GroupManager.tsx ---
'use client';

import { useState, useEffect } from 'react';
import Link from 'next/link';
import { usePathname } from 'next/navigation';
import api from '../../lib/api';
import Toast from './Toast';
import DeleteConfirmationModal from './DeleteConfirmationModal';

interface Group {
  id: number;
  name: string;
  group_type: 'OPEN' | 'APPLICATION' | 'CLOSED';
  is_system_group: boolean;
  member_count: number;
  pending_request_count: number;
  created_at: string;
  municipality: number | null;
  municipality_name?: string; // New
  club: number | null;
  club_name?: string;         // New
}

interface GroupManagerProps {
  basePath: string; // e.g., "/admin/super/groups"
}

export default function GroupManager({ basePath }: GroupManagerProps) {
  const [groups, setGroups] = useState<Group[]>([]);
  const [loading, setLoading] = useState(true);
  
  // Determine admin type from basePath
  const isSuperAdmin = basePath.includes('/super');
  const isMuniAdmin = basePath.includes('/municipality');
  
  // Stats
  const [stats, setStats] = useState({
    totalGroups: 0,
    totalMembers: 0,
    activeGroups: 0,
    emptyGroups: 0
  });

  // Actions
  const [toast, setToast] = useState({ message: '', type: 'success' as 'success' | 'error', isVisible: false });
  const [showDelete, setShowDelete] = useState(false);
  const [selectedGroup, setSelectedGroup] = useState<Group | null>(null);

  useEffect(() => {
    fetchGroups();
  }, []);

  const fetchGroups = async () => {
    setLoading(true);
    try {
      const res = await api.get('/groups/');
      const data = Array.isArray(res.data) ? res.data : res.data.results;
      setGroups(data);
      calculateStats(data);
    } catch (err) {
      console.error(err);
      setToast({ message: 'Failed to load groups.', type: 'error', isVisible: true });
    } finally {
      setLoading(false);
    }
  };

  const calculateStats = (data: Group[]) => {
    const totalMembers = data.reduce((sum, g) => sum + g.member_count, 0);
    const activeGroups = data.filter(g => g.member_count > 0).length;
    
    setStats({
      totalGroups: data.length,
      totalMembers,
      activeGroups,
      emptyGroups: data.length - activeGroups
    });
  };

  const handleDelete = async () => {
    if (!selectedGroup) return;
    try {
      await api.delete(`/groups/${selectedGroup.id}/`);
      setToast({ message: 'Group deleted successfully.', type: 'success', isVisible: true });
      fetchGroups();
    } catch (err) {
      setToast({ message: 'Failed to delete group.', type: 'error', isVisible: true });
    } finally {
      setShowDelete(false);
      setSelectedGroup(null);
    }
  };

  const getBadgeStyle = (type: string) => {
    switch (type) {
      case 'OPEN': return 'bg-green-100 text-green-800';
      case 'APPLICATION': return 'bg-blue-100 text-blue-800';
      case 'CLOSED': return 'bg-gray-100 text-gray-800';
      default: return 'bg-gray-100 text-gray-800';
    }
  };

  return (
    <div className="space-y-6">
      
      {/* HEADER & ACTIONS */}
      <div className="flex flex-col md:flex-row md:items-center justify-between gap-4">
        <div>
          <h1 className="text-2xl font-bold text-gray-900">Groups</h1>
          <p className="text-gray-500 text-sm">Manage member segments and filters.</p>
        </div>
        <Link 
          href={`${basePath}/create`}
          className="bg-indigo-600 text-white px-4 py-2 rounded-lg font-medium hover:bg-indigo-700 shadow transition text-center"
        >
          + Create New Group
        </Link>
      </div>

      {/* ANALYTICS CARDS (Same as before) */}
      {!loading && (
        <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
          <div className="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
            <p className="text-xs font-bold text-gray-500 uppercase">Total Groups</p>
            <p className="text-2xl font-bold text-gray-900">{stats.totalGroups}</p>
          </div>
          <div className="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
            <p className="text-xs font-bold text-gray-500 uppercase">Total Members</p>
            <p className="text-2xl font-bold text-indigo-600">{stats.totalMembers}</p>
          </div>
          <div className="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
            <p className="text-xs font-bold text-gray-500 uppercase">Active Groups</p>
            <p className="text-2xl font-bold text-green-600">{stats.activeGroups}</p>
          </div>
          <div className="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
            <p className="text-xs font-bold text-gray-500 uppercase">Empty Groups</p>
            <p className="text-2xl font-bold text-gray-400">{stats.emptyGroups}</p>
          </div>
        </div>
      )}

      {/* GROUPS LIST */}
      <div className="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
        {loading ? (
          <div className="p-8 text-center text-gray-500">Loading groups...</div>
        ) : groups.length === 0 ? (
          <div className="p-12 text-center">
            <p className="text-gray-500 mb-2">No groups found.</p>
            <p className="text-sm text-gray-400">Create your first group to get started.</p>
          </div>
        ) : (
          <div className="overflow-x-auto">
            <table className="min-w-full divide-y divide-gray-200">
              <thead className="bg-gray-50">
                <tr>
                  <th className="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase">Group Name</th>
                  
                  {/* DYNAMIC COLUMNS */}
                  {isSuperAdmin && <th className="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase">Municipality</th>}
                  {(isSuperAdmin || isMuniAdmin) && <th className="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase">Club</th>}
                  
                  <th className="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase">Type</th>
                  <th className="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase">Members</th>
                  <th className="px-6 py-3 text-right text-xs font-bold text-gray-500 uppercase">Actions</th>
                </tr>
              </thead>
              <tbody className="bg-white divide-y divide-gray-200">
                {groups.map((group) => (
                  <tr key={group.id} className="hover:bg-gray-50 transition">
                    <td className="px-6 py-4 whitespace-nowrap">
                      <div className="flex items-center">
                        <div>
                          <div className="text-sm font-bold text-gray-900">{group.name}</div>
                          {group.is_system_group && (
                            <span className="text-[10px] uppercase font-bold bg-purple-100 text-purple-700 px-1.5 py-0.5 rounded">System</span>
                          )}
                        </div>
                      </div>
                    </td>

                    {/* DYNAMIC CELLS */}
                    {isSuperAdmin && (
                      <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        {group.municipality_name || '-'}
                      </td>
                    )}
                    {(isSuperAdmin || isMuniAdmin) && (
                      <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        {group.club_name || '-'}
                      </td>
                    )}

                    <td className="px-6 py-4 whitespace-nowrap">
                      <span className={`px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full ${getBadgeStyle(group.group_type)}`}>
                        {group.group_type}
                      </span>
                    </td>
                    <td className="px-6 py-4 whitespace-nowrap">
                      <div className="text-sm text-gray-900 font-medium">{group.member_count}</div>
                      {group.pending_request_count > 0 && (
                        <div className="text-xs text-orange-600 font-semibold">
                          {group.pending_request_count} pending
                        </div>
                      )}
                    </td>
                    <td className="px-6 py-4 whitespace-nowrap text-right text-sm font-medium space-x-3">
                      <Link 
                        href={`${basePath}/${group.id}`}
                        className="text-indigo-600 hover:text-indigo-900"
                      >
                        View
                      </Link>
                      {!group.is_system_group && (
                        <button 
                          onClick={() => { setSelectedGroup(group); setShowDelete(true); }}
                          className="text-red-600 hover:text-red-900"
                        >
                          Delete
                        </button>
                      )}
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        )}
      </div>

      <DeleteConfirmationModal
        isVisible={showDelete}
        onClose={() => setShowDelete(false)}
        onConfirm={handleDelete}
        itemName={selectedGroup?.name}
        message="Are you sure? This will remove all members from this group."
      />

      <Toast {...toast} onClose={() => setToast({ ...toast, isVisible: false })} />
    </div>
  );
}
--- END OF FILE: ./frontend/app/components/GroupManager.tsx ---


--- START OF FILE: ./frontend/app/components/GroupRequestsManager.tsx ---
'use client';

import { useState, useEffect } from 'react';
import api from '../../lib/api';
import Toast from './Toast';
import { getMediaUrl } from '../../app/utils';

export default function GroupRequestsManager() {
  const [requests, setRequests] = useState<any[]>([]);
  const [loading, setLoading] = useState(true);
  const [filter, setFilter] = useState('');
  const [toast, setToast] = useState({ message: '', type: 'success' as 'success'|'error', isVisible: false });

  useEffect(() => {
    fetchRequests();
  }, [filter]);

  const fetchRequests = async () => {
    setLoading(true);
    try {
      const params = new URLSearchParams();
      if (filter) params.set('group_name', filter);
      
      const res = await api.get(`/group-requests/?${params.toString()}`);
      setRequests(Array.isArray(res.data) ? res.data : res.data.results);
    } catch (err) {
      console.error(err);
    } finally {
      setLoading(false);
    }
  };

  const handleAction = async (id: number, action: 'approve' | 'reject') => {
    try {
      await api.post(`/group-requests/${id}/${action}/`);
      setToast({ 
        message: action === 'approve' ? 'Member approved!' : 'Request rejected.', 
        type: 'success', 
        isVisible: true 
      });
      fetchRequests(); // Refresh list
    } catch (err) {
      setToast({ message: 'Action failed.', type: 'error', isVisible: true });
    }
  };

  return (
    <div className="space-y-6">
      
      {/* FILTER BAR */}
      <div className="flex flex-col sm:flex-row justify-between items-end sm:items-center gap-4 bg-white p-4 rounded-xl shadow-sm border border-gray-100">
        <div>
          <h2 className="text-lg font-bold text-gray-800">Pending Applications</h2>
          <p className="text-sm text-gray-500">Manage users waiting to join your groups.</p>
        </div>
        <div className="w-full sm:w-64">
          <input 
            type="text" 
            placeholder="Filter by group name..." 
            className="w-full border rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none"
            value={filter}
            onChange={(e) => setFilter(e.target.value)}
          />
        </div>
      </div>

      {/* LIST */}
      <div className="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
        {loading ? (
          <div className="p-8 text-center text-gray-500">Loading requests...</div>
        ) : requests.length === 0 ? (
          <div className="p-12 text-center text-gray-500">
            <p className="mb-2">No pending applications found.</p>
            {filter && <button onClick={() => setFilter('')} className="text-blue-600 underline text-sm">Clear filter</button>}
          </div>
        ) : (
          <div className="overflow-x-auto">
            <table className="min-w-full divide-y divide-gray-200">
              <thead className="bg-gray-50">
                <tr>
                  <th className="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase">User</th>
                  <th className="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase">Applying To</th>
                  <th className="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase">Requested</th>
                  <th className="px-6 py-3 text-right text-xs font-bold text-gray-500 uppercase">Actions</th>
                </tr>
              </thead>
              <tbody className="bg-white divide-y divide-gray-200">
                {requests.map((req) => (
                  <tr key={req.id} className="hover:bg-gray-50 transition">
                    <td className="px-6 py-4 whitespace-nowrap">
                      <div className="flex items-center gap-3">
                        {req.user_avatar ? (
                          <img src={getMediaUrl(req.user_avatar) || ''} className="w-8 h-8 rounded-full object-cover bg-gray-200" />
                        ) : (
                          <div className="w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center text-xs font-bold text-gray-600">
                            {req.user_name.charAt(0)}
                          </div>
                        )}
                        <div>
                          <div className="text-sm font-bold text-gray-900">{req.user_name}</div>
                          <div className="text-xs text-gray-500">{req.user_email}</div>
                        </div>
                      </div>
                    </td>
                    <td className="px-6 py-4 whitespace-nowrap">
                      <span className="text-sm font-medium text-gray-900 bg-blue-50 px-2 py-1 rounded text-blue-700">
                        {req.group_name}
                      </span>
                    </td>
                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                      {new Date(req.joined_at).toLocaleDateString()}
                    </td>
                    <td className="px-6 py-4 whitespace-nowrap text-right space-x-2">
                      <button 
                        onClick={() => handleAction(req.id, 'approve')}
                        className="bg-green-100 text-green-700 px-3 py-1.5 rounded-lg text-xs font-bold hover:bg-green-200 transition"
                      >
                        Approve
                      </button>
                      <button 
                        onClick={() => handleAction(req.id, 'reject')}
                        className="bg-red-50 text-red-600 px-3 py-1.5 rounded-lg text-xs font-bold hover:bg-red-100 transition"
                      >
                        Deny
                      </button>
                    </td>
                  </tr>
                ))}
              </tbody>
            </table>
          </div>
        )}
      </div>

      <Toast {...toast} onClose={() => setToast({...toast, isVisible: false})} />
    </div>
  );
}
--- END OF FILE: ./frontend/app/components/GroupRequestsManager.tsx ---


--- START OF FILE: ./frontend/app/components/CustomFieldsForm.tsx ---
'use client';

import { useState, useEffect } from 'react';
import api from '../../lib/api';

interface CustomField {
  id: number;
  name: string;
  help_text: string;
  field_type: 'TEXT' | 'SINGLE_SELECT' | 'MULTI_SELECT' | 'BOOLEAN';
  options: string[];
  required: boolean;
  context: 'USER_PROFILE' | 'EVENT';
  target_roles: string[];
  value?: any; // Value is included when fetching via applicable_for_user
}

interface CustomFieldsFormProps {
  targetRole: 'YOUTH_MEMBER' | 'GUARDIAN';
  context?: 'USER_PROFILE' | 'EVENT';
  values: Record<number, any>; // field_id -> value
  onChange: (fieldId: number, value: any) => void;
  userId?: number | null; // ID of the user being edited (for fetching applicable fields)
  userMunicipalityId?: number | null;
  userClubId?: number | null;
}

export default function CustomFieldsForm({
  targetRole,
  context = 'USER_PROFILE',
  values,
  onChange,
  userId,
  userMunicipalityId,
  userClubId,
}: CustomFieldsFormProps) {
  const [fields, setFields] = useState<CustomField[]>([]);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    // For new user creation: only fetch if userClubId is provided (club selected)
    // For editing existing user: 
    //   - If userClubId is provided (preferred_club selected/changed), fetch based on that club
    //   - Otherwise, fetch using applicable_for_user (uses user's saved club)
    if (userId && userClubId) {
      // Editing with a club selected - fetch based on the selected club (may have changed)
      fetchFields();
    } else if (userId && !userClubId) {
      // Editing but no club selected - fetch using applicable_for_user (uses saved club)
      fetchFields();
    } else if (!userId && userClubId) {
      // Creating new user with club selected
      fetchFields();
    } else {
      // No club selected for new user - don't show fields yet
      setFields([]);
      setLoading(false);
    }
  }, [targetRole, context, userId, userMunicipalityId, userClubId]);

  const fetchFields = async () => {
    setLoading(true);
    try {
      let applicableFields: CustomField[] = [];
      
      // If userId is provided but userClubId is also provided, it means the user changed the club
      // In this case, fetch fields based on the new club selection (not the saved one)
      // Otherwise, if only userId is provided, use applicable_for_user (uses saved club)
      if (userId && userClubId) {
        // User is editing and has selected/changed preferred_club - fetch based on new club
        try {
          const clubRes = await api.get(`/clubs/${userClubId}/`);
          const club = clubRes.data;
          const clubMunicipalityId = typeof club.municipality === 'object' ? club.municipality?.id : club.municipality;

          // Fetch all fields (backend filters by admin scope)
          const res = await api.get('/custom-fields/');
          const allFields = Array.isArray(res.data.results) ? res.data.results : (Array.isArray(res.data) ? res.data : []);

          // Filter to show only:
          // - Global fields (owner_role = SUPER_ADMIN, no municipality/club)
          // - Municipality fields for the club's municipality
          // - Club fields for the selected club
          applicableFields = allFields.filter((field: any) => {
            // Must match context
            if (field.context !== context) return false;

            // Must target this role (or "ALL")
            const targetRoles = Array.isArray(field.target_roles) ? field.target_roles : [];
            if (!targetRoles.includes('ALL') && !targetRoles.includes(targetRole)) return false;

            // Check if field is applicable to this club/municipality
            const fieldMunicipalityId = typeof field.municipality === 'object' ? field.municipality?.id : field.municipality;
            const fieldClubId = typeof field.club === 'object' ? field.club?.id : field.club;

            // Global fields (no municipality, no club)
            if (field.owner_role === 'SUPER_ADMIN' && !fieldMunicipalityId && !fieldClubId) {
              return true;
            }

            // Municipality fields for this municipality
            if (field.owner_role === 'MUNICIPALITY_ADMIN' && fieldMunicipalityId === clubMunicipalityId) {
              // Check if field applies to this club (specific_clubs empty or includes this club)
              if (!field.specific_clubs || field.specific_clubs.length === 0) {
                return true; // Applies to all clubs in municipality
              }
              // Check if this club is in specific_clubs
              const specificClubIds = field.specific_clubs.map((c: any) => typeof c === 'object' ? c.id : c);
              return specificClubIds.includes(userClubId);
            }

            // Club fields for this club
            if (field.owner_role === 'CLUB_ADMIN' && fieldClubId === userClubId) {
              return true;
            }

            return false;
          });

          // For editing, we need to preserve existing values for fields that still exist
          // Fetch existing values from the user
          try {
            const userRes = await api.get(`/users/${userId}/`);
            const customFieldValuesData = userRes.data.custom_field_values || [];
            // customFieldValuesData is a list: [{field: field_id, value: value}, ...]
            // Update parent state with existing values
            customFieldValuesData.forEach((cfv: any) => {
              const fieldId = typeof cfv.field === 'object' ? cfv.field.id : Number(cfv.field);
              // Only set if this field is still applicable
              if (applicableFields.some((f: any) => f.id === fieldId)) {
                const valueToSet = cfv.value !== null && cfv.value !== undefined ? cfv.value : '';
                onChange(fieldId, valueToSet);
              }
            });
          } catch (err) {
            console.error('Failed to load existing custom field values:', err);
          }
        } catch (err) {
          console.error('Failed to fetch club details:', err);
          setFields([]);
          setLoading(false);
          return;
        }
      } else if (userId && !userClubId) {
        // User is editing but no club selected - use applicable_for_user (uses saved club)
        const res = await api.get(`/custom-fields/applicable_for_user/?user_id=${userId}`);
        applicableFields = Array.isArray(res.data) ? res.data : [];
        
        // Extract values from fields and update parent component
        // The applicable_for_user endpoint returns fields with embedded values
        // We sync these with the parent's values state so they're available for saving
        applicableFields.forEach((field: any) => {
          // field.value is included by CustomFieldUserViewSerializer
          // Update parent state for each field (including null/empty, so they're in sync)
          // Use empty string for null/undefined to ensure form fields work correctly
          const valueToSet = field.value !== null && field.value !== undefined ? field.value : '';
          onChange(field.id, valueToSet);
        });
      } else if (userClubId) {
        // For new user creation with club selected: fetch club details to get municipality
        // Then fetch fields applicable to that club and municipality
        try {
          const clubRes = await api.get(`/clubs/${userClubId}/`);
          const club = clubRes.data;
          const clubMunicipalityId = typeof club.municipality === 'object' ? club.municipality?.id : club.municipality;
          
          // Fetch all fields (backend filters by admin scope)
          const res = await api.get('/custom-fields/');
          const allFields = Array.isArray(res.data.results) ? res.data.results : (Array.isArray(res.data) ? res.data : []);
          
          // Filter to show only:
          // - Global fields (owner_role = SUPER_ADMIN, no municipality/club)
          // - Municipality fields for the club's municipality
          // - Club fields for the selected club
          applicableFields = allFields.filter((field: any) => {
            // Must match context
            if (field.context !== context) return false;
            
            // Must target this role (or "ALL")
            const targetRoles = Array.isArray(field.target_roles) ? field.target_roles : [];
            if (!targetRoles.includes('ALL') && !targetRoles.includes(targetRole)) return false;
            
            // Check if field is applicable to this club/municipality
            const fieldMunicipalityId = typeof field.municipality === 'object' ? field.municipality?.id : field.municipality;
            const fieldClubId = typeof field.club === 'object' ? field.club?.id : field.club;
            
            // Global fields (no municipality, no club)
            if (field.owner_role === 'SUPER_ADMIN' && !fieldMunicipalityId && !fieldClubId) {
              return true;
            }
            
            // Municipality fields for this municipality
            if (field.owner_role === 'MUNICIPALITY_ADMIN' && fieldMunicipalityId === clubMunicipalityId) {
              // Check if field applies to this club (specific_clubs empty or includes this club)
              if (!field.specific_clubs || field.specific_clubs.length === 0) {
                return true; // Applies to all clubs in municipality
              }
              // Check if this club is in specific_clubs
              const specificClubIds = field.specific_clubs.map((c: any) => typeof c === 'object' ? c.id : c);
              return specificClubIds.includes(userClubId);
            }
            
            // Club fields for this club
            if (field.owner_role === 'CLUB_ADMIN' && fieldClubId === userClubId) {
              return true;
            }
            
            return false;
          });
        } catch (err) {
          console.error('Failed to fetch club details:', err);
          setFields([]);
          setLoading(false);
          return;
        }
      } else if (userMunicipalityId && userClubId) {
        // Municipality admin creating/editing user with club selected
        // Fetch club details to get municipality
        try {
          const clubRes = await api.get(`/clubs/${userClubId}/`);
          const club = clubRes.data;
          const clubMunicipalityId = typeof club.municipality === 'object' ? club.municipality?.id : club.municipality;

          // Fetch all fields (backend filters by admin scope)
          const res = await api.get('/custom-fields/');
          const allFields = Array.isArray(res.data.results) ? res.data.results : (Array.isArray(res.data) ? res.data : []);

          // Filter to show only:
          // - Global fields (owner_role = SUPER_ADMIN, no municipality/club)
          // - Municipality fields for the club's municipality
          // - Club fields for the selected club
          applicableFields = allFields.filter((field: any) => {
            // Must match context
            if (field.context !== context) return false;

            // Must target this role (or "ALL")
            const targetRoles = Array.isArray(field.target_roles) ? field.target_roles : [];
            if (!targetRoles.includes('ALL') && !targetRoles.includes(targetRole)) return false;

            // Check if field is applicable to this club/municipality
            const fieldMunicipalityId = typeof field.municipality === 'object' ? field.municipality?.id : field.municipality;
            const fieldClubId = typeof field.club === 'object' ? field.club?.id : field.club;

            // Global fields (no municipality, no club)
            if (field.owner_role === 'SUPER_ADMIN' && !fieldMunicipalityId && !fieldClubId) {
              return true;
            }

            // Municipality fields for this municipality
            if (field.owner_role === 'MUNICIPALITY_ADMIN' && fieldMunicipalityId === clubMunicipalityId) {
              // Check if field applies to this club (specific_clubs empty or includes this club)
              if (!field.specific_clubs || field.specific_clubs.length === 0) {
                return true; // Applies to all clubs in municipality
              }
              // Check if this club is in specific_clubs
              const specificClubIds = field.specific_clubs.map((c: any) => typeof c === 'object' ? c.id : c);
              return specificClubIds.includes(userClubId);
            }

            // Club fields for this club
            if (field.owner_role === 'CLUB_ADMIN' && fieldClubId === userClubId) {
              return true;
            }

            return false;
          });

          // For editing, preserve existing values
          if (userId) {
            try {
              const userRes = await api.get(`/users/${userId}/`);
              const customFieldValuesData = userRes.data.custom_field_values || [];
              customFieldValuesData.forEach((cfv: any) => {
                const fieldId = typeof cfv.field === 'object' ? cfv.field.id : Number(cfv.field);
                if (applicableFields.some((f: any) => f.id === fieldId)) {
                  const valueToSet = cfv.value !== null && cfv.value !== undefined ? cfv.value : '';
                  onChange(fieldId, valueToSet);
                }
              });
            } catch (err) {
              console.error('Failed to load existing custom field values:', err);
            }
          }
        } catch (err) {
          console.error('Failed to fetch club details:', err);
          setFields([]);
          setLoading(false);
          return;
        }
      } else if (userMunicipalityId && !userClubId) {
        // Municipality admin creating user in their municipality (no club selected yet)
        // Don't show fields until club is selected
        setFields([]);
        setLoading(false);
        return;
      } else {
        // No club or municipality selected for new user - don't fetch fields
        setFields([]);
        setLoading(false);
        return;
      }
      
      setFields(applicableFields);
    } catch (err) {
      console.error('Failed to fetch custom fields:', err);
      setFields([]);
    } finally {
      setLoading(false);
    }
  };

  const handleFieldChange = (fieldId: number, value: any) => {
    onChange(fieldId, value);
  };

  // For new user creation: only show if club is selected (or if municipality admin creating user in their municipality)
  // For editing: always show (userId is provided)
  if (!userId && !userClubId && !userMunicipalityId) {
    return null;
  }

  if (loading) {
    return <div className="text-sm text-gray-500">Loading custom fields...</div>;
  }

  if (fields.length === 0) {
    return null;
  }

  return (
    <div className="space-y-4 border-t pt-4 mt-4">
      <h3 className="text-lg font-bold text-gray-800">Additional Information</h3>
      {fields.map((field) => {
        // Prioritize values prop (which gets updated when user types) over field.value (from API)
        // This ensures the input is controlled by the parent state, not the API response
        let fieldValue: any = values[field.id] !== undefined ? values[field.id] : ((field as any).value !== undefined ? (field as any).value : '');
        if (fieldValue === null || fieldValue === undefined) {
          fieldValue = '';
        }
        // For MULTI_SELECT, ensure it's an array
        if (field.field_type === 'MULTI_SELECT' && !Array.isArray(fieldValue)) {
          fieldValue = [];
        }
        const isRequired = field.required;

        return (
          <div key={field.id} className="space-y-1">
            <label className="block text-sm font-semibold text-gray-700">
              {field.name}
              {isRequired && <span className="text-red-500 ml-1">*</span>}
            </label>
            {field.help_text && (
              <p className="text-xs text-gray-500 mb-1">{field.help_text}</p>
            )}

            {field.field_type === 'TEXT' && (
              <input
                type="text"
                className="w-full border rounded-lg p-2 text-sm"
                value={fieldValue}
                onChange={(e) => handleFieldChange(field.id, e.target.value)}
                required={isRequired}
              />
            )}

            {field.field_type === 'SINGLE_SELECT' && (
              <select
                className="w-full border rounded-lg p-2 text-sm"
                value={fieldValue}
                onChange={(e) => handleFieldChange(field.id, e.target.value)}
                required={isRequired}
              >
                <option value="">Select...</option>
                {field.options.map((option, idx) => (
                  <option key={idx} value={option}>
                    {option}
                  </option>
                ))}
              </select>
            )}

            {field.field_type === 'MULTI_SELECT' && (
              <div className="space-y-2">
                {field.options.map((option, idx) => {
                  const selectedValues = Array.isArray(fieldValue) ? fieldValue : [];
                  const isChecked = selectedValues.includes(option);
                  return (
                    <label key={idx} className="flex items-center gap-2 cursor-pointer">
                      <input
                        type="checkbox"
                        checked={isChecked}
                        onChange={(e) => {
                          const newValues = e.target.checked
                            ? [...selectedValues, option]
                            : selectedValues.filter((v) => v !== option);
                          handleFieldChange(field.id, newValues);
                        }}
                        className="w-4 h-4 text-blue-600"
                      />
                      <span className="text-sm text-gray-700">{option}</span>
                    </label>
                  );
                })}
              </div>
            )}

            {field.field_type === 'BOOLEAN' && (
              <label className="flex items-center gap-2 cursor-pointer">
                <input
                  type="checkbox"
                  checked={!!fieldValue}
                  onChange={(e) => handleFieldChange(field.id, e.target.checked)}
                  className="w-4 h-4 text-blue-600"
                />
                <span className="text-sm text-gray-700">Yes</span>
              </label>
            )}
          </div>
        );
      })}
    </div>
  );
}


--- END OF FILE: ./frontend/app/components/CustomFieldsForm.tsx ---


--- START OF FILE: ./frontend/app/components/DeleteConfirmationModal.tsx ---
'use client';

interface DeleteConfirmationModalProps {
  isVisible: boolean;
  onClose: () => void;
  onConfirm: () => void;
  title?: string;
  message?: string;
  itemName?: string;
  confirmButtonText?: string;
  cancelButtonText?: string;
  isLoading?: boolean;
}

export default function DeleteConfirmationModal({
  isVisible,
  onClose,
  onConfirm,
  title,
  message,
  itemName,
  confirmButtonText = 'Delete',
  cancelButtonText = 'Cancel',
  isLoading = false,
}: DeleteConfirmationModalProps) {
  if (!isVisible) return null;

  const defaultTitle = title || 'Confirm Deletion';
  const defaultMessage = message || (itemName 
    ? `Are you sure you want to delete "${itemName}"? This action cannot be undone.`
    : 'Are you sure you want to delete this item? This action cannot be undone.');

  const handleConfirm = () => {
    if (!isLoading) {
      onConfirm();
    }
  };

  const handleBackdropClick = (e: React.MouseEvent<HTMLDivElement>) => {
    if (e.target === e.currentTarget && !isLoading) {
      onClose();
    }
  };

  return (
    <div
      className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4"
      onClick={handleBackdropClick}
    >
      <div className="bg-white rounded-xl shadow-2xl w-full max-w-md p-6 transition-all duration-200">
        {/* Icon */}
        <div className="flex items-center justify-center w-12 h-12 mx-auto mb-4 rounded-full bg-red-100">
          <svg
            className="w-6 h-6 text-red-600"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              strokeLinecap="round"
              strokeLinejoin="round"
              strokeWidth={2}
              d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"
            />
          </svg>
        </div>

        {/* Title */}
        <h2 className="text-xl font-bold text-gray-900 text-center mb-2">
          {defaultTitle}
        </h2>

        {/* Message */}
        <p className="text-gray-600 text-center mb-6">
          {defaultMessage}
        </p>

        {/* Buttons */}
        <div className="flex gap-3">
          <button
            type="button"
            onClick={onClose}
            disabled={isLoading}
            className="flex-1 px-4 py-2.5 text-gray-700 bg-gray-100 rounded-lg font-semibold hover:bg-gray-200 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
          >
            {cancelButtonText}
          </button>
          <button
            type="button"
            onClick={handleConfirm}
            disabled={isLoading}
            className="flex-1 px-4 py-2.5 text-white bg-red-600 rounded-lg font-semibold hover:bg-red-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2"
          >
            {isLoading ? (
              <>
                <svg
                  className="animate-spin h-4 w-4"
                  fill="none"
                  viewBox="0 0 24 24"
                >
                  <circle
                    className="opacity-25"
                    cx="12"
                    cy="12"
                    r="10"
                    stroke="currentColor"
                    strokeWidth="4"
                  />
                  <path
                    className="opacity-75"
                    fill="currentColor"
                    d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
                  />
                </svg>
                Deleting...
              </>
            ) : (
              confirmButtonText
            )}
          </button>
        </div>
      </div>
    </div>
  );
}


--- END OF FILE: ./frontend/app/components/DeleteConfirmationModal.tsx ---


--- START OF FILE: ./frontend/app/components/RichTextEditor.tsx ---
'use client';

import dynamic from 'next/dynamic';
import 'react-quill-new/dist/quill.snow.css'; // Import Quill styles

// Dynamically import ReactQuill with SSR disabled
const ReactQuill = dynamic(() => import('react-quill-new'), { 
  ssr: false,
  loading: () => <p>Loading Editor...</p>
});

interface EditorProps {
  value: string;
  onChange: (content: string) => void;
}

const modules = {
  toolbar: [
    [{ 'header': [1, 2, 3, false] }],
    ['bold', 'italic', 'underline', 'strike', 'blockquote'],
    [{'list': 'ordered'}, {'list': 'bullet'}],
    ['link'],
    ['clean']
  ],
};

export default function RichTextEditor({ value, onChange }: EditorProps) {
  return (
    <div className="bg-white text-black">
      <ReactQuill 
        theme="snow" 
        value={value} 
        onChange={onChange} 
        modules={modules}
        className="h-64 mb-12" // Height + margin for toolbar
      />
    </div>
  );
}
--- END OF FILE: ./frontend/app/components/RichTextEditor.tsx ---


--- START OF FILE: ./frontend/app/components/CustomFieldManager.tsx ---
'use client';

import { useState, useEffect } from 'react';
import api from '../../lib/api';
import { useAuth } from '../../context/AuthContext';
import Toast from './Toast';
import DeleteConfirmationModal from './DeleteConfirmationModal';

interface CustomField {
  id: number;
  name: string;
  help_text: string;
  field_type: 'TEXT' | 'SINGLE_SELECT' | 'MULTI_SELECT' | 'BOOLEAN';
  options: string[];
  required: boolean;
  is_published: boolean;
  target_roles: string[];
  specific_clubs: number[];
  owner_role?: string;
  club?: number | { id: number };
  municipality?: number | { id: number };
}

interface ClubOption {
  id: number;
  name: string;
}

interface CustomFieldManagerProps {
  scope: 'SUPER' | 'MUNICIPALITY' | 'CLUB';
}

export default function CustomFieldManager({ scope }: CustomFieldManagerProps) {
  const { user } = useAuth();
  const [fields, setFields] = useState<CustomField[]>([]);
  const [clubs, setClubs] = useState<ClubOption[]>([]); // For Muni Admin context
  const [loading, setLoading] = useState(true);
  
  // Modal State
  const [showModal, setShowModal] = useState(false);
  const [isEditing, setIsEditing] = useState(false);
  const [editId, setEditId] = useState<number | null>(null);
  
  // Delete Modal
  const [showDelete, setShowDelete] = useState(false);
  const [deleteId, setDeleteId] = useState<number | null>(null);

  // Form State
  const [formData, setFormData] = useState({
    name: '',
    help_text: '',
    field_type: 'TEXT',
    options: [] as string[], // For select fields
    currentOptionInput: '', // Helper for adding options
    required: false,
    is_published: true,
    target_roles: [] as string[],
    specific_clubs: [] as number[],
    context: 'USER_PROFILE',
  });

  const [toast, setToast] = useState({ message: '', type: 'success' as 'success'|'error', isVisible: false });

  useEffect(() => {
    fetchFields();
    if (scope === 'MUNICIPALITY') {
      fetchClubs();
    }
  }, [scope]);

  const fetchFields = async () => {
    setLoading(true);
    try {
      const res = await api.get('/custom-fields/');
      const data = res.data.results || res.data;
      setFields(Array.isArray(data) ? data : []);
    } catch (err: any) {
      console.error('Failed to fetch custom fields:', err);
      const errorMessage = err?.response?.data?.detail || err?.response?.data?.message || 'Failed to load custom fields';
      setToast({ message: errorMessage, type: 'error', isVisible: true });
      setFields([]);
    } finally {
      setLoading(false);
    }
  };

  const fetchClubs = async () => {
    try {
      // Muni admin gets their clubs automatically via this endpoint due to permissions
      const res = await api.get('/clubs/'); 
      setClubs(Array.isArray(res.data) ? res.data : res.data.results || []);
    } catch (err) {
      console.error(err);
    }
  };

  // --- Form Helpers ---

  const resetForm = () => {
    setFormData({
      name: '', help_text: '', field_type: 'TEXT',
      options: [], currentOptionInput: '',
      required: false, is_published: true,
      target_roles: ['YOUTH_MEMBER'], // Default
      specific_clubs: [],
      context: 'USER_PROFILE',
    });
    setIsEditing(false);
    setEditId(null);
  };

  const handleOpenCreate = () => {
    resetForm();
    setShowModal(true);
  };

  const handleOpenEdit = (field: CustomField) => {
    // Prevent editing read-only fields
    // Club admins can only edit their own club fields
    if (scope === 'CLUB' && user?.assigned_club) {
      const isOwnedByClubAdmin = field.owner_role === 'CLUB_ADMIN' && 
        (typeof field.club === 'object' ? field.club?.id : field.club) === (typeof user.assigned_club === 'object' ? user.assigned_club.id : user.assigned_club);
      
      if (!isOwnedByClubAdmin) {
        setToast({ message: 'You can only edit fields assigned to your club.', type: 'error', isVisible: true });
        return;
      }
    }
    
    // Municipality admins can edit their own municipality fields and club fields in their municipality (not global super admin fields)
    if (scope === 'MUNICIPALITY' && user?.assigned_municipality) {
      const userMunicipalityId = typeof user.assigned_municipality === 'object' ? user.assigned_municipality.id : user.assigned_municipality;
      const fieldMunicipalityId = typeof field.municipality === 'object' ? field.municipality?.id : field.municipality;
      
      // Check if it's a municipality field owned by this municipality
      const isOwnedByMunicipalityAdmin = field.owner_role === 'MUNICIPALITY_ADMIN' && 
        fieldMunicipalityId === userMunicipalityId;
      
      // Check if it's a club field that belongs to a club in this municipality
      let isClubFieldInMunicipality = false;
      if (field.owner_role === 'CLUB_ADMIN' && field.club) {
        const fieldClubId = typeof field.club === 'object' ? field.club.id : field.club;
        const clubInMunicipality = clubs.find(c => c.id === fieldClubId);
        isClubFieldInMunicipality = !!clubInMunicipality;
      }
      
      // Only allow editing if it's a municipality field or a club field in their municipality
      // Block global super admin fields
      if (field.owner_role === 'SUPER_ADMIN' || (!isOwnedByMunicipalityAdmin && !isClubFieldInMunicipality)) {
        setToast({ message: 'You can only edit fields assigned to your municipality or clubs in your municipality.', type: 'error', isVisible: true });
        return;
      }
    }
    
    setIsEditing(true);
    setEditId(field.id);
    setFormData({
      name: field.name,
      help_text: field.help_text || '',
      field_type: field.field_type,
      options: field.options || [],
      currentOptionInput: '',
      required: field.required,
      is_published: field.is_published,
      target_roles: field.target_roles || [],
      specific_clubs: field.specific_clubs || [],
      // @ts-ignore  -- field.context exists on API but might not be in TS interface yet
      context: field.context || 'USER_PROFILE',
    });
    setShowModal(true);
  };

  // Option Management (for Select fields)
  const addOption = () => {
    if (!formData.currentOptionInput.trim()) return;
    setFormData(prev => ({
      ...prev,
      options: [...prev.options, prev.currentOptionInput.trim()],
      currentOptionInput: ''
    }));
  };

  const removeOption = (index: number) => {
    setFormData(prev => ({
      ...prev,
      options: prev.options.filter((_, i) => i !== index)
    }));
  };

  // Role Toggling
  const toggleRole = (role: string) => {
    setFormData(prev => {
      const roles = prev.target_roles.includes(role)
        ? prev.target_roles.filter(r => r !== role)
        : [...prev.target_roles, role];
      return { ...prev, target_roles: roles };
    });
  };

  // Club Toggling (Muni only)
  const toggleClub = (clubId: number) => {
    setFormData(prev => {
      const list = prev.specific_clubs.includes(clubId)
        ? prev.specific_clubs.filter(id => id !== clubId)
        : [...prev.specific_clubs, clubId];
      return { ...prev, specific_clubs: list };
    });
  };

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    
    // Validation
    if ((formData.field_type === 'SINGLE_SELECT' || formData.field_type === 'MULTI_SELECT') && formData.options.length === 0) {
      alert("Please add at least one option for the selection list.");
      return;
    }
    if (formData.target_roles.length === 0) {
      alert("Please select at least one target role (Youth or Guardian).");
      return;
    }

    const payload = {
      name: formData.name,
      help_text: formData.help_text,
      field_type: formData.field_type,
      options: formData.options,
      required: formData.required,
      is_published: formData.is_published,
      target_roles: formData.target_roles,
      specific_clubs: formData.specific_clubs,
      context: formData.context,
    };

    try {
      if (isEditing && editId) {
        await api.patch(`/custom-fields/${editId}/`, payload);
        setToast({ message: 'Field updated', type: 'success', isVisible: true });
      } else {
        await api.post('/custom-fields/', payload);
        setToast({ message: 'Field created', type: 'success', isVisible: true });
      }
      setShowModal(false);
      fetchFields();
    } catch (err) {
      console.error(err);
      setToast({ message: 'Operation failed', type: 'error', isVisible: true });
    }
  };

  const handleDelete = async () => {
    if (!deleteId) return;
    
    // Prevent deleting read-only fields
    // Club admins can only delete their own club fields
    if (scope === 'CLUB' && user?.assigned_club) {
      const fieldToDelete = fields.find(f => f.id === deleteId);
      if (fieldToDelete) {
        const isOwnedByClubAdmin = fieldToDelete.owner_role === 'CLUB_ADMIN' && 
          (typeof fieldToDelete.club === 'object' ? fieldToDelete.club?.id : fieldToDelete.club) === (typeof user.assigned_club === 'object' ? user.assigned_club.id : user.assigned_club);
        
        if (!isOwnedByClubAdmin) {
          setToast({ message: 'You can only delete fields assigned to your club.', type: 'error', isVisible: true });
          setDeleteId(null);
          setShowDelete(false);
          return;
        }
      }
    }
    
    // Municipality admins can delete their own municipality fields and club fields in their municipality (not global super admin fields)
    if (scope === 'MUNICIPALITY' && user?.assigned_municipality) {
      const fieldToDelete = fields.find(f => f.id === deleteId);
      if (fieldToDelete) {
        const userMunicipalityId = typeof user.assigned_municipality === 'object' ? user.assigned_municipality.id : user.assigned_municipality;
        const fieldMunicipalityId = typeof fieldToDelete.municipality === 'object' ? fieldToDelete.municipality?.id : fieldToDelete.municipality;
        
        // Check if it's a municipality field owned by this municipality
        const isOwnedByMunicipalityAdmin = fieldToDelete.owner_role === 'MUNICIPALITY_ADMIN' && 
          fieldMunicipalityId === userMunicipalityId;
        
        // Check if it's a club field that belongs to a club in this municipality
        let isClubFieldInMunicipality = false;
        if (fieldToDelete.owner_role === 'CLUB_ADMIN' && fieldToDelete.club) {
          const fieldClubId = typeof fieldToDelete.club === 'object' ? fieldToDelete.club.id : fieldToDelete.club;
          const clubInMunicipality = clubs.find(c => c.id === fieldClubId);
          isClubFieldInMunicipality = !!clubInMunicipality;
        }
        
        // Only allow deleting if it's a municipality field or a club field in their municipality
        // Block global super admin fields
        if (fieldToDelete.owner_role === 'SUPER_ADMIN' || (!isOwnedByMunicipalityAdmin && !isClubFieldInMunicipality)) {
          setToast({ message: 'You can only delete fields assigned to your municipality or clubs in your municipality.', type: 'error', isVisible: true });
          setDeleteId(null);
          setShowDelete(false);
          return;
        }
      }
    }
    
    try {
      await api.delete(`/custom-fields/${deleteId}/`);
      setToast({ message: 'Field deleted', type: 'success', isVisible: true });
      setDeleteId(null);
      setShowDelete(false);
      fetchFields();
    } catch (err) {
      setToast({ message: 'Delete failed', type: 'error', isVisible: true });
    }
  };

  return (
    <div className="bg-white rounded-lg shadow p-6">
      <div className="flex justify-between items-center mb-6">
        <div>
          <h2 className="text-xl font-bold text-gray-800">Registration Fields</h2>
          <p className="text-sm text-gray-500">Customize the data users provide during registration.</p>
        </div>
        <button 
          onClick={handleOpenCreate}
          className="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition"
        >
          + Add Field
        </button>
      </div>

      {/* LIST */}
      <div className="overflow-x-auto">
        <table className="min-w-full divide-y divide-gray-200">
          <thead className="bg-gray-50">
            <tr>
              <th className="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase">Label</th>
              <th className="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase">Type</th>
              <th className="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase">Roles</th>
              <th className="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase">Req?</th>
              <th className="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase">Status</th>
              <th className="px-6 py-3 text-right">Action</th>
            </tr>
          </thead>
          <tbody className="divide-y divide-gray-200">
            {loading ? (
              <tr><td colSpan={6} className="p-4 text-center">Loading...</td></tr>
            ) : fields.length === 0 ? (
              <tr><td colSpan={6} className="p-4 text-center text-gray-500">No custom fields created yet.</td></tr>
            ) : fields.map(field => {
              // For club admins, check if field belongs to their club
              const isOwnedByClubAdmin = scope === 'CLUB' && user?.assigned_club && 
                field.owner_role === 'CLUB_ADMIN' && 
                (typeof field.club === 'object' ? field.club?.id : field.club) === (typeof user.assigned_club === 'object' ? user.assigned_club.id : user.assigned_club);
              
              // For municipality admins:
              // - Can edit their own municipality fields
              // - Can edit club fields that belong to clubs in their municipality
              // - Cannot edit global super admin fields
              let isOwnedByMunicipalityAdmin = false;
              let isClubFieldInMunicipality = false;
              
              if (scope === 'MUNICIPALITY' && user?.assigned_municipality) {
                const userMunicipalityId = typeof user.assigned_municipality === 'object' ? user.assigned_municipality.id : user.assigned_municipality;
                const fieldMunicipalityId = typeof field.municipality === 'object' ? field.municipality?.id : field.municipality;
                
                // Check if it's a municipality field owned by this municipality
                isOwnedByMunicipalityAdmin = field.owner_role === 'MUNICIPALITY_ADMIN' && 
                  fieldMunicipalityId === userMunicipalityId;
                
                // Check if it's a club field that belongs to a club in this municipality
                if (field.owner_role === 'CLUB_ADMIN' && field.club) {
                  // We need to check if the club belongs to this municipality
                  // Since we have clubs loaded for municipality admins, we can check against that
                  const fieldClubId = typeof field.club === 'object' ? field.club.id : field.club;
                  const clubInMunicipality = clubs.find(c => c.id === fieldClubId);
                  // If the club is in our clubs list (which is filtered by municipality), it's editable
                  isClubFieldInMunicipality = !!clubInMunicipality;
                }
              }
              
              // Fields that are not owned by the admin should be greyed out and disabled
              // Club admins can only edit their club fields
              // Municipality admins can edit their municipality fields and club fields in their municipality (only global super admin fields are read-only)
              const isReadOnly = (scope === 'CLUB' && !isOwnedByClubAdmin) || 
                                 (scope === 'MUNICIPALITY' && field.owner_role === 'SUPER_ADMIN');
              
              return (
                <tr key={field.id} className={isReadOnly ? 'opacity-50 bg-gray-50' : ''}>
                  <td className={`px-6 py-4 font-medium ${isReadOnly ? 'text-gray-500' : 'text-gray-900'}`}>
                    {field.name}
                    {isReadOnly && <span className="ml-2 text-xs text-gray-400">(Read-only)</span>}
                  </td>
                  <td className={`px-6 py-4 text-sm ${isReadOnly ? 'text-gray-400' : 'text-gray-600'}`}>
                    {field.field_type.replace('_', ' ')}
                  </td>
                  <td className={`px-6 py-4 text-sm flex gap-1 ${isReadOnly ? 'opacity-50' : ''}`}>
                    {field.target_roles.map(r => (
                      <span key={r} className="bg-gray-100 px-2 py-0.5 rounded text-xs">
                        {r === 'YOUTH_MEMBER' ? 'Youth' : 'Guardian'}
                      </span>
                    ))}
                  </td>
                  <td className={`px-6 py-4 text-sm ${isReadOnly ? 'text-gray-400' : ''}`}>
                    {field.required ? <span className="text-red-600 font-bold">Yes</span> : 'No'}
                  </td>
                  <td className={`px-6 py-4 ${isReadOnly ? 'opacity-50' : ''}`}>
                    {field.is_published 
                      ? <span className="bg-green-100 text-green-800 px-2 py-1 rounded text-xs font-bold">Active</span>
                      : <span className="bg-gray-100 text-gray-600 px-2 py-1 rounded text-xs font-bold">Draft</span>
                    }
                  </td>
                  <td className="px-6 py-4 text-right space-x-2">
                    {isReadOnly ? (
                      <span className="text-gray-400 text-sm italic">Read-only</span>
                    ) : (
                      <>
                        <button onClick={() => handleOpenEdit(field)} className="text-blue-600 hover:underline text-sm font-bold">Edit</button>
                        <button onClick={() => { setDeleteId(field.id); setShowDelete(true); }} className="text-red-600 hover:underline text-sm">Delete</button>
                      </>
                    )}
                  </td>
                </tr>
              );
            })}
          </tbody>
        </table>
      </div>

      {/* MODAL */}
      {showModal && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-xl shadow-xl w-full max-w-2xl p-6 max-h-[90vh] overflow-y-auto">
            <h2 className="text-2xl font-bold mb-4">{isEditing ? 'Edit Field' : 'Create Custom Field'}</h2>
            
            <form onSubmit={handleSubmit} className="space-y-5">
              {/* Row 1 */}
              <div className="grid grid-cols-2 gap-4">
                <div>
                  <label className="block text-sm font-bold mb-1">Field Label</label>
                  <input 
                    required 
                    type="text" 
                    className="w-full border p-2 rounded" 
                    placeholder="e.g. T-Shirt Size"
                    value={formData.name}
                    onChange={e => setFormData({...formData, name: e.target.value})}
                  />
                </div>
                <div>
                  <label className="block text-sm font-bold mb-1">Data Type</label>
                  <select 
                    className="w-full border p-2 rounded"
                    value={formData.field_type}
                    // @ts-ignore
                    onChange={e => setFormData({...formData, field_type: e.target.value})}
                  >
                    <option value="TEXT">Text (Free type)</option>
                    <option value="SINGLE_SELECT">Single Select (Dropdown)</option>
                    <option value="MULTI_SELECT">Multi Select (Checkboxes)</option>
                    <option value="BOOLEAN">Boolean (Yes/No Checkbox)</option>
                  </select>
                </div>
              </div>

              {/* NEW ROW: Usage Context */}
              <div>
                <label className="block text-sm font-bold mb-1">Used For</label>
                <div className="flex gap-4">
                  <label className="flex items-center gap-2 cursor-pointer border p-3 rounded-lg w-full hover:bg-gray-50">
                    <input 
                      type="radio" 
                      name="context"
                      value="USER_PROFILE"
                      checked={formData.context === 'USER_PROFILE'}
                      onChange={e => setFormData({...formData, context: e.target.value})}
                      className="text-blue-600"
                    />
                    <div>
                      <span className="block font-bold text-gray-800">User Profile</span>
                      <span className="text-xs text-gray-500">Shown during registration/profile edit</span>
                    </div>
                  </label>
                  <label className="flex items-center gap-2 cursor-pointer border p-3 rounded-lg w-full hover:bg-gray-50">
                    <input 
                      type="radio" 
                      name="context"
                      value="EVENT"
                      checked={formData.context === 'EVENT'}
                      onChange={e => setFormData({...formData, context: e.target.value})}
                      className="text-blue-600"
                    />
                    <div>
                      <span className="block font-bold text-gray-800">Event Booking</span>
                      <span className="text-xs text-gray-500">Shown when booking an event ticket</span>
                    </div>
                  </label>
                </div>
              </div>

              {/* Help Text */}
              <div>
                <label className="block text-sm font-bold mb-1">Help Text (Optional)</label>
                <input 
                  type="text" 
                  className="w-full border p-2 rounded text-sm text-gray-600" 
                  placeholder="e.g. Please select the size for your team jersey"
                  value={formData.help_text}
                  onChange={e => setFormData({...formData, help_text: e.target.value})}
                />
              </div>

              {/* OPTIONS BUILDER (Only for Selects) */}
              {(formData.field_type === 'SINGLE_SELECT' || formData.field_type === 'MULTI_SELECT') && (
                <div className="bg-blue-50 p-4 rounded border border-blue-100">
                  <label className="block text-sm font-bold mb-2 text-blue-800">Options List</label>
                  <div className="flex gap-2 mb-2">
                    <input 
                      type="text" 
                      className="flex-1 border p-2 rounded text-sm"
                      placeholder="Type option and press Add..."
                      value={formData.currentOptionInput}
                      onChange={e => setFormData({...formData, currentOptionInput: e.target.value})}
                      onKeyDown={e => e.key === 'Enter' && (e.preventDefault(), addOption())}
                    />
                    <button type="button" onClick={addOption} className="bg-blue-600 text-white px-3 py-1 rounded text-sm font-bold">Add</button>
                  </div>
                  
                  <div className="flex flex-wrap gap-2">
                    {formData.options.map((opt, idx) => (
                      <span key={idx} className="bg-white border border-blue-200 text-blue-800 px-2 py-1 rounded text-sm flex items-center gap-2">
                        {opt}
                        <button type="button" onClick={() => removeOption(idx)} className="text-red-500 font-bold hover:text-red-700">√ó</button>
                      </span>
                    ))}
                    {formData.options.length === 0 && <span className="text-xs text-gray-500 italic">No options added yet.</span>}
                  </div>
                </div>
              )}

              {/* TARGET ROLES */}
              <div>
                <label className="block text-sm font-bold mb-2">Who should verify this?</label>
                <div className="flex gap-4">
                  <label className="flex items-center gap-2 cursor-pointer">
                    <input 
                      type="checkbox" 
                      checked={formData.target_roles.includes('YOUTH_MEMBER')}
                      onChange={() => toggleRole('YOUTH_MEMBER')}
                      className="w-5 h-5 text-blue-600"
                    />
                    <span>Youth Members</span>
                  </label>
                  <label className="flex items-center gap-2 cursor-pointer">
                    <input 
                      type="checkbox" 
                      checked={formData.target_roles.includes('GUARDIAN')}
                      onChange={() => toggleRole('GUARDIAN')}
                      className="w-5 h-5 text-blue-600"
                    />
                    <span>Guardians</span>
                  </label>
                </div>
              </div>

              {/* SETTINGS */}
              <div className="flex gap-6 bg-gray-50 p-3 rounded">
                <label className="flex items-center gap-2 cursor-pointer">
                  <input 
                    type="checkbox" 
                    checked={formData.required}
                    onChange={e => setFormData({...formData, required: e.target.checked})}
                    className="w-5 h-5 text-red-600"
                  />
                  <span className="font-medium">Required Field</span>
                </label>
                
                <label className="flex items-center gap-2 cursor-pointer">
                  <input 
                    type="checkbox" 
                    checked={formData.is_published}
                    onChange={e => setFormData({...formData, is_published: e.target.checked})}
                    className="w-5 h-5 text-green-600"
                  />
                  <span className="font-medium">Published (Active)</span>
                </label>
              </div>

              {/* MUNICIPALITY SPECIFIC: LIMIT TO CLUBS */}
              {scope === 'MUNICIPALITY' && (
                <div className="border-t pt-4">
                  <label className="block text-sm font-bold mb-2">Limit to Specific Clubs (Optional)</label>
                  <p className="text-xs text-gray-500 mb-2">If no clubs are selected, this field applies to ALL clubs in your municipality.</p>
                  <div className="max-h-32 overflow-y-auto border rounded p-2 grid grid-cols-2 gap-2">
                    {clubs.map(club => (
                      <label key={club.id} className="flex items-center gap-2 text-sm">
                        <input 
                          type="checkbox" 
                          checked={formData.specific_clubs.includes(club.id)}
                          onChange={() => toggleClub(club.id)}
                        />
                        {club.name}
                      </label>
                    ))}
                  </div>
                </div>
              )}

              <div className="flex justify-end gap-4 pt-4 border-t">
                <button type="button" onClick={() => setShowModal(false)} className="text-gray-500">Cancel</button>
                <button type="submit" className="bg-blue-600 text-white px-6 py-2 rounded font-bold hover:bg-blue-700">Save Field</button>
              </div>
            </form>
          </div>
        </div>
      )}

      <DeleteConfirmationModal 
        isVisible={showDelete}
        onClose={() => setShowDelete(false)}
        onConfirm={handleDelete}
        itemName="this field"
        message="Deleting this field will remove all data users have entered for it. This cannot be undone."
      />

      <Toast {...toast} onClose={() => setToast({...toast, isVisible: false})} />
    </div>
  );
}
--- END OF FILE: ./frontend/app/components/CustomFieldManager.tsx ---


--- START OF FILE: ./frontend/app/components/Toast.tsx ---
'use client';

import { useEffect } from 'react';

interface ToastProps {
  message: string;
  type?: 'success' | 'error' | 'info' | 'warning';
  isVisible: boolean;
  onClose: () => void;
  duration?: number;
}

export default function Toast({ 
  message, 
  type = 'success', 
  isVisible, 
  onClose, 
  duration = 3000 
}: ToastProps) {
  useEffect(() => {
    if (isVisible) {
      const timer = setTimeout(() => {
        onClose();
      }, duration);
      return () => clearTimeout(timer);
    }
  }, [isVisible, duration, onClose]);

  if (!isVisible) return null;

  const bgColors = {
    success: 'bg-green-500',
    error: 'bg-red-500',
    info: 'bg-blue-500',
    warning: 'bg-yellow-500',
  };

  const icons = {
    success: (
      <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
      </svg>
    ),
    error: (
      <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
      </svg>
    ),
    info: (
      <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
      </svg>
    ),
    warning: (
      <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
      </svg>
    ),
  };

  return (
    <div className="fixed top-4 right-4 z-50 animate-slide-in">
      <div className={`${bgColors[type]} text-white px-6 py-4 rounded-lg shadow-lg flex items-center gap-3 min-w-[300px] max-w-md transition-all duration-300`}>
        <div className="flex-shrink-0">
          {icons[type]}
        </div>
        <p className="flex-1 font-medium">{message}</p>
        <button
          onClick={onClose}
          className="flex-shrink-0 hover:bg-white/20 rounded p-1 transition-colors"
          aria-label="Close"
        >
          <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>
    </div>
  );
}


--- END OF FILE: ./frontend/app/components/Toast.tsx ---


--- START OF FILE: ./frontend/app/components/RewardForm.tsx ---
'use client';

import { useState, useEffect } from 'react';
import { useRouter } from 'next/navigation';
import api from '../../lib/api';
import Toast from './Toast';
import { getMediaUrl } from '../utils';

interface Option { id: number; name: string; }

interface RewardFormProps {
  initialData?: any;
  redirectPath: string;
}

const GRADES = Array.from({ length: 13 }, (_, i) => i + 1); // [1...13]
const GENDERS = [
  { value: 'MALE', label: 'Male' },
  { value: 'FEMALE', label: 'Female' },
  { value: 'OTHER', label: 'Other' },
];

const TRIGGERS = [
  { value: 'BIRTHDAY', label: 'üéÇ On Birthday', desc: 'Given automatically on member\'s birthday' },
  { value: 'WELCOME', label: 'üëã On Signup', desc: 'Given immediately after registration' },
  { value: 'VERIFIED', label: '‚úÖ On Verification', desc: 'Given when account is verified' },
  { value: 'MOST_ACTIVE', label: 'üî• Most Active', desc: 'Awarded to users with most logins' },
];

export default function RewardForm({ initialData, redirectPath }: RewardFormProps) {
  const router = useRouter();
  const [loading, setLoading] = useState(false);
  
  // Dropdown Data
  const [groups, setGroups] = useState<Option[]>([]);
  const [interests, setInterests] = useState<Option[]>([]);
  
  const [toast, setToast] = useState({ message: '', type: 'success' as 'success'|'error', isVisible: false });

  // Files
  const [imageFile, setImageFile] = useState<File | null>(null);
  const [imagePreview, setImagePreview] = useState<string | null>(null);

  // Form State
  const [formData, setFormData] = useState({
    name: '',
    description: '',
    sponsor_name: '',
    sponsor_link: '',
    
    // Targeting
    target_groups: [] as number[],
    target_interests: [] as number[],
    target_genders: [] as string[],
    target_grades: [] as number[],
    min_age: '',
    max_age: '',
    target_member_type: 'YOUTH_MEMBER', // <--- WAS 'YOUTH'

    // Constraints
    expiration_date: '',
    usage_limit: '', // Empty = Unlimited

    // Triggers
    active_triggers: [] as string[],
    trigger_config: {} as any,
    
    is_active: true
  });

  useEffect(() => {
    fetchDropdowns();
    if (initialData) {
      loadInitialData();
    }
  }, [initialData]);

  const fetchDropdowns = async () => {
    try {
      const [grpRes, intRes] = await Promise.all([
        api.get('/groups/'),
        api.get('/interests/')
      ]);
      setGroups(Array.isArray(grpRes.data) ? grpRes.data : grpRes.data.results || []);
      setInterests(Array.isArray(intRes.data) ? intRes.data : intRes.data.results || []);
    } catch (err) {
      console.error(err);
    }
  };

  const loadInitialData = () => {
    setFormData({
      name: initialData.name || '',
      description: initialData.description || '',
      sponsor_name: initialData.sponsor_name || '',
      sponsor_link: initialData.sponsor_link || '',
      target_groups: initialData.target_groups || [],
      target_interests: initialData.target_interests || [],
      target_genders: initialData.target_genders || [],
      target_grades: initialData.target_grades || [],
      min_age: initialData.min_age || '',
      max_age: initialData.max_age || '',
      target_member_type: initialData.target_member_type || 'YOUTH_MEMBER',
      expiration_date: initialData.expiration_date || '',
      usage_limit: initialData.usage_limit || '',
      active_triggers: initialData.active_triggers || [],
      trigger_config: initialData.trigger_config || {},
      is_active: initialData.is_active ?? true,
    });
    if (initialData.image) {
      setImagePreview(getMediaUrl(initialData.image));
    }
  };

  // --- Helpers ---

  const handleArrayToggle = (field: keyof typeof formData, value: any) => {
    setFormData(prev => {
      const currentList = prev[field] as any[];
      if (currentList.includes(value)) {
        return { ...prev, [field]: currentList.filter(i => i !== value) };
      }
      return { ...prev, [field]: [...currentList, value] };
    });
  };

  const handleFileChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    if (e.target.files?.[0]) {
      setImageFile(e.target.files[0]);
      setImagePreview(URL.createObjectURL(e.target.files[0]));
    }
  };

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setLoading(true);

    const data = new FormData();
    // Append standard fields
    Object.entries(formData).forEach(([key, value]) => {
      if (key === 'target_groups' || key === 'target_interests' || key === 'target_genders' || key === 'target_grades' || key === 'active_triggers') return; // Handle arrays separately
      if (key === 'trigger_config') {
        data.append(key, JSON.stringify(value));
        return;
      }
      if (value === null || value === '') return; // Skip empty
      data.append(key, value.toString());
    });

    // Append Arrays (ManyToMany fields - DRF handles multiple values automatically)
    formData.target_groups.forEach(id => data.append('target_groups', id.toString()));
    formData.target_interests.forEach(id => data.append('target_interests', id.toString()));
    
    // JSON Fields - Send as JSON strings since DRF's MultiPartParser doesn't auto-convert to lists for JSONFields
    // The serializer will parse these JSON strings back to lists
    // Always send these fields, even if empty (send as "[]")
    data.append('target_genders', JSON.stringify(formData.target_genders || []));
    data.append('target_grades', JSON.stringify(formData.target_grades || []));
    data.append('active_triggers', JSON.stringify(formData.active_triggers || []));

    if (imageFile) data.append('image', imageFile);

    try {
      if (initialData) {
        await api.patch(`/rewards/${initialData.id}/`, data, { headers: { 'Content-Type': 'multipart/form-data' } });
        setToast({ message: 'Reward updated!', type: 'success', isVisible: true });
      } else {
        await api.post('/rewards/', data, { headers: { 'Content-Type': 'multipart/form-data' } });
        setToast({ message: 'Reward created!', type: 'success', isVisible: true });
      }
      setTimeout(() => router.push(redirectPath), 1000);
    } catch (err) {
      console.error(err);
      setToast({ message: 'Operation failed.', type: 'error', isVisible: true });
      setLoading(false);
    }
  };

  return (
    <form onSubmit={handleSubmit} className="space-y-8 max-w-5xl mx-auto pb-20">
      
      {/* 1. INFO */}
      <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-100 space-y-4">
        <h3 className="text-lg font-bold text-gray-900 border-b pb-2">1. Reward Details</h3>
        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div className="space-y-4">
            <div>
              <label className="block text-sm font-bold mb-1">Reward Title</label>
              <input required type="text" className="w-full border p-2 rounded" placeholder="e.g. Free Coffee"
                value={formData.name} onChange={e => setFormData({...formData, name: e.target.value})} />
            </div>
            <div>
              <label className="block text-sm font-bold mb-1">Sponsor Name</label>
              <input type="text" className="w-full border p-2 rounded" placeholder="e.g. Local Cafe"
                value={formData.sponsor_name} onChange={e => setFormData({...formData, sponsor_name: e.target.value})} />
            </div>
            <div>
              <label className="block text-sm font-bold mb-1">Sponsor Link (Optional)</label>
              <input type="url" className="w-full border p-2 rounded" placeholder="https://..."
                value={formData.sponsor_link} onChange={e => setFormData({...formData, sponsor_link: e.target.value})} />
            </div>
          </div>
          <div>
            <label className="block text-sm font-bold mb-1">Reward Image</label>
            <div className="border-2 border-dashed border-gray-300 rounded-lg p-4 text-center h-48 flex flex-col items-center justify-center bg-gray-50">
              {imagePreview ? (
                <img src={imagePreview} alt="Preview" className="h-full object-contain mb-2" />
              ) : (
                <span className="text-gray-400 text-sm mb-2">No image selected</span>
              )}
              <input type="file" accept="image/*" onChange={handleFileChange} className="text-xs" />
            </div>
          </div>
        </div>
        <div>
          <label className="block text-sm font-bold mb-1">Description & Redemption Instructions</label>
          <textarea required rows={4} className="w-full border p-2 rounded" 
            placeholder="Explain what the reward is and how to use it..."
            value={formData.description} onChange={e => setFormData({...formData, description: e.target.value})} />
        </div>
      </div>

      {/* 2. TARGETING */}
      <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-100 space-y-6">
        <h3 className="text-lg font-bold text-gray-900 border-b pb-2">2. Who gets this reward?</h3>
        
        {/* Role Selection */}
        <div className="flex gap-6">
          <label className="flex items-center gap-2 cursor-pointer">
            <input type="radio" name="member_type" value="YOUTH_MEMBER" // <--- WAS "YOUTH"
              checked={formData.target_member_type === 'YOUTH_MEMBER'} // <--- WAS 'YOUTH'
              onChange={e => setFormData({...formData, target_member_type: e.target.value})}
              className="w-5 h-5 text-blue-600" />
            <span className="font-bold">Youth Members</span>
          </label>
          <label className="flex items-center gap-2 cursor-pointer">
            <input type="radio" name="member_type" value="GUARDIAN" 
              checked={formData.target_member_type === 'GUARDIAN'}
              onChange={e => setFormData({...formData, target_member_type: e.target.value})}
              className="w-5 h-5 text-blue-600" />
            <span className="font-bold">Guardians</span>
          </label>
        </div>

        {/* Groups & Interests */}
        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <label className="block text-sm font-bold mb-2">Target Groups (Optional)</label>
            <div className="h-40 overflow-y-auto border p-2 rounded bg-gray-50 space-y-1">
              {groups.map(g => (
                <label key={g.id} className="flex items-center gap-2 text-sm">
                  <input type="checkbox" checked={formData.target_groups.includes(g.id)}
                    onChange={() => handleArrayToggle('target_groups', g.id)} />
                  {g.name}
                </label>
              ))}
              {groups.length === 0 && <p className="text-xs text-gray-400">No groups available.</p>}
            </div>
          </div>
          <div>
            <label className="block text-sm font-bold mb-2">Target Interests (Optional)</label>
            <div className="h-40 overflow-y-auto border p-2 rounded bg-gray-50 space-y-1">
              {interests.map(i => (
                <label key={i.id} className="flex items-center gap-2 text-sm">
                  <input type="checkbox" checked={formData.target_interests.includes(i.id)}
                    onChange={() => handleArrayToggle('target_interests', i.id)} />
                  {i.name}
                </label>
              ))}
            </div>
          </div>
        </div>

        {/* Demographics (Only for Youth) */}
        {formData.target_member_type === 'YOUTH_MEMBER' && ( // <--- WAS 'YOUTH'
          <div className="space-y-4 pt-4 border-t border-gray-100">
            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div>
                <label className="block text-sm font-bold mb-2">Age Range</label>
                <div className="flex gap-2 items-center">
                  <input type="number" placeholder="Min" className="w-20 border p-2 rounded" 
                    value={formData.min_age} onChange={e => setFormData({...formData, min_age: e.target.value})} />
                  <span>to</span>
                  <input type="number" placeholder="Max" className="w-20 border p-2 rounded" 
                    value={formData.max_age} onChange={e => setFormData({...formData, max_age: e.target.value})} />
                </div>
              </div>
              <div>
                <label className="block text-sm font-bold mb-2">Gender</label>
                <div className="flex gap-4">
                  {GENDERS.map(g => (
                    <label key={g.value} className="flex items-center gap-2 text-sm">
                      <input type="checkbox" checked={formData.target_genders.includes(g.value)}
                        onChange={() => handleArrayToggle('target_genders', g.value)} />
                      {g.label}
                    </label>
                  ))}
                </div>
              </div>
            </div>
            
            <div>
              <label className="block text-sm font-bold mb-2">Grades</label>
              <div className="flex flex-wrap gap-2">
                {GRADES.map(g => (
                  <button type="button" key={g} onClick={() => handleArrayToggle('target_grades', g)}
                    className={`w-8 h-8 rounded text-sm font-bold border transition
                      ${formData.target_grades.includes(g) ? 'bg-blue-600 text-white border-blue-600' : 'bg-white text-gray-500 border-gray-300'}
                    `}>
                    {g}
                  </button>
                ))}
              </div>
            </div>
          </div>
        )}
      </div>

      {/* 3. CONSTRAINTS */}
      <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-100 space-y-4">
        <h3 className="text-lg font-bold text-gray-900 border-b pb-2">3. Limits & Expiration</h3>
        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <label className="block text-sm font-bold mb-1">Expiration Date</label>
            <input type="date" className="w-full border p-2 rounded" 
              value={formData.expiration_date} onChange={e => setFormData({...formData, expiration_date: e.target.value})} />
          </div>
          <div>
            <label className="block text-sm font-bold mb-1">Total Usage Limit</label>
            <input type="number" className="w-full border p-2 rounded" placeholder="Leave empty for unlimited"
              value={formData.usage_limit} onChange={e => setFormData({...formData, usage_limit: e.target.value})} />
          </div>
        </div>
      </div>

      {/* 4. TRIGGERS */}
      <div className="bg-white p-6 rounded-xl shadow-sm border border-gray-100 space-y-4">
        <h3 className="text-lg font-bold text-gray-900 border-b pb-2">4. Automatic Triggers (Optional)</h3>
        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
          {TRIGGERS.map(t => (
            <label key={t.value} className={`border p-4 rounded-lg cursor-pointer transition flex items-start gap-3
              ${formData.active_triggers.includes(t.value) ? 'bg-green-50 border-green-500' : 'hover:bg-gray-50'}
            `}>
              <input type="checkbox" className="mt-1" 
                checked={formData.active_triggers.includes(t.value)}
                onChange={() => {
                  // For simplistic UI, let's treat JSONField array just like other arrays
                  const current = [...formData.active_triggers];
                  if (current.includes(t.value)) {
                    setFormData({...formData, active_triggers: current.filter(x => x !== t.value)});
                  } else {
                    setFormData({...formData, active_triggers: [...current, t.value]});
                  }
                }}
              />
              <div>
                <span className="block font-bold text-gray-900">{t.label}</span>
                <span className="text-xs text-gray-500">{t.desc}</span>
              </div>
            </label>
          ))}
        </div>
      </div>

      {/* ACTIONS */}
      <div className="flex justify-end gap-4 pt-4">
        <button type="button" onClick={() => router.back()} className="px-6 py-2 text-gray-600 hover:bg-gray-100 rounded-lg font-bold">
          Cancel
        </button>
        <button type="submit" disabled={loading} className="px-8 py-2 bg-green-600 text-white rounded-lg font-bold hover:bg-green-700 shadow-lg disabled:opacity-50">
          {loading ? 'Saving...' : (initialData ? 'Update Reward' : 'Create Reward')}
        </button>
      </div>

      <Toast {...toast} onClose={() => setToast({...toast, isVisible: false})} />
    </form>
  );
}
--- END OF FILE: ./frontend/app/components/RewardForm.tsx ---


--- START OF FILE: ./frontend/app/components/MemberSelector.tsx ---
'use client';

import { useState, useEffect } from 'react';
import api from '../../lib/api';
import { getMediaUrl } from '../../app/utils';

interface User {
  id: number;
  first_name: string;
  last_name: string;
  email: string;
  avatar: string | null;
  grade?: number;
  age?: number; // Calculated on backend or frontend
}

interface MemberSelectorProps {
  criteria: {
    target_member_type: string;
    min_age: string | number;
    max_age: string | number;
    grades: number[];
    genders: string[];
    interests: number[];
    custom_field_rules?: Record<string, any>; // NEW: Custom field rules
  };
  selectedIds: number[];
  onChange: (ids: number[]) => void;
  excludeGroupId?: number; // To exclude people already in the group (Edit mode)
}

export default function MemberSelector({ criteria, selectedIds, onChange, excludeGroupId }: MemberSelectorProps) {
  const [candidates, setCandidates] = useState<User[]>([]);
  const [loading, setLoading] = useState(false);
  const [searchTerm, setSearchTerm] = useState('');
  const [hasSearched, setHasSearched] = useState(false);

  // Auto-fetch when criteria changes significantly, or manual refresh
  const fetchCandidates = async () => {
    setLoading(true);
    try {
      const params = new URLSearchParams();
      
      // Map criteria to API params
      params.set('target_member_type', criteria.target_member_type);
      if (criteria.min_age) params.set('min_age', criteria.min_age.toString());
      if (criteria.max_age) params.set('max_age', criteria.max_age.toString());
      if (criteria.grades.length > 0) params.set('grades', criteria.grades.join(','));
      if (criteria.genders.length > 0) params.set('genders', criteria.genders.join(','));
      if (criteria.interests.length > 0) params.set('interests', criteria.interests.join(','));
      
      // NEW: Add custom field rules
      if (criteria.custom_field_rules && Object.keys(criteria.custom_field_rules).length > 0) {
        params.set('custom_field_rules', JSON.stringify(criteria.custom_field_rules));
      }
      
      if (searchTerm) params.set('search', searchTerm);
      if (excludeGroupId) params.set('exclude_group', excludeGroupId.toString());
      
      // Get all candidates (pagination handled by backend, but for selector we might want a reasonable limit or load more)
      // For now, let's get the first page (default 10) or set a higher page_size
      params.set('page_size', '50'); 

      const res = await api.get(`/groups/search_candidates/?${params.toString()}`);
      const data = Array.isArray(res.data) ? res.data : res.data.results;
      setCandidates(data || []);
      setHasSearched(true);
    } catch (err) {
      console.error("Failed to search members", err);
    } finally {
      setLoading(false);
    }
  };

  const toggleUser = (id: number) => {
    if (selectedIds.includes(id)) {
      onChange(selectedIds.filter(sid => sid !== id));
    } else {
      onChange([...selectedIds, id]);
    }
  };

  const selectAllVisible = () => {
    const visibleIds = candidates.map(c => c.id);
    // Add only ones not already selected
    const newIds = [...selectedIds];
    visibleIds.forEach(id => {
      if (!newIds.includes(id)) newIds.push(id);
    });
    onChange(newIds);
  };

  const clearSelection = () => {
    onChange([]);
  };

  return (
    <div className="border rounded-xl overflow-hidden bg-white shadow-sm">
      <div className="p-4 bg-gray-50 border-b flex flex-col gap-4">
        <div className="flex justify-between items-center">
          <h4 className="font-bold text-gray-800">Add Members</h4>
          <div className="text-sm text-gray-500">
            {selectedIds.length} selected
          </div>
        </div>

        <div className="flex gap-2">
          <input 
            type="text" 
            placeholder="Search by name or email..." 
            className="flex-1 border rounded-lg px-3 py-2 text-sm"
            value={searchTerm}
            onChange={(e) => setSearchTerm(e.target.value)}
            onKeyDown={(e) => e.key === 'Enter' && fetchCandidates()}
          />
          <button 
            type="button" 
            onClick={fetchCandidates}
            disabled={loading}
            className="bg-indigo-600 text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-indigo-700 disabled:opacity-50"
          >
            {loading ? 'Searching...' : 'Find Matches'}
          </button>
        </div>
        
        <p className="text-xs text-gray-500">
          Showing users matching the rules defined above (Age, Grade, etc.)
        </p>
      </div>

      {/* LIST */}
      <div className="max-h-80 overflow-y-auto p-2">
        {!hasSearched && (
          <div className="text-center py-8 text-gray-400 text-sm">
            Click "Find Matches" to see eligible users.
          </div>
        )}

        {hasSearched && candidates.length === 0 && (
          <div className="text-center py-8 text-gray-400 text-sm">
            No eligible users found matching criteria.
          </div>
        )}

        {candidates.length > 0 && (
          <div className="space-y-1">
            <div className="flex justify-end px-2 mb-2">
              <button type="button" onClick={selectAllVisible} className="text-xs text-indigo-600 font-bold hover:underline">Select All</button>
            </div>
            
            {candidates.map(user => {
              const isSelected = selectedIds.includes(user.id);
              return (
                <div 
                  key={user.id} 
                  onClick={() => toggleUser(user.id)}
                  className={`flex items-center gap-3 p-3 rounded-lg cursor-pointer border transition-colors
                    ${isSelected ? 'bg-indigo-50 border-indigo-200' : 'bg-white border-transparent hover:bg-gray-50'}
                  `}
                >
                  <div className={`w-5 h-5 rounded border flex items-center justify-center flex-shrink-0
                    ${isSelected ? 'bg-indigo-600 border-indigo-600' : 'border-gray-300'}
                  `}>
                    {isSelected && <svg className="w-3 h-3 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={3} d="M5 13l4 4L19 7" /></svg>}
                  </div>

                  {user.avatar ? (
                    <img src={getMediaUrl(user.avatar) || ''} className="w-8 h-8 rounded-full object-cover bg-gray-200" />
                  ) : (
                    <div className="w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center text-xs font-bold text-gray-500">
                      {user.first_name.charAt(0)}
                    </div>
                  )}

                  <div className="flex-1 min-w-0">
                    <p className="text-sm font-bold text-gray-900 truncate">
                      {user.first_name} {user.last_name}
                    </p>
                    <p className="text-xs text-gray-500 truncate">{user.email}</p>
                  </div>

                  {user.grade && (
                    <span className="text-xs bg-gray-100 text-gray-600 px-2 py-1 rounded">Gr {user.grade}</span>
                  )}
                </div>
              );
            })}
          </div>
        )}
      </div>
    </div>
  );
}
--- END OF FILE: ./frontend/app/components/MemberSelector.tsx ---


--- START OF FILE: ./frontend/app/components/posts/PostForm.tsx ---
'use client';

import { useState, useEffect } from 'react';
import { useRouter } from 'next/navigation';
import api from '../../../lib/api';
import { Post, PostImage } from '../../../types/post';
import RichTextEditor from '../RichTextEditor';
import { getMediaUrl } from '../../utils';
import Toast from '../Toast';
import { useAuth } from '../../../context/AuthContext';

interface PostFormProps {
    initialData?: Post;
    role: 'super' | 'municipality' | 'club';
    onSuccess: () => void;
}

export default function PostForm({ initialData, role, onSuccess }: PostFormProps) {
    const router = useRouter();
    const { user: currentUser } = useAuth();
    const [loading, setLoading] = useState(false);
    const [error, setError] = useState('');
    const [toast, setToast] = useState<{ message: string; type: 'success' | 'error' | 'info' | 'warning'; isVisible: boolean }>({
        message: '', type: 'success', isVisible: false,
    });

    // --- Dynamic Data ---
    const [municipalities, setMunicipalities] = useState<any[]>([]);
    const [clubs, setClubs] = useState<any[]>([]);
    const [availableGroups, setAvailableGroups] = useState<any[]>([]);
    const [availableInterests, setAvailableInterests] = useState<any[]>([]);
    const [availableCustomFields, setAvailableCustomFields] = useState<any[]>([]);

    // --- 1. Distribution (Scope) State ---
    const getInitialDistributionMode = (): 'GLOBAL' | 'MUNICIPALITY' | 'CLUB' => {
        if (initialData) {
            if (initialData.is_global) return 'GLOBAL';
            if (initialData.target_municipalities?.length) return 'MUNICIPALITY';
            return 'CLUB';
        }
        if (role === 'super') return 'GLOBAL';
        if (role === 'municipality') return 'MUNICIPALITY';
        return 'CLUB';
    };
    
    const [distributionMode, setDistributionMode] = useState<'GLOBAL' | 'MUNICIPALITY' | 'CLUB'>(getInitialDistributionMode());
    const [selectedMunis, setSelectedMunis] = useState<number[]>(initialData?.target_municipalities || []);
    const [selectedClubs, setSelectedClubs] = useState<number[]>(initialData?.target_clubs || []);
    
    // For Muni Admin: "All Clubs" vs "Specific"
    const [muniScope, setMuniScope] = useState<'ALL' | 'SPECIFIC'>(
        (initialData?.target_clubs && initialData.target_clubs.length > 0) ? 'SPECIFIC' : 'ALL'
    );

    // --- 2. Basic Info ---
    const [title, setTitle] = useState(initialData?.title || '');
    const [content, setContent] = useState(initialData?.content || '');
    const [postType, setPostType] = useState(initialData?.post_type || 'TEXT');
    const [videoUrl, setVideoUrl] = useState(initialData?.video_url || '');
    const [existingImages, setExistingImages] = useState<PostImage[]>(initialData?.images || []);
    const [newImages, setNewImages] = useState<File[]>([]);
    const [imagesToDelete, setImagesToDelete] = useState<number[]>([]);

    // --- 3. Status & Scheduling ---
    const [status, setStatus] = useState(initialData?.status || 'DRAFT');
    const [publishedAt, setPublishedAt] = useState(initialData?.published_at ? initialData.published_at.slice(0, 16) : '');
    const [visibilityEndDate, setVisibilityEndDate] = useState(initialData?.visibility_end_date ? initialData.visibility_end_date.slice(0, 16) : '');
    const [isPinned, setIsPinned] = useState(initialData?.is_pinned || false);

    // --- 4. Targeting (Audience) ---
    const [targetMode, setTargetMode] = useState<'GROUPS' | 'ATTRIBUTES'>(
        (initialData?.target_groups && initialData.target_groups.length > 0) ? 'GROUPS' : 'ATTRIBUTES'
    );
    const [selectedGroups, setSelectedGroups] = useState<number[]>(initialData?.target_groups || []);
    const [memberType, setMemberType] = useState(initialData?.target_member_type || 'BOTH');
    const [minAge, setMinAge] = useState(initialData?.target_min_age?.toString() || '');
    const [maxAge, setMaxAge] = useState(initialData?.target_max_age?.toString() || '');
    const [selectedGrades, setSelectedGrades] = useState<number[]>(initialData?.target_grades || []);
    const [selectedGenders, setSelectedGenders] = useState<string[]>(initialData?.target_genders || []);
    const [selectedInterests, setSelectedInterests] = useState<number[]>(initialData?.target_interests || []);
    const [customFieldRules, setCustomFieldRules] = useState<Record<string, any>>(initialData?.target_custom_fields || {});

    // --- 5. Settings ---
    const [allowComments, setAllowComments] = useState(initialData?.allow_comments ?? true);
    const [requireModeration, setRequireModeration] = useState(initialData?.require_moderation ?? false);
    const [allowReplies, setAllowReplies] = useState(initialData?.allow_replies ?? true);
    const [limitComments, setLimitComments] = useState(initialData?.limit_comments_per_user || 0);
    const [sendPush, setSendPush] = useState(initialData?.send_push_notification || false);
    const [pushTitle, setPushTitle] = useState(initialData?.push_title || '');
    const [pushMessage, setPushMessage] = useState(initialData?.push_message || '');

    // --- Data Fetching ---
    useEffect(() => {
        const loadData = async () => {
            try {
                // 1. Basic Lists
                const groupsRes = await api.get('/groups/');
                setAvailableGroups(Array.isArray(groupsRes.data) ? groupsRes.data : groupsRes.data.results || []);

                const interestsRes = await api.get('/interests/');
                setAvailableInterests(Array.isArray(interestsRes.data) ? interestsRes.data : interestsRes.data.results || []);

                const fieldsRes = await api.get('/custom-fields/');
                const allFields = Array.isArray(fieldsRes.data) ? fieldsRes.data : fieldsRes.data.results || [];
                setAvailableCustomFields(allFields.filter((f: any) => 
                    ['BOOLEAN', 'SINGLE_SELECT', 'MULTI_SELECT'].includes(f.field_type)
                ));

                // 2. Admin Specific Lists
                if (role === 'super') {
                    const muniRes = await api.get('/municipalities/');
                    setMunicipalities(Array.isArray(muniRes.data) ? muniRes.data : muniRes.data.results || []);
                    
                    const clubRes = await api.get('/clubs/?page_size=1000');
                    setClubs(Array.isArray(clubRes.data) ? clubRes.data : clubRes.data.results || []);
                } 
                else if (role === 'municipality') {
                    // Municipality Admins only need the clubs in their muni (API handles filtering)
                    const clubRes = await api.get('/clubs/?page_size=1000');
                    setClubs(Array.isArray(clubRes.data) ? clubRes.data : clubRes.data.results || []);
                }
                // Club admins don't need to fetch external clubs or munis

            } catch (err) {
                console.error("Failed to load form data", err);
            }
        };
        loadData();
    }, [role]);

    // --- Helpers ---
    const toggleSelection = (id: any, list: any[], setList: (l: any[]) => void) => {
        if (list.includes(id)) setList(list.filter(item => item !== id));
        else setList([...list, id]);
    };

    const handleSubmit = async (e: React.FormEvent) => {
        e.preventDefault();
        setLoading(true);
        setError('');
        const formData = new FormData();

        // 1. Basic
        formData.append('title', title);
        formData.append('content', content);
        formData.append('post_type', postType);
        if (videoUrl) formData.append('video_url', videoUrl);

        // 2. Distribution Logic
        let isGlobal = false;
        let targetMunis: number[] = [];
        let targetClubs: number[] = [];

        if (role === 'super') {
            if (distributionMode === 'GLOBAL') isGlobal = true;
            else if (distributionMode === 'MUNICIPALITY') targetMunis = selectedMunis;
            else targetClubs = selectedClubs;
        } 
        else if (role === 'municipality') {
            // Ensure we force 'false' for global
            isGlobal = false;
            if (muniScope === 'ALL') {
                 // If targeting entire municipality, we pass the municipality ID but NO specific clubs
                 const muniId = currentUser?.assigned_municipality 
                    ? (typeof currentUser.assigned_municipality === 'object' ? currentUser.assigned_municipality.id : currentUser.assigned_municipality)
                    : null;
                 if (muniId) targetMunis = [muniId];
            } else {
                // Specific clubs
                targetClubs = selectedClubs;
            }
        } 
        else if (role === 'club') {
            isGlobal = false;
            // The backend automatically assigns the club, but passing it here helps validity
            const clubId = currentUser?.assigned_club
                ? (typeof currentUser.assigned_club === 'object' ? currentUser.assigned_club.id : currentUser.assigned_club)
                : null;
            if (clubId) targetClubs = [clubId];
        }

        formData.append('is_global', isGlobal.toString());
        
        // Only append IDs if we have them (avoids sending empty strings)
        targetMunis.forEach(id => formData.append('target_municipalities', id.toString()));
        targetClubs.forEach(id => formData.append('target_clubs', id.toString()));

        // 3. Status
        formData.append('status', status);
        if (status === 'SCHEDULED' && publishedAt) formData.append('published_at', new Date(publishedAt).toISOString());
        if (visibilityEndDate) formData.append('visibility_end_date', new Date(visibilityEndDate).toISOString());
        formData.append('is_pinned', isPinned ? 'true' : 'false');

        // 4. Targeting
        formData.append('target_member_type', memberType);
        if (targetMode === 'GROUPS') {
            selectedGroups.forEach(id => formData.append('target_groups', id.toString()));
            formData.append('target_grades', '[]');
            formData.append('target_genders', '[]');
            formData.append('target_custom_fields', '{}');
        } else {
            // Important: Don't append empty strings for ManyToMany logic in Django Rest Framework
            if (selectedGroups.length > 0) {
                 selectedGroups.forEach(id => formData.append('target_groups', id.toString()));
            }
            
            if (minAge) formData.append('target_min_age', minAge.toString());
            if (maxAge) formData.append('target_max_age', maxAge.toString());
            formData.append('target_grades', JSON.stringify(selectedGrades));
            formData.append('target_genders', JSON.stringify(selectedGenders));
            
            selectedInterests.forEach(id => formData.append('target_interests', id.toString()));
            formData.append('target_custom_fields', JSON.stringify(customFieldRules));
        }

        // 5. Settings
        formData.append('allow_comments', allowComments ? 'true' : 'false');
        formData.append('require_moderation', requireModeration ? 'true' : 'false');
        formData.append('allow_replies', allowReplies ? 'true' : 'false');
        formData.append('limit_comments_per_user', limitComments.toString());
        formData.append('send_push_notification', sendPush ? 'true' : 'false');
        if (sendPush) {
            formData.append('push_title', pushTitle);
            formData.append('push_message', pushMessage);
        }

        // 6. Files
        newImages.forEach((file) => formData.append('uploaded_images', file));
        if (initialData && imagesToDelete.length > 0) {
            imagesToDelete.forEach((id) => formData.append('images_to_delete', id.toString()));
        }

        try {
            if (initialData) {
                await api.patch(`/posts/${initialData.id}/`, formData, { headers: { 'Content-Type': 'multipart/form-data' } });
                setToast({ message: 'Updated successfully', type: 'success', isVisible: true });
            } else {
                await api.post('/posts/', formData, { headers: { 'Content-Type': 'multipart/form-data' } });
                setToast({ message: 'Created successfully', type: 'success', isVisible: true });
            }
            setTimeout(() => onSuccess(), 1000);
        } catch (err: any) {
            console.error(err);
            // Extract error message safely
            let msg = 'Failed to save post.';
            if (err.response?.data) {
               if (typeof err.response.data === 'string') msg = err.response.data;
               else if (err.response.data.detail) msg = err.response.data.detail;
               else msg = JSON.stringify(err.response.data);
            }
            setError(msg);
            setToast({ message: msg, type: 'error', isVisible: true });
        } finally {
            setLoading(false);
        }
    };

    return (
        <form onSubmit={handleSubmit} className="space-y-8 bg-white p-6 rounded-lg shadow-sm border border-gray-100">
            <div>
                <h2 className="text-xl font-bold text-gray-800 mb-2">{initialData ? 'Edit Post' : 'Create New Post'}</h2>
                {error && <p className="text-red-600 bg-red-50 p-2 rounded text-sm">{error}</p>}
            </div>

            {/* --- DISTRIBUTION SECTION --- */}
            <div className="bg-blue-50 p-5 rounded-lg border border-blue-100 space-y-4">
                <h3 className="text-lg font-bold text-blue-900">Distribution Scope</h3>
                
                {/* SUPER ADMIN UI */}
                {role === 'super' && (
                    <>
                        <div className="flex gap-4 mb-4">
                            <label className="flex items-center cursor-pointer bg-white px-3 py-2 rounded border hover:border-blue-300">
                                <input type="radio" checked={distributionMode === 'GLOBAL'} onChange={() => setDistributionMode('GLOBAL')} className="mr-2" />
                                <span className="font-medium">Global (All Users)</span>
                            </label>
                            <label className="flex items-center cursor-pointer bg-white px-3 py-2 rounded border hover:border-blue-300">
                                <input type="radio" checked={distributionMode === 'MUNICIPALITY'} onChange={() => setDistributionMode('MUNICIPALITY')} className="mr-2" />
                                <span className="font-medium">Specific Municipalities</span>
                            </label>
                            <label className="flex items-center cursor-pointer bg-white px-3 py-2 rounded border hover:border-blue-300">
                                <input type="radio" checked={distributionMode === 'CLUB'} onChange={() => setDistributionMode('CLUB')} className="mr-2" />
                                <span className="font-medium">Specific Clubs</span>
                            </label>
                        </div>

                        {distributionMode === 'MUNICIPALITY' && (
                            <div className="bg-white p-3 rounded border max-h-48 overflow-y-auto grid grid-cols-2 gap-2">
                                {municipalities.map(m => (
                                    <label key={m.id} className="flex items-center space-x-2 text-sm">
                                        <input type="checkbox" checked={selectedMunis.includes(m.id)} onChange={() => toggleSelection(m.id, selectedMunis, setSelectedMunis)} />
                                        <span>{m.name}</span>
                                    </label>
                                ))}
                            </div>
                        )}
                        {distributionMode === 'CLUB' && (
                            <div className="bg-white p-3 rounded border max-h-48 overflow-y-auto grid grid-cols-2 gap-2">
                                {clubs.map(c => (
                                    <label key={c.id} className="flex items-center space-x-2 text-sm">
                                        <input type="checkbox" checked={selectedClubs.includes(c.id)} onChange={() => toggleSelection(c.id, selectedClubs, setSelectedClubs)} />
                                        <span>{c.name}</span>
                                    </label>
                                ))}
                            </div>
                        )}
                    </>
                )}

                {/* MUNICIPALITY ADMIN UI */}
                {role === 'municipality' && (
                    <>
                        <div className="flex gap-4 mb-4">
                            <label className="flex items-center cursor-pointer bg-white px-3 py-2 rounded border hover:border-blue-300">
                                <input type="radio" checked={muniScope === 'ALL'} onChange={() => setMuniScope('ALL')} className="mr-2" />
                                <span className="font-medium">Entire Municipality</span>
                            </label>
                            <label className="flex items-center cursor-pointer bg-white px-3 py-2 rounded border hover:border-blue-300">
                                <input type="radio" checked={muniScope === 'SPECIFIC'} onChange={() => setMuniScope('SPECIFIC')} className="mr-2" />
                                <span className="font-medium">Specific Clubs</span>
                            </label>
                        </div>

                        {muniScope === 'SPECIFIC' && (
                            <div className="bg-white p-3 rounded border max-h-48 overflow-y-auto grid grid-cols-2 gap-2">
                                {clubs.map(c => (
                                    <label key={c.id} className="flex items-center space-x-2 text-sm">
                                        <input type="checkbox" checked={selectedClubs.includes(c.id)} onChange={() => toggleSelection(c.id, selectedClubs, setSelectedClubs)} />
                                        <span>{c.name}</span>
                                    </label>
                                ))}
                                {clubs.length === 0 && <p className="text-sm text-gray-500">No clubs found.</p>}
                            </div>
                        )}
                    </>
                )}

                {/* CLUB ADMIN UI */}
                {role === 'club' && (
                    <div className="bg-white p-4 rounded border border-blue-200">
                         <p className="text-sm text-blue-800 font-medium flex items-center gap-2">
                            <span className="text-lg">üì¢</span>
                            This post will be visible to members of your assigned club.
                        </p>
                    </div>
                )}
            </div>

            {/* --- CONTENT --- */}
            <div className="space-y-4">
                <div>
                    <label className="block text-sm font-medium text-gray-700">Title</label>
                    <input type="text" required className="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border" value={title} onChange={e => setTitle(e.target.value)} />
                </div>
                <RichTextEditor value={content} onChange={setContent} />
                
                <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">Media</label>
                    <div className="flex gap-4 mb-2">
                        {['TEXT', 'IMAGE', 'VIDEO'].map((type) => (
                            <button key={type} type="button" onClick={() => setPostType(type as any)} 
                                className={`px-4 py-2 rounded text-sm font-medium border ${postType === type ? 'bg-blue-600 text-white' : 'bg-white text-gray-700'}`}>
                                {type}
                            </button>
                        ))}
                    </div>
                    
                    {postType === 'IMAGE' && (
                        <div className="space-y-3">
                            {existingImages.length > 0 && (
                                <div className="flex gap-2 flex-wrap">
                                    {existingImages.map(img => (
                                        <div key={img.id} className="relative w-24 h-24">
                                            <img src={getMediaUrl(img.image) || ''} className={`w-full h-full object-cover rounded ${imagesToDelete.includes(img.id) ? 'opacity-50' : ''}`} alt={`Post image ${img.id}`} />
                                            <button type="button" onClick={() => toggleSelection(img.id, imagesToDelete, setImagesToDelete)} 
                                                className="absolute top-0 right-0 bg-red-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs">√ó</button>
                                        </div>
                                    ))}
                                </div>
                            )}
                            <input type="file" multiple accept="image/*" onChange={e => e.target.files && setNewImages(Array.from(e.target.files))} className="block w-full text-sm text-gray-500" />
                        </div>
                    )}
                    
                    {postType === 'VIDEO' && (
                        <input type="url" placeholder="YouTube URL" className="w-full border p-2 rounded" value={videoUrl} onChange={e => setVideoUrl(e.target.value)} />
                    )}
                </div>
            </div>

            <hr />

            {/* --- TARGETING (AUDIENCE) --- */}
            <div>
                <h3 className="text-lg font-bold text-gray-800 mb-4">Target Audience Filters</h3>
                <div className="flex items-center gap-6 mb-4">
                    <label className="flex items-center cursor-pointer">
                        <input type="radio" checked={targetMode === 'ATTRIBUTES'} onChange={() => setTargetMode('ATTRIBUTES')} className="mr-2" />
                        Attributes (Age, Interests)
                    </label>
                    <label className="flex items-center cursor-pointer">
                        <input type="radio" checked={targetMode === 'GROUPS'} onChange={() => setTargetMode('GROUPS')} className="mr-2" />
                        Specific Groups
                    </label>
                </div>

                {targetMode === 'GROUPS' ? (
                    <div className="bg-gray-50 p-4 rounded border max-h-48 overflow-y-auto">
                        {availableGroups.map(g => (
                            <label key={g.id} className="flex items-center p-1 cursor-pointer">
                                <input type="checkbox" checked={selectedGroups.includes(g.id)} onChange={() => toggleSelection(g.id, selectedGroups, setSelectedGroups)} className="mr-2" />
                                {g.name}
                            </label>
                        ))}
                        {availableGroups.length === 0 && <p className="text-sm text-gray-500">No groups available.</p>}
                    </div>
                ) : (
                    <div className="space-y-4 bg-gray-50 p-4 rounded border">
                        <div>
                            <label className="block text-xs font-bold uppercase text-gray-500 mb-1">Member Type</label>
                            <div className="flex gap-4">
                                {['BOTH', 'YOUTH', 'GUARDIAN'].map(t => (
                                    <label key={t} className="flex items-center"><input type="radio" checked={memberType === t} onChange={() => setMemberType(t as any)} className="mr-1" /> {t}</label>
                                ))}
                            </div>
                        </div>
                        <div className="grid grid-cols-2 gap-4">
                            <input type="number" placeholder="Min Age" className="border p-2 rounded" value={minAge} onChange={e => setMinAge(e.target.value)} />
                            <input type="number" placeholder="Max Age" className="border p-2 rounded" value={maxAge} onChange={e => setMaxAge(e.target.value)} />
                        </div>
                        <div>
                            <label className="block text-xs font-bold uppercase text-gray-500 mb-1">Grades</label>
                            <div className="flex flex-wrap gap-2">
                                {[1,2,3,4,5,6,7,8,9,10,11,12].map(g => (
                                    <button key={g} type="button" onClick={() => toggleSelection(g, selectedGrades, setSelectedGrades)} 
                                        className={`w-8 h-8 rounded border ${selectedGrades.includes(g) ? 'bg-blue-600 text-white' : 'bg-white'}`}>{g}</button>
                                ))}
                            </div>
                        </div>
                        <div>
                            <label className="block text-xs font-bold uppercase text-gray-500 mb-1">Gender</label>
                            <div className="flex gap-3">
                                {['MALE', 'FEMALE', 'OTHER'].map(g => (
                                    <label key={g} className="inline-flex items-center bg-white px-3 py-1 rounded border shadow-sm cursor-pointer">
                                        <input 
                                            type="checkbox" 
                                            checked={selectedGenders.includes(g)}
                                            onChange={() => toggleSelection(g, selectedGenders, setSelectedGenders)}
                                            className="mr-2 text-blue-600"
                                        />
                                        <span className="text-sm capitalize">{g.toLowerCase()}</span>
                                    </label>
                                ))}
                            </div>
                        </div>
                        <div>
                            <label className="block text-xs font-bold uppercase text-gray-500 mb-1">Interests</label>
                            <div className="grid grid-cols-2 md:grid-cols-3 gap-2 max-h-40 overflow-y-auto">
                                {availableInterests.map(interest => (
                                    <label key={interest.id} className="flex items-center text-sm cursor-pointer">
                                        <input 
                                            type="checkbox" 
                                            checked={selectedInterests.includes(interest.id)}
                                            onChange={() => toggleSelection(interest.id, selectedInterests, setSelectedInterests)}
                                            className="mr-2 rounded text-blue-600 h-4 w-4 border-gray-300"
                                        />
                                        {interest.name}
                                    </label>
                                ))}
                                {availableInterests.length === 0 && <span className="text-sm text-gray-400">No interests available.</span>}
                            </div>
                        </div>
                        {availableCustomFields.length > 0 && (
                            <div className="border-t pt-2 mt-2">
                                <label className="block text-xs font-bold uppercase text-gray-500 mb-2">Custom Fields</label>
                                <div className="grid grid-cols-2 gap-4">
                                    {availableCustomFields.map(f => (
                                        <div key={f.id}>
                                            <label className="text-xs block mb-1">{f.name}</label>
                                            {f.field_type === 'BOOLEAN' ? (
                                                <select className="w-full border p-1 rounded text-sm" value={customFieldRules[f.id] || ''} onChange={e => handleCustomFieldChange(f.id, e.target.value)}>
                                                    <option value="">Any</option><option value="true">Yes</option><option value="false">No</option>
                                                </select>
                                            ) : (
                                                <select className="w-full border p-1 rounded text-sm" value={customFieldRules[f.id] || ''} onChange={e => handleCustomFieldChange(f.id, e.target.value)}>
                                                    <option value="">Any</option>
                                                    {f.options?.map((o:string) => <option key={o} value={o}>{o}</option>)}
                                                </select>
                                            )}
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}
                    </div>
                )}
            </div>

            {/* --- PUBLISH SETTINGS --- */}
            <div className="grid grid-cols-1 md:grid-cols-2 gap-6 pt-4 border-t border-gray-200">
                <div className="space-y-4">
                    <div>
                        <label className="block text-sm font-medium">Status</label>
                        <select value={status} onChange={e => setStatus(e.target.value as any)} className="w-full border p-2 rounded">
                            <option value="DRAFT">Draft</option>
                            <option value="PUBLISHED">Publish Now</option>
                            <option value="SCHEDULED">Schedule</option>
                        </select>
                    </div>
                    {status === 'SCHEDULED' && <input type="datetime-local" className="w-full border p-2 rounded" value={publishedAt} onChange={e => setPublishedAt(e.target.value)} />}
                    
                    <label className="flex items-center gap-2">
                        <input type="checkbox" checked={isPinned} onChange={e => setIsPinned(e.target.checked)} />
                        Pin to top
                    </label>
                </div>
                <div className="bg-gray-50 p-4 rounded border">
                    <label className="flex items-center gap-2 mb-2 font-bold"><input type="checkbox" checked={allowComments} onChange={e => setAllowComments(e.target.checked)} /> Allow Comments</label>
                    {allowComments && (
                        <div className="pl-6 space-y-2 text-sm">
                            <label className="flex items-center gap-2"><input type="checkbox" checked={requireModeration} onChange={e => setRequireModeration(e.target.checked)} /> Moderation</label>
                            <label className="flex items-center gap-2"><input type="checkbox" checked={allowReplies} onChange={e => setAllowReplies(e.target.checked)} /> Replies</label>
                        </div>
                    )}
                    <label className="flex items-center gap-2 mt-4 font-bold"><input type="checkbox" checked={sendPush} onChange={e => setSendPush(e.target.checked)} /> Send Push Notification</label>
                    {sendPush && (
                        <div className="pl-6 mt-2 space-y-2">
                            <input type="text" placeholder="Notif Title" className="w-full border p-1 rounded text-sm" value={pushTitle} onChange={e => setPushTitle(e.target.value)} />
                            <input type="text" placeholder="Notif Message" className="w-full border p-1 rounded text-sm" value={pushMessage} onChange={e => setPushMessage(e.target.value)} />
                        </div>
                    )}
                </div>
            </div>

            <div className="flex justify-end gap-4 pt-6 border-t">
                <button type="button" onClick={() => router.back()} className="px-4 py-2 border rounded hover:bg-gray-50">Cancel</button>
                <button type="submit" disabled={loading} className="px-6 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 disabled:opacity-50">
                    {loading ? 'Saving...' : (initialData ? 'Update' : 'Create')}
                </button>
            </div>

            <Toast message={toast.message} type={toast.type} isVisible={toast.isVisible} onClose={() => setToast({...toast, isVisible: false})} />
        </form>
    );
}
--- END OF FILE: ./frontend/app/components/posts/PostForm.tsx ---


--- START OF FILE: ./frontend/app/login/page.tsx ---
'use client';

import { useState } from 'react';
import { useAuth } from '../../context/AuthContext';

export default function LoginPage() {
  const { login } = useAuth();
  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');
  const [error, setError] = useState('');
  const [isLoading, setIsLoading] = useState(false);

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setError('');
    setIsLoading(true);

    try {
      await login(email, password);
      // Redirect happens automatically in AuthContext
    } catch (err) {
      setError('Invalid email or password');
      setIsLoading(false);
    }
  };

  return (
    <div className="min-h-screen flex items-center justify-center bg-gray-100">
      <div className="max-w-md w-full bg-white rounded-xl shadow-lg p-8 space-y-6">
        <div className="text-center">
          <h1 className="text-3xl font-bold text-gray-900">Welcome Back</h1>
          <p className="text-gray-500 mt-2">Sign in to Ungdomsappen</p>
        </div>

        {error && (
          <div className="bg-red-50 text-red-600 p-3 rounded-lg text-sm text-center">
            {error}
          </div>
        )}

        <form onSubmit={handleSubmit} className="space-y-4">
          <div>
            <label className="block text-sm font-medium text-gray-700">Email</label>
            <input
              type="email"
              required
              value={email}
              onChange={(e) => setEmail(e.target.value)}
              className="mt-1 w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition"
              placeholder="admin@example.com"
            />
          </div>

          <div>
            <label className="block text-sm font-medium text-gray-700">Password</label>
            <input
              type="password"
              required
              value={password}
              onChange={(e) => setPassword(e.target.value)}
              className="mt-1 w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition"
              placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
            />
          </div>

          <button
            type="submit"
            disabled={isLoading}
            className={`w-full py-3 text-white rounded-lg font-bold transition
              ${isLoading ? 'bg-blue-400 cursor-not-allowed' : 'bg-blue-600 hover:bg-blue-700'}
            `}
          >
            {isLoading ? 'Signing in...' : 'Sign In'}
          </button>
        </form>

        <div className="text-center text-sm text-gray-500">
          <a href="#" className="hover:text-blue-600">Forgot password?</a>
        </div>
      </div>
    </div>
  );
}
--- END OF FILE: ./frontend/app/login/page.tsx ---


--- START OF FILE: ./frontend/lib/api.ts ---
import axios from 'axios';
import Cookies from 'js-cookie';

const API_URL = 'http://localhost:8000/api';

const api = axios.create({
  baseURL: API_URL,
  headers: {
    'Content-Type': 'application/json',
  },
});

// Interceptor: Automatically add the Token to every request
api.interceptors.request.use((config) => {
  const token = Cookies.get('access_token');
  if (token) {
    config.headers.Authorization = `JWT ${token}`;
  }
  return config;
});

// Interceptor: Handle errors (like if token expires)
api.interceptors.response.use(
  (response) => response,
  (error) => {
    if (error.response && error.response.status === 401) {
      // If token is invalid, logout (optional: add refresh logic later)
      Cookies.remove('access_token');
      Cookies.remove('refresh_token');
      // window.location.href = '/login'; // Optional: Force redirect
    }
    return Promise.reject(error);
  }
);

export default api;
--- END OF FILE: ./frontend/lib/api.ts ---


--- START OF FILE: ./backend/manage.py ---
#!/usr/bin/env python
"""Django's command-line utility for administrative tasks."""
import os
import sys


def main():
    """Run administrative tasks."""
    os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'core.settings')
    try:
        from django.core.management import execute_from_command_line
    except ImportError as exc:
        raise ImportError(
            "Couldn't import Django. Are you sure it's installed and "
            "available on your PYTHONPATH environment variable? Did you "
            "forget to activate a virtual environment?"
        ) from exc
    execute_from_command_line(sys.argv)


if __name__ == '__main__':
    main()

--- END OF FILE: ./backend/manage.py ---


--- START OF FILE: ./backend/organization/models.py ---
from django.db import models
from django.core.validators import FileExtensionValidator

# Define allowed file types
image_validator = FileExtensionValidator(allowed_extensions=['jpg', 'jpeg', 'png', 'svg', 'webp'])

class Country(models.Model):
    """
    Represents the highest organizational level.
    """
    name = models.CharField(max_length=100, unique=True)
    country_code = models.CharField(max_length=5, help_text="ISO Code, e.g., SE, NO")
    description = models.TextField()
    
    # Changed to FileField to support SVG
    avatar = models.FileField(
        upload_to='countries/avatars/', 
        blank=True, 
        null=True,
        validators=[image_validator]
    )

    currency_code = models.CharField(max_length=10, blank=True, null=True)
    default_language = models.CharField(max_length=10, blank=True, null=True)
    timezone = models.CharField(max_length=50, blank=True, null=True)

    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)

    class Meta:
        verbose_name_plural = "Countries"

    def __str__(self):
        return self.name

class Municipality(models.Model):
    """
    Represents a local government area.
    """
    country = models.ForeignKey(Country, on_delete=models.CASCADE, related_name='municipalities')
    name = models.CharField(max_length=100)
    description = models.TextField()
    terms_and_conditions = models.TextField()
    
    # Changed to FileField
    avatar = models.FileField(
        upload_to='municipalities/avatars/', 
        blank=True, 
        null=True,
        validators=[image_validator]
    )
    hero_image = models.FileField(
        upload_to='municipalities/heroes/', 
        blank=True, 
        null=True,
        validators=[image_validator]
    )

    municipality_code = models.CharField(max_length=20, unique=True, blank=True, null=True)
    email = models.EmailField(blank=True, null=True)
    phone = models.CharField(max_length=50, blank=True, null=True)
    website_link = models.URLField(blank=True, null=True)
    social_media = models.JSONField(default=dict, blank=True)
    allow_self_registration = models.BooleanField(default=True)
    
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)

    class Meta:
        verbose_name_plural = "Municipalities"

    def __str__(self):
        return f"{self.name} ({self.country.country_code})"

class Club(models.Model):
    """
    Represents a physical youth center.
    """
    municipality = models.ForeignKey(Municipality, on_delete=models.CASCADE, related_name='clubs')
    name = models.CharField(max_length=100)
    description = models.TextField()
    email = models.EmailField()
    phone = models.CharField(max_length=50)
    terms_and_conditions = models.TextField()
    club_policies = models.TextField()

    # Changed to FileField
    avatar = models.FileField(
        upload_to='clubs/avatars/', 
        blank=True, 
        null=True,
        validators=[image_validator]
    )
    hero_image = models.FileField(
        upload_to='clubs/heroes/', 
        blank=True, 
        null=True,
        validators=[image_validator]
    )

    address = models.CharField(max_length=255, blank=True, null=True)
    latitude = models.FloatField(blank=True, null=True)
    longitude = models.FloatField(blank=True, null=True)
    allowed_age_groups = models.CharField(max_length=100, blank=True, null=True)
    club_categories = models.CharField(max_length=255, blank=True, null=True)

    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)

    def __str__(self):
        return f"{self.name} ({self.municipality.name})"

class RegularOpeningHour(models.Model):
    """
    Defines the standard weekly schedule.
    """
    WEEKDAY_CHOICES = [
        (1, 'Monday'), (2, 'Tuesday'), (3, 'Wednesday'), (4, 'Thursday'),
        (5, 'Friday'), (6, 'Saturday'), (7, 'Sunday'),
    ]
    
    WEEK_CYCLE_CHOICES = [
        ('ALL', 'Every Week'),
        ('ODD', 'Odd Weeks (1, 3, 5...)'),
        ('EVEN', 'Even Weeks (2, 4, 6...)'),
    ]

    GENDER_CHOICES = [
        ('ALL', 'All Genders'), ('BOYS', 'Boys Only'), 
        ('GIRLS', 'Girls Only'), ('OTHER', 'Other'),
    ]

    RESTRICTION_CHOICES = [
        ('NONE', 'No Restriction'),
        ('AGE', 'Age Range'),
        ('GRADE', 'Grade Range'),
    ]

    club = models.ForeignKey(Club, on_delete=models.CASCADE, related_name='regular_hours')
    weekday = models.IntegerField(choices=WEEKDAY_CHOICES)
    week_cycle = models.CharField(max_length=10, choices=WEEK_CYCLE_CHOICES, default='ALL')
    
    open_time = models.TimeField()
    close_time = models.TimeField()
    
    title = models.CharField(max_length=100, blank=True)
    description = models.TextField(blank=True)
    
    # New Logic for Restrictions
    restriction_mode = models.CharField(max_length=10, choices=RESTRICTION_CHOICES, default='NONE')
    min_value = models.IntegerField(null=True, blank=True, help_text="Min Age or Grade")
    max_value = models.IntegerField(null=True, blank=True, help_text="Max Age or Grade")
    
    gender_restriction = models.CharField(max_length=10, choices=GENDER_CHOICES, default='ALL')

    class Meta:
        ordering = ['weekday', 'open_time']

    def __str__(self):
        return f"{self.club.name} - {self.get_weekday_display()}"


class ClubClosure(models.Model):
    """
    Dates when the club is completely closed (Section 6.5, 6.6).
    """
    club = models.ForeignKey(Club, on_delete=models.CASCADE, related_name='closures')
    start_date = models.DateField()
    end_date = models.DateField(help_text="If same as start_date, it's a one-day closure")
    description = models.CharField(max_length=255, help_text="Reason for closure (e.g. Christmas)")

    class Meta:
        ordering = ['start_date']

    def __str__(self):
        return f"{self.club.name} Closed: {self.start_date}"


class DateOverride(models.Model):
    """
    Specific dates with special hours that replace the regular schedule (Section 6.4).
    """
    club = models.ForeignKey(Club, on_delete=models.CASCADE, related_name='date_overrides')
    date = models.DateField()
    
    open_time = models.TimeField()
    close_time = models.TimeField()
    
    title = models.CharField(max_length=100, blank=True, help_text="e.g., 'Summer Party'")
    description = models.TextField(blank=True)
    
    class Meta:
        ordering = ['date', 'open_time']

    def __str__(self):
        return f"{self.club.name} Override: {self.date}"


class Interest(models.Model):
    """
    Global interests defined by Super Admin. 
    Used to categorize Users and Events.
    """
    name = models.CharField(max_length=50, unique=True)
    # Kept 'icon' as a fallback or for small UI elements (emoji)
    icon = models.CharField(max_length=50, blank=True, help_text="Emoji or Icon name (e.g. '‚öΩ' or 'sports_soccer')")
    
    # New visual field supporting SVGs
    avatar = models.FileField(
        upload_to='interests/avatars/', 
        blank=True, 
        null=True,
        validators=[image_validator]
    )
    
    class Meta:
        ordering = ['name']

    def __str__(self):
        return f"{self.icon} {self.name}" if self.icon else self.name
--- END OF FILE: ./backend/organization/models.py ---


--- START OF FILE: ./backend/organization/serializers.py ---
from rest_framework import serializers
from django.http import QueryDict
import json
from .models import Country, Municipality, Club, RegularOpeningHour, ClubClosure, DateOverride, Interest

# --- Opening Hours Serializers ---

class RegularOpeningHourSerializer(serializers.ModelSerializer):
    weekday_display = serializers.CharField(source='get_weekday_display', read_only=True)
    
    class Meta:
        model = RegularOpeningHour
        fields = [
            'id', 'weekday', 'weekday_display', 'week_cycle', 
            'open_time', 'close_time', 'title', 
            'gender_restriction', 'restriction_mode', 'min_value', 'max_value'
        ]

class ClubClosureSerializer(serializers.ModelSerializer):
    class Meta:
        model = ClubClosure
        fields = ['id', 'start_date', 'end_date', 'description']

class DateOverrideSerializer(serializers.ModelSerializer):
    class Meta:
        model = DateOverride
        fields = ['id', 'date', 'open_time', 'close_time', 'title', 'description']

# --- Organization Serializers ---

class CountrySerializer(serializers.ModelSerializer):
    class Meta:
        model = Country
        fields = [
            'id',
            'name',
            'country_code',
            'description',
            'currency_code',
            'default_language',
            'timezone',
            'avatar',
        ]

class MunicipalitySerializer(serializers.ModelSerializer):
    # Include country name for easier display
    country_name = serializers.CharField(source='country.name', read_only=True)
    country_code = serializers.CharField(source='country.country_code', read_only=True)
    
    class Meta:
        model = Municipality
        fields = [
            'id',
            'country',
            'country_name',
            'country_code',
            'name',
            'municipality_code',
            'description',
            'terms_and_conditions',
            'avatar',
            'hero_image',
            'email',
            'phone',
            'website_link',
            'social_media',
            'allow_self_registration',
        ]

class ClubSerializer(serializers.ModelSerializer):
    # Include the related data nicely
    municipality_name = serializers.CharField(source='municipality.name', read_only=True)
    
    # Nested Opening Hours (so we get them automatically when fetching a club)
    regular_hours = RegularOpeningHourSerializer(many=True, read_only=True)
    closures = ClubClosureSerializer(many=True, read_only=True)
    date_overrides = DateOverrideSerializer(many=True, read_only=True)

    class Meta:
        model = Club
        fields = [
            'id', 'name', 'municipality', 'municipality_name', 
            'description', 'email', 'phone', 
            'terms_and_conditions', 'club_policies',
            'avatar', 'hero_image', 'address', 
            'latitude', 'longitude', 
            'allowed_age_groups', 'club_categories',
            'regular_hours', 'closures', 'date_overrides'
        ]

class InterestSerializer(serializers.ModelSerializer):
    class Meta:
        model = Interest
        fields = ['id', 'name', 'icon', 'avatar']


class ClubManagementSerializer(serializers.ModelSerializer):
    """
    Used by Super Admins to create/update Clubs AND their opening hours.
    """
    # We accept a JSON string for hours because we are using FormData (for images)
    regular_hours_data = serializers.CharField(write_only=True, required=False)

    class Meta:
        model = Club
        fields = [
            'id', 'name', 'municipality', 'description', 'email', 'phone',
            'terms_and_conditions', 'club_policies',
            'avatar', 'hero_image',
            'address', 'latitude', 'longitude',
            'club_categories',  # Removed allowed_age_groups as it's now handled per hour
            'regular_hours_data'
        ]

    def create(self, validated_data):
        hours_json = validated_data.pop('regular_hours_data', None)
        club = Club.objects.create(**validated_data)

        if hours_json:
            try:
                hours_list = json.loads(hours_json)
                for hour in hours_list:
                    # Clean up frontend temporary IDs
                    if 'id' in hour: del hour['id']
                    if 'weekday_display' in hour: del hour['weekday_display']
                    
                    # Validate Overlap Logic Here (Optional but good for safety)
                    # For now, we rely on frontend validation for UX, 
                    # simply saving what is sent.
                    RegularOpeningHour.objects.create(club=club, **hour)
            except json.JSONDecodeError:
                pass  # Ignore invalid JSON

        return club

    def update(self, instance, validated_data):
        hours_json = validated_data.pop('regular_hours_data', None)
        
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()
        
        if hours_json:
            try:
                hours_list = json.loads(hours_json)
                instance.regular_hours.all().delete()
                for hour in hours_list:
                    # Clean up frontend temporary IDs
                    if 'id' in hour: del hour['id']
                    if 'weekday_display' in hour: del hour['weekday_display']
                    
                    # Validate Overlap Logic Here (Optional but good for safety)
                    # For now, we rely on frontend validation for UX, 
                    # simply saving what is sent.
                    RegularOpeningHour.objects.create(club=instance, **hour)
            except json.JSONDecodeError:
                pass
                
        return instance
--- END OF FILE: ./backend/organization/serializers.py ---


--- START OF FILE: ./backend/organization/apps.py ---
from django.apps import AppConfig


class OrganizationConfig(AppConfig):
    default_auto_field = 'django.db.models.BigAutoField'
    name = 'organization'

--- END OF FILE: ./backend/organization/apps.py ---


--- START OF FILE: ./backend/organization/admin.py ---
from django.contrib import admin
from .models import Country, Municipality, Club, RegularOpeningHour, ClubClosure, DateOverride, Interest

# --- INLINES (Allows editing inside the Club page) ---

class RegularOpeningHourInline(admin.TabularInline):
    model = RegularOpeningHour
    extra = 0 # Don't show empty extra rows by default
    ordering = ['weekday', 'open_time']

class ClubClosureInline(admin.TabularInline):
    model = ClubClosure
    extra = 0
    ordering = ['start_date']

class DateOverrideInline(admin.TabularInline):
    model = DateOverride
    extra = 0
    ordering = ['date']

# --- ADMIN CONFIGURATION ---

@admin.register(Country)
class CountryAdmin(admin.ModelAdmin):
    list_display = ('name', 'country_code', 'default_language')
    search_fields = ('name', 'country_code')

@admin.register(Municipality)
class MunicipalityAdmin(admin.ModelAdmin):
    list_display = ('name', 'country', 'municipality_code')
    list_filter = ('country',)
    search_fields = ('name', 'municipality_code')

@admin.register(Club)
class ClubAdmin(admin.ModelAdmin):
    list_display = ('name', 'municipality', 'email')
    list_filter = ('municipality__country', 'municipality')
    search_fields = ('name', 'email')
    
    # Add the opening hours, closures, and overrides here
    inlines = [RegularOpeningHourInline, DateOverrideInline, ClubClosureInline]

@admin.register(Interest)
class InterestAdmin(admin.ModelAdmin):
    list_display = ('name', 'icon')
    search_fields = ('name',)
--- END OF FILE: ./backend/organization/admin.py ---


--- START OF FILE: ./backend/organization/tests.py ---
from django.test import TestCase

# Create your tests here.

--- END OF FILE: ./backend/organization/tests.py ---


--- START OF FILE: ./backend/organization/urls.py ---
from django.urls import path, include
from rest_framework.routers import DefaultRouter
from .views import CountryViewSet, MunicipalityViewSet, ClubViewSet, InterestViewSet

# Create a router and register our viewsets with it.
router = DefaultRouter()
router.register(r'countries', CountryViewSet)
router.register(r'municipalities', MunicipalityViewSet)
router.register(r'clubs', ClubViewSet)
router.register(r'interests', InterestViewSet)

urlpatterns = [
    path('', include(router.urls)),
]
--- END OF FILE: ./backend/organization/urls.py ---


--- START OF FILE: ./backend/organization/views.py ---
from rest_framework import viewsets
from rest_framework.permissions import AllowAny
from django.db.models import Q
from users.permissions import IsSuperAdmin, IsMunicipalityAdmin, IsClubOrMunicipalityAdmin
from .models import Country, Municipality, Club, Interest
from .serializers import (
    CountrySerializer,
    MunicipalitySerializer,
    ClubSerializer,
    InterestSerializer,
    ClubManagementSerializer,
)

class CountryViewSet(viewsets.ModelViewSet):
    """
    Country management.
    Read: Public
    Write: Super Admin Only
    """
    queryset = Country.objects.all()
    serializer_class = CountrySerializer

    def get_permissions(self):
        # Allow anyone to read the list (needed for login/registration dropdowns)
        if self.action in ['list', 'retrieve']:
            return [AllowAny()]
        # Only Super Admins can create, update, or delete
        return [IsSuperAdmin()]

class MunicipalityViewSet(viewsets.ModelViewSet):
    """
    API endpoint that allows Municipalities to be viewed and managed.
    """
    queryset = Municipality.objects.all()
    serializer_class = MunicipalitySerializer

    def get_queryset(self):
        base_queryset = Municipality.objects.all()
        user = self.request.user

        if not user.is_authenticated:
            queryset = base_queryset
        elif getattr(user, 'role', None) == 'SUPER_ADMIN':
            queryset = base_queryset
        elif getattr(user, 'role', None) == 'MUNICIPALITY_ADMIN' and user.assigned_municipality:
            queryset = base_queryset.filter(id=user.assigned_municipality.id)
        else:
            queryset = base_queryset

        # Additional query param filters (country/search)
        country = self.request.query_params.get('country')
        if country:
            queryset = queryset.filter(country=country)

        search = self.request.query_params.get('search')
        if search:
            queryset = queryset.filter(
                Q(name__icontains=search) |
                Q(municipality_code__icontains=search) |
                Q(email__icontains=search) |
                Q(description__icontains=search)
            )

        return queryset.order_by('name')

    def get_permissions(self):
        # Public Read Access
        if self.action in ['list', 'retrieve']:
            return [AllowAny()]
        
        # Municipality Admin can ONLY Edit (Update/Partial Update)
        if self.action in ['update', 'partial_update']:
            return [IsMunicipalityAdmin()]
        
        # Only Super Admin can Create or Delete
        return [IsSuperAdmin()]

class ClubViewSet(viewsets.ModelViewSet):
    """
    API endpoint that allows Clubs to be viewed and managed.
    Read: Public
    Write: Super Admin OR Municipality Admin (for their own clubs)
    """
    queryset = Club.objects.all()
    serializer_class = ClubSerializer

    def get_queryset(self):
        base_queryset = Club.objects.all().order_by('name')
        user = self.request.user

        if not user.is_authenticated:
            queryset = base_queryset
        elif getattr(user, 'role', None) == 'SUPER_ADMIN':
            queryset = base_queryset
        elif getattr(user, 'role', None) == 'MUNICIPALITY_ADMIN' and user.assigned_municipality:
            queryset = base_queryset.filter(municipality=user.assigned_municipality)
        elif getattr(user, 'role', None) == 'CLUB_ADMIN' and user.assigned_club:
            queryset = base_queryset.filter(id=user.assigned_club.id)
        else:
            queryset = base_queryset

        municipality = self.request.query_params.get('municipality', None)
        if municipality:
            queryset = queryset.filter(municipality=municipality)

        search = self.request.query_params.get('search', None)
        if search:
            queryset = queryset.filter(
                Q(name__icontains=search) |
                Q(email__icontains=search) |
                Q(description__icontains=search)
            )

        return queryset

    def get_permissions(self):
        if self.action in ['list', 'retrieve']:
            return [AllowAny()]
        if self.action in ['create', 'destroy']:
            return [IsMunicipalityAdmin()]
        if self.action in ['update', 'partial_update']:
            return [IsClubOrMunicipalityAdmin()]
        return [IsMunicipalityAdmin()]

    def get_serializer_class(self):
        if self.action in ['create', 'update', 'partial_update']:
            return ClubManagementSerializer
        return ClubSerializer

    def perform_create(self, serializer):
        user = self.request.user
        if getattr(user, 'role', None) == 'MUNICIPALITY_ADMIN' and user.assigned_municipality:
            serializer.save(municipality=user.assigned_municipality)
        else:
            serializer.save()

class InterestViewSet(viewsets.ModelViewSet):
    """
    Interests management.
    Read: Public
    Write: Super Admin Only
    """
    queryset = Interest.objects.all()
    serializer_class = InterestSerializer

    def get_permissions(self):
        # Allow anyone to read the list (needed for registration forms)
        if self.action in ['list', 'retrieve']:
            return [AllowAny()]
        # Only Super Admins can create, update, or delete
        return [IsSuperAdmin()]
--- END OF FILE: ./backend/organization/views.py ---


--- START OF FILE: ./backend/posts/models.py ---
# backend/posts/models.py

from django.db import models
from django.conf import settings
from django.core.validators import FileExtensionValidator, MinValueValidator, MaxValueValidator
from organization.models import Municipality, Club, Interest
from groups.models import Group

# Validator for post images
image_validator = FileExtensionValidator(allowed_extensions=['jpg', 'jpeg', 'png', 'gif', 'webp'])

class Post(models.Model):
    # --- Enums ---
    class PostType(models.TextChoices):
        TEXT = 'TEXT', 'Text Post'
        IMAGE = 'IMAGE', 'Image Post'
        VIDEO = 'VIDEO', 'Video Post'

    class Status(models.TextChoices):
        DRAFT = 'DRAFT', 'Draft'
        SCHEDULED = 'SCHEDULED', 'Scheduled'
        PUBLISHED = 'PUBLISHED', 'Published'
        ARCHIVED = 'ARCHIVED', 'Archived/Expired'

    class OwnerRole(models.TextChoices):
        SUPER_ADMIN = 'SUPER_ADMIN', 'Super Admin'
        MUNICIPALITY_ADMIN = 'MUNICIPALITY_ADMIN', 'Municipality Admin'
        CLUB_ADMIN = 'CLUB_ADMIN', 'Club Admin'

    class TargetMemberType(models.TextChoices):
        YOUTH = 'YOUTH', 'Youth Only'
        GUARDIAN = 'GUARDIAN', 'Guardians Only'
        BOTH = 'BOTH', 'Both Youth and Guardians'

    # --- Basic Info (Section 3) ---
    title = models.CharField(max_length=200)
    content = models.TextField(help_text="Rich text content")
    post_type = models.CharField(max_length=20, choices=PostType.choices, default=PostType.TEXT)
    
    # Video Link (Only used if post_type is VIDEO)
    video_url = models.URLField(blank=True, null=True, help_text="YouTube link")

    # --- Ownership & Scope (Section 2) ---
    author = models.ForeignKey(settings.AUTH_USER_MODEL, on_delete=models.SET_NULL, null=True, related_name='authored_posts')
    owner_role = models.CharField(max_length=50, choices=OwnerRole.choices)
    
    # These fields now represent OWNERSHIP context, not necessarily the only viewers
    municipality = models.ForeignKey(Municipality, on_delete=models.CASCADE, null=True, blank=True, related_name='owned_posts')
    club = models.ForeignKey(Club, on_delete=models.CASCADE, null=True, blank=True, related_name='owned_posts')

    # --- NEW: DISTRIBUTION SCOPE (Who SEES it) ---
    is_global = models.BooleanField(default=False, help_text="Visible to everyone (Super Admin only)")
    
    # Granular targeting
    target_municipalities = models.ManyToManyField(Municipality, blank=True, related_name='targeted_posts')
    target_clubs = models.ManyToManyField(Club, blank=True, related_name='targeted_posts')

    # --- Publishing & Visibility (Section 4, 5, 6, 8) ---
    status = models.CharField(max_length=20, choices=Status.choices, default=Status.DRAFT)
    
    # Scheduling
    published_at = models.DateTimeField(null=True, blank=True, help_text="When the post goes live")
    
    # Visibility Window
    visibility_start_date = models.DateTimeField(null=True, blank=True)
    visibility_end_date = models.DateTimeField(null=True, blank=True, help_text="Auto-hide after this date")
    
    # Pinned Logic
    is_pinned = models.BooleanField(default=False)
    pinned_until = models.DateTimeField(null=True, blank=True)

    # --- Targeting (Section 7) ---
    # 1. Broad Roles
    target_member_type = models.CharField(max_length=20, choices=TargetMemberType.choices, default=TargetMemberType.BOTH)

    # 2. Specific Groups (Overrides other targeting if set)
    target_groups = models.ManyToManyField(Group, blank=True, related_name='targeted_posts')
    
    # 3. Attribute Targeting
    target_interests = models.ManyToManyField(Interest, blank=True, related_name='targeted_posts')
    target_genders = models.JSONField(default=list, blank=True, help_text='List of genders e.g. ["MALE", "FEMALE"]')
    target_grades = models.JSONField(default=list, blank=True, help_text='List of grades e.g. [7, 8, 9]')
    
    target_min_age = models.IntegerField(null=True, blank=True)
    target_max_age = models.IntegerField(null=True, blank=True)
    
    # Custom Fields: {"field_id": "value"}
    target_custom_fields = models.JSONField(default=dict, blank=True)

    # --- Comment Settings (Section 9) ---
    allow_comments = models.BooleanField(default=True)
    require_moderation = models.BooleanField(default=False, help_text="If true, comments must be approved")
    limit_comments_per_user = models.IntegerField(default=0, help_text="0 = Unlimited")
    allow_replies = models.BooleanField(default=True)
    
    # --- Push Notification Config (Section 10) ---
    send_push_notification = models.BooleanField(default=False)
    push_title = models.CharField(max_length=200, blank=True)
    push_message = models.CharField(max_length=200, blank=True)

    # --- Metrics ---
    view_count = models.IntegerField(default=0)
    
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)

    class Meta:
        ordering = ['-is_pinned', '-published_at', '-created_at']

    def __str__(self):
        return f"{self.title} ({self.get_status_display()})"


class PostImage(models.Model):
    """
    Allows multiple images per post (Section 3.B).
    """
    post = models.ForeignKey(Post, on_delete=models.CASCADE, related_name='images')
    image = models.FileField(upload_to='posts/images/', validators=[image_validator])
    order = models.IntegerField(default=0)

    class Meta:
        ordering = ['order']


class PostComment(models.Model):
    """
    Comment system (Section 9).
    """
    post = models.ForeignKey(Post, on_delete=models.CASCADE, related_name='comments')
    author = models.ForeignKey(settings.AUTH_USER_MODEL, on_delete=models.CASCADE, related_name='post_comments')
    content = models.TextField(max_length=1000)
    
    parent = models.ForeignKey('self', on_delete=models.CASCADE, null=True, blank=True, related_name='replies')
    
    is_approved = models.BooleanField(default=True) # Defaults to true unless moderation is on
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)

    def __str__(self):
        return f"Comment by {self.author} on {self.post}"
--- END OF FILE: ./backend/posts/models.py ---


--- START OF FILE: ./backend/posts/serializers.py ---
from rest_framework import serializers
from django.db.models import Max
from .models import Post, PostImage, PostComment
from users.serializers import CustomUserSerializer # To show author details
from organization.serializers import MunicipalitySerializer, ClubSerializer # Import these for display
from organization.models import Municipality, Club
import json

class PostImageSerializer(serializers.ModelSerializer):
    class Meta:
        model = PostImage
        fields = ['id', 'image', 'order']

class PostCommentSerializer(serializers.ModelSerializer):
    author = CustomUserSerializer(read_only=True)
    
    class Meta:
        model = PostComment
        fields = ['id', 'post', 'author', 'content', 'parent', 'is_approved', 'created_at']
        read_only_fields = ['is_approved', 'author']

class PostSerializer(serializers.ModelSerializer):
    images = PostImageSerializer(many=True, read_only=True)
    author = CustomUserSerializer(read_only=True)
    
    # Read-only details for the UI
    target_municipalities_details = MunicipalitySerializer(source='target_municipalities', many=True, read_only=True)
    target_clubs_details = ClubSerializer(source='target_clubs', many=True, read_only=True)
    
    # Write-only fields for ManyToMany
    target_municipalities = serializers.PrimaryKeyRelatedField(
        many=True, read_only=False, queryset=Municipality.objects.all(), required=False
    )
    target_clubs = serializers.PrimaryKeyRelatedField(
        many=True, read_only=False, queryset=Club.objects.all(), required=False
    )
    
    # We will accept uploaded files as a list during creation
    uploaded_images = serializers.ListField(
        child=serializers.FileField(max_length=100000, allow_empty_file=False, use_url=False),
        write_only=True,
        required=False
    )
    
    # Accept list of image IDs to delete during update
    images_to_delete = serializers.ListField(
        child=serializers.IntegerField(),
        write_only=True,
        required=False
    )
    
    comment_count = serializers.IntegerField(read_only=True)

    class Meta:
        model = Post
        fields = '__all__'
        read_only_fields = [
            'author', 'owner_role', 'municipality', 'club', 'view_count', 'comment_count',
            'target_municipalities_details', 'target_clubs_details'
        ]
    
    def validate(self, data):
        """
        Validate that JSON fields are lists/dicts.
        Handle both JSON strings (from FormData) and native types (from JSON API).
        Also handle boolean strings from FormData.
        """
        # Handle boolean strings from FormData
        boolean_fields = ['is_pinned', 'allow_comments', 'require_moderation', 'allow_replies', 'send_push_notification', 'is_global']
        for field in boolean_fields:
            if field in data and isinstance(data[field], str):
                data[field] = data[field].lower() == 'true'
        
        # Parse JSON strings if they come from FormData
        if 'target_genders' in data:
            if isinstance(data['target_genders'], str):
                try:
                    data['target_genders'] = json.loads(data['target_genders'])
                except (json.JSONDecodeError, ValueError):
                    raise serializers.ValidationError({"target_genders": "Invalid JSON format."})
            if not isinstance(data['target_genders'], list):
                raise serializers.ValidationError({"target_genders": "Must be a list."})
        
        if 'target_grades' in data:
            if isinstance(data['target_grades'], str):
                try:
                    data['target_grades'] = json.loads(data['target_grades'])
                except (json.JSONDecodeError, ValueError):
                    raise serializers.ValidationError({"target_grades": "Invalid JSON format."})
            if not isinstance(data['target_grades'], list):
                raise serializers.ValidationError({"target_grades": "Must be a list."})
        
        if 'target_custom_fields' in data:
            if isinstance(data['target_custom_fields'], str):
                try:
                    data['target_custom_fields'] = json.loads(data['target_custom_fields'])
                except (json.JSONDecodeError, ValueError):
                    raise serializers.ValidationError({"target_custom_fields": "Invalid JSON format."})
            if not isinstance(data['target_custom_fields'], dict):
                raise serializers.ValidationError({"target_custom_fields": "Must be a dictionary."})
        
        return data

    def create(self, validated_data):
        # Extract ManyToMany fields (they can't be set during create)
        # DRF automatically parses multiple FormData values into lists for ManyToMany fields
        target_groups = validated_data.pop('target_groups', [])
        target_interests = validated_data.pop('target_interests', [])
        t_munis = validated_data.pop('target_municipalities', [])
        t_clubs = validated_data.pop('target_clubs', [])
        uploaded_images = validated_data.pop('uploaded_images', [])
        
        # Ensure they're lists (in case DRF didn't parse them correctly)
        if not isinstance(target_groups, list):
            target_groups = [target_groups] if target_groups else []
        if not isinstance(target_interests, list):
            target_interests = [target_interests] if target_interests else []
        if not isinstance(t_munis, list):
            t_munis = [t_munis] if t_munis else []
        if not isinstance(t_clubs, list):
            t_clubs = [t_clubs] if t_clubs else []
        
        # For club admins: automatically add their club to target_clubs if not specified
        user = self.context.get('request').user if self.context.get('request') else None
        if user and user.role == 'CLUB_ADMIN' and user.assigned_club:
            # If no clubs specified, automatically add the club admin's club
            if not t_clubs:
                t_clubs = [user.assigned_club.id]
            # Ensure the club admin's club is always included (even if they somehow specified others)
            elif user.assigned_club.id not in t_clubs:
                t_clubs.append(user.assigned_club.id)
        
        # Create the post
        post = Post.objects.create(**validated_data)

        # Set ManyToMany relationships (even if empty, to clear any defaults)
        post.target_groups.set(target_groups)
        post.target_interests.set(target_interests)
        post.target_municipalities.set(t_munis)
        post.target_clubs.set(t_clubs)

        # Handle Image Uploads
        for index, image in enumerate(uploaded_images):
            PostImage.objects.create(post=post, image=image, order=index)

        return post

    def update(self, instance, validated_data):
        # Extract ManyToMany fields
        target_groups = validated_data.pop('target_groups', None)
        target_interests = validated_data.pop('target_interests', None)
        t_munis = validated_data.pop('target_municipalities', None)
        t_clubs = validated_data.pop('target_clubs', None)
        uploaded_images = validated_data.pop('uploaded_images', [])
        images_to_delete = validated_data.pop('images_to_delete', [])
        
        # Ensure they're lists if provided
        if target_groups is not None and not isinstance(target_groups, list):
            target_groups = [target_groups] if target_groups else []
        if target_interests is not None and not isinstance(target_interests, list):
            target_interests = [target_interests] if target_interests else []
        if t_munis is not None and not isinstance(t_munis, list):
            t_munis = [t_munis] if t_munis else []
        if t_clubs is not None and not isinstance(t_clubs, list):
            t_clubs = [t_clubs] if t_clubs else []
        
        # Handle image deletion first
        if images_to_delete:
            if isinstance(images_to_delete, str):
                try:
                    images_to_delete = json.loads(images_to_delete)
                except (json.JSONDecodeError, ValueError):
                    images_to_delete = []
            if isinstance(images_to_delete, list):
                instance.images.filter(id__in=images_to_delete).delete()
        
        # Update standard fields
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()
        
        # Update ManyToMany relationships if provided
        if target_groups is not None:
            instance.target_groups.set(target_groups)
        if target_interests is not None:
            instance.target_interests.set(target_interests)
        if t_munis is not None:
            instance.target_municipalities.set(t_munis)
        if t_clubs is not None:
            instance.target_clubs.set(t_clubs)
        
        # Handle new image uploads
        if uploaded_images:
            # Get current max order
            current_max_order = instance.images.aggregate(max_order=Max('order'))['max_order'] or -1
            for index, image in enumerate(uploaded_images):
                PostImage.objects.create(post=instance, image=image, order=current_max_order + 1 + index)
        
        return instance
--- END OF FILE: ./backend/posts/serializers.py ---


--- START OF FILE: ./backend/posts/apps.py ---
from django.apps import AppConfig


class PostsConfig(AppConfig):
    default_auto_field = 'django.db.models.BigAutoField'
    name = 'posts'

--- END OF FILE: ./backend/posts/apps.py ---


--- START OF FILE: ./backend/posts/admin.py ---
from django.contrib import admin

# Register your models here.

--- END OF FILE: ./backend/posts/admin.py ---


--- START OF FILE: ./backend/posts/tests.py ---
from django.test import TestCase

# Create your tests here.

--- END OF FILE: ./backend/posts/tests.py ---


--- START OF FILE: ./backend/posts/views.py ---
from rest_framework import viewsets, permissions, status, parsers
from rest_framework.decorators import action
from rest_framework.response import Response
from rest_framework.exceptions import PermissionDenied
from django.db.models import Q, Count
from django.utils import timezone
from datetime import timedelta

from .models import Post, PostComment
from .serializers import PostSerializer, PostCommentSerializer

class PostViewSet(viewsets.ModelViewSet):
    serializer_class = PostSerializer
    permission_classes = [permissions.IsAuthenticated]
    parser_classes = (parsers.MultiPartParser, parsers.FormParser, parsers.JSONParser)

    def get_queryset(self):
        """
        Filter posts based on Admin Role (Section 2 of Doc).
        """
        user = self.request.user
        queryset = Post.objects.all().annotate(comment_count=Count('comments'))

        # 1. Super Admin sees ALL posts
        if user.role == 'SUPER_ADMIN':
            return queryset.order_by('-is_pinned', '-created_at')

        # 2. Municipality Admin sees their Muni + Clubs inside it
        if user.role == 'MUNICIPALITY_ADMIN' and user.assigned_municipality:
            return queryset.filter(
                Q(municipality=user.assigned_municipality) |
                Q(club__municipality=user.assigned_municipality)
            ).order_by('-is_pinned', '-created_at')

        # 3. Club Admin sees ONLY their Club
        if user.role == 'CLUB_ADMIN' and user.assigned_club:
            return queryset.filter(club=user.assigned_club).order_by('-is_pinned', '-created_at')

        # 4. If regular user (Fallback), show nothing (Admins only in this view)
        return Post.objects.none()

    def perform_create(self, serializer):
        """
        Auto-assign Owner Role and Scope (Municipality/Club) based on who is creating.
        """
        user = self.request.user
        
        save_kwargs = {'author': user}

        if user.role == 'SUPER_ADMIN':
            save_kwargs['owner_role'] = 'SUPER_ADMIN'
            # Super admins can optionally set muni/club manually in the form, 
            # but for now we default to global if not provided.
            
        elif user.role == 'MUNICIPALITY_ADMIN' and user.assigned_municipality:
            save_kwargs['owner_role'] = 'MUNICIPALITY_ADMIN'
            save_kwargs['municipality'] = user.assigned_municipality
            
        elif user.role == 'CLUB_ADMIN' and user.assigned_club:
            save_kwargs['owner_role'] = 'CLUB_ADMIN'
            save_kwargs['club'] = user.assigned_club
            # Club admins can only post to their own club - automatically set target_clubs
            # Note: target_clubs will be set in the serializer's create method
        else:
            raise PermissionDenied("You do not have permission to create posts.")
            
        post = serializer.save(**save_kwargs)
        
        # For club admins, automatically add their club to target_clubs if not already set
        if user.role == 'CLUB_ADMIN' and user.assigned_club:
            if not post.target_clubs.filter(id=user.assigned_club.id).exists():
                post.target_clubs.add(user.assigned_club)
        
        return post

    @action(detail=False, methods=['get'])
    def analytics_overview(self, request):
        """
        Analytics for the Management Dashboard (Section 13).
        """
        queryset = self.get_queryset()
        now = timezone.now()
        
        total_posts = queryset.count()
        last_7_days = queryset.filter(created_at__gte=now - timedelta(days=7)).count()
        last_30_days = queryset.filter(created_at__gte=now - timedelta(days=30)).count()
        
        # Calculate Average Views (avoid division by zero)
        total_views = sum([p.view_count for p in queryset])
        avg_views = (total_views / total_posts) if total_posts > 0 else 0

        return Response({
            "total_posts": total_posts,
            "created_last_7_days": last_7_days,
            "created_last_30_days": last_30_days,
            "average_views": round(avg_views, 1)
        })

class PostCommentViewSet(viewsets.ModelViewSet):
    serializer_class = PostCommentSerializer
    permission_classes = [permissions.IsAuthenticated]

    def get_queryset(self):
        queryset = PostComment.objects.all().order_by('-created_at')
        
        # Allow filtering by post ID (e.g. /api/post-comments/?post_id=1)
        post_id = self.request.query_params.get('post_id')
        if post_id:
            queryset = queryset.filter(post_id=post_id)
            
        return queryset

    def perform_create(self, serializer):
        serializer.save(author=self.request.user)
--- END OF FILE: ./backend/posts/views.py ---


--- START OF FILE: ./backend/core/asgi.py ---
"""
ASGI config for core project.

It exposes the ASGI callable as a module-level variable named ``application``.

For more information on this file, see
https://docs.djangoproject.com/en/5.1/howto/deployment/asgi/
"""

import os

from django.core.asgi import get_asgi_application

os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'core.settings')

application = get_asgi_application()

--- END OF FILE: ./backend/core/asgi.py ---


--- START OF FILE: ./backend/core/settings.py ---
import os
from pathlib import Path

# Build paths inside the project like this: BASE_DIR / 'subdir'.
BASE_DIR = Path(__file__).resolve().parent.parent


# Quick-start development settings - unsuitable for production
# See https://docs.djangoproject.com/en/5.1/howto/deployment/checklist/

# SECURITY WARNING: keep the secret key used in production secret!
SECRET_KEY = 'django-insecure--=9kkpv))f8u^_0()806)3=3%8!d3(_185s!x2(&lz*3h#5$sj'

# SECURITY WARNING: don't run with debug turned on in production!
DEBUG = True

ALLOWED_HOSTS = []


# Application definition

INSTALLED_APPS = [
    'django.contrib.admin',
    'django.contrib.auth',
    'django.contrib.contenttypes',
    'django.contrib.sessions',
    'django.contrib.messages',
    'django.contrib.staticfiles',
    'rest_framework',
    'corsheaders',
    'djoser',
    'users',
    'api',
    'organization',
    'system_messages',
    'news',
    'custom_fields',
    'groups',
    'rewards',
    'posts',
]

MIDDLEWARE = [
    'corsheaders.middleware.CorsMiddleware',
    'django.middleware.security.SecurityMiddleware',
    'django.contrib.sessions.middleware.SessionMiddleware',
    'django.middleware.common.CommonMiddleware',
    'django.middleware.csrf.CsrfViewMiddleware',
    'django.contrib.auth.middleware.AuthenticationMiddleware',
    'django.contrib.messages.middleware.MessageMiddleware',
    'django.middleware.clickjacking.XFrameOptionsMiddleware',
]

ROOT_URLCONF = 'core.urls'

TEMPLATES = [
    {
        'BACKEND': 'django.template.backends.django.DjangoTemplates',
        'DIRS': [],
        'APP_DIRS': True,
        'OPTIONS': {
            'context_processors': [
                'django.template.context_processors.debug',
                'django.template.context_processors.request',
                'django.contrib.auth.context_processors.auth',
                'django.contrib.messages.context_processors.messages',
            ],
        },
    },
]

WSGI_APPLICATION = 'core.wsgi.application'


# Database
# https://docs.djangoproject.com/en/5.1/ref/settings/#databases

DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.sqlite3',
        'NAME': BASE_DIR / 'db.sqlite3',
    }
}


# Password validation
# https://docs.djangoproject.com/en/5.1/ref/settings/#auth-password-validators

AUTH_PASSWORD_VALIDATORS = [
    {
        'NAME': 'django.contrib.auth.password_validation.UserAttributeSimilarityValidator',
    },
    {
        'NAME': 'django.contrib.auth.password_validation.MinimumLengthValidator',
    },
    {
        'NAME': 'django.contrib.auth.password_validation.CommonPasswordValidator',
    },
    {
        'NAME': 'django.contrib.auth.password_validation.NumericPasswordValidator',
    },
]


# Internationalization
# https://docs.djangoproject.com/en/5.1/topics/i18n/

LANGUAGE_CODE = 'en-us'

TIME_ZONE = 'UTC'

USE_I18N = True

USE_TZ = True


# Static files (CSS, JavaScript, Images)
# https://docs.djangoproject.com/en/5.1/howto/static-files/

STATIC_URL = 'static/'

# Default primary key field type
# https://docs.djangoproject.com/en/5.1/ref/settings/#default-auto-field

DEFAULT_AUTO_FIELD = 'django.db.models.BigAutoField'

# Allow Next.js to talk to Django
CORS_ALLOWED_ORIGINS = [
    "http://localhost:3000",
]

AUTH_USER_MODEL = 'users.User'

# Media files (User uploads)
MEDIA_URL = '/media/'
MEDIA_ROOT = os.path.join(BASE_DIR, 'media')

# --- DRF & AUTH CONFIGURATION ---

REST_FRAMEWORK = {
    'DEFAULT_AUTHENTICATION_CLASSES': (
        'rest_framework_simplejwt.authentication.JWTAuthentication',
    ),
    'DEFAULT_PERMISSION_CLASSES': [
        'rest_framework.permissions.AllowAny',
    ],
    # --- PAGINATION ---
    'DEFAULT_PAGINATION_CLASS': 'rest_framework.pagination.PageNumberPagination',
    'PAGE_SIZE': 10, # How many items per page
}

from datetime import timedelta

SIMPLE_JWT = {
    'ACCESS_TOKEN_LIFETIME': timedelta(minutes=60),
    'REFRESH_TOKEN_LIFETIME': timedelta(days=1),
    'AUTH_HEADER_TYPES': ('JWT',),
}

DJOSER = {
    'LOGIN_FIELD': 'email',
    'USER_CREATE_PASSWORD_RETYPE': True,
    'SERIALIZERS': {
        'user_create': 'djoser.serializers.UserCreateSerializer',
        # Update these two lines to use your new serializer:
        'user': 'users.serializers.CustomUserSerializer',
        'current_user': 'users.serializers.CustomUserSerializer',
    },
}
--- END OF FILE: ./backend/core/settings.py ---


--- START OF FILE: ./backend/core/urls.py ---
from django.contrib import admin
from django.urls import path, include
from django.conf import settings
from django.conf.urls.static import static

urlpatterns = [
    path('admin/', admin.site.urls),
    path('api/', include('api.urls')),
]

# This logic is what serves the image files during development
# It connects the URL '/media/' to your actual 'media' folder
if settings.DEBUG:
    urlpatterns += static(settings.MEDIA_URL, document_root=settings.MEDIA_ROOT)
--- END OF FILE: ./backend/core/urls.py ---


--- START OF FILE: ./backend/core/wsgi.py ---
"""
WSGI config for core project.

It exposes the WSGI callable as a module-level variable named ``application``.

For more information on this file, see
https://docs.djangoproject.com/en/5.1/howto/deployment/wsgi/
"""

import os

from django.core.wsgi import get_wsgi_application

os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'core.settings')

application = get_wsgi_application()

--- END OF FILE: ./backend/core/wsgi.py ---


--- START OF FILE: ./backend/system_messages/models.py ---
from django.db import models
from django.utils import timezone
from users.models import User

class SystemMessage(models.Model):
    class MessageType(models.TextChoices):
        INFO = 'INFO', 'Information'       # Blue
        IMPORTANT = 'IMPORTANT', 'Important' # Orange
        WARNING = 'WARNING', 'Warning'     # Red

    title = models.CharField(max_length=200)
    message = models.TextField()
    message_type = models.CharField(max_length=20, choices=MessageType.choices, default=MessageType.INFO)
    
    # Configuration
    target_roles = models.JSONField(default=list, help_text='List of roles or ["ALL"]')
    is_sticky = models.BooleanField(default=False, help_text="If true, reappears on refresh even if closed")
    external_link = models.URLField(blank=True, null=True, help_text="Optional link to read more")
    
    # Lifespan
    created_at = models.DateTimeField(auto_now_add=True)
    expires_at = models.DateTimeField()

    class Meta:
        ordering = ['-created_at']

    def __str__(self):
        return f"{self.title} ({self.get_message_type_display()})"


class SystemMessageDismissal(models.Model):
    user = models.ForeignKey(User, on_delete=models.CASCADE, related_name='dismissed_messages')
    message = models.ForeignKey(SystemMessage, on_delete=models.CASCADE, related_name='dismissals')
    dismissed_at = models.DateTimeField(auto_now_add=True)

    class Meta:
        unique_together = ('user', 'message')
        ordering = ['-dismissed_at']

    def __str__(self):
        return f"{self.user.email} dismissed {self.message.title}"
--- END OF FILE: ./backend/system_messages/models.py ---


--- START OF FILE: ./backend/system_messages/serializers.py ---
from rest_framework import serializers
from .models import SystemMessage

class SystemMessageSerializer(serializers.ModelSerializer):
    class Meta:
        model = SystemMessage
        fields = [
            'id', 'title', 'message', 'message_type', 
            'target_roles', 'is_sticky', 'external_link', 
            'created_at', 'expires_at'
        ]
--- END OF FILE: ./backend/system_messages/serializers.py ---


--- START OF FILE: ./backend/system_messages/apps.py ---
from django.apps import AppConfig


class SystemMessagesConfig(AppConfig):
    default_auto_field = 'django.db.models.BigAutoField'
    name = 'system_messages'

--- END OF FILE: ./backend/system_messages/apps.py ---


--- START OF FILE: ./backend/system_messages/admin.py ---
from django.contrib import admin

# Register your models here.

--- END OF FILE: ./backend/system_messages/admin.py ---


--- START OF FILE: ./backend/system_messages/tests.py ---
from django.test import TestCase

# Create your tests here.

--- END OF FILE: ./backend/system_messages/tests.py ---


--- START OF FILE: ./backend/system_messages/views.py ---
from rest_framework import viewsets
from rest_framework.decorators import action
from rest_framework.response import Response
from rest_framework.permissions import IsAuthenticated
from rest_framework.exceptions import PermissionDenied
from django.utils import timezone
from users.permissions import IsSuperAdmin
from .models import SystemMessage, SystemMessageDismissal
from .serializers import SystemMessageSerializer

class SystemMessageViewSet(viewsets.ModelViewSet):
    queryset = SystemMessage.objects.all()
    serializer_class = SystemMessageSerializer

    def get_permissions(self):
        # Logged in users can view/dismiss their applicable messages
        if self.action in ['my_latest', 'active_list', 'dismiss', 'destroy']:
            return [IsAuthenticated()]
        # Municipality admins may delete non-sticky messages targeted to them
        if self.action in ['destroy']:
            return [IsAuthenticated()]
        # Only Super Admins can manage everything else (create/update)
        return [IsSuperAdmin()]

    @action(detail=False, methods=['get'])
    def my_latest(self, request):
        """
        Returns the SINGLE latest active message for the current user.
        Logic: Active + Targets User Role + Newest First.
        """
        user = request.user
        now = timezone.now()
        
        # Get all active messages (not expired)
        active_messages = SystemMessage.objects.filter(
            expires_at__gt=now
        ).order_by('-created_at')
        
        # Filter in Python for JSONField compatibility (works with SQLite and PostgreSQL)
        for msg in active_messages:
            target_roles = msg.target_roles if isinstance(msg.target_roles, list) else []
            # Check if message targets "ALL" or the user's specific role
            if "ALL" in target_roles or user.role in target_roles:
                return Response(SystemMessageSerializer(msg).data)
        
        return Response(None)

    @action(detail=False, methods=['get'])
    def active_list(self, request):
        """
        Returns ALL active messages for the user (for the 'Archive' view).
        """
        user = request.user
        now = timezone.now()
        
        # Get all active messages (not expired)
        active_messages = SystemMessage.objects.filter(
            expires_at__gt=now
        ).order_by('-created_at')
        
        # Filter in Python for JSONField compatibility (works with SQLite and PostgreSQL)
        matching_messages = []
        dismissed_ids = set(
            SystemMessageDismissal.objects.filter(user=user).values_list('message_id', flat=True)
        )
        for msg in active_messages:
            target_roles = msg.target_roles if isinstance(msg.target_roles, list) else []
            # Check if message targets "ALL" or the user's specific role
            if msg.id in dismissed_ids:
                continue
            if "ALL" in target_roles or user.role in target_roles:
                matching_messages.append(msg)

        return Response(SystemMessageSerializer(matching_messages, many=True).data)

    def destroy(self, request, *args, **kwargs):
        instance = self.get_object()
        user = request.user
        target_roles = instance.target_roles if isinstance(instance.target_roles, list) else []
        can_access = "ALL" in target_roles or getattr(user, 'role', None) in target_roles

        if getattr(user, 'role', None) == 'SUPER_ADMIN':
            return super().destroy(request, *args, **kwargs)

        if getattr(user, 'role', None) == 'MUNICIPALITY_ADMIN' and can_access:
            if instance.is_sticky:
                raise PermissionDenied("Sticky messages cannot be dismissed.")
            SystemMessageDismissal.objects.get_or_create(user=user, message=instance)
            return Response(status=204)

        raise PermissionDenied("You do not have permission to delete this message.")

    @action(detail=True, methods=['post'], permission_classes=[IsAuthenticated], url_path='dismiss')
    def dismiss(self, request, pk=None):
        """
        Allows a user to dismiss a non-sticky message just for themselves.
        """
        user = request.user
        message = self.get_object()
        target_roles = message.target_roles if isinstance(message.target_roles, list) else []
        can_access = "ALL" in target_roles or getattr(user, 'role', None) in target_roles

        if not can_access:
            raise PermissionDenied("You do not have permission to dismiss this message.")

        if message.is_sticky and getattr(user, 'role', None) != 'SUPER_ADMIN':
            raise PermissionDenied("Sticky messages cannot be dismissed.")

        SystemMessageDismissal.objects.get_or_create(user=user, message=message)
        return Response({"status": "dismissed"})
--- END OF FILE: ./backend/system_messages/views.py ---


--- START OF FILE: ./backend/rewards/signals.py ---
from django.db.models.signals import pre_save, post_save
from django.dispatch import receiver
from django.utils import timezone
from users.models import User
from .models import Reward, RewardUsage
from .utils import grant_reward


@receiver(pre_save, sender=User)
def track_dob_change(sender, instance, **kwargs):
    """
    Checks if date_of_birth is changing.
    We attach a temporary flag '_dob_changed' to the instance to check in post_save.
    """
    if instance.pk: # Only for existing users
        try:
            old_user = User.objects.get(pk=instance.pk)
            if old_user.date_of_birth != instance.date_of_birth:
                instance._dob_changed = True
        except User.DoesNotExist:
            pass


@receiver(post_save, sender=User)
def check_reward_triggers(sender, instance, created, **kwargs):
    """
    Handles all automatic triggers: WELCOME, VERIFIED, and BIRTHDAY (on change).
    """
    user = instance
    
    # --- 1. WELCOME TRIGGER (On Creation) ---
    if created:
        welcome_rewards = Reward.objects.filter(active_triggers__icontains="WELCOME", is_active=True)
        for reward in welcome_rewards:
            triggers = reward.active_triggers if isinstance(reward.active_triggers, list) else []
            if "WELCOME" in triggers:
                grant_reward(user, reward)

    # --- 2. VERIFIED TRIGGER (On Update) ---
    if not created and user.verification_status == 'VERIFIED':
        verified_rewards = Reward.objects.filter(active_triggers__icontains="VERIFIED", is_active=True)
        for reward in verified_rewards:
            triggers = reward.active_triggers if isinstance(reward.active_triggers, list) else []
            if "VERIFIED" in triggers:
                grant_reward(user, reward)

    # --- 3. BIRTHDAY TRIGGER (On DOB Change) ---
    # If the user changes their birthday, we re-evaluate.
    if getattr(instance, '_dob_changed', False):
        print(f"üéÇ DOB changed for {user.email}. Re-evaluating birthday rewards...")
        
        # A. Revoke existing unredeemed birthday rewards
        # (Because the previous birthday date is no longer valid)
        user_usages = RewardUsage.objects.filter(user=user, is_redeemed=False)
        for usage in user_usages:
            triggers = usage.reward.active_triggers if isinstance(usage.reward.active_triggers, list) else []
            if "BIRTHDAY" in triggers:
                print(f"   -> Revoking previous birthday reward '{usage.reward.name}'")
                usage.delete()

        # B. Check if NEW birthday is today
        today = timezone.now().date()
        if user.date_of_birth and user.date_of_birth.month == today.month and user.date_of_birth.day == today.day:
            print("   -> New birthday is TODAY! Granting rewards...")
            birthday_rewards = Reward.objects.filter(active_triggers__icontains="BIRTHDAY", is_active=True)
            for reward in birthday_rewards:
                triggers = reward.active_triggers if isinstance(reward.active_triggers, list) else []
                if "BIRTHDAY" in triggers:
                    grant_reward(user, reward)
        else:
            print("   -> New birthday is not today.")

--- END OF FILE: ./backend/rewards/signals.py ---


--- START OF FILE: ./backend/rewards/models.py ---
from django.db import models
from django.conf import settings
from django.core.validators import MinValueValidator, MaxValueValidator, FileExtensionValidator
from organization.models import Municipality, Club, Interest
from groups.models import Group

# Validator for reward images
image_validator = FileExtensionValidator(allowed_extensions=['jpg', 'jpeg', 'png', 'webp'])

class Reward(models.Model):
    # --- Enums (Choices) ---
    class OwnerRole(models.TextChoices):
        SUPER_ADMIN = 'SUPER_ADMIN', 'Super Admin'
        MUNICIPALITY_ADMIN = 'MUNICIPALITY_ADMIN', 'Municipality Admin'
        CLUB_ADMIN = 'CLUB_ADMIN', 'Club Admin'

    class MemberType(models.TextChoices):
        YOUTH_MEMBER = 'YOUTH_MEMBER', 'Youth Member' # <--- CHANGED THIS
        GUARDIAN = 'GUARDIAN', 'Guardians Only'

    class TriggerType(models.TextChoices):
        NONE = 'NONE', 'Manual / No Trigger'
        BIRTHDAY = 'BIRTHDAY', 'Birthday'
        WELCOME = 'WELCOME', 'Welcome (Registration)'
        VERIFIED = 'VERIFIED', 'Verified Account'
        MOST_ACTIVE = 'MOST_ACTIVE', 'Most Active (Logins)'
        # MOST_CHECKED_IN can be added later

    # --- Basic Info (Section 3) ---
    name = models.CharField(max_length=200)
    description = models.TextField()
    image = models.FileField(
        upload_to='rewards/images/', 
        validators=[image_validator],
        blank=True, null=True
    )
    sponsor_name = models.CharField(max_length=200, blank=True)
    sponsor_link = models.URLField(blank=True, null=True)

    # --- Ownership & Scope (Section 2) ---
    owner_role = models.CharField(max_length=50, choices=OwnerRole.choices)
    
    # If owned by Municipality Admin:
    municipality = models.ForeignKey(Municipality, on_delete=models.CASCADE, null=True, blank=True, related_name='rewards')
    
    # If owned by Club Admin:
    club = models.ForeignKey(Club, on_delete=models.CASCADE, null=True, blank=True, related_name='rewards')

    # --- Targeting Options (Section 4) ---
    # A. Target Specific Groups
    target_groups = models.ManyToManyField(Group, blank=True, related_name='targeted_rewards')
    
    # B. Target Interests
    target_interests = models.ManyToManyField(Interest, blank=True, related_name='targeted_rewards')
    
    # C. Gender (Stored as list ["MALE", "FEMALE"])
    target_genders = models.JSONField(default=list, blank=True)
    
    # D. Grade (Stored as list [7, 8, 9])
    target_grades = models.JSONField(default=list, blank=True)
    
    # E. Age Range
    min_age = models.IntegerField(null=True, blank=True, validators=[MinValueValidator(0), MaxValueValidator(100)])
    max_age = models.IntegerField(null=True, blank=True, validators=[MinValueValidator(0), MaxValueValidator(100)])
    
    # F. Member Type
    target_member_type = models.CharField(max_length=20, choices=MemberType.choices, default=MemberType.YOUTH_MEMBER) # <--- CHANGED THIS

    # --- Constraints (Section 5) ---
    expiration_date = models.DateField(null=True, blank=True)
    usage_limit = models.IntegerField(null=True, blank=True, help_text="Total times this reward can be claimed. Null = Unlimited.")

    # --- Triggers (Section 6) ---
    # We allow multiple triggers, but for simplicity in SQL, we can store primary trigger type
    # or use a ManyToMany if you want complex combinations. 
    # Based on your doc, "Admins can choose one or several triggers".
    # For now, let's use a JSON list to store multiple trigger types e.g. ["BIRTHDAY", "VERIFIED"]
    active_triggers = models.JSONField(default=list, blank=True, help_text="List of active trigger codes")
    
    # Configuration for complex triggers (like Most Active)
    # Example: { "logins_per_day": 3, "top_n": 10, "period": "WEEKLY" }
    trigger_config = models.JSONField(default=dict, blank=True)

    # --- System Fields ---
    is_active = models.BooleanField(default=True)
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)

    def __str__(self):
        return f"{self.name} ({self.get_owner_role_display()})"


class RewardUsage(models.Model):
    """
    Tracks the lifecycle of a reward for a user.
    1. Created (Granted) -> When a trigger happens.
    2. Redeemed -> When the user actually uses it.
    """
    reward = models.ForeignKey(Reward, on_delete=models.CASCADE, related_name='usages')
    user = models.ForeignKey(settings.AUTH_USER_MODEL, on_delete=models.CASCADE, related_name='reward_usages')
    
    # When was it given to the user?
    created_at = models.DateTimeField(auto_now_add=True)
    
    # Has the user actually used it at the shop/club?
    is_redeemed = models.BooleanField(default=False)
    redeemed_at = models.DateTimeField(null=True, blank=True)

    class Meta:
        ordering = ['-created_at']
        # Ensure a user can't have multiple "active/unredeemed" copies of the same reward
        # They must use the first one before getting another (optional, but good practice)
        # For now, let's allow multiples if triggers fire multiple times, but usually we want to limit unique constraints here.
        # We will handle logic in utils.py instead of strict DB constraints to be safe.

    def __str__(self):
        status = "Redeemed" if self.is_redeemed else "Available"
        return f"{self.user} - {self.reward.name} ({status})"
--- END OF FILE: ./backend/rewards/models.py ---


--- START OF FILE: ./backend/rewards/serializers.py ---
from rest_framework import serializers
from .models import Reward, RewardUsage
from organization.serializers import InterestSerializer, ClubSerializer
from groups.serializers import GroupSerializer
import json

class RewardUsageSerializer(serializers.ModelSerializer):
    user_name = serializers.CharField(source='user.first_name', read_only=True)
    user_email = serializers.CharField(source='user.email', read_only=True)

    class Meta:
        model = RewardUsage
        # Include created_at as fallback if redeemed_at is null
        fields = ['id', 'user_name', 'user_email', 'redeemed_at', 'created_at']

class RewardSerializer(serializers.ModelSerializer):
    # Read-only fields to show details nicely in the frontend
    municipality_name = serializers.CharField(source='municipality.name', read_only=True)
    club_name = serializers.CharField(source='club.name', read_only=True)
    
    # Nested serializers for reading (shows full object details)
    target_groups_details = GroupSerializer(source='target_groups', many=True, read_only=True)
    target_interests_details = InterestSerializer(source='target_interests', many=True, read_only=True)

    # Write-only fields for saving data (accepts lists of IDs)
    target_groups = serializers.PrimaryKeyRelatedField(
        many=True, read_only=False, queryset=Reward.target_groups.rel.model.objects.all()
    )
    target_interests = serializers.PrimaryKeyRelatedField(
        many=True, read_only=False, queryset=Reward.target_interests.rel.model.objects.all()
    )

    class Meta:
        model = Reward
        fields = [
            'id', 'name', 'description', 'image', 
            'sponsor_name', 'sponsor_link',
            'owner_role', 'municipality', 'municipality_name', 'club', 'club_name',
            'target_groups', 'target_groups_details',
            'target_interests', 'target_interests_details',
            'target_genders', 'target_grades', 
            'min_age', 'max_age', 'target_member_type',
            'expiration_date', 'usage_limit',
            'active_triggers', 'trigger_config',
            'is_active', 'created_at'
        ]
        read_only_fields = ['id', 'created_at', 'owner_role', 'municipality', 'club']

    def validate(self, data):
        """
        Validate that JSON fields are lists.
        Handle both JSON strings (from FormData) and lists (from JSON API).
        """
        # Parse JSON strings if they come from FormData
        if 'target_genders' in data:
            if isinstance(data['target_genders'], str):
                try:
                    data['target_genders'] = json.loads(data['target_genders'])
                except (json.JSONDecodeError, ValueError):
                    raise serializers.ValidationError({"target_genders": "Invalid JSON format."})
            if not isinstance(data['target_genders'], list):
                raise serializers.ValidationError({"target_genders": "Must be a list."})
        
        if 'target_grades' in data:
            if isinstance(data['target_grades'], str):
                try:
                    data['target_grades'] = json.loads(data['target_grades'])
                except (json.JSONDecodeError, ValueError):
                    raise serializers.ValidationError({"target_grades": "Invalid JSON format."})
            if not isinstance(data['target_grades'], list):
                raise serializers.ValidationError({"target_grades": "Must be a list."})
        
        return data
--- END OF FILE: ./backend/rewards/serializers.py ---


--- START OF FILE: ./backend/rewards/apps.py ---
from django.apps import AppConfig

class RewardsConfig(AppConfig):
    default_auto_field = 'django.db.models.BigAutoField'
    name = 'rewards'

    def ready(self):
        import rewards.signals
--- END OF FILE: ./backend/rewards/apps.py ---


--- START OF FILE: ./backend/rewards/admin.py ---
from django.contrib import admin
from .models import Reward, RewardUsage

@admin.register(Reward)
class RewardAdmin(admin.ModelAdmin):
    # Columns to show in the list view
    list_display = ('name', 'owner_role', 'municipality', 'club', 'target_member_type', 'is_active', 'expiration_date')
    
    # Sidebar filters
    list_filter = ('owner_role', 'is_active', 'target_member_type', 'municipality', 'club')
    
    # Search bar config
    search_fields = ('name', 'description', 'sponsor_name')
    
    # Nice UI for selecting multiple Groups/Interests
    filter_horizontal = ('target_groups', 'target_interests')
    
    # Organizing the edit form into logical sections
    fieldsets = (
        ('Basic Info', {
            'fields': ('name', 'description', 'image', 'sponsor_name', 'sponsor_link', 'is_active')
        }),
        ('Ownership', {
            'fields': ('owner_role', 'municipality', 'club')
        }),
        ('Targeting', {
            'fields': (
                'target_member_type', 'target_groups', 'target_interests', 
                'target_genders', 'target_grades', 'min_age', 'max_age'
            )
        }),
        ('Constraints & Triggers', {
            'fields': ('expiration_date', 'usage_limit', 'active_triggers', 'trigger_config')
        }),
    )

@admin.register(RewardUsage)
class RewardUsageAdmin(admin.ModelAdmin):
    list_display = ('user', 'reward', 'is_redeemed', 'created_at', 'redeemed_at')
    list_filter = ('is_redeemed', 'reward', 'created_at')
    search_fields = ('user__email', 'reward__name')
--- END OF FILE: ./backend/rewards/admin.py ---


--- START OF FILE: ./backend/rewards/utils.py ---
from django.utils import timezone
from .models import Reward, RewardUsage

def is_user_eligible_for_reward(user, reward):
    """
    Checks if a user meets all targeting criteria for a reward.
    """
    print(f"Checking eligibility for User: {user.email} vs Reward: {reward.name}")

    # 1. Active Check
    if not reward.is_active:
        print("-> Failed: Reward is inactive")
        return False
    
    # 2. Scope Check
    if reward.owner_role == 'MUNICIPALITY_ADMIN':
        user_muni = user.assigned_municipality
        if not user_muni and user.preferred_club:
            user_muni = user.preferred_club.municipality
        if user_muni != reward.municipality:
            print("-> Failed: Municipality scope mismatch")
            return False
            
    if reward.owner_role == 'CLUB_ADMIN':
        user_club = user.assigned_club or user.preferred_club
        if user_club != reward.club:
            print("-> Failed: Club scope mismatch")
            return False

    # 3. Member Type
    if reward.target_member_type != user.role:
        print(f"-> Failed: Role mismatch. Reward wants {reward.target_member_type}, User is {user.role}")
        return False

    # 4. Demographics
    if reward.target_genders and user.legal_gender not in reward.target_genders:
        print(f"-> Failed: Gender mismatch. Reward needs {reward.target_genders}")
        return False
    
    # Note: Ensure user.grade is not None before comparing if target_grades is set
    if reward.target_grades:
        if user.grade is None or user.grade not in reward.target_grades:
            print(f"-> Failed: Grade mismatch. User grade is {user.grade}")
            return False
    
    # 5. Age
    if user.age is not None:
        if reward.min_age and user.age < reward.min_age: 
            print(f"-> Failed: Too young ({user.age} < {reward.min_age})")
            return False
        if reward.max_age and user.age > reward.max_age: 
            print(f"-> Failed: Too old ({user.age} > {reward.max_age})")
            return False

    # 6. Usage Limit
    if reward.usage_limit:
        count = RewardUsage.objects.filter(user=user, reward=reward).count()
        if count >= reward.usage_limit:
            print("-> Failed: Usage limit reached")
            return False

    print("-> Success! Eligible.")
    return True

def grant_reward(user, reward):
    """
    Grants a reward to a user (UNLOCKED state).
    It does NOT mark it as redeemed yet.
    """
    if is_user_eligible_for_reward(user, reward):
        # Check if they already have an UNREDEEMED copy of this reward
        # We generally don't want to stack 5 "Welcome" rewards if the trigger fires 5 times by accident
        exists = RewardUsage.objects.filter(
            user=user, 
            reward=reward, 
            is_redeemed=False
        ).exists()
        
        if exists:
            print(f"-> Skipped: User already has an active copy of '{reward.name}'")
            return False

        # Create the record as AVAILABLE (not redeemed)
        RewardUsage.objects.create(
            user=user, 
            reward=reward, 
            is_redeemed=False,
            redeemed_at=None
        )
        print(f"-> Granted '{reward.name}' to {user.email} (Pending Redemption)")
        return True
        
    return False
--- END OF FILE: ./backend/rewards/utils.py ---


--- START OF FILE: ./backend/rewards/tests.py ---
from django.test import TestCase

# Create your tests here.

--- END OF FILE: ./backend/rewards/tests.py ---


--- START OF FILE: ./backend/rewards/views.py ---
from rest_framework import viewsets, permissions, status
from rest_framework.decorators import action
from rest_framework.response import Response
from rest_framework.exceptions import PermissionDenied
from django.db.models import Q, Count
from django.utils import timezone
from datetime import timedelta

from .models import Reward, RewardUsage
from .serializers import RewardSerializer, RewardUsageSerializer

class RewardViewSet(viewsets.ModelViewSet):
    serializer_class = RewardSerializer
    permission_classes = [permissions.IsAuthenticated]

    def get_queryset(self):
        """
        Filter rewards based on the Admin's scope (Section 2).
        """
        user = self.request.user
        queryset = Reward.objects.all().order_by('-created_at')

        # Super Admin sees everything
        if user.role == 'SUPER_ADMIN':
            return queryset

        # Municipality Admin sees rewards in their muni + rewards in clubs of their muni
        if user.role == 'MUNICIPALITY_ADMIN' and user.assigned_municipality:
            return queryset.filter(
                Q(municipality=user.assigned_municipality) |
                Q(club__municipality=user.assigned_municipality)
            )

        # Club Admin sees only rewards in their club
        if user.role == 'CLUB_ADMIN' and user.assigned_club:
            return queryset.filter(club=user.assigned_club)

        # Regular users (Youth/Guardian) should not access this management endpoint
        # They will use a separate endpoint later to "see available rewards"
        return Reward.objects.none()

    def perform_create(self, serializer):
        """
        Automatically assign owner_role and scope based on the logged-in user.
        """
        user = self.request.user
        
        if user.role == 'SUPER_ADMIN':
            # Super Admin can create Global rewards (no muni/club)
            # OR they can manually assign them in the serializer if passed (not handled here for simplicity)
            serializer.save(owner_role='SUPER_ADMIN', municipality=None, club=None)
            
        elif user.role == 'MUNICIPALITY_ADMIN' and user.assigned_municipality:
            serializer.save(
                owner_role='MUNICIPALITY_ADMIN', 
                municipality=user.assigned_municipality,
                club=None
            )
            
        elif user.role == 'CLUB_ADMIN' and user.assigned_club:
            serializer.save(
                owner_role='CLUB_ADMIN', 
                municipality=None, # Explicitly None, as it belongs to the Club specifically
                club=user.assigned_club
            )
        else:
            raise PermissionDenied("You do not have permission to create rewards.")

    @action(detail=False, methods=['get'])
    def analytics_overview(self, request):
        """
        Analytics for the Management Page (Section 10.A).
        """
        queryset = self.get_queryset()
        now = timezone.now().date()
        
        # 1. Totals
        total_created = queryset.count()
        
        # Active: is_active=True AND (expiration is None OR expiration > today)
        active_count = queryset.filter(
            Q(is_active=True) & 
            (Q(expiration_date__isnull=True) | Q(expiration_date__gte=now))
        ).count()
        
        expired_count = queryset.filter(expiration_date__lt=now).count()

        # 2. Usage Stats (Redeemed only)
        visible_reward_ids = queryset.values_list('id', flat=True)
        usages = RewardUsage.objects.filter(reward_id__in=visible_reward_ids, is_redeemed=True)
        
        total_uses = usages.count()
        
        seven_days_ago = timezone.now() - timedelta(days=7)
        thirty_days_ago = timezone.now() - timedelta(days=30)
        
        uses_7d = usages.filter(redeemed_at__gte=seven_days_ago).count()
        uses_30d = usages.filter(redeemed_at__gte=thirty_days_ago).count()

        return Response({
            "total_created": total_created,
            "active_rewards": active_count,
            "expired_rewards": expired_count,
            "total_uses": total_uses,
            "uses_last_7_days": uses_7d,
            "uses_last_30_days": uses_30d
        })

    @action(detail=True, methods=['get'])
    def analytics_detail(self, request, pk=None):
        """
        Analytics for a Single Reward Detail Page.
        Only counts REDEEMED rewards.
        """
        reward = self.get_object()
        # Filter for redeemed items only
        usages = reward.usages.filter(is_redeemed=True)
        now = timezone.now()

        total_uses = usages.count()
        uses_24h = usages.filter(redeemed_at__gte=now - timedelta(hours=24)).count()
        uses_7d = usages.filter(redeemed_at__gte=now - timedelta(days=7)).count()
        uses_30d = usages.filter(redeemed_at__gte=now - timedelta(days=30)).count()

        days_remaining = None
        if reward.expiration_date:
            delta = (reward.expiration_date - now.date()).days
            days_remaining = max(delta, 0)

        return Response({
            "total_uses": total_uses,
            "uses_last_24h": uses_24h,
            "uses_last_7d": uses_7d,
            "uses_last_30d": uses_30d,
            "days_remaining": days_remaining
        })

    @action(detail=True, methods=['get'])
    def history(self, request, pk=None):
        """
        Returns the list of users who claimed (redeemed) this reward.
        """
        reward = self.get_object()
        
        # Only show REDEEMED rewards, ordered by when they were redeemed
        usages = reward.usages.filter(is_redeemed=True).select_related('user').order_by('-redeemed_at')
        
        page = self.paginate_queryset(usages)
        if page is not None:
            serializer = RewardUsageSerializer(page, many=True)
            return self.get_paginated_response(serializer.data)

        serializer = RewardUsageSerializer(usages, many=True)
        return Response(serializer.data)

    @action(detail=True, methods=['post'], permission_classes=[permissions.IsAuthenticated])
    def redeem(self, request, pk=None):
        """
        The User claims/uses the reward.
        """
        reward = self.get_object()
        user = request.user

        # 1. Check if they have a granted (unredeemed) copy
        usage = RewardUsage.objects.filter(
            user=user, 
            reward=reward, 
            is_redeemed=False
        ).first()

        if usage:
            # Mark as used
            usage.is_redeemed = True
            usage.redeemed_at = timezone.now()
            usage.save()
            return Response({"status": "redeemed", "message": f"You have used {reward.name}!"})
        
        # 2. If no granted copy, check if it's an "Open" reward (No Triggers)
        # If a reward has NO triggers, it is available to everyone who matches targeting
        # So we create a record and mark it redeemed immediately.
        if not reward.active_triggers:
            # We must re-check eligibility logic here to be safe
            from .utils import is_user_eligible_for_reward
            if is_user_eligible_for_reward(user, reward):
                RewardUsage.objects.create(
                    user=user, 
                    reward=reward, 
                    is_redeemed=True,
                    redeemed_at=timezone.now()
                )
                return Response({"status": "redeemed", "message": f"You have used {reward.name}!"})
            else:
                return Response({"error": "You are not eligible for this reward."}, status=403)

        return Response({"error": "No active reward to redeem."}, status=400)
--- END OF FILE: ./backend/rewards/views.py ---


--- START OF FILE: ./backend/rewards/management/commands/process_birthday_rewards.py ---
from django.core.management.base import BaseCommand
from django.utils import timezone
from users.models import User
from rewards.models import Reward
from rewards.utils import grant_reward

class Command(BaseCommand):
    help = 'Grants rewards to users whose birthday is today'

    def handle(self, *args, **kwargs):
        today = timezone.now().date()
        self.stdout.write(f"üìÖ Checking birthdays for Date: {today}")

        # 1. Find active Birthday Rewards
        birthday_rewards = []
        all_rewards = Reward.objects.filter(is_active=True)
        for r in all_rewards:
            triggers = r.active_triggers if isinstance(r.active_triggers, list) else []
            # Check for exact string match
            if "BIRTHDAY" in triggers:
                birthday_rewards.append(r)

        self.stdout.write(f"üéÅ Found {len(birthday_rewards)} active Birthday Reward(s).")
        if not birthday_rewards:
            self.stdout.write(self.style.WARNING("   -> No rewards found. Check if Reward is Active and Trigger is 'BIRTHDAY'."))
            return

        # 2. Find Users with birthday today
        birthday_users = User.objects.filter(
            date_of_birth__month=today.month, 
            date_of_birth__day=today.day
        )
        
        self.stdout.write(f"üéÇ Found {len(birthday_users)} User(s) with birthday today.")
        if not birthday_users:
            self.stdout.write(self.style.WARNING("   -> No users found. Check User 'Date of birth'."))

        # 3. Process
        count = 0
        for user in birthday_users:
            self.stdout.write(f"   Processing User: {user.email} (Role: {user.role})")
            for reward in birthday_rewards:
                self.stdout.write(f"      - Trying Reward: {reward.name}")
                
                # We attempt to grant. The utils.py already prints eligibility failures to console.
                if grant_reward(user, reward):
                    count += 1
                    self.stdout.write(self.style.SUCCESS(f"        -> GRANTED!"))
                else:
                    self.stdout.write(self.style.WARNING(f"        -> SKIPPED (See reason above)"))

        self.stdout.write(self.style.SUCCESS(f"‚úÖ Done. Total rewards granted: {count}"))
--- END OF FILE: ./backend/rewards/management/commands/process_birthday_rewards.py ---


--- START OF FILE: ./backend/custom_fields/models.py ---
from django.db import models
from django.conf import settings
from organization.models import Municipality, Club

class CustomFieldDefinition(models.Model):
    """
    Defines the schema for a custom field.
    """
    class FieldType(models.TextChoices):
        TEXT = 'TEXT', 'Text Field'
        SINGLE_SELECT = 'SINGLE_SELECT', 'Single Select'
        MULTI_SELECT = 'MULTI_SELECT', 'Multi Select'
        BOOLEAN = 'BOOLEAN', 'Boolean (Checkbox)'

    class OwnerRole(models.TextChoices):
        SUPER_ADMIN = 'SUPER_ADMIN', 'Super Admin'
        MUNICIPALITY_ADMIN = 'MUNICIPALITY_ADMIN', 'Municipality Admin'
        CLUB_ADMIN = 'CLUB_ADMIN', 'Club Admin'

    class Context(models.TextChoices):
        USER_PROFILE = 'USER_PROFILE', 'User Profile'
        EVENT = 'EVENT', 'Event'

    # --- Basic Configuration ---
    name = models.CharField(max_length=255, help_text="Label for the field")
    help_text = models.CharField(max_length=255, blank=True, null=True, help_text="Hint text displayed to user")
    field_type = models.CharField(max_length=20, choices=FieldType.choices, default=FieldType.TEXT)
    
    # Stores options for Single/Multi select as a JSON list ["Option A", "Option B"]
    options = models.JSONField(default=list, blank=True, help_text="List of options for select fields")
    
    required = models.BooleanField(default=False)
    is_published = models.BooleanField(default=True)

    # --- Scoping & Permissions ---
    context = models.CharField(max_length=20, choices=Context.choices, default=Context.USER_PROFILE)
    
    # Target Roles: e.g. ["YOUTH_MEMBER", "GUARDIAN"]
    target_roles = models.JSONField(default=list)

    # --- Ownership Logic ---
    owner_role = models.CharField(max_length=50, choices=OwnerRole.choices)
    
    # If owned by Municipality:
    municipality = models.ForeignKey(Municipality, on_delete=models.CASCADE, null=True, blank=True, related_name='custom_fields')
    # Optional: Limit to specific clubs within that municipality
    specific_clubs = models.ManyToManyField(Club, blank=True, related_name='specific_custom_fields', help_text="If set, only applies to these clubs within the municipality")

    # If owned by Club:
    club = models.ForeignKey(Club, on_delete=models.CASCADE, null=True, blank=True, related_name='custom_fields')

    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)

    def __str__(self):
        return f"{self.name} ({self.get_field_type_display()})"


class CustomFieldValue(models.Model):
    """
    Stores the actual data entered by a user for a specific field.
    """
    field = models.ForeignKey(CustomFieldDefinition, on_delete=models.CASCADE, related_name='values')
    user = models.ForeignKey(settings.AUTH_USER_MODEL, on_delete=models.CASCADE, related_name='custom_field_values')
    
    # Using JSONField allows us to store Strings, Booleans, or Lists (for Multi Select) easily
    value = models.JSONField(null=True, blank=True)
    
    updated_at = models.DateTimeField(auto_now=True)

    class Meta:
        unique_together = ('field', 'user')

    def __str__(self):
        return f"{self.user} - {self.field.name}: {self.value}"
--- END OF FILE: ./backend/custom_fields/models.py ---


--- START OF FILE: ./backend/custom_fields/serializers.py ---
from rest_framework import serializers
from .models import CustomFieldDefinition, CustomFieldValue
from organization.serializers import ClubSerializer

class CustomFieldDefinitionSerializer(serializers.ModelSerializer):
    # Used to show which specific clubs are selected (read-only)
    specific_clubs_details = ClubSerializer(source='specific_clubs', many=True, read_only=True)
    
    class Meta:
        model = CustomFieldDefinition
        fields = [
            'id', 'name', 'help_text', 'field_type', 'options',
            'required', 'is_published', 'context', 'target_roles',
            'owner_role', 'municipality', 'club', 'specific_clubs', 'specific_clubs_details',
            'created_at', 'updated_at'
        ]
        read_only_fields = ['id', 'created_at', 'updated_at', 'owner_role', 'municipality', 'club']

    def validate(self, data):
        """
        Ensure that Select fields have options.
        """
        field_type = data.get('field_type')
        options = data.get('options')

        if field_type in ['SINGLE_SELECT', 'MULTI_SELECT']:
            if not options or not isinstance(options, list) or len(options) == 0:
                raise serializers.ValidationError({
                    "options": "Options list is required for Select fields."
                })
        return data

class CustomFieldValueSerializer(serializers.ModelSerializer):
    class Meta:
        model = CustomFieldValue
        fields = ['id', 'field', 'user', 'value']


class CustomFieldUserViewSerializer(CustomFieldDefinitionSerializer):
    """
    Used when a User views fields applicable to them.
    Includes the user's saved value for this field.
    """
    value = serializers.SerializerMethodField()

    class Meta(CustomFieldDefinitionSerializer.Meta):
        fields = CustomFieldDefinitionSerializer.Meta.fields + ['value']

    def get_value(self, obj):
        # 'context' is passed from the View
        user = self.context.get('user')
        if user and user.is_authenticated:
            # Try to find a value for this field and user
            # We use the related name 'values' from the model definition
            val_obj = obj.values.filter(user=user).first()
            return val_obj.value if val_obj else None
        return None
--- END OF FILE: ./backend/custom_fields/serializers.py ---


--- START OF FILE: ./backend/custom_fields/apps.py ---
from django.apps import AppConfig


class CustomFieldsConfig(AppConfig):
    default_auto_field = 'django.db.models.BigAutoField'
    name = 'custom_fields'

--- END OF FILE: ./backend/custom_fields/apps.py ---


--- START OF FILE: ./backend/custom_fields/admin.py ---
from django.contrib import admin
from .models import CustomFieldDefinition, CustomFieldValue

@admin.register(CustomFieldDefinition)
class CustomFieldDefinitionAdmin(admin.ModelAdmin):
    list_display = ('name', 'field_type', 'owner_role', 'context', 'is_published', 'created_at')
    list_filter = ('owner_role', 'context', 'field_type', 'is_published')
    search_fields = ('name', 'help_text')
    ordering = ['-created_at']

@admin.register(CustomFieldValue)
class CustomFieldValueAdmin(admin.ModelAdmin):
    list_display = ('user', 'field', 'value', 'updated_at')
    search_fields = ('user__email', 'field__name', 'value')
    list_filter = ('field',)
--- END OF FILE: ./backend/custom_fields/admin.py ---


--- START OF FILE: ./backend/custom_fields/tests.py ---
from django.test import TestCase

# Create your tests here.

--- END OF FILE: ./backend/custom_fields/tests.py ---


--- START OF FILE: ./backend/custom_fields/views.py ---
from rest_framework import viewsets, permissions
from rest_framework.decorators import action
from rest_framework.response import Response
from rest_framework.exceptions import PermissionDenied
from django.db.models import Q
# Import User to check roles if needed, though request.user is sufficient
from .models import CustomFieldDefinition, CustomFieldValue
from .serializers import CustomFieldDefinitionSerializer, CustomFieldUserViewSerializer, CustomFieldValueSerializer

class CustomFieldDefinitionViewSet(viewsets.ModelViewSet):
    serializer_class = CustomFieldDefinitionSerializer
    permission_classes = [permissions.IsAuthenticated]
    
    def get_queryset(self):
        """
        Filter fields based on the admin's role and scope.
        - SUPER_ADMIN: sees ALL fields (global + municipality + club) for editing users
        - MUNICIPALITY_ADMIN: sees global fields + MUNICIPALITY_ADMIN fields for their municipality
        - CLUB_ADMIN: sees global fields + CLUB_ADMIN fields for their club
        """
        user = self.request.user
        role = user.role
        
        if role == 'SUPER_ADMIN':
            # Super admins see ALL fields (global + municipality + club) for editing any user
            return CustomFieldDefinition.objects.all()
        
        elif role == 'MUNICIPALITY_ADMIN':
            # Municipality admins see global fields + their municipality fields + club fields for clubs in their municipality
            municipality = user.assigned_municipality
            if isinstance(municipality, dict):
                municipality_id = municipality.get('id')
            elif hasattr(municipality, 'id'):
                municipality_id = municipality.id
            else:
                municipality_id = municipality
            
            if municipality_id:
                # Get all club IDs in this municipality
                from organization.models import Club
                club_ids = Club.objects.filter(municipality_id=municipality_id).values_list('id', flat=True)
                
                return CustomFieldDefinition.objects.filter(
                    Q(owner_role='SUPER_ADMIN') |  # Global fields
                    Q(owner_role='MUNICIPALITY_ADMIN', municipality_id=municipality_id) |  # Their municipality fields
                    Q(owner_role='CLUB_ADMIN', club_id__in=club_ids)  # Club fields for clubs in their municipality
                )
            # If no municipality assigned, only show global fields
            return CustomFieldDefinition.objects.filter(owner_role='SUPER_ADMIN')
        
        elif role == 'CLUB_ADMIN':
            # Club admins see global fields + their club fields + municipality fields for their club's municipality
            club = user.assigned_club
            if isinstance(club, dict):
                club_id = club.get('id')
            elif hasattr(club, 'id'):
                club_id = club.id
            else:
                club_id = club
            
            if club_id:
                # Get the club's municipality
                from organization.models import Club
                try:
                    club_obj = Club.objects.get(id=club_id)
                    municipality_id = club_obj.municipality_id
                    
                    return CustomFieldDefinition.objects.filter(
                        Q(owner_role='SUPER_ADMIN') |  # Global fields
                        Q(owner_role='CLUB_ADMIN', club_id=club_id) |  # Their club fields
                        Q(owner_role='MUNICIPALITY_ADMIN', municipality_id=municipality_id)  # Municipality fields for their club's municipality
                    )
                except Club.DoesNotExist:
                    # Club doesn't exist, fall back to just global and club fields
                    return CustomFieldDefinition.objects.filter(
                        Q(owner_role='SUPER_ADMIN') |  # Global fields
                        Q(owner_role='CLUB_ADMIN', club_id=club_id)  # Their club fields
                    )
            # If no club assigned, only show global fields
            return CustomFieldDefinition.objects.filter(owner_role='SUPER_ADMIN')
        
        # Default: no access
        return CustomFieldDefinition.objects.none()
    
    def perform_create(self, serializer):
        """
        Automatically set owner_role, municipality, and club based on the user's role.
        - SUPER_ADMIN: Global fields (no municipality/club)
        - MUNICIPALITY_ADMIN: Fields assigned to their municipality
        - CLUB_ADMIN: Fields assigned to their club
        """
        user = self.request.user
        role = user.role
        
        # Set owner_role
        owner_role = None
        if role == 'SUPER_ADMIN':
            owner_role = 'SUPER_ADMIN'
        elif role == 'MUNICIPALITY_ADMIN':
            owner_role = 'MUNICIPALITY_ADMIN'
        elif role == 'CLUB_ADMIN':
            owner_role = 'CLUB_ADMIN'
        
        if not owner_role:
            raise PermissionDenied("Only admins can create custom fields.")
        
        # Get municipality/club IDs - explicitly handle None for super admins
        municipality_id = None
        club_id = None
        
        if role == 'MUNICIPALITY_ADMIN':
            # Municipality admin: assign to their municipality, club should be None
            municipality = user.assigned_municipality
            if municipality:
                if isinstance(municipality, dict):
                    municipality_id = municipality.get('id')
                elif hasattr(municipality, 'id'):
                    municipality_id = municipality.id
                else:
                    municipality_id = municipality
                
                if not municipality_id:
                    raise PermissionDenied("Municipality admin must be assigned to a municipality.")
            else:
                raise PermissionDenied("Municipality admin must be assigned to a municipality.")
        
        elif role == 'CLUB_ADMIN':
            # Club admin: assign to their club, municipality should be None
            club = user.assigned_club
            if club:
                if isinstance(club, dict):
                    club_id = club.get('id')
                elif hasattr(club, 'id'):
                    club_id = club.id
                else:
                    club_id = club
                
                if not club_id:
                    raise PermissionDenied("Club admin must be assigned to a club.")
            else:
                raise PermissionDenied("Club admin must be assigned to a club.")
        
        # For SUPER_ADMIN: municipality_id and club_id remain None (global fields)
        
        # Save with the appropriate ownership
        # Explicitly set None for fields that shouldn't be assigned
        save_kwargs = {
            'owner_role': owner_role,
            'municipality_id': municipality_id,  # None for SUPER_ADMIN and CLUB_ADMIN
            'club_id': club_id,  # None for SUPER_ADMIN and MUNICIPALITY_ADMIN
        }
        
        serializer.save(**save_kwargs)
    
    def perform_update(self, serializer):
        """
        Ensure ownership fields cannot be changed during update.
        The get_queryset already ensures admins can only see/edit their own fields.
        """
        instance = serializer.instance
        
        # Prevent changing ownership
        serializer.save(
            owner_role=instance.owner_role,
            municipality_id=instance.municipality_id if instance.municipality_id else None,
            club_id=instance.club_id if instance.club_id else None
        )

    @action(detail=False, methods=['get'], permission_classes=[permissions.IsAuthenticated])
    def applicable(self, request):
        """
        Returns fields applicable to the current logged-in user.
        Combines Global + Municipality + Club fields.
        """
        user = request.user
        role = user.role

        # 1. Determine Context (Club/Muni)
        # Ideally, a user (Youth) matches fields via their 'preferred_club'
        # A Guardian might match via their children, but for V1 let's use user attributes.
        
        target_club = user.preferred_club or user.assigned_club
        target_muni = user.assigned_municipality
        
        if target_club and not target_muni:
            target_muni = target_club.municipality

        # 2. Build Query
        # A. Always include Global Super Admin fields
        query = Q(owner_role='SUPER_ADMIN')

        # B. Include Municipality Fields (if user is linked to a muni)
        if target_muni:
            # Must be owned by Muni AND (no specific clubs set OR club is in specific_clubs)
            muni_query = Q(owner_role='MUNICIPALITY_ADMIN', municipality=target_muni)
            
            if target_club:
                # Logic: (specific_clubs is empty) OR (target_club in specific_clubs)
                # In Django Q objects for M2M: 
                # specific_clubs=None checks if the relation is empty.
                # specific_clubs=target_club checks if specific club is in the list.
                muni_query &= (Q(specific_clubs=None) | Q(specific_clubs=target_club))
            else:
                # If user has no club (just muni), only show fields that apply to ALL clubs
                muni_query &= Q(specific_clubs=None)
            
            query |= muni_query

        # C. Include Club Fields (if user is linked to a club)
        if target_club:
            query |= Q(owner_role='CLUB_ADMIN', club=target_club)

        # 3. Execute Database Fetch
        # Filter by: Calculated Scope AND Published AND Profile Context
        fields = CustomFieldDefinition.objects.filter(query).filter(
            is_published=True,
            context='USER_PROFILE' 
        ).distinct()

        # 4. Post-Filter by Role (Python side for JSONField safety across DBs)
        # Check if the field's target_roles list contains the user's role OR "ALL"
        final_fields = []
        for f in fields:
            # Clean/normalize list
            allowed_roles = f.target_roles if isinstance(f.target_roles, list) else []
            if "ALL" in allowed_roles or role in allowed_roles:
                final_fields.append(f)

        # 5. Serialize (Including User Values)
        serializer = CustomFieldUserViewSerializer(final_fields, many=True, context={'user': user})
        return Response(serializer.data)

    @action(detail=False, methods=['post'], permission_classes=[permissions.IsAuthenticated])
    def save_values(self, request):
        """
        Bulk save values for the logged-in user.
        Expected Payload: { "field_id": value, "field_id_2": value }
        """
        user = request.user
        data = request.data
        
        results = []
        
        for field_id, val in data.items():
            try:
                field_def = CustomFieldDefinition.objects.get(id=field_id)
                # Security Check: Is this field actually applicable?
                # (For MVP speed, we skip complex re-verification here, 
                # but ideally you re-run the query logic above to ensure they aren't hacking fields)
                
                obj, created = CustomFieldValue.objects.update_or_create(
                    field=field_def,
                    user=user,
                    defaults={'value': val}
                )
                results.append({"id": field_id, "status": "saved"})
            except CustomFieldDefinition.DoesNotExist:
                continue
                
        return Response({"results": results})

    @action(detail=False, methods=['get'], permission_classes=[permissions.IsAuthenticated])
    def applicable_for_user(self, request):
        """
        Returns fields applicable to a specific user (for admin editing).
        Takes user_id as query parameter.
        Returns fields based on the user's municipality/club, not the admin's scope.
        """
        admin_user = request.user
        user_id = request.query_params.get('user_id')
        
        if not user_id:
            return Response({"error": "user_id parameter required"}, status=400)
        
        # Check if admin has permission
        if admin_user.role not in ['SUPER_ADMIN', 'MUNICIPALITY_ADMIN', 'CLUB_ADMIN']:
            raise PermissionDenied("Only admins can view custom fields for other users.")
        
        try:
            from users.models import User
            target_user = User.objects.get(id=user_id)
        except User.DoesNotExist:
            return Response({"error": "User not found"}, status=404)
        
        # Verify admin has permission to edit this user
        # Super admin can edit anyone
        if admin_user.role == 'SUPER_ADMIN':
            pass  # Allowed
        elif admin_user.role == 'MUNICIPALITY_ADMIN':
            # Can only edit users in their municipality
            if target_user.preferred_club and target_user.preferred_club.municipality != admin_user.assigned_municipality:
                raise PermissionDenied("You can only view fields for users in your municipality.")
        elif admin_user.role == 'CLUB_ADMIN':
            # Can only edit users in their club
            # For guardians, check if any of their youth members are in the admin's club
            if target_user.role == 'GUARDIAN':
                # Guardians are linked to youth through GuardianYouthLink
                youth_links = target_user.youth_links.all()
                has_youth_in_club = any(link.youth.preferred_club == admin_user.assigned_club for link in youth_links)
                if not has_youth_in_club:
                    raise PermissionDenied("You can only view fields for guardians linked to youth in your club.")
            else:
                # For youth members, check preferred_club
                if target_user.preferred_club != admin_user.assigned_club:
                    raise PermissionDenied("You can only view fields for users in your club.")
        
        # Determine the target user's municipality and club
        # For guardians, get club from their linked youth members
        if target_user.role == 'GUARDIAN':
            # Guardians are linked to youth through GuardianYouthLink
            youth_links = target_user.youth_links.all()
            # Get the first youth member's club (or municipality if no club)
            target_club = None
            target_muni = None
            for link in youth_links:
                youth = link.youth
                if youth.preferred_club:
                    target_club = youth.preferred_club
                    target_muni = target_club.municipality
                    break
                elif youth.assigned_municipality:
                    target_muni = youth.assigned_municipality
        else:
            target_club = target_user.preferred_club or target_user.assigned_club
            target_muni = target_user.assigned_municipality
        
        if target_club and not target_muni:
            target_muni = target_club.municipality
        
        role = target_user.role
        
        # Build query for fields applicable to this user
        # A. Always include Global Super Admin fields
        query = Q(owner_role='SUPER_ADMIN')
        
        # B. Include Municipality Fields (if user is linked to a muni)
        if target_muni:
            muni_query = Q(owner_role='MUNICIPALITY_ADMIN', municipality=target_muni)
            
            if target_club:
                # Logic: (specific_clubs is empty) OR (target_club in specific_clubs)
                muni_query &= (Q(specific_clubs=None) | Q(specific_clubs=target_club))
            else:
                # If user has no club (just muni), only show fields that apply to ALL clubs
                muni_query &= Q(specific_clubs=None)
            
            query |= muni_query
        
        # C. Include Club Fields (if user is linked to a club)
        if target_club:
            query |= Q(owner_role='CLUB_ADMIN', club=target_club)
        
        # Execute Database Fetch
        fields = CustomFieldDefinition.objects.filter(query).filter(
            is_published=True,
            context='USER_PROFILE'
        ).distinct()
        
        # Post-Filter by Role (Python side for JSONField safety across DBs)
        final_fields = []
        for f in fields:
            allowed_roles = f.target_roles if isinstance(f.target_roles, list) else []
            if "ALL" in allowed_roles or role in allowed_roles:
                final_fields.append(f)
        
        # Serialize (Including User Values)
        serializer = CustomFieldUserViewSerializer(final_fields, many=True, context={'user': target_user})
        return Response(serializer.data)

    @action(detail=False, methods=['post'], permission_classes=[permissions.IsAuthenticated])
    def save_values_for_user(self, request):
        """
        Bulk save custom field values for a specific user (admin only).
        Expected Payload: { "user_id": 123, "values": { "field_id": value, "field_id_2": value } }
        """
        admin_user = request.user
        user_id = request.data.get('user_id')
        values = request.data.get('values', {})
        
        # Check if admin has permission
        if admin_user.role not in ['SUPER_ADMIN', 'MUNICIPALITY_ADMIN', 'CLUB_ADMIN']:
            raise PermissionDenied("Only admins can save custom field values for other users.")
        
        try:
            from users.models import User
            target_user = User.objects.get(id=user_id)
        except User.DoesNotExist:
            return Response({"error": "User not found"}, status=404)
        
        # Verify admin has permission to edit this user
        # Super admin can edit anyone
        if admin_user.role == 'SUPER_ADMIN':
            pass  # Allowed
        elif admin_user.role == 'MUNICIPALITY_ADMIN':
            # Can only edit users in their municipality
            if target_user.preferred_club and target_user.preferred_club.municipality != admin_user.assigned_municipality:
                raise PermissionDenied("You can only edit users in your municipality.")
        elif admin_user.role == 'CLUB_ADMIN':
            # Can only edit users in their club
            # For guardians, check if any of their youth members are in the admin's club
            if target_user.role == 'GUARDIAN':
                # Guardians are linked to youth through GuardianYouthLink
                youth_links = target_user.youth_links.all()
                has_youth_in_club = any(link.youth.preferred_club == admin_user.assigned_club for link in youth_links)
                if not has_youth_in_club:
                    raise PermissionDenied("You can only edit guardians linked to youth in your club.")
            else:
                # For youth members, check preferred_club
                if target_user.preferred_club != admin_user.assigned_club:
                    raise PermissionDenied("You can only edit users in your club.")
        
        results = []
        
        # Get all fields the admin can see (to validate)
        allowed_fields = self.get_queryset()
        allowed_field_ids = set(allowed_fields.values_list('id', flat=True))
        
        for field_id_str, val in values.items():
            try:
                field_id = int(field_id_str)
                
                # Security: Only allow fields the admin can see
                if field_id not in allowed_field_ids:
                    continue
                
                field_def = CustomFieldDefinition.objects.get(id=field_id)
                
                obj, created = CustomFieldValue.objects.update_or_create(
                    field=field_def,
                    user=target_user,
                    defaults={'value': val}
                )
                results.append({"id": field_id, "status": "saved"})
            except (ValueError, CustomFieldDefinition.DoesNotExist):
                continue
                
        return Response({"results": results})
--- END OF FILE: ./backend/custom_fields/views.py ---


--- START OF FILE: ./backend/groups/signals.py ---
from django.db.models.signals import post_save
from django.contrib.auth.signals import user_logged_in
from django.dispatch import receiver
from users.models import User
from .models import Group, GroupMembership

# 1. Registered Members (Triggered when a User is created)
@receiver(post_save, sender=User)
def add_to_registered_group(sender, instance, created, **kwargs):
    if created:
        try:
            group = Group.objects.get(system_group_type='REGISTERED')
            GroupMembership.objects.get_or_create(user=instance, group=group, defaults={'status': 'APPROVED'})
        except Group.DoesNotExist:
            pass # Group hasn't been created yet

# 2. Verified Members (Triggered when User is saved/updated)
@receiver(post_save, sender=User)
def update_verified_group(sender, instance, **kwargs):
    try:
        group = Group.objects.get(system_group_type='VERIFIED')
        is_member = GroupMembership.objects.filter(user=instance, group=group).exists()
        
        # If user is verified but NOT in group -> Add them
        if instance.verification_status == 'VERIFIED' and not is_member:
            GroupMembership.objects.create(user=instance, group=group, status='APPROVED')
            
        # If user is NOT verified but IS in group -> Remove them
        elif instance.verification_status != 'VERIFIED' and is_member:
            GroupMembership.objects.filter(user=instance, group=group).delete()
            
    except Group.DoesNotExist:
        pass

# 3. Active Members (Triggered when User logs in)
@receiver(user_logged_in)
def add_to_active_group(sender, user, request, **kwargs):
    try:
        group = Group.objects.get(system_group_type='ACTIVE')
        # We use get_or_create to ensure we don't duplicate or crash
        GroupMembership.objects.get_or_create(user=user, group=group, defaults={'status': 'APPROVED'})
    except Group.DoesNotExist:
        pass
--- END OF FILE: ./backend/groups/signals.py ---


--- START OF FILE: ./backend/groups/models.py ---
from django.db import models
from django.conf import settings
from django.core.validators import MinValueValidator, MaxValueValidator
from organization.models import Municipality, Club, Interest

class Group(models.Model):
    class GroupType(models.TextChoices):
        OPEN = 'OPEN', 'Open (Join Freely)'
        APPLICATION = 'APPLICATION', 'Application Required'
        CLOSED = 'CLOSED', 'Closed (Invite Only)'

    class MemberType(models.TextChoices):
        YOUTH = 'YOUTH', 'Youth Only'
        GUARDIAN = 'GUARDIAN', 'Guardians Only'

    class SystemGroupType(models.TextChoices):
        NONE = 'NONE', 'Standard Group'
        REGISTERED = 'REGISTERED', 'All Registered'
        ACTIVE = 'ACTIVE', 'Active Members'
        VERIFIED = 'VERIFIED', 'Verified Members'

    # --- Basic Info ---
    name = models.CharField(max_length=200)
    description = models.TextField(blank=True)
    # Using the same file validator you used in other apps
    avatar = models.FileField(upload_to='groups/avatars/', blank=True, null=True)
    
    # --- Scope & Ownership ---
    # If both are null, it's a Global Group (Super Admin only)
    municipality = models.ForeignKey(Municipality, on_delete=models.CASCADE, null=True, blank=True, related_name='groups')
    club = models.ForeignKey(Club, on_delete=models.CASCADE, null=True, blank=True, related_name='groups')
    
    # --- Configuration ---
    group_type = models.CharField(max_length=20, choices=GroupType.choices, default=GroupType.OPEN)
    target_member_type = models.CharField(max_length=20, choices=MemberType.choices, default=MemberType.YOUTH)
    
    # System Groups are managed by code, not admins
    is_system_group = models.BooleanField(default=False)
    system_group_type = models.CharField(max_length=20, choices=SystemGroupType.choices, default=SystemGroupType.NONE)

    # --- Eligibility Rules (Criteria) ---
    # Age Range (Null means no limit)
    min_age = models.IntegerField(null=True, blank=True, validators=[MinValueValidator(0), MaxValueValidator(100)])
    max_age = models.IntegerField(null=True, blank=True, validators=[MinValueValidator(0), MaxValueValidator(100)])
    
    # Grades: stored as a list of integers, e.g., [7, 8, 9]
    grades = models.JSONField(default=list, blank=True, help_text="List of allowed grades")
    
    # Genders: stored as a list, e.g., ["FEMALE", "OTHER"]
    genders = models.JSONField(default=list, blank=True, help_text="List of allowed genders")
    
    # Interests: Users must match at least one (M2M)
    interests = models.ManyToManyField(Interest, blank=True, related_name='targeted_groups')
    
    # Custom Fields Rules: e.g. {"field_id_5": true, "field_id_10": "Option A"}
    custom_field_rules = models.JSONField(default=dict, blank=True, help_text="Rules based on custom field values")

    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)

    def __str__(self):
        return f"{self.name} ({self.get_group_type_display()})"

class GroupMembership(models.Model):
    class Status(models.TextChoices):
        PENDING = 'PENDING', 'Pending Approval'
        APPROVED = 'APPROVED', 'Approved (Active)'
        REJECTED = 'REJECTED', 'Rejected'
    
    class Role(models.TextChoices):
        MEMBER = 'MEMBER', 'Member'
        ADMIN = 'ADMIN', 'Group Admin'

    group = models.ForeignKey(Group, on_delete=models.CASCADE, related_name='memberships')
    user = models.ForeignKey(settings.AUTH_USER_MODEL, on_delete=models.CASCADE, related_name='group_memberships')
    
    status = models.CharField(max_length=20, choices=Status.choices, default=Status.APPROVED)
    role = models.CharField(max_length=20, choices=Role.choices, default=Role.MEMBER)
    
    joined_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)

    class Meta:
        unique_together = ('group', 'user')

    def __str__(self):
        return f"{self.user} in {self.group}"
--- END OF FILE: ./backend/groups/models.py ---


--- START OF FILE: ./backend/groups/serializers.py ---
from rest_framework import serializers
from .models import Group, GroupMembership
from organization.serializers import InterestSerializer
from users.models import User  # Import User

class GroupMembershipSerializer(serializers.ModelSerializer):
    """
    Shows which user is in a group and their status (Pending/Approved).
    """
    user_name = serializers.SerializerMethodField()
    user_email = serializers.CharField(source='user.email', read_only=True)
    user_avatar = serializers.ImageField(source='user.avatar', read_only=True)
    # NEW: Group Name for the requests list
    group_name = serializers.CharField(source='group.name', read_only=True)

    class Meta:
        model = GroupMembership
        fields = ['id', 'user', 'user_name', 'user_email', 'user_avatar', 'group', 'group_name', 'status', 'role', 'joined_at']

    def get_user_name(self, obj):
        return f"{obj.user.first_name} {obj.user.last_name}"

class GroupSerializer(serializers.ModelSerializer):
    interests_details = InterestSerializer(source='interests', many=True, read_only=True)
    municipality_name = serializers.CharField(source='municipality.name', read_only=True)
    club_name = serializers.CharField(source='club.name', read_only=True)
    
    member_count = serializers.SerializerMethodField()
    pending_request_count = serializers.SerializerMethodField()

    # NEW: Write-only field to accept a list of User IDs to add immediately
    members_to_add = serializers.ListField(
        child=serializers.IntegerField(), 
        write_only=True, 
        required=False
    )

    class Meta:
        model = Group
        fields = [
            'id', 'name', 'description', 'avatar',
            'municipality', 'municipality_name',
            'club', 'club_name',
            'group_type', 'target_member_type',
            'is_system_group', 'system_group_type',
            'min_age', 'max_age', 'grades', 'genders',
            'interests', 'interests_details',
            'custom_field_rules',
            'member_count', 'pending_request_count', 'created_at',
            'members_to_add'  # Add to fields
        ]

    def get_member_count(self, obj):
        return obj.memberships.filter(status='APPROVED').count()

    def get_pending_request_count(self, obj):
        return obj.memberships.filter(status='PENDING').count()

    def create(self, validated_data):
        # Extract members data
        members_ids = validated_data.pop('members_to_add', [])
        interests = validated_data.pop('interests', [])
        
        # Create group
        group = Group.objects.create(**validated_data)
        group.interests.set(interests)
        
        # Add members
        for user_id in members_ids:
            # We use get_or_create to allow "updating" lists safely
            GroupMembership.objects.get_or_create(
                group=group, 
                user_id=user_id, 
                defaults={'status': 'APPROVED', 'role': 'MEMBER'}
            )
            
        return group

    def update(self, instance, validated_data):
        members_ids = validated_data.pop('members_to_add', [])
        interests = validated_data.pop('interests', None)
        
        # Update standard fields
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()
        
        # Update interests if provided
        if interests is not None:
            instance.interests.set(interests)
        
        # Add NEW members (we do not remove existing ones here to be safe)
        for user_id in members_ids:
            GroupMembership.objects.get_or_create(
                group=instance, 
                user_id=user_id, 
                defaults={'status': 'APPROVED', 'role': 'MEMBER'}
            )
            
        return instance
--- END OF FILE: ./backend/groups/serializers.py ---


--- START OF FILE: ./backend/groups/apps.py ---
from django.apps import AppConfig

class GroupsConfig(AppConfig):
    default_auto_field = 'django.db.models.BigAutoField'
    name = 'groups'

    def ready(self):
        import groups.signals
--- END OF FILE: ./backend/groups/apps.py ---


--- START OF FILE: ./backend/groups/admin.py ---
from django.contrib import admin
from .models import Group, GroupMembership

class MembershipInline(admin.TabularInline):
    model = GroupMembership
    extra = 0
    raw_id_fields = ('user',) # Useful if you have thousands of users

@admin.register(Group)
class GroupAdmin(admin.ModelAdmin):
    list_display = ('name', 'group_type', 'target_member_type', 'is_system_group', 'municipality', 'club')
    list_filter = ('group_type', 'is_system_group', 'municipality', 'club')
    search_fields = ('name', 'description')
    filter_horizontal = ('interests',) # Makes selecting many interests easier
    inlines = [MembershipInline] # Allows editing members directly inside the Group page

@admin.register(GroupMembership)
class GroupMembershipAdmin(admin.ModelAdmin):
    list_display = ('user', 'group', 'status', 'role', 'joined_at')
    list_filter = ('status', 'role', 'group')
    search_fields = ('user__email', 'user__first_name', 'group__name')
--- END OF FILE: ./backend/groups/admin.py ---


--- START OF FILE: ./backend/groups/permissions.py ---
from rest_framework import permissions

class IsGroupAdminOrReadOnly(permissions.BasePermission):
    """
    Custom permission to ensure:
    - Super Admins can do anything.
    - Muni Admins can edit groups in their municipality.
    - Club Admins can edit groups in their club.
    - Others can only read (SAFE_METHODS).
    """
    def has_permission(self, request, view):
        # Allow anyone logged in to view the list (filtering happens in get_queryset)
        if request.method in permissions.SAFE_METHODS:
            return request.user and request.user.is_authenticated
        
        # Only Admins can create/edit/delete
        return request.user.role in ['SUPER_ADMIN', 'MUNICIPALITY_ADMIN', 'CLUB_ADMIN']

    def has_object_permission(self, request, view, obj):
        # Read permissions are allowed to any authenticated user
        if request.method in permissions.SAFE_METHODS:
            return True

        user = request.user
        if user.role == 'SUPER_ADMIN':
            return True
        
        # Muni Admin can edit if group belongs to their muni OR a club in their muni
        if user.role == 'MUNICIPALITY_ADMIN':
            if obj.municipality == user.assigned_municipality:
                return True
            if obj.club and obj.club.municipality == user.assigned_municipality:
                return True
                
        # Club Admin can edit if group belongs to their club
        if user.role == 'CLUB_ADMIN':
            if obj.club == user.assigned_club:
                return True

        return False

class IsGroupMembershipAdmin(permissions.BasePermission):
    """
    Permission for managing Group Memberships (Approving/Rejecting).
    """
    def has_permission(self, request, view):
        # Only admins can access this endpoint
        return request.user.is_authenticated and request.user.role in ['SUPER_ADMIN', 'MUNICIPALITY_ADMIN', 'CLUB_ADMIN']

    def has_object_permission(self, request, view, obj):
        # obj is a GroupMembership instance
        user = request.user
        group = obj.group
        
        if user.role == 'SUPER_ADMIN':
            return True
        
        # Muni Admin: Owns the group directly OR owns the club the group belongs to
        if user.role == 'MUNICIPALITY_ADMIN':
            return (group.municipality == user.assigned_municipality) or \
                   (group.club and group.club.municipality == user.assigned_municipality)
                
        # Club Admin: Owns the club the group belongs to
        if user.role == 'CLUB_ADMIN':
            return group.club == user.assigned_club

        return False
--- END OF FILE: ./backend/groups/permissions.py ---


--- START OF FILE: ./backend/groups/tests.py ---
from django.test import TestCase

# Create your tests here.

--- END OF FILE: ./backend/groups/tests.py ---


--- START OF FILE: ./backend/groups/views.py ---
from rest_framework import viewsets, status, permissions
from rest_framework.decorators import action
from rest_framework.response import Response
from django.db.models import Q, Count
from django.utils import timezone
from datetime import timedelta, date
import json
from .models import Group, GroupMembership
from .serializers import GroupSerializer, GroupMembershipSerializer
from .permissions import IsGroupAdminOrReadOnly, IsGroupMembershipAdmin
from users.models import User
from users.serializers import CustomUserSerializer

class GroupViewSet(viewsets.ModelViewSet):
    serializer_class = GroupSerializer
    permission_classes = [IsGroupAdminOrReadOnly]

    def get_queryset(self):
        """
        Filter groups based on who is asking.
        """
        user = self.request.user
        
        # 1. Super Admins see ALL groups
        if user.role == 'SUPER_ADMIN':
            return Group.objects.all().order_by('-created_at')

        # 2. Municipality Admins see groups in their scope
        if user.role == 'MUNICIPALITY_ADMIN' and user.assigned_municipality:
            return Group.objects.filter(
                Q(municipality=user.assigned_municipality) |
                Q(club__municipality=user.assigned_municipality)
            ).distinct().order_by('-created_at')

        # 3. Club Admins see groups in their club
        if user.role == 'CLUB_ADMIN' and user.assigned_club:
            return Group.objects.filter(club=user.assigned_club).order_by('-created_at')

        # 4. Regular Members (Youth/Guardian)
        return Group.objects.filter(
            Q(group_type='OPEN') | 
            Q(memberships__user=user)
        ).distinct()

    def perform_create(self, serializer):
        user = self.request.user
        if user.role == 'MUNICIPALITY_ADMIN':
            serializer.save(municipality=user.assigned_municipality)
        elif user.role == 'CLUB_ADMIN':
            serializer.save(club=user.assigned_club)
        else:
            serializer.save()

    # --- Actions for Members ---

    @action(detail=True, methods=['post'], permission_classes=[permissions.IsAuthenticated])
    def join(self, request, pk=None):
        group = self.get_object()
        user = request.user

        if GroupMembership.objects.filter(group=group, user=user).exists():
            return Response({"message": "Already a member or application pending."}, status=status.HTTP_400_BAD_REQUEST)

        if group.group_type == 'CLOSED':
            return Response({"message": "Cannot join a closed group."}, status=status.HTTP_403_FORBIDDEN)

        membership_status = 'APPROVED' if group.group_type == 'OPEN' else 'PENDING'
        
        GroupMembership.objects.create(
            group=group,
            user=user,
            status=membership_status,
            role='MEMBER'
        )
        
        msg = "Joined successfully" if membership_status == 'APPROVED' else "Application sent"
        return Response({"message": msg, "status": membership_status})

    @action(detail=True, methods=['post'], permission_classes=[permissions.IsAuthenticated])
    def leave(self, request, pk=None):
        group = self.get_object()
        user = request.user
        
        if group.is_system_group:
             return Response({"message": "Cannot leave a system-managed group manually."}, status=status.HTTP_403_FORBIDDEN)

        deleted_count, _ = GroupMembership.objects.filter(group=group, user=user).delete()
        
        if deleted_count > 0:
            return Response({"message": "Left group successfully."})
        return Response({"message": "You are not in this group."}, status=status.HTTP_400_BAD_REQUEST)

    # --- Actions for Admins ---

    @action(detail=True, methods=['post'], url_path='duplicate')
    def duplicate(self, request, pk=None):
        original = self.get_object()
        
        original.pk = None
        original.id = None
        original.name = f"{original.name} (Copy)"
        original.is_system_group = False 
        original.save()
        
        original.interests.set(self.get_object().interests.all())
        
        return Response(GroupSerializer(original).data)

    @action(detail=True, methods=['get'])
    def members(self, request, pk=None):
        """
        Get list of members. ADMIN ONLY.
        """
        if request.user.role not in ['SUPER_ADMIN', 'MUNICIPALITY_ADMIN', 'CLUB_ADMIN']:
            return Response({"detail": "Not authorized."}, status=status.HTTP_403_FORBIDDEN)

        group = self.get_object()
        status_param = request.query_params.get('status') # Optional: filter by PENDING/APPROVED
        
        queryset = group.memberships.select_related('user').order_by('-joined_at')
        
        if status_param:
            queryset = queryset.filter(status=status_param)
            
        page = self.paginate_queryset(queryset)
        if page is not None:
            serializer = GroupMembershipSerializer(page, many=True)
            return self.get_paginated_response(serializer.data)

        serializer = GroupMembershipSerializer(queryset, many=True)
        return Response(serializer.data)

    @action(detail=True, methods=['get'])
    def analytics(self, request, pk=None):
        """
        Get stats for the group. ADMIN ONLY.
        """
        if request.user.role not in ['SUPER_ADMIN', 'MUNICIPALITY_ADMIN', 'CLUB_ADMIN']:
            return Response({"detail": "Not authorized."}, status=status.HTTP_403_FORBIDDEN)

        group = self.get_object()
        memberships = group.memberships.filter(status='APPROVED')
        
        # 1. Total
        total = memberships.count()
        
        # 2. New this week
        week_ago = timezone.now() - timedelta(days=7)
        new_this_week = memberships.filter(joined_at__gte=week_ago).count()
        
        # 3. Gender Dist
        gender_dist = memberships.values('user__legal_gender').annotate(count=Count('id'))
        gender_data = {item['user__legal_gender']: item['count'] for item in gender_dist}
        
        # 4. Grade Dist (Youth only)
        grade_dist = memberships.exclude(user__grade__isnull=True).values('user__grade').annotate(count=Count('id'))
        grade_data = {item['user__grade']: item['count'] for item in grade_dist}
        
        return Response({
            "total_members": total,
            "new_this_week": new_this_week,
            "gender_distribution": gender_data,
            "grade_distribution": grade_data,
        })
    
    @action(detail=True, methods=['post'], url_path='approve_member')
    def approve_member(self, request, pk=None):
        """
        Approve a pending member. Payload: { "membership_id": 123 }
        """
        membership_id = request.data.get('membership_id')
        try:
            membership = GroupMembership.objects.get(id=membership_id, group_id=pk)
            membership.status = 'APPROVED'
            membership.save()
            return Response({"status": "approved"})
        except GroupMembership.DoesNotExist:
            return Response({"error": "Membership not found"}, status=404)

    @action(detail=True, methods=['post'], url_path='remove_member')
    def remove_member(self, request, pk=None):
        """
        Remove/Deny a member. Payload: { "membership_id": 123 }
        """
        membership_id = request.data.get('membership_id')
        try:
            GroupMembership.objects.get(id=membership_id, group_id=pk).delete()
            return Response({"status": "removed"})
        except GroupMembership.DoesNotExist:
            return Response({"error": "Membership not found"}, status=404)

    @action(detail=False, methods=['get'])
    def search_candidates(self, request):
        """
        Returns users who MATCH the provided criteria (age, grade, custom fields)
        AND fall within the Admin's scope.
        """
        user = request.user
        
        # 1. Base Scope: Filter by Admin Role
        queryset = User.objects.filter(is_active=True)
        
        if user.role == 'MUNICIPALITY_ADMIN' and user.assigned_municipality:
            queryset = queryset.filter(
                Q(preferred_club__municipality=user.assigned_municipality) |
                Q(assigned_municipality=user.assigned_municipality)
            )
        elif user.role == 'CLUB_ADMIN' and user.assigned_club:
            queryset = queryset.filter(preferred_club=user.assigned_club)
        
        # 2. Filter by Member Type
        member_type = request.query_params.get('target_member_type', 'YOUTH')
        if member_type == 'YOUTH':
            queryset = queryset.filter(role='YOUTH_MEMBER')
        elif member_type == 'GUARDIAN':
            queryset = queryset.filter(role='GUARDIAN')

        # 3. Filter by Grade
        grades_param = request.query_params.get('grades')
        if grades_param:
            try:
                grade_list = [int(g) for g in grades_param.split(',') if g.strip()]
                if grade_list:
                    queryset = queryset.filter(grade__in=grade_list)
            except ValueError:
                pass

        # 4. Filter by Gender
        genders_param = request.query_params.get('genders')
        if genders_param:
            gender_list = [g.strip() for g in genders_param.split(',') if g.strip()]
            if gender_list:
                queryset = queryset.filter(legal_gender__in=gender_list)

        # 5. Filter by Interests
        interests_param = request.query_params.get('interests')
        if interests_param:
            try:
                interest_ids = [int(i) for i in interests_param.split(',') if i.strip()]
                if interest_ids:
                    queryset = queryset.filter(interests__id__in=interest_ids).distinct()
            except ValueError:
                pass

        # 6. Filter by Age Range
        min_age = request.query_params.get('min_age')
        max_age = request.query_params.get('max_age')
        if min_age or max_age:
            today = date.today()
            if min_age:
                max_dob = today.replace(year=today.year - int(min_age))
                queryset = queryset.filter(date_of_birth__lte=max_dob)
            if max_age:
                min_dob = today.replace(year=today.year - int(max_age) - 1)
                queryset = queryset.filter(date_of_birth__gt=min_dob)

        # 7. Text Search
        search = request.query_params.get('search')
        if search:
            queryset = queryset.filter(
                Q(first_name__icontains=search) | 
                Q(last_name__icontains=search) | 
                Q(email__icontains=search)
            )

        # 8. Exclude existing
        group_id = request.query_params.get('exclude_group')
        if group_id:
            queryset = queryset.exclude(group_memberships__group_id=group_id)

        # 9. NEW: Filter by Custom Fields
        # Format: {"field_id": "value", "field_id": true}
        custom_rules_str = request.query_params.get('custom_field_rules')
        if custom_rules_str:
            try:
                custom_rules = json.loads(custom_rules_str)
                for field_id, value in custom_rules.items():
                    # We look for users who have a CustomFieldValue entry matching this field and value
                    # Note: 'value' is a JSONField in DB, so strict equality works for strings/bools
                    # For lists (Multi-Select), we might need logic changes, but let's assume single match for now.
                    if isinstance(value, bool):
                        # Handle booleans safely
                        queryset = queryset.filter(
                            custom_field_values__field_id=field_id,
                            custom_field_values__value=value
                        )
                    else:
                        # String matching
                        queryset = queryset.filter(
                            custom_field_values__field_id=field_id,
                            custom_field_values__value__icontains=str(value)
                        )
            except (ValueError, json.JSONDecodeError):
                pass

        # Paginate results
        page = self.paginate_queryset(queryset)
        if page is not None:
            serializer = CustomUserSerializer(page, many=True)
            return self.get_paginated_response(serializer.data)

        serializer = CustomUserSerializer(queryset, many=True)
        return Response(serializer.data)


class GroupMembershipViewSet(viewsets.ModelViewSet):
    """
    Dedicated endpoint for managing pending join requests across ALL groups.
    """
    serializer_class = GroupMembershipSerializer
    permission_classes = [IsGroupMembershipAdmin]

    def get_queryset(self):
        user = self.request.user
        
        # Base: Only return Pending requests
        queryset = GroupMembership.objects.filter(status='PENDING').select_related('group', 'user')

        # 1. Scope Filtering
        if user.role == 'SUPER_ADMIN':
            pass # See all
        elif user.role == 'MUNICIPALITY_ADMIN' and user.assigned_municipality:
            queryset = queryset.filter(
                Q(group__municipality=user.assigned_municipality) |
                Q(group__club__municipality=user.assigned_municipality)
            )
        elif user.role == 'CLUB_ADMIN' and user.assigned_club:
            queryset = queryset.filter(group__club=user.assigned_club)
        else:
            return GroupMembership.objects.none()

        # 2. Filter by Group Name (Frontend Search)
        group_name = self.request.query_params.get('group_name')
        if group_name:
            queryset = queryset.filter(group__name__icontains=group_name)

        return queryset.order_by('-joined_at')

    @action(detail=True, methods=['post'])
    def approve(self, request, pk=None):
        membership = self.get_object()
        membership.status = 'APPROVED'
        membership.save()
        return Response({'status': 'approved', 'message': 'Request approved successfully.'})

    @action(detail=True, methods=['post'])
    def reject(self, request, pk=None):
        membership = self.get_object()
        membership.delete() # Or set status='REJECTED'
        return Response({'status': 'rejected', 'message': 'Request rejected.'})
--- END OF FILE: ./backend/groups/views.py ---


--- START OF FILE: ./backend/groups/management/commands/init_system_groups.py ---
from django.core.management.base import BaseCommand
from groups.models import Group

class Command(BaseCommand):
    help = 'Creates default system groups'

    def handle(self, *args, **kwargs):
        system_groups = [
            {
                'name': 'All Registered Members', 
                'type': 'REGISTERED', 
                'desc': 'Automatically populated with all new users.'
            },
            {
                'name': 'Active Members', 
                'type': 'ACTIVE', 
                'desc': 'Users who have logged in at least once.'
            },
            {
                'name': 'Verified Members', 
                'type': 'VERIFIED', 
                'desc': 'Users who have completed identity verification.'
            },
        ]

        for data in system_groups:
            group, created = Group.objects.get_or_create(
                system_group_type=data['type'],
                defaults={
                    'name': data['name'],
                    'description': data['desc'],
                    'is_system_group': True,
                    'group_type': 'CLOSED', # Hidden/System controlled
                    'target_member_type': 'YOUTH' # Default, can be changed
                }
            )
            if created:
                self.stdout.write(self.style.SUCCESS(f"‚úÖ Created group: {data['name']}"))
            else:
                self.stdout.write(f"‚ÑπÔ∏è Group already exists: {data['name']}")
--- END OF FILE: ./backend/groups/management/commands/init_system_groups.py ---


--- START OF FILE: ./backend/news/models.py ---
from django.db import models
from django.conf import settings
from django.core.validators import FileExtensionValidator

# Reusing your existing validator for consistency
image_validator = FileExtensionValidator(allowed_extensions=['jpg', 'jpeg', 'png', 'webp'])

class NewsTag(models.Model):
    name = models.CharField(max_length=50, unique=True)
    slug = models.SlugField(unique=True, help_text="URL-friendly version of the name")

    def __str__(self):
        return self.name

class NewsArticle(models.Model):
    # Role choices for targeting (Reusing logic from User model for consistency)
    class TargetRole(models.TextChoices):
        SUPER_ADMIN = 'SUPER_ADMIN', 'Super Admin'
        MUNICIPALITY_ADMIN = 'MUNICIPALITY_ADMIN', 'Municipality Admin'
        CLUB_ADMIN = 'CLUB_ADMIN', 'Club Admin'
        YOUTH_MEMBER = 'YOUTH_MEMBER', 'Youth Member'
        GUARDIAN = 'GUARDIAN', 'Guardian'

    title = models.CharField(max_length=200)
    # Excerpt is the short summary shown on the card
    excerpt = models.TextField(max_length=300, help_text="Short summary for the card view")
    # Content will store the HTML from the WYSIWYG editor
    content = models.TextField()
    
    author = models.ForeignKey(
        settings.AUTH_USER_MODEL, 
        on_delete=models.SET_NULL, 
        null=True, 
        related_name='news_articles'
    )
    
    hero_image = models.FileField(
        upload_to='news/heroes/', 
        validators=[image_validator],
        null=True,
        blank=True
    )
    
    # Relationships
    tags = models.ManyToManyField(NewsTag, blank=True, related_name='articles')
    
    # Configuration
    # Using JSONField for target roles like we did in SystemMessages
    target_roles = models.JSONField(default=list, help_text='List of roles or ["ALL"]')
    is_published = models.BooleanField(default=False)
    published_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)
    
    # The Hero Logic
    is_hero = models.BooleanField(
        default=False, 
        help_text="If checked, this becomes the main featured news. Previous hero will be unset."
    )

    class Meta:
        ordering = ['-published_at']

    def __str__(self):
        return self.title

    def save(self, *args, **kwargs):
        """
        Custom save method to ensure only one article is marked as Hero at a time.
        """
        if self.is_hero:
            # Set all other articles' is_hero to False
            NewsArticle.objects.filter(is_hero=True).exclude(id=self.id).update(is_hero=False)
        
        super().save(*args, **kwargs)
--- END OF FILE: ./backend/news/models.py ---


--- START OF FILE: ./backend/news/serializers.py ---
import json
from rest_framework import serializers
from .models import NewsTag, NewsArticle

class NewsTagSerializer(serializers.ModelSerializer):
    class Meta:
        model = NewsTag
        fields = ['id', 'name', 'slug']

class NewsArticleSerializer(serializers.ModelSerializer):
    # Read-only field to display the author's name nicely
    author_name = serializers.SerializerMethodField()
    
    # Read-only field to display full tag objects (for the UI chips)
    tags_details = NewsTagSerializer(source='tags', many=True, read_only=True)
    
    # We accept a JSON string for target_roles because we are using FormData (for images)
    target_roles_data = serializers.CharField(write_only=True, required=False)

    class Meta:
        model = NewsArticle
        fields = [
            'id', 
            'title', 
            'excerpt', 
            'content', 
            'hero_image',
            'author', 
            'author_name', 
            'tags',          # Used for writing (sending IDs like [1, 2])
            'tags_details',  # Used for reading (getting objects like [{id:1, name:"Sports"}])
            'target_roles', 
            'target_roles_data',  # Used for writing (JSON string from FormData)
            'is_published', 
            'is_hero',
            'published_at', 
            'updated_at'
        ]
        # 'tags' is fine for input, but we primarily read 'tags_details'
        extra_kwargs = {
            'tags': {'required': False},
            'target_roles': {'read_only': True}  # Make target_roles read-only since we use target_roles_data for writing
        }

    def get_author_name(self, obj):
        if obj.author:
            return f"{obj.author.first_name} {obj.author.last_name}".strip() or obj.author.email
        return "Unknown"

    def create(self, validated_data):
        # Handle target_roles_data JSON string
        target_roles_json = validated_data.pop('target_roles_data', None)
        if target_roles_json:
            try:
                validated_data['target_roles'] = json.loads(target_roles_json)
            except json.JSONDecodeError:
                validated_data['target_roles'] = ['ALL']  # Default fallback
        elif 'target_roles' not in validated_data:
            validated_data['target_roles'] = ['ALL']  # Default if not provided
        
        # Automatically set the author to the current user if not provided
        request = self.context.get('request')
        if request and hasattr(request, 'user'):
            validated_data['author'] = request.user
        return super().create(validated_data)
    
    def update(self, instance, validated_data):
        # Handle target_roles_data JSON string
        target_roles_json = validated_data.pop('target_roles_data', None)
        if target_roles_json:
            try:
                validated_data['target_roles'] = json.loads(target_roles_json)
            except json.JSONDecodeError:
                pass  # Keep existing value if JSON is invalid
        
        return super().update(instance, validated_data)
--- END OF FILE: ./backend/news/serializers.py ---


--- START OF FILE: ./backend/news/apps.py ---
from django.apps import AppConfig


class NewsConfig(AppConfig):
    default_auto_field = 'django.db.models.BigAutoField'
    name = 'news'

--- END OF FILE: ./backend/news/apps.py ---


--- START OF FILE: ./backend/news/admin.py ---
from django.contrib import admin
from .models import NewsTag, NewsArticle

@admin.register(NewsTag)
class NewsTagAdmin(admin.ModelAdmin):
    list_display = ('name', 'slug')
    prepopulated_fields = {'slug': ('name',)}

@admin.register(NewsArticle)
class NewsArticleAdmin(admin.ModelAdmin):
    list_display = ('title', 'author', 'is_hero', 'is_published', 'published_at')
    list_filter = ('is_hero', 'is_published', 'tags')
    search_fields = ('title', 'excerpt')
    filter_horizontal = ('tags',)
--- END OF FILE: ./backend/news/admin.py ---


--- START OF FILE: ./backend/news/tests.py ---
from django.test import TestCase

# Create your tests here.

--- END OF FILE: ./backend/news/tests.py ---


--- START OF FILE: ./backend/news/views.py ---
from rest_framework import viewsets, filters, permissions
from rest_framework.decorators import action
from rest_framework.response import Response
from django.db.models import Q
from users.permissions import IsSuperAdmin
from .models import NewsTag, NewsArticle
from .serializers import NewsTagSerializer, NewsArticleSerializer

class NewsTagViewSet(viewsets.ModelViewSet):
    """
    Tags for categorizing news.
    """
    queryset = NewsTag.objects.all()
    serializer_class = NewsTagSerializer

    def get_permissions(self):
        # Anyone can read tags, only Super Admins can manage them
        if self.action in ['list', 'retrieve']:
            return [permissions.AllowAny()]
        return [IsSuperAdmin()]

class NewsArticleViewSet(viewsets.ModelViewSet):
    """
    Main News Logic.
    """
    queryset = NewsArticle.objects.all()
    serializer_class = NewsArticleSerializer
    
    # Filters for the Archive page
    filter_backends = [filters.SearchFilter, filters.OrderingFilter]
    search_fields = ['title', 'excerpt', 'author__first_name', 'author__last_name']
    ordering_fields = ['published_at', 'title']
    ordering = ['-published_at'] # Default to newest first

    def get_permissions(self):
        # Only Super Admins can Create/Update/Delete
        if self.action in ['create', 'update', 'partial_update', 'destroy']:
            return [IsSuperAdmin()]
        # Anyone (authenticated) can read
        return [permissions.IsAuthenticated()]

    def get_queryset(self):
        user = self.request.user
        queryset = NewsArticle.objects.all()

        # Check if we should only show published articles (for public feed views)
        published_only = self.request.query_params.get('published_only') == 'true'

        # 1. Super Admins see everything (Drafts, targeted to anyone) UNLESS published_only=true
        if getattr(user, 'role', None) == 'SUPER_ADMIN' and not published_only:
            pass # No filtering needed - super admin management view sees all articles
        else:
            # 2. Regular users OR super admins with published_only=true only see Published news
            queryset = queryset.filter(is_published=True)
            
            # 3. Filter by target_roles: users see news targeted to "ALL" or their specific role
            # This applies to both regular users AND super admins when viewing the feed (published_only=true)
            # Simple Logic: If JSON contains "ALL" or user.role
            # Note: This relies on JSON being stored as text in SQLite.
            role = getattr(user, 'role', None)
            if role:
                queryset = queryset.filter(
                    Q(target_roles__icontains="ALL") | 
                    Q(target_roles__icontains=role)
                )

        # 4. Filtering for the Dashboard (exclude_hero)
        # If frontend sends ?exclude_hero=true, we hide the hero article
        if self.request.query_params.get('exclude_hero') == 'true':
            queryset = queryset.filter(is_hero=False)
            
        # 5. Filtering by Tag (Archive page)
        tag_id = self.request.query_params.get('tag')
        if tag_id:
            queryset = queryset.filter(tags__id=tag_id)

        return queryset

    @action(detail=False, methods=['get'])
    def hero(self, request):
        """
        Specific endpoint to fetch ONLY the current Hero article.
        Usage: /api/news/hero/
        """
        # Re-use get_queryset to ensure role/published security applies to Hero too
        queryset = self.get_queryset()
        
        hero_article = queryset.filter(is_hero=True).first()
        
        if hero_article:
            serializer = self.get_serializer(hero_article)
            return Response(serializer.data)
        
        return Response(None) # No hero active
--- END OF FILE: ./backend/news/views.py ---


--- START OF FILE: ./backend/users/models.py ---
from django.contrib.auth.models import AbstractUser, BaseUserManager
from django.db import models
from django.utils.translation import gettext_lazy as _
from django.core.validators import FileExtensionValidator
from organization.models import Municipality, Club, Interest
from datetime import date

# Define allowed file types for user avatars
user_avatar_validator = FileExtensionValidator(allowed_extensions=['jpg', 'jpeg', 'png', 'svg', 'gif'])

class CustomUserManager(BaseUserManager):
    def create_user(self, email, password=None, **extra_fields):
        if not email:
            raise ValueError('The Email field must be set')
        email = self.normalize_email(email)
        user = self.model(email=email, **extra_fields)
        user.set_password(password)
        user.save(using=self._db)
        return user

    def create_superuser(self, email, password=None, **extra_fields):
        extra_fields.setdefault('is_staff', True)
        extra_fields.setdefault('is_superuser', True)
        extra_fields.setdefault('role', 'SUPER_ADMIN')
        return self.create_user(email, password, **extra_fields)

class User(AbstractUser):
    class Role(models.TextChoices):
        SUPER_ADMIN = 'SUPER_ADMIN', 'Super Admin'
        MUNICIPALITY_ADMIN = 'MUNICIPALITY_ADMIN', 'Municipality Admin'
        CLUB_ADMIN = 'CLUB_ADMIN', 'Club Admin'
        YOUTH_MEMBER = 'YOUTH_MEMBER', 'Youth Member'
        GUARDIAN = 'GUARDIAN', 'Guardian'
        
    class Gender(models.TextChoices):
        MALE = 'MALE', 'Male'
        FEMALE = 'FEMALE', 'Female'
        OTHER = 'OTHER', 'Other'

    # New Verification Status Enum
    class VerificationStatus(models.TextChoices):
        UNVERIFIED = 'UNVERIFIED', 'Unverified'
        PENDING = 'PENDING', 'Pending'
        VERIFIED = 'VERIFIED', 'Verified'

    username = None
    email = models.EmailField(_('email address'), unique=True)

    # --- Base Profile Fields ---
    role = models.CharField(max_length=50, choices=Role.choices, default=Role.YOUTH_MEMBER)
    phone_number = models.CharField(max_length=20, blank=True, null=True)
    preferred_language = models.CharField(max_length=10, default='sv')
    avatar = models.FileField(
        upload_to='users/avatars/',
        blank=True,
        null=True,
        validators=[user_avatar_validator]
    )
    notification_email_enabled = models.BooleanField(default=True)
    
    # --- Verification Field ---
    verification_status = models.CharField(
        max_length=20, 
        choices=VerificationStatus.choices, 
        default=VerificationStatus.UNVERIFIED,
        help_text="Status of identity verification"
    )
    
    # Shared Fields
    nickname = models.CharField(max_length=50, blank=True)
    legal_gender = models.CharField(max_length=10, choices=Gender.choices, blank=True)

    # Admin Assignments
    assigned_municipality = models.ForeignKey(
        Municipality, on_delete=models.SET_NULL, null=True, blank=True,
        related_name='admins'
    )
    assigned_club = models.ForeignKey(
        Club, on_delete=models.SET_NULL, null=True, blank=True,
        related_name='admins'
    )
    profession = models.CharField(max_length=100, blank=True)
    hide_contact_info = models.BooleanField(default=False)

    # Youth Fields
    grade = models.IntegerField(blank=True, null=True)
    interests = models.ManyToManyField(Interest, blank=True, related_name='users')
    preferred_club = models.ForeignKey(
        Club, on_delete=models.SET_NULL, null=True, blank=True,
        related_name='members'
    )
    preferred_gender = models.CharField(max_length=50, blank=True)
    date_of_birth = models.DateField(null=True, blank=True)

    objects = CustomUserManager()
    USERNAME_FIELD = 'email'
    REQUIRED_FIELDS = []

    def __str__(self):
        return f"{self.email} ({self.get_role_display()})"

    @property
    def age(self):
        if not self.date_of_birth:
            return None
        today = date.today()
        return today.year - self.date_of_birth.year - ((today.month, today.day) < (self.date_of_birth.month, self.date_of_birth.day))


class GuardianYouthLink(models.Model):
    """
    Links a Guardian to a Youth Member.
    """
    RELATIONSHIP_CHOICES = [
        ('MOTHER', 'Mother'),
        ('FATHER', 'Father'),
        ('GUARDIAN', 'Legal Guardian'),
        ('SIBLING', 'Sibling'),
        ('OTHER', 'Other'),
    ]
    
    STATUS_CHOICES = [
        ('PENDING', 'Pending Approval'),
        ('ACTIVE', 'Active'),
        ('REJECTED', 'Rejected'),
    ]

    guardian = models.ForeignKey(
        User, 
        on_delete=models.CASCADE, 
        related_name='youth_links',
        limit_choices_to={'role': User.Role.GUARDIAN}
    )
    
    youth = models.ForeignKey(
        User, 
        on_delete=models.CASCADE, 
        related_name='guardian_links',
        limit_choices_to={'role': User.Role.YOUTH_MEMBER}
    )
    
    relationship_type = models.CharField(max_length=20, choices=RELATIONSHIP_CHOICES)
    is_primary_guardian = models.BooleanField(default=False)
    status = models.CharField(max_length=20, choices=STATUS_CHOICES, default='PENDING')
    
    created_at = models.DateTimeField(auto_now_add=True)
    verified_at = models.DateTimeField(blank=True, null=True)

    class Meta:
        unique_together = ('guardian', 'youth')

    def __str__(self):
        return f"{self.guardian.first_name} -> {self.youth.first_name}"


class UserLoginHistory(models.Model):
    """
    Stores a simple audit trail of user logins.
    """
    user = models.ForeignKey(User, on_delete=models.CASCADE, related_name='login_history')
    timestamp = models.DateTimeField(auto_now_add=True)
    ip_address = models.GenericIPAddressField(null=True, blank=True)
    user_agent = models.CharField(max_length=512, blank=True)

    class Meta:
        ordering = ['-timestamp']

    def __str__(self):
        return f"{self.user.email} @ {self.timestamp}"


# --- PROXY MODELS ---

class YouthMember(User):
    class Meta:
        proxy = True
        verbose_name = "Youth Member"
        verbose_name_plural = "Youth Members"

class Guardian(User):
    class Meta:
        proxy = True
        verbose_name = "Guardian"
        verbose_name_plural = "Guardians"

class ClubAdmin(User):
    class Meta:
        proxy = True
        verbose_name = "Club Staff"
        verbose_name_plural = "Club Staff"

class MunicipalityAdmin(User):
    class Meta:
        proxy = True
        verbose_name = "Municipality Admin"
        verbose_name_plural = "Municipality Admins"
--- END OF FILE: ./backend/users/models.py ---


--- START OF FILE: ./backend/users/serializers.py ---
from rest_framework import serializers
from .models import User, GuardianYouthLink
from django.http import QueryDict

class CustomUserSerializer(serializers.ModelSerializer):
    """
    Standard serializer for reading user data.
    """
    guardians = serializers.SerializerMethodField()
    # Add youth_members for Guardians viewing their profile
    youth_members = serializers.SerializerMethodField()
    custom_field_values = serializers.SerializerMethodField()

    class Meta:
        model = User
        fields = [
            'id', 'email', 'first_name', 'last_name', 
            'role', 'phone_number', 'profession', 
            'assigned_municipality', 'assigned_club',
            'grade', 'preferred_club', 'nickname',
            'legal_gender', 'preferred_gender', 'date_of_birth',
            'avatar', 'preferred_language', 'is_active',
            'date_joined', 'last_login', 'hide_contact_info', 'interests',
            'verification_status', 'guardians', 'youth_members', 'custom_field_values'
        ]
        read_only_fields = ['id', 'date_joined', 'last_login']

    def get_guardians(self, obj):
        # If obj is a Youth, return their guardians
        return list(obj.guardian_links.values_list('guardian_id', flat=True))

    def get_youth_members(self, obj):
        # If obj is a Guardian, return their youth
        return list(obj.youth_links.values_list('youth_id', flat=True))

    def get_custom_field_values(self, obj):
        # Return custom field values as a list of {field: field_id, value: value}
        from custom_fields.models import CustomFieldValue
        values = CustomFieldValue.objects.filter(user=obj).select_related('field')
        return [
            {'field': cfv.field.id, 'value': cfv.value}
            for cfv in values
        ]


class UserManagementSerializer(serializers.ModelSerializer):
    """
    Used by Super Admins to create AND update users.
    """
    password = serializers.CharField(write_only=True, required=False)
    
    # For Youth: List of Guardian IDs
    guardians = serializers.ListField(child=serializers.IntegerField(), required=False, write_only=True)
    
    # For Guardians: List of Youth IDs (New)
    youth_members = serializers.ListField(child=serializers.IntegerField(), required=False, write_only=True)

    class Meta:
        model = User
        fields = [
            'id', 'email', 'password', 'first_name', 'last_name',
            'role', 'phone_number', 'profession',
            'assigned_municipality', 'assigned_club',
            'grade', 'preferred_club', 'interests',
            'nickname', 'legal_gender', 'preferred_gender',
            'date_of_birth', 'hide_contact_info', 'avatar',
            'verification_status', 'guardians', 'youth_members',
            'preferred_language'
        ]

    def _filter_youth_ids_by_scope(self, youth_ids):
        if not youth_ids:
            return youth_ids
        request = self.context.get('request')
        if not request:
            return youth_ids

        requester = request.user
        if getattr(requester, 'role', None) == 'MUNICIPALITY_ADMIN' and requester.assigned_municipality:
            allowed_ids = set(
                User.objects.filter(
                    role='YOUTH_MEMBER',
                    preferred_club__municipality=requester.assigned_municipality
                ).values_list('id', flat=True)
            )
            return [yid for yid in youth_ids if yid in allowed_ids]
        elif getattr(requester, 'role', None) == 'CLUB_ADMIN' and requester.assigned_club:
            allowed_ids = set(
                User.objects.filter(
                    role='YOUTH_MEMBER',
                    preferred_club=requester.assigned_club
                ).values_list('id', flat=True)
            )
            return [yid for yid in youth_ids if yid in allowed_ids]
        return youth_ids

    def create(self, validated_data):
        password = validated_data.pop('password')
        email = validated_data.pop('email')
        interests = validated_data.pop('interests', [])
        guardian_ids = validated_data.pop('guardians', [])
        youth_ids = validated_data.pop('youth_members', [])

        youth_ids = self._filter_youth_ids_by_scope(youth_ids)
        
        user = User.objects.create_user(email, password=password, **validated_data)
        
        if interests:
            user.interests.set(interests)
            
        # Case 1: Creating a Youth (Link to Guardians)
        if guardian_ids:
            for gid in guardian_ids:
                GuardianYouthLink.objects.create(
                    youth=user, guardian_id=gid, relationship_type='GUARDIAN', status='ACTIVE'
                )

        # Case 2: Creating a Guardian (Link to Youth)
        if youth_ids:
            for yid in youth_ids:
                GuardianYouthLink.objects.create(
                    guardian=user, youth_id=yid, relationship_type='GUARDIAN', status='ACTIVE'
                )
            
        return user

    def update(self, instance, validated_data):
        password = validated_data.pop('password', None)
        interests = validated_data.pop('interests', None)
        guardian_ids = validated_data.pop('guardians', None)
        youth_ids = validated_data.pop('youth_members', None)
        
        # --- Handle Data Extraction from FormData (QueryDict) ---
        if hasattr(self, 'initial_data'):
            request_data = self.initial_data
            if isinstance(request_data, QueryDict):
                # Handle Interests
                if interests is None:
                    raw = request_data.getlist('interests')
                    if raw: interests = [int(i) for i in raw if i.strip()]
                
                # Handle Guardians
                if guardian_ids is None:
                    raw = request_data.getlist('guardians')
                    if raw: guardian_ids = [int(i) for i in raw if i.strip()]

                # Handle Youth Members (New)
                if youth_ids is None:
                    raw = request_data.getlist('youth_members')
                    if raw: youth_ids = [int(i) for i in raw if i.strip()]

        youth_ids = self._filter_youth_ids_by_scope(youth_ids)

        if password:
            instance.set_password(password)
        
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        
        instance.save()
        
        if interests is not None:
            instance.interests.set(interests)
            
        # Sync Guardians (If User is Youth)
        if guardian_ids is not None:
            instance.guardian_links.all().delete()
            for gid in guardian_ids:
                GuardianYouthLink.objects.create(
                    youth=instance, guardian_id=gid, relationship_type='GUARDIAN', status='ACTIVE'
                )

        # Sync Youth (If User is Guardian)
        if youth_ids is not None:
            instance.youth_links.all().delete()
            for yid in youth_ids:
                GuardianYouthLink.objects.create(
                    guardian=instance, youth_id=yid, relationship_type='GUARDIAN', status='ACTIVE'
                )
            
        return instance

--- END OF FILE: ./backend/users/serializers.py ---


--- START OF FILE: ./backend/users/apps.py ---
from django.apps import AppConfig


class UsersConfig(AppConfig):
    default_auto_field = 'django.db.models.BigAutoField'
    name = 'users'

--- END OF FILE: ./backend/users/apps.py ---


--- START OF FILE: ./backend/users/admin.py ---
from django.contrib import admin
from django.contrib.auth.admin import UserAdmin
from django.utils.html import format_html
from datetime import date
from .models import (
    User,
    YouthMember,
    Guardian,
    ClubAdmin,
    MunicipalityAdmin,
    GuardianYouthLink,
    UserLoginHistory,
)
# Import the Reward models
from rewards.models import Reward, RewardUsage

# --- INLINES ---

class RewardUsageInline(admin.TabularInline):
    model = RewardUsage
    extra = 0
    # Show status and timestamps
    fields = ('reward', 'is_redeemed', 'created_at', 'redeemed_at')
    readonly_fields = ('reward', 'created_at', 'redeemed_at')
    can_delete = True # Allow admins to delete a grant if needed
    verbose_name = "Reward Status"
    verbose_name_plural = "Rewards Wallet"

class GuardianLinkInline(admin.TabularInline):
    model = GuardianYouthLink
    fk_name = 'guardian' 
    extra = 0
    verbose_name = "Linked Youth"
    verbose_name_plural = "Linked Youth Members"
    raw_id_fields = ['youth']

class YouthLinkInline(admin.TabularInline):
    model = GuardianYouthLink
    fk_name = 'youth'
    extra = 0
    verbose_name = "Linked Guardian"
    verbose_name_plural = "Linked Guardians"
    raw_id_fields = ['guardian']

# --- BASE ADMIN SETUP ---

class BaseRoleAdmin(UserAdmin):
    ordering = ['email']
    list_display = ('email', 'first_name', 'last_name', 'role')
    search_fields = ('email', 'first_name', 'last_name')
    
    fieldsets = (
        (None, {'fields': ('email', 'password')}),
        ('Personal info', {'fields': ('first_name', 'last_name')}),
        ('Permissions', {'fields': ('is_active', 'is_staff', 'is_superuser')}),
        ('Important dates', {'fields': ('last_login', 'date_joined')}),
        ('Rewards', {'fields': ('view_eligible_rewards',)}), # <--- Added this section
    )
    
    add_fieldsets = (
        (None, {
            'classes': ('wide',),
            'fields': ('email', 'first_name', 'last_name', 'role', 'password1', 'password2'),
        }),
    )
    
    # Add the inline table for history
    inlines = [GuardianLinkInline, RewardUsageInline] 
    
    # Allow us to display the calculated field
    readonly_fields = ('view_eligible_rewards',)

    def view_eligible_rewards(self, user):
        """
        Calculates which rewards this specific user matches based on rules.
        """
        # 1. Fetch all active rewards
        all_rewards = Reward.objects.filter(is_active=True)
        eligible_list = []

        # 2. Calculate User Age
        user_age = user.age if user.date_of_birth else None

        for r in all_rewards:
            # --- CHECK 1: SCOPE (Who owns the reward?) ---
            # If Super Admin: Everyone sees it
            # If Muni Admin: User must be in that Muni
            # If Club Admin: User must be in that Club
            if r.owner_role == 'MUNICIPALITY_ADMIN':
                if user.assigned_municipality != r.municipality and \
                   (not user.preferred_club or user.preferred_club.municipality != r.municipality):
                    continue
            
            if r.owner_role == 'CLUB_ADMIN':
                if user.preferred_club != r.club and user.assigned_club != r.club:
                    continue

            # --- CHECK 2: MEMBER TYPE ---
            if r.target_member_type != user.role:
                continue

            # --- CHECK 3: DEMOGRAPHICS ---
            # Gender
            if r.target_genders and user.legal_gender not in r.target_genders:
                continue
            
            # Grade
            if r.target_grades and user.grade not in r.target_grades:
                continue

            # Age
            if user_age is not None:
                if r.min_age and user_age < r.min_age: continue
                if r.max_age and user_age > r.max_age: continue

            # --- CHECK 4: USAGE LIMITS ---
            # Count how many times THIS user has claimed THIS reward
            claim_count = RewardUsage.objects.filter(user=user, reward=r).count()
            limit_str = f"{claim_count} / {r.usage_limit}" if r.usage_limit else f"{claim_count} / ‚àû"
            
            # Styling: Red if maxed out, Green if available
            color = "green"
            if r.usage_limit and claim_count >= r.usage_limit:
                color = "red"
                limit_str += " (Max Reached)"

            eligible_list.append(
                f"<li style='color:{color};'><b>{r.name}</b> ‚Äî Used: {limit_str}</li>"
            )

        if not eligible_list:
            return "No rewards currently available for this user."

        return format_html("<ul>" + "".join(eligible_list) + "</ul>")

    view_eligible_rewards.short_description = "Eligible / Active Rewards"

# --- SPECIFIC ADMINS ---

@admin.register(YouthMember)
class YouthMemberAdmin(BaseRoleAdmin):
    list_display = ('email', 'first_name', 'last_name', 'get_age_display', 'grade', 'preferred_club')
    search_fields = ('email', 'first_name', 'last_name', 'nickname')
    
    fieldsets = (
        ('Account', {'fields': ('email', 'password', 'role', 'is_active')}),
        ('Profile', {
            'fields': (
                'first_name', 'last_name', 'nickname', 
                'phone_number', 'avatar', 'preferred_language'
            )
        }),
        ('Demographics', {
            'fields': ('date_of_birth', 'get_age_display', 'legal_gender', 'preferred_gender')
        }),
        ('Youth Specifics', {'fields': ('grade', 'preferred_club', 'interests')}),
        ('Rewards', {'fields': ('view_eligible_rewards',)}),
    )
    
    readonly_fields = ('get_age_display', 'view_eligible_rewards',)
    # We merge the base inlines (RewardHistory) with the Youth link
    inlines = [YouthLinkInline, RewardUsageInline]

    def get_age_display(self, obj):
        return obj.age
    get_age_display.short_description = "Age"

    def get_queryset(self, request):
        return super().get_queryset(request).filter(role=User.Role.YOUTH_MEMBER)

    def save_model(self, request, obj, form, change):
        obj.role = User.Role.YOUTH_MEMBER
        super().save_model(request, obj, form, change)


@admin.register(Guardian)
class GuardianAdmin(BaseRoleAdmin):
    list_display = ('email', 'first_name', 'last_name', 'phone_number')
    search_fields = ('email', 'first_name', 'last_name', 'phone_number')
    
    fieldsets = (
        ('Account', {'fields': ('email', 'password', 'role', 'is_active')}),
        ('Profile', {
            'fields': (
                'first_name', 'last_name', 'phone_number', 
                'legal_gender', 'avatar'
            )
        }),
        ('Rewards', {'fields': ('view_eligible_rewards',)}),
    )
    
    readonly_fields = ('view_eligible_rewards',)
    inlines = [GuardianLinkInline, RewardUsageInline]

    def get_queryset(self, request):
        return super().get_queryset(request).filter(role=User.Role.GUARDIAN)

    def save_model(self, request, obj, form, change):
        obj.role = User.Role.GUARDIAN
        super().save_model(request, obj, form, change)


@admin.register(ClubAdmin)
class ClubAdminAdmin(BaseRoleAdmin):
    list_display = ('email', 'first_name', 'last_name', 'assigned_club')
    
    fieldsets = (
        ('Account', {'fields': ('email', 'password', 'role', 'is_active')}),
        ('Profile', {
            'fields': (
                'first_name', 'last_name', 'nickname', 
                'phone_number', 'legal_gender', 'avatar'
            )
        }),
        ('Professional Info', {
            'fields': ('profession', 'hide_contact_info', 'assigned_club')
        }),
    )

    def get_queryset(self, request):
        return super().get_queryset(request).filter(role=User.Role.CLUB_ADMIN)

    def save_model(self, request, obj, form, change):
        obj.role = User.Role.CLUB_ADMIN
        super().save_model(request, obj, form, change)


@admin.register(MunicipalityAdmin)
class MunicipalityAdminAdmin(BaseRoleAdmin):
    list_display = ('email', 'first_name', 'last_name', 'assigned_municipality')
    
    fieldsets = (
        ('Account', {'fields': ('email', 'password', 'role', 'is_active')}),
        ('Profile', {'fields': ('first_name', 'last_name', 'phone_number')}),
        ('Assignment', {'fields': ('assigned_municipality',)}),
    )

    def get_queryset(self, request):
        return super().get_queryset(request).filter(role=User.Role.MUNICIPALITY_ADMIN)

    def save_model(self, request, obj, form, change):
        obj.role = User.Role.MUNICIPALITY_ADMIN
        super().save_model(request, obj, form, change)

# Main User Admin (Super Admin View)
@admin.register(User)
class MainUserAdmin(UserAdmin):
    ordering = ['email']
    list_display = ('email', 'role', 'is_superuser')
    list_filter = ('role',)
    search_fields = ('email', 'first_name', 'last_name')
    
    fieldsets = (
        (None, {'fields': ('email', 'password')}),
        ('Personal info', {'fields': ('first_name', 'last_name', 'nickname', 'phone_number')}),
        ('Permissions', {'fields': ('role', 'is_superuser', 'is_staff', 'is_active')}),
    )
    
    add_fieldsets = (
        (None, {
            'classes': ('wide',),
            'fields': ('email', 'password1', 'password2', 'role'),
        }),
    )


@admin.register(UserLoginHistory)
class UserLoginHistoryAdmin(admin.ModelAdmin):
    list_display = ('user', 'timestamp', 'ip_address')
    list_filter = ('user',)
    search_fields = ('user__email', 'ip_address', 'user_agent')
--- END OF FILE: ./backend/users/admin.py ---


--- START OF FILE: ./backend/users/permissions.py ---
from rest_framework import permissions

class IsSuperAdmin(permissions.BasePermission):
    """
    Allows access only to Super Admins.
    """
    def has_permission(self, request, view):
        return bool(request.user and request.user.is_authenticated and request.user.role == 'SUPER_ADMIN')

class IsMunicipalityAdmin(permissions.BasePermission):
    """
    Allows access to Super Admins OR Municipality Admins.
    """
    def has_permission(self, request, view):
        if not request.user or not request.user.is_authenticated:
            return False
        return request.user.role in ['SUPER_ADMIN', 'MUNICIPALITY_ADMIN']


class IsClubOrMunicipalityAdmin(permissions.BasePermission):
    """
    Allows access to Super Admins, Municipality Admins, or Club Admins.
    """
    def has_permission(self, request, view):
        if not request.user or not request.user.is_authenticated:
            return False
        return request.user.role in ['SUPER_ADMIN', 'MUNICIPALITY_ADMIN', 'CLUB_ADMIN']
--- END OF FILE: ./backend/users/permissions.py ---


--- START OF FILE: ./backend/users/tests.py ---
from django.test import TestCase

# Create your tests here.

--- END OF FILE: ./backend/users/tests.py ---


--- START OF FILE: ./backend/users/views.py ---
from rest_framework import viewsets, filters, permissions
from rest_framework.decorators import action
from rest_framework.response import Response
from django.db.models import Count, Q
from django.utils import timezone
from datetime import timedelta, date

from .models import User, GuardianYouthLink, UserLoginHistory
from .serializers import CustomUserSerializer, UserManagementSerializer
from .permissions import IsSuperAdmin, IsMunicipalityAdmin, IsClubOrMunicipalityAdmin

class UserViewSet(viewsets.ModelViewSet):
    """
    API endpoint that allows Admins to CRUD users based on their scope.
    """
    permission_classes = [IsClubOrMunicipalityAdmin]
    lookup_field = 'id'

    def get_queryset(self):
        queryset = User.objects.all().order_by('-date_joined')
        user = self.request.user

        if getattr(user, 'role', None) == 'MUNICIPALITY_ADMIN' and user.assigned_municipality:
            queryset = queryset.filter(
                Q(assigned_municipality=user.assigned_municipality) |
                Q(assigned_club__municipality=user.assigned_municipality) |
                Q(preferred_club__municipality=user.assigned_municipality) |
                Q(guardian_links__youth__preferred_club__municipality=user.assigned_municipality) |
                Q(youth_links__youth__preferred_club__municipality=user.assigned_municipality)
            ).exclude(role='SUPER_ADMIN').distinct()
        elif getattr(user, 'role', None) == 'CLUB_ADMIN' and user.assigned_club:
            queryset = queryset.filter(
                Q(assigned_club=user.assigned_club) |
                Q(preferred_club=user.assigned_club) |
                Q(guardian_links__youth__preferred_club=user.assigned_club) |
                Q(youth_links__youth__preferred_club=user.assigned_club)
            ).exclude(role__in=['SUPER_ADMIN', 'MUNICIPALITY_ADMIN']).distinct()

        role = self.request.query_params.get('role')
        if role:
            queryset = queryset.filter(role=role)

        municipality = self.request.query_params.get('assigned_municipality')
        if municipality:
            queryset = queryset.filter(assigned_municipality=municipality)

        club = self.request.query_params.get('assigned_club')
        if club:
            queryset = queryset.filter(assigned_club=club)

        gender = self.request.query_params.get('legal_gender')
        if gender:
            queryset = queryset.filter(legal_gender=gender)

        search = self.request.query_params.get('search')
        if search:
            queryset = queryset.filter(
                Q(first_name__icontains=search) |
                Q(last_name__icontains=search) |
                Q(email__icontains=search)
            )

        grade_from = self.request.query_params.get('grade_from')
        if grade_from:
            try:
                queryset = queryset.filter(grade__gte=int(grade_from))
            except ValueError:
                pass

        grade_to = self.request.query_params.get('grade_to')
        if grade_to:
            try:
                queryset = queryset.filter(grade__lte=int(grade_to))
            except ValueError:
                pass

        age_from = self.request.query_params.get('age_from')
        if age_from:
            try:
                age_from_int = int(age_from)
                max_birth_date = date.today() - timedelta(days=365 * age_from_int)
                queryset = queryset.filter(date_of_birth__lte=max_birth_date)
            except (ValueError, TypeError):
                pass

        age_to = self.request.query_params.get('age_to')
        if age_to:
            try:
                age_to_int = int(age_to)
                min_birth_date = date.today() - timedelta(days=365 * (age_to_int + 1))
                queryset = queryset.filter(date_of_birth__gte=min_birth_date)
            except (ValueError, TypeError):
                pass

        verification_status = self.request.query_params.get('verification_status')
        if verification_status:
            queryset = queryset.filter(verification_status=verification_status)

        preferred_club = self.request.query_params.get('preferred_club')
        if preferred_club:
            queryset = queryset.filter(preferred_club=preferred_club)

        country = self.request.query_params.get('country')
        if country:
            queryset = queryset.filter(
                Q(preferred_club__municipality__country=country) |
                Q(assigned_municipality__country=country)
            )

        municipality_filter = self.request.query_params.get('municipality')
        if municipality_filter:
            queryset = queryset.filter(
                Q(preferred_club__municipality=municipality_filter) |
                Q(assigned_municipality=municipality_filter)
            )

        return queryset

    def get_serializer_class(self):
        if self.action in ['create', 'update', 'partial_update']:
            return UserManagementSerializer
        return CustomUserSerializer

    def perform_create(self, serializer):
        user = self.request.user

        if getattr(user, 'role', None) == 'MUNICIPALITY_ADMIN' and user.assigned_municipality:
            serializer.save(assigned_municipality=user.assigned_municipality)
        elif getattr(user, 'role', None) == 'CLUB_ADMIN' and user.assigned_club:
            role = serializer.validated_data.get('role', 'YOUTH_MEMBER')
            if role == 'YOUTH_MEMBER':
                serializer.save(preferred_club=user.assigned_club)
            elif role == 'GUARDIAN':
                # Guardians don't have assigned_club, they're linked via youth members
                serializer.save()
            else:
                # For other roles (like CLUB_ADMIN), assign to club
                serializer.save(
                    assigned_club=user.assigned_club,
                    assigned_municipality=user.assigned_municipality,
                    role='CLUB_ADMIN'
                )
        else:
            serializer.save()

    def perform_update(self, serializer):
        user = self.request.user
        if getattr(user, 'role', None) == 'CLUB_ADMIN' and user.assigned_club:
            role = serializer.instance.role
            if role == 'YOUTH_MEMBER':
                serializer.save(preferred_club=user.assigned_club)
            else:
                serializer.save(assigned_club=user.assigned_club)
        elif getattr(user, 'role', None) == 'MUNICIPALITY_ADMIN' and user.assigned_municipality:
            serializer.save(assigned_municipality=user.assigned_municipality)
        else:
            serializer.save()

    @action(detail=False, methods=['get'])
    def stats(self, request):
        """
        Returns analytics data for the Admin Dashboard.
        Only counts Admins (excludes Youth/Guardians).
        """
        # Base query: Only Admins
        admin_roles = ['SUPER_ADMIN', 'MUNICIPALITY_ADMIN', 'CLUB_ADMIN']
        admins = User.objects.filter(role__in=admin_roles)

        # 1. Total Count
        total = admins.count()

        # 2. Breakdown by Role
        role_counts = admins.values('role').annotate(count=Count('id'))
        # Convert to dictionary { 'SUPER_ADMIN': 5, ... }
        roles_data = {item['role']: item['count'] for item in role_counts}

        # 3. Breakdown by Gender
        gender_counts = admins.values('legal_gender').annotate(count=Count('id'))
        gender_data = {item['legal_gender']: item['count'] for item in gender_counts}

        # 4. Activity (Last 7 Days)
        seven_days_ago = timezone.now() - timedelta(days=7)
        active_recently = admins.filter(last_login__gte=seven_days_ago).count()

        # 5. New Admins (Last 30 Days)
        thirty_days_ago = timezone.now() - timedelta(days=30)
        new_recently = admins.filter(date_joined__gte=thirty_days_ago).count()

        return Response({
            "total_admins": total,
            "roles": {
                "super": roles_data.get('SUPER_ADMIN', 0),
                "municipality": roles_data.get('MUNICIPALITY_ADMIN', 0),
                "club": roles_data.get('CLUB_ADMIN', 0)
            },
            "gender": {
                "male": gender_data.get('MALE', 0),
                "female": gender_data.get('FEMALE', 0),
                "other": gender_data.get('OTHER', 0)
            },
            "activity": {
                "active_7_days": active_recently,
                "new_30_days": new_recently
            }
        })

    @action(detail=False, methods=['get'])
    def youth_stats(self, request):
        """
        Returns analytics data specifically for Youth Members.
        Scoped by Municipality if the user is a Municipality Admin.
        """
        user = request.user
        youth = User.objects.filter(role='YOUTH_MEMBER')

        if getattr(user, 'role', None) == 'MUNICIPALITY_ADMIN' and user.assigned_municipality:
            youth = youth.filter(preferred_club__municipality=user.assigned_municipality)
        elif getattr(user, 'role', None) == 'CLUB_ADMIN' and user.assigned_club:
            youth = youth.filter(preferred_club=user.assigned_club)

        total = youth.count()

        grade_counts = youth.values('grade').annotate(count=Count('id')).order_by('grade')
        grade_data = {str(item['grade']): item['count'] for item in grade_counts if item['grade'] is not None}

        gender_counts = youth.values('legal_gender').annotate(count=Count('id'))
        gender_data = {item['legal_gender']: item['count'] for item in gender_counts}

        seven_days_ago = timezone.now() - timedelta(days=7)
        active_recently = youth.filter(last_login__gte=seven_days_ago).count()

        return Response({
            "total_youth": total,
            "grades": grade_data,
            "gender": {
                "male": gender_data.get('MALE', 0),
                "female": gender_data.get('FEMALE', 0),
                "other": gender_data.get('OTHER', 0)
            },
            "activity": {
                "active_7_days": active_recently
            }
        })

    @action(detail=False, methods=['get'])
    def list_guardians(self, request):
        """
        Returns a list of guardians.
        Super Admin: All guardians.
        Muni Admin: Only guardians linked to youth within their municipality.
        """
        user = request.user
        guardians = User.objects.filter(role='GUARDIAN')
        if getattr(user, 'role', None) == 'MUNICIPALITY_ADMIN' and user.assigned_municipality:
            guardians = guardians.filter(
                youth_links__youth__preferred_club__municipality=user.assigned_municipality
            ).distinct()
        elif getattr(user, 'role', None) == 'CLUB_ADMIN' and user.assigned_club:
            guardians = guardians.filter(
                youth_links__youth__preferred_club=user.assigned_club
            ).distinct()

        values = guardians.values('id', 'first_name', 'last_name', 'email')
        return Response(list(values))

    @action(detail=False, methods=['get'])
    def guardian_stats(self, request):
        """
        Returns analytics data specifically for Guardians.
        Scoped by Municipality/Club if the user is an Admin.
        """
        user = request.user
        guardians = User.objects.filter(role='GUARDIAN')

        # Filter by scope
        if getattr(user, 'role', None) == 'MUNICIPALITY_ADMIN' and user.assigned_municipality:
            guardians = guardians.filter(
                youth_links__youth__preferred_club__municipality=user.assigned_municipality
            ).distinct()
        elif getattr(user, 'role', None) == 'CLUB_ADMIN' and user.assigned_club:
            guardians = guardians.filter(
                youth_links__youth__preferred_club=user.assigned_club
            ).distinct()

        # 1. Total Count
        total = guardians.count()

        # 2. Verification Status Breakdown
        status_counts = guardians.values('verification_status').annotate(count=Count('id'))
        status_data = {item['verification_status']: item['count'] for item in status_counts}

        # 3. Activity (Last 7 Days)
        seven_days_ago = timezone.now() - timedelta(days=7)
        active_recently = guardians.filter(last_login__gte=seven_days_ago).count()

        # 4. Connected Youth Count (scoped to this admin's youth)
        if getattr(user, 'role', None) == 'MUNICIPALITY_ADMIN' and user.assigned_municipality:
            youth_ids = User.objects.filter(
                role='YOUTH_MEMBER',
                preferred_club__municipality=user.assigned_municipality
            ).values_list('id', flat=True)
            total_connections = GuardianYouthLink.objects.filter(youth_id__in=youth_ids).count()
        elif getattr(user, 'role', None) == 'CLUB_ADMIN' and user.assigned_club:
            youth_ids = User.objects.filter(
                role='YOUTH_MEMBER',
                preferred_club=user.assigned_club
            ).values_list('id', flat=True)
            total_connections = GuardianYouthLink.objects.filter(youth_id__in=youth_ids).count()
        else:
            total_connections = GuardianYouthLink.objects.count()

        return Response({
            "total_guardians": total,
            "verification": {
                "verified": status_data.get('VERIFIED', 0),
                "pending": status_data.get('PENDING', 0),
                "unverified": status_data.get('UNVERIFIED', 0)
            },
            "activity": {
                "active_7_days": active_recently,
                "total_connections": total_connections
            }
        })

    @action(detail=False, methods=['get'])
    def list_youth(self, request):
        """
        Returns a simple list of all Youth Members.
        Used for dropdowns in Guardian management.
        """
        user = request.user
        youth = User.objects.filter(role='YOUTH_MEMBER')
        if getattr(user, 'role', None) == 'MUNICIPALITY_ADMIN' and user.assigned_municipality:
            youth = youth.filter(preferred_club__municipality=user.assigned_municipality)
        elif getattr(user, 'role', None) == 'CLUB_ADMIN' and user.assigned_club:
            youth = youth.filter(preferred_club=user.assigned_club)

        youth = youth.values('id', 'first_name', 'last_name', 'email', 'grade')
        return Response(list(youth))

    @action(detail=False, methods=['get'], permission_classes=[permissions.IsAuthenticated], url_path='login_history')
    def login_history(self, request):
        """
        Returns the latest 10 login events for the authenticated user.
        """
        history = UserLoginHistory.objects.filter(user=request.user).order_by('-timestamp')[:10]
        data = [
            {
                "id": log.id,
                "timestamp": log.timestamp,
                "ip_address": log.ip_address,
                "user_agent": log.user_agent,
            }
            for log in history
        ]
        return Response(data)

    @action(detail=False, methods=['post'], permission_classes=[permissions.IsAuthenticated], url_path='log_login')
    def log_login(self, request):
        """
        Stores a login entry for the authenticated user.
        Useful for keeping a lightweight audit trail when tokens are issued.
        """
        ip_address = request.META.get('HTTP_X_FORWARDED_FOR')
        if ip_address:
            ip_address = ip_address.split(',')[0].strip()
        else:
            ip_address = request.META.get('REMOTE_ADDR')

        user_agent = request.META.get('HTTP_USER_AGENT', '') or ''

        UserLoginHistory.objects.create(
            user=request.user,
            ip_address=ip_address,
            user_agent=user_agent[:512],
        )

        return Response({"status": "logged"})
--- END OF FILE: ./backend/users/views.py ---


--- START OF FILE: ./backend/users/management/commands/increment_grades.py ---
from django.core.management.base import BaseCommand
from django.db.models import F
from users.models import User
from django.utils import timezone

class Command(BaseCommand):
    help = 'Increments the grade of all youth members by 1. Should be run on July 1st.'

    def handle(self, *args, **options):
        # 1. Identify users who have a grade (Youth Members)
        youth_with_grades = User.objects.filter(role='YOUTH_MEMBER', grade__isnull=False)
        
        count = youth_with_grades.count()
        
        if count == 0:
            self.stdout.write(self.style.WARNING('No youth members with grades found.'))
            return

        self.stdout.write(f"Found {count} youth members. Incrementing grades...")

        # 2. Increment grade by 1 efficiently in the database
        # F('grade') + 1 tells the database to take the existing value and add 1
        youth_with_grades.update(grade=F('grade') + 1)

        self.stdout.write(self.style.SUCCESS(f'Successfully incremented grades for {count} users.'))
        self.stdout.write(f"Operation completed on {timezone.now().date()}")
--- END OF FILE: ./backend/users/management/commands/increment_grades.py ---


--- START OF FILE: ./backend/api/models.py ---
from django.db import models

# Create your models here.

--- END OF FILE: ./backend/api/models.py ---


--- START OF FILE: ./backend/api/apps.py ---
from django.apps import AppConfig


class ApiConfig(AppConfig):
    default_auto_field = 'django.db.models.BigAutoField'
    name = 'api'

--- END OF FILE: ./backend/api/apps.py ---


--- START OF FILE: ./backend/api/admin.py ---
from django.contrib import admin

# Register your models here.

--- END OF FILE: ./backend/api/admin.py ---


--- START OF FILE: ./backend/api/tests.py ---
from django.test import TestCase

# Create your tests here.

--- END OF FILE: ./backend/api/tests.py ---


--- START OF FILE: ./backend/api/urls.py ---
from django.urls import path, include
from rest_framework.routers import DefaultRouter
from .views import HealthCheckView
from users.views import UserViewSet
from system_messages.views import SystemMessageViewSet
from news.views import NewsArticleViewSet, NewsTagViewSet
from custom_fields.views import CustomFieldDefinitionViewSet
# Update Import
from groups.views import GroupViewSet, GroupMembershipViewSet
from rewards.views import RewardViewSet
# Add this line at the top with other imports
from posts.views import PostViewSet, PostCommentViewSet

router = DefaultRouter()
router.register(r'users', UserViewSet, basename='user')
router.register(r'messages', SystemMessageViewSet)
router.register(r'news', NewsArticleViewSet)
router.register(r'news_tags', NewsTagViewSet)
router.register(r'custom-fields', CustomFieldDefinitionViewSet, basename='custom-fields')
router.register(r'groups', GroupViewSet, basename='groups')
# NEW
router.register(r'group-requests', GroupMembershipViewSet, basename='group-requests')
router.register(r'rewards', RewardViewSet, basename='rewards')
# --- ADD THESE TWO LINES ---
router.register(r'posts', PostViewSet, basename='posts')
router.register(r'post-comments', PostCommentViewSet, basename='post-comments')

urlpatterns = [
    path('health/', HealthCheckView.as_view(), name='health_check'),
    path('auth/', include('djoser.urls')),
    path('auth/', include('djoser.urls.jwt')),
    path('', include(router.urls)), 
    path('', include('organization.urls')),
]
--- END OF FILE: ./backend/api/urls.py ---


--- START OF FILE: ./backend/api/views.py ---
from rest_framework.views import APIView
from rest_framework.response import Response

class HealthCheckView(APIView):
    """
    A simple endpoint to check if the backend is running 
    and accessible by the frontend.
    """
    def get(self, request):
        return Response({
            "status": "success",
            "message": "Hello from Django! The Youth App Backend is operational."
        })
--- END OF FILE: ./backend/api/views.py ---
