=== PROJECT CONTEXT GENERATED ===
=== IGNORED: node_modules, venv, migrations, media, images ===

=== DIRECTORY STRUCTURE ===
./
    project_context.txt
    frontend/
        postcss.config.mjs
        next-env.d.ts
        README.md
        package.json
        tsconfig.json
        eslint.config.mjs
        next.config.ts
        context/
            AuthContext.tsx
        app/
            utils.ts
            types.ts
            layout.tsx
            page.tsx
            globals.css
            admin/
                club/
                    page.tsx
                super/
                    layout.tsx
                    page.tsx
                    municipalities/
                        page.tsx
                        [id]/
                            page.tsx
                    clubs/
                        page.tsx
                        [id]/
                            page.tsx
                    admins/
                        page.tsx
                    youth/
                        page.tsx
                        [id]/
                            page.tsx
                    guardians/
                        page.tsx
                        [id]/
                            page.tsx
                    countries/
                        page.tsx
                    interests/
                        page.tsx
                municipality/
                    page.tsx
            dashboard/
                youth/
                    page.tsx
                guardian/
                    page.tsx
            login/
                page.tsx
        public/
        lib/
            api.ts
    backend/
        manage.py
        organization/
            models.py
            serializers.py
            __init__.py
            apps.py
            admin.py
            tests.py
            urls.py
            views.py
        core/
            asgi.py
            __init__.py
            settings.py
            urls.py
            wsgi.py
        users/
            models.py
            serializers.py
            __init__.py
            apps.py
            admin.py
            permissions.py
            tests.py
            views.py
            management/
                commands/
                    increment_grades.py
        api/
            models.py
            __init__.py
            apps.py
            admin.py
            tests.py
            urls.py
            views.py


=== FILE CONTENTS ===


--- START OF FILE: ./frontend/postcss.config.mjs ---
const config = {
  plugins: {
    "@tailwindcss/postcss": {},
  },
};

export default config;

--- END OF FILE: ./frontend/postcss.config.mjs ---


--- START OF FILE: ./frontend/next-env.d.ts ---
/// <reference types="next" />
/// <reference types="next/image-types/global" />
import "./.next/dev/types/routes.d.ts";

// NOTE: This file should not be edited
// see https://nextjs.org/docs/app/api-reference/config/typescript for more information.

--- END OF FILE: ./frontend/next-env.d.ts ---


--- START OF FILE: ./frontend/README.md ---
This is a [Next.js](https://nextjs.org) project bootstrapped with [`create-next-app`](https://nextjs.org/docs/app/api-reference/cli/create-next-app).

## Getting Started

First, run the development server:

```bash
npm run dev
# or
yarn dev
# or
pnpm dev
# or
bun dev
```

Open [http://localhost:3000](http://localhost:3000) with your browser to see the result.

You can start editing the page by modifying `app/page.tsx`. The page auto-updates as you edit the file.

This project uses [`next/font`](https://nextjs.org/docs/app/building-your-application/optimizing/fonts) to automatically optimize and load [Geist](https://vercel.com/font), a new font family for Vercel.

## Learn More

To learn more about Next.js, take a look at the following resources:

- [Next.js Documentation](https://nextjs.org/docs) - learn about Next.js features and API.
- [Learn Next.js](https://nextjs.org/learn) - an interactive Next.js tutorial.

You can check out [the Next.js GitHub repository](https://github.com/vercel/next.js) - your feedback and contributions are welcome!

## Deploy on Vercel

The easiest way to deploy your Next.js app is to use the [Vercel Platform](https://vercel.com/new?utm_medium=default-template&filter=next.js&utm_source=create-next-app&utm_campaign=create-next-app-readme) from the creators of Next.js.

Check out our [Next.js deployment documentation](https://nextjs.org/docs/app/building-your-application/deploying) for more details.

--- END OF FILE: ./frontend/README.md ---


--- START OF FILE: ./frontend/package.json ---
{
  "name": "frontend",
  "version": "0.1.0",
  "private": true,
  "scripts": {
    "dev": "next dev",
    "build": "next build",
    "start": "next start",
    "lint": "eslint"
  },
  "dependencies": {
    "@react-google-maps/api": "^2.20.7",
    "axios": "^1.13.2",
    "js-cookie": "^3.0.5",
    "next": "16.0.3",
    "react": "19.2.0",
    "react-dom": "19.2.0"
  },
  "devDependencies": {
    "@tailwindcss/postcss": "^4",
    "@types/js-cookie": "^3.0.6",
    "@types/node": "^20",
    "@types/react": "^19",
    "@types/react-dom": "^19",
    "eslint": "^9",
    "eslint-config-next": "16.0.3",
    "tailwindcss": "^4",
    "typescript": "^5"
  }
}

--- END OF FILE: ./frontend/package.json ---


--- START OF FILE: ./frontend/tsconfig.json ---
{
  "compilerOptions": {
    "target": "ES2017",
    "lib": ["dom", "dom.iterable", "esnext"],
    "allowJs": true,
    "skipLibCheck": true,
    "strict": true,
    "noEmit": true,
    "esModuleInterop": true,
    "module": "esnext",
    "moduleResolution": "bundler",
    "resolveJsonModule": true,
    "isolatedModules": true,
    "jsx": "react-jsx",
    "incremental": true,
    "plugins": [
      {
        "name": "next"
      }
    ],
    "paths": {
      "@/*": ["./*"]
    }
  },
  "include": [
    "next-env.d.ts",
    "**/*.ts",
    "**/*.tsx",
    ".next/types/**/*.ts",
    ".next/dev/types/**/*.ts",
    "**/*.mts"
  ],
  "exclude": ["node_modules"]
}

--- END OF FILE: ./frontend/tsconfig.json ---


--- START OF FILE: ./frontend/eslint.config.mjs ---
import { defineConfig, globalIgnores } from "eslint/config";
import nextVitals from "eslint-config-next/core-web-vitals";
import nextTs from "eslint-config-next/typescript";

const eslintConfig = defineConfig([
  ...nextVitals,
  ...nextTs,
  // Override default ignores of eslint-config-next.
  globalIgnores([
    // Default ignores of eslint-config-next:
    ".next/**",
    "out/**",
    "build/**",
    "next-env.d.ts",
  ]),
]);

export default eslintConfig;

--- END OF FILE: ./frontend/eslint.config.mjs ---


--- START OF FILE: ./frontend/next.config.ts ---
import type { NextConfig } from "next";

const nextConfig: NextConfig = {
  /* config options here */
};

export default nextConfig;

--- END OF FILE: ./frontend/next.config.ts ---


--- START OF FILE: ./frontend/context/AuthContext.tsx ---
'use client';

import { createContext, useContext, useState, useEffect, ReactNode } from 'react';
import Cookies from 'js-cookie';
import api from '../lib/api';
import { useRouter } from 'next/navigation';

interface User {
  id: number;
  email: string;
  first_name: string;
  last_name: string;
  role: string;
  avatar: string | null;
}

interface AuthContextType {
  user: User | null;
  login: (email: string, password: string) => Promise<void>;
  logout: () => void;
  loading: boolean;
}

const AuthContext = createContext<AuthContextType | undefined>(undefined);

export function AuthProvider({ children }: { children: ReactNode }) {
  const [user, setUser] = useState<User | null>(null);
  const [loading, setLoading] = useState(true);
  const router = useRouter();

  // Check if user is already logged in when page loads
  useEffect(() => {
    const checkUser = async () => {
      const token = Cookies.get('access_token');
      if (token) {
        try {
          const res = await api.get('/auth/users/me/');
          setUser(res.data);
        } catch (error) {
          console.error("Session expired", error);
          Cookies.remove('access_token');
        }
      }
      setLoading(false);
    };
    checkUser();
  }, []);

  const login = async (email: string, password: string) => {
    try {
      // 1. Get Token
      const res = await api.post('/auth/jwt/create/', { email, password });
      Cookies.set('access_token', res.data.access, { expires: 1 }); // Expires in 1 day
      Cookies.set('refresh_token', res.data.refresh, { expires: 1 });

      // 2. Get User Details
      const userRes = await api.get('/auth/users/me/');
      const userData = userRes.data;
      setUser(userData);

      // 3. Redirect based on Role
      switch (userData.role) {
        case 'SUPER_ADMIN':
          router.push('/admin/super');
          break;
        case 'MUNICIPALITY_ADMIN':
          router.push('/admin/municipality');
          break;
        case 'CLUB_ADMIN':
          router.push('/admin/club');
          break;
        case 'GUARDIAN':
          router.push('/dashboard/guardian');
          break;
        case 'YOUTH_MEMBER':
          router.push('/dashboard/youth');
          break;
        default:
          router.push('/');
      }
    } catch (error) {
      console.error("Login failed", error);
      throw error;
    }
  };

  const logout = () => {
    Cookies.remove('access_token');
    Cookies.remove('refresh_token');
    setUser(null);
    router.push('/login');
  };

  return (
    <AuthContext.Provider value={{ user, login, logout, loading }}>
      {children}
    </AuthContext.Provider>
  );
}

export const useAuth = () => {
  const context = useContext(AuthContext);
  if (!context) throw new Error('useAuth must be used within an AuthProvider');
  return context;
};
--- END OF FILE: ./frontend/context/AuthContext.tsx ---


--- START OF FILE: ./frontend/app/utils.ts ---
export const getMediaUrl = (path: string | null | undefined) => {
    if (!path) return null;
    
    // If it's already a full URL (starts with http), return it as is
    if (path.startsWith('http')) {
      return path;
    }
  
    // Ensure path starts with / for proper URL construction
    const normalizedPath = path.startsWith('/') ? path : `/${path}`;
    
    // Otherwise, prepend the Django Backend URL
    // We use localhost:8000 because that's where Django is running
    return `http://localhost:8000${normalizedPath}`;
  };
--- END OF FILE: ./frontend/app/utils.ts ---


--- START OF FILE: ./frontend/app/types.ts ---
export interface OpeningHour {
    id: number;
    weekday: number;
    weekday_display: string;
    week_cycle: string;
    open_time: string;
    close_time: string;
    title: string;
  }
  
  export interface Club {
    id: number;
    name: string;
    municipality: number;
    municipality_name: string;
    description: string;
    email: string;
    phone: string;
    avatar: string | null;
    hero_image: string | null;
    address: string;
    allowed_age_groups: string;
    club_categories: string;
    regular_hours: OpeningHour[];
  }
--- END OF FILE: ./frontend/app/types.ts ---


--- START OF FILE: ./frontend/app/layout.tsx ---
import type { Metadata } from "next";
import { Inter } from "next/font/google";
import "./globals.css";
import { AuthProvider } from "../context/AuthContext";

const inter = Inter({ subsets: ["latin"] });

export const metadata: Metadata = {
  title: "The Youth App",
  description: "Ungdomsappen 2.0",
};

export default function RootLayout({
  children,
}: Readonly<{
  children: React.ReactNode;
}>) {
  return (
    <html lang="en">
      <body className={inter.className}>
        <AuthProvider>
          {children}
        </AuthProvider>
      </body>
    </html>
  );
}
--- END OF FILE: ./frontend/app/layout.tsx ---


--- START OF FILE: ./frontend/app/page.tsx ---
'use client';

import { useState, useEffect } from 'react';
import Link from 'next/link'; // We need this for navigation
import { Club } from './types';
import { getMediaUrl } from './utils';
import { useAuth } from '../context/AuthContext'; // Import Auth

export default function Home() {
  const [clubs, setClubs] = useState<Club[]>([]);
  const [loadingClubs, setLoadingClubs] = useState(true);
  
  // Get user info from our Auth Context
  const { user, logout, loading: authLoading } = useAuth();

  useEffect(() => {
    fetch('http://localhost:8000/api/clubs/')
      .then((res) => res.json())
      .then((data) => {
        setClubs(data);
        setLoadingClubs(false);
      })
      .catch((err) => {
        console.error('Error fetching clubs:', err);
        setLoadingClubs(false);
      });
  }, []);

  return (
    <main className="min-h-screen bg-gray-50 text-gray-900 font-sans">
      {/* HEADER */}
      <header className="bg-blue-600 text-white p-6 shadow-md">
        <div className="max-w-7xl mx-auto flex justify-between items-center">
          <h1 className="text-3xl font-bold tracking-tight">Ungdomsappen</h1>
          
          <div className="flex items-center gap-4">
            {!authLoading && (
              <>
                {user ? (
                  // LOGGED IN STATE
                  <div className="flex items-center gap-4">
                    <span className="hidden md:block font-medium">Hi, {user.first_name}</span>
                    
                    {/* Link back to their specific dashboard based on role */}
                    <Link 
                      href={
                        user.role === 'SUPER_ADMIN' ? '/admin/super' :
                        user.role === 'MUNICIPALITY_ADMIN' ? '/admin/municipality' :
                        user.role === 'CLUB_ADMIN' ? '/admin/club' :
                        user.role === 'GUARDIAN' ? '/dashboard/guardian' :
                        '/dashboard/youth'
                      }
                      className="bg-white text-blue-600 px-4 py-2 rounded-lg font-bold text-sm hover:bg-gray-100 transition"
                    >
                      My Dashboard
                    </Link>

                    <button 
                      onClick={logout}
                      className="bg-blue-800 px-4 py-2 rounded-lg text-sm hover:bg-blue-700 transition"
                    >
                      Logout
                    </button>
                  </div>
                ) : (
                  // LOGGED OUT STATE
                  <Link 
                    href="/login"
                    className="bg-blue-800 px-4 py-2 rounded-lg hover:bg-blue-700 transition"
                  >
                    Login
                  </Link>
                )}
              </>
            )}
          </div>
        </div>
      </header>

      {/* MAIN CONTENT */}
      <div className="max-w-7xl mx-auto p-6 mt-8">
        <h2 className="text-2xl font-bold mb-6 text-gray-800">Explore Clubs</h2>
        
        {loadingClubs ? (
          <p>Loading clubs...</p>
        ) : (
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
            {clubs.map((club) => {
              const heroUrl = getMediaUrl(club.hero_image);
              const avatarUrl = getMediaUrl(club.avatar);

              return (
                <div key={club.id} className="bg-white rounded-xl shadow-lg overflow-hidden border border-gray-100 flex flex-col h-full hover:shadow-xl transition">
                  {/* HERO IMAGE */}
                  <div className="h-48 bg-gray-200 w-full relative">
                    {heroUrl ? (
                      <img 
                        src={heroUrl} 
                        alt={club.name} 
                        className="w-full h-full object-cover"
                        onError={(e) => {
                          (e.target as HTMLImageElement).src = 'https://via.placeholder.com/400x200?text=No+Image';
                        }}
                      />
                    ) : (
                      <div className="flex items-center justify-center h-full text-gray-400">
                        No Image
                      </div>
                    )}
                    
                    <div className="absolute -bottom-6 left-6">
                      {avatarUrl && (
                        <img 
                          src={avatarUrl} 
                          alt="Avatar" 
                          className="w-16 h-16 rounded-full border-4 border-white shadow-md bg-white object-cover" 
                        />
                      )}
                    </div>
                  </div>

                  <div className="p-6 pt-8 flex-grow">
                    <h3 className="text-xl font-bold text-gray-900">{club.name}</h3>
                    <p className="text-sm text-blue-600 font-medium mb-2">{club.municipality_name}</p>
                    <p className="text-gray-600 text-sm mb-4 line-clamp-3">
                      {club.description}
                    </p>
                    <div className="text-xs text-gray-500 space-y-1">
                      <p>üìç {club.address || 'No address set'}</p>
                      <p>üìß {club.email}</p>
                    </div>
                  </div>
                  
                  <div className="bg-gray-50 p-4 border-t border-gray-100">
                    <button className="w-full py-2 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700 transition">
                      Visit Club
                    </button>
                  </div>
                </div>
              );
            })}
          </div>
        )}
      </div>
    </main>
  );
}
--- END OF FILE: ./frontend/app/page.tsx ---


--- START OF FILE: ./frontend/app/globals.css ---
@import "tailwindcss";

:root {
  --background: #ffffff;
  --foreground: #171717;
}

@theme inline {
  --color-background: var(--background);
  --color-foreground: var(--foreground);
  --font-sans: var(--font-geist-sans);
  --font-mono: var(--font-geist-mono);
}

@media (prefers-color-scheme: dark) {
  :root {
    --background: #0a0a0a;
    --foreground: #ededed;
  }
}

body {
  background: var(--background);
  color: var(--foreground);
  font-family: Arial, Helvetica, sans-serif;
}

--- END OF FILE: ./frontend/app/globals.css ---


--- START OF FILE: ./frontend/app/admin/club/page.tsx ---
'use client';

import { useAuth } from '../../../context/AuthContext';

export default function ClubAdminDashboard() {
  const { user, logout } = useAuth();

  return (
    <div className="min-h-screen bg-gray-100 p-10">
      <div className="flex justify-between items-center mb-8">
        <h1 className="text-3xl font-bold text-green-600">Club Admin</h1>
        <div className="flex gap-4 items-center">
          <span className="text-gray-600">Welcome, {user?.first_name}</span>
          <button onClick={logout} className="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">
            Logout
          </button>
        </div>
      </div>
      <div className="bg-white p-6 rounded-lg shadow">
        <p>Manage your daily club operations, events, and members here.</p>
      </div>
    </div>
  );
}
--- END OF FILE: ./frontend/app/admin/club/page.tsx ---


--- START OF FILE: ./frontend/app/admin/super/layout.tsx ---
'use client';

import Link from 'next/link';
import { usePathname } from 'next/navigation';
import { useAuth } from '../../../context/AuthContext';

export default function SuperAdminLayout({ children }: { children: React.ReactNode }) {
  const pathname = usePathname();
  const { logout } = useAuth();

  const navigation = [
    { name: 'Overview', href: '/admin/super' },
    { name: 'Manage Admins', href: '/admin/super/admins' },
    { name: 'Manage Youth', href: '/admin/super/youth' },
    { name: 'Manage Guardians', href: '/admin/super/guardians' },
    { name: 'Manage Interests', href: '/admin/super/interests' },
    { name: 'Manage Countries', href: '/admin/super/countries' },
    { name: 'Manage Municipalities', href: '/admin/super/municipalities' },
    { name: 'Manage Clubs', href: '/admin/super/clubs' },
  ];

  return (
    <div className="min-h-screen bg-gray-100 flex">
      {/* SIDEBAR */}
      <aside className="w-64 bg-slate-900 text-white flex flex-col">
        <div className="p-6 border-b border-slate-800">
          <h2 className="text-xl font-bold text-blue-400">Super Admin</h2>
          <p className="text-xs text-slate-400 mt-1">Ungdomsappen 2.0</p>
        </div>
        
        <nav className="flex-1 p-4 space-y-2">
          {navigation.map((item) => {
            const isActive = pathname === item.href;
            return (
              <Link
                key={item.name}
                href={item.href}
                className={`block px-4 py-3 rounded-lg text-sm font-medium transition-colors ${
                  isActive 
                    ? 'bg-blue-600 text-white shadow-md' 
                    : 'text-slate-300 hover:bg-slate-800 hover:text-white'
                }`}
              >
                {item.name}
              </Link>
            );
          })}
        </nav>

        <div className="p-4 border-t border-slate-800">
          <button 
            onClick={logout}
            className="w-full py-2 px-4 bg-red-600 hover:bg-red-700 rounded text-sm font-bold transition"
          >
            Sign Out
          </button>
        </div>
      </aside>

      {/* MAIN CONTENT AREA */}
      <main className="flex-1 p-8 overflow-y-auto">
        {children}
      </main>
    </div>
  );
}
--- END OF FILE: ./frontend/app/admin/super/layout.tsx ---


--- START OF FILE: ./frontend/app/admin/super/page.tsx ---
export default function SuperAdminDashboard() {
    return (
      <div className="p-10">
        <h1 className="text-3xl font-bold text-red-600">Super Admin Dashboard</h1>
        <p>Only visible to Super Admins.</p>
      </div>
    );
  }
--- END OF FILE: ./frontend/app/admin/super/page.tsx ---


--- START OF FILE: ./frontend/app/admin/super/municipalities/page.tsx ---
'use client';

import { useState, useEffect, Suspense } from 'react';
import { useRouter, useSearchParams, usePathname } from 'next/navigation';
import Link from 'next/link';
import api from '../../../../lib/api';
import { getMediaUrl } from '../../../utils';

interface CountryOption { id: number; name: string; }

function ManageMunicipalitiesPageContent() {
  const router = useRouter();
  const pathname = usePathname();
  const searchParams = useSearchParams();

  // --- STATE ---
  const [municipalities, setMunicipalities] = useState<any[]>([]);
  const [countries, setCountries] = useState<CountryOption[]>([]);
  const [isLoading, setIsLoading] = useState(true);

  // Modal
  const [showModal, setShowModal] = useState(false);
  const [isEditing, setIsEditing] = useState(false);
  const [editId, setEditId] = useState<number | null>(null);
  
  // Files
  const [avatarFile, setAvatarFile] = useState<File | null>(null);
  const [avatarPreview, setAvatarPreview] = useState<string | null>(null);
  const [heroFile, setHeroFile] = useState<File | null>(null);
  const [heroPreview, setHeroPreview] = useState<string | null>(null);

  const initialFormState = {
    country: '',
    name: '',
    municipality_code: '',
    description: '',
    terms_and_conditions: '',
    email: '',
    phone: '',
    website_link: '',
    allow_self_registration: true,
    // Social Media inputs (we will pack these into JSON later)
    facebook: '',
    instagram: ''
  };

  const [formData, setFormData] = useState(initialFormState);

  // --- LOAD DATA ---
  useEffect(() => {
    fetchData();
  }, []);

  const fetchData = async () => {
    setIsLoading(true);
    try {
      // Fetch Municipalities
      const muniRes = await api.get('/municipalities/');
      const muniData = Array.isArray(muniRes.data) ? muniRes.data : (muniRes.data.results || []);
      setMunicipalities(muniData);

      // Fetch Countries (for dropdown)
      const countryRes = await api.get('/countries/');
      const countryData = Array.isArray(countryRes.data) ? countryRes.data : (countryRes.data.results || []);
      setCountries(countryData);
    } catch (err) {
      console.error(err);
    } finally {
      setIsLoading(false);
    }
  };

  // --- ACTIONS ---
  const handleOpenCreate = () => {
    setIsEditing(false);
    setEditId(null);
    setFormData(initialFormState);
    setAvatarFile(null); setAvatarPreview(null);
    setHeroFile(null); setHeroPreview(null);
    setShowModal(true);
  };

  const handleOpenEdit = (item: any) => {
    setIsEditing(true);
    setEditId(item.id);
    
    // Parse social media JSON safely
    let social = { facebook: '', instagram: '' };
    try {
      if (item.social_media) {
        if (typeof item.social_media === 'string') {
          social = { ...social, ...JSON.parse(item.social_media) };
        } else if (typeof item.social_media === 'object') {
          social = { ...social, ...item.social_media };
        }
      }
    } catch (e) {}

    setFormData({
      country: String(item.country?.id ?? item.country ?? ''),
      name: item.name,
      municipality_code: item.municipality_code || '',
      description: item.description || '',
      terms_and_conditions: item.terms_and_conditions || '',
      email: item.email || '',
      phone: item.phone || '',
      website_link: item.website_link || '',
      allow_self_registration: item.allow_self_registration ?? true,
      facebook: social.facebook || '',
      instagram: social.instagram || ''
    });

    setAvatarFile(null);
    setAvatarPreview(item.avatar ? getMediaUrl(item.avatar) : null);
    
    setHeroFile(null);
    setHeroPreview(item.hero_image ? getMediaUrl(item.hero_image) : null);
    
    setShowModal(true);
  };

  const handleDelete = async (id: number) => {
    if (!window.confirm("Are you sure? This will delete all clubs linked to this municipality.")) return;
    try {
      await api.delete(`/municipalities/${id}/`);
      fetchData();
    } catch (err) {
      alert("Failed to delete.");
    }
  };

  const handleFileChange = (e: React.ChangeEvent<HTMLInputElement>, type: 'avatar' | 'hero') => {
    const file = e.target.files?.[0];
    if (file) {
      const reader = new FileReader();
      reader.onloadend = () => {
        if (type === 'avatar') {
          setAvatarFile(file);
          setAvatarPreview(reader.result as string);
        } else {
          setHeroFile(file);
          setHeroPreview(reader.result as string);
        }
      };
      reader.readAsDataURL(file);
    }
  };

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    try {
      const data = new FormData();
      
      // Pack social media into JSON string
      const socialMediaJson = JSON.stringify({
        facebook: formData.facebook,
        instagram: formData.instagram
      });

      data.append('country', formData.country);
      data.append('name', formData.name);
      data.append('municipality_code', formData.municipality_code);
      data.append('description', formData.description);
      data.append('terms_and_conditions', formData.terms_and_conditions);
      data.append('email', formData.email);
      data.append('phone', formData.phone);
      data.append('website_link', formData.website_link);
      data.append('allow_self_registration', formData.allow_self_registration.toString());
      data.append('social_media', socialMediaJson);
      
      if (avatarFile) data.append('avatar', avatarFile);
      if (heroFile) data.append('hero_image', heroFile);

      const config = { headers: { 'Content-Type': 'multipart/form-data' } };
      
      if (isEditing && editId) {
        await api.patch(`/municipalities/${editId}/`, data, config);
      } else {
        await api.post('/municipalities/', data, config);
      }

      setShowModal(false);
      fetchData();
    } catch (err) {
      alert('Operation failed. Check console for details.');
      console.error(err);
    }
  };

  return (
    <div>
      <div className="flex justify-between items-center mb-6">
        <h1 className="text-2xl font-bold text-gray-800">Manage Municipalities</h1>
        <button onClick={handleOpenCreate} className="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 shadow">
          + Add Municipality
        </button>
      </div>

      {/* --- LIST --- */}
      <div className="bg-white rounded-lg shadow overflow-hidden mb-6">
        {isLoading ? (
          <div className="p-8 text-center text-gray-500">Loading...</div>
        ) : municipalities.length === 0 ? (
          <div className="p-8 text-center text-gray-500">No municipalities found.</div>
        ) : (
          <table className="min-w-full divide-y divide-gray-200">
            <thead className="bg-gray-50">
              <tr>
                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Municipality</th>
                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Country</th>
                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Code</th>
                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Registration</th>
                <th className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">Actions</th>
              </tr>
            </thead>
            <tbody className="bg-white divide-y divide-gray-200">
              {municipalities.map((muni) => {
                // Find country name for display
                const countryName = countries.find(c => c.id === muni.country)?.name || muni.country;
                
                return (
                  <tr key={muni.id}>
                    <td className="px-6 py-4 whitespace-nowrap">
                      <div className="flex items-center">
                        {muni.avatar ? (
                          <img 
                            src={getMediaUrl(muni.avatar) || ''}
                            alt={muni.name}
                            className="w-10 h-10 rounded-full object-cover mr-3 border"
                            onError={(e) => { (e.target as HTMLImageElement).style.display = 'none'; }}
                          />
                        ) : (
                          <div className="w-10 h-10 rounded-full bg-gray-100 mr-3 flex items-center justify-center text-gray-400 text-xs font-bold">
                            M
                          </div>
                        )}
                        <div className="text-sm font-bold text-gray-900">{muni.name}</div>
                      </div>
                    </td>
                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
                      {countryName}
                    </td>
                    <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
                      {muni.municipality_code || '-'}
                    </td>
                    <td className="px-6 py-4 whitespace-nowrap text-sm">
                      <span className={`px-2 py-1 text-xs rounded-full ${muni.allow_self_registration ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`}>
                        {muni.allow_self_registration ? 'Allowed' : 'Restricted'}
                      </span>
                    </td>
                    <td className="px-6 py-4 whitespace-nowrap text-right text-sm font-medium space-x-4">
                      <Link href={`/admin/super/municipalities/${muni.id}`} className="text-blue-600 hover:text-blue-900 font-bold">View</Link>
                      <button onClick={() => handleOpenEdit(muni)} className="text-indigo-600 hover:text-indigo-900 font-bold">Edit</button>
                      <button onClick={() => handleDelete(muni.id)} className="text-red-600 hover:text-red-900">Delete</button>
                    </td>
                  </tr>
                );
              })}
            </tbody>
          </table>
        )}
      </div>

      {/* --- MODAL --- */}
      {showModal && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-xl shadow-2xl w-full max-w-2xl p-8 max-h-[90vh] overflow-y-auto">
            <h2 className="text-2xl font-bold mb-6 text-gray-800">{isEditing ? 'Edit Municipality' : 'New Municipality'}</h2>
            <form onSubmit={handleSubmit} className="space-y-6">
              
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label className="block text-sm font-bold mb-1 text-gray-700">Name</label>
                  <input required type="text" className="w-full border p-2 rounded" 
                    value={formData.name} onChange={e => setFormData({...formData, name: e.target.value})} />
                </div>
                
                <div>
                  <label className="block text-sm font-bold mb-1 text-gray-700">Country</label>
                  <select required className="w-full border p-2 rounded" 
                    value={formData.country} onChange={e => setFormData({...formData, country: e.target.value})}>
                    <option value="">Select Country...</option>
                    {countries.map(c => <option key={c.id} value={c.id}>{c.name}</option>)}
                  </select>
                </div>
              </div>

              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label className="block text-sm font-bold mb-1 text-gray-700">Municipality Code</label>
                  <input type="text" className="w-full border p-2 rounded" 
                    value={formData.municipality_code} onChange={e => setFormData({...formData, municipality_code: e.target.value})} />
                </div>
                
                <div className="flex items-center pt-6">
                  <label className="flex items-center space-x-2 cursor-pointer">
                    <input type="checkbox" checked={formData.allow_self_registration}
                      onChange={e => setFormData({...formData, allow_self_registration: e.target.checked})}
                      className="text-blue-600 h-5 w-5" />
                    <span className="text-sm font-bold text-gray-700">Allow Self Registration</span>
                  </label>
                </div>
              </div>

              {/* IMAGES */}
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4 bg-gray-50 p-4 rounded">
                <div>
                  <label className="block text-xs font-bold mb-1 uppercase text-gray-500">Avatar</label>
                  <input type="file" accept="image/*" className="w-full border p-1 rounded text-sm" onChange={e => handleFileChange(e, 'avatar')} />
                  {avatarPreview && <img src={avatarPreview} className="h-16 mt-2 object-contain" alt="Avatar Preview" />}
                </div>
                <div>
                  <label className="block text-xs font-bold mb-1 uppercase text-gray-500">Hero Image</label>
                  <input type="file" accept="image/*" className="w-full border p-1 rounded text-sm" onChange={e => handleFileChange(e, 'hero')} />
                  {heroPreview && <img src={heroPreview} className="h-16 mt-2 object-cover w-full rounded" alt="Hero Preview" />}
                </div>
              </div>

              {/* CONTACT */}
              <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                <input type="email" placeholder="Email" className="border p-2 rounded" 
                  value={formData.email} onChange={e => setFormData({...formData, email: e.target.value})} />
                <input type="text" placeholder="Phone" className="border p-2 rounded" 
                  value={formData.phone} onChange={e => setFormData({...formData, phone: e.target.value})} />
                <input type="url" placeholder="Website URL" className="border p-2 rounded" 
                  value={formData.website_link} onChange={e => setFormData({...formData, website_link: e.target.value})} />
              </div>

              {/* SOCIAL MEDIA */}
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <input type="text" placeholder="Facebook URL" className="border p-2 rounded" 
                  value={formData.facebook} onChange={e => setFormData({...formData, facebook: e.target.value})} />
                <input type="text" placeholder="Instagram URL" className="border p-2 rounded" 
                  value={formData.instagram} onChange={e => setFormData({...formData, instagram: e.target.value})} />
              </div>

              <div>
                <label className="block text-sm font-bold mb-1 text-gray-700">Description</label>
                <textarea rows={2} required className="w-full border p-2 rounded" 
                  value={formData.description} onChange={e => setFormData({...formData, description: e.target.value})} />
              </div>

              <div>
                <label className="block text-sm font-bold mb-1 text-gray-700">Terms & Conditions</label>
                <textarea rows={3} required className="w-full border p-2 rounded" 
                  value={formData.terms_and_conditions} onChange={e => setFormData({...formData, terms_and_conditions: e.target.value})} />
              </div>

              <div className="flex justify-end gap-4 pt-4 border-t">
                <button type="button" onClick={() => setShowModal(false)} className="text-gray-500 hover:text-gray-700">Cancel</button>
                <button type="submit" className="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700 transition">
                  {isEditing ? 'Save Changes' : 'Create'}
                </button>
              </div>
            </form>
          </div>
        </div>
      )}
    </div>
  );
}

export default function ManageMunicipalitiesPage() {
  return (
    <Suspense fallback={<div>Loading...</div>}>
      <ManageMunicipalitiesPageContent />
    </Suspense>
  );
}
--- END OF FILE: ./frontend/app/admin/super/municipalities/page.tsx ---


--- START OF FILE: ./frontend/app/admin/super/municipalities/[id]/page.tsx ---
'use client';

import { useState, useEffect, Suspense } from 'react';
import { useRouter, useParams } from 'next/navigation';
import Link from 'next/link';
import api from '../../../../../lib/api';
import { getMediaUrl } from '../../../../utils';

function MunicipalityViewPageContent() {
  const router = useRouter();
  const params = useParams();
  const municipalityId = params?.id as string;

  const [municipality, setMunicipality] = useState<any>(null);
  const [isLoading, setIsLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);

  useEffect(() => {
    if (municipalityId) {
      fetchMunicipality();
    }
  }, [municipalityId]);

  const fetchMunicipality = async () => {
    setIsLoading(true);
    setError(null);
    try {
      const res = await api.get(`/municipalities/${municipalityId}/`);
      setMunicipality(res.data);
    } catch (err: any) {
      setError(err?.response?.status === 404 ? 'Municipality not found' : 'Failed to load municipality');
      console.error(err);
    } finally {
      setIsLoading(false);
    }
  };

  if (isLoading) {
    return (
      <div className="p-8 text-center">
        <p className="text-gray-500">Loading municipality details...</p>
      </div>
    );
  }

  if (error || !municipality) {
    return (
      <div className="p-8">
        <div className="bg-red-50 border border-red-200 rounded-lg p-4 mb-4">
          <p className="text-red-800">{error || 'Municipality not found'}</p>
        </div>
        <Link href="/admin/super/municipalities" className="text-blue-600 hover:text-blue-800">
          ‚Üê Back to Municipalities
        </Link>
      </div>
    );
  }

  // Parse social media safely
  let socialMedia = { facebook: '', instagram: '' };
  try {
    if (municipality.social_media) {
      if (typeof municipality.social_media === 'string') {
        socialMedia = { ...socialMedia, ...JSON.parse(municipality.social_media) };
      } else if (typeof municipality.social_media === 'object') {
        socialMedia = { ...socialMedia, ...municipality.social_media };
      }
    }
  } catch (e) {
    console.error('Failed to parse social media:', e);
  }

  return (
    <div className="p-8">
      {/* HEADER */}
      <div className="flex items-center justify-between mb-6">
        <Link href="/admin/super/municipalities" className="text-blue-600 hover:text-blue-800 font-medium">
          ‚Üê Back to Municipalities
        </Link>
        <div className="flex gap-4">
          <button
            onClick={() => router.push(`/admin/super/municipalities?edit=${municipality.id}`)}
            className="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700"
          >
            Edit Municipality
          </button>
        </div>
      </div>

      {/* MUNICIPALITY HEADER */}
      <div className="bg-white rounded-xl shadow-lg overflow-hidden mb-6">
        <div className="relative">
          {municipality.hero_image && (
            <img
              src={getMediaUrl(municipality.hero_image) || ''}
              alt={municipality.name}
              className="w-full h-64 object-cover"
              onError={(e) => (e.target as HTMLImageElement).style.display = 'none'}
            />
          )}
          <div className={`p-8 ${municipality.hero_image ? 'absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/70 to-transparent' : ''}`}>
            <div className="flex items-end gap-6">
              {municipality.avatar && (
                <img
                  src={getMediaUrl(municipality.avatar) || ''}
                  alt={municipality.name}
                  className={`w-24 h-24 rounded-full object-cover border-4 ${municipality.hero_image ? 'border-white' : 'border-gray-200'}`}
                  onError={(e) => (e.target as HTMLImageElement).style.display = 'none'}
                />
              )}
              <div className={municipality.hero_image ? 'text-white' : ''}>
                <h1 className="text-4xl font-bold mb-2">{municipality.name}</h1>
                <p className="text-lg opacity-90">
                  {municipality.country_name || 'Unknown Country'}
                  {municipality.country_code && ` (${municipality.country_code})`}
                </p>
                {municipality.municipality_code && (
                  <p className="text-sm opacity-80 mt-2">Code: {municipality.municipality_code}</p>
                )}
              </div>
            </div>
          </div>
        </div>
      </div>

      <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
        {/* MAIN CONTENT */}
        <div className="lg:col-span-2 space-y-6">
          {/* DESCRIPTION */}
          <div className="bg-white rounded-xl shadow p-6">
            <h2 className="text-2xl font-bold text-gray-800 mb-4">About</h2>
            <p className="text-gray-700 whitespace-pre-wrap">{municipality.description || 'No description provided.'}</p>
          </div>

          {/* CONTACT INFO */}
          <div className="bg-white rounded-xl shadow p-6">
            <h2 className="text-2xl font-bold text-gray-800 mb-4">Contact Information</h2>
            <div className="grid grid-cols-2 gap-4">
              {municipality.email && (
                <div>
                  <p className="text-sm text-gray-500 font-bold uppercase">Email</p>
                  <p className="font-medium">{municipality.email}</p>
                </div>
              )}
              {municipality.phone && (
                <div>
                  <p className="text-sm text-gray-500 font-bold uppercase">Phone</p>
                  <p className="font-medium">{municipality.phone}</p>
                </div>
              )}
              {municipality.website_link && (
                <div className="col-span-2">
                  <p className="text-sm text-gray-500 font-bold uppercase">Website</p>
                  <a
                    href={municipality.website_link}
                    target="_blank"
                    rel="noopener noreferrer"
                    className="text-blue-600 hover:text-blue-800 underline font-medium"
                  >
                    {municipality.website_link}
                  </a>
                </div>
              )}
            </div>
          </div>

          {/* SOCIAL MEDIA */}
          {(socialMedia.facebook || socialMedia.instagram) && (
            <div className="bg-white rounded-xl shadow p-6">
              <h2 className="text-2xl font-bold text-gray-800 mb-4">Social Media</h2>
              <div className="flex gap-4">
                {socialMedia.facebook && (
                  <a
                    href={socialMedia.facebook}
                    target="_blank"
                    rel="noopener noreferrer"
                    className="text-blue-600 hover:text-blue-800 underline"
                  >
                    Facebook ‚Üí
                  </a>
                )}
                {socialMedia.instagram && (
                  <a
                    href={socialMedia.instagram}
                    target="_blank"
                    rel="noopener noreferrer"
                    className="text-pink-600 hover:text-pink-800 underline"
                  >
                    Instagram ‚Üí
                  </a>
                )}
              </div>
            </div>
          )}

          {/* TERMS & CONDITIONS */}
          {municipality.terms_and_conditions && (
            <div className="bg-white rounded-xl shadow p-6">
              <h2 className="text-2xl font-bold text-gray-800 mb-4">Terms & Conditions</h2>
              <p className="text-sm text-gray-600 whitespace-pre-wrap">{municipality.terms_and_conditions}</p>
            </div>
          )}
        </div>

        {/* SIDEBAR */}
        <div className="space-y-6">
          {/* QUICK INFO */}
          <div className="bg-white rounded-xl shadow p-6">
            <h3 className="text-lg font-bold text-gray-800 mb-4">Quick Info</h3>
            <div className="space-y-3">
              <div>
                <p className="text-xs text-gray-500 font-bold uppercase">Country</p>
                <p className="text-sm font-medium">
                  {municipality.country_name || 'Unknown'}
                  {municipality.country_code && ` (${municipality.country_code})`}
                </p>
              </div>
              {municipality.municipality_code && (
                <div>
                  <p className="text-xs text-gray-500 font-bold uppercase">Municipality Code</p>
                  <p className="text-sm font-medium">{municipality.municipality_code}</p>
                </div>
              )}
              <div>
                <p className="text-xs text-gray-500 font-bold uppercase">Self Registration</p>
                <span className={`inline-block px-2 py-1 text-xs rounded-full ${
                  municipality.allow_self_registration 
                    ? 'bg-green-100 text-green-800' 
                    : 'bg-red-100 text-red-800'
                }`}>
                  {municipality.allow_self_registration ? 'Allowed' : 'Restricted'}
                </span>
              </div>
            </div>
          </div>

          {/* ACTIONS */}
          <div className="bg-white rounded-xl shadow p-6">
            <h3 className="text-lg font-bold text-gray-800 mb-4">Actions</h3>
            <div className="space-y-2">
              <button
                onClick={() => router.push(`/admin/super/municipalities?edit=${municipality.id}`)}
                className="w-full bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 text-center"
              >
                Edit Municipality
              </button>
              <Link
                href="/admin/super/municipalities"
                className="block w-full bg-gray-100 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-200 text-center"
              >
                Back to List
              </Link>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
}

export default function MunicipalityViewPage() {
  return (
    <Suspense fallback={<div className="p-8 text-center">Loading...</div>}>
      <MunicipalityViewPageContent />
    </Suspense>
  );
}


--- END OF FILE: ./frontend/app/admin/super/municipalities/[id]/page.tsx ---


--- START OF FILE: ./frontend/app/admin/super/clubs/page.tsx ---
'use client';

import { useState, useEffect, Suspense } from 'react';
import { useRouter, useSearchParams, usePathname } from 'next/navigation';
import Link from 'next/link';
import api from '../../../../lib/api';
import { getMediaUrl } from '../../../utils';

interface Option { id: number; name: string; }

const WEEKDAYS = [
  { id: 1, name: 'Monday' }, { id: 2, name: 'Tuesday' }, { id: 3, name: 'Wednesday' },
  { id: 4, name: 'Thursday' }, { id: 5, name: 'Friday' }, { id: 6, name: 'Saturday' }, { id: 7, name: 'Sunday' },
];

const CYCLES = [
  { id: 'ALL', name: 'Every Week' },
  { id: 'ODD', name: 'Odd Weeks' },
  { id: 'EVEN', name: 'Even Weeks' },
];

function ManageClubsPageContent() {
  const router = useRouter();
  const pathname = usePathname();
  const searchParams = useSearchParams();

  // --- STATE ---
  const [clubs, setClubs] = useState<any[]>([]);
  const [municipalities, setMunicipalities] = useState<Option[]>([]);
  const [isLoading, setIsLoading] = useState(true);

  // Modal & Files
  const [showModal, setShowModal] = useState(false);
  const [isEditing, setIsEditing] = useState(false);
  const [editId, setEditId] = useState<number | null>(null);
  const [avatarFile, setAvatarFile] = useState<File | null>(null);
  const [avatarPreview, setAvatarPreview] = useState<string | null>(null);
  const [heroFile, setHeroFile] = useState<File | null>(null);
  const [heroPreview, setHeroPreview] = useState<string | null>(null);

  // Opening Hours
  const [openingHours, setOpeningHours] = useState<any[]>([]);
  const [hourError, setHourError] = useState('');

  // Form Data
  const initialFormState = {
    name: '', municipality: '', email: '', phone: '',
    description: '', terms_and_conditions: '', club_policies: '',
    address: '', club_categories: '', latitude: '', longitude: '',
  };
  const [formData, setFormData] = useState(initialFormState);

  // New Hour Form
  const initialHourState = {
    weekday: 1, week_cycle: 'ALL',
    open_time: '14:00', close_time: '20:00',
    title: '', gender_restriction: 'ALL',
    restriction_mode: 'NONE', // NONE, AGE, GRADE
    min_value: '', max_value: ''
  };
  const [newHour, setNewHour] = useState(initialHourState);

  useEffect(() => { fetchData(); }, []);

  const fetchData = async () => {
    setIsLoading(true);
    try {
      const clubRes = await api.get('/clubs/');
      setClubs(Array.isArray(clubRes.data) ? clubRes.data : (clubRes.data.results || []));
      const muniRes = await api.get('/municipalities/');
      setMunicipalities(Array.isArray(muniRes.data) ? muniRes.data : (muniRes.data.results || []));
    } catch (err) { console.error(err); } 
    finally { setIsLoading(false); }
  };

  const handleOpenCreate = () => {
    setIsEditing(false); setEditId(null);
    setFormData(initialFormState);
    setOpeningHours([]); setNewHour(initialHourState);
    setAvatarFile(null); setAvatarPreview(null);
    setHeroFile(null); setHeroPreview(null);
    setShowModal(true);
  };

  const handleOpenEdit = (item: any) => {
    setIsEditing(true); setEditId(item.id);
    setFormData({
      name: item.name, municipality: item.municipality,
      email: item.email || '', phone: item.phone || '',
      description: item.description || '', terms_and_conditions: item.terms_and_conditions || '',
      club_policies: item.club_policies || '', address: item.address || '',
      club_categories: item.club_categories || '',
      latitude: item.latitude?.toString() || '', longitude: item.longitude?.toString() || '',
    });
    setOpeningHours(item.regular_hours || []);
    setAvatarFile(null); setAvatarPreview(item.avatar ? getMediaUrl(item.avatar) : null);
    setHeroFile(null); setHeroPreview(item.hero_image ? getMediaUrl(item.hero_image) : null);
    setNewHour(initialHourState);
    setShowModal(true);
  };

  const handleDelete = async (id: number) => {
    if (!window.confirm("Are you sure?")) return;
    try { await api.delete(`/clubs/${id}/`); fetchData(); } 
    catch (err) { alert("Failed to delete."); }
  };

  const handleFileChange = (e: React.ChangeEvent<HTMLInputElement>, type: 'avatar' | 'hero') => {
    const file = e.target.files?.[0];
    if (file) {
      const reader = new FileReader();
      reader.onloadend = () => {
        if (type === 'avatar') { setAvatarFile(file); setAvatarPreview(reader.result as string); } 
        else { setHeroFile(file); setHeroPreview(reader.result as string); }
      };
      reader.readAsDataURL(file);
    }
  };

  // --- HOUR VALIDATION ---
  const checkOverlap = (newItem: any) => {
    // Convert time string "14:00" to minutes
    const toMins = (t: string) => {
      const [h, m] = t.split(':').map(Number);
      return h * 60 + m;
    };
    const start = toMins(newItem.open_time);
    const end = toMins(newItem.close_time);

    // Validation: End must be after Start
    if (end <= start) return "Close time must be after Open time.";

    // Check against existing
    for (const h of openingHours) {
      if (h.weekday !== newItem.weekday) continue;
      
      // Cycle Check: Overlap if either is ALL or they match
      const cycleOverlap = h.week_cycle === 'ALL' || newItem.week_cycle === 'ALL' || h.week_cycle === newItem.week_cycle;
      if (!cycleOverlap) continue;

      const s2 = toMins(h.open_time);
      const e2 = toMins(h.close_time);

      // Overlap formula: (StartA < EndB) and (EndA > StartB)
      // Note: We use < and > to allow touching (e.g. 15:00 end and 15:00 start is ok)
      if (start < e2 && end > s2) {
        return `Overlap detected with existing hour: ${h.open_time}-${h.close_time} (${h.week_cycle === 'ALL' ? 'Every Week' : h.week_cycle})`;
      }
    }
    return null;
  };

  const addHour = () => {
    setHourError('');
    const error = checkOverlap(newHour);
    if (error) {
      setHourError(error);
      return;
    }
    setOpeningHours([...openingHours, { ...newHour }]);
    // Keep the day selected for faster entry, reset times/title
    setNewHour({ ...newHour, title: '', min_value: '', max_value: '' }); 
  };

  const removeHour = (index: number) => {
    const updated = [...openingHours];
    updated.splice(index, 1);
    setOpeningHours(updated);
  };

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    
    // Validate required fields (trim whitespace and check for actual content)
    const trimmedName = formData.name?.trim();
    const municipalityValue = formData.municipality?.toString().trim();
    const trimmedEmail = formData.email?.trim();
    const trimmedPhone = formData.phone?.trim();
    const trimmedDescription = formData.description?.trim();
    const trimmedTerms = formData.terms_and_conditions?.trim();
    const trimmedPolicies = formData.club_policies?.trim();
    
    // Check if municipality is a valid number
    const isValidMunicipality = municipalityValue && !isNaN(Number(municipalityValue)) && Number(municipalityValue) > 0;
    
    if (!trimmedName || !isValidMunicipality || !trimmedEmail || !trimmedPhone || 
        !trimmedDescription || !trimmedTerms || !trimmedPolicies) {
      const missingFields = [];
      if (!trimmedName) missingFields.push('Name');
      if (!isValidMunicipality) missingFields.push('Municipality');
      if (!trimmedEmail) missingFields.push('Email');
      if (!trimmedPhone) missingFields.push('Phone');
      if (!trimmedDescription) missingFields.push('Description');
      if (!trimmedTerms) missingFields.push('Terms & Conditions');
      if (!trimmedPolicies) missingFields.push('Club Policies');
      
      alert(`Please fill in the following required fields: ${missingFields.join(', ')}`);
      return;
    }
    
    try {
      const data = new FormData();
      // Append all form fields with trimmed values (validation already ensured required fields are filled)
      data.append('name', trimmedName);
      data.append('municipality', municipalityValue);
      data.append('email', trimmedEmail);
      data.append('phone', trimmedPhone);
      data.append('description', trimmedDescription);
      data.append('terms_and_conditions', trimmedTerms);
      data.append('club_policies', trimmedPolicies);
      // Append optional fields
      if (formData.address?.trim()) data.append('address', formData.address.trim());
      if (formData.club_categories?.trim()) data.append('club_categories', formData.club_categories.trim());
      if (formData.latitude?.trim()) data.append('latitude', formData.latitude.trim());
      if (formData.longitude?.trim()) data.append('longitude', formData.longitude.trim());
      
      // Clean up opening hours data before sending
      const cleanedHours = openingHours.map(hour => {
        const cleaned: any = {
          weekday: hour.weekday,
          week_cycle: hour.week_cycle || 'ALL',
          open_time: hour.open_time,
          close_time: hour.close_time,
          title: hour.title || '',
          gender_restriction: hour.gender_restriction || 'ALL',
          restriction_mode: hour.restriction_mode || 'NONE',
        };
        
        // Only include min_value/max_value if restriction_mode is not 'NONE'
        if (cleaned.restriction_mode !== 'NONE') {
          cleaned.min_value = hour.min_value ? parseInt(hour.min_value) : null;
          cleaned.max_value = hour.max_value ? parseInt(hour.max_value) : null;
        } else {
          cleaned.min_value = null;
          cleaned.max_value = null;
        }
        
        return cleaned;
      });
      
      data.append('regular_hours_data', JSON.stringify(cleanedHours));
      if (avatarFile) data.append('avatar', avatarFile);
      if (heroFile) data.append('hero_image', heroFile);

      const config = { headers: { 'Content-Type': 'multipart/form-data' } };
      if (isEditing && editId) await api.patch(`/clubs/${editId}/`, data, config);
      else await api.post('/clubs/', data, config);

      setShowModal(false);
      fetchData();
    } catch (err: any) { 
      const errorMessage = err?.response?.data?.detail || err?.response?.data?.message || JSON.stringify(err?.response?.data) || 'Operation failed.';
      alert(`Error: ${errorMessage}`);
      console.error('Full error:', err);
      console.error('Error response data:', err?.response?.data);
    }
  };

  return (
    <div>
      <div className="flex justify-between items-center mb-6">
        <h1 className="text-2xl font-bold text-gray-800">Manage Clubs</h1>
        <button onClick={handleOpenCreate} className="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 shadow">+ Add Club</button>
      </div>

      {/* LIST */}
      <div className="bg-white rounded-lg shadow overflow-hidden mb-6">
        {isLoading ? <div className="p-8 text-center">Loading...</div> : (
          <table className="min-w-full divide-y divide-gray-200">
            <thead className="bg-gray-50">
              <tr>
                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Club</th>
                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Municipality</th>
                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Email</th>
                <th className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">Actions</th>
              </tr>
            </thead>
            <tbody className="bg-white divide-y divide-gray-200">
              {clubs.map((club) => (
                <tr key={club.id}>
                  <td className="px-6 py-4 whitespace-nowrap">
                    <div className="flex items-center">
                      {club.avatar ? <img src={getMediaUrl(club.avatar) || ''} className="w-10 h-10 rounded-full object-cover mr-3" /> : <div className="w-10 h-10 bg-gray-200 rounded-full mr-3 flex items-center justify-center text-xs">C</div>}
                      <div className="text-sm font-bold">{club.name}</div>
                    </div>
                  </td>
                  <td className="px-6 py-4 whitespace-nowrap text-sm">{club.municipality_name}</td>
                  <td className="px-6 py-4 whitespace-nowrap text-sm">{club.email}</td>
                  <td className="px-6 py-4 whitespace-nowrap text-right text-sm space-x-4">
                    <Link href={`/admin/super/clubs/${club.id}`} className="text-blue-600 hover:text-blue-900 font-bold">View</Link>
                    <button onClick={() => handleOpenEdit(club)} className="text-indigo-600 hover:text-indigo-900 font-bold">Edit</button>
                    <button onClick={() => handleDelete(club.id)} className="text-red-600 hover:text-red-900">Delete</button>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        )}
      </div>

      {/* MODAL */}
      {showModal && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-xl shadow-2xl w-full max-w-5xl p-8 max-h-[90vh] overflow-y-auto">
            <h2 className="text-2xl font-bold mb-6 text-gray-800">{isEditing ? 'Edit Club' : 'New Club'}</h2>
            <form onSubmit={handleSubmit} className="space-y-6">
              <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                {/* Left Col: Basic */}
                <div className="space-y-4">
                  <div><label className="text-sm font-bold">Club Name</label><input required type="text" className="w-full border p-2 rounded" value={formData.name} onChange={e => setFormData({...formData, name: e.target.value})} /></div>
                  <div><label className="text-sm font-bold">Municipality</label><select required className="w-full border p-2 rounded" value={formData.municipality} onChange={e => setFormData({...formData, municipality: e.target.value})}>{municipalities.map(m => <option key={m.id} value={m.id}>{m.name}</option>)}</select></div>
                  <div className="grid grid-cols-2 gap-2">
                    <input required type="email" placeholder="Email" className="border p-2 rounded" value={formData.email} onChange={e => setFormData({...formData, email: e.target.value})} />
                    <input required type="text" placeholder="Phone" className="border p-2 rounded" value={formData.phone} onChange={e => setFormData({...formData, phone: e.target.value})} />
                  </div>
                  <div><label className="text-sm font-bold">Description</label><textarea required rows={3} className="w-full border p-2 rounded" value={formData.description} onChange={e => setFormData({...formData, description: e.target.value})} /></div>
                  <div><label className="text-sm font-bold">Address</label><input type="text" className="w-full border p-2 rounded" value={formData.address} onChange={e => setFormData({...formData, address: e.target.value})} /></div>
                  <div className="grid grid-cols-2 gap-2">
                    <div><label className="text-sm font-bold">Latitude</label><input type="number" step="any" placeholder="e.g. 59.3293" className="w-full border p-2 rounded" value={formData.latitude} onChange={e => setFormData({...formData, latitude: e.target.value})} /></div>
                    <div><label className="text-sm font-bold">Longitude</label><input type="number" step="any" placeholder="e.g. 18.0686" className="w-full border p-2 rounded" value={formData.longitude} onChange={e => setFormData({...formData, longitude: e.target.value})} /></div>
                  </div>
                  <div><label className="text-sm font-bold">Categories</label><input type="text" placeholder="e.g. Sports, Art" className="w-full border p-2 rounded" value={formData.club_categories} onChange={e => setFormData({...formData, club_categories: e.target.value})} /></div>
                </div>
                
                {/* Right Col: Media & Legal */}
                <div className="space-y-4">
                  <div className="grid grid-cols-2 gap-2 bg-gray-50 p-2 rounded">
                    <div><label className="text-xs font-bold uppercase">Avatar</label><input type="file" className="w-full text-xs" onChange={e => handleFileChange(e, 'avatar')} />{avatarPreview && <img src={avatarPreview} className="h-10 mt-1" />}</div>
                    <div><label className="text-xs font-bold uppercase">Hero</label><input type="file" className="w-full text-xs" onChange={e => handleFileChange(e, 'hero')} />{heroPreview && <img src={heroPreview} className="h-10 mt-1 rounded" />}</div>
                  </div>
                  <div><label className="text-sm font-bold">Terms & Conditions</label><textarea required rows={2} placeholder="Terms & Conditions" className="w-full border p-2 rounded text-sm" value={formData.terms_and_conditions} onChange={e => setFormData({...formData, terms_and_conditions: e.target.value})} /></div>
                  <div><label className="text-sm font-bold">Club Policies</label><textarea required rows={2} placeholder="Club Policies" className="w-full border p-2 rounded text-sm" value={formData.club_policies} onChange={e => setFormData({...formData, club_policies: e.target.value})} /></div>
                </div>
              </div>

              {/* HOURS BUILDER */}
              <div className="border-t pt-4 mt-4">
                <h3 className="text-lg font-bold text-gray-700 mb-4">Opening Hours</h3>
                
                {/* Add Form */}
                <div className="bg-gray-50 p-3 rounded mb-4 border space-y-3">
                  <div className="flex flex-wrap gap-2">
                    <select className="border p-1 rounded text-sm w-32" value={newHour.weekday} onChange={e => setNewHour({...newHour, weekday: parseInt(e.target.value)})}>
                      {WEEKDAYS.map(d => <option key={d.id} value={d.id}>{d.name}</option>)}
                    </select>
                    <select className="border p-1 rounded text-sm w-32" value={newHour.week_cycle} onChange={e => setNewHour({...newHour, week_cycle: e.target.value})}>
                      {CYCLES.map(c => <option key={c.id} value={c.id}>{c.name}</option>)}
                    </select>
                    <input type="time" className="border p-1 rounded text-sm" value={newHour.open_time} onChange={e => setNewHour({...newHour, open_time: e.target.value})} />
                    <span>-</span>
                    <input type="time" className="border p-1 rounded text-sm" value={newHour.close_time} onChange={e => setNewHour({...newHour, close_time: e.target.value})} />
                  </div>

                  {/* RESTRICTIONS ROW */}
                  <div className="flex flex-wrap gap-2 items-center">
                    <select className="border p-1 rounded text-sm w-32 bg-white" value={newHour.restriction_mode} onChange={e => setNewHour({...newHour, restriction_mode: e.target.value})}>
                      <option value="NONE">No Restriction</option>
                      <option value="AGE">Age Range</option>
                      <option value="GRADE">Grade Range</option>
                    </select>

                    {newHour.restriction_mode !== 'NONE' && (
                      <div className="flex items-center gap-1">
                        <input type="number" placeholder="From" className="border p-1 rounded text-sm w-16" value={newHour.min_value} onChange={e => setNewHour({...newHour, min_value: e.target.value})} />
                        <span className="text-gray-500">-</span>
                        <input type="number" placeholder="To" className="border p-1 rounded text-sm w-16" value={newHour.max_value} onChange={e => setNewHour({...newHour, max_value: e.target.value})} />
                        <span className="text-xs text-gray-500 font-bold uppercase ml-1">{newHour.restriction_mode}</span>
                      </div>
                    )}

                    <input type="text" placeholder="Title (Optional)" className="border p-1 rounded text-sm flex-1" value={newHour.title} onChange={e => setNewHour({...newHour, title: e.target.value})} />
                    
                    <button type="button" onClick={addHour} className="bg-green-600 text-white px-3 py-1 rounded text-sm hover:bg-green-700 ml-auto">+ Add Hour</button>
                  </div>
                  
                  {hourError && <p className="text-red-600 text-xs font-bold">{hourError}</p>}
                </div>

                {/* HOURS LIST */}
                <div className="space-y-2 max-h-60 overflow-y-auto">
                  {openingHours.map((hour, idx) => {
                    const dayName = WEEKDAYS.find(d => d.id === hour.weekday)?.name;
                    const cycleName = CYCLES.find(c => c.id === hour.week_cycle)?.name;
                    return (
                      <div key={idx} className="flex justify-between items-center bg-white border p-2 rounded shadow-sm text-sm">
                        <div className="flex gap-2">
                          <span className="font-bold w-24">{dayName}</span>
                          <span className="text-gray-500 text-xs uppercase w-20 pt-0.5">{cycleName}</span>
                          <span>{hour.open_time.substring(0,5)} - {hour.close_time.substring(0,5)}</span>
                        </div>
                        
                        <div className="flex gap-4 items-center">
                          {hour.restriction_mode !== 'NONE' && (
                            <span className="bg-yellow-100 text-yellow-800 px-2 py-0.5 rounded text-xs font-bold">
                              {hour.restriction_mode === 'AGE' ? 'Age' : 'Grade'} {hour.min_value}-{hour.max_value}
                            </span>
                          )}
                          {hour.title && <span className="text-gray-500 italic">{hour.title}</span>}
                          <button type="button" onClick={() => removeHour(idx)} className="text-red-500 font-bold px-2">√ó</button>
                        </div>
                      </div>
                    );
                  })}
                </div>
              </div>

              <div className="flex justify-end gap-4 pt-4 border-t">
                <button type="button" onClick={() => setShowModal(false)} className="text-gray-500">Cancel</button>
                <button type="submit" className="bg-blue-600 text-white px-6 py-2 rounded">{isEditing ? 'Save' : 'Create'}</button>
              </div>
            </form>
          </div>
        </div>
      )}

    </div>
  );
}

export default function ManageClubsPage() {
  return <Suspense fallback={<div>Loading...</div>}><ManageClubsPageContent /></Suspense>;
}

--- END OF FILE: ./frontend/app/admin/super/clubs/page.tsx ---


--- START OF FILE: ./frontend/app/admin/super/clubs/[id]/page.tsx ---
'use client';

import { useState, useEffect, Suspense, useMemo } from 'react';
import { useRouter, useParams } from 'next/navigation';
import Link from 'next/link';
import Script from 'next/script';
import { GoogleMap, Marker, LoadScript } from '@react-google-maps/api';
import api from '../../../../../lib/api';
import { getMediaUrl } from '../../../../utils';

const WEEKDAYS = [
  { id: 1, name: 'Monday' }, { id: 2, name: 'Tuesday' }, { id: 3, name: 'Wednesday' },
  { id: 4, name: 'Thursday' }, { id: 5, name: 'Friday' }, { id: 6, name: 'Saturday' }, { id: 7, name: 'Sunday' },
];

const CYCLES = [
  { id: 'ALL', name: 'Every Week' },
  { id: 'ODD', name: 'Odd Weeks' },
  { id: 'EVEN', name: 'Even Weeks' },
];

function ClubViewPageContent() {
  const router = useRouter();
  const params = useParams();
  const clubId = params?.id as string;

  const [club, setClub] = useState<any>(null);
  const [isLoading, setIsLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);

  useEffect(() => {
    if (clubId) {
      fetchClub();
    }
  }, [clubId]);

  const fetchClub = async () => {
    setIsLoading(true);
    setError(null);
    try {
      const res = await api.get(`/clubs/${clubId}/`);
      setClub(res.data);
    } catch (err: any) {
      setError(err?.response?.status === 404 ? 'Club not found' : 'Failed to load club');
      console.error(err);
    } finally {
      setIsLoading(false);
    }
  };

  if (isLoading) {
    return (
      <div className="p-8 text-center">
        <p className="text-gray-500">Loading club details...</p>
      </div>
    );
  }

  if (error || !club) {
    return (
      <div className="p-8">
        <div className="bg-red-50 border border-red-200 rounded-lg p-4 mb-4">
          <p className="text-red-800">{error || 'Club not found'}</p>
        </div>
        <Link href="/admin/super/clubs" className="text-blue-600 hover:text-blue-800">
          ‚Üê Back to Clubs
        </Link>
      </div>
    );
  }

  return (
    <div className="p-8">
      {/* HEADER */}
      <div className="flex items-center justify-between mb-6">
        <Link href="/admin/super/clubs" className="text-blue-600 hover:text-blue-800 font-medium">
          ‚Üê Back to Clubs
        </Link>
        <div className="flex gap-4">
          <button
            onClick={() => router.push(`/admin/super/clubs?edit=${club.id}`)}
            className="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700"
          >
            Edit Club
          </button>
        </div>
      </div>

      {/* CLUB HEADER */}
      <div className="bg-white rounded-xl shadow-lg overflow-hidden mb-6">
        <div className="relative">
          {club.hero_image && (
            <img
              src={getMediaUrl(club.hero_image) || ''}
              alt={club.name}
              className="w-full h-64 object-cover"
              onError={(e) => (e.target as HTMLImageElement).style.display = 'none'}
            />
          )}
          <div className={`p-8 ${club.hero_image ? 'absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/70 to-transparent' : ''}`}>
            <div className="flex items-end gap-6">
              {club.avatar && (
                <img
                  src={getMediaUrl(club.avatar) || ''}
                  alt={club.name}
                  className={`w-24 h-24 rounded-full object-cover border-4 ${club.hero_image ? 'border-white' : 'border-gray-200'}`}
                  onError={(e) => (e.target as HTMLImageElement).style.display = 'none'}
                />
              )}
              <div className={club.hero_image ? 'text-white' : ''}>
                <h1 className="text-4xl font-bold mb-2">{club.name}</h1>
                <p className="text-lg opacity-90">{club.municipality_name}</p>
                {club.address && (
                  <p className="text-sm opacity-80 mt-2">üìç {club.address}</p>
                )}
              </div>
            </div>
          </div>
        </div>
      </div>

      <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
        {/* MAIN CONTENT */}
        <div className="lg:col-span-2 space-y-6">
          {/* DESCRIPTION */}
          <div className="bg-white rounded-xl shadow p-6">
            <h2 className="text-2xl font-bold text-gray-800 mb-4">About</h2>
            <p className="text-gray-700 whitespace-pre-wrap">{club.description || 'No description provided.'}</p>
          </div>

          {/* CONTACT INFO */}
          <div className="bg-white rounded-xl shadow p-6">
            <h2 className="text-2xl font-bold text-gray-800 mb-4">Contact Information</h2>
            <div className="grid grid-cols-2 gap-4">
              <div>
                <p className="text-sm text-gray-500 font-bold uppercase">Email</p>
                <p className="font-medium">{club.email || '-'}</p>
              </div>
              <div>
                <p className="text-sm text-gray-500 font-bold uppercase">Phone</p>
                <p className="font-medium">{club.phone || '-'}</p>
              </div>
              {club.address && (
                <div className="col-span-2">
                  <p className="text-sm text-gray-500 font-bold uppercase">Address</p>
                  <p className="font-medium">{club.address}</p>
                </div>
              )}
              {(club.latitude && club.longitude) && (
                <div className="col-span-2">
                  <p className="text-sm text-gray-500 font-bold uppercase mb-2">Location</p>
                  <p className="text-sm text-gray-600 mb-2">Coordinates: {club.latitude}, {club.longitude}</p>
                  <a
                    href={`https://www.google.com/maps?q=${club.latitude},${club.longitude}`}
                    target="_blank"
                    rel="noopener noreferrer"
                    className="text-blue-600 hover:text-blue-800 underline text-sm mb-3 inline-block"
                  >
                    Open in Google Maps ‚Üí
                  </a>
                </div>
              )}
            </div>
          </div>

          {/* GOOGLE MAP */}
          {club.latitude && club.longitude && (
            <div className="bg-white rounded-xl shadow p-6">
              <h2 className="text-2xl font-bold text-gray-800 mb-4">Map Location</h2>
              {process.env.NEXT_PUBLIC_GOOGLE_MAPS_API_KEY ? (
                <div className="w-full h-96 rounded-lg overflow-hidden border border-gray-200">
                  <LoadScript googleMapsApiKey={process.env.NEXT_PUBLIC_GOOGLE_MAPS_API_KEY}>
                    <GoogleMap
                      mapContainerStyle={{ width: '100%', height: '100%' }}
                      center={{
                        lat: parseFloat(club.latitude),
                        lng: parseFloat(club.longitude)
                      }}
                      zoom={15}
                      options={{
                        zoomControl: true,
                        streetViewControl: true,
                        mapTypeControl: true,
                        fullscreenControl: true,
                      }}
                    >
                      <Marker
                        position={{
                          lat: parseFloat(club.latitude),
                          lng: parseFloat(club.longitude)
                        }}
                        title={club.name}
                      />
                    </GoogleMap>
                  </LoadScript>
                </div>
              ) : (
                <div className="w-full h-96 rounded-lg overflow-hidden border border-gray-200 bg-gray-100 flex items-center justify-center">
                  <div className="text-center p-4">
                    <p className="text-gray-600 mb-2">Google Maps API key not configured</p>
                    <p className="text-sm text-gray-500">Add NEXT_PUBLIC_GOOGLE_MAPS_API_KEY to your .env.local file</p>
                    <a
                      href={`https://www.google.com/maps?q=${club.latitude},${club.longitude}`}
                      target="_blank"
                      rel="noopener noreferrer"
                      className="text-blue-600 hover:text-blue-800 underline text-sm mt-2 inline-block"
                    >
                      Open in Google Maps instead ‚Üí
                    </a>
                  </div>
                </div>
              )}
            </div>
          )}

          {/* OPENING HOURS */}
          {club.regular_hours && club.regular_hours.length > 0 && (
            <div className="bg-white rounded-xl shadow p-6">
              <h2 className="text-2xl font-bold text-gray-800 mb-4">Opening Hours</h2>
              <div className="space-y-3">
                {club.regular_hours.map((hour: any, idx: number) => {
                  const dayName = WEEKDAYS.find(d => d.id === hour.weekday)?.name;
                  const cycleName = CYCLES.find(c => c.id === hour.week_cycle)?.name;
                  const timeStr = `${hour.open_time.substring(0,5)} - ${hour.close_time.substring(0,5)}`;
                  
                  return (
                    <div key={idx} className="border rounded-lg p-4 hover:bg-gray-50 transition">
                      <div className="flex justify-between items-start">
                        <div className="flex-1">
                          <div className="flex items-center gap-3 mb-2">
                            <span className="font-bold text-gray-900 w-28">{dayName}</span>
                            <span className="text-xs text-gray-500 uppercase bg-gray-100 px-2 py-1 rounded">{cycleName}</span>
                            <span className="text-gray-700 font-medium">{timeStr}</span>
                          </div>
                          {hour.title && (
                            <p className="text-sm text-gray-600 italic ml-28">{hour.title}</p>
                          )}
                          {hour.description && (
                            <p className="text-xs text-gray-500 mt-1 ml-28">{hour.description}</p>
                          )}
                        </div>
                        <div className="flex gap-2 items-center">
                          {hour.restriction_mode !== 'NONE' && hour.min_value && hour.max_value && (
                            <span className="bg-yellow-100 text-yellow-800 px-2 py-1 rounded text-xs font-bold">
                              {hour.restriction_mode === 'AGE' ? 'Age' : 'Grade'} {hour.min_value}-{hour.max_value}
                            </span>
                          )}
                          {hour.gender_restriction !== 'ALL' && (
                            <span className="bg-blue-100 text-blue-800 px-2 py-1 rounded text-xs font-bold">
                              {hour.gender_restriction}
                            </span>
                          )}
                        </div>
                      </div>
                    </div>
                  );
                })}
              </div>
            </div>
          )}

          {/* LEGAL DOCUMENTS */}
          {(club.terms_and_conditions || club.club_policies) && (
            <div className="bg-white rounded-xl shadow p-6">
              <h2 className="text-2xl font-bold text-gray-800 mb-4">Legal Documents</h2>
              <div className="space-y-4">
                {club.terms_and_conditions && (
                  <div>
                    <h3 className="text-lg font-bold text-gray-700 mb-2">Terms & Conditions</h3>
                    <p className="text-sm text-gray-600 whitespace-pre-wrap">{club.terms_and_conditions}</p>
                  </div>
                )}
                {club.club_policies && (
                  <div>
                    <h3 className="text-lg font-bold text-gray-700 mb-2">Club Policies</h3>
                    <p className="text-sm text-gray-600 whitespace-pre-wrap">{club.club_policies}</p>
                  </div>
                )}
              </div>
            </div>
          )}
        </div>

        {/* SIDEBAR */}
        <div className="space-y-6">
          {/* QUICK INFO */}
          <div className="bg-white rounded-xl shadow p-6">
            <h3 className="text-lg font-bold text-gray-800 mb-4">Quick Info</h3>
            <div className="space-y-3">
              {club.club_categories && (
                <div>
                  <p className="text-xs text-gray-500 font-bold uppercase">Categories</p>
                  <p className="text-sm font-medium">{club.club_categories}</p>
                </div>
              )}
              {club.allowed_age_groups && (
                <div>
                  <p className="text-xs text-gray-500 font-bold uppercase">Age Groups</p>
                  <p className="text-sm font-medium">{club.allowed_age_groups}</p>
                </div>
              )}
            </div>
          </div>

          {/* ACTIONS */}
          <div className="bg-white rounded-xl shadow p-6">
            <h3 className="text-lg font-bold text-gray-800 mb-4">Actions</h3>
            <div className="space-y-2">
              <button
                onClick={() => router.push(`/admin/super/clubs?edit=${club.id}`)}
                className="w-full bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 text-center"
              >
                Edit Club
              </button>
              <Link
                href="/admin/super/clubs"
                className="block w-full bg-gray-100 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-200 text-center"
              >
                Back to List
              </Link>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
}

export default function ClubViewPage() {
  return (
    <Suspense fallback={<div className="p-8 text-center">Loading...</div>}>
      <ClubViewPageContent />
    </Suspense>
  );
}


--- END OF FILE: ./frontend/app/admin/super/clubs/[id]/page.tsx ---


--- START OF FILE: ./frontend/app/admin/super/admins/page.tsx ---
'use client';

import { useState, useEffect, Suspense } from 'react';
import { useRouter, useSearchParams, usePathname } from 'next/navigation';
import api from '../../../../lib/api';
import { getMediaUrl } from '../../../utils';

interface Option { id: number; name: string; }

// Define the shape of our stats data
interface AdminStats {
  total_admins: number;
  roles: { super: number; municipality: number; club: number };
  gender: { male: number; female: number; other: number };
  activity: { active_7_days: number; new_30_days: number };
}

function ManageAdminsPageContent() {
  const router = useRouter();
  const pathname = usePathname();
  const searchParams = useSearchParams();

  // --- STATE ---
  const [users, setUsers] = useState<any[]>([]);
  const [totalCount, setTotalCount] = useState(0); 
  const [isLoading, setIsLoading] = useState(true);
  
  // Stats State
  const [stats, setStats] = useState<AdminStats | null>(null);

  // Modal & Form State
  const [showModal, setShowModal] = useState(false);
  const [isEditing, setIsEditing] = useState(false);
  const [editUserId, setEditUserId] = useState<number | null>(null);
  const [municipalities, setMunicipalities] = useState<Option[]>([]);
  const [clubs, setClubs] = useState<Option[]>([]);

  const initialFormState = {
    email: '', password: '', first_name: '', last_name: '', nickname: '',
    legal_gender: 'MALE', phone_number: '', profession: '',
    assigned_municipality: '', assigned_club: '', hide_contact_info: false
  };

  const [formData, setFormData] = useState(initialFormState);
  const [adminType, setAdminType] = useState('MUNICIPALITY_ADMIN');
  const [avatarFile, setAvatarFile] = useState<File | null>(null);
  const [avatarPreview, setAvatarPreview] = useState<string | null>(null);

  // --- INITIAL DATA LOAD ---
  useEffect(() => {
    fetchDropdowns();
    fetchStats(); // Fetch analytics on load
  }, []);

  // --- FETCH LIST WHEN URL CHANGES ---
  useEffect(() => {
    fetchAdmins();
  }, [searchParams]);

  const fetchStats = async () => {
    try {
      const res = await api.get('/users/stats/');
      setStats(res.data);
    } catch (err) {
      console.error("Failed to load stats", err);
    }
  };

  const fetchAdmins = async () => {
    setIsLoading(true);
    try {
      const adminRoles = ['SUPER_ADMIN', 'MUNICIPALITY_ADMIN', 'CLUB_ADMIN'];
      const roleFilter = searchParams.get('role');
      
      // If a specific admin role is selected, fetch only that role
      if (roleFilter && adminRoles.includes(roleFilter)) {
        const params = new URLSearchParams();
        params.set('role', roleFilter);
        
        // Copy other allowed filters
        const municipality = searchParams.get('assigned_municipality');
        if (municipality) params.set('assigned_municipality', municipality);
        
        const club = searchParams.get('assigned_club');
        if (club) params.set('assigned_club', club);
        
        const gender = searchParams.get('legal_gender');
        if (gender) params.set('legal_gender', gender);
        
        const page = searchParams.get('page');
        if (page) params.set('page', page);
        
        const res = await api.get(`/users/?${params.toString()}`);
        setUsers(res.data.results || []);
        setTotalCount(res.data.count);
      } else {
        // When showing all admins (no role filter), fetch all admin roles and combine
        // We need to fetch each role separately and combine results
        const municipality = searchParams.get('assigned_municipality');
        const club = searchParams.get('assigned_club');
        const gender = searchParams.get('legal_gender');
        const page = Number(searchParams.get('page')) || 1;
        const pageSize = 10;
        
        // Fetch all admin roles in parallel
        const promises = adminRoles.map(role => {
          const params = new URLSearchParams();
          params.set('role', role);
          if (municipality) params.set('assigned_municipality', municipality);
          if (club) params.set('assigned_club', club);
          if (gender) params.set('legal_gender', gender);
          // Fetch all pages for each role (we'll paginate on frontend)
          params.set('page_size', '1000'); // Large number to get all
          return api.get(`/users/?${params.toString()}`);
        });
        
        const results = await Promise.all(promises);
        
        // Combine all admin users
        let allAdmins: any[] = [];
        results.forEach(res => {
          if (res.data.results) {
            allAdmins = allAdmins.concat(res.data.results);
          }
        });
        
        // Apply frontend pagination
        const startIndex = (page - 1) * pageSize;
        const endIndex = startIndex + pageSize;
        const paginatedAdmins = allAdmins.slice(startIndex, endIndex);
        
        setUsers(paginatedAdmins);
        setTotalCount(allAdmins.length);
      }
    } catch (err) {
      console.error(err);
    } finally {
      setIsLoading(false);
    }
  };

  const fetchDropdowns = async () => {
    try {
      const muniRes = await api.get('/municipalities/');
      setMunicipalities(Array.isArray(muniRes.data) ? muniRes.data : (muniRes.data?.results || []));
      const clubRes = await api.get('/clubs/');
      setClubs(Array.isArray(clubRes.data) ? clubRes.data : (clubRes.data?.results || []));
    } catch (err) {
      console.error(err);
    }
  };

  const updateUrl = (key: string, value: string) => {
    const params = new URLSearchParams(searchParams.toString());
    
    // If updating role, ensure it's a valid admin role
    if (key === 'role') {
      const adminRoles = ['SUPER_ADMIN', 'MUNICIPALITY_ADMIN', 'CLUB_ADMIN'];
      if (value && adminRoles.includes(value)) {
        params.set(key, value);
      } else {
        params.delete(key); // Remove invalid role filter
      }
    } else {
      if (value) params.set(key, value);
      else params.delete(key);
    }
    
    if (key !== 'page') params.set('page', '1');
    router.push(`${pathname}?${params.toString()}`);
  };

  // --- ACTIONS ---

  const handleOpenCreate = () => {
    setIsEditing(false);
    setEditUserId(null);
    setFormData(initialFormState);
    setAdminType('MUNICIPALITY_ADMIN');
    setAvatarFile(null);
    setAvatarPreview(null);
    setShowModal(true);
  };

  const handleOpenEdit = (user: any) => {
    setIsEditing(true);
    setEditUserId(user.id);
    setAdminType(user.role);
    setFormData({
      email: user.email, password: '', 
      first_name: user.first_name || '', last_name: user.last_name || '',
      nickname: user.nickname || '', legal_gender: user.legal_gender || 'MALE',
      phone_number: user.phone_number || '', profession: user.profession || '',
      assigned_municipality: user.assigned_municipality || '', assigned_club: user.assigned_club || '',
      hide_contact_info: user.hide_contact_info || false
    });
    setAvatarFile(null);
    setAvatarPreview(user.avatar ? getMediaUrl(user.avatar) : null);
    setShowModal(true);
  };

  const handleDelete = async (id: number) => {
    if (!window.confirm("Are you sure?")) return;
    try {
      await api.delete(`/users/${id}/`);
      fetchAdmins();
      fetchStats(); // Update stats after delete
    } catch (err) { 
      alert("Failed to delete."); 
    }
  };

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    try {
      const data = new FormData();
      Object.entries(formData).forEach(([key, value]) => {
        if (key === 'password' && !value) return; 
        data.append(key, value.toString());
      });
      data.append('role', adminType);
      if (avatarFile) data.append('avatar', avatarFile);

      const config = { headers: { 'Content-Type': 'multipart/form-data' } };
      if (isEditing && editUserId) await api.patch(`/users/${editUserId}/`, data, config);
      else await api.post('/users/', data, config);

      setShowModal(false);
      setAvatarFile(null);
      setAvatarPreview(null);
      fetchAdmins();
      fetchStats(); // Update stats after create/edit
    } catch (err) { 
      alert('Operation failed.'); 
      console.error(err);
    }
  };

  const handleAvatarChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (file) {
      const validTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/svg+xml', 'image/gif'];
      if (!validTypes.includes(file.type)) {
        alert('Please select a valid image file (jpg, png, svg, or gif)');
        return;
      }
      setAvatarFile(file);
      const reader = new FileReader();
      reader.onloadend = () => setAvatarPreview(reader.result as string);
      reader.readAsDataURL(file);
    }
  };

  const currentPage = Number(searchParams.get('page')) || 1;
  const totalPages = Math.ceil(totalCount / 10);

  return (
    <div>
      <div className="flex justify-between items-center mb-6">
        <h1 className="text-2xl font-bold text-gray-800">Manage Administrators</h1>
        <button onClick={handleOpenCreate} className="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 shadow">
          + Create New Admin
        </button>
      </div>

      {/* --- ANALYTICS HUD --- */}
      {stats && (
        <div className="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
          {/* Card 1: Total */}
          <div className="bg-white p-4 rounded-xl shadow border-l-4 border-blue-500">
            <h3 className="text-gray-500 text-xs font-bold uppercase">Total Admins</h3>
            <p className="text-3xl font-bold text-gray-800 mt-1">{stats.total_admins}</p>
          </div>

          {/* Card 2: Roles */}
          <div className="bg-white p-4 rounded-xl shadow border-l-4 border-purple-500">
            <h3 className="text-gray-500 text-xs font-bold uppercase mb-2">Role Distribution</h3>
            <div className="space-y-1 text-sm">
              <div className="flex justify-between"><span>Super:</span> <span className="font-bold">{stats.roles.super}</span></div>
              <div className="flex justify-between"><span>Municipality:</span> <span className="font-bold">{stats.roles.municipality}</span></div>
              <div className="flex justify-between"><span>Club:</span> <span className="font-bold">{stats.roles.club}</span></div>
            </div>
          </div>

          {/* Card 3: Gender */}
          <div className="bg-white p-4 rounded-xl shadow border-l-4 border-green-500">
            <h3 className="text-gray-500 text-xs font-bold uppercase mb-2">Gender Split</h3>
            <div className="space-y-1 text-sm">
              <div className="flex justify-between"><span>Male:</span> <span className="font-bold">{stats.gender.male}</span></div>
              <div className="flex justify-between"><span>Female:</span> <span className="font-bold">{stats.gender.female}</span></div>
              <div className="flex justify-between"><span>Other:</span> <span className="font-bold">{stats.gender.other}</span></div>
            </div>
          </div>

          {/* Card 4: Activity */}
          <div className="bg-white p-4 rounded-xl shadow border-l-4 border-orange-500">
            <h3 className="text-gray-500 text-xs font-bold uppercase mb-2">Engagement</h3>
            <div className="space-y-1 text-sm">
              <div className="flex justify-between">
                <span>Active (7d):</span> 
                <span className="font-bold text-green-600">{stats.activity.active_7_days}</span>
              </div>
              <div className="flex justify-between">
                <span>New (30d):</span> 
                <span className="font-bold text-blue-600">{stats.activity.new_30_days}</span>
              </div>
            </div>
          </div>
        </div>
      )}

      {/* --- FILTER BAR --- */}
      <div className="bg-white p-4 rounded-lg shadow mb-6 border border-gray-100">
        <div className="flex flex-wrap gap-4 items-end">
          <div className="w-48">
            <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Role</label>
            <select className="w-full border rounded p-2 text-sm bg-gray-50" value={searchParams.get('role') || ''} onChange={(e) => updateUrl('role', e.target.value)}>
              <option value="">All Roles</option>
              <option value="SUPER_ADMIN">Super Admin</option>
              <option value="MUNICIPALITY_ADMIN">Municipality Admin</option>
              <option value="CLUB_ADMIN">Club Admin</option>
            </select>
          </div>

          <div className="w-48">
            <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Municipality</label>
            <select className="w-full border rounded p-2 text-sm bg-gray-50" value={searchParams.get('assigned_municipality') || ''} onChange={(e) => updateUrl('assigned_municipality', e.target.value)}>
              <option value="">All Municipalities</option>
              {Array.isArray(municipalities) && municipalities.map(m => <option key={m.id} value={m.id.toString()}>{m.name}</option>)}
            </select>
          </div>

          <div className="w-48">
            <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Club</label>
            <select className="w-full border rounded p-2 text-sm bg-gray-50" value={searchParams.get('assigned_club') || ''} onChange={(e) => updateUrl('assigned_club', e.target.value)}>
              <option value="">All Clubs</option>
              {Array.isArray(clubs) && clubs.map(c => <option key={c.id} value={c.id.toString()}>{c.name}</option>)}
            </select>
          </div>

          <div className="w-32">
            <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Gender</label>
            <select className="w-full border rounded p-2 text-sm bg-gray-50" value={searchParams.get('legal_gender') || ''} onChange={(e) => updateUrl('legal_gender', e.target.value)}>
              <option value="">Any</option>
              <option value="MALE">Male</option>
              <option value="FEMALE">Female</option>
              <option value="OTHER">Other</option>
            </select>
          </div>

          <button onClick={() => router.push(pathname)} className="px-4 py-2 text-sm text-gray-500 hover:text-red-500 font-medium pb-2.5">
            Clear Filters
          </button>
        </div>
      </div>

      {/* --- LIST --- */}
      <div className="bg-white rounded-lg shadow overflow-hidden mb-6">
        {isLoading ? (
          <div className="p-8 text-center text-gray-500">Loading admins...</div>
        ) : users.length === 0 ? (
          <div className="p-8 text-center text-gray-500">No results found.</div>
        ) : (
          <table className="min-w-full divide-y divide-gray-200">
            <thead className="bg-gray-50">
              <tr>
                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">User</th>
                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Role</th>
                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Context</th>
                <th className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">Actions</th>
              </tr>
            </thead>
            <tbody className="bg-white divide-y divide-gray-200">
              {users.map((user) => (
                <tr key={user.id}>
                  <td className="px-6 py-4 whitespace-nowrap">
                    <div className="flex items-center">
                      {user.avatar && (
                        <img 
                          src={getMediaUrl(user.avatar) || ''}
                          alt="Avatar"
                          className="w-10 h-10 rounded-full object-cover mr-3"
                          onError={(e) => { (e.target as HTMLImageElement).style.display = 'none'; }}
                        />
                      )}
                      <div>
                        <div className="text-sm font-medium text-gray-900">{user.first_name} {user.last_name}</div>
                        <div className="text-sm text-gray-500">{user.email}</div>
                      </div>
                    </div>
                  </td>
                  <td className="px-6 py-4 whitespace-nowrap">
                    <span className={`px-2 inline-flex text-xs leading-5 font-semibold rounded-full 
                      ${user.role === 'SUPER_ADMIN' ? 'bg-red-100 text-red-800' : 
                        user.role === 'MUNICIPALITY_ADMIN' ? 'bg-purple-100 text-purple-800' : 
                        'bg-green-100 text-green-800'}`}>
                      {user.role.replace('_', ' ')}
                    </span>
                  </td>
                  <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                    {user.role === 'MUNICIPALITY_ADMIN' && (
                       Array.isArray(municipalities) ? municipalities.find(m => m.id === user.assigned_municipality)?.name || 'Unassigned' : 'Unassigned'
                    )}
                    {user.role === 'CLUB_ADMIN' && (
                       Array.isArray(clubs) ? clubs.find(c => c.id === user.assigned_club)?.name || 'Unassigned' : 'Unassigned'
                    )}
                    {user.role === 'SUPER_ADMIN' && 'Global'}
                  </td>
                  <td className="px-6 py-4 whitespace-nowrap text-right text-sm font-medium space-x-4">
                    <button onClick={() => handleOpenEdit(user)} className="text-indigo-600 hover:text-indigo-900 font-bold">Edit</button>
                    <button onClick={() => handleDelete(user.id)} className="text-red-600 hover:text-red-900">Delete</button>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        )}
      </div>

      {/* --- PAGINATION CONTROLS (KEPT EXISTING) --- */}
      <div className="flex items-center justify-between border-t border-gray-200 bg-white px-4 py-3 sm:px-6 rounded-lg shadow">
        <div className="flex flex-1 justify-between sm:hidden">
          <button 
            disabled={currentPage === 1}
            onClick={() => updateUrl('page', (currentPage - 1).toString())}
            className="relative inline-flex items-center rounded-md border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50 disabled:opacity-50"
          >
            Previous
          </button>
          <button 
            disabled={currentPage >= totalPages}
            onClick={() => updateUrl('page', (currentPage + 1).toString())}
            className="relative ml-3 inline-flex items-center rounded-md border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50 disabled:opacity-50"
          >
            Next
          </button>
        </div>
        <div className="hidden sm:flex sm:flex-1 sm:items-center sm:justify-between">
          <div>
            <p className="text-sm text-gray-700">
              Showing page <span className="font-medium">{currentPage}</span> of <span className="font-medium">{totalPages}</span>
              {' '}(Total: {totalCount})
            </p>
          </div>
          <div>
            <nav className="isolate inline-flex -space-x-px rounded-md shadow-sm" aria-label="Pagination">
              <button
                disabled={currentPage === 1}
                onClick={() => updateUrl('page', (currentPage - 1).toString())}
                className="relative inline-flex items-center rounded-l-md px-2 py-2 text-gray-400 ring-1 ring-inset ring-gray-300 hover:bg-gray-50 focus:z-20 focus:outline-offset-0 disabled:opacity-50"
              >
                <span className="sr-only">Previous</span>
                ‚Üê Prev
              </button>
              
              {/* Simple Pagination Numbers */}
              {[...Array(totalPages)].map((_, i) => {
                const p = i + 1;
                return (
                  <button
                    key={p}
                    onClick={() => updateUrl('page', p.toString())}
                    className={`relative inline-flex items-center px-4 py-2 text-sm font-semibold 
                      ${p === currentPage 
                        ? 'bg-blue-600 text-white focus:z-20 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-blue-600' 
                        : 'text-gray-900 ring-1 ring-inset ring-gray-300 hover:bg-gray-50 focus:z-20 focus:outline-offset-0'}`}
                  >
                    {p}
                  </button>
                );
              })}

              <button
                disabled={currentPage >= totalPages}
                onClick={() => updateUrl('page', (currentPage + 1).toString())}
                className="relative inline-flex items-center rounded-r-md px-2 py-2 text-gray-400 ring-1 ring-inset ring-gray-300 hover:bg-gray-50 focus:z-20 focus:outline-offset-0 disabled:opacity-50"
              >
                <span className="sr-only">Next</span>
                Next ‚Üí
              </button>
            </nav>
          </div>
        </div>
      </div>

      {/* --- MODAL --- */}
      {showModal && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-xl shadow-2xl w-full max-w-2xl p-8 max-h-[90vh] overflow-y-auto">
            <h2 className="text-2xl font-bold mb-6 text-gray-800">{isEditing ? 'Edit Admin' : 'Create Admin'}</h2>
            <form onSubmit={handleSubmit} className="space-y-6">
              
              {/* ADMIN TYPE */}
              <div className="grid grid-cols-3 gap-4">
                {['SUPER_ADMIN', 'MUNICIPALITY_ADMIN', 'CLUB_ADMIN'].map((role) => (
                  <button key={role} type="button" 
                    onClick={() => !isEditing && setAdminType(role)}
                    className={`py-3 px-2 rounded-lg text-sm font-bold border-2 transition
                      ${adminType === role ? 'border-blue-600 bg-blue-50 text-blue-700' : 'border-gray-200 text-gray-600'}
                      ${isEditing && adminType !== role ? 'opacity-50 cursor-not-allowed' : ''}
                    `}>
                    {role.replace('_', ' ')}
                  </button>
                ))}
              </div>

              {/* FIELDS */}
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <input required type="text" placeholder="First Name" className="border p-2 rounded" value={formData.first_name} onChange={e => setFormData({...formData, first_name: e.target.value})} />
                <input required type="text" placeholder="Last Name" className="border p-2 rounded" value={formData.last_name} onChange={e => setFormData({...formData, last_name: e.target.value})} />
                <input type="text" placeholder="Nickname" className="border p-2 rounded" value={formData.nickname} onChange={e => setFormData({...formData, nickname: e.target.value})} />
                <select className="border p-2 rounded" value={formData.legal_gender} onChange={e => setFormData({...formData, legal_gender: e.target.value})}>
                  <option value="MALE">Male</option> <option value="FEMALE">Female</option> <option value="OTHER">Other</option>
                </select>
                <input required type="email" placeholder="Email" className="border p-2 rounded" value={formData.email} onChange={e => setFormData({...formData, email: e.target.value})} />
                <input type="password" placeholder={isEditing ? "New Password" : "Password"} className="border p-2 rounded" required={!isEditing} value={formData.password} onChange={e => setFormData({...formData, password: e.target.value})} />
                <input type="text" placeholder="Phone" className="border p-2 rounded" value={formData.phone_number} onChange={e => setFormData({...formData, phone_number: e.target.value})} />
                {adminType === 'CLUB_ADMIN' && <input type="text" placeholder="Profession" className="border p-2 rounded" value={formData.profession} onChange={e => setFormData({...formData, profession: e.target.value})} />}
              </div>

              {/* AVATAR */}
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">Avatar</label>
                <input type="file" accept="image/jpeg,image/jpg,image/png,image/svg+xml,image/gif" className="w-full border p-2 rounded" onChange={handleAvatarChange} />
                <p className="text-xs text-gray-500 mt-1">Accepted formats: JPG, PNG, SVG, GIF</p>
                {avatarPreview && (
                  <div className="mt-2">
                    <p className="text-xs text-gray-500 mb-1">Preview:</p>
                    <img src={avatarPreview} alt="Preview" className="w-20 h-20 rounded-full object-cover border border-gray-300" />
                  </div>
                )}
              </div>

              {/* ASSIGNMENT */}
              <div className="bg-gray-50 p-4 rounded-lg border">
                {adminType === 'MUNICIPALITY_ADMIN' && (
                  <select className="w-full border p-2 rounded" value={formData.assigned_municipality} onChange={e => setFormData({...formData, assigned_municipality: e.target.value})} required>
                    <option value="">Select Municipality...</option>
                    {Array.isArray(municipalities) && municipalities.map(m => <option key={m.id} value={m.id.toString()}>{m.name}</option>)}
                  </select>
                )}
                {adminType === 'CLUB_ADMIN' && (
                  <select className="w-full border p-2 rounded" value={formData.assigned_club} onChange={e => setFormData({...formData, assigned_club: e.target.value})} required>
                    <option value="">Select Club...</option>
                    {Array.isArray(clubs) && clubs.map(c => <option key={c.id} value={c.id.toString()}>{c.name}</option>)}
                  </select>
                )}
              </div>

              <div className="flex items-center gap-2">
                <input type="checkbox" id="hideContact" checked={formData.hide_contact_info} onChange={e => setFormData({...formData, hide_contact_info: e.target.checked})} />
                <label htmlFor="hideContact" className="text-sm text-gray-700">Hide Contact Info</label>
              </div>

              <div className="flex justify-end gap-4 pt-4 border-t">
                <button type="button" onClick={() => setShowModal(false)} className="text-gray-500 hover:text-gray-700">Cancel</button>
                <button type="submit" className="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700">
                  {isEditing ? 'Save' : 'Create'}
                </button>
              </div>

            </form>
          </div>
        </div>
      )}
    </div>
  );
}

export default function ManageAdminsPage() {
  return (
    <Suspense fallback={<div className="p-8 text-center">Loading...</div>}>
      <ManageAdminsPageContent />
    </Suspense>
  );
}

--- END OF FILE: ./frontend/app/admin/super/admins/page.tsx ---


--- START OF FILE: ./frontend/app/admin/super/youth/page.tsx ---
'use client';

import { useState, useEffect, Suspense } from 'react';
import { useRouter, useSearchParams, usePathname } from 'next/navigation';
import Link from 'next/link';
import api from '../../../../lib/api';
import { getMediaUrl } from '../../../utils';

interface Option { id: number; name: string; }
interface GuardianOption { id: number; first_name: string; last_name: string; email: string; }

function ManageYouthPageContent() {
  const router = useRouter();
  const pathname = usePathname();
  const searchParams = useSearchParams();

  // --- STATE ---
  const [users, setUsers] = useState<any[]>([]);
  const [totalCount, setTotalCount] = useState(0);
  const [isLoading, setIsLoading] = useState(true);
  const [stats, setStats] = useState<any>(null);

  // Dropdowns
  const [clubs, setClubs] = useState<Option[]>([]);
  const [interests, setInterests] = useState<Option[]>([]);
  const [guardiansList, setGuardiansList] = useState<GuardianOption[]>([]);

  // Modal
  const [showModal, setShowModal] = useState(false);
  const [isEditing, setIsEditing] = useState(false);
  const [editUserId, setEditUserId] = useState<number | null>(null);
  const [avatarFile, setAvatarFile] = useState<File | null>(null);
  const [avatarPreview, setAvatarPreview] = useState<string | null>(null);

  const initialFormState = {
    email: '', password: '', first_name: '', last_name: '', nickname: '',
    legal_gender: 'MALE', preferred_gender: '', phone_number: '',
    date_of_birth: '', grade: '', preferred_club: '', 
    verification_status: 'UNVERIFIED',
    interests: [] as number[],
    guardians: [] as number[], // Array of Guardian IDs
  };

  const [formData, setFormData] = useState(initialFormState);

  // --- LOAD DATA ---
  useEffect(() => {
    fetchDropdowns();
    fetchStats();
  }, []);

  useEffect(() => {
    fetchYouth();
  }, [searchParams]);

  // Handle edit parameter from URL (e.g., from view page)
  useEffect(() => {
    const editId = searchParams.get('edit');
    if (editId && !isEditing && !showModal) {
      const userId = parseInt(editId);
      // Try to find user in current list first
      const userToEdit = users.find(u => u.id === userId);
      if (userToEdit) {
        handleOpenEdit(userToEdit);
      } else if (users.length > 0) {
        // User not in current page, fetch it directly
        api.get(`/users/${userId}/`).then(res => {
          handleOpenEdit(res.data);
        }).catch(err => {
          console.error('Failed to load user for editing:', err);
        });
      }
    }
  }, [searchParams, users.length, isEditing, showModal]);

  const fetchStats = async () => {
    try {
      const res = await api.get('/users/youth_stats/');
      setStats(res.data);
    } catch (err) { console.error(err); }
  };

  const fetchDropdowns = async () => {
    try {
      const clubRes = await api.get('/clubs/');
      setClubs(Array.isArray(clubRes.data) ? clubRes.data : (clubRes.data?.results || []));
      
      const interestRes = await api.get('/interests/');
      setInterests(Array.isArray(interestRes.data) ? interestRes.data : (interestRes.data?.results || []));

      const guardianRes = await api.get('/users/list_guardians/');
      setGuardiansList(guardianRes.data);
    } catch (err) { console.error(err); }
  };

  const fetchYouth = async () => {
    setIsLoading(true);
    try {
      const params = new URLSearchParams(searchParams.toString());
      params.set('role', 'YOUTH_MEMBER');
      
      const res = await api.get(`/users/?${params.toString()}`);
      setUsers(res.data.results);
      setTotalCount(res.data.count);
    } catch (err) { console.error(err); } 
    finally { setIsLoading(false); }
  };

  const updateUrl = (key: string, value: string) => {
    const params = new URLSearchParams(searchParams.toString());
    if (value) params.set(key, value); else params.delete(key);
    if (key !== 'page') params.set('page', '1');
    router.push(`${pathname}?${params.toString()}`);
  };

  // --- HANDLERS ---
  const handleOpenCreate = () => {
    setIsEditing(false);
    setEditUserId(null);
    setFormData(initialFormState);
    setAvatarFile(null);
    setAvatarPreview(null);
    setShowModal(true);
  };

  const handleOpenEdit = (user: any) => {
    setIsEditing(true);
    setEditUserId(user.id);
    
    // Normalize interests/guardians (handle API variations)
    const interestIds = user.interests?.map((i: any) => typeof i === 'object' ? i.id : i) || [];
    // The serializer now returns 'guardians' as a list of IDs directly
    const guardianIds = user.guardians || [];
    
    setFormData({
      email: user.email, password: '', 
      first_name: user.first_name || '', last_name: user.last_name || '',
      nickname: user.nickname || '', 
      legal_gender: user.legal_gender || 'MALE', preferred_gender: user.preferred_gender || '',
      phone_number: user.phone_number || '', 
      date_of_birth: user.date_of_birth || '',
      grade: user.grade || '', 
      preferred_club: user.preferred_club || '',
      verification_status: user.verification_status || 'UNVERIFIED',
      interests: interestIds,
      guardians: guardianIds
    });
    setAvatarFile(null);
    setAvatarPreview(user.avatar ? getMediaUrl(user.avatar) : null);
    setShowModal(true);
  };

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    try {
      const data = new FormData();
      
      // Basic fields
      Object.entries(formData).forEach(([key, value]) => {
        if (key === 'password' && !value) return;
        if (key === 'interests') return; 
        if (key === 'guardians') return;
        data.append(key, value.toString());
      });
      
      // Handle Arrays
      formData.interests.forEach(id => data.append('interests', id.toString()));
      formData.guardians.forEach(id => data.append('guardians', id.toString()));
      
      data.append('role', 'YOUTH_MEMBER');
      if (avatarFile) data.append('avatar', avatarFile);

      const config = { headers: { 'Content-Type': 'multipart/form-data' } };
      if (isEditing && editUserId) await api.patch(`/users/${editUserId}/`, data, config);
      else await api.post('/users/', data, config);

      setShowModal(false);
      fetchYouth();
      fetchStats();
    } catch (err) { alert('Operation failed.'); console.error(err); }
  };

  const handleDelete = async (id: number) => {
    if (!window.confirm("Are you sure?")) return;
    try { await api.delete(`/users/${id}/`); fetchYouth(); fetchStats(); } 
    catch (err) { alert("Failed to delete."); }
  };

  const handleAvatarChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (file) {
      setAvatarFile(file);
      const reader = new FileReader();
      reader.onloadend = () => setAvatarPreview(reader.result as string);
      reader.readAsDataURL(file);
    }
  };

  const toggleInterest = (id: number) => {
    setFormData(prev => {
      const exists = prev.interests.includes(id);
      if (exists) return { ...prev, interests: prev.interests.filter(i => i !== id) };
      return { ...prev, interests: [...prev.interests, id] };
    });
  };

  const toggleGuardian = (id: number) => {
    setFormData(prev => {
      const exists = prev.guardians.includes(id);
      if (exists) return { ...prev, guardians: prev.guardians.filter(i => i !== id) };
      return { ...prev, guardians: [...prev.guardians, id] };
    });
  };

  const currentPage = Number(searchParams.get('page')) || 1;
  const totalPages = Math.ceil(totalCount / 10);

  return (
    <div>
      <div className="flex justify-between items-center mb-6">
        <h1 className="text-2xl font-bold text-gray-800">Manage Youth Members</h1>
        <button onClick={handleOpenCreate} className="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 shadow">
          + Create New Member
        </button>
      </div>

      {/* --- STATS HUD --- */}
      {stats && (
        <div className="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
          <div className="bg-white p-4 rounded-xl shadow border-l-4 border-blue-500">
            <h3 className="text-gray-500 text-xs font-bold uppercase">Total Youth</h3>
            <p className="text-3xl font-bold text-gray-800 mt-1">{stats.total_youth}</p>
          </div>
          <div className="bg-white p-4 rounded-xl shadow border-l-4 border-purple-500">
             <h3 className="text-gray-500 text-xs font-bold uppercase mb-2">Active (7 Days)</h3>
             <p className="text-3xl font-bold text-green-600">{stats.activity.active_7_days}</p>
          </div>
          <div className="bg-white p-4 rounded-xl shadow border-l-4 border-orange-500 col-span-2">
            <h3 className="text-gray-500 text-xs font-bold uppercase mb-2">Grade Breakdown</h3>
            <div className="flex gap-4 overflow-x-auto text-sm">
                {Object.entries(stats.grades).map(([grade, count]: any) => (
                    <div key={grade} className="bg-orange-50 px-3 py-1 rounded border border-orange-100">
                        Gr {grade}: <strong>{count}</strong>
                    </div>
                ))}
            </div>
          </div>
        </div>
      )}

      {/* --- FILTER BAR --- */}
      <div className="bg-white p-4 rounded-lg shadow mb-6 border border-gray-100 flex gap-4">
        <div className="w-48">
          <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Club</label>
          <select className="w-full border rounded p-2 text-sm bg-gray-50" value={searchParams.get('assigned_club') || ''} onChange={e => updateUrl('assigned_club', e.target.value)}>
            <option value="">All Clubs</option>
            {clubs.map(c => <option key={c.id} value={c.id.toString()}>{c.name}</option>)}
        </select>
        </div>
        <div className="w-32">
          <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Gender</label>
          <select className="w-full border rounded p-2 text-sm bg-gray-50" value={searchParams.get('legal_gender') || ''} onChange={e => updateUrl('legal_gender', e.target.value)}>
            <option value="">Any</option>
            <option value="MALE">Male</option> <option value="FEMALE">Female</option> <option value="OTHER">Other</option>
          </select>
        </div>
        <button onClick={() => router.push(pathname)} className="px-4 py-2 text-sm text-gray-500 hover:text-red-500 mt-5">Clear</button>
      </div>

      {/* --- LIST --- */}
      <div className="bg-white rounded-lg shadow overflow-hidden mb-6">
        <table className="min-w-full divide-y divide-gray-200">
          <thead className="bg-gray-50">
            <tr>
              <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">User</th>
              <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
              <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Grade / DOB</th>
              <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Club</th>
              <th className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">Actions</th>
            </tr>
          </thead>
          <tbody className="bg-white divide-y divide-gray-200">
            {users.map((user) => (
              <tr key={user.id}>
                <td className="px-6 py-4 whitespace-nowrap">
                  <div className="flex items-center">
                    {user.avatar && <img src={getMediaUrl(user.avatar) || ''} className="w-10 h-10 rounded-full mr-3 object-cover" onError={(e) => (e.target as HTMLImageElement).style.display='none'} />}
                    <div>
                        <div className="text-sm font-medium text-gray-900">{user.first_name} {user.last_name}</div>
                        <div className="text-xs text-gray-500">{user.email}</div>
                    </div>
                  </div>
                </td>
                <td className="px-6 py-4 whitespace-nowrap">
                   <span className={`px-2 py-1 text-xs font-bold rounded-full ${
                       user.verification_status === 'VERIFIED' ? 'bg-green-100 text-green-800' :
                       user.verification_status === 'PENDING' ? 'bg-yellow-100 text-yellow-800' :
                       'bg-gray-100 text-gray-600'
                   }`}>
                       {user.verification_status || 'UNVERIFIED'}
                   </span>
                </td>
                <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                  Grade: <span className="font-bold">{user.grade || '-'}</span><br/>
                  <span className="text-xs">{user.date_of_birth}</span>
                </td>
                <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                  {clubs.find(c => c.id === user.preferred_club)?.name || '-'}
                </td>
                <td className="px-6 py-4 whitespace-nowrap text-right text-sm font-medium space-x-4">
                  <Link href={`/admin/super/youth/${user.id}`} className="text-blue-600 hover:text-blue-900 font-bold">View</Link>
                  <button onClick={() => handleOpenEdit(user)} className="text-indigo-600 hover:text-indigo-900 font-bold">Edit</button>
                  <button onClick={() => handleDelete(user.id)} className="text-red-600 hover:text-red-900">Delete</button>
                </td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>

       {/* --- PAGINATION --- */}
       <div className="flex items-center justify-between border-t border-gray-200 bg-white px-4 py-3 sm:px-6 rounded-lg shadow">
          <div className="hidden sm:flex sm:flex-1 sm:items-center sm:justify-between">
            <p className="text-sm text-gray-700">Page {currentPage} of {totalPages}</p>
            <nav className="isolate inline-flex -space-x-px rounded-md shadow-sm">
                <button disabled={currentPage === 1} onClick={() => updateUrl('page', (currentPage - 1).toString())} className="relative inline-flex items-center rounded-l-md px-2 py-2 text-gray-400 ring-1 ring-inset ring-gray-300 hover:bg-gray-50 disabled:opacity-50">Prev</button>
                <button disabled={currentPage >= totalPages} onClick={() => updateUrl('page', (currentPage + 1).toString())} className="relative inline-flex items-center rounded-r-md px-2 py-2 text-gray-400 ring-1 ring-inset ring-gray-300 hover:bg-gray-50 disabled:opacity-50">Next</button>
            </nav>
          </div>
       </div>

      {/* --- MODAL --- */}
      {showModal && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-xl shadow-2xl w-full max-w-2xl p-8 max-h-[90vh] overflow-y-auto">
            <h2 className="text-2xl font-bold mb-6 text-gray-800">{isEditing ? 'Edit Youth' : 'Create Youth'}</h2>
            <form onSubmit={handleSubmit} className="space-y-6">
              
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <input required type="text" placeholder="First Name" className="border p-2 rounded" value={formData.first_name} onChange={e => setFormData({...formData, first_name: e.target.value})} />
                <input required type="text" placeholder="Last Name" className="border p-2 rounded" value={formData.last_name} onChange={e => setFormData({...formData, last_name: e.target.value})} />
                <input type="text" placeholder="Nickname" className="border p-2 rounded" value={formData.nickname} onChange={e => setFormData({...formData, nickname: e.target.value})} />
                
                <input required type="email" placeholder="Email" className="border p-2 rounded" value={formData.email} onChange={e => setFormData({...formData, email: e.target.value})} />
                <input type="password" placeholder={isEditing ? "New Password" : "Password"} className="border p-2 rounded" required={!isEditing} value={formData.password} onChange={e => setFormData({...formData, password: e.target.value})} />
                <input type="text" placeholder="Phone" className="border p-2 rounded" value={formData.phone_number} onChange={e => setFormData({...formData, phone_number: e.target.value})} />
              </div>

              {/* VERIFICATION (Admin Only) */}
              <div className="bg-blue-50 p-4 rounded-lg border border-blue-100">
                  <label className="block text-sm font-bold text-blue-800 mb-2">Verification Status</label>
                  <div className="flex gap-4">
                      {['UNVERIFIED', 'PENDING', 'VERIFIED'].map(status => (
                          <label key={status} className="flex items-center space-x-2 cursor-pointer">
                              <input 
                                  type="radio" 
                                  name="verification_status"
                                  value={status}
                                  checked={formData.verification_status === status}
                                  onChange={e => setFormData({...formData, verification_status: e.target.value})}
                                  className="text-blue-600"
                              />
                              <span className="text-sm font-medium">{status}</span>
                          </label>
                      ))}
                  </div>
              </div>

              {/* DEMOGRAPHICS */}
              <div className="bg-gray-50 p-4 rounded-lg border grid grid-cols-2 gap-4">
                  <div>
                      <label className="block text-xs font-bold uppercase text-gray-500 mb-1">Date of Birth</label>
                      <input type="date" className="w-full border p-2 rounded" value={formData.date_of_birth} onChange={e => setFormData({...formData, date_of_birth: e.target.value})} />
                  </div>
                  <div>
                      <label className="block text-xs font-bold uppercase text-gray-500 mb-1">Grade</label>
                      <input type="number" placeholder="e.g. 7" className="w-full border p-2 rounded" value={formData.grade} onChange={e => setFormData({...formData, grade: e.target.value})} />
                  </div>
                  <div>
                    <label className="block text-xs font-bold uppercase text-gray-500 mb-1">Legal Gender</label>
                    <select className="w-full border p-2 rounded" value={formData.legal_gender} onChange={e => setFormData({...formData, legal_gender: e.target.value})}>
                        <option value="MALE">Male</option> <option value="FEMALE">Female</option> <option value="OTHER">Other</option>
                    </select>
                  </div>
                  <div>
                    <label className="block text-xs font-bold uppercase text-gray-500 mb-1">Preferred Gender</label>
                    <input type="text" className="w-full border p-2 rounded" value={formData.preferred_gender} onChange={e => setFormData({...formData, preferred_gender: e.target.value})} />
                  </div>
              </div>

              {/* GUARDIANS & CLUB & INTERESTS */}
              <div>
                  <label className="block text-sm font-bold mb-2">Preferred Club</label>
                  <select className="w-full border p-2 rounded mb-4" value={formData.preferred_club} onChange={e => setFormData({...formData, preferred_club: e.target.value})}>
                      <option value="">Select Club...</option>
                      {clubs.map(c => <option key={c.id} value={c.id}>{c.name}</option>)}
                  </select>

                  <label className="block text-sm font-bold mb-2">Assign Guardians</label>
                  <div className="grid grid-cols-2 gap-2 border p-3 rounded max-h-40 overflow-y-auto bg-gray-50 mb-4">
                      {guardiansList.map(g => (
                          <label key={g.id} className="flex items-center space-x-2 text-sm cursor-pointer hover:bg-gray-100 p-1 rounded">
                              <input 
                                  type="checkbox" 
                                  checked={formData.guardians.includes(g.id)}
                                  onChange={() => toggleGuardian(g.id)}
                                  className="rounded text-green-600"
                              />
                              <span>{g.first_name} {g.last_name} ({g.email})</span>
                          </label>
                      ))}
                      {guardiansList.length === 0 && <span className="text-gray-400 text-xs">No guardians found. Create a guardian first.</span>}
                  </div>

                  <label className="block text-sm font-bold mb-2">Interests</label>
                  <div className="grid grid-cols-3 gap-2 border p-3 rounded max-h-40 overflow-y-auto bg-gray-50">
                      {interests.length > 0 ? (
                          interests.map(interest => (
                              <label key={interest.id} className="flex items-center space-x-2 text-sm cursor-pointer hover:bg-gray-100 p-1 rounded">
                                  <input 
                                      type="checkbox" 
                                      checked={formData.interests.includes(interest.id)}
                                      onChange={() => toggleInterest(interest.id)}
                                      className="rounded text-blue-600"
                                  />
                                  <span>{interest.name}</span>
                              </label>
                          ))
                      ) : (
                          <span className="text-gray-400 text-xs col-span-3">No interests found. Please create interests in the admin panel.</span>
                      )}
                  </div>
              </div>

               {/* AVATAR */}
               <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">Avatar</label>
                <input type="file" accept="image/*" className="w-full border p-2 rounded" onChange={handleAvatarChange} />
                {avatarPreview && <img src={avatarPreview} alt="Preview" className="w-16 h-16 mt-2 rounded-full object-cover border" />}
              </div>

              <div className="flex justify-end gap-4 pt-4 border-t">
                <button type="button" onClick={() => setShowModal(false)} className="text-gray-500">Cancel</button>
                <button type="submit" className="bg-blue-600 text-white px-6 py-2 rounded">
                  {isEditing ? 'Save Changes' : 'Create Youth'}
                </button>
              </div>
            </form>
          </div>
        </div>
      )}

    </div>
  );
}

export default function ManageYouthPage() {
  return (
    <Suspense fallback={<div>Loading...</div>}>
      <ManageYouthPageContent />
    </Suspense>
  );
}

--- END OF FILE: ./frontend/app/admin/super/youth/page.tsx ---


--- START OF FILE: ./frontend/app/admin/super/youth/[id]/page.tsx ---
'use client';

import { useState, useEffect, Suspense } from 'react';
import { useRouter, useParams } from 'next/navigation';
import Link from 'next/link';
import api from '../../../../../lib/api';
import { getMediaUrl } from '../../../../utils';

interface Option { id: number; name: string; }
interface GuardianOption { id: number; first_name: string; last_name: string; email: string; }

function YouthViewPageContent() {
  const router = useRouter();
  const params = useParams();
  const youthId = params?.id as string;

  const [user, setUser] = useState<any>(null);
  const [clubs, setClubs] = useState<Option[]>([]);
  const [interests, setInterests] = useState<Option[]>([]);
  const [guardiansList, setGuardiansList] = useState<GuardianOption[]>([]);
  const [isLoading, setIsLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);

  useEffect(() => {
    if (youthId) {
      fetchData();
    }
  }, [youthId]);

  const fetchData = async () => {
    setIsLoading(true);
    setError(null);
    try {
      // Fetch user data
      const userRes = await api.get(`/users/${youthId}/`);
      setUser(userRes.data);

      // Fetch dropdowns for display
      const clubRes = await api.get('/clubs/');
      setClubs(Array.isArray(clubRes.data) ? clubRes.data : (clubRes.data?.results || []));
      
      const interestRes = await api.get('/interests/');
      setInterests(Array.isArray(interestRes.data) ? interestRes.data : (interestRes.data?.results || []));

      const guardianRes = await api.get('/users/list_guardians/');
      setGuardiansList(guardianRes.data);
    } catch (err: any) {
      setError(err?.response?.status === 404 ? 'Youth member not found' : 'Failed to load youth member');
      console.error(err);
    } finally {
      setIsLoading(false);
    }
  };

  // Calculate age from date of birth
  const calculateAge = (dateOfBirth: string | null) => {
    if (!dateOfBirth) return null;
    const today = new Date();
    const birthDate = new Date(dateOfBirth);
    let age = today.getFullYear() - birthDate.getFullYear();
    const monthDiff = today.getMonth() - birthDate.getMonth();
    if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
      age--;
    }
    return age;
  };

  if (isLoading) {
    return (
      <div className="p-8 text-center">
        <p className="text-gray-500">Loading youth member details...</p>
      </div>
    );
  }

  if (error || !user) {
    return (
      <div className="p-8">
        <div className="bg-red-50 border border-red-200 rounded-lg p-4 mb-4">
          <p className="text-red-800">{error || 'Youth member not found'}</p>
        </div>
        <Link href="/admin/super/youth" className="text-blue-600 hover:text-blue-800">
          ‚Üê Back to Youth Members
        </Link>
      </div>
    );
  }

  // Normalize interests/guardians (handle API variations)
  const interestIds = user.interests?.map((i: any) => typeof i === 'object' ? i.id : i) || [];
  const guardianIds = user.guardians || [];

  return (
    <div className="p-8">
      {/* HEADER */}
      <div className="flex items-center justify-between mb-6">
        <Link href="/admin/super/youth" className="text-blue-600 hover:text-blue-800 font-medium">
          ‚Üê Back to Youth Members
        </Link>
        <div className="flex gap-4">
          <button
            onClick={() => router.push(`/admin/super/youth?edit=${user.id}`)}
            className="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700"
          >
            Edit Profile
          </button>
        </div>
      </div>

      {/* PROFILE HEADER */}
      <div className="bg-white rounded-xl shadow-lg overflow-hidden mb-6">
        <div className="p-8">
          <div className="flex items-center gap-6 pb-6 border-b">
            {user.avatar && (
              <img 
                src={getMediaUrl(user.avatar) || ''} 
                alt={`${user.first_name} ${user.last_name}`}
                className="w-32 h-32 rounded-full object-cover border-4 border-gray-200"
                onError={(e) => (e.target as HTMLImageElement).style.display='none'} 
              />
            )}
            <div className="flex-1">
              <h1 className="text-4xl font-bold text-gray-900 mb-2">
                {user.first_name} {user.last_name}
                {user.nickname && <span className="text-2xl font-normal text-gray-500 ml-3">({user.nickname})</span>}
              </h1>
              <p className="text-lg text-gray-600 mb-3">{user.email}</p>
              <div className="flex items-center gap-4">
                <span className={`px-3 py-1 text-xs font-bold rounded-full ${
                  user.verification_status === 'VERIFIED' ? 'bg-green-100 text-green-800' :
                  user.verification_status === 'PENDING' ? 'bg-yellow-100 text-yellow-800' :
                  'bg-gray-100 text-gray-600'
                }`}>
                  {user.verification_status || 'UNVERIFIED'}
                </span>
                {user.phone_number && (
                  <span className="text-sm text-gray-600">üìû {user.phone_number}</span>
                )}
                {user.is_active !== undefined && (
                  <span className={`px-2 py-1 rounded text-xs font-bold ${
                    user.is_active ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'
                  }`}>
                    {user.is_active ? 'Active' : 'Inactive'}
                  </span>
                )}
              </div>
            </div>
          </div>
        </div>
      </div>

      <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
        {/* MAIN CONTENT */}
        <div className="lg:col-span-2 space-y-6">
          {/* BASIC INFORMATION */}
          <div className="bg-white rounded-xl shadow p-6">
            <h2 className="text-2xl font-bold text-gray-800 mb-4">Basic Information</h2>
            <div className="grid grid-cols-2 gap-4">
              <div>
                <p className="text-sm text-gray-500 font-bold uppercase mb-1">First Name</p>
                <p className="text-gray-900 font-medium">{user.first_name || '-'}</p>
              </div>
              <div>
                <p className="text-sm text-gray-500 font-bold uppercase mb-1">Last Name</p>
                <p className="text-gray-900 font-medium">{user.last_name || '-'}</p>
              </div>
              <div>
                <p className="text-sm text-gray-500 font-bold uppercase mb-1">Email</p>
                <p className="text-gray-900 font-medium">{user.email || '-'}</p>
              </div>
              <div>
                <p className="text-sm text-gray-500 font-bold uppercase mb-1">Phone Number</p>
                <p className="text-gray-900 font-medium">{user.phone_number || '-'}</p>
              </div>
              <div>
                <p className="text-sm text-gray-500 font-bold uppercase mb-1">Date of Birth</p>
                <p className="text-gray-900 font-medium">{user.date_of_birth || '-'}</p>
              </div>
              <div>
                <p className="text-sm text-gray-500 font-bold uppercase mb-1">Age</p>
                <p className="text-gray-900 font-medium">{calculateAge(user.date_of_birth) || '-'}</p>
              </div>
            </div>
          </div>

          {/* DEMOGRAPHICS */}
          <div className="bg-white rounded-xl shadow p-6">
            <h2 className="text-2xl font-bold text-gray-800 mb-4">Demographics</h2>
            <div className="grid grid-cols-2 gap-4">
              <div>
                <p className="text-sm text-gray-500 font-bold uppercase mb-1">Grade</p>
                <p className="text-gray-900 font-medium">{user.grade || '-'}</p>
              </div>
              <div>
                <p className="text-sm text-gray-500 font-bold uppercase mb-1">Legal Gender</p>
                <p className="text-gray-900 font-medium">{user.legal_gender || '-'}</p>
              </div>
              <div>
                <p className="text-sm text-gray-500 font-bold uppercase mb-1">Preferred Gender</p>
                <p className="text-gray-900 font-medium">{user.preferred_gender || '-'}</p>
              </div>
              <div>
                <p className="text-sm text-gray-500 font-bold uppercase mb-1">Preferred Club</p>
                <p className="text-gray-900 font-medium">
                  {clubs.find(c => c.id === user.preferred_club)?.name || '-'}
                </p>
              </div>
            </div>
          </div>

          {/* GUARDIANS */}
          {guardianIds.length > 0 && (
            <div className="bg-white rounded-xl shadow p-6">
              <h2 className="text-2xl font-bold text-gray-800 mb-4">Assigned Guardians</h2>
              <div className="space-y-3">
                {guardianIds.map((guardianId: number) => {
                  const guardian = guardiansList.find(g => g.id === guardianId);
                  return guardian ? (
                    <div key={guardianId} className="flex items-center gap-3 p-3 bg-gray-50 rounded-lg border">
                      <div className="flex-1">
                        <p className="text-sm font-medium text-gray-900">
                          {guardian.first_name} {guardian.last_name}
                        </p>
                        <p className="text-xs text-gray-500">{guardian.email}</p>
                      </div>
                    </div>
                  ) : null;
                })}
              </div>
            </div>
          )}

          {/* INTERESTS */}
          {interestIds.length > 0 && (
            <div className="bg-white rounded-xl shadow p-6">
              <h2 className="text-2xl font-bold text-gray-800 mb-4">Interests</h2>
              <div className="flex flex-wrap gap-2">
                {interestIds.map((interestId: number) => {
                  const interestData = interests.find(i => i.id === interestId);
                  return interestData ? (
                    <span 
                      key={interestId}
                      className="px-3 py-1 bg-blue-100 text-blue-800 text-sm font-medium rounded-full"
                    >
                      {interestData.name}
                    </span>
                  ) : null;
                })}
              </div>
            </div>
          )}
        </div>

        {/* SIDEBAR */}
        <div className="space-y-6">
          {/* ACCOUNT INFO */}
          <div className="bg-white rounded-xl shadow p-6">
            <h3 className="text-lg font-bold text-gray-800 mb-4">Account Information</h3>
            <div className="space-y-3">
              <div>
                <p className="text-xs text-gray-500 font-bold uppercase mb-1">Date Joined</p>
                <p className="text-sm font-medium">
                  {user.date_joined ? new Date(user.date_joined).toLocaleDateString() : '-'}
                </p>
              </div>
              <div>
                <p className="text-xs text-gray-500 font-bold uppercase mb-1">Last Login</p>
                <p className="text-sm font-medium">
                  {user.last_login ? new Date(user.last_login).toLocaleDateString() : 'Never'}
                </p>
              </div>
              <div>
                <p className="text-xs text-gray-500 font-bold uppercase mb-1">Account Status</p>
                <span className={`inline-block px-2 py-1 rounded text-xs font-bold ${
                  user.is_active ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'
                }`}>
                  {user.is_active ? 'Active' : 'Inactive'}
                </span>
              </div>
              <div>
                <p className="text-xs text-gray-500 font-bold uppercase mb-1">Preferred Language</p>
                <p className="text-sm font-medium">{user.preferred_language || '-'}</p>
              </div>
            </div>
          </div>

          {/* ACTIONS */}
          <div className="bg-white rounded-xl shadow p-6">
            <h3 className="text-lg font-bold text-gray-800 mb-4">Actions</h3>
            <div className="space-y-2">
              <button
                onClick={() => router.push(`/admin/super/youth?edit=${user.id}`)}
                className="w-full bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 text-center"
              >
                Edit Profile
              </button>
              <Link
                href="/admin/super/youth"
                className="block w-full bg-gray-100 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-200 text-center"
              >
                Back to List
              </Link>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
}

export default function YouthViewPage() {
  return (
    <Suspense fallback={<div className="p-8 text-center">Loading...</div>}>
      <YouthViewPageContent />
    </Suspense>
  );
}


--- END OF FILE: ./frontend/app/admin/super/youth/[id]/page.tsx ---


--- START OF FILE: ./frontend/app/admin/super/guardians/page.tsx ---
'use client';

import { useState, useEffect, Suspense } from 'react';
import { useRouter, useSearchParams, usePathname } from 'next/navigation';
import Link from 'next/link';
import api from '../../../../lib/api';
import { getMediaUrl } from '../../../utils';

interface YouthOption { id: number; first_name: string; last_name: string; email: string; grade: number; }

function ManageGuardiansPageContent() {
  const router = useRouter();
  const pathname = usePathname();
  const searchParams = useSearchParams();

  // --- STATE ---
  const [users, setUsers] = useState<any[]>([]);
  const [totalCount, setTotalCount] = useState(0);
  const [isLoading, setIsLoading] = useState(true);
  const [stats, setStats] = useState<any>(null);

  // Dropdowns
  const [youthList, setYouthList] = useState<YouthOption[]>([]);

  // Modal
  const [showModal, setShowModal] = useState(false);
  const [isEditing, setIsEditing] = useState(false);
  const [editUserId, setEditUserId] = useState<number | null>(null);
  const [avatarFile, setAvatarFile] = useState<File | null>(null);
  const [avatarPreview, setAvatarPreview] = useState<string | null>(null);

  const initialFormState = {
    email: '', password: '', first_name: '', last_name: '', 
    phone_number: '', legal_gender: 'MALE',
    verification_status: 'UNVERIFIED',
    youth_members: [] as number[], // Array of Youth IDs
  };

  const [formData, setFormData] = useState(initialFormState);

  // --- LOAD DATA ---
  useEffect(() => {
    fetchDropdowns();
    fetchStats();
  }, []);

  useEffect(() => {
    fetchGuardians();
  }, [searchParams]);

  // Handle edit parameter from URL (e.g., from view page)
  useEffect(() => {
    const editId = searchParams.get('edit');
    if (editId && !isEditing && !showModal) {
      const userId = parseInt(editId);
      // Try to find user in current list first
      const userToEdit = users.find(u => u.id === userId);
      if (userToEdit) {
        handleOpenEdit(userToEdit);
      } else if (users.length > 0) {
        // User not in current page, fetch it directly
        api.get(`/users/${userId}/`).then(res => {
          handleOpenEdit(res.data);
        }).catch(err => {
          console.error('Failed to load user for editing:', err);
        });
      }
    }
  }, [searchParams, users.length, isEditing, showModal]);

  const fetchStats = async () => {
    try {
      const res = await api.get('/users/guardian_stats/');
      setStats(res.data);
    } catch (err) { console.error(err); }
  };

  const fetchDropdowns = async () => {
    try {
      const youthRes = await api.get('/users/list_youth/');
      setYouthList(youthRes.data);
    } catch (err) { console.error(err); }
  };

  const fetchGuardians = async () => {
    setIsLoading(true);
    try {
      const params = new URLSearchParams();
      // Always force role to GUARDIAN - this page only shows guardians
      params.set('role', 'GUARDIAN');
      
      // Copy other filters from URL (except role which we override)
      const gender = searchParams.get('legal_gender');
      if (gender) params.set('legal_gender', gender);
      
      const page = searchParams.get('page');
      if (page) params.set('page', page);
      
      const res = await api.get(`/users/?${params.toString()}`);
      
      // Double-check: Filter out any non-guardians on the frontend as a safety measure
      const guardiansOnly = (res.data.results || []).filter((user: any) => user.role === 'GUARDIAN');
      
      setUsers(guardiansOnly);
      // Update count to reflect filtered results
      setTotalCount(guardiansOnly.length);
    } catch (err) { 
      console.error('Error fetching guardians:', err); 
    } 
    finally { setIsLoading(false); }
  };

  const updateUrl = (key: string, value: string) => {
    const params = new URLSearchParams(searchParams.toString());
    if (value) params.set(key, value); else params.delete(key);
    if (key !== 'page') params.set('page', '1');
    router.push(`${pathname}?${params.toString()}`);
  };

  // --- HANDLERS ---
  const handleOpenCreate = () => {
    setIsEditing(false);
    setEditUserId(null);
    setFormData(initialFormState);
    setAvatarFile(null);
    setAvatarPreview(null);
    setShowModal(true);
  };

  const handleOpenEdit = (user: any) => {
    setIsEditing(true);
    setEditUserId(user.id);
    
    // The serializer now returns 'youth_members' as a list of IDs
    const youthIds = user.youth_members || [];
    
    setFormData({
      email: user.email, password: '', 
      first_name: user.first_name || '', last_name: user.last_name || '',
      phone_number: user.phone_number || '',
      legal_gender: user.legal_gender || 'MALE',
      verification_status: user.verification_status || 'UNVERIFIED',
      youth_members: youthIds
    });
    setAvatarFile(null);
    setAvatarPreview(user.avatar ? getMediaUrl(user.avatar) : null);
    setShowModal(true);
  };

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    try {
      const data = new FormData();
      
      // Basic fields
      Object.entries(formData).forEach(([key, value]) => {
        if (key === 'password' && !value) return;
        if (key === 'youth_members') return;
        data.append(key, value.toString());
      });
      
      // Handle Youth Array
      formData.youth_members.forEach(id => data.append('youth_members', id.toString()));
      
      data.append('role', 'GUARDIAN');
      if (avatarFile) data.append('avatar', avatarFile);

      const config = { headers: { 'Content-Type': 'multipart/form-data' } };
      if (isEditing && editUserId) await api.patch(`/users/${editUserId}/`, data, config);
      else await api.post('/users/', data, config);

      setShowModal(false);
      fetchGuardians();
      fetchStats();
    } catch (err) { alert('Operation failed.'); console.error(err); }
  };

  const handleDelete = async (id: number) => {
    if (!window.confirm("Are you sure?")) return;
    try { await api.delete(`/users/${id}/`); fetchGuardians(); fetchStats(); } 
    catch (err) { alert("Failed to delete."); }
  };

  const handleAvatarChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (file) {
      setAvatarFile(file);
      const reader = new FileReader();
      reader.onloadend = () => setAvatarPreview(reader.result as string);
      reader.readAsDataURL(file);
    }
  };

  const toggleYouth = (id: number) => {
    setFormData(prev => {
      const exists = prev.youth_members.includes(id);
      if (exists) return { ...prev, youth_members: prev.youth_members.filter(i => i !== id) };
      return { ...prev, youth_members: [...prev.youth_members, id] };
    });
  };

  const currentPage = Number(searchParams.get('page')) || 1;
  const totalPages = Math.ceil(totalCount / 10);

  return (
    <div>
      <div className="flex justify-between items-center mb-6">
        <h1 className="text-2xl font-bold text-gray-800">Manage Guardians</h1>
        <button onClick={handleOpenCreate} className="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 shadow">
          + Create New Guardian
        </button>
      </div>

      {/* --- STATS HUD --- */}
      {stats && (
        <div className="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
          <div className="bg-white p-4 rounded-xl shadow border-l-4 border-blue-500">
            <h3 className="text-gray-500 text-xs font-bold uppercase">Total Guardians</h3>
            <p className="text-3xl font-bold text-gray-800 mt-1">{stats.total_guardians}</p>
          </div>
          <div className="bg-white p-4 rounded-xl shadow border-l-4 border-green-500">
             <h3 className="text-gray-500 text-xs font-bold uppercase mb-2">Verified</h3>
             <p className="text-3xl font-bold text-green-600">{stats.verification.verified}</p>
          </div>
          <div className="bg-white p-4 rounded-xl shadow border-l-4 border-yellow-500">
             <h3 className="text-gray-500 text-xs font-bold uppercase mb-2">Pending</h3>
             <p className="text-3xl font-bold text-yellow-600">{stats.verification.pending}</p>
          </div>
          <div className="bg-white p-4 rounded-xl shadow border-l-4 border-purple-500">
             <h3 className="text-gray-500 text-xs font-bold uppercase mb-2">Active (7 Days)</h3>
             <p className="text-3xl font-bold text-gray-800">{stats.activity.active_7_days}</p>
          </div>
        </div>
      )}

      {/* --- FILTER BAR --- */}
      <div className="bg-white p-4 rounded-lg shadow mb-6 border border-gray-100 flex gap-4">
        <div className="w-32">
          <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Gender</label>
          <select className="w-full border rounded p-2 text-sm bg-gray-50" value={searchParams.get('legal_gender') || ''} onChange={e => updateUrl('legal_gender', e.target.value)}>
            <option value="">Any</option>
            <option value="MALE">Male</option> <option value="FEMALE">Female</option> <option value="OTHER">Other</option>
          </select>
        </div>
        <button onClick={() => router.push(pathname)} className="px-4 py-2 text-sm text-gray-500 hover:text-red-500 mt-5">Clear</button>
      </div>

      {/* --- LIST --- */}
      <div className="bg-white rounded-lg shadow overflow-hidden mb-6">
        <table className="min-w-full divide-y divide-gray-200">
          <thead className="bg-gray-50">
            <tr>
              <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Guardian</th>
              <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
              <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Connected Youth</th>
              <th className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">Actions</th>
            </tr>
          </thead>
          <tbody className="bg-white divide-y divide-gray-200">
            {users.map((user) => (
              <tr key={user.id}>
                <td className="px-6 py-4 whitespace-nowrap">
                  <div className="flex items-center">
                    {user.avatar && <img src={getMediaUrl(user.avatar) || ''} className="w-10 h-10 rounded-full mr-3 object-cover" onError={(e) => (e.target as HTMLImageElement).style.display='none'} />}
                    <div>
                        <div className="text-sm font-medium text-gray-900">{user.first_name} {user.last_name}</div>
                        <div className="text-xs text-gray-500">{user.email}</div>
                    </div>
                  </div>
                </td>
                <td className="px-6 py-4 whitespace-nowrap">
                   <span className={`px-2 py-1 text-xs font-bold rounded-full ${
                       user.verification_status === 'VERIFIED' ? 'bg-green-100 text-green-800' :
                       user.verification_status === 'PENDING' ? 'bg-yellow-100 text-yellow-800' :
                       'bg-gray-100 text-gray-600'
                   }`}>
                       {user.verification_status || 'UNVERIFIED'}
                   </span>
                </td>
                <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                  <span className="font-bold">{user.youth_members ? user.youth_members.length : 0}</span> linked
                </td>
                <td className="px-6 py-4 whitespace-nowrap text-right text-sm font-medium space-x-4">
                  <Link href={`/admin/super/guardians/${user.id}`} className="text-blue-600 hover:text-blue-900 font-bold">View</Link>
                  <button onClick={() => handleOpenEdit(user)} className="text-indigo-600 hover:text-indigo-900 font-bold">Edit</button>
                  <button onClick={() => handleDelete(user.id)} className="text-red-600 hover:text-red-900">Delete</button>
                </td>
              </tr>
            ))}
          </tbody>
        </table>
      </div>

       {/* --- PAGINATION --- */}
       <div className="flex items-center justify-between border-t border-gray-200 bg-white px-4 py-3 sm:px-6 rounded-lg shadow">
          <div className="hidden sm:flex sm:flex-1 sm:items-center sm:justify-between">
            <p className="text-sm text-gray-700">Page {currentPage} of {totalPages}</p>
            <nav className="isolate inline-flex -space-x-px rounded-md shadow-sm">
                <button disabled={currentPage === 1} onClick={() => updateUrl('page', (currentPage - 1).toString())} className="relative inline-flex items-center rounded-l-md px-2 py-2 text-gray-400 ring-1 ring-inset ring-gray-300 hover:bg-gray-50 disabled:opacity-50">Prev</button>
                <button disabled={currentPage >= totalPages} onClick={() => updateUrl('page', (currentPage + 1).toString())} className="relative inline-flex items-center rounded-r-md px-2 py-2 text-gray-400 ring-1 ring-inset ring-gray-300 hover:bg-gray-50 disabled:opacity-50">Next</button>
            </nav>
          </div>
       </div>

      {/* --- MODAL --- */}
      {showModal && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-xl shadow-2xl w-full max-w-2xl p-8 max-h-[90vh] overflow-y-auto">
            <h2 className="text-2xl font-bold mb-6 text-gray-800">{isEditing ? 'Edit Guardian' : 'Create Guardian'}</h2>
            <form onSubmit={handleSubmit} className="space-y-6">
              
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <input required type="text" placeholder="First Name" className="border p-2 rounded" value={formData.first_name} onChange={e => setFormData({...formData, first_name: e.target.value})} />
                <input required type="text" placeholder="Last Name" className="border p-2 rounded" value={formData.last_name} onChange={e => setFormData({...formData, last_name: e.target.value})} />
                
                <input required type="email" placeholder="Email" className="border p-2 rounded" value={formData.email} onChange={e => setFormData({...formData, email: e.target.value})} />
                <input type="password" placeholder={isEditing ? "New Password" : "Password"} className="border p-2 rounded" required={!isEditing} value={formData.password} onChange={e => setFormData({...formData, password: e.target.value})} />
                
                <input type="text" placeholder="Phone" className="border p-2 rounded" value={formData.phone_number} onChange={e => setFormData({...formData, phone_number: e.target.value})} />
                
                <select className="border p-2 rounded" value={formData.legal_gender} onChange={e => setFormData({...formData, legal_gender: e.target.value})}>
                    <option value="MALE">Male</option> <option value="FEMALE">Female</option> <option value="OTHER">Other</option>
                </select>
              </div>

              {/* VERIFICATION */}
              <div className="bg-blue-50 p-4 rounded-lg border border-blue-100">
                  <label className="block text-sm font-bold text-blue-800 mb-2">Verification Status</label>
                  <div className="flex gap-4">
                      {['UNVERIFIED', 'PENDING', 'VERIFIED'].map(status => (
                          <label key={status} className="flex items-center space-x-2 cursor-pointer">
                              <input 
                                  type="radio" 
                                  name="verification_status"
                                  value={status}
                                  checked={formData.verification_status === status}
                                  onChange={e => setFormData({...formData, verification_status: e.target.value})}
                                  className="text-blue-600"
                              />
                              <span className="text-sm font-medium">{status}</span>
                          </label>
                      ))}
                  </div>
              </div>

              {/* YOUTH ASSIGNMENT */}
              <div>
                  <label className="block text-sm font-bold mb-2">Assign Youth Members</label>
                  <div className="grid grid-cols-2 gap-2 border p-3 rounded max-h-60 overflow-y-auto bg-gray-50 mb-4">
                      {youthList.map(y => (
                          <label key={y.id} className="flex items-center space-x-2 text-sm cursor-pointer hover:bg-gray-100 p-1 rounded">
                              <input 
                                  type="checkbox" 
                                  checked={formData.youth_members.includes(y.id)}
                                  onChange={() => toggleYouth(y.id)}
                                  className="rounded text-green-600"
                              />
                              <span>{y.first_name} {y.last_name} (Grade {y.grade})</span>
                          </label>
                      ))}
                      {youthList.length === 0 && <span className="text-gray-400 text-xs">No youth members found.</span>}
                  </div>
              </div>

               {/* AVATAR */}
               <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">Avatar</label>
                <input type="file" accept="image/*" className="w-full border p-2 rounded" onChange={handleAvatarChange} />
                {avatarPreview && <img src={avatarPreview} alt="Preview" className="w-16 h-16 mt-2 rounded-full object-cover border" />}
              </div>

              <div className="flex justify-end gap-4 pt-4 border-t">
                <button type="button" onClick={() => setShowModal(false)} className="text-gray-500">Cancel</button>
                <button type="submit" className="bg-blue-600 text-white px-6 py-2 rounded">
                  {isEditing ? 'Save Changes' : 'Create Guardian'}
                </button>
              </div>
            </form>
          </div>
        </div>
      )}

    </div>
  );
}

export default function ManageGuardiansPage() {
  return (
    <Suspense fallback={<div>Loading...</div>}>
      <ManageGuardiansPageContent />
    </Suspense>
  );
}
--- END OF FILE: ./frontend/app/admin/super/guardians/page.tsx ---


--- START OF FILE: ./frontend/app/admin/super/guardians/[id]/page.tsx ---
'use client';

import { useState, useEffect, Suspense } from 'react';
import { useRouter, useParams } from 'next/navigation';
import Link from 'next/link';
import api from '../../../../../lib/api';
import { getMediaUrl } from '../../../../utils';

interface YouthOption { id: number; first_name: string; last_name: string; email: string; grade: number; }

function GuardianViewPageContent() {
  const router = useRouter();
  const params = useParams();
  const guardianId = params?.id as string;

  const [user, setUser] = useState<any>(null);
  const [youthList, setYouthList] = useState<YouthOption[]>([]);
  const [isLoading, setIsLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);

  useEffect(() => {
    if (guardianId) {
      fetchData();
    }
  }, [guardianId]);

  const fetchData = async () => {
    setIsLoading(true);
    setError(null);
    try {
      // Fetch user data
      const userRes = await api.get(`/users/${guardianId}/`);
      setUser(userRes.data);

      // Fetch youth list for display
      const youthRes = await api.get('/users/list_youth/');
      setYouthList(youthRes.data);
    } catch (err: any) {
      setError(err?.response?.status === 404 ? 'Guardian not found' : 'Failed to load guardian');
      console.error(err);
    } finally {
      setIsLoading(false);
    }
  };

  if (isLoading) {
    return (
      <div className="p-8 text-center">
        <p className="text-gray-500">Loading guardian details...</p>
      </div>
    );
  }

  if (error || !user) {
    return (
      <div className="p-8">
        <div className="bg-red-50 border border-red-200 rounded-lg p-4 mb-4">
          <p className="text-red-800">{error || 'Guardian not found'}</p>
        </div>
        <Link href="/admin/super/guardians" className="text-blue-600 hover:text-blue-800">
          ‚Üê Back to Guardians
        </Link>
      </div>
    );
  }

  // Normalize youth_members (handle API variations)
  const youthIds = user.youth_members || [];

  return (
    <div className="p-8">
      {/* HEADER */}
      <div className="flex items-center justify-between mb-6">
        <Link href="/admin/super/guardians" className="text-blue-600 hover:text-blue-800 font-medium">
          ‚Üê Back to Guardians
        </Link>
        <div className="flex gap-4">
          <button
            onClick={() => router.push(`/admin/super/guardians?edit=${user.id}`)}
            className="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700"
          >
            Edit Profile
          </button>
        </div>
      </div>

      {/* PROFILE HEADER */}
      <div className="bg-white rounded-xl shadow-lg overflow-hidden mb-6">
        <div className="p-8">
          <div className="flex items-center gap-6 pb-6 border-b">
            {user.avatar && (
              <img 
                src={getMediaUrl(user.avatar) || ''} 
                alt={`${user.first_name} ${user.last_name}`}
                className="w-32 h-32 rounded-full object-cover border-4 border-gray-200"
                onError={(e) => (e.target as HTMLImageElement).style.display='none'} 
              />
            )}
            <div className="flex-1">
              <h1 className="text-4xl font-bold text-gray-900 mb-2">
                {user.first_name} {user.last_name}
              </h1>
              <p className="text-lg text-gray-600 mb-3">{user.email}</p>
              <div className="flex items-center gap-4">
                <span className={`px-3 py-1 text-xs font-bold rounded-full ${
                  user.verification_status === 'VERIFIED' ? 'bg-green-100 text-green-800' :
                  user.verification_status === 'PENDING' ? 'bg-yellow-100 text-yellow-800' :
                  'bg-gray-100 text-gray-600'
                }`}>
                  {user.verification_status || 'UNVERIFIED'}
                </span>
                {user.phone_number && (
                  <span className="text-sm text-gray-600">üìû {user.phone_number}</span>
                )}
                {user.is_active !== undefined && (
                  <span className={`px-2 py-1 rounded text-xs font-bold ${
                    user.is_active ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'
                  }`}>
                    {user.is_active ? 'Active' : 'Inactive'}
                  </span>
                )}
              </div>
            </div>
          </div>
        </div>
      </div>

      <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
        {/* MAIN CONTENT */}
        <div className="lg:col-span-2 space-y-6">
          {/* BASIC INFORMATION */}
          <div className="bg-white rounded-xl shadow p-6">
            <h2 className="text-2xl font-bold text-gray-800 mb-4">Basic Information</h2>
            <div className="grid grid-cols-2 gap-4">
              <div>
                <p className="text-sm text-gray-500 font-bold uppercase mb-1">First Name</p>
                <p className="text-gray-900 font-medium">{user.first_name || '-'}</p>
              </div>
              <div>
                <p className="text-sm text-gray-500 font-bold uppercase mb-1">Last Name</p>
                <p className="text-gray-900 font-medium">{user.last_name || '-'}</p>
              </div>
              <div>
                <p className="text-sm text-gray-500 font-bold uppercase mb-1">Email</p>
                <p className="text-gray-900 font-medium">{user.email || '-'}</p>
              </div>
              <div>
                <p className="text-sm text-gray-500 font-bold uppercase mb-1">Phone Number</p>
                <p className="text-gray-900 font-medium">{user.phone_number || '-'}</p>
              </div>
              <div>
                <p className="text-sm text-gray-500 font-bold uppercase mb-1">Legal Gender</p>
                <p className="text-gray-900 font-medium">{user.legal_gender || '-'}</p>
              </div>
            </div>
          </div>

          {/* CONNECTED YOUTH MEMBERS */}
          {youthIds.length > 0 && (
            <div className="bg-white rounded-xl shadow p-6">
              <h2 className="text-2xl font-bold text-gray-800 mb-4">Connected Youth Members</h2>
              <div className="space-y-3">
                {youthIds.map((youthId: number) => {
                  const youth = youthList.find(y => y.id === youthId);
                  return youth ? (
                    <div key={youthId} className="flex items-center gap-3 p-3 bg-gray-50 rounded-lg border">
                      <div className="flex-1">
                        <p className="text-sm font-medium text-gray-900">
                          {youth.first_name} {youth.last_name} (Grade {youth.grade})
                        </p>
                        <p className="text-xs text-gray-500">{youth.email}</p>
                      </div>
                    </div>
                  ) : null;
                })}
              </div>
            </div>
          )}

          {youthIds.length === 0 && (
            <div className="bg-white rounded-xl shadow p-6">
              <h2 className="text-2xl font-bold text-gray-800 mb-4">Connected Youth Members</h2>
              <p className="text-gray-500">No youth members connected to this guardian.</p>
            </div>
          )}
        </div>

        {/* SIDEBAR */}
        <div className="space-y-6">
          {/* ACCOUNT INFO */}
          <div className="bg-white rounded-xl shadow p-6">
            <h3 className="text-lg font-bold text-gray-800 mb-4">Account Information</h3>
            <div className="space-y-3">
              <div>
                <p className="text-xs text-gray-500 font-bold uppercase mb-1">Date Joined</p>
                <p className="text-sm font-medium">
                  {user.date_joined ? new Date(user.date_joined).toLocaleDateString() : '-'}
                </p>
              </div>
              <div>
                <p className="text-xs text-gray-500 font-bold uppercase mb-1">Last Login</p>
                <p className="text-sm font-medium">
                  {user.last_login ? new Date(user.last_login).toLocaleDateString() : 'Never'}
                </p>
              </div>
              <div>
                <p className="text-xs text-gray-500 font-bold uppercase mb-1">Account Status</p>
                <span className={`inline-block px-2 py-1 rounded text-xs font-bold ${
                  user.is_active ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'
                }`}>
                  {user.is_active ? 'Active' : 'Inactive'}
                </span>
              </div>
              <div>
                <p className="text-xs text-gray-500 font-bold uppercase mb-1">Preferred Language</p>
                <p className="text-sm font-medium">{user.preferred_language || '-'}</p>
              </div>
            </div>
          </div>

          {/* ACTIONS */}
          <div className="bg-white rounded-xl shadow p-6">
            <h3 className="text-lg font-bold text-gray-800 mb-4">Actions</h3>
            <div className="space-y-2">
              <button
                onClick={() => router.push(`/admin/super/guardians?edit=${user.id}`)}
                className="w-full bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 text-center"
              >
                Edit Profile
              </button>
              <Link
                href="/admin/super/guardians"
                className="block w-full bg-gray-100 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-200 text-center"
              >
                Back to List
              </Link>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
}

export default function GuardianViewPage() {
  return (
    <Suspense fallback={<div className="p-8 text-center">Loading...</div>}>
      <GuardianViewPageContent />
    </Suspense>
  );
}


--- END OF FILE: ./frontend/app/admin/super/guardians/[id]/page.tsx ---


--- START OF FILE: ./frontend/app/admin/super/countries/page.tsx ---
'use client';

import { useState, useEffect, Suspense } from 'react';
import { useRouter, useSearchParams, usePathname } from 'next/navigation';
import api from '../../../../lib/api';
import { getMediaUrl } from '../../../utils';

function ManageCountriesPageContent() {
  const router = useRouter();
  const pathname = usePathname();
  const searchParams = useSearchParams();

  // --- STATE ---
  const [countries, setCountries] = useState<any[]>([]);
  const [isLoading, setIsLoading] = useState(true);

  // Modal
  const [showModal, setShowModal] = useState(false);
  const [isEditing, setIsEditing] = useState(false);
  const [editId, setEditId] = useState<number | null>(null);
  
  // Form Files
  const [avatarFile, setAvatarFile] = useState<File | null>(null);
  const [avatarPreview, setAvatarPreview] = useState<string | null>(null);

  const initialFormState = {
    name: '',
    country_code: '',
    description: '',
    currency_code: '',
    default_language: '',
    timezone: ''
  };

  const [formData, setFormData] = useState(initialFormState);

  // --- LOAD DATA ---
  useEffect(() => {
    fetchCountries();
  }, []);

  const fetchCountries = async () => {
    setIsLoading(true);
    try {
      const res = await api.get('/countries/');
      const data = Array.isArray(res.data) ? res.data : (res.data.results || []);
      setCountries(data);
    } catch (err) {
      console.error(err);
    } finally {
      setIsLoading(false);
    }
  };

  // --- ACTIONS ---
  const handleOpenCreate = () => {
    setIsEditing(false);
    setEditId(null);
    setFormData(initialFormState);
    setAvatarFile(null);
    setAvatarPreview(null);
    setShowModal(true);
  };

  const handleOpenEdit = (country: any) => {
    setIsEditing(true);
    setEditId(country.id);
    
    setFormData({
      name: country.name,
      country_code: country.country_code,
      description: country.description || '',
      currency_code: country.currency_code || '',
      default_language: country.default_language || '',
      timezone: country.timezone || ''
    });
    setAvatarFile(null);
    setAvatarPreview(country.avatar ? getMediaUrl(country.avatar) : null);
    setShowModal(true);
  };

  const handleDelete = async (id: number) => {
    if (!window.confirm("Are you sure? This may affect all municipalities and clubs linked to this country.")) return;
    try {
      await api.delete(`/countries/${id}/`);
      fetchCountries();
    } catch (err) {
      alert("Failed to delete.");
    }
  };

  const handleAvatarChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (file) {
      setAvatarFile(file);
      const reader = new FileReader();
      reader.onloadend = () => setAvatarPreview(reader.result as string);
      reader.readAsDataURL(file);
    }
  };

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    try {
      const data = new FormData();
      data.append('name', formData.name);
      data.append('country_code', formData.country_code);
      data.append('description', formData.description);
      data.append('currency_code', formData.currency_code);
      data.append('default_language', formData.default_language);
      data.append('timezone', formData.timezone);
      
      if (avatarFile) data.append('avatar', avatarFile);

      const config = { headers: { 'Content-Type': 'multipart/form-data' } };
      
      if (isEditing && editId) {
        await api.patch(`/countries/${editId}/`, data, config);
      } else {
        await api.post('/countries/', data, config);
      }

      setShowModal(false);
      fetchCountries();
    } catch (err) {
      alert('Operation failed.');
      console.error(err);
    }
  };

  return (
    <div>
      <div className="flex justify-between items-center mb-6">
        <h1 className="text-2xl font-bold text-gray-800">Manage Countries</h1>
        <button onClick={handleOpenCreate} className="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 shadow">
          + Add Country
        </button>
      </div>

      {/* --- LIST --- */}
      <div className="bg-white rounded-lg shadow overflow-hidden mb-6">
        {isLoading ? (
          <div className="p-8 text-center text-gray-500">Loading...</div>
        ) : countries.length === 0 ? (
          <div className="p-8 text-center text-gray-500">No countries found. Add one to get started.</div>
        ) : (
          <table className="min-w-full divide-y divide-gray-200">
            <thead className="bg-gray-50">
              <tr>
                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Country</th>
                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Code</th>
                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Currency</th>
                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Lang</th>
                <th className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">Actions</th>
              </tr>
            </thead>
            <tbody className="bg-white divide-y divide-gray-200">
              {countries.map((country) => (
                <tr key={country.id}>
                  <td className="px-6 py-4 whitespace-nowrap">
                    <div className="flex items-center">
                      {country.avatar ? (
                        <img 
                          src={getMediaUrl(country.avatar) || ''}
                          alt={country.name}
                          className="w-10 h-10 rounded-full object-cover mr-3 border bg-gray-50"
                          onError={(e) => { (e.target as HTMLImageElement).style.display = 'none'; }}
                        />
                      ) : (
                        <div className="w-10 h-10 rounded-full bg-gray-100 mr-3 flex items-center justify-center text-gray-400 text-xs font-bold">
                          {country.country_code}
                        </div>
                      )}
                      <div className="text-sm font-bold text-gray-900">{country.name}</div>
                    </div>
                  </td>
                  <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
                    {country.country_code}
                  </td>
                  <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
                    {country.currency_code || '-'}
                  </td>
                  <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-600">
                    {country.default_language || '-'}
                  </td>
                  <td className="px-6 py-4 whitespace-nowrap text-right text-sm font-medium space-x-4">
                    <button onClick={() => handleOpenEdit(country)} className="text-indigo-600 hover:text-indigo-900 font-bold">Edit</button>
                    <button onClick={() => handleDelete(country.id)} className="text-red-600 hover:text-red-900">Delete</button>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        )}
      </div>

      {/* --- MODAL --- */}
      {showModal && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-xl shadow-2xl w-full max-w-2xl p-8 max-h-[90vh] overflow-y-auto">
            <h2 className="text-2xl font-bold mb-6 text-gray-800">{isEditing ? 'Edit Country' : 'New Country'}</h2>
            <form onSubmit={handleSubmit} className="space-y-6">
              
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label className="block text-sm font-bold mb-1 text-gray-700">Name</label>
                  <input 
                    required 
                    type="text" 
                    placeholder="e.g. Sweden" 
                    className="w-full border p-2 rounded focus:ring-2 focus:ring-blue-500 outline-none" 
                    value={formData.name} 
                    onChange={e => setFormData({...formData, name: e.target.value})} 
                  />
                </div>
                <div>
                  <label className="block text-sm font-bold mb-1 text-gray-700">Country Code (ISO)</label>
                  <input 
                    required 
                    type="text" 
                    placeholder="e.g. SE" 
                    maxLength={5}
                    className="w-full border p-2 rounded focus:ring-2 focus:ring-blue-500 outline-none uppercase" 
                    value={formData.country_code} 
                    onChange={e => setFormData({...formData, country_code: e.target.value.toUpperCase()})} 
                  />
                </div>
              </div>

              <div>
                <label className="block text-sm font-bold mb-1 text-gray-700">Description</label>
                <textarea 
                  required
                  rows={3}
                  placeholder="General description of the country settings..." 
                  className="w-full border p-2 rounded focus:ring-2 focus:ring-blue-500 outline-none" 
                  value={formData.description} 
                  onChange={e => setFormData({...formData, description: e.target.value})} 
                />
              </div>

              <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                  <label className="block text-sm font-bold mb-1 text-gray-700">Currency</label>
                  <input 
                    type="text" 
                    placeholder="e.g. SEK" 
                    className="w-full border p-2 rounded focus:ring-2 focus:ring-blue-500 outline-none uppercase" 
                    value={formData.currency_code} 
                    onChange={e => setFormData({...formData, currency_code: e.target.value.toUpperCase()})} 
                  />
                </div>
                <div>
                  <label className="block text-sm font-bold mb-1 text-gray-700">Language</label>
                  <input 
                    type="text" 
                    placeholder="e.g. sv" 
                    className="w-full border p-2 rounded focus:ring-2 focus:ring-blue-500 outline-none" 
                    value={formData.default_language} 
                    onChange={e => setFormData({...formData, default_language: e.target.value})} 
                  />
                </div>
                <div>
                  <label className="block text-sm font-bold mb-1 text-gray-700">Timezone</label>
                  <input 
                    type="text" 
                    placeholder="e.g. Europe/Stockholm" 
                    className="w-full border p-2 rounded focus:ring-2 focus:ring-blue-500 outline-none" 
                    value={formData.timezone} 
                    onChange={e => setFormData({...formData, timezone: e.target.value})} 
                  />
                </div>
              </div>

              {/* AVATAR UPLOAD */}
              <div>
                <label className="block text-sm font-bold mb-2 text-gray-700">Flag / Avatar</label>
                <input 
                  type="file" 
                  accept="image/*" 
                  className="w-full border p-2 rounded text-sm" 
                  onChange={handleAvatarChange} 
                />
                {avatarPreview && (
                  <div className="mt-3 flex justify-center bg-gray-50 p-4 rounded border border-dashed">
                    <img src={avatarPreview} alt="Preview" className="h-20 object-contain" />
                  </div>
                )}
              </div>

              <div className="flex justify-end gap-4 pt-4 border-t">
                <button type="button" onClick={() => setShowModal(false)} className="text-gray-500 hover:text-gray-700">Cancel</button>
                <button type="submit" className="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700 transition">
                  {isEditing ? 'Save Changes' : 'Create'}
                </button>
              </div>
            </form>
          </div>
        </div>
      )}
    </div>
  );
}

export default function ManageCountriesPage() {
  return (
    <Suspense fallback={<div>Loading...</div>}>
      <ManageCountriesPageContent />
    </Suspense>
  );
}


--- END OF FILE: ./frontend/app/admin/super/countries/page.tsx ---


--- START OF FILE: ./frontend/app/admin/super/interests/page.tsx ---
'use client';

import { useState, useEffect, Suspense } from 'react';
import { useRouter, useSearchParams, usePathname } from 'next/navigation';
import api from '../../../../lib/api';
import { getMediaUrl } from '../../../utils';

function ManageInterestsPageContent() {
  const router = useRouter();
  const pathname = usePathname();
  const searchParams = useSearchParams();

  // --- STATE ---
  const [interests, setInterests] = useState<any[]>([]);
  const [isLoading, setIsLoading] = useState(true);

  // Modal
  const [showModal, setShowModal] = useState(false);
  const [isEditing, setIsEditing] = useState(false);
  const [editId, setEditId] = useState<number | null>(null);
  
  // Form Files
  const [avatarFile, setAvatarFile] = useState<File | null>(null);
  const [avatarPreview, setAvatarPreview] = useState<string | null>(null);

  const initialFormState = {
    name: '',
    icon: '', // For Emoji
  };

  const [formData, setFormData] = useState(initialFormState);

  // --- LOAD DATA ---
  useEffect(() => {
    fetchInterests();
  }, []);

  const fetchInterests = async () => {
    setIsLoading(true);
    try {
      // FIXED URL: Removed '/organization' prefix
      const res = await api.get('/interests/');
      const data = Array.isArray(res.data) ? res.data : (res.data.results || []);
      setInterests(data);
    } catch (err) {
      console.error(err);
    } finally {
      setIsLoading(false);
    }
  };

  // --- ACTIONS ---
  const handleOpenCreate = () => {
    setIsEditing(false);
    setEditId(null);
    setFormData(initialFormState);
    setAvatarFile(null);
    setAvatarPreview(null);
    setShowModal(true);
  };

  const handleOpenEdit = (interest: any) => {
    setIsEditing(true);
    setEditId(interest.id);
    
    setFormData({
      name: interest.name,
      icon: interest.icon || '',
    });
    setAvatarFile(null);
    setAvatarPreview(interest.avatar ? getMediaUrl(interest.avatar) : null);
    setShowModal(true);
  };

  const handleDelete = async (id: number) => {
    if (!window.confirm("Are you sure? This will remove this interest from all users who selected it.")) return;
    try {
      // FIXED URL
      await api.delete(`/interests/${id}/`);
      fetchInterests();
    } catch (err) {
      alert("Failed to delete.");
    }
  };

  const handleAvatarChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (file) {
      setAvatarFile(file);
      const reader = new FileReader();
      reader.onloadend = () => setAvatarPreview(reader.result as string);
      reader.readAsDataURL(file);
    }
  };

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    try {
      const data = new FormData();
      data.append('name', formData.name);
      data.append('icon', formData.icon);
      
      if (avatarFile) data.append('avatar', avatarFile);

      const config = { headers: { 'Content-Type': 'multipart/form-data' } };
      
      // FIXED URLs
      if (isEditing && editId) {
        await api.patch(`/interests/${editId}/`, data, config);
      } else {
        await api.post('/interests/', data, config);
      }

      setShowModal(false);
      fetchInterests();
    } catch (err) {
      alert('Operation failed.');
      console.error(err);
    }
  };

  return (
    <div>
      <div className="flex justify-between items-center mb-6">
        <h1 className="text-2xl font-bold text-gray-800">Manage Interests</h1>
        <button onClick={handleOpenCreate} className="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 shadow">
          + Add Interest
        </button>
      </div>

      {/* --- LIST --- */}
      <div className="bg-white rounded-lg shadow overflow-hidden mb-6">
        {isLoading ? (
          <div className="p-8 text-center text-gray-500">Loading...</div>
        ) : interests.length === 0 ? (
          <div className="p-8 text-center text-gray-500">No interests found. Add one to get started.</div>
        ) : (
          <table className="min-w-full divide-y divide-gray-200">
            <thead className="bg-gray-50">
              <tr>
                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Interest</th>
                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Icon (Emoji)</th>
                <th className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">Actions</th>
              </tr>
            </thead>
            <tbody className="bg-white divide-y divide-gray-200">
              {interests.map((interest) => (
                <tr key={interest.id}>
                  <td className="px-6 py-4 whitespace-nowrap">
                    <div className="flex items-center">
                      {/* Show Avatar if exists */}
                      {interest.avatar ? (
                        <img 
                          src={getMediaUrl(interest.avatar) || ''}
                          alt={interest.name}
                          className="w-10 h-10 rounded-lg object-cover mr-3 border bg-gray-50"
                          onError={(e) => { (e.target as HTMLImageElement).style.display = 'none'; }}
                        />
                      ) : (
                        <div className="w-10 h-10 rounded-lg bg-gray-100 mr-3 flex items-center justify-center text-gray-400 text-xs">
                          No img
                        </div>
                      )}
                      <div className="text-sm font-bold text-gray-900">{interest.name}</div>
                    </div>
                  </td>
                  <td className="px-6 py-4 whitespace-nowrap text-2xl">
                    {interest.icon}
                  </td>
                  <td className="px-6 py-4 whitespace-nowrap text-right text-sm font-medium space-x-4">
                    <button onClick={() => handleOpenEdit(interest)} className="text-indigo-600 hover:text-indigo-900 font-bold">Edit</button>
                    <button onClick={() => handleDelete(interest.id)} className="text-red-600 hover:text-red-900">Delete</button>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        )}
      </div>

      {/* --- MODAL --- */}
      {showModal && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-xl shadow-2xl w-full max-w-md p-8">
            <h2 className="text-2xl font-bold mb-6 text-gray-800">{isEditing ? 'Edit Interest' : 'New Interest'}</h2>
            <form onSubmit={handleSubmit} className="space-y-6">
              
              <div>
                <label className="block text-sm font-bold mb-1 text-gray-700">Name</label>
                <input 
                  required 
                  type="text" 
                  placeholder="e.g. Football" 
                  className="w-full border p-2 rounded focus:ring-2 focus:ring-blue-500 outline-none" 
                  value={formData.name} 
                  onChange={e => setFormData({...formData, name: e.target.value})} 
                />
              </div>

              <div>
                <label className="block text-sm font-bold mb-1 text-gray-700">Icon (Emoji)</label>
                <input 
                  type="text" 
                  placeholder="e.g. ‚öΩ" 
                  className="w-full border p-2 rounded focus:ring-2 focus:ring-blue-500 outline-none" 
                  value={formData.icon} 
                  onChange={e => setFormData({...formData, icon: e.target.value})} 
                />
                <p className="text-xs text-gray-500 mt-1">Type an emoji (Win + . or Cmd + Ctrl + Space)</p>
              </div>

              {/* AVATAR UPLOAD */}
              <div>
                <label className="block text-sm font-bold mb-2 text-gray-700">Cover Image / Icon (SVG/PNG)</label>
                <input 
                  type="file" 
                  accept="image/*" 
                  className="w-full border p-2 rounded text-sm" 
                  onChange={handleAvatarChange} 
                />
                {avatarPreview && (
                  <div className="mt-3 flex justify-center bg-gray-50 p-4 rounded border border-dashed">
                    <img src={avatarPreview} alt="Preview" className="h-20 object-contain" />
                  </div>
                )}
              </div>

              <div className="flex justify-end gap-4 pt-4 border-t">
                <button type="button" onClick={() => setShowModal(false)} className="text-gray-500 hover:text-gray-700">Cancel</button>
                <button type="submit" className="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700 transition">
                  {isEditing ? 'Save Changes' : 'Create'}
                </button>
              </div>
            </form>
          </div>
        </div>
      )}
    </div>
  );
}

export default function ManageInterestsPage() {
  return (
    <Suspense fallback={<div>Loading...</div>}>
      <ManageInterestsPageContent />
    </Suspense>
  );
}
--- END OF FILE: ./frontend/app/admin/super/interests/page.tsx ---


--- START OF FILE: ./frontend/app/admin/municipality/page.tsx ---
'use client';

import { useAuth } from '../../../context/AuthContext';

export default function MunicipalityDashboard() {
  const { user, logout } = useAuth();

  return (
    <div className="min-h-screen bg-gray-100 p-10">
      <div className="flex justify-between items-center mb-8">
        <h1 className="text-3xl font-bold text-purple-600">Municipality Admin</h1>
        <div className="flex gap-4 items-center">
          <span className="text-gray-600">Welcome, {user?.first_name}</span>
          <button onClick={logout} className="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">
            Logout
          </button>
        </div>
      </div>
      <div className="bg-white p-6 rounded-lg shadow">
        <p>Manage your clubs and municipality settings here.</p>
      </div>
    </div>
  );
}
--- END OF FILE: ./frontend/app/admin/municipality/page.tsx ---


--- START OF FILE: ./frontend/app/dashboard/youth/page.tsx ---
'use client';

import { useAuth } from '../../../context/AuthContext';

export default function YouthDashboard() {
  const { user, logout } = useAuth();

  return (
    <div className="min-h-screen bg-gray-100 p-10">
      <div className="flex justify-between items-center mb-8">
        <h1 className="text-3xl font-bold text-blue-500">My Youth Dashboard</h1>
        <div className="flex gap-4 items-center">
          <span className="text-gray-600">Hi, {user?.first_name}!</span>
          <button onClick={logout} className="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">
            Logout
          </button>
        </div>
      </div>
      <div className="bg-white p-6 rounded-lg shadow">
        <p>Check into events, view your interests, and see what's happening!</p>
      </div>
    </div>
  );
}
--- END OF FILE: ./frontend/app/dashboard/youth/page.tsx ---


--- START OF FILE: ./frontend/app/dashboard/guardian/page.tsx ---
'use client';

import { useAuth } from '../../../context/AuthContext';

export default function GuardianDashboard() {
  const { user, logout } = useAuth();

  return (
    <div className="min-h-screen bg-gray-100 p-10">
      <div className="flex justify-between items-center mb-8">
        <h1 className="text-3xl font-bold text-orange-600">Parent Portal</h1>
        <div className="flex gap-4 items-center">
          <span className="text-gray-600">Welcome, {user?.first_name}</span>
          <button onClick={logout} className="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">
            Logout
          </button>
        </div>
      </div>
      <div className="bg-white p-6 rounded-lg shadow">
        <p>Manage your connected youth members and approve events here.</p>
      </div>
    </div>
  );
}
--- END OF FILE: ./frontend/app/dashboard/guardian/page.tsx ---


--- START OF FILE: ./frontend/app/login/page.tsx ---
'use client';

import { useState } from 'react';
import { useAuth } from '../../context/AuthContext';

export default function LoginPage() {
  const { login } = useAuth();
  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');
  const [error, setError] = useState('');
  const [isLoading, setIsLoading] = useState(false);

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setError('');
    setIsLoading(true);

    try {
      await login(email, password);
      // Redirect happens automatically in AuthContext
    } catch (err) {
      setError('Invalid email or password');
      setIsLoading(false);
    }
  };

  return (
    <div className="min-h-screen flex items-center justify-center bg-gray-100">
      <div className="max-w-md w-full bg-white rounded-xl shadow-lg p-8 space-y-6">
        <div className="text-center">
          <h1 className="text-3xl font-bold text-gray-900">Welcome Back</h1>
          <p className="text-gray-500 mt-2">Sign in to Ungdomsappen</p>
        </div>

        {error && (
          <div className="bg-red-50 text-red-600 p-3 rounded-lg text-sm text-center">
            {error}
          </div>
        )}

        <form onSubmit={handleSubmit} className="space-y-4">
          <div>
            <label className="block text-sm font-medium text-gray-700">Email</label>
            <input
              type="email"
              required
              value={email}
              onChange={(e) => setEmail(e.target.value)}
              className="mt-1 w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition"
              placeholder="admin@example.com"
            />
          </div>

          <div>
            <label className="block text-sm font-medium text-gray-700">Password</label>
            <input
              type="password"
              required
              value={password}
              onChange={(e) => setPassword(e.target.value)}
              className="mt-1 w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition"
              placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
            />
          </div>

          <button
            type="submit"
            disabled={isLoading}
            className={`w-full py-3 text-white rounded-lg font-bold transition
              ${isLoading ? 'bg-blue-400 cursor-not-allowed' : 'bg-blue-600 hover:bg-blue-700'}
            `}
          >
            {isLoading ? 'Signing in...' : 'Sign In'}
          </button>
        </form>

        <div className="text-center text-sm text-gray-500">
          <a href="#" className="hover:text-blue-600">Forgot password?</a>
        </div>
      </div>
    </div>
  );
}
--- END OF FILE: ./frontend/app/login/page.tsx ---


--- START OF FILE: ./frontend/lib/api.ts ---
import axios from 'axios';
import Cookies from 'js-cookie';

const API_URL = 'http://localhost:8000/api';

const api = axios.create({
  baseURL: API_URL,
  headers: {
    'Content-Type': 'application/json',
  },
});

// Interceptor: Automatically add the Token to every request
api.interceptors.request.use((config) => {
  const token = Cookies.get('access_token');
  if (token) {
    config.headers.Authorization = `JWT ${token}`;
  }
  return config;
});

// Interceptor: Handle errors (like if token expires)
api.interceptors.response.use(
  (response) => response,
  (error) => {
    if (error.response && error.response.status === 401) {
      // If token is invalid, logout (optional: add refresh logic later)
      Cookies.remove('access_token');
      Cookies.remove('refresh_token');
      // window.location.href = '/login'; // Optional: Force redirect
    }
    return Promise.reject(error);
  }
);

export default api;
--- END OF FILE: ./frontend/lib/api.ts ---


--- START OF FILE: ./backend/manage.py ---
#!/usr/bin/env python
"""Django's command-line utility for administrative tasks."""
import os
import sys


def main():
    """Run administrative tasks."""
    os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'core.settings')
    try:
        from django.core.management import execute_from_command_line
    except ImportError as exc:
        raise ImportError(
            "Couldn't import Django. Are you sure it's installed and "
            "available on your PYTHONPATH environment variable? Did you "
            "forget to activate a virtual environment?"
        ) from exc
    execute_from_command_line(sys.argv)


if __name__ == '__main__':
    main()

--- END OF FILE: ./backend/manage.py ---


--- START OF FILE: ./backend/organization/models.py ---
from django.db import models
from django.core.validators import FileExtensionValidator

# Define allowed file types
image_validator = FileExtensionValidator(allowed_extensions=['jpg', 'jpeg', 'png', 'svg', 'webp'])

class Country(models.Model):
    """
    Represents the highest organizational level.
    """
    name = models.CharField(max_length=100, unique=True)
    country_code = models.CharField(max_length=5, help_text="ISO Code, e.g., SE, NO")
    description = models.TextField()
    
    # Changed to FileField to support SVG
    avatar = models.FileField(
        upload_to='countries/avatars/', 
        blank=True, 
        null=True,
        validators=[image_validator]
    )

    currency_code = models.CharField(max_length=10, blank=True, null=True)
    default_language = models.CharField(max_length=10, blank=True, null=True)
    timezone = models.CharField(max_length=50, blank=True, null=True)

    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)

    class Meta:
        verbose_name_plural = "Countries"

    def __str__(self):
        return self.name

class Municipality(models.Model):
    """
    Represents a local government area.
    """
    country = models.ForeignKey(Country, on_delete=models.CASCADE, related_name='municipalities')
    name = models.CharField(max_length=100)
    description = models.TextField()
    terms_and_conditions = models.TextField()
    
    # Changed to FileField
    avatar = models.FileField(
        upload_to='municipalities/avatars/', 
        blank=True, 
        null=True,
        validators=[image_validator]
    )
    hero_image = models.FileField(
        upload_to='municipalities/heroes/', 
        blank=True, 
        null=True,
        validators=[image_validator]
    )

    municipality_code = models.CharField(max_length=20, unique=True, blank=True, null=True)
    email = models.EmailField(blank=True, null=True)
    phone = models.CharField(max_length=50, blank=True, null=True)
    website_link = models.URLField(blank=True, null=True)
    social_media = models.JSONField(default=dict, blank=True)
    allow_self_registration = models.BooleanField(default=True)
    
    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)

    class Meta:
        verbose_name_plural = "Municipalities"

    def __str__(self):
        return f"{self.name} ({self.country.country_code})"

class Club(models.Model):
    """
    Represents a physical youth center.
    """
    municipality = models.ForeignKey(Municipality, on_delete=models.CASCADE, related_name='clubs')
    name = models.CharField(max_length=100)
    description = models.TextField()
    email = models.EmailField()
    phone = models.CharField(max_length=50)
    terms_and_conditions = models.TextField()
    club_policies = models.TextField()

    # Changed to FileField
    avatar = models.FileField(
        upload_to='clubs/avatars/', 
        blank=True, 
        null=True,
        validators=[image_validator]
    )
    hero_image = models.FileField(
        upload_to='clubs/heroes/', 
        blank=True, 
        null=True,
        validators=[image_validator]
    )

    address = models.CharField(max_length=255, blank=True, null=True)
    latitude = models.FloatField(blank=True, null=True)
    longitude = models.FloatField(blank=True, null=True)
    allowed_age_groups = models.CharField(max_length=100, blank=True, null=True)
    club_categories = models.CharField(max_length=255, blank=True, null=True)

    created_at = models.DateTimeField(auto_now_add=True)
    updated_at = models.DateTimeField(auto_now=True)

    def __str__(self):
        return f"{self.name} ({self.municipality.name})"

class RegularOpeningHour(models.Model):
    """
    Defines the standard weekly schedule.
    """
    WEEKDAY_CHOICES = [
        (1, 'Monday'), (2, 'Tuesday'), (3, 'Wednesday'), (4, 'Thursday'),
        (5, 'Friday'), (6, 'Saturday'), (7, 'Sunday'),
    ]
    
    WEEK_CYCLE_CHOICES = [
        ('ALL', 'Every Week'),
        ('ODD', 'Odd Weeks (1, 3, 5...)'),
        ('EVEN', 'Even Weeks (2, 4, 6...)'),
    ]

    GENDER_CHOICES = [
        ('ALL', 'All Genders'), ('BOYS', 'Boys Only'), 
        ('GIRLS', 'Girls Only'), ('OTHER', 'Other'),
    ]

    RESTRICTION_CHOICES = [
        ('NONE', 'No Restriction'),
        ('AGE', 'Age Range'),
        ('GRADE', 'Grade Range'),
    ]

    club = models.ForeignKey(Club, on_delete=models.CASCADE, related_name='regular_hours')
    weekday = models.IntegerField(choices=WEEKDAY_CHOICES)
    week_cycle = models.CharField(max_length=10, choices=WEEK_CYCLE_CHOICES, default='ALL')
    
    open_time = models.TimeField()
    close_time = models.TimeField()
    
    title = models.CharField(max_length=100, blank=True)
    description = models.TextField(blank=True)
    
    # New Logic for Restrictions
    restriction_mode = models.CharField(max_length=10, choices=RESTRICTION_CHOICES, default='NONE')
    min_value = models.IntegerField(null=True, blank=True, help_text="Min Age or Grade")
    max_value = models.IntegerField(null=True, blank=True, help_text="Max Age or Grade")
    
    gender_restriction = models.CharField(max_length=10, choices=GENDER_CHOICES, default='ALL')

    class Meta:
        ordering = ['weekday', 'open_time']

    def __str__(self):
        return f"{self.club.name} - {self.get_weekday_display()}"


class ClubClosure(models.Model):
    """
    Dates when the club is completely closed (Section 6.5, 6.6).
    """
    club = models.ForeignKey(Club, on_delete=models.CASCADE, related_name='closures')
    start_date = models.DateField()
    end_date = models.DateField(help_text="If same as start_date, it's a one-day closure")
    description = models.CharField(max_length=255, help_text="Reason for closure (e.g. Christmas)")

    class Meta:
        ordering = ['start_date']

    def __str__(self):
        return f"{self.club.name} Closed: {self.start_date}"


class DateOverride(models.Model):
    """
    Specific dates with special hours that replace the regular schedule (Section 6.4).
    """
    club = models.ForeignKey(Club, on_delete=models.CASCADE, related_name='date_overrides')
    date = models.DateField()
    
    open_time = models.TimeField()
    close_time = models.TimeField()
    
    title = models.CharField(max_length=100, blank=True, help_text="e.g., 'Summer Party'")
    description = models.TextField(blank=True)
    
    class Meta:
        ordering = ['date', 'open_time']

    def __str__(self):
        return f"{self.club.name} Override: {self.date}"


class Interest(models.Model):
    """
    Global interests defined by Super Admin. 
    Used to categorize Users and Events.
    """
    name = models.CharField(max_length=50, unique=True)
    # Kept 'icon' as a fallback or for small UI elements (emoji)
    icon = models.CharField(max_length=50, blank=True, help_text="Emoji or Icon name (e.g. '‚öΩ' or 'sports_soccer')")
    
    # New visual field supporting SVGs
    avatar = models.FileField(
        upload_to='interests/avatars/', 
        blank=True, 
        null=True,
        validators=[image_validator]
    )
    
    class Meta:
        ordering = ['name']

    def __str__(self):
        return f"{self.icon} {self.name}" if self.icon else self.name
--- END OF FILE: ./backend/organization/models.py ---


--- START OF FILE: ./backend/organization/serializers.py ---
from rest_framework import serializers
from django.http import QueryDict
import json
from .models import Country, Municipality, Club, RegularOpeningHour, ClubClosure, DateOverride, Interest

# --- Opening Hours Serializers ---

class RegularOpeningHourSerializer(serializers.ModelSerializer):
    weekday_display = serializers.CharField(source='get_weekday_display', read_only=True)
    
    class Meta:
        model = RegularOpeningHour
        fields = [
            'id', 'weekday', 'weekday_display', 'week_cycle', 
            'open_time', 'close_time', 'title', 
            'gender_restriction', 'restriction_mode', 'min_value', 'max_value'
        ]

class ClubClosureSerializer(serializers.ModelSerializer):
    class Meta:
        model = ClubClosure
        fields = ['id', 'start_date', 'end_date', 'description']

class DateOverrideSerializer(serializers.ModelSerializer):
    class Meta:
        model = DateOverride
        fields = ['id', 'date', 'open_time', 'close_time', 'title', 'description']

# --- Organization Serializers ---

class CountrySerializer(serializers.ModelSerializer):
    class Meta:
        model = Country
        fields = [
            'id',
            'name',
            'country_code',
            'description',
            'currency_code',
            'default_language',
            'timezone',
            'avatar',
        ]

class MunicipalitySerializer(serializers.ModelSerializer):
    # Include country name for easier display
    country_name = serializers.CharField(source='country.name', read_only=True)
    country_code = serializers.CharField(source='country.country_code', read_only=True)
    
    class Meta:
        model = Municipality
        fields = [
            'id',
            'country',
            'country_name',
            'country_code',
            'name',
            'municipality_code',
            'description',
            'terms_and_conditions',
            'avatar',
            'hero_image',
            'email',
            'phone',
            'website_link',
            'social_media',
            'allow_self_registration',
        ]

class ClubSerializer(serializers.ModelSerializer):
    # Include the related data nicely
    municipality_name = serializers.CharField(source='municipality.name', read_only=True)
    
    # Nested Opening Hours (so we get them automatically when fetching a club)
    regular_hours = RegularOpeningHourSerializer(many=True, read_only=True)
    closures = ClubClosureSerializer(many=True, read_only=True)
    date_overrides = DateOverrideSerializer(many=True, read_only=True)

    class Meta:
        model = Club
        fields = [
            'id', 'name', 'municipality', 'municipality_name', 
            'description', 'email', 'phone', 
            'terms_and_conditions', 'club_policies',
            'avatar', 'hero_image', 'address', 
            'latitude', 'longitude', 
            'allowed_age_groups', 'club_categories',
            'regular_hours', 'closures', 'date_overrides'
        ]

class InterestSerializer(serializers.ModelSerializer):
    class Meta:
        model = Interest
        fields = ['id', 'name', 'icon', 'avatar']


class ClubManagementSerializer(serializers.ModelSerializer):
    """
    Used by Super Admins to create/update Clubs AND their opening hours.
    """
    # We accept a JSON string for hours because we are using FormData (for images)
    regular_hours_data = serializers.CharField(write_only=True, required=False)

    class Meta:
        model = Club
        fields = [
            'id', 'name', 'municipality', 'description', 'email', 'phone',
            'terms_and_conditions', 'club_policies',
            'avatar', 'hero_image',
            'address', 'latitude', 'longitude',
            'club_categories',  # Removed allowed_age_groups as it's now handled per hour
            'regular_hours_data'
        ]

    def create(self, validated_data):
        hours_json = validated_data.pop('regular_hours_data', None)
        club = Club.objects.create(**validated_data)

        if hours_json:
            try:
                hours_list = json.loads(hours_json)
                for hour in hours_list:
                    # Clean up frontend temporary IDs
                    if 'id' in hour: del hour['id']
                    if 'weekday_display' in hour: del hour['weekday_display']
                    
                    # Validate Overlap Logic Here (Optional but good for safety)
                    # For now, we rely on frontend validation for UX, 
                    # simply saving what is sent.
                    RegularOpeningHour.objects.create(club=club, **hour)
            except json.JSONDecodeError:
                pass  # Ignore invalid JSON

        return club

    def update(self, instance, validated_data):
        hours_json = validated_data.pop('regular_hours_data', None)
        
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        instance.save()
        
        if hours_json:
            try:
                hours_list = json.loads(hours_json)
                instance.regular_hours.all().delete()
                for hour in hours_list:
                    # Clean up frontend temporary IDs
                    if 'id' in hour: del hour['id']
                    if 'weekday_display' in hour: del hour['weekday_display']
                    
                    # Validate Overlap Logic Here (Optional but good for safety)
                    # For now, we rely on frontend validation for UX, 
                    # simply saving what is sent.
                    RegularOpeningHour.objects.create(club=instance, **hour)
            except json.JSONDecodeError:
                pass
                
        return instance
--- END OF FILE: ./backend/organization/serializers.py ---


--- START OF FILE: ./backend/organization/apps.py ---
from django.apps import AppConfig


class OrganizationConfig(AppConfig):
    default_auto_field = 'django.db.models.BigAutoField'
    name = 'organization'

--- END OF FILE: ./backend/organization/apps.py ---


--- START OF FILE: ./backend/organization/admin.py ---
from django.contrib import admin
from .models import Country, Municipality, Club, RegularOpeningHour, ClubClosure, DateOverride, Interest

# --- INLINES (Allows editing inside the Club page) ---

class RegularOpeningHourInline(admin.TabularInline):
    model = RegularOpeningHour
    extra = 0 # Don't show empty extra rows by default
    ordering = ['weekday', 'open_time']

class ClubClosureInline(admin.TabularInline):
    model = ClubClosure
    extra = 0
    ordering = ['start_date']

class DateOverrideInline(admin.TabularInline):
    model = DateOverride
    extra = 0
    ordering = ['date']

# --- ADMIN CONFIGURATION ---

@admin.register(Country)
class CountryAdmin(admin.ModelAdmin):
    list_display = ('name', 'country_code', 'default_language')
    search_fields = ('name', 'country_code')

@admin.register(Municipality)
class MunicipalityAdmin(admin.ModelAdmin):
    list_display = ('name', 'country', 'municipality_code')
    list_filter = ('country',)
    search_fields = ('name', 'municipality_code')

@admin.register(Club)
class ClubAdmin(admin.ModelAdmin):
    list_display = ('name', 'municipality', 'email')
    list_filter = ('municipality__country', 'municipality')
    search_fields = ('name', 'email')
    
    # Add the opening hours, closures, and overrides here
    inlines = [RegularOpeningHourInline, DateOverrideInline, ClubClosureInline]

@admin.register(Interest)
class InterestAdmin(admin.ModelAdmin):
    list_display = ('name', 'icon')
    search_fields = ('name',)
--- END OF FILE: ./backend/organization/admin.py ---


--- START OF FILE: ./backend/organization/tests.py ---
from django.test import TestCase

# Create your tests here.

--- END OF FILE: ./backend/organization/tests.py ---


--- START OF FILE: ./backend/organization/urls.py ---
from django.urls import path, include
from rest_framework.routers import DefaultRouter
from .views import CountryViewSet, MunicipalityViewSet, ClubViewSet, InterestViewSet

# Create a router and register our viewsets with it.
router = DefaultRouter()
router.register(r'countries', CountryViewSet)
router.register(r'municipalities', MunicipalityViewSet)
router.register(r'clubs', ClubViewSet)
router.register(r'interests', InterestViewSet)

urlpatterns = [
    path('', include(router.urls)),
]
--- END OF FILE: ./backend/organization/urls.py ---


--- START OF FILE: ./backend/organization/views.py ---
from rest_framework import viewsets
from rest_framework.permissions import AllowAny
from users.permissions import IsSuperAdmin
from .models import Country, Municipality, Club, Interest
from .serializers import (
    CountrySerializer,
    MunicipalitySerializer,
    ClubSerializer,
    InterestSerializer,
    ClubManagementSerializer,
)

class CountryViewSet(viewsets.ModelViewSet):
    """
    Country management.
    Read: Public
    Write: Super Admin Only
    """
    queryset = Country.objects.all()
    serializer_class = CountrySerializer

    def get_permissions(self):
        # Allow anyone to read the list (needed for login/registration dropdowns)
        if self.action in ['list', 'retrieve']:
            return [AllowAny()]
        # Only Super Admins can create, update, or delete
        return [IsSuperAdmin()]

class MunicipalityViewSet(viewsets.ModelViewSet):
    """
    API endpoint that allows Municipalities to be viewed and managed.
    Read: Public
    Write: Super Admin Only
    """
    queryset = Municipality.objects.all()
    serializer_class = MunicipalitySerializer

    def get_permissions(self):
        if self.action in ['list', 'retrieve']:
            return [AllowAny()]
        return [IsSuperAdmin()]

class ClubViewSet(viewsets.ModelViewSet):
    """
    API endpoint that allows Clubs to be viewed and managed.
    Read: Public
    Write: Super Admin Only
    """
    queryset = Club.objects.all()
    serializer_class = ClubSerializer

    def get_permissions(self):
        if self.action in ['list', 'retrieve']:
            return [AllowAny()]
        return [IsSuperAdmin()]

    def get_serializer_class(self):
        if self.action in ['create', 'update', 'partial_update']:
            return ClubManagementSerializer
        return ClubSerializer

class InterestViewSet(viewsets.ModelViewSet):
    """
    Interests management.
    Read: Public
    Write: Super Admin Only
    """
    queryset = Interest.objects.all()
    serializer_class = InterestSerializer

    def get_permissions(self):
        # Allow anyone to read the list (needed for registration forms)
        if self.action in ['list', 'retrieve']:
            return [AllowAny()]
        # Only Super Admins can create, update, or delete
        return [IsSuperAdmin()]
--- END OF FILE: ./backend/organization/views.py ---


--- START OF FILE: ./backend/core/asgi.py ---
"""
ASGI config for core project.

It exposes the ASGI callable as a module-level variable named ``application``.

For more information on this file, see
https://docs.djangoproject.com/en/5.1/howto/deployment/asgi/
"""

import os

from django.core.asgi import get_asgi_application

os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'core.settings')

application = get_asgi_application()

--- END OF FILE: ./backend/core/asgi.py ---


--- START OF FILE: ./backend/core/settings.py ---
import os
from pathlib import Path

# Build paths inside the project like this: BASE_DIR / 'subdir'.
BASE_DIR = Path(__file__).resolve().parent.parent


# Quick-start development settings - unsuitable for production
# See https://docs.djangoproject.com/en/5.1/howto/deployment/checklist/

# SECURITY WARNING: keep the secret key used in production secret!
SECRET_KEY = 'django-insecure--=9kkpv))f8u^_0()806)3=3%8!d3(_185s!x2(&lz*3h#5$sj'

# SECURITY WARNING: don't run with debug turned on in production!
DEBUG = True

ALLOWED_HOSTS = []


# Application definition

INSTALLED_APPS = [
    'django.contrib.admin',
    'django.contrib.auth',
    'django.contrib.contenttypes',
    'django.contrib.sessions',
    'django.contrib.messages',
    'django.contrib.staticfiles',
    'rest_framework',
    'corsheaders',
    'djoser',
    'users',
    'api',
    'organization',
]

MIDDLEWARE = [
    'corsheaders.middleware.CorsMiddleware',
    'django.middleware.security.SecurityMiddleware',
    'django.contrib.sessions.middleware.SessionMiddleware',
    'django.middleware.common.CommonMiddleware',
    'django.middleware.csrf.CsrfViewMiddleware',
    'django.contrib.auth.middleware.AuthenticationMiddleware',
    'django.contrib.messages.middleware.MessageMiddleware',
    'django.middleware.clickjacking.XFrameOptionsMiddleware',
]

ROOT_URLCONF = 'core.urls'

TEMPLATES = [
    {
        'BACKEND': 'django.template.backends.django.DjangoTemplates',
        'DIRS': [],
        'APP_DIRS': True,
        'OPTIONS': {
            'context_processors': [
                'django.template.context_processors.debug',
                'django.template.context_processors.request',
                'django.contrib.auth.context_processors.auth',
                'django.contrib.messages.context_processors.messages',
            ],
        },
    },
]

WSGI_APPLICATION = 'core.wsgi.application'


# Database
# https://docs.djangoproject.com/en/5.1/ref/settings/#databases

DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.sqlite3',
        'NAME': BASE_DIR / 'db.sqlite3',
    }
}


# Password validation
# https://docs.djangoproject.com/en/5.1/ref/settings/#auth-password-validators

AUTH_PASSWORD_VALIDATORS = [
    {
        'NAME': 'django.contrib.auth.password_validation.UserAttributeSimilarityValidator',
    },
    {
        'NAME': 'django.contrib.auth.password_validation.MinimumLengthValidator',
    },
    {
        'NAME': 'django.contrib.auth.password_validation.CommonPasswordValidator',
    },
    {
        'NAME': 'django.contrib.auth.password_validation.NumericPasswordValidator',
    },
]


# Internationalization
# https://docs.djangoproject.com/en/5.1/topics/i18n/

LANGUAGE_CODE = 'en-us'

TIME_ZONE = 'UTC'

USE_I18N = True

USE_TZ = True


# Static files (CSS, JavaScript, Images)
# https://docs.djangoproject.com/en/5.1/howto/static-files/

STATIC_URL = 'static/'

# Default primary key field type
# https://docs.djangoproject.com/en/5.1/ref/settings/#default-auto-field

DEFAULT_AUTO_FIELD = 'django.db.models.BigAutoField'

# Allow Next.js to talk to Django
CORS_ALLOWED_ORIGINS = [
    "http://localhost:3000",
]

AUTH_USER_MODEL = 'users.User'

# Media files (User uploads)
MEDIA_URL = '/media/'
MEDIA_ROOT = os.path.join(BASE_DIR, 'media')

# --- DRF & AUTH CONFIGURATION ---

REST_FRAMEWORK = {
    'DEFAULT_AUTHENTICATION_CLASSES': (
        'rest_framework_simplejwt.authentication.JWTAuthentication',
    ),
    'DEFAULT_PERMISSION_CLASSES': [
        'rest_framework.permissions.AllowAny',
    ],
    # --- PAGINATION ---
    'DEFAULT_PAGINATION_CLASS': 'rest_framework.pagination.PageNumberPagination',
    'PAGE_SIZE': 10, # How many items per page
}

from datetime import timedelta

SIMPLE_JWT = {
    'ACCESS_TOKEN_LIFETIME': timedelta(minutes=60),
    'REFRESH_TOKEN_LIFETIME': timedelta(days=1),
    'AUTH_HEADER_TYPES': ('JWT',),
}

DJOSER = {
    'LOGIN_FIELD': 'email',
    'USER_CREATE_PASSWORD_RETYPE': True,
    'SERIALIZERS': {
        'user_create': 'djoser.serializers.UserCreateSerializer',
        # Update these two lines to use your new serializer:
        'user': 'users.serializers.CustomUserSerializer',
        'current_user': 'users.serializers.CustomUserSerializer',
    },
}
--- END OF FILE: ./backend/core/settings.py ---


--- START OF FILE: ./backend/core/urls.py ---
from django.contrib import admin
from django.urls import path, include
from django.conf import settings
from django.conf.urls.static import static

urlpatterns = [
    path('admin/', admin.site.urls),
    path('api/', include('api.urls')),
]

# This logic is what serves the image files during development
# It connects the URL '/media/' to your actual 'media' folder
if settings.DEBUG:
    urlpatterns += static(settings.MEDIA_URL, document_root=settings.MEDIA_ROOT)
--- END OF FILE: ./backend/core/urls.py ---


--- START OF FILE: ./backend/core/wsgi.py ---
"""
WSGI config for core project.

It exposes the WSGI callable as a module-level variable named ``application``.

For more information on this file, see
https://docs.djangoproject.com/en/5.1/howto/deployment/wsgi/
"""

import os

from django.core.wsgi import get_wsgi_application

os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'core.settings')

application = get_wsgi_application()

--- END OF FILE: ./backend/core/wsgi.py ---


--- START OF FILE: ./backend/users/models.py ---
from django.contrib.auth.models import AbstractUser, BaseUserManager
from django.db import models
from django.utils.translation import gettext_lazy as _
from django.core.validators import FileExtensionValidator
from organization.models import Municipality, Club, Interest
from datetime import date

# Define allowed file types for user avatars
user_avatar_validator = FileExtensionValidator(allowed_extensions=['jpg', 'jpeg', 'png', 'svg', 'gif'])

class CustomUserManager(BaseUserManager):
    def create_user(self, email, password=None, **extra_fields):
        if not email:
            raise ValueError('The Email field must be set')
        email = self.normalize_email(email)
        user = self.model(email=email, **extra_fields)
        user.set_password(password)
        user.save(using=self._db)
        return user

    def create_superuser(self, email, password=None, **extra_fields):
        extra_fields.setdefault('is_staff', True)
        extra_fields.setdefault('is_superuser', True)
        extra_fields.setdefault('role', 'SUPER_ADMIN')
        return self.create_user(email, password, **extra_fields)

class User(AbstractUser):
    class Role(models.TextChoices):
        SUPER_ADMIN = 'SUPER_ADMIN', 'Super Admin'
        MUNICIPALITY_ADMIN = 'MUNICIPALITY_ADMIN', 'Municipality Admin'
        CLUB_ADMIN = 'CLUB_ADMIN', 'Club Admin'
        YOUTH_MEMBER = 'YOUTH_MEMBER', 'Youth Member'
        GUARDIAN = 'GUARDIAN', 'Guardian'
        
    class Gender(models.TextChoices):
        MALE = 'MALE', 'Male'
        FEMALE = 'FEMALE', 'Female'
        OTHER = 'OTHER', 'Other'

    # New Verification Status Enum
    class VerificationStatus(models.TextChoices):
        UNVERIFIED = 'UNVERIFIED', 'Unverified'
        PENDING = 'PENDING', 'Pending'
        VERIFIED = 'VERIFIED', 'Verified'

    username = None
    email = models.EmailField(_('email address'), unique=True)

    # --- Base Profile Fields ---
    role = models.CharField(max_length=50, choices=Role.choices, default=Role.YOUTH_MEMBER)
    phone_number = models.CharField(max_length=20, blank=True, null=True)
    preferred_language = models.CharField(max_length=10, default='sv')
    avatar = models.FileField(
        upload_to='users/avatars/',
        blank=True,
        null=True,
        validators=[user_avatar_validator]
    )
    notification_email_enabled = models.BooleanField(default=True)
    
    # --- Verification Field ---
    verification_status = models.CharField(
        max_length=20, 
        choices=VerificationStatus.choices, 
        default=VerificationStatus.UNVERIFIED,
        help_text="Status of identity verification"
    )
    
    # Shared Fields
    nickname = models.CharField(max_length=50, blank=True)
    legal_gender = models.CharField(max_length=10, choices=Gender.choices, blank=True)

    # Admin Assignments
    assigned_municipality = models.ForeignKey(
        Municipality, on_delete=models.SET_NULL, null=True, blank=True,
        related_name='admins'
    )
    assigned_club = models.ForeignKey(
        Club, on_delete=models.SET_NULL, null=True, blank=True,
        related_name='admins'
    )
    profession = models.CharField(max_length=100, blank=True)
    hide_contact_info = models.BooleanField(default=False)

    # Youth Fields
    grade = models.IntegerField(blank=True, null=True)
    interests = models.ManyToManyField(Interest, blank=True, related_name='users')
    preferred_club = models.ForeignKey(
        Club, on_delete=models.SET_NULL, null=True, blank=True,
        related_name='members'
    )
    preferred_gender = models.CharField(max_length=50, blank=True)
    date_of_birth = models.DateField(null=True, blank=True)

    objects = CustomUserManager()
    USERNAME_FIELD = 'email'
    REQUIRED_FIELDS = []

    def __str__(self):
        return f"{self.email} ({self.get_role_display()})"

    @property
    def age(self):
        if not self.date_of_birth:
            return None
        today = date.today()
        return today.year - self.date_of_birth.year - ((today.month, today.day) < (self.date_of_birth.month, self.date_of_birth.day))


class GuardianYouthLink(models.Model):
    """
    Links a Guardian to a Youth Member.
    """
    RELATIONSHIP_CHOICES = [
        ('MOTHER', 'Mother'),
        ('FATHER', 'Father'),
        ('GUARDIAN', 'Legal Guardian'),
        ('SIBLING', 'Sibling'),
        ('OTHER', 'Other'),
    ]
    
    STATUS_CHOICES = [
        ('PENDING', 'Pending Approval'),
        ('ACTIVE', 'Active'),
        ('REJECTED', 'Rejected'),
    ]

    guardian = models.ForeignKey(
        User, 
        on_delete=models.CASCADE, 
        related_name='youth_links',
        limit_choices_to={'role': User.Role.GUARDIAN}
    )
    
    youth = models.ForeignKey(
        User, 
        on_delete=models.CASCADE, 
        related_name='guardian_links',
        limit_choices_to={'role': User.Role.YOUTH_MEMBER}
    )
    
    relationship_type = models.CharField(max_length=20, choices=RELATIONSHIP_CHOICES)
    is_primary_guardian = models.BooleanField(default=False)
    status = models.CharField(max_length=20, choices=STATUS_CHOICES, default='PENDING')
    
    created_at = models.DateTimeField(auto_now_add=True)
    verified_at = models.DateTimeField(blank=True, null=True)

    class Meta:
        unique_together = ('guardian', 'youth')

    def __str__(self):
        return f"{self.guardian.first_name} -> {self.youth.first_name}"


# --- PROXY MODELS ---

class YouthMember(User):
    class Meta:
        proxy = True
        verbose_name = "Youth Member"
        verbose_name_plural = "Youth Members"

class Guardian(User):
    class Meta:
        proxy = True
        verbose_name = "Guardian"
        verbose_name_plural = "Guardians"

class ClubAdmin(User):
    class Meta:
        proxy = True
        verbose_name = "Club Staff"
        verbose_name_plural = "Club Staff"

class MunicipalityAdmin(User):
    class Meta:
        proxy = True
        verbose_name = "Municipality Admin"
        verbose_name_plural = "Municipality Admins"
--- END OF FILE: ./backend/users/models.py ---


--- START OF FILE: ./backend/users/serializers.py ---
from rest_framework import serializers
from .models import User, GuardianYouthLink
from django.http import QueryDict

class CustomUserSerializer(serializers.ModelSerializer):
    """
    Standard serializer for reading user data.
    """
    guardians = serializers.SerializerMethodField()
    # Add youth_members for Guardians viewing their profile
    youth_members = serializers.SerializerMethodField()

    class Meta:
        model = User
        fields = [
            'id', 'email', 'first_name', 'last_name', 
            'role', 'phone_number', 'profession', 
            'assigned_municipality', 'assigned_club',
            'grade', 'preferred_club', 'nickname',
            'legal_gender', 'preferred_gender', 'date_of_birth',
            'avatar', 'preferred_language', 'is_active',
            'date_joined', 'last_login', 'hide_contact_info', 'interests',
            'verification_status', 'guardians', 'youth_members'
        ]
        read_only_fields = ['id', 'date_joined', 'last_login']

    def get_guardians(self, obj):
        # If obj is a Youth, return their guardians
        return list(obj.guardian_links.values_list('guardian_id', flat=True))

    def get_youth_members(self, obj):
        # If obj is a Guardian, return their youth
        return list(obj.youth_links.values_list('youth_id', flat=True))


class UserManagementSerializer(serializers.ModelSerializer):
    """
    Used by Super Admins to create AND update users.
    """
    password = serializers.CharField(write_only=True, required=False)
    
    # For Youth: List of Guardian IDs
    guardians = serializers.ListField(child=serializers.IntegerField(), required=False, write_only=True)
    
    # For Guardians: List of Youth IDs (New)
    youth_members = serializers.ListField(child=serializers.IntegerField(), required=False, write_only=True)

    class Meta:
        model = User
        fields = [
            'id', 'email', 'password', 'first_name', 'last_name', 
            'role', 'phone_number', 'profession', 
            'assigned_municipality', 'assigned_club',
            'grade', 'preferred_club', 'interests', 
            'nickname', 'legal_gender', 'preferred_gender', 
            'date_of_birth', 'hide_contact_info', 'avatar',
            'verification_status', 'guardians', 'youth_members'
        ]

    def create(self, validated_data):
        password = validated_data.pop('password')
        email = validated_data.pop('email')
        interests = validated_data.pop('interests', [])
        guardian_ids = validated_data.pop('guardians', [])
        youth_ids = validated_data.pop('youth_members', [])
        
        user = User.objects.create_user(email, password=password, **validated_data)
        
        if interests:
            user.interests.set(interests)
            
        # Case 1: Creating a Youth (Link to Guardians)
        if guardian_ids:
            for gid in guardian_ids:
                GuardianYouthLink.objects.create(
                    youth=user, guardian_id=gid, relationship_type='GUARDIAN', status='ACTIVE'
                )

        # Case 2: Creating a Guardian (Link to Youth)
        if youth_ids:
            for yid in youth_ids:
                GuardianYouthLink.objects.create(
                    guardian=user, youth_id=yid, relationship_type='GUARDIAN', status='ACTIVE'
                )
            
        return user

    def update(self, instance, validated_data):
        password = validated_data.pop('password', None)
        interests = validated_data.pop('interests', None)
        guardian_ids = validated_data.pop('guardians', None)
        youth_ids = validated_data.pop('youth_members', None)
        
        # --- Handle Data Extraction from FormData (QueryDict) ---
        if hasattr(self, 'initial_data'):
            request_data = self.initial_data
            if isinstance(request_data, QueryDict):
                # Handle Interests
                if interests is None:
                    raw = request_data.getlist('interests')
                    if raw: interests = [int(i) for i in raw if i.strip()]
                
                # Handle Guardians
                if guardian_ids is None:
                    raw = request_data.getlist('guardians')
                    if raw: guardian_ids = [int(i) for i in raw if i.strip()]

                # Handle Youth Members (New)
                if youth_ids is None:
                    raw = request_data.getlist('youth_members')
                    if raw: youth_ids = [int(i) for i in raw if i.strip()]

        if password:
            instance.set_password(password)
        
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        
        instance.save()
        
        if interests is not None:
            instance.interests.set(interests)
            
        # Sync Guardians (If User is Youth)
        if guardian_ids is not None:
            instance.guardian_links.all().delete()
            for gid in guardian_ids:
                GuardianYouthLink.objects.create(
                    youth=instance, guardian_id=gid, relationship_type='GUARDIAN', status='ACTIVE'
                )

        # Sync Youth (If User is Guardian)
        if youth_ids is not None:
            instance.youth_links.all().delete()
            for yid in youth_ids:
                GuardianYouthLink.objects.create(
                    guardian=instance, youth_id=yid, relationship_type='GUARDIAN', status='ACTIVE'
                )
            
        return instance

--- END OF FILE: ./backend/users/serializers.py ---


--- START OF FILE: ./backend/users/apps.py ---
from django.apps import AppConfig


class UsersConfig(AppConfig):
    default_auto_field = 'django.db.models.BigAutoField'
    name = 'users'

--- END OF FILE: ./backend/users/apps.py ---


--- START OF FILE: ./backend/users/admin.py ---
from django.contrib import admin
from django.contrib.auth.admin import UserAdmin
from .models import User, YouthMember, Guardian, ClubAdmin, MunicipalityAdmin, GuardianYouthLink

# --- INLINES ---

class GuardianLinkInline(admin.TabularInline):
    model = GuardianYouthLink
    fk_name = 'guardian' 
    extra = 0
    verbose_name = "Linked Youth"
    verbose_name_plural = "Linked Youth Members"
    raw_id_fields = ['youth']

class YouthLinkInline(admin.TabularInline):
    model = GuardianYouthLink
    fk_name = 'youth'
    extra = 0
    verbose_name = "Linked Guardian"
    verbose_name_plural = "Linked Guardians"
    raw_id_fields = ['guardian']

# --- BASE ADMIN SETUP ---

class BaseRoleAdmin(UserAdmin):
    ordering = ['email']
    list_display = ('email', 'first_name', 'last_name', 'role')
    search_fields = ('email', 'first_name', 'last_name')
    
    fieldsets = (
        (None, {'fields': ('email', 'password')}),
        ('Personal info', {'fields': ('first_name', 'last_name')}),
        ('Permissions', {'fields': ('is_active', 'is_staff', 'is_superuser')}),
        ('Important dates', {'fields': ('last_login', 'date_joined')}),
    )
    
    add_fieldsets = (
        (None, {
            'classes': ('wide',),
            'fields': ('email', 'first_name', 'last_name', 'role', 'password1', 'password2'),
        }),
    )

# --- SPECIFIC ADMINS ---

@admin.register(YouthMember)
class YouthMemberAdmin(BaseRoleAdmin):
    list_display = ('email', 'first_name', 'last_name', 'get_age_display', 'grade', 'preferred_club')
    search_fields = ('email', 'first_name', 'last_name', 'nickname')
    
    fieldsets = (
        ('Account', {'fields': ('email', 'password', 'role', 'is_active')}),
        ('Profile', {
            'fields': (
                'first_name', 'last_name', 'nickname', 
                'phone_number', 'avatar', 'preferred_language'
            )
        }),
        ('Demographics', {
            'fields': ('date_of_birth', 'get_age_display', 'legal_gender', 'preferred_gender')
        }),
        ('Youth Specifics', {'fields': ('grade', 'preferred_club', 'interests')}),
    )
    
    readonly_fields = ('get_age_display',)
    inlines = [YouthLinkInline]

    def get_age_display(self, obj):
        return obj.age
    get_age_display.short_description = "Age"

    def get_queryset(self, request):
        return super().get_queryset(request).filter(role=User.Role.YOUTH_MEMBER)

    def save_model(self, request, obj, form, change):
        obj.role = User.Role.YOUTH_MEMBER
        super().save_model(request, obj, form, change)


@admin.register(Guardian)
class GuardianAdmin(BaseRoleAdmin):
    list_display = ('email', 'first_name', 'last_name', 'phone_number')
    search_fields = ('email', 'first_name', 'last_name', 'phone_number')
    
    fieldsets = (
        ('Account', {'fields': ('email', 'password', 'role', 'is_active')}),
        ('Profile', {
            'fields': (
                'first_name', 'last_name', 'phone_number', 
                'legal_gender', 'avatar'
            )
        }),
    )
    
    inlines = [GuardianLinkInline]

    def get_queryset(self, request):
        return super().get_queryset(request).filter(role=User.Role.GUARDIAN)

    def save_model(self, request, obj, form, change):
        obj.role = User.Role.GUARDIAN
        super().save_model(request, obj, form, change)


@admin.register(ClubAdmin)
class ClubAdminAdmin(BaseRoleAdmin):
    list_display = ('email', 'first_name', 'last_name', 'assigned_club')
    
    fieldsets = (
        ('Account', {'fields': ('email', 'password', 'role', 'is_active')}),
        ('Profile', {
            'fields': (
                'first_name', 'last_name', 'nickname', 
                'phone_number', 'legal_gender', 'avatar'
            )
        }),
        ('Professional Info', {
            'fields': ('profession', 'hide_contact_info', 'assigned_club')
        }),
    )

    def get_queryset(self, request):
        return super().get_queryset(request).filter(role=User.Role.CLUB_ADMIN)

    def save_model(self, request, obj, form, change):
        obj.role = User.Role.CLUB_ADMIN
        super().save_model(request, obj, form, change)


@admin.register(MunicipalityAdmin)
class MunicipalityAdminAdmin(BaseRoleAdmin):
    list_display = ('email', 'first_name', 'last_name', 'assigned_municipality')
    
    fieldsets = (
        ('Account', {'fields': ('email', 'password', 'role', 'is_active')}),
        ('Profile', {'fields': ('first_name', 'last_name', 'phone_number')}),
        ('Assignment', {'fields': ('assigned_municipality',)}),
    )

    def get_queryset(self, request):
        return super().get_queryset(request).filter(role=User.Role.MUNICIPALITY_ADMIN)

    def save_model(self, request, obj, form, change):
        obj.role = User.Role.MUNICIPALITY_ADMIN
        super().save_model(request, obj, form, change)

# Main User Admin (Super Admin View)
@admin.register(User)
class MainUserAdmin(UserAdmin):
    ordering = ['email']
    list_display = ('email', 'role', 'is_superuser')
    list_filter = ('role',)
    search_fields = ('email', 'first_name', 'last_name')
    
    fieldsets = (
        (None, {'fields': ('email', 'password')}),
        ('Personal info', {'fields': ('first_name', 'last_name', 'nickname', 'phone_number')}),
        ('Permissions', {'fields': ('role', 'is_superuser', 'is_staff', 'is_active')}),
    )
    
    add_fieldsets = (
        (None, {
            'classes': ('wide',),
            'fields': ('email', 'password1', 'password2', 'role'),
        }),
    )
--- END OF FILE: ./backend/users/admin.py ---


--- START OF FILE: ./backend/users/permissions.py ---
from rest_framework import permissions

class IsSuperAdmin(permissions.BasePermission):
    """
    Allows access only to Super Admins.
    """
    def has_permission(self, request, view):
        return bool(request.user and request.user.is_authenticated and request.user.role == 'SUPER_ADMIN')

class IsMunicipalityAdmin(permissions.BasePermission):
    """
    Allows access to Super Admins OR Municipality Admins.
    """
    def has_permission(self, request, view):
        if not request.user or not request.user.is_authenticated:
            return False
        return request.user.role in ['SUPER_ADMIN', 'MUNICIPALITY_ADMIN']
--- END OF FILE: ./backend/users/permissions.py ---


--- START OF FILE: ./backend/users/tests.py ---
from django.test import TestCase

# Create your tests here.

--- END OF FILE: ./backend/users/tests.py ---


--- START OF FILE: ./backend/users/views.py ---
from rest_framework import viewsets, filters
from rest_framework.decorators import action
from rest_framework.response import Response
from django.db.models import Count, Q
from django.utils import timezone
from datetime import timedelta

from .models import User, GuardianYouthLink
from .serializers import CustomUserSerializer, UserManagementSerializer
from .permissions import IsSuperAdmin

class UserViewSet(viewsets.ModelViewSet):
    """
    API endpoint that allows Super Admins to CRUD all users.
    """
    permission_classes = [IsSuperAdmin] 
    lookup_field = 'id'
    
    def get_queryset(self):
        queryset = User.objects.all().order_by('-date_joined')
        
        # Filters
        role = self.request.query_params.get('role', None)
        if role:
            queryset = queryset.filter(role=role)
        
        municipality = self.request.query_params.get('assigned_municipality', None)
        if municipality:
            queryset = queryset.filter(assigned_municipality=municipality)
        
        club = self.request.query_params.get('assigned_club', None)
        if club:
            queryset = queryset.filter(assigned_club=club)
        
        gender = self.request.query_params.get('legal_gender', None)
        if gender:
            queryset = queryset.filter(legal_gender=gender)
            
        return queryset

    def get_serializer_class(self):
        if self.action in ['create', 'update', 'partial_update']:
            return UserManagementSerializer
        return CustomUserSerializer

    @action(detail=False, methods=['get'])
    def stats(self, request):
        """
        Returns analytics data for the Admin Dashboard.
        Only counts Admins (excludes Youth/Guardians).
        """
        # Base query: Only Admins
        admin_roles = ['SUPER_ADMIN', 'MUNICIPALITY_ADMIN', 'CLUB_ADMIN']
        admins = User.objects.filter(role__in=admin_roles)

        # 1. Total Count
        total = admins.count()

        # 2. Breakdown by Role
        role_counts = admins.values('role').annotate(count=Count('id'))
        # Convert to dictionary { 'SUPER_ADMIN': 5, ... }
        roles_data = {item['role']: item['count'] for item in role_counts}

        # 3. Breakdown by Gender
        gender_counts = admins.values('legal_gender').annotate(count=Count('id'))
        gender_data = {item['legal_gender']: item['count'] for item in gender_counts}

        # 4. Activity (Last 7 Days)
        seven_days_ago = timezone.now() - timedelta(days=7)
        active_recently = admins.filter(last_login__gte=seven_days_ago).count()

        # 5. New Admins (Last 30 Days)
        thirty_days_ago = timezone.now() - timedelta(days=30)
        new_recently = admins.filter(date_joined__gte=thirty_days_ago).count()

        return Response({
            "total_admins": total,
            "roles": {
                "super": roles_data.get('SUPER_ADMIN', 0),
                "municipality": roles_data.get('MUNICIPALITY_ADMIN', 0),
                "club": roles_data.get('CLUB_ADMIN', 0)
            },
            "gender": {
                "male": gender_data.get('MALE', 0),
                "female": gender_data.get('FEMALE', 0),
                "other": gender_data.get('OTHER', 0)
            },
            "activity": {
                "active_7_days": active_recently,
                "new_30_days": new_recently
            }
        })

    @action(detail=False, methods=['get'])
    def youth_stats(self, request):
        """
        Returns analytics data specifically for Youth Members.
        """
        youth = User.objects.filter(role='YOUTH_MEMBER')

        # 1. Total Count
        total = youth.count()

        # 2. Breakdown by Grade
        grade_counts = youth.values('grade').annotate(count=Count('id')).order_by('grade')
        grade_data = {str(item['grade']): item['count'] for item in grade_counts if item['grade'] is not None}

        # 3. Breakdown by Gender
        gender_counts = youth.values('legal_gender').annotate(count=Count('id'))
        gender_data = {item['legal_gender']: item['count'] for item in gender_counts}

        # 4. Activity (Last 7 Days)
        seven_days_ago = timezone.now() - timedelta(days=7)
        active_recently = youth.filter(last_login__gte=seven_days_ago).count()

        return Response({
            "total_youth": total,
            "grades": grade_data,
            "gender": {
                "male": gender_data.get('MALE', 0),
                "female": gender_data.get('FEMALE', 0),
                "other": gender_data.get('OTHER', 0)
            },
            "activity": {
                "active_7_days": active_recently
            }
        })

    @action(detail=False, methods=['get'])
    def list_guardians(self, request):
        """
        Returns a simple list of all users with role GUARDIAN.
        Used for dropdowns.
        """
        guardians = User.objects.filter(role='GUARDIAN').values('id', 'first_name', 'last_name', 'email')
        return Response(list(guardians))

    @action(detail=False, methods=['get'])
    def guardian_stats(self, request):
        """
        Returns analytics data specifically for Guardians.
        """
        guardians = User.objects.filter(role='GUARDIAN')

        # 1. Total Count
        total = guardians.count()

        # 2. Verification Status Breakdown
        status_counts = guardians.values('verification_status').annotate(count=Count('id'))
        status_data = {item['verification_status']: item['count'] for item in status_counts}

        # 3. Activity (Last 7 Days)
        seven_days_ago = timezone.now() - timedelta(days=7)
        active_recently = guardians.filter(last_login__gte=seven_days_ago).count()

        # 4. Connected Youth Count (Avg or Total links)
        # Just counting total links for simplicity here
        total_connections = GuardianYouthLink.objects.count()

        return Response({
            "total_guardians": total,
            "verification": {
                "verified": status_data.get('VERIFIED', 0),
                "pending": status_data.get('PENDING', 0),
                "unverified": status_data.get('UNVERIFIED', 0)
            },
            "activity": {
                "active_7_days": active_recently,
                "total_connections": total_connections
            }
        })

    @action(detail=False, methods=['get'])
    def list_youth(self, request):
        """
        Returns a simple list of all Youth Members.
        Used for dropdowns in Guardian management.
        """
        youth = User.objects.filter(role='YOUTH_MEMBER').values('id', 'first_name', 'last_name', 'email', 'grade')
        return Response(list(youth))
--- END OF FILE: ./backend/users/views.py ---


--- START OF FILE: ./backend/users/management/commands/increment_grades.py ---
from django.core.management.base import BaseCommand
from django.db.models import F
from users.models import User
from django.utils import timezone

class Command(BaseCommand):
    help = 'Increments the grade of all youth members by 1. Should be run on July 1st.'

    def handle(self, *args, **options):
        # 1. Identify users who have a grade (Youth Members)
        youth_with_grades = User.objects.filter(role='YOUTH_MEMBER', grade__isnull=False)
        
        count = youth_with_grades.count()
        
        if count == 0:
            self.stdout.write(self.style.WARNING('No youth members with grades found.'))
            return

        self.stdout.write(f"Found {count} youth members. Incrementing grades...")

        # 2. Increment grade by 1 efficiently in the database
        # F('grade') + 1 tells the database to take the existing value and add 1
        youth_with_grades.update(grade=F('grade') + 1)

        self.stdout.write(self.style.SUCCESS(f'Successfully incremented grades for {count} users.'))
        self.stdout.write(f"Operation completed on {timezone.now().date()}")
--- END OF FILE: ./backend/users/management/commands/increment_grades.py ---


--- START OF FILE: ./backend/api/models.py ---
from django.db import models

# Create your models here.

--- END OF FILE: ./backend/api/models.py ---


--- START OF FILE: ./backend/api/apps.py ---
from django.apps import AppConfig


class ApiConfig(AppConfig):
    default_auto_field = 'django.db.models.BigAutoField'
    name = 'api'

--- END OF FILE: ./backend/api/apps.py ---


--- START OF FILE: ./backend/api/admin.py ---
from django.contrib import admin

# Register your models here.

--- END OF FILE: ./backend/api/admin.py ---


--- START OF FILE: ./backend/api/tests.py ---
from django.test import TestCase

# Create your tests here.

--- END OF FILE: ./backend/api/tests.py ---


--- START OF FILE: ./backend/api/urls.py ---
from django.urls import path, include
from rest_framework.routers import DefaultRouter
from .views import HealthCheckView
from users.views import UserViewSet # Import the new view

# Create a router for our custom endpoints
router = DefaultRouter()
router.register(r'users', UserViewSet, basename='user')

urlpatterns = [
    path('health/', HealthCheckView.as_view(), name='health_check'),
    
    # Djoser Auth (Login/Register self)
    path('auth/', include('djoser.urls')),
    path('auth/', include('djoser.urls.jwt')),
    
    # Our Custom User Management (Manage others)
    # This creates /api/users/
    path('', include(router.urls)), 
    
    # Organization URLs
    path('', include('organization.urls')),
]
--- END OF FILE: ./backend/api/urls.py ---


--- START OF FILE: ./backend/api/views.py ---
from rest_framework.views import APIView
from rest_framework.response import Response

class HealthCheckView(APIView):
    """
    A simple endpoint to check if the backend is running 
    and accessible by the frontend.
    """
    def get(self, request):
        return Response({
            "status": "success",
            "message": "Hello from Django! The Youth App Backend is operational."
        })
--- END OF FILE: ./backend/api/views.py ---
