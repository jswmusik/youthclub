=== FOCUSED CONTEXT ===



--- START OF FILE: backend/users/models.py ---
from django.contrib.auth.models import AbstractUser, BaseUserManager
from django.db import models
from django.utils.translation import gettext_lazy as _
from django.core.validators import FileExtensionValidator
from organization.models import Municipality, Club, Interest
from datetime import date

# Define allowed file types for user avatars
user_avatar_validator = FileExtensionValidator(allowed_extensions=['jpg', 'jpeg', 'png', 'svg', 'gif'])

class CustomUserManager(BaseUserManager):
    def create_user(self, email, password=None, **extra_fields):
        if not email:
            raise ValueError('The Email field must be set')
        email = self.normalize_email(email)
        user = self.model(email=email, **extra_fields)
        user.set_password(password)
        user.save(using=self._db)
        return user

    def create_superuser(self, email, password=None, **extra_fields):
        extra_fields.setdefault('is_staff', True)
        extra_fields.setdefault('is_superuser', True)
        extra_fields.setdefault('role', 'SUPER_ADMIN')
        return self.create_user(email, password, **extra_fields)

class User(AbstractUser):
    class Role(models.TextChoices):
        SUPER_ADMIN = 'SUPER_ADMIN', 'Super Admin'
        MUNICIPALITY_ADMIN = 'MUNICIPALITY_ADMIN', 'Municipality Admin'
        CLUB_ADMIN = 'CLUB_ADMIN', 'Club Admin'
        YOUTH_MEMBER = 'YOUTH_MEMBER', 'Youth Member'
        GUARDIAN = 'GUARDIAN', 'Guardian'
        
    class Gender(models.TextChoices):
        MALE = 'MALE', 'Male'
        FEMALE = 'FEMALE', 'Female'
        OTHER = 'OTHER', 'Other'

    # New Verification Status Enum
    class VerificationStatus(models.TextChoices):
        UNVERIFIED = 'UNVERIFIED', 'Unverified'
        PENDING = 'PENDING', 'Pending'
        VERIFIED = 'VERIFIED', 'Verified'

    username = None
    email = models.EmailField(_('email address'), unique=True)

    # --- Base Profile Fields ---
    role = models.CharField(max_length=50, choices=Role.choices, default=Role.YOUTH_MEMBER)
    phone_number = models.CharField(max_length=20, blank=True, null=True)
    preferred_language = models.CharField(max_length=10, default='sv')
    avatar = models.FileField(
        upload_to='users/avatars/',
        blank=True,
        null=True,
        validators=[user_avatar_validator]
    )
    notification_email_enabled = models.BooleanField(default=True)
    
    # --- Verification Field ---
    verification_status = models.CharField(
        max_length=20, 
        choices=VerificationStatus.choices, 
        default=VerificationStatus.UNVERIFIED,
        help_text="Status of identity verification"
    )
    
    # Shared Fields
    nickname = models.CharField(max_length=50, blank=True)
    legal_gender = models.CharField(max_length=10, choices=Gender.choices, blank=True)

    # Admin Assignments
    assigned_municipality = models.ForeignKey(
        Municipality, on_delete=models.SET_NULL, null=True, blank=True,
        related_name='admins'
    )
    assigned_club = models.ForeignKey(
        Club, on_delete=models.SET_NULL, null=True, blank=True,
        related_name='admins'
    )
    profession = models.CharField(max_length=100, blank=True)
    hide_contact_info = models.BooleanField(default=False)

    # Youth Fields
    grade = models.IntegerField(blank=True, null=True)
    interests = models.ManyToManyField(Interest, blank=True, related_name='users')
    preferred_club = models.ForeignKey(
        Club, on_delete=models.SET_NULL, null=True, blank=True,
        related_name='members'
    )
    preferred_gender = models.CharField(max_length=50, blank=True)
    date_of_birth = models.DateField(null=True, blank=True)

    objects = CustomUserManager()
    USERNAME_FIELD = 'email'
    REQUIRED_FIELDS = []

    def __str__(self):
        return f"{self.email} ({self.get_role_display()})"

    @property
    def age(self):
        if not self.date_of_birth:
            return None
        today = date.today()
        return today.year - self.date_of_birth.year - ((today.month, today.day) < (self.date_of_birth.month, self.date_of_birth.day))


class GuardianYouthLink(models.Model):
    """
    Links a Guardian to a Youth Member.
    """
    RELATIONSHIP_CHOICES = [
        ('MOTHER', 'Mother'),
        ('FATHER', 'Father'),
        ('GUARDIAN', 'Legal Guardian'),
        ('SIBLING', 'Sibling'),
        ('OTHER', 'Other'),
    ]
    
    STATUS_CHOICES = [
        ('PENDING', 'Pending Approval'),
        ('ACTIVE', 'Active'),
        ('REJECTED', 'Rejected'),
    ]

    guardian = models.ForeignKey(
        User, 
        on_delete=models.CASCADE, 
        related_name='youth_links',
        limit_choices_to={'role': User.Role.GUARDIAN}
    )
    
    youth = models.ForeignKey(
        User, 
        on_delete=models.CASCADE, 
        related_name='guardian_links',
        limit_choices_to={'role': User.Role.YOUTH_MEMBER}
    )
    
    relationship_type = models.CharField(max_length=20, choices=RELATIONSHIP_CHOICES)
    is_primary_guardian = models.BooleanField(default=False)
    status = models.CharField(max_length=20, choices=STATUS_CHOICES, default='PENDING')
    
    created_at = models.DateTimeField(auto_now_add=True)
    verified_at = models.DateTimeField(blank=True, null=True)

    class Meta:
        unique_together = ('guardian', 'youth')

    def __str__(self):
        return f"{self.guardian.first_name} -> {self.youth.first_name}"


class UserLoginHistory(models.Model):
    """
    Stores a simple audit trail of user logins.
    """
    user = models.ForeignKey(User, on_delete=models.CASCADE, related_name='login_history')
    timestamp = models.DateTimeField(auto_now_add=True)
    ip_address = models.GenericIPAddressField(null=True, blank=True)
    user_agent = models.CharField(max_length=512, blank=True)

    class Meta:
        ordering = ['-timestamp']

    def __str__(self):
        return f"{self.user.email} @ {self.timestamp}"


# --- PROXY MODELS ---

class YouthMember(User):
    class Meta:
        proxy = True
        verbose_name = "Youth Member"
        verbose_name_plural = "Youth Members"

class Guardian(User):
    class Meta:
        proxy = True
        verbose_name = "Guardian"
        verbose_name_plural = "Guardians"

class ClubAdmin(User):
    class Meta:
        proxy = True
        verbose_name = "Club Staff"
        verbose_name_plural = "Club Staff"

class MunicipalityAdmin(User):
    class Meta:
        proxy = True
        verbose_name = "Municipality Admin"
        verbose_name_plural = "Municipality Admins"
--- END OF FILE: backend/users/models.py ---


--- START OF FILE: backend/users/serializers.py ---
from rest_framework import serializers
from .models import User, GuardianYouthLink
from django.http import QueryDict

class CustomUserSerializer(serializers.ModelSerializer):
    """
    Standard serializer for reading user data.
    """
    guardians = serializers.SerializerMethodField()
    # Add youth_members for Guardians viewing their profile
    youth_members = serializers.SerializerMethodField()

    class Meta:
        model = User
        fields = [
            'id', 'email', 'first_name', 'last_name', 
            'role', 'phone_number', 'profession', 
            'assigned_municipality', 'assigned_club',
            'grade', 'preferred_club', 'nickname',
            'legal_gender', 'preferred_gender', 'date_of_birth',
            'avatar', 'preferred_language', 'is_active',
            'date_joined', 'last_login', 'hide_contact_info', 'interests',
            'verification_status', 'guardians', 'youth_members'
        ]
        read_only_fields = ['id', 'date_joined', 'last_login']

    def get_guardians(self, obj):
        # If obj is a Youth, return their guardians
        return list(obj.guardian_links.values_list('guardian_id', flat=True))

    def get_youth_members(self, obj):
        # If obj is a Guardian, return their youth
        return list(obj.youth_links.values_list('youth_id', flat=True))


class UserManagementSerializer(serializers.ModelSerializer):
    """
    Used by Super Admins to create AND update users.
    """
    password = serializers.CharField(write_only=True, required=False)
    
    # For Youth: List of Guardian IDs
    guardians = serializers.ListField(child=serializers.IntegerField(), required=False, write_only=True)
    
    # For Guardians: List of Youth IDs (New)
    youth_members = serializers.ListField(child=serializers.IntegerField(), required=False, write_only=True)

    class Meta:
        model = User
        fields = [
            'id', 'email', 'password', 'first_name', 'last_name',
            'role', 'phone_number', 'profession',
            'assigned_municipality', 'assigned_club',
            'grade', 'preferred_club', 'interests',
            'nickname', 'legal_gender', 'preferred_gender',
            'date_of_birth', 'hide_contact_info', 'avatar',
            'verification_status', 'guardians', 'youth_members',
            'preferred_language'
        ]

    def _filter_youth_ids_by_scope(self, youth_ids):
        if not youth_ids:
            return youth_ids
        request = self.context.get('request')
        if not request:
            return youth_ids

        requester = request.user
        if getattr(requester, 'role', None) == 'MUNICIPALITY_ADMIN' and requester.assigned_municipality:
            allowed_ids = set(
                User.objects.filter(
                    role='YOUTH_MEMBER',
                    preferred_club__municipality=requester.assigned_municipality
                ).values_list('id', flat=True)
            )
            return [yid for yid in youth_ids if yid in allowed_ids]
        return youth_ids

    def create(self, validated_data):
        password = validated_data.pop('password')
        email = validated_data.pop('email')
        interests = validated_data.pop('interests', [])
        guardian_ids = validated_data.pop('guardians', [])
        youth_ids = validated_data.pop('youth_members', [])

        youth_ids = self._filter_youth_ids_by_scope(youth_ids)
        
        user = User.objects.create_user(email, password=password, **validated_data)
        
        if interests:
            user.interests.set(interests)
            
        # Case 1: Creating a Youth (Link to Guardians)
        if guardian_ids:
            for gid in guardian_ids:
                GuardianYouthLink.objects.create(
                    youth=user, guardian_id=gid, relationship_type='GUARDIAN', status='ACTIVE'
                )

        # Case 2: Creating a Guardian (Link to Youth)
        if youth_ids:
            for yid in youth_ids:
                GuardianYouthLink.objects.create(
                    guardian=user, youth_id=yid, relationship_type='GUARDIAN', status='ACTIVE'
                )
            
        return user

    def update(self, instance, validated_data):
        password = validated_data.pop('password', None)
        interests = validated_data.pop('interests', None)
        guardian_ids = validated_data.pop('guardians', None)
        youth_ids = validated_data.pop('youth_members', None)
        
        # --- Handle Data Extraction from FormData (QueryDict) ---
        if hasattr(self, 'initial_data'):
            request_data = self.initial_data
            if isinstance(request_data, QueryDict):
                # Handle Interests
                if interests is None:
                    raw = request_data.getlist('interests')
                    if raw: interests = [int(i) for i in raw if i.strip()]
                
                # Handle Guardians
                if guardian_ids is None:
                    raw = request_data.getlist('guardians')
                    if raw: guardian_ids = [int(i) for i in raw if i.strip()]

                # Handle Youth Members (New)
                if youth_ids is None:
                    raw = request_data.getlist('youth_members')
                    if raw: youth_ids = [int(i) for i in raw if i.strip()]

        youth_ids = self._filter_youth_ids_by_scope(youth_ids)

        if password:
            instance.set_password(password)
        
        for attr, value in validated_data.items():
            setattr(instance, attr, value)
        
        instance.save()
        
        if interests is not None:
            instance.interests.set(interests)
            
        # Sync Guardians (If User is Youth)
        if guardian_ids is not None:
            instance.guardian_links.all().delete()
            for gid in guardian_ids:
                GuardianYouthLink.objects.create(
                    youth=instance, guardian_id=gid, relationship_type='GUARDIAN', status='ACTIVE'
                )

        # Sync Youth (If User is Guardian)
        if youth_ids is not None:
            instance.youth_links.all().delete()
            for yid in youth_ids:
                GuardianYouthLink.objects.create(
                    guardian=instance, youth_id=yid, relationship_type='GUARDIAN', status='ACTIVE'
                )
            
        return instance

--- END OF FILE: backend/users/serializers.py ---


--- START OF FILE: backend/users/permissions.py ---
from rest_framework import permissions

class IsSuperAdmin(permissions.BasePermission):
    """
    Allows access only to Super Admins.
    """
    def has_permission(self, request, view):
        return bool(request.user and request.user.is_authenticated and request.user.role == 'SUPER_ADMIN')

class IsMunicipalityAdmin(permissions.BasePermission):
    """
    Allows access to Super Admins OR Municipality Admins.
    """
    def has_permission(self, request, view):
        if not request.user or not request.user.is_authenticated:
            return False
        return request.user.role in ['SUPER_ADMIN', 'MUNICIPALITY_ADMIN']


class IsClubOrMunicipalityAdmin(permissions.BasePermission):
    """
    Allows access to Super Admins, Municipality Admins, or Club Admins.
    """
    def has_permission(self, request, view):
        if not request.user or not request.user.is_authenticated:
            return False
        return request.user.role in ['SUPER_ADMIN', 'MUNICIPALITY_ADMIN', 'CLUB_ADMIN']
--- END OF FILE: backend/users/permissions.py ---


--- START OF FILE: backend/users/views.py ---
from rest_framework import viewsets, filters, permissions
from rest_framework.decorators import action
from rest_framework.response import Response
from django.db.models import Count, Q
from django.utils import timezone
from datetime import timedelta, date

from .models import User, GuardianYouthLink, UserLoginHistory
from .serializers import CustomUserSerializer, UserManagementSerializer
from .permissions import IsSuperAdmin, IsMunicipalityAdmin, IsClubOrMunicipalityAdmin

class UserViewSet(viewsets.ModelViewSet):
    """
    API endpoint that allows Admins to CRUD users based on their scope.
    """
    permission_classes = [IsClubOrMunicipalityAdmin]
    lookup_field = 'id'

    def get_queryset(self):
        queryset = User.objects.all().order_by('-date_joined')
        user = self.request.user

        if getattr(user, 'role', None) == 'MUNICIPALITY_ADMIN' and user.assigned_municipality:
            queryset = queryset.filter(
                Q(assigned_municipality=user.assigned_municipality) |
                Q(assigned_club__municipality=user.assigned_municipality) |
                Q(preferred_club__municipality=user.assigned_municipality) |
                Q(guardian_links__youth__preferred_club__municipality=user.assigned_municipality) |
                Q(youth_links__youth__preferred_club__municipality=user.assigned_municipality)
            ).exclude(role='SUPER_ADMIN').distinct()
        elif getattr(user, 'role', None) == 'CLUB_ADMIN' and user.assigned_club:
            queryset = queryset.filter(
                Q(assigned_club=user.assigned_club) |
                Q(preferred_club=user.assigned_club) |
                Q(guardian_links__youth__preferred_club=user.assigned_club) |
                Q(youth_links__youth__preferred_club=user.assigned_club)
            ).exclude(role__in=['SUPER_ADMIN', 'MUNICIPALITY_ADMIN']).distinct()

        role = self.request.query_params.get('role')
        if role:
            queryset = queryset.filter(role=role)

        municipality = self.request.query_params.get('assigned_municipality')
        if municipality:
            queryset = queryset.filter(assigned_municipality=municipality)

        club = self.request.query_params.get('assigned_club')
        if club:
            queryset = queryset.filter(assigned_club=club)

        gender = self.request.query_params.get('legal_gender')
        if gender:
            queryset = queryset.filter(legal_gender=gender)

        search = self.request.query_params.get('search')
        if search:
            queryset = queryset.filter(
                Q(first_name__icontains=search) |
                Q(last_name__icontains=search) |
                Q(email__icontains=search)
            )

        grade_from = self.request.query_params.get('grade_from')
        if grade_from:
            try:
                queryset = queryset.filter(grade__gte=int(grade_from))
            except ValueError:
                pass

        grade_to = self.request.query_params.get('grade_to')
        if grade_to:
            try:
                queryset = queryset.filter(grade__lte=int(grade_to))
            except ValueError:
                pass

        age_from = self.request.query_params.get('age_from')
        if age_from:
            try:
                age_from_int = int(age_from)
                max_birth_date = date.today() - timedelta(days=365 * age_from_int)
                queryset = queryset.filter(date_of_birth__lte=max_birth_date)
            except (ValueError, TypeError):
                pass

        age_to = self.request.query_params.get('age_to')
        if age_to:
            try:
                age_to_int = int(age_to)
                min_birth_date = date.today() - timedelta(days=365 * (age_to_int + 1))
                queryset = queryset.filter(date_of_birth__gte=min_birth_date)
            except (ValueError, TypeError):
                pass

        verification_status = self.request.query_params.get('verification_status')
        if verification_status:
            queryset = queryset.filter(verification_status=verification_status)

        preferred_club = self.request.query_params.get('preferred_club')
        if preferred_club:
            queryset = queryset.filter(preferred_club=preferred_club)

        country = self.request.query_params.get('country')
        if country:
            queryset = queryset.filter(
                Q(preferred_club__municipality__country=country) |
                Q(assigned_municipality__country=country)
            )

        municipality_filter = self.request.query_params.get('municipality')
        if municipality_filter:
            queryset = queryset.filter(
                Q(preferred_club__municipality=municipality_filter) |
                Q(assigned_municipality=municipality_filter)
            )

        return queryset

    def get_serializer_class(self):
        if self.action in ['create', 'update', 'partial_update']:
            return UserManagementSerializer
        return CustomUserSerializer

    def perform_create(self, serializer):
        user = self.request.user

        if getattr(user, 'role', None) == 'MUNICIPALITY_ADMIN' and user.assigned_municipality:
            serializer.save(assigned_municipality=user.assigned_municipality)
        elif getattr(user, 'role', None) == 'CLUB_ADMIN' and user.assigned_club:
            serializer.save(
                assigned_club=user.assigned_club,
                assigned_municipality=user.assigned_municipality,
                role='CLUB_ADMIN'
            )
        else:
            serializer.save()

    def perform_update(self, serializer):
        user = self.request.user
        if getattr(user, 'role', None) == 'MUNICIPALITY_ADMIN' and user.assigned_municipality:
            serializer.save(assigned_municipality=user.assigned_municipality)
        elif getattr(user, 'role', None) == 'CLUB_ADMIN' and user.assigned_club:
            serializer.save(
                assigned_club=user.assigned_club,
                assigned_municipality=user.assigned_municipality,
                role='CLUB_ADMIN'
            )
        else:
            serializer.save()

    @action(detail=False, methods=['get'])
    def stats(self, request):
        """
        Returns analytics data for the Admin Dashboard.
        Only counts Admins (excludes Youth/Guardians).
        """
        # Base query: Only Admins
        admin_roles = ['SUPER_ADMIN', 'MUNICIPALITY_ADMIN', 'CLUB_ADMIN']
        admins = User.objects.filter(role__in=admin_roles)

        # 1. Total Count
        total = admins.count()

        # 2. Breakdown by Role
        role_counts = admins.values('role').annotate(count=Count('id'))
        # Convert to dictionary { 'SUPER_ADMIN': 5, ... }
        roles_data = {item['role']: item['count'] for item in role_counts}

        # 3. Breakdown by Gender
        gender_counts = admins.values('legal_gender').annotate(count=Count('id'))
        gender_data = {item['legal_gender']: item['count'] for item in gender_counts}

        # 4. Activity (Last 7 Days)
        seven_days_ago = timezone.now() - timedelta(days=7)
        active_recently = admins.filter(last_login__gte=seven_days_ago).count()

        # 5. New Admins (Last 30 Days)
        thirty_days_ago = timezone.now() - timedelta(days=30)
        new_recently = admins.filter(date_joined__gte=thirty_days_ago).count()

        return Response({
            "total_admins": total,
            "roles": {
                "super": roles_data.get('SUPER_ADMIN', 0),
                "municipality": roles_data.get('MUNICIPALITY_ADMIN', 0),
                "club": roles_data.get('CLUB_ADMIN', 0)
            },
            "gender": {
                "male": gender_data.get('MALE', 0),
                "female": gender_data.get('FEMALE', 0),
                "other": gender_data.get('OTHER', 0)
            },
            "activity": {
                "active_7_days": active_recently,
                "new_30_days": new_recently
            }
        })

    @action(detail=False, methods=['get'])
    def youth_stats(self, request):
        """
        Returns analytics data specifically for Youth Members.
        Scoped by Municipality if the user is a Municipality Admin.
        """
        user = request.user
        youth = User.objects.filter(role='YOUTH_MEMBER')

        if getattr(user, 'role', None) == 'MUNICIPALITY_ADMIN' and user.assigned_municipality:
            youth = youth.filter(preferred_club__municipality=user.assigned_municipality)
        elif getattr(user, 'role', None) == 'CLUB_ADMIN' and user.assigned_club:
            youth = youth.filter(preferred_club=user.assigned_club)

        total = youth.count()

        grade_counts = youth.values('grade').annotate(count=Count('id')).order_by('grade')
        grade_data = {str(item['grade']): item['count'] for item in grade_counts if item['grade'] is not None}

        gender_counts = youth.values('legal_gender').annotate(count=Count('id'))
        gender_data = {item['legal_gender']: item['count'] for item in gender_counts}

        seven_days_ago = timezone.now() - timedelta(days=7)
        active_recently = youth.filter(last_login__gte=seven_days_ago).count()

        return Response({
            "total_youth": total,
            "grades": grade_data,
            "gender": {
                "male": gender_data.get('MALE', 0),
                "female": gender_data.get('FEMALE', 0),
                "other": gender_data.get('OTHER', 0)
            },
            "activity": {
                "active_7_days": active_recently
            }
        })

    @action(detail=False, methods=['get'])
    def list_guardians(self, request):
        """
        Returns a list of guardians.
        Super Admin: All guardians.
        Muni Admin: Only guardians linked to youth within their municipality.
        """
        user = request.user
        guardians = User.objects.filter(role='GUARDIAN')
        if getattr(user, 'role', None) == 'MUNICIPALITY_ADMIN' and user.assigned_municipality:
            guardians = guardians.filter(
                youth_links__youth__preferred_club__municipality=user.assigned_municipality
            ).distinct()

        values = guardians.values('id', 'first_name', 'last_name', 'email')
        return Response(list(values))

    @action(detail=False, methods=['get'])
    def guardian_stats(self, request):
        """
        Returns analytics data specifically for Guardians.
        """
        guardians = User.objects.filter(role='GUARDIAN')

        # 1. Total Count
        total = guardians.count()

        # 2. Verification Status Breakdown
        status_counts = guardians.values('verification_status').annotate(count=Count('id'))
        status_data = {item['verification_status']: item['count'] for item in status_counts}

        # 3. Activity (Last 7 Days)
        seven_days_ago = timezone.now() - timedelta(days=7)
        active_recently = guardians.filter(last_login__gte=seven_days_ago).count()

        # 4. Connected Youth Count (Avg or Total links)
        # Just counting total links for simplicity here
        total_connections = GuardianYouthLink.objects.count()

        return Response({
            "total_guardians": total,
            "verification": {
                "verified": status_data.get('VERIFIED', 0),
                "pending": status_data.get('PENDING', 0),
                "unverified": status_data.get('UNVERIFIED', 0)
            },
            "activity": {
                "active_7_days": active_recently,
                "total_connections": total_connections
            }
        })

    @action(detail=False, methods=['get'])
    def list_youth(self, request):
        """
        Returns a simple list of all Youth Members.
        Used for dropdowns in Guardian management.
        """
        user = request.user
        youth = User.objects.filter(role='YOUTH_MEMBER')
        if getattr(user, 'role', None) == 'MUNICIPALITY_ADMIN' and user.assigned_municipality:
            youth = youth.filter(preferred_club__municipality=user.assigned_municipality)
        elif getattr(user, 'role', None) == 'CLUB_ADMIN' and user.assigned_club:
            youth = youth.filter(preferred_club=user.assigned_club)

        youth = youth.values('id', 'first_name', 'last_name', 'email', 'grade')
        return Response(list(youth))

    @action(detail=False, methods=['get'], permission_classes=[permissions.IsAuthenticated], url_path='login_history')
    def login_history(self, request):
        """
        Returns the latest 10 login events for the authenticated user.
        """
        history = UserLoginHistory.objects.filter(user=request.user).order_by('-timestamp')[:10]
        data = [
            {
                "id": log.id,
                "timestamp": log.timestamp,
                "ip_address": log.ip_address,
                "user_agent": log.user_agent,
            }
            for log in history
        ]
        return Response(data)

    @action(detail=False, methods=['post'], permission_classes=[permissions.IsAuthenticated], url_path='log_login')
    def log_login(self, request):
        """
        Stores a login entry for the authenticated user.
        Useful for keeping a lightweight audit trail when tokens are issued.
        """
        ip_address = request.META.get('HTTP_X_FORWARDED_FOR')
        if ip_address:
            ip_address = ip_address.split(',')[0].strip()
        else:
            ip_address = request.META.get('REMOTE_ADDR')

        user_agent = request.META.get('HTTP_USER_AGENT', '') or ''

        UserLoginHistory.objects.create(
            user=request.user,
            ip_address=ip_address,
            user_agent=user_agent[:512],
        )

        return Response({"status": "logged"})
--- END OF FILE: backend/users/views.py ---


--- START OF FILE: backend/api/urls.py ---
from django.urls import path, include
from rest_framework.routers import DefaultRouter
from .views import HealthCheckView
from users.views import UserViewSet # Import the new view
from system_messages.views import SystemMessageViewSet

# Create a router for our custom endpoints
router = DefaultRouter()
router.register(r'users', UserViewSet, basename='user')
router.register(r'messages', SystemMessageViewSet)

urlpatterns = [
    path('health/', HealthCheckView.as_view(), name='health_check'),
    
    # Djoser Auth (Login/Register self)
    path('auth/', include('djoser.urls')),
    path('auth/', include('djoser.urls.jwt')),
    
    # Our Custom User Management (Manage others)
    # This creates /api/users/
    path('', include(router.urls)), 
    
    # Organization URLs
    path('', include('organization.urls')),
]
--- END OF FILE: backend/api/urls.py ---


--- START OF FILE: frontend/context/AuthContext.tsx ---
'use client';

import { createContext, useContext, useState, useEffect, ReactNode } from 'react';
import Cookies from 'js-cookie';
import api from '../lib/api';
import { useRouter } from 'next/navigation';

interface User {
  id: number;
  email: string;
  first_name: string;
  last_name: string;
  role: string;
  avatar: string | null;
  assigned_municipality?: number | { id: number } | null;
  assigned_club?: number | { id: number } | null;
}

interface AuthContextType {
  user: User | null;
  login: (email: string, password: string) => Promise<void>;
  logout: () => void;
  loading: boolean;
  messageCount: number;
  refreshMessageCount: () => Promise<void>;
}

const AuthContext = createContext<AuthContextType | undefined>(undefined);

export function AuthProvider({ children }: { children: ReactNode }) {
  const [user, setUser] = useState<User | null>(null);
  const [loading, setLoading] = useState(true);
  const [messageCount, setMessageCount] = useState(0);
  const router = useRouter();

  // Check if user is already logged in when page loads
  useEffect(() => {
    const checkUser = async () => {
      const token = Cookies.get('access_token');
      if (token) {
        try {
          const res = await api.get('/auth/users/me/');
          setUser(res.data);
        } catch (error) {
          console.error("Session expired", error);
          Cookies.remove('access_token');
        }
      }
      setLoading(false);
    };
    checkUser();
  }, []);

  const refreshMessageCount = async () => {
    try {
      const res = await api.get('/messages/active_list/');
      const list = Array.isArray(res.data) ? res.data : [];
      setMessageCount(list.length);
    } catch (err) {
      console.error('Failed to load message count', err);
    }
  };

  const login = async (email: string, password: string) => {
    try {
      // 1. Get Token
      const res = await api.post('/auth/jwt/create/', { email, password });
      Cookies.set('access_token', res.data.access, { expires: 1 }); // Expires in 1 day
      Cookies.set('refresh_token', res.data.refresh, { expires: 1 });

      // 2. Get User Details
      const userRes = await api.get('/auth/users/me/');
      const userData = userRes.data;
      setUser(userData);
      refreshMessageCount();

      // Log the successful login for audit trail (ignore failures)
      try {
        await api.post('/users/log_login/');
      } catch (logErr) {
        console.error('Failed to log login event', logErr);
      }

      // 3. Redirect based on Role
      switch (userData.role) {
        case 'SUPER_ADMIN':
          router.push('/admin/super');
          break;
        case 'MUNICIPALITY_ADMIN':
          router.push('/admin/municipality');
          break;
        case 'CLUB_ADMIN':
          router.push('/admin/club');
          break;
        case 'GUARDIAN':
          router.push('/dashboard/guardian');
          break;
        case 'YOUTH_MEMBER':
          router.push('/dashboard/youth');
          break;
        default:
          router.push('/');
      }
    } catch (error) {
      console.error("Login failed", error);
      throw error;
    }
  };

  const logout = () => {
    Cookies.remove('access_token');
    Cookies.remove('refresh_token');
    setUser(null);
    setMessageCount(0);
    router.push('/login');
  };

  return (
    <AuthContext.Provider value={{ user, login, logout, loading, messageCount, refreshMessageCount }}>
      {children}
    </AuthContext.Provider>
  );
}

export const useAuth = () => {
  const context = useContext(AuthContext);
  if (!context) throw new Error('useAuth must be used within an AuthProvider');
  return context;
};
--- END OF FILE: frontend/context/AuthContext.tsx ---


--- START OF FILE: frontend/lib/api.ts ---
import axios from 'axios';
import Cookies from 'js-cookie';

const API_URL = 'http://localhost:8000/api';

const api = axios.create({
  baseURL: API_URL,
  headers: {
    'Content-Type': 'application/json',
  },
});

// Interceptor: Automatically add the Token to every request
api.interceptors.request.use((config) => {
  const token = Cookies.get('access_token');
  if (token) {
    config.headers.Authorization = `JWT ${token}`;
  }
  return config;
});

// Interceptor: Handle errors (like if token expires)
api.interceptors.response.use(
  (response) => response,
  (error) => {
    if (error.response && error.response.status === 401) {
      // If token is invalid, logout (optional: add refresh logic later)
      Cookies.remove('access_token');
      Cookies.remove('refresh_token');
      // window.location.href = '/login'; // Optional: Force redirect
    }
    return Promise.reject(error);
  }
);

export default api;
--- END OF FILE: frontend/lib/api.ts ---


--- START OF FILE: frontend/app/admin/municipality/youth/page.tsx ---
'use client';

import { useState, useEffect, Suspense } from 'react';
import { useRouter, useSearchParams, usePathname } from 'next/navigation';
import Link from 'next/link';
import api from '../../../../lib/api';
import { useAuth } from '../../../../context/AuthContext';
import { getMediaUrl } from '../../../utils';
import Toast from '../../../components/Toast';

interface Option { id: number; name: string; }
interface GuardianOption { id: number; first_name: string; last_name: string; email: string; }

function ManageMunicipalityYouthPageContent() {
  const router = useRouter();
  const pathname = usePathname();
  const searchParams = useSearchParams();
  const { user } = useAuth();

  const [users, setUsers] = useState<any[]>([]);
  const [totalCount, setTotalCount] = useState(0);
  const [isLoading, setIsLoading] = useState(true);
  const [stats, setStats] = useState<any>(null);
  const [analyticsExpanded, setAnalyticsExpanded] = useState(true);
  const [avatarErrors, setAvatarErrors] = useState<Set<number>>(new Set());

  const [toast, setToast] = useState<{ message: string; type: 'success' | 'error'; isVisible: boolean }>({
    message: '',
    type: 'success',
    isVisible: false,
  });

  const [clubs, setClubs] = useState<Option[]>([]);
  const [interests, setInterests] = useState<Option[]>([]);
  const [guardiansList, setGuardiansList] = useState<GuardianOption[]>([]);

  const [showModal, setShowModal] = useState(false);
  const [isEditing, setIsEditing] = useState(false);
  const [editUserId, setEditUserId] = useState<number | null>(null);
  const [avatarFile, setAvatarFile] = useState<File | null>(null);
  const [avatarPreview, setAvatarPreview] = useState<string | null>(null);

  const [guardianSearchTerm, setGuardianSearchTerm] = useState('');
  const [showGuardianDropdown, setShowGuardianDropdown] = useState(false);
  const [interestSearchTerm, setInterestSearchTerm] = useState('');
  const [showInterestDropdown, setShowInterestDropdown] = useState(false);

  const initialFormState = {
    email: '', password: '', first_name: '', last_name: '', nickname: '',
    legal_gender: 'MALE', preferred_gender: '', phone_number: '',
    date_of_birth: '', grade: '', preferred_club: '',
    verification_status: 'UNVERIFIED',
    interests: [] as number[],
    guardians: [] as number[],
  };

  const [formData, setFormData] = useState(initialFormState);

  useEffect(() => {
    fetchDropdowns();
    fetchStats();
  }, []);

  useEffect(() => {
    fetchYouth();
  }, [searchParams]);

  const fetchStats = async () => {
    try {
      const res = await api.get('/users/youth_stats/');
      setStats(res.data);
    } catch (err) {
      console.error(err);
    }
  };

  const fetchDropdowns = async () => {
    try {
      const clubRes = await api.get('/clubs/?page_size=1000');
      setClubs(Array.isArray(clubRes.data) ? clubRes.data : (clubRes.data?.results || []));

      const interestRes = await api.get('/interests/');
      setInterests(Array.isArray(interestRes.data) ? interestRes.data : (interestRes.data?.results || []));

      const guardianRes = await api.get('/users/list_guardians/');
      setGuardiansList(guardianRes.data);
    } catch (err) {
      console.error(err);
    }
  };

  const fetchYouth = async () => {
    setIsLoading(true);
    try {
      const params = new URLSearchParams();
      params.set('role', 'YOUTH_MEMBER');

      const page = searchParams.get('page');
      if (page) params.set('page', page);
      const search = searchParams.get('search');
      if (search) params.set('search', search);
      const ageFrom = searchParams.get('age_from');
      if (ageFrom) params.set('age_from', ageFrom);
      const ageTo = searchParams.get('age_to');
      if (ageTo) params.set('age_to', ageTo);
      const gradeFrom = searchParams.get('grade_from');
      if (gradeFrom) params.set('grade_from', gradeFrom);
      const gradeTo = searchParams.get('grade_to');
      if (gradeTo) params.set('grade_to', gradeTo);
      const status = searchParams.get('verification_status');
      if (status) params.set('verification_status', status);
      const club = searchParams.get('preferred_club');
      if (club) params.set('preferred_club', club);
      const gender = searchParams.get('legal_gender');
      if (gender) params.set('legal_gender', gender);

      const res = await api.get(`/users/?${params.toString()}`);
      const results = res.data.results || [];
      setUsers(results);
      setTotalCount(res.data.count ?? results.length);
    } catch (err) {
      console.error(err);
    } finally {
      setIsLoading(false);
    }
  };

  const updateUrl = (key: string, value: string) => {
    const params = new URLSearchParams(searchParams.toString());
    if (value) params.set(key, value); else params.delete(key);
    if (key !== 'page') params.set('page', '1');
    router.push(`${pathname}?${params.toString()}`);
  };

  const handleOpenCreate = () => {
    setIsEditing(false);
    setEditUserId(null);
    setFormData(initialFormState);
    setAvatarFile(null);
    setAvatarPreview(null);
    setGuardianSearchTerm('');
    setInterestSearchTerm('');
    setShowGuardianDropdown(false);
    setShowInterestDropdown(false);
    setShowModal(true);
  };

  const handleOpenEdit = (youth: any) => {
    setIsEditing(true);
    setEditUserId(youth.id);
    setFormData({
      email: youth.email,
      password: '',
      first_name: youth.first_name || '',
      last_name: youth.last_name || '',
      nickname: youth.nickname || '',
      legal_gender: youth.legal_gender || 'MALE',
      preferred_gender: youth.preferred_gender || '',
      phone_number: youth.phone_number || '',
      date_of_birth: youth.date_of_birth || '',
      grade: youth.grade?.toString() || '',
      preferred_club:
        typeof youth.preferred_club === 'object'
          ? youth.preferred_club?.id?.toString() || ''
          : youth.preferred_club?.toString() || '',
      verification_status: youth.verification_status || 'UNVERIFIED',
      interests:
        youth.interests?.map((i: any) => (typeof i === 'object' ? i.id : i)) || [],
      guardians: youth.guardians || [],
    });
    setAvatarFile(null);
    setAvatarPreview(youth.avatar ? getMediaUrl(youth.avatar) : null);
    setGuardianSearchTerm('');
    setInterestSearchTerm('');
    setShowGuardianDropdown(false);
    setShowInterestDropdown(false);
    setShowModal(true);
  };

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    try {
      const data = new FormData();
      Object.entries(formData).forEach(([key, value]) => {
        if (key === 'password' && !value) return;
        if (key === 'interests' || key === 'guardians') return;
        data.append(key, value?.toString() || '');
      });

      formData.interests.forEach((id) => data.append('interests', id.toString()));
      formData.guardians.forEach((id) => data.append('guardians', id.toString()));
      data.append('role', 'YOUTH_MEMBER');
      if (avatarFile) data.append('avatar', avatarFile);

      const config = { headers: { 'Content-Type': 'multipart/form-data' } };
      if (isEditing && editUserId) {
        await api.patch(`/users/${editUserId}/`, data, config);
        setToast({ message: 'Youth member updated successfully!', type: 'success', isVisible: true });
      } else {
        await api.post('/users/', data, config);
        setToast({ message: 'Youth member created successfully!', type: 'success', isVisible: true });
      }

      setShowModal(false);
      fetchYouth();
      fetchStats();
    } catch (err) {
      setToast({ message: 'Operation failed. Please try again.', type: 'error', isVisible: true });
      console.error(err);
    }
  };

  const handleDelete = async (id: number) => {
    if (!window.confirm('Delete this youth member?')) return;
    try {
      await api.delete(`/users/${id}/`);
      setToast({ message: 'Youth member deleted successfully!', type: 'success', isVisible: true });
      fetchYouth();
      fetchStats();
    } catch (err) {
      setToast({ message: 'Failed to delete youth member.', type: 'error', isVisible: true });
    }
  };

  const handleAvatarChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (file) {
      setAvatarFile(file);
      const reader = new FileReader();
      reader.onloadend = () => setAvatarPreview(reader.result as string);
      reader.readAsDataURL(file);
    }
  };

  const toggleInterest = (id: number) => {
    setFormData((prev) => ({
      ...prev,
      interests: prev.interests.includes(id)
        ? prev.interests.filter((i) => i !== id)
        : [...prev.interests, id],
    }));
    setInterestSearchTerm('');
    setShowInterestDropdown(false);
  };

  const removeInterest = (id: number) => {
    setFormData((prev) => ({
      ...prev,
      interests: prev.interests.filter((i) => i !== id),
    }));
  };

  const toggleGuardian = (id: number) => {
    setFormData((prev) => ({
      ...prev,
      guardians: prev.guardians.includes(id)
        ? prev.guardians.filter((i) => i !== id)
        : [...prev.guardians, id],
    }));
    setGuardianSearchTerm('');
    setShowGuardianDropdown(false);
  };

  const removeGuardian = (id: number) => {
    setFormData((prev) => ({
      ...prev,
      guardians: prev.guardians.filter((i) => i !== id),
    }));
  };

  const filteredInterests = interests.filter(
    (interest) =>
      interest.name.toLowerCase().includes(interestSearchTerm.toLowerCase()) &&
      !formData.interests.includes(interest.id)
  );

  const filteredGuardians = guardiansList.filter((guardian) => {
    const target = `${guardian.first_name} ${guardian.last_name} ${guardian.email}`.toLowerCase();
    return (
      target.includes(guardianSearchTerm.toLowerCase()) &&
      !formData.guardians.includes(guardian.id)
    );
  });

  const getSelectedInterests = () =>
    formData.interests.map((id) => interests.find((interest) => interest.id === id)).filter(Boolean) as Option[];

  const getSelectedGuardians = () =>
    formData.guardians.map((id) => guardiansList.find((guardian) => guardian.id === id)).filter(Boolean) as GuardianOption[];

  const getInitials = (first = '', last = '') => {
    const a = first.charAt(0)?.toUpperCase() || '';
    const b = last.charAt(0)?.toUpperCase() || '';
    return a + b || '?';
  };

  const getAvatarColor = () => 'bg-purple-100 text-purple-700';

  const currentPage = Number(searchParams.get('page')) || 1;
  const totalPages = totalCount > 0 ? Math.ceil(totalCount / 10) : 1;

  return (
    <div>
      <div className="flex justify-between items-center mb-6">
        <div>
          <p className="text-sm text-purple-500 uppercase font-semibold">Municipality Admin</p>
          <h1 className="text-2xl font-bold text-gray-900">Manage Youth Members</h1>
        </div>
        <button onClick={handleOpenCreate} className="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-Ð¿urple-700 shadow">
          + Add Youth
        </button>
      </div>

      {stats && (
        <div className="mb-6">
          <button
            onClick={() => setAnalyticsExpanded(!analyticsExpanded)}
            className="flex items-center justify-between w-full bg-white rounded-lg shadow-sm border border-gray-200 p-3 hover:bg-gray-50 transition-colors mb-3"
          >
            <div className="flex items-center gap-2">
              <svg className="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
              </svg>
              <span className="text-sm font-semibold text-gray-700">Analytics</span>
            </div>
            <svg
              className={`w-5 h-5 text-gray-600 transition-transform duration-200 ${analyticsExpanded ? 'rotate-180' : ''}`}
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
            </svg>
          </button>

          <div
            className={`grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 transition-all duration-500 ease-in-out ${
              analyticsExpanded ? 'max-h-[600px] opacity-100 translate-y-0' : 'max-h-0 opacity-0 -translate-y-4 pointer-events-none'
            } overflow-hidden`}
          >
            <div className="bg-gradient-to-br from-purple-500 to-purple-600 rounded-xl shadow-md p-4 text-white">
              <h3 className="text-xs font-semibold uppercase text-white/80">Total Youth</h3>
              <p className="text-3xl font-bold mt-1">{stats.total_youth}</p>
            </div>
            <div className="bg-white rounded-xl shadow p-4 border border-purple-50">
              <h3 className="text-xs font-semibold uppercase text-gray-500 mb-2">Active (7 days)</h3>
              <p className="text-2xl font-bold text-gray-800">{stats.activity.active_7_days}</p>
            </div>
            <div className="bg-white rounded-xl shadow p-4 border border-purple-50">
              <h3 className="text-xs font-semibold uppercase text-gray-500 mb-2">Verified</h3>
              <p className="text-xl font-bold text-green-600">{stats.gender?.female ?? 0}</p>
            </div>
            <div className="bg-white rounded-xl shadow p-4 border border-purple-50">
              <h3 className="text-xs font-semibold uppercase text-gray-500 mb-2">Grades Tracked</h3>
              <p className="text-xl font-bold text-purple-600">{Object.keys(stats.grades || {}).length}</p>
            </div>
          </div>
        </div>
      )}

      <div className="bg-white p-4 rounded-lg shadow mb-6 border border-gray-100">
        <div className="flex flex-wrap gap-4 items-end">
          <div className="flex-1 min-w-[200px]">
            <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Search</label>
            <input
              type="text"
              placeholder="Search name or email..."
              className="w-full border rounded p-2 text-sm bg-gray-50"
              value={searchParams.get('search') || ''}
              onChange={(e) => updateUrl('search', e.target.value)}
            />
          </div>

          <div className="w-20">
            <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Age From</label>
            <input
              type="number"
              className="w-full border rounded p-2 text-sm bg-gray-50"
              value={searchParams.get('age_from') || ''}
              onChange={(e) => updateUrl('age_from', e.target.value)}
            />
          </div>

          <div className="w-20">
            <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Age To</label>
            <input
              type="number"
              className="w-full border rounded p-2 text-sm bg-gray-50"
              value={searchParams.get('age_to') || ''}
              onChange={(e) => updateUrl('age_to', e.target.value)}
            />
          </div>

          <div className="w-24">
            <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Grade From</label>
            <input
              type="number"
              className="w-full border rounded p-2 text-sm bg-gray-50"
              value={searchParams.get('grade_from') || ''}
              onChange={(e) => updateUrl('grade_from', e.target.value)}
            />
          </div>

          <div className="w-24">
            <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Grade To</label>
            <input
              type="number"
              className="w-full border rounded p-2 text-sm bg-gray-50"
              value={searchParams.get('grade_to') || ''}
              onChange={(e) => updateUrl('grade_to', e.target.value)}
            />
          </div>

          <div className="w-44">
            <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Status</label>
            <select
              className="w-full border rounded p-2 text-sm bg-gray-50"
              value={searchParams.get('verification_status') || ''}
              onChange={(e) => updateUrl('verification_status', e.target.value)}
            >
              <option value="">All Statuses</option>
              <option value="UNVERIFIED">Unverified</option>
              <option value="PENDING">Pending</option>
              <option value="VERIFIED">Verified</option>
            </select>
          </div>

          <div className="w-48">
            <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Club</label>
            <select
              className="w-full border rounded p-2 text-sm bg-gray-50"
              value={searchParams.get('preferred_club') || ''}
              onChange={(e) => updateUrl('preferred_club', e.target.value)}
            >
              <option value="">All Clubs</option>
              {clubs.map((club) => (
                <option key={club.id} value={club.id.toString()}>
                  {club.name}
                </option>
              ))}
            </select>
          </div>

          <div className="w-32">
            <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Gender</label>
            <select
              className="w-full border rounded p-2 text-sm bg-gray-50"
              value={searchParams.get('legal_gender') || ''}
              onChange={(e) => updateUrl('legal_gender', e.target.value)}
            >
              <option value="">Any</option>
              <option value="MALE">Male</option>
              <option value="FEMALE">Female</option>
              <option value="OTHER">Other</option>
            </select>
          </div>

          <button onClick={() => router.push(pathname)} className="px-4 py-2 text-sm text-gray-600 hover:text-red-500">
            Clear Filters
          </button>
        </div>
      </div>

      <div className="bg-white rounded-lg shadow overflow-hidden mb-6">
        {isLoading ? (
          <div className="p-8 text-center text-gray-500">Loading youth...</div>
        ) : users.length === 0 ? (
          <div className="p-8 text-center text-gray-500">No youth members found.</div>
        ) : (
          <table className="min-w-full divide-y divide-gray-200">
            <thead className="bg-gray-50">
              <tr>
                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">User</th>
                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Club</th>
                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Grade / DOB</th>
                <th className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">Actions</th>
              </tr>
            </thead>
            <tbody className="bg-white divide-y divide-gray-200">
              {users.map((youth) => (
                <tr key={youth.id}>
                  <td className="px-6 py-4">
                    <div className="flex items-center">
                      {youth.avatar && !avatarErrors.has(youth.id) ? (
                        <img
                          src={getMediaUrl(youth.avatar) || ''}
                          alt="Avatar"
                          className="w-10 h-10 rounded-full object-cover mr-3"
                          onError={() =>
                            setAvatarErrors((prev) => {
                              const next = new Set(prev);
                              next.add(youth.id);
                              return next;
                            })
                          }
                        />
                      ) : (
                        <div className={`w-10 h-10 rounded-full ${getAvatarColor()} flex items-center justify-center font-semibold text-sm mr-3`}>
                          {getInitials(youth.first_name, youth.last_name)}
                        </div>
                      )}
                      <div>
                        <div className="text-sm font-semibold text-gray-900">
                          {youth.first_name} {youth.last_name}
                        </div>
                        <div className="text-xs text-gray-500">{youth.email}</div>
                      </div>
                    </div>
                  </td>
                  <td className="px-6 py-4 text-sm text-gray-600">
                    {clubs.find((club) => club.id === youth.preferred_club)?.name || 'â'}
                  </td>
                  <td className="px-6 py-4 text-sm text-gray-600">
                    Grade: <span className="font-semibold">{youth.grade || '-'}</span>
                    <br />
                    <span className="text-xs">{youth.date_of_birth || '-'}</span>
                  </td>
                  <td className="px-6 py-4 whitespace-nowrap text-right text-sm space-x-4">
                    <Link href={`/admin/municipality/youth/${youth.id}`} className="text-purple-600 font-bold">
                      View
                    </Link>
                    <button onClick={() => handleOpenEdit(youth)} className="text-indigo-600 font-bold">
                      Edit
                    </button>
                    <button onClick={() => handleDelete(youth.id)} className="text-red-600">
                      Delete
                    </button>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        )}
      </div>

      <div className="flex items-center justify-between border-t border-gray-200 bg-white px-4 py-3 sm:px-6 rounded-lg shadow">
        <div className="text-sm text-gray-600">Total youth: {totalCount}</div>
        <div className="flex items-center gap-2">
          <button
            disabled={currentPage === 1}
            onClick={() => updateUrl('page', (currentPage - 1).toString())}
            className="px-3 py-1 rounded border text-sm disabled:opacity-50"
          >
            Previous
          </button>
          <span className="text-sm text-gray-600">
            Page {currentPage} of {totalPages}
          </span>
          <button
            disabled={currentPage >= totalPages}
            onClick={() => updateUrl('page', (currentPage + 1).toString())}
            className="px-3 py-1 rounded border text-sm disabled:opacity-50"
          >
            Next
          </button>
        </div>
      </div>

      {showModal && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-xl shadow-2xl w-full max-w-2xl p-8 max-h-[90vh] overflow-y-auto">
            <h2 className="text-2xl font-bold mb-6 text-gray-800">{isEditing ? 'Edit Youth' : 'Create Youth'}</h2>
            <form onSubmit={handleSubmit} className="space-y-6">
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <input
                  required
                  type="text"
                  placeholder="First Name"
                  className="border p-2 rounded"
                  value={formData.first_name}
                  onChange={(e) => setFormData({ ...formData, first_name: e.target.value })}
                />
                <input
                  required
                  type="text"
                  placeholder="Last Name"
                  className="border p-2 rounded"
                  value={formData.last_name}
                  onChange={(e) => setFormData({ ...formData, last_name: e.target.value })}
                />
                <input
                  required
                  type="email"
                  placeholder="Email"
                  className="border p-2 rounded"
                  value={formData.email}
                  onChange={(e) => setFormData({ ...formData, email: e.target.value })}
                />
                <input
                  type="password"
                  placeholder={isEditing ? 'New Password (optional)' : 'Password'}
                  className="border p-2 rounded"
                  required={!isEditing}
                  value={formData.password}
                  onChange={(e) => setFormData({ ...formData, password: e.target.value })}
                />
                <input
                  type="text"
                  placeholder="Nickname"
                  className="border p-2 rounded"
                  value={formData.nickname}
                  onChange={(e) => setFormData({ ...formData, nickname: e.target.value })}
                />
                <input
                  type="text"
                  placeholder="Phone"
                  className="border p-2 rounded"
                  value={formData.phone_number}
                  onChange={(e) => setFormData({ ...formData, phone_number: e.target.value })}
                />
              </div>

              <div className="bg-gray-50 p-4 rounded-lg border grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label className="block text-xs font-bold uppercase text-gray-500 mb-1">Date of Birth</label>
                  <input
                    type="date"
                    className="w-full border p-2 rounded"
                    value={formData.date_of_birth}
                    onChange={(e) => setFormData({ ...formData, date_of_birth: e.target.value })}
                  />
                </div>
                <div>
                  <label className="block text-xs font-bold uppercase text-gray-500 mb-1">Grade</label>
                  <input
                    type="number"
                    className="w-full border p-2 rounded"
                    value={formData.grade}
                    onChange={(e) => setFormData({ ...formData, grade: e.target.value })}
                  />
                </div>
                <div>
                  <label className="block text-xs font-bold uppercase text-gray-500 mb-1">Legal Gender</label>
                  <select
                    className="w-full border p-2 rounded"
                    value={formData.legal_gender}
                    onChange={(e) => setFormData({ ...formData, legal_gender: e.target.value })}
                  >
                    <option value="MALE">Male</option>
                    <option value="FEMALE">Female</option>
                    <option value="OTHER">Other</option>
                  </select>
                </div>
                <div>
                  <label className="block text-xs font-bold uppercase text-gray-500 mb-1">Preferred Gender</label>
                  <input
                    type="text"
                    className="w-full border p-2 rounded"
                    value={formData.preferred_gender}
                    onChange={(e) => setFormData({ ...formData, preferred_gender: e.target.value })}
                  />
                </div>
              </div>

              <div>
                <label className="block text-sm font-bold mb-2">Preferred Club</label>
                <select
                  className="w-full border p-2 rounded mb-4"
                  value={formData.preferred_club}
                  onChange={(e) => setFormData({ ...formData, preferred_club: e.target.value })}
                >
                  <option value="">Select Club...</option>
                  {clubs.map((club) => (
                    <option key={club.id} value={club.id.toString()}>
                      {club.name}
                    </option>
                  ))}
                </select>

                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                  <div>
                    <label className="block text-sm font-bold mb-2">Assign Guardians</label>
                    {formData.guardians.length > 0 && (
                      <div className="flex flex-wrap gap-2 mb-3 p-3 bg-blue-50 rounded-lg border border-blue-200">
                        {getSelectedGuardians().map((guardian) => (
                          <span key={guardian.id} className="inline-flex items-center gap-1.5 px-3 py-1.5 bg-blue-600 text-white text-sm rounded-full font-medium">
                            {guardian.first_name} {guardian.last_name}
                            <button type="button" onClick={() => removeGuardian(guardian.id)} className="hover:bg-blue-700 rounded-full p-0.5 transition-colors">
                              <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                              </svg>
                            </button>
                          </span>
                        ))}
                      </div>
                    )}
                    <div className="relative mb-4">
                      <input
                        type="text"
                        placeholder="Search guardians..."
                        value={guardianSearchTerm}
                        onChange={(e) => {
                          setGuardianSearchTerm(e.target.value);
                          setShowGuardianDropdown(true);
                        }}
                        onFocus={() => setShowGuardianDropdown(true)}
                        className="w-full border border-gray-300 rounded-lg p-2.5 focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                      />
                      {showGuardianDropdown && (
                        <>
                          <div className="fixed inset-0 z-10" onClick={() => setShowGuardianDropdown(false)}></div>
                          <div className="absolute z-20 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-60 overflow-y-auto">
                            {filteredGuardians.length > 0 ? (
                              filteredGuardians.map((guardian) => (
                                <button
                                  key={guardian.id}
                                  type="button"
                                  onClick={() => toggleGuardian(guardian.id)}
                                  className="w-full text-left px-4 py-2.5 hover:bg-blue-50 transition-colors border-b border-gray-100 last:border-b-0"
                                >
                                  <div className="font-medium text-gray-900">{guardian.first_name} {guardian.last_name}</div>
                                  <div className="text-xs text-gray-500">{guardian.email}</div>
                                </button>
                              ))
                            ) : guardianSearchTerm ? (
                              <div className="px-4 py-3 text-sm text-gray-500 text-center">No guardians found</div>
                            ) : (
                              <div className="px-4 py-3 text-sm text-gray-500 text-center">All guardians already selected</div>
                            )}
                          </div>
                        </>
                      )}
                    </div>
                  </div>

                  <div>
                    <label className="block text-sm font-bold mb-2">Interests</label>
                    {formData.interests.length > 0 && (
                      <div className="flex flex-wrap gap-2 mb-3 p-3 bg-purple-50 rounded-lg border border-purple-200">
                        {getSelectedInterests().map((interest) => (
                          <span key={interest.id} className="inline-flex items-center gap-1.5 px-3 py-1.5 bg-purple-600 text-white text-sm rounded-full font-medium">
                            {interest.name}
                            <button type="button" onClick={() => removeInterest(interest.id)} className="hover:bg-purple-700 rounded-full p-0.5 transition-colors">
                              <svg className="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
                              </svg>
                            </button>
                          </span>
                        ))}
                      </div>
                    )}
                    <div className="relative mb-4">
                      <input
                        type="text"
                        placeholder="Search interests..."
                        value={interestSearchTerm}
                        onChange={(e) => {
                          setInterestSearchTerm(e.target.value);
                          setShowInterestDropdown(true);
                        }}
                        onFocus={() => setShowInterestDropdown(true)}
                        className="w-full border border-gray-300 rounded-lg p-2.5 focus:ring-2 focus:ring-purple-500 focus:border-purple-500"
                      />
                      {showInterestDropdown && (
                        <>
                          <div className="fixed inset-0 z-10" onClick={() => setShowInterestDropdown(false)}></div>
                          <div className="absolute z-20 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-60 overflow-y-auto">
                            {filteredInterests.length > 0 ? (
                              filteredInterests.map((interest) => (
                                <button
                                  key={interest.id}
                                  type="button"
                                  onClick={() => toggleInterest(interest.id)}
                                  className="w-full text-left px-4 py-2.5 hover:bg-purple-50 transition-colors border-b border-gray-100 last:border-b-0"
                                >
                                  <div className="font-medium text-gray-900">{interest.name}</div>
                                </button>
                              ))
                            ) : interestSearchTerm ? (
                              <div className="px-4 py-3 text-sm text-gray-500 text-center">No interests found</div>
                            ) : (
                              <div className="px-4 py-3 text-sm text-gray-500 text-center">All interests already selected</div>
                            )}
                          </div>
                        </>
                      )}
                    </div>
                  </div>
                </div>
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">Avatar</label>
                <input type="file" accept="image/*" className="w-full border p-2 rounded" onChange={handleAvatarChange} />
                {avatarPreview && <img src={avatarPreview} alt="Preview" className="w-16 h-16 mt-2 rounded-full object-cover border" />}
              </div>

              <div className="flex justify-end gap-4 pt-4 border-t">
                <button type="button" onClick={() => setShowModal(false)} className="text-gray-500">
                  Cancel
                </button>
                <button type="submit" className="bg-purple-600 text-white px-6 py-2 rounded-lg hover:bg-purple-700">
                  {isEditing ? 'Save Changes' : 'Create Youth'}
                </button>
              </div>
            </form>
          </div>
        </div>
      )}

      <Toast
        message={toast.message}
        type={toast.type}
        isVisible={toast.isVisible}
        onClose={() => setToast({ ...toast, isVisible: false })}
      />
    </div>
  );
}

export default function ManageMunicipalityYouthPage() {
  return (
    <Suspense fallback={<div>Loading...</div>}>
      <ManageMunicipalityYouthPageContent />
    </Suspense>
  );
}
--- END OF FILE: frontend/app/admin/municipality/youth/page.tsx ---


--- START OF FILE: frontend/app/admin/municipality/youth/[id]/page.tsx ---
'use client';

import { useState, useEffect, Suspense } from 'react';
import { useRouter, useParams } from 'next/navigation';
import Link from 'next/link';
import api from '../../../../../lib/api';
import { getMediaUrl } from '../../../../utils';

interface Option { id: number; name: string; }
interface GuardianOption { id: number; first_name: string; last_name: string; email: string; }

function MunicipalityYouthViewContent() {
  const router = useRouter();
  const params = useParams();
  const youthId = params?.id as string;

  const [youth, setYouth] = useState<any>(null);
  const [clubs, setClubs] = useState<Option[]>([]);
  const [interests, setInterests] = useState<Option[]>([]);
  const [guardiansList, setGuardiansList] = useState<GuardianOption[]>([]);
  const [isLoading, setIsLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);

  useEffect(() => {
    if (youthId) {
      fetchData();
    }
  }, [youthId]);

  const fetchData = async () => {
    setIsLoading(true);
    setError(null);
    try {
      const userRes = await api.get(`/users/${youthId}/`);
      setYouth(userRes.data);

      const clubRes = await api.get('/clubs/?page_size=1000');
      setClubs(Array.isArray(clubRes.data) ? clubRes.data : (clubRes.data?.results || []));

      const interestRes = await api.get('/interests/');
      setInterests(Array.isArray(interestRes.data) ? interestRes.data : (interestRes.data?.results || []));

      const guardianRes = await api.get('/users/list_guardians/');
      setGuardiansList(guardianRes.data);
    } catch (err: any) {
      setError(err?.response?.status === 404 ? 'Youth member not found or access denied.' : 'Failed to load youth member');
    } finally {
      setIsLoading(false);
    }
  };

  const calculateAge = (dateOfBirth: string | null) => {
    if (!dateOfBirth) return null;
    const today = new Date();
    const birthDate = new Date(dateOfBirth);
    let age = today.getFullYear() - birthDate.getFullYear();
    const monthDiff = today.getMonth() - birthDate.getMonth();
    if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) age--;
    return age;
  };

  if (isLoading) {
    return (
      <div className="p-8 text-center">
        <p className="text-gray-500">Loading youth member...</p>
      </div>
    );
  }

  if (error || !youth) {
    return (
      <div className="p-8">
        <div className="bg-red-50 border border-red-200 rounded-lg p-4 mb-4">
          <p className="text-red-800">{error || 'Youth member not found.'}</p>
        </div>
        <Link href="/admin/municipality/youth" className="text-purple-600 hover:text-purple-800 font-semibold">
          â Back to Youth Members
        </Link>
      </div>
    );
  }

  const interestIds = youth.interests?.map((i: any) => (typeof i === 'object' ? i.id : i)) || [];
  const guardianIds = youth.guardians || [];

  return (
    <div className="p-8 space-y-6">
      <div className="flex items-center justify-between">
        <Link href="/admin/municipality/youth" className="text-purple-600 hover:text-purple-800 font-semibold">
          â Back to Youth Members
        </Link>
        <button
          onClick={() => router.push(`/admin/municipality/youth?edit=${youth.id}`)}
          className="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 shadow"
        >
          Edit Youth
        </button>
      </div>

      <section className="bg-white rounded-2xl shadow-xl p-8">
        <div className="flex flex-col md:flex-row md:items-center gap-6 border-b pb-6">
          {youth.avatar && (
            <img
              src={getMediaUrl(youth.avatar) || ''}
              alt={`${youth.first_name} ${youth.last_name}`}
              className="w-32 h-32 rounded-full object-cover border-4 border-purple-100"
              onError={(e) => ((e.target as HTMLImageElement).style.display = 'none')}
            />
          )}
          <div>
            <p className="text-sm text-purple-500 uppercase font-semibold">Youth Profile</p>
            <h1 className="text-3xl font-bold text-gray-900 mt-1">
              {youth.first_name} {youth.last_name}
              {youth.nickname && <span className="text-xl text-gray-500 ml-2">({youth.nickname})</span>}
            </h1>
            <p className="text-gray-600 mt-2">{youth.email}</p>
            <div className="flex items-center gap-3 mt-3">
              <span className={`px-3 py-1 text-xs font-bold rounded-full ${
                youth.verification_status === 'VERIFIED'
                  ? 'bg-green-100 text-green-700'
                  : youth.verification_status === 'PENDING'
                  ? 'bg-yellow-100 text-yellow-700'
                  : 'bg-gray-100 text-gray-600'
              }`}>
                {youth.verification_status || 'UNVERIFIED'}
              </span>
              {youth.phone_number && <span className="text-sm text-gray-600">ð {youth.phone_number}</span>}
            </div>
          </div>
        </div>
      </section>

      <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <div className="lg:col-span-2 space-y-6">
          <section className="bg-white rounded-2xl shadow p-6">
            <h2 className="text-xl font-bold text-gray-800 mb-4">Basic Information</h2>
            <div className="grid grid-cols-2 gap-4 text-sm">
              <div>
                <p className="text-gray-500 font-semibold uppercase text-xs mb-1">Date of Birth</p>
                <p className="text-gray-900">{youth.date_of_birth || '-'}</p>
              </div>
              <div>
                <p className="text-gray-500 font-semibold uppercase text-xs mb-1">Age</p>
                <p className="text-gray-900">{calculateAge(youth.date_of_birth) || '-'}</p>
              </div>
              <div>
                <p className="text-gray-500 font-semibold uppercase text-xs mb-1">Grade</p>
                <p className="text-gray-900">{youth.grade || '-'}</p>
              </div>
              <div>
                <p className="text-gray-500 font-semibold uppercase text-xs mb-1">Legal Gender</p>
                <p className="text-gray-900">{youth.legal_gender || '-'}</p>
              </div>
              <div>
                <p className="text-gray-500 font-semibold uppercase text-xs mb-1">Preferred Gender</p>
                <p className="text-gray-900">{youth.preferred_gender || '-'}</p>
              </div>
              <div>
                <p className="text-gray-500 font-semibold uppercase text-xs mb-1">Preferred Club</p>
                <p className="text-gray-900">{clubs.find((c) => c.id === youth.preferred_club)?.name || '-'}</p>
              </div>
            </div>
          </section>

          {guardianIds.length > 0 && (
            <section className="bg-white rounded-2xl shadow p-6">
              <h2 className="text-xl font-bold text-gray-800 mb-4">Assigned Guardians</h2>
              <div className="space-y-3">
                {guardianIds.map((guardianId: number) => {
                  const guardian = guardiansList.find((g) => g.id === guardianId);
                  if (!guardian) return null;
                  return (
                    <div key={guardianId} className="p-3 border rounded-lg bg-gray-50">
                      <p className="text-sm font-semibold text-gray-900">
                        {guardian.first_name} {guardian.last_name}
                      </p>
                      <p className="text-xs text-gray-500">{guardian.email}</p>
                    </div>
                  );
                })}
              </div>
            </section>
          )}

          {interestIds.length > 0 && (
            <section className="bg-white rounded-2xl shadow p-6">
              <h2 className="text-xl font-bold text-gray-800 mb-4">Interests</h2>
              <div className="flex flex-wrap gap-2">
                {interestIds.map((interestId: number) => {
                  const interest = interests.find((i) => i.id === interestId);
                  if (!interest) return null;
                  return (
                    <span
                      key={interestId}
                      className="px-3 py-1 bg-purple-100 text-purple-700 rounded-full text-sm font-medium"
                    >
                      {interest.name}
                    </span>
                  );
                })}
              </div>
            </section>
          )}
        </div>

        <aside className="space-y-6">
          <section className="bg-white rounded-2xl shadow p-6">
            <h3 className="text-lg font-bold text-gray-800 mb-3">Account Information</h3>
            <div className="space-y-3 text-sm text-gray-700">
              <div>
                <p className="text-xs text-gray-500 font-semibold uppercase">Date Joined</p>
                <p>{youth.date_joined ? new Date(youth.date_joined).toLocaleDateString() : '-'}</p>
              </div>
              <div>
                <p className="text-xs text-gray-500 font-semibold uppercase">Last Login</p>
                <p>{youth.last_login ? new Date(youth.last_login).toLocaleDateString() : 'Never'}</p>
              </div>
              <div>
                <p className="text-xs text-gray-500 font-semibold uppercase">Preferred Language</p>
                <p>{youth.preferred_language || '-'}</p>
              </div>
              <div>
                <p className="text-xs text-gray-500 font-semibold uppercase">Account Status</p>
                <span
                  className={`px-2 py-1 rounded text-xs font-bold ${
                    youth.is_active ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'
                  }`}
                >
                  {youth.is_active ? 'Active' : 'Inactive'}
                </span>
              </div>
            </div>
          </section>

          <section className="bg-white rounded-2xl shadow p-6 space-y-2">
            <button
              onClick={() => router.push(`/admin/municipality/youth?edit=${youth.id}`)}
              className="w-full bg-purple-600 text-white py-2 rounded-lg font-semibold hover:bg-purple-700"
            >
              Edit Youth
            </button>
            <Link
              href="/admin/municipality/youth"
              className="block w-full text-center bg-gray-100 text-gray-700 py-2 rounded-lg font-semibold hover:bg-gray-200"
            >
              Back to List
            </Link>
          </section>
        </aside>
      </div>
    </div>
  );
}

export default function MunicipalityYouthViewPage() {
  return (
    <Suspense fallback={<div className="p-8 text-center">Loading...</div>}>
      <MunicipalityYouthViewContent />
    </Suspense>
  );
}

--- END OF FILE: frontend/app/admin/municipality/youth/[id]/page.tsx ---


--- START OF FILE: frontend/app/admin/municipality/admins/page.tsx ---
'use client';

import { useState, useEffect, Suspense } from 'react';
import { useRouter, useSearchParams, usePathname } from 'next/navigation';
import api from '../../../../lib/api';
import { getMediaUrl } from '../../../utils';
import Toast from '../../../components/Toast';

interface Option { id: number; name: string; }

function ManageMuniAdminsPageContent() {
  const router = useRouter();
  const pathname = usePathname();
  const searchParams = useSearchParams();

  // --- STATE ---
  const [users, setUsers] = useState<any[]>([]);
  const [totalCount, setTotalCount] = useState(0); 
  const [isLoading, setIsLoading] = useState(true);
  const [clubs, setClubs] = useState<Option[]>([]);
  
  const [toast, setToast] = useState<{ message: string; type: 'success' | 'error'; isVisible: boolean }>({
    message: '', type: 'success', isVisible: false,
  });

  // Modal & Form State
  const [showModal, setShowModal] = useState(false);
  const [isEditing, setIsEditing] = useState(false);
  const [editUserId, setEditUserId] = useState<number | null>(null);

  const initialFormState = {
    email: '', password: '', first_name: '', last_name: '', nickname: '',
    legal_gender: 'MALE', phone_number: '', profession: '',
    assigned_club: '', hide_contact_info: false
  };

  const [formData, setFormData] = useState(initialFormState);
  // Default to Club Admin (most common action)
  const [adminType, setAdminType] = useState('CLUB_ADMIN');
  const [avatarFile, setAvatarFile] = useState<File | null>(null);
  const [avatarPreview, setAvatarPreview] = useState<string | null>(null);

  // --- INITIAL DATA LOAD ---
  useEffect(() => {
    fetchClubs();
  }, []);

  useEffect(() => {
    fetchAdmins();
  }, [searchParams]);

  const fetchClubs = async () => {
    try {
      // API automatically filters clubs for this municipality
      const res = await api.get('/clubs/');
      const data = Array.isArray(res.data) ? res.data : (res.data.results || []);
      setClubs(data);
    } catch (err) {
      console.error(err);
    }
  };

  const fetchAdmins = async () => {
    setIsLoading(true);
    try {
      const params = new URLSearchParams(searchParams.toString());
      
      // If no role selected, fetch both valid roles for this view
      if (!params.get('role')) {
          // We handle this by fetching all and filtering on client side or making 2 requests.
          // Since backend scopes data, we can just ask for users and filter out Youth/Guardians visually or via API logic.
          // A cleaner way for the UI:
          const adminRoles = ['MUNICIPALITY_ADMIN', 'CLUB_ADMIN'];
          
          // We fetch all, the backend already excludes Super Admins and other munis
          const res = await api.get(`/users/?${params.toString()}`);
          
          let allUsers = res.data.results || [];
          // Filter to only show Admins (exclude Youth/Guardian if they appear)
          allUsers = allUsers.filter((u: any) => adminRoles.includes(u.role));
          
          setUsers(allUsers);
          setTotalCount(allUsers.length);
      } else {
          // Role specifically requested
          const res = await api.get(`/users/?${params.toString()}`);
          setUsers(res.data.results || []);
          setTotalCount(res.data.count);
      }
    } catch (err) {
      console.error(err);
    } finally {
      setIsLoading(false);
    }
  };

  const updateUrl = (key: string, value: string) => {
    const params = new URLSearchParams(searchParams.toString());
    if (value) params.set(key, value); else params.delete(key);
    if (key !== 'page') params.set('page', '1');
    router.push(`${pathname}?${params.toString()}`);
  };

  // --- ACTIONS ---

  const handleOpenCreate = () => {
    setIsEditing(false);
    setEditUserId(null);
    setFormData(initialFormState);
    setAdminType('CLUB_ADMIN');
    setAvatarFile(null);
    setAvatarPreview(null);
    setShowModal(true);
  };

  const handleOpenEdit = (user: any) => {
    setIsEditing(true);
    setEditUserId(user.id);
    setAdminType(user.role);
    setFormData({
      email: user.email, password: '', 
      first_name: user.first_name || '', last_name: user.last_name || '',
      nickname: user.nickname || '', legal_gender: user.legal_gender || 'MALE',
      phone_number: user.phone_number || '', profession: user.profession || '',
      assigned_club: user.assigned_club || '',
      hide_contact_info: user.hide_contact_info || false
    });
    setAvatarFile(null);
    setAvatarPreview(user.avatar ? getMediaUrl(user.avatar) : null);
    setShowModal(true);
  };

  const handleDelete = async (id: number) => {
    if (!window.confirm("Are you sure?")) return;
    try {
      await api.delete(`/users/${id}/`);
      setToast({ message: 'User deleted.', type: 'success', isVisible: true });
      fetchAdmins();
    } catch (err) { 
      setToast({ message: 'Failed to delete.', type: 'error', isVisible: true });
    }
  };

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    try {
      const data = new FormData();
      Object.entries(formData).forEach(([key, value]) => {
        if (key === 'password' && !value) return; 
        data.append(key, value.toString());
      });
      data.append('role', adminType);
      
      // Backend automatically assigns municipality
      
      if (avatarFile) data.append('avatar', avatarFile);

      const config = { headers: { 'Content-Type': 'multipart/form-data' } };
      if (isEditing && editUserId) await api.patch(`/users/${editUserId}/`, data, config);
      else await api.post('/users/', data, config);

      setShowModal(false);
      setToast({ message: isEditing ? 'Updated successfully!' : 'Created successfully!', type: 'success', isVisible: true });
      fetchAdmins();
    } catch (err) { 
      setToast({ message: 'Operation failed.', type: 'error', isVisible: true });
    }
  };

  const handleAvatarChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (file) {
      setAvatarFile(file);
      const reader = new FileReader();
      reader.onloadend = () => setAvatarPreview(reader.result as string);
      reader.readAsDataURL(file);
    }
  };

  const currentPage = Number(searchParams.get('page')) || 1;
  const totalPages = Math.ceil(totalCount / 10);

  return (
    <div>
      <div className="flex justify-between items-center mb-6">
        <h1 className="text-2xl font-bold text-gray-800">Manage Staff</h1>
        <button onClick={handleOpenCreate} className="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 shadow">
          + Create New Staff
        </button>
      </div>

      {/* --- FILTER BAR --- */}
      <div className="bg-white p-4 rounded-lg shadow mb-6 border border-gray-100">
        <div className="flex flex-wrap gap-4 items-end">
          <div className="flex-1 min-w-[200px]">
            <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Search</label>
            <input
              type="text"
              placeholder="Search name or email..."
              className="w-full border rounded p-2 text-sm bg-gray-50"
              value={searchParams.get('search') || ''}
              onChange={(e) => updateUrl('search', e.target.value)}
            />
          </div>

          <div className="w-48">
            <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Role</label>
            <select className="w-full border rounded p-2 text-sm bg-gray-50" value={searchParams.get('role') || ''} onChange={(e) => updateUrl('role', e.target.value)}>
              <option value="">All Roles</option>
              <option value="MUNICIPALITY_ADMIN">Municipality Admin</option>
              <option value="CLUB_ADMIN">Club Admin</option>
            </select>
          </div>

          <div className="w-48">
            <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Club</label>
            <select className="w-full border rounded p-2 text-sm bg-gray-50" value={searchParams.get('assigned_club') || ''} onChange={(e) => updateUrl('assigned_club', e.target.value)}>
              <option value="">All Clubs</option>
              {clubs.map(c => <option key={c.id} value={c.id.toString()}>{c.name}</option>)}
            </select>
          </div>

          <button onClick={() => router.push(pathname)} className="px-4 py-2 text-sm text-gray-500 hover:text-red-500 font-medium pb-2.5">
            Clear Filters
          </button>
        </div>
      </div>

      {/* --- LIST --- */}
      <div className="bg-white rounded-lg shadow overflow-hidden mb-6">
        {isLoading ? (
          <div className="p-8 text-center text-gray-500">Loading staff...</div>
        ) : users.length === 0 ? (
          <div className="p-8 text-center text-gray-500">No staff found.</div>
        ) : (
          <table className="min-w-full divide-y divide-gray-200">
            <thead className="bg-gray-50">
              <tr>
                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">User</th>
                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Role</th>
                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Assignment</th>
                <th className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">Actions</th>
              </tr>
            </thead>
            <tbody className="bg-white divide-y divide-gray-200">
              {users.map((user) => (
                <tr key={user.id}>
                  <td className="px-6 py-4 whitespace-nowrap">
                    <div className="flex items-center">
                      {user.avatar ? (
                        <img src={getMediaUrl(user.avatar) || ''} className="w-10 h-10 rounded-full object-cover mr-3" />
                      ) : (
                        <div className="w-10 h-10 rounded-full bg-gray-200 flex items-center justify-center text-gray-600 text-sm font-bold mr-3">
                           {user.first_name?.[0]}{user.last_name?.[0]}
                        </div>
                      )}
                      <div>
                        <div className="text-sm font-medium text-gray-900">{user.first_name} {user.last_name}</div>
                        <div className="text-sm text-gray-500">{user.email}</div>
                      </div>
                    </div>
                  </td>
                  <td className="px-6 py-4 whitespace-nowrap">
                    <span className={`px-2 inline-flex text-xs leading-5 font-semibold rounded-full 
                      ${user.role === 'MUNICIPALITY_ADMIN' ? 'bg-purple-100 text-purple-800' : 'bg-green-100 text-green-800'}`}>
                      {user.role.replace('_', ' ')}
                    </span>
                  </td>
                  <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                    {user.role === 'CLUB_ADMIN' && (
                       clubs.find(c => c.id === user.assigned_club)?.name || 'Unassigned'
                    )}
                    {user.role === 'MUNICIPALITY_ADMIN' && 'Municipality'}
                  </td>
                  <td className="px-6 py-4 whitespace-nowrap text-right text-sm font-medium space-x-4">
                    <button onClick={() => handleOpenEdit(user)} className="text-indigo-600 hover:text-indigo-900 font-bold">Edit</button>
                    <button onClick={() => handleDelete(user.id)} className="text-red-600 hover:text-red-900">Delete</button>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        )}
      </div>

      {/* --- PAGINATION --- */}
      <div className="flex items-center justify-between border-t border-gray-200 bg-white px-4 py-3 sm:px-6 rounded-lg shadow">
        {/* (Standard Pagination Code reused from other pages) */}
        <div className="flex-1 flex justify-between sm:hidden">
             <button disabled={currentPage === 1} onClick={() => updateUrl('page', (currentPage - 1).toString())} className="relative inline-flex items-center rounded-md border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50 disabled:opacity-50">Previous</button>
             <button disabled={currentPage >= totalPages} onClick={() => updateUrl('page', (currentPage + 1).toString())} className="relative ml-3 inline-flex items-center rounded-md border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-50 disabled:opacity-50">Next</button>
        </div>
        <div className="hidden sm:flex sm:flex-1 sm:items-center sm:justify-between">
            <div><p className="text-sm text-gray-700">Page {currentPage} of {totalPages}</p></div>
            <div>
                <nav className="isolate inline-flex -space-x-px rounded-md shadow-sm">
                    <button disabled={currentPage === 1} onClick={() => updateUrl('page', (currentPage - 1).toString())} className="relative inline-flex items-center rounded-l-md px-2 py-2 text-gray-400 ring-1 ring-inset ring-gray-300 hover:bg-gray-50 disabled:opacity-50">Prev</button>
                    <button disabled={currentPage >= totalPages} onClick={() => updateUrl('page', (currentPage + 1).toString())} className="relative inline-flex items-center rounded-r-md px-2 py-2 text-gray-400 ring-1 ring-inset ring-gray-300 hover:bg-gray-50 disabled:opacity-50">Next</button>
                </nav>
            </div>
        </div>
      </div>

      {/* --- MODAL --- */}
      {showModal && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-xl shadow-2xl w-full max-w-2xl p-8 max-h-[90vh] overflow-y-auto">
            <h2 className="text-2xl font-bold mb-6 text-gray-800">{isEditing ? 'Edit Staff' : 'Create New Staff'}</h2>
            <form onSubmit={handleSubmit} className="space-y-6">
              
              {/* ROLE TYPE (Restricted) */}
              <div className="grid grid-cols-2 gap-4">
                {['MUNICIPALITY_ADMIN', 'CLUB_ADMIN'].map((role) => (
                  <button key={role} type="button" 
                    onClick={() => !isEditing && setAdminType(role)}
                    className={`py-3 px-2 rounded-lg text-sm font-bold border-2 transition
                      ${adminType === role ? 'border-purple-600 bg-purple-50 text-purple-700' : 'border-gray-200 text-gray-600'}
                      ${isEditing && adminType !== role ? 'opacity-50 cursor-not-allowed' : ''}
                    `}>
                    {role.replace('_', ' ')}
                  </button>
                ))}
              </div>

              {/* FIELDS */}
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <input required type="text" placeholder="First Name" className="border p-2 rounded" value={formData.first_name} onChange={e => setFormData({...formData, first_name: e.target.value})} />
                <input required type="text" placeholder="Last Name" className="border p-2 rounded" value={formData.last_name} onChange={e => setFormData({...formData, last_name: e.target.value})} />
                <input type="text" placeholder="Nickname" className="border p-2 rounded" value={formData.nickname} onChange={e => setFormData({...formData, nickname: e.target.value})} />
                <select className="border p-2 rounded" value={formData.legal_gender} onChange={e => setFormData({...formData, legal_gender: e.target.value})}>
                  <option value="MALE">Male</option> <option value="FEMALE">Female</option> <option value="OTHER">Other</option>
                </select>
                <input required type="email" placeholder="Email" className="border p-2 rounded" value={formData.email} onChange={e => setFormData({...formData, email: e.target.value})} />
                <input type="password" placeholder={isEditing ? "New Password" : "Password"} className="border p-2 rounded" required={!isEditing} value={formData.password} onChange={e => setFormData({...formData, password: e.target.value})} />
                <input type="text" placeholder="Phone" className="border p-2 rounded" value={formData.phone_number} onChange={e => setFormData({...formData, phone_number: e.target.value})} />
                {adminType === 'CLUB_ADMIN' && <input type="text" placeholder="Profession" className="border p-2 rounded" value={formData.profession} onChange={e => setFormData({...formData, profession: e.target.value})} />}
              </div>

              {/* AVATAR */}
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">Avatar</label>
                <input type="file" accept="image/*" className="w-full border p-2 rounded" onChange={handleAvatarChange} />
                {avatarPreview && <img src={avatarPreview} alt="Preview" className="w-16 h-16 mt-2 rounded-full object-cover border" />}
              </div>

              {/* ASSIGNMENT (Restricted: Only Club selection if applicable) */}
              {adminType === 'CLUB_ADMIN' && (
                <div className="bg-gray-50 p-4 rounded-lg border">
                  <label className="block text-sm font-bold mb-1 text-gray-700">Assign Club</label>
                  <select className="w-full border p-2 rounded" value={formData.assigned_club} onChange={e => setFormData({...formData, assigned_club: e.target.value})} required>
                    <option value="">Select Club...</option>
                    {clubs.map(c => <option key={c.id} value={c.id.toString()}>{c.name}</option>)}
                  </select>
                </div>
              )}

              <div className="flex items-center gap-2">
                <input type="checkbox" id="hideContact" checked={formData.hide_contact_info} onChange={e => setFormData({...formData, hide_contact_info: e.target.checked})} />
                <label htmlFor="hideContact" className="text-sm text-gray-700">Hide Contact Info</label>
              </div>

              <div className="flex justify-end gap-4 pt-4 border-t">
                <button type="button" onClick={() => setShowModal(false)} className="text-gray-500">Cancel</button>
                <button type="submit" className="bg-purple-600 text-white px-6 py-2 rounded hover:bg-purple-700">
                  {isEditing ? 'Save' : 'Create'}
                </button>
              </div>
            </form>
          </div>
        </div>
      )}

      <Toast message={toast.message} type={toast.type} isVisible={toast.isVisible} onClose={() => setToast({ ...toast, isVisible: false })} />
    </div>
  );
}

export default function ManageMuniAdminsPage() {
  return (
    <Suspense fallback={<div className="p-8 text-center">Loading...</div>}>
      <ManageMuniAdminsPageContent />
    </Suspense>
  );
}
--- END OF FILE: frontend/app/admin/municipality/admins/page.tsx ---


--- START OF FILE: frontend/app/admin/club/admins/page.tsx ---
'use client';

import { useState, useEffect, Suspense } from 'react';
import { useRouter, useSearchParams, usePathname } from 'next/navigation';
import api from '../../../../lib/api';
import { getMediaUrl } from '../../../utils';
import Toast from '../../../components/Toast';

function ManageClubStaffPageContent() {
  const router = useRouter();
  const pathname = usePathname();
  const searchParams = useSearchParams();

  // --- STATE ---
  const [users, setUsers] = useState<any[]>([]);
  const [totalCount, setTotalCount] = useState(0); 
  const [isLoading, setIsLoading] = useState(true);
  
  const [toast, setToast] = useState<{ message: string; type: 'success' | 'error'; isVisible: boolean }>({
    message: '', type: 'success', isVisible: false,
  });

  // Modal & Form State
  const [showModal, setShowModal] = useState(false);
  const [isEditing, setIsEditing] = useState(false);
  const [editUserId, setEditUserId] = useState<number | null>(null);

  const initialFormState = {
    email: '', password: '', first_name: '', last_name: '', nickname: '',
    legal_gender: 'MALE', phone_number: '', profession: '',
    hide_contact_info: false
  };

  const [formData, setFormData] = useState(initialFormState);
  const [avatarFile, setAvatarFile] = useState<File | null>(null);
  const [avatarPreview, setAvatarPreview] = useState<string | null>(null);

  // --- INITIAL DATA LOAD ---
  useEffect(() => {
    fetchAdmins();
  }, [searchParams]);

  const fetchAdmins = async () => {
    setIsLoading(true);
    try {
      const params = new URLSearchParams(searchParams.toString());
      
      // Force filters: Only show Club Admins
      params.set('role', 'CLUB_ADMIN');
      
      const res = await api.get(`/users/?${params.toString()}`);
      setUsers(res.data.results || []);
      setTotalCount(res.data.count);
    } catch (err) {
      console.error(err);
    } finally {
      setIsLoading(false);
    }
  };

  const updateUrl = (key: string, value: string) => {
    const params = new URLSearchParams(searchParams.toString());
    if (value) params.set(key, value); else params.delete(key);
    if (key !== 'page') params.set('page', '1');
    router.push(`${pathname}?${params.toString()}`);
  };

  // --- ACTIONS ---

  const handleOpenCreate = () => {
    setIsEditing(false);
    setEditUserId(null);
    setFormData(initialFormState);
    setAvatarFile(null);
    setAvatarPreview(null);
    setShowModal(true);
  };

  const handleOpenEdit = (user: any) => {
    setIsEditing(true);
    setEditUserId(user.id);
    setFormData({
      email: user.email, password: '', 
      first_name: user.first_name || '', last_name: user.last_name || '',
      nickname: user.nickname || '', legal_gender: user.legal_gender || 'MALE',
      phone_number: user.phone_number || '', profession: user.profession || '',
      hide_contact_info: user.hide_contact_info || false
    });
    setAvatarFile(null);
    setAvatarPreview(user.avatar ? getMediaUrl(user.avatar) : null);
    setShowModal(true);
  };

  const handleDelete = async (id: number) => {
    if (!window.confirm("Are you sure?")) return;
    try {
      await api.delete(`/users/${id}/`);
      setToast({ message: 'Staff deleted.', type: 'success', isVisible: true });
      fetchAdmins();
    } catch (err) { 
      setToast({ message: 'Failed to delete.', type: 'error', isVisible: true });
    }
  };

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    try {
      const data = new FormData();
      Object.entries(formData).forEach(([key, value]) => {
        if (key === 'password' && !value) return; 
        data.append(key, value.toString());
      });
      
      // Role is forced by backend for Club Admins, but good to send
      data.append('role', 'CLUB_ADMIN'); 
      
      if (avatarFile) data.append('avatar', avatarFile);

      const config = { headers: { 'Content-Type': 'multipart/form-data' } };
      if (isEditing && editUserId) await api.patch(`/users/${editUserId}/`, data, config);
      else await api.post('/users/', data, config);

      setShowModal(false);
      setToast({ message: isEditing ? 'Updated successfully!' : 'Created successfully!', type: 'success', isVisible: true });
      fetchAdmins();
    } catch (err) { 
      setToast({ message: 'Operation failed.', type: 'error', isVisible: true });
    }
  };

  const handleAvatarChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (file) {
      setAvatarFile(file);
      const r = new FileReader();
      r.onloadend = () => setAvatarPreview(r.result as string);
      r.readAsDataURL(file);
    }
  };

  const getInitials = (f: string = '', l: string = '') => (f?.charAt(0) + l?.charAt(0)).toUpperCase() || '?';

  return (
    <div>
      <div className="flex justify-between items-center mb-6">
        <h1 className="text-2xl font-bold text-gray-800">Manage Club Staff</h1>
        <button onClick={handleOpenCreate} className="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 shadow">
          + Create New Staff
        </button>
      </div>

      {/* --- FILTER BAR --- */}
      <div className="bg-white p-4 rounded-lg shadow mb-6 border border-gray-100">
        <div className="flex flex-wrap gap-4 items-end">
          <div className="flex-1 min-w-[200px]">
            <label className="block text-xs font-bold text-gray-500 uppercase mb-1">Search</label>
            <input type="text" placeholder="Search name or email..." className="w-full border rounded p-2 text-sm bg-gray-50"
              value={searchParams.get('search') || ''} onChange={(e) => updateUrl('search', e.target.value)} />
          </div>
        </div>
      </div>

      {/* --- LIST --- */}
      <div className="bg-white rounded-lg shadow overflow-hidden mb-6">
        {isLoading ? (
          <div className="p-8 text-center text-gray-500">Loading staff...</div>
        ) : users.length === 0 ? (
          <div className="p-8 text-center text-gray-500">No staff found.</div>
        ) : (
          <table className="min-w-full divide-y divide-gray-200">
            <thead className="bg-gray-50">
              <tr>
                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">User</th>
                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Role</th>
                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Job Title</th>
                <th className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">Actions</th>
              </tr>
            </thead>
            <tbody className="bg-white divide-y divide-gray-200">
              {users.map((user) => (
                <tr key={user.id}>
                  <td className="px-6 py-4 whitespace-nowrap">
                    <div className="flex items-center">
                      {user.avatar ? (
                        <img src={getMediaUrl(user.avatar) || ''} className="w-10 h-10 rounded-full object-cover mr-3" />
                      ) : (
                        <div className="w-10 h-10 rounded-full bg-gray-200 flex items-center justify-center text-gray-600 text-sm font-bold mr-3">
                           {getInitials(user.first_name, user.last_name)}
                        </div>
                      )}
                      <div>
                        <div className="text-sm font-medium text-gray-900">{user.first_name} {user.last_name}</div>
                        <div className="text-sm text-gray-500">{user.email}</div>
                      </div>
                    </div>
                  </td>
                  <td className="px-6 py-4 whitespace-nowrap">
                    <span className="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">
                      Club Admin
                    </span>
                  </td>
                  <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                    {user.profession || '-'}
                  </td>
                  <td className="px-6 py-4 whitespace-nowrap text-right text-sm font-medium space-x-4">
                    <button onClick={() => handleOpenEdit(user)} className="text-indigo-600 hover:text-indigo-900 font-bold">Edit</button>
                    <button onClick={() => handleDelete(user.id)} className="text-red-600 hover:text-red-900">Delete</button>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        )}
      </div>

      {/* --- MODAL --- */}
      {showModal && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
          <div className="bg-white rounded-xl shadow-2xl w-full max-w-2xl p-8 max-h-[90vh] overflow-y-auto">
            <h2 className="text-2xl font-bold mb-6 text-gray-800">{isEditing ? 'Edit Staff' : 'Create New Staff'}</h2>
            <form onSubmit={handleSubmit} className="space-y-6">
              
              {/* FIELDS */}
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <input required type="text" placeholder="First Name" className="border p-2 rounded" value={formData.first_name} onChange={e => setFormData({...formData, first_name: e.target.value})} />
                <input required type="text" placeholder="Last Name" className="border p-2 rounded" value={formData.last_name} onChange={e => setFormData({...formData, last_name: e.target.value})} />
                <input type="text" placeholder="Nickname" className="border p-2 rounded" value={formData.nickname} onChange={e => setFormData({...formData, nickname: e.target.value})} />
                <select className="border p-2 rounded" value={formData.legal_gender} onChange={e => setFormData({...formData, legal_gender: e.target.value})}>
                  <option value="MALE">Male</option> <option value="FEMALE">Female</option> <option value="OTHER">Other</option>
                </select>
                <input required type="email" placeholder="Email" className="border p-2 rounded" value={formData.email} onChange={e => setFormData({...formData, email: e.target.value})} />
                <input type="password" placeholder={isEditing ? "New Password" : "Password"} className="border p-2 rounded" required={!isEditing} value={formData.password} onChange={e => setFormData({...formData, password: e.target.value})} />
                <input type="text" placeholder="Phone" className="border p-2 rounded" value={formData.phone_number} onChange={e => setFormData({...formData, phone_number: e.target.value})} />
                <input type="text" placeholder="Profession / Job Title" className="border p-2 rounded" value={formData.profession} onChange={e => setFormData({...formData, profession: e.target.value})} />
              </div>

              {/* AVATAR */}
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-2">Avatar</label>
                <input type="file" accept="image/*" className="w-full border p-2 rounded" onChange={handleAvatarChange} />
                {avatarPreview && <img src={avatarPreview} alt="Preview" className="w-16 h-16 mt-2 rounded-full object-cover border border-gray-300" />}
              </div>

              <div className="flex items-center gap-2">
                <input type="checkbox" id="hideContact" checked={formData.hide_contact_info} onChange={e => setFormData({...formData, hide_contact_info: e.target.checked})} />
                <label htmlFor="hideContact" className="text-sm text-gray-700">Hide Contact Info</label>
              </div>

              <div className="flex justify-end gap-4 pt-4 border-t">
                <button type="button" onClick={() => setShowModal(false)} className="text-gray-500">Cancel</button>
                <button type="submit" className="bg-green-600 text-white px-6 py-2 rounded hover:bg-green-700">
                  {isEditing ? 'Save' : 'Create'}
                </button>
              </div>
            </form>
          </div>
        </div>
      )}

      <Toast message={toast.message} type={toast.type} isVisible={toast.isVisible} onClose={() => setToast({ ...toast, isVisible: false })} />
    </div>
  );
}

export default function ManageClubStaffPage() {
  return (
    <Suspense fallback={<div className="p-8 text-center">Loading...</div>}>
      <ManageClubStaffPageContent />
    </Suspense>
  );
}
--- END OF FILE: frontend/app/admin/club/admins/page.tsx ---
